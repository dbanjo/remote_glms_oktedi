CREATE OR REPLACE package body STX1.strangp
as

  /*

  Ported to Piction v76

  This is compiled in the STX1 schema.

  -- Not required
  grant execute on on stx1.oltp to strang;
  grant execute on on stx1.gl to strang;
  grant select on on stx1.object_role to strang;
  grant select on on stx1.piction_roles to strang;
  create synonym oltp for stx1.oltp;
  create synonym gl for stx1.oltp;
  create synonym object_role for stx1.object_role;
  create synonym piction_roles for stx1.piction_roles;

  grant execute on strang.f_get_vendor_id to stx1;
  grant execute on strang.F_DISPLAY_PO_TOTAL to stx1;
  grant execute on strang.ent to stx1;
  grant execute on strang.f_sap_format to stx1;
  grant execute on strang.F_AHECC to stx1;
  grant execute on strang.revenue_tonne to stx1;
  grant execute on strang.F_GET_PARTY_ADDRESS to stx1;
  grant execute on strang.chargeable_weight to stx1;
  grant execute on strang.global_site to stx1;
  grant execute on strang.ent2 to stx1;
  grant execute on strang.generate_sad to stx1;
  grant execute on strang.strang_global to stx1;
  grant execute on strang.validate_entry to stx1;
  grant execute on strang.VALIDATE_SINGLE_CUSTOMER to stx1;
  grant execute on strang.F_SAD_SAD_COM to stx1;
  grant execute on strang.F15_PARAMETER_RANGE_COM to stx1;
  grant execute on strang. to stx1;
  grant execute on strang. to stx1;


  grant select,insert,update,delete on strang.unload_strang to stx1;
  grant select,insert,update,delete on strang.lov to stx1;

*/

 G_STR_FRMT_03		constant varchar2(200)		:=  '999,999,999.999';
 G_STR_FRMT_04		constant varchar2(200)		:=  '999,999,999';
 G_STR_FRMT_05		constant varchar2(200)		:=  '999,999.99999';
 G_STR_FRMT_06		constant varchar2(200)		:=  '99999999.99';
 G_STR_FRMT_07		constant varchar2(200)		:=  '999,999.999';
 G_STR_FRMT_08		constant varchar2(200)		:=  '999,999.9999999';
 G_MONEY_FORMAT		constant varchar2(200)		:=  '$999,999,990.99';
 G_MONEY_FORMAT2	constant varchar2(200)		:=  '$999999990.99';
 G_USER_SITE		varchar2(100); -- Initially used by Strang, but can be used by other customers. See procedure identify_user
 LNG_MASK		constant varchar2(100)          := 'DD-MON-YYYY';

 function currsite return varchar2;
 function new_log_no( p1 in varchar2, vste in varchar2 ) return varchar2;
 function control_code( cd in varchar2, vste in varchar2 ) return varchar2;
 function pop_up_window(v_features in varchar2, v_title in varchar2 default '_blank') return varchar2;
 function pos_is_789(vdeliv integer) return boolean;

 procedure lov_list( lname in varchar2, parm in varchar2, cd in varchar2 default null, ismand in boolean DEFAULT FALSE, showdesc in boolean DEFAULT TRUE, showcola in boolean DEFAULT FALSE, isedit in boolean DEFAULT TRUE, xtr_a in varchar2 default null, xtr_b in varchar2 default null, css in varchar2 default null );
 procedure lov_ship( cd in varchar2, lname in varchar2, val in varchar2 default null, isedit in boolean DEFAULT TRUE );
 procedure customer_list( custype in varchar2, parm in varchar2, custid in varchar2 default null, ismand in boolean DEFAULT FALSE, isedit in boolean DEFAULT TRUE, css in varchar2 default null, forceid in varchar2 default null );
 procedure search( surl in varchar2, msearch in varchar2, curr_rowid in varchar2, samerow in boolean DEFAULT FALSE, buttons_only in boolean DEFAULT FALSE, override_top in varchar2 default null, search_only in boolean DEFAULT FALSE, button_text in varchar2 default NULL, lmnu in rowid default null, first_rid in varchar2 default null, xtra1 in varchar2 default null, xtra2 in varchar2 default null, xtra3 in varchar2 default null, colspan in varchar2 default '1', norder in varchar2 default null );
 procedure display_report( surl in varchar2, acid in integer, typ in varchar2, repname in varchar2, r1 in varchar2 default null, r2 in varchar2 default null, r3 in varchar2 default null );
 procedure allocate_hawb( mawb in varchar2, vste in varchar2 );
 procedure generate_entry(vship_id in integer, vste in varchar2);
 procedure generate_entry_airfreight(vship_id in integer, vste in varchar2);
 -- procedure trac_search( surl in varchar2, msg in varchar2 default null );
 procedure create_duty(vship_id varchar2, entryno number, vcust_id integer );
 procedure create_duty_com(vship_id varchar2, entryno number, vcust_id integer );
 procedure create_line_no( vShip_id integer, typ in varchar2 );
 procedure unallocate_entry( vShip_id integer );
 procedure generate_ost356( surl in varchar2, vContainerno in varchar2, vSeal in varchar2 );
 procedure generate_ost256( surl in varchar2, vShip_id in integer );
 procedure generate_ost156( surl in varchar2, vShip_id in integer );
 procedure generate_OST157( surl in varchar2, vShip_id in integer );
 -- procedure generate_ost185( surl in varchar2, vtoday in date, is_batch in boolean default FALSE );
 procedure generate_ccdets( surl in varchar2, vShip_id in integer );
 procedure generate_ccpo( surl in varchar2, vShip_id in integer );
 procedure download_gl(surl in varchar2, rid in varchar2, scid in varchar2, call_name in varchar2, parm in varchar2, access_id in varchar2 default null, vste in varchar2, vaccess in varchar2 );
 procedure generate_containers( shpid in integer );
 procedure generate_containers_onhire( crec in strang.containers%ROWTYPE );
 procedure generate_containers_offhire( crec in strang.containers%ROWTYPE );

 function currsite
  return varchar2
 as
 begin
  return( 'PRIMARY' );
 end currsite;

procedure redisplay_login_page( msg in varchar2, nodisplay in boolean default FALSE, extra_parameter in varchar2 default null )
as
begin
 htp.init;
 if gl.extract_master_parameter('ON_LOGOUT_API') is not null
  then
   begin
    execute immediate
     'begin ' || gl.extract_master_parameter('ON_LOGOUT_API') || '(extra_parameter=>:extra_parameter); end;'
     using extra_parameter;
    return;
   exception
    when others then null;
   end;
 end if;

 htp.htmlopen;
 if nodisplay
  then
   htp.bold( msg );
   htp.htmlclose;
   return;
 end if;
 htp.header(2, LNG.GLB_TXT_001, 'CENTER' );
 htp.nl;
 htp.header(3, msg, 'CENTER' );
 htp.nl;
 htp.header(4, LNG.GLB_TXT_002, 'CENTER' );
 htp.nl;
 htp.p( '<CENTER>' );
 gl.login_page;

end redisplay_login_page;

procedure error_details(pkn in varchar2 default null, prc in varchar2 default null, vpid in integer default null, vaid in integer default null, vphid in integer default null, vpoid in integer default null, errmsg in varchar2 default null, extdet in varchar2 default null, display_error_page in boolean default TRUE)
as
begin
 dapi.error_details(errmsg=>errmsg, extdet=>extdet);
end error_details;

procedure header_msg( txt in varchar2, newline in boolean default TRUE )
as
begin
 htp.header( 2, txt, 'CENTER', cattributes=>'CLASS="error"' );
 if newline then htp.nl; end if;
exception when others then
 error_details( 'STRANGP', 'HEADER_MSG',errmsg=>sqlerrm,extdet=>'TXT: ' || txt);
end header_msg;

function html_format( v in varchar2 )
 return varchar2
as
begin
 --return( replace(replace(replace(v,'"','&#34;'),'<','&lt;'),'>','&gt;') );
 return( replace(v,'"','&#34;') );
end html_format;

function calc_status( vsection in varchar2, ins_upd in char, dno in number, vrec in integer)
 return varchar2
as

 cursor c1(dno number, vrec integer) is select * from strang.pos where deliveryno = dno and recno = vrec;
 cursor c2(dno number) is
  select sum(decode(nvl(grn_status,10),0,1,0)) sum_0,
         sum(decode(nvl(grn_status,10),1,1,0)) sum_1,
         sum(decode(nvl(grn_status,10),2,1,0)) sum_2,
         sum(decode(nvl(grn_status,10),3,1,0)) sum_3,
         sum(decode(nvl(grn_status,10),4,1,0)) sum_4,
         sum(decode(nvl(grn_status,10),8,1,0)) sum_8,
         sum(decode(nvl(grn_status,10),9,1,0)) sum_9,
         sum(decode(nvl(grn_status,10),10,1,0)) sum_10
  from strang.pos
  where deliveryno = dno;
 cursor c3(dno number) is select * from strang.receivals where deliveryno = dno;

 prec	strang.pos%ROWTYPE;
 rrec	strang.receivals%ROWTYPE;
 c2rec	c2%ROWTYPE;
 v	varchar2(32767);
 t2	varchar2(1000);
 varr	owa.vc_arr;
 marr	owa.vc_arr;

begin

 /*

 strang status = pos.grn_status
 po -
 . on insert, look at po_pool.manual_gr if it is not null, then set status = 1, else po_pool.critical is not null then status = 2 else status = 0
 . if on insert = 0, they can only change it to 8 only
 . if on insert = 1, they cant update until grn and grn_item is filled in, and then it can be changed to 9 only + off_site_receipt date is set.
 . if on insert = 2, they can only change to 3.
   if on 3, can only change to 4 or 8
   if on 4, can be changed to 2 only
   if on 8, it is pushed using interface2 batch

 interface3 - on push set status to 9 and off_site_receipt date is set.

 receivals -
 . if all null, only can happen if customer is not 1, which we can ignore
 . if all 0,1,2,3,4 can toggle
 . if mixed values (but can ignore 9 ones), then
 if it detects 0 and 1, then it can update all 0 to 8.- enter manual grn first before
 (note ignore 8 and 9)
 if all 0s then "confirm records are ready for grn receipting" - can mass update all to 8
 if all 1s then "manually enter in grn and grn items" - read only
 if all 2s then "critical part insepction required" - can mass update to 3
 if all 3s then "critical part inspection complete" or option "failed" - can mass update to 8 or 4
 if all 4s then "critical part insepction failed" - can mass update to 2
 if mixed indicate "refer to indivudal PO records" - read only
 if all 8 then "ready for grn" - read only
 if all 9 then "grn receipted" - read only

 0 initial
 1 manual grn
 2 critical part inspection required
 3 critical part inspection complete
 4 critical part insepction fail
 5 mixed refer to individual po records
 6
 7
 8 Ready for GRN
 9 GRN Receipted
 */

 open c3(dno);
 fetch c3 into rrec;
 close c3;
 if rrec.CUST_CUSTOMER_ID = 1
  then
   null; -- OKTedi, correct spot
  else
   return( htf.formselectoption( null ) );
 end if;

 -- xxx on insert, look at po_pool.manual_gr if it is not null, then set status = 1, else po_pool.critical is not null then status = 2 else status = 0

 if vsection = 'POS'
  then
   open c1(dno,vrec);
   fetch c1 into prec;
   close c1;
   case nvl(prec.grn_status,10)
    when 0	then 	varr(0) := 'R'; varr(8) := 'E';
    when 1
     then
      varr(1) := 'R';
      if prec.grn is not null and prec.grn_item is not null then varr(1) := 'E'; varr(9) := 'E'; end if;
    when 2	then 	varr(2) := 'R'; varr(3) := 'E';
    when 3	then 	varr(3) := 'R'; varr(4) := 'E'; varr(8) := 'E';
    when 4	then 	varr(4) := 'R'; varr(2) := 'E';
    when 8	then 	varr(8) := 'R';
    when 9	then 	varr(9) := 'R';
    when 10	then 	null; -- This should never happen
    else
     null;
   end case;

 end if;
 if vsection = 'RECEIVAL'
  then
   open c2(dno);
   fetch c2 into c2rec;
   close c2;
   if    c2rec.sum_0 = 0 and c2rec.sum_1 = 0 and c2rec.sum_2 = 0 and c2rec.sum_3 = 0 and c2rec.sum_4 = 0 and c2rec.sum_8 = 0 and c2rec.sum_9 = 0
    then
     -- No PO records
     varr(10) := 'R';
     marr(10) := 'No PO Records exist';

   elsif c2rec.sum_0 > 0 and c2rec.sum_1 = 0 and c2rec.sum_2 = 0 and c2rec.sum_3 = 0 and c2rec.sum_4 = 0 -- ignore 8 and 9
    then
     -- "confirm records are ready for grn receipting" - can mass update all to 8
     varr(0) := 'R';
     varr(8) := 'E';
     marr(0) := 'Confirm records are ready for grn receipting';
     marr(8) := 'Update all records for grn receipting';

   elsif c2rec.sum_0 = 0 and c2rec.sum_1 > 0 and c2rec.sum_2 = 0 and c2rec.sum_3 = 0 and c2rec.sum_4 = 0 -- ignore 8 and 9
    then
     -- "manually enter in grn and grn items" - read only
     varr(1) := 'R';
     marr(1) := 'Manually enter in grn and grn items';

   elsif c2rec.sum_0 = 0 and c2rec.sum_1 = 0 and c2rec.sum_2 > 0 and c2rec.sum_3 = 0 and c2rec.sum_4 = 0 -- ignore 8 and 9
    then
     -- "critical part insepction required" - can mass update to 3
     varr(2) := 'R';
     varr(3) := 'E';
     marr(2) := 'Critical part insepction required';
     marr(3) := 'Update all to Critical Part Inspection Complete';

   elsif c2rec.sum_0 = 0 and c2rec.sum_1 = 0 and c2rec.sum_2 = 0 and c2rec.sum_3 > 0 and c2rec.sum_4 = 0 -- ignore 8 and 9
    then
     -- "critical part inspection complete" or option "failed" - can mass update to 8 or 4
     varr(3) := 'R';
     varr(4) := 'E';
     varr(8) := 'E';
     marr(3) := 'Critical Part Inspection Complete';
     marr(4) := 'Update all to Critical Part Inspection Failed';
     marr(8) := 'Update all records for GRN Receipting';

   elsif c2rec.sum_0 = 0 and c2rec.sum_1 = 0 and c2rec.sum_2 = 0 and c2rec.sum_3 = 0 and c2rec.sum_4 > 0 -- ignore 8 and 9
    then
     -- "critical part insepction failed" - can mass update to 2
     varr(4) := 'R';
     varr(2) := 'E';
     marr(4) := 'Critical Parts Inspection Failed';
     marr(2) := 'Update all to Critical Part Inspection Required';

   elsif c2rec.sum_0 = 0 and c2rec.sum_1 = 0 and c2rec.sum_2 = 0 and c2rec.sum_3 = 0 and c2rec.sum_4 = 0 and c2rec.sum_8 > 0 and c2rec.sum_9 = 0
    then
     -- if all 8 then "ready for grn" - read only
     varr(8) := 'R';
     marr(8) := 'All records are for GRN Receipting';

   elsif c2rec.sum_0 = 0 and c2rec.sum_1 = 0 and c2rec.sum_2 = 0 and c2rec.sum_3 = 0 and c2rec.sum_4 = 0 and c2rec.sum_8 = 0 and c2rec.sum_9 > 0
    then
     -- if all 9 then "grn receipted" - read only
     varr(9) := 'R';
     marr(9) := 'All records are GRN receipted';

   else
     -- "refer to individual PO records" - read only
     varr(10) := 'R';

  end if;
 end if;

 if varr.count = 0 then return( htf.formselectoption( null ) ); end if;
 for j in varr.first..varr.last loop
  if marr.exists(j)
   then
    if varr(j) = 'R'
     then
      v := v || htf.formselectoption( marr(j), 'SELECTED', cattributes=>'VALUE="' || to_char(j) || '"');
     else
      v := v || htf.formselectoption( marr(j), cattributes=>'VALUE="' || varr(j) || '"');
    end if;

   else
    t2 := null;
    if varr(j) = 'R' then t2 := 'SELECTED'; end if;
    case j
     when 0 then  v := v || htf.formselectoption( 'Initial', t2, cattributes=>'VALUE="' || to_char(j) || '"');
     when 1 then  v := v || htf.formselectoption( 'Manual GRN', t2, cattributes=>'VALUE="' || to_char(j) || '"');
     when 2 then  v := v || htf.formselectoption( 'Critical Part Inspection Required', t2, cattributes=>'VALUE="' || to_char(j) || '"');
     when 3 then  v := v || htf.formselectoption( 'Critical Part Inspection Complete', t2, cattributes=>'VALUE="' || to_char(j) || '"');
     when 4 then  v := v || htf.formselectoption( 'Critical Part Insepction Fail', t2, cattributes=>'VALUE="' || to_char(j) || '"');
     when 8 then  v := v || htf.formselectoption( 'Ready for GRN', t2, cattributes=>'VALUE="' || to_char(j) || '"');
     when 9 then  v := v || htf.formselectoption( 'GRN Receipted', t2, cattributes=>'VALUE="' || to_char(j) || '"');
     when 10 then v := v || htf.formselectoption( 'Mixed Refer To Individual Po Records', t2, cattributes=>'VALUE="' || to_char(j) || '"');
    else null;
    end case;

  end if;
 end loop;

 return( v );
end calc_status;

function guess_time( v in varchar2 )
 return varchar2
as

 r	varchar2(5);
 x	integer;
 m	varchar2(20);
 n	varchar2(20);
 z	number;
 dt	date;
 f	boolean;

begin
 /*
  Format: hh:mi, hh24:mi, 3am 4pm 3 or 4 (default to current am or pm), 3.5 = 15:30
 */
 G_ERR := null;
 if v is null then return( null ); end if;
 if upper(v) = 'D'
  then
   return( to_char(sysdate,'HH24:MI') );
 end if;
 x := instr(v,':');
 if x = 0
  then
   z := gl.guess_number(v);
   if z is null
    then
     f := FALSE;
     if not f then begin dt := to_date( v, '01-JAN-2010 hh:mi am' ); f := true; exception when others then null; end; end if;
     if not f then begin dt := to_date( v, '01-JAN-2010 hh:mi a.m.' ); f := true; exception when others then null; end; end if;
     if not f then begin dt := to_date( v, '01-JAN-2010 hh am' ); f := true; exception when others then null; end; end if;
     if not f then begin dt := to_date( v, '01-JAN-2010 hh a.m.' ); f := true; exception when others then null; end; end if;
     if not f then begin dt := to_date( v, '01-JAN-2010 hh.mi am' ); f := true; exception when others then null; end; end if;
     if not f then begin dt := to_date( v, '01-JAN-2010 hh.mi a.m.' ); f := true; exception when others then null; end; end if;
     if f then return( to_char(dt,'HH24:MI') ); end if;
     G_ERR := 'Invalid time (a) :' || v;
     return( NULL );

    else
     -- Number: e.g. 3.5
     if not( trunc(z) between 0 and 23) then G_ERR := 'Invalid time (b) :' || v; return( NULL ); end if;
     return( lpad( to_char(trunc(z)),2,'0') || ':' || lpad(to_char( round(60 * ( nvl(to_number(substr(to_char(z),instr(to_char(z),'.')+1)),0)/10),2)),2,'0') );
   end if;

  else
   m := upper(trim(substr(v,1,x-1)));
   n := upper(trim(substr(v,x+1)));
   if gl.guess_number(m) between 0 and 23 and gl.guess_number(n) between 0 and 59 then return( lpad(m,2,'0') || ':' || lpad(n,2,'0') ); end if;
   G_ERR := 'Invalid time (c) :' || v;
   return( null );
 end if;
 return( r );

exception
 when others then
  G_ERR := sqlerrm;
  return( null );
end guess_time;

function urladjust(v in varchar2 )
 return varchar2
as
begin
 return(
  replace(replace(v,'~RND',to_char(sysdate,'SSSSS')),'~SURL',dapi.GLOBAL_SURL)
       );
end urladjust;

procedure html5_menu(vparm1 in varchar2, vparm2 in varchar2, vparm3 in varchar2)
as

 cursor c1(vparm1 varchar2, vparm2 varchar2, vparm3 varchar2) is
  select m.*, (select count('x') tot from configurable_menu c where menu_type = 'SUBMENU' and c.theme_id = m.order_by) xtot
  from configurable_menu m
  where m.menu_type = 'HTML5' and
        m.login_type in ('STANDARD',vparm1,vparm2,vparm3)
  order by order_by;

 cursor c2( vord integer, vparm1 varchar2, vparm2 varchar2, vparm3 varchar2) is
  select m.*
  from configurable_menu m
  where m.menu_type = 'SUBMENU' and
        m.login_type in ('STANDARD',vparm1,vparm2,vparm3) and
        m.theme_id = vord
  order by order_by;

   url 		varchar2(1000);

begin
 htp.p( '<div style="text-align: center; width: 1900px">' );
  htp.p( '<div class="navbar">' );
  htp.p( '<div class="dropdown">' || htf.img( INSTALL_PARAMETERS.IMAGE_LOCATION || 'str/' || 'strang_2017_09_20.gif', cattributes=>' BORDER=0',calt=>'Strang Logo' ) || '</div>');
  for c1rec in c1(vparm1, vparm2, vparm3) loop
   if c1rec.xtot = 0
    then
     htp.p( '<a href="' || urladjust(c1rec.url_call) || '" target="_top">' || c1rec.help_on || '</a>' );
    else
     htp.p( '<div class="dropdown">' );
     htp.p( '<button class="dropbtn">' || c1rec.help_on || '<i class="fa fa-caret-down"></i></button>' );
     htp.p( '<div class="dropdown-content">' );
     for c2rec in c2(c1rec.order_by,vparm1, vparm2, vparm3) loop
       htp.p( '<a href="' || urladjust(c2rec.url_call) || '" target="_top">' || c2rec.help_on || '</a>' );
     end loop;
     htp.p( '</div>' );
     htp.p( '</div>' );
   end if;
  end loop;

  htp.p( '<div class="dropdown">' );
   url := 'strangp.usersumm?surl=' || dapi.GLOBAL_SURL;
   url := 'javascript: window.open(''' || url || ''',''' || 'USRSUMM' || ''',''height=' || '600' || ',width=' || '800' || ',scrollbars=yes,resizable=yes'');void('''');';
   htp.p( '<a href="' || url || '" target="_top">' || nvl(initcap(dapi.GLOBAL_ACCOUNT.account_name),initcap(dapi.GLOBAL_ACCOUNT.username)) || '</a>' );
  htp.p( '</div>' );

  htp.p( '</div>' );
 htp.p( '</div>' );

end html5_menu;

function security_role( vprofid in integer )
 return varchar2
as

 cursor c1(vprofid integer) is
  select role_name
  from object_role cr, piction_roles pr
  where cr.object_id = vprofid and
        cr.role_id = pr.role_id and
		role_name like 'LEVEL%';

   c1rec  	c1%ROWTYPE;
   url 		varchar2(1000);

begin
 open c1(vprofid);
 fetch c1 into c1rec;
 close c1;
 return( c1rec.role_name );
exception
 when others then return( null );
end security_role;

procedure main_title( ttl in varchar2 default null, helpid in varchar2 default null, dispmenu in boolean default TRUE)
as

 fsize			integer;
 lnkh			varchar2(40);
 smlsz			integer;
 expanded_scenes	owa.vc_arr;
 vsec1			varchar2(20);
 vsec2			varchar2(20);
 vsec3			varchar2(20);

begin
 -- backimg(surl,dapi.GLOBAL_ACCOUNT.acctid,pfx.text_back,c1rec.background_img,ltype)
 htp.p('<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">' );

 htp.htmlopen;
   htp.p( '<head>' );
   htp.p( '<link rel="stylesheet" href="' || INSTALL_PARAMETERS.IMAGE_LOCATION || 'str/' || 'strang.css">' );
   htp.title( ttl );
   if dispmenu
    then
     htp.p( '<CENTER>' );
     --cst.acct_topx(dapi.GLOBAL_SURL, ttl, helpid );
     vsec1 := null; -- country=AUS
     vsec2 := null; -- admin user
     vsec3 := null; -- show old options
     if G_USER_SITE in ('SYD','BNE','PER','MEL','ADL') then vsec1 := 'SEC1'; end if;
     if security_role( dapi.GLOBAL_ACCOUNT.acctid ) in ('LEVEL 7' ) then vsec2 := 'SEC2'; end if;
     if ENABLE_OLD_OPTIONS then vsec3 := 'SEC3'; end if;
     html5_menu(vsec1,vsec2,null);
     htp.p( '</CENTER>' );
    else
     htp.p( '</head>' );
   end if;

exception when others then
 error_details( 'STRANGP', 'MAIN_TITLE',errmsg=>sqlerrm, extdet=>'TTL:' || ttl);
end main_title;

procedure identify_user( vprof in integer )
as
  cursor c1(vprof integer) is
   select decode( role_name, 'ADELAIDE','ADL','BRISBANE','BNE','MELBOURNE','MEL','PERTH','PER','SYDNEY','SYD','TOWNSVILLE','TVL','CNS','CAIRNS','MOTUKEA','MOT','KIUNGA','KIU','TABUBIL','TAB',substr(role_name,9)) rname
   from object_role cr, piction_roles pr
   where pr.role_id = cr.role_id and
         cr.object_id = vprof and
		 role_name in ('ADELAIDE','BRISBANE','MELBOURNE','PERTH','SYDNEY','TOWNSVILLE','CAIRNS','MOTUKEA','KIUNGA','TABUBIL');
   c1rec c1%ROWTYPE;
 begin
  open c1(vprof);
  fetch c1 into c1rec;
  close c1;
  G_USER_SITE := nvl(c1rec.rname,'SYD');
end identify_user;

function customer_state(vprof in integer)
  return varchar2
 as
 begin
  identify_user( vprof );
  return(nvl(G_USER_SITE,'SYD'));
 end customer_state;

 procedure lov_list( lname in varchar2, parm in varchar2, cd in varchar2 default null, ismand in boolean DEFAULT FALSE, showdesc in boolean DEFAULT TRUE, showcola in boolean DEFAULT FALSE, isedit in boolean DEFAULT TRUE, xtr_a in varchar2 default null, xtr_b in varchar2 default null, css in varchar2 default null )
 as

  cursor c1( lname varchar2, snd varchar2, xtr_a varchar2, xtr_b varchar2 ) is
   select *
   from strang.lov
   where lov_name = lname and
         ((xtr_a is null) or (xtr_a is not null and cola = xtr_a) ) and
         ((xtr_b is null) or (xtr_b is not null and colb = xtr_b) )
   order by decode(snd,'A',code,'B',description);

  cursor c2( cd varchar2, xtr_a varchar2, xtr_b varchar2 ) is
   select *
   from strang.lov
   where lov_name = lname and
         code = cd and
         ((xtr_a is null) or (xtr_a is not null and cola = xtr_a) ) and
         ((xtr_b is null) or (xtr_b is not null and colb = xtr_b) );

  c2rec	c2%ROWTYPE;
  snd	varchar2(10);
  fval	boolean;

 begin

  if showdesc then snd := 'B'; else snd := 'A'; end if;
  fval := false;
  if isedit
   then
    if css is null
     then
      htp.formselectopen( parm);
     else
      htp.p( '<label class="' || css || '" for="styledSelect1">' );
      htp.formselectopen( parm, cattributes=>'id="styledSelect1"' );
    end if;
    if not ismand then htp.formselectoption( NULL ); end if;
    for c1rec in c1( lname, snd, xtr_a, xtr_b ) loop
     if (cd is not null) and (cd = c1rec.code)
      then
       if showdesc
        then
         if showcola
          then
           htp.formselectoption( c1rec.description || '-' || c1rec.cola, 'SELECTED', cattributes=>'VALUE="' || c1rec.code || '"' );
           fval := TRUE;
          else
           htp.formselectoption( c1rec.description, 'SELECTED', cattributes=>'VALUE="' || c1rec.code || '"' );
           fval := TRUE;
        end if;
       else
         htp.formselectoption( c1rec.code, 'SELECTED', cattributes=>'VALUE="' || c1rec.code || '"' );
         fval := TRUE;
       end if;
      else
       if showdesc
        then
         if showcola
          then
           htp.formselectoption( c1rec.description || '-' || c1rec.cola, cattributes=>'VALUE="' || c1rec.code || '"' );
          else
           htp.formselectoption( c1rec.description, cattributes=>'VALUE="' || c1rec.code || '"' );
         end if;
        else
         htp.formselectoption( c1rec.code, cattributes=>'VALUE="' || c1rec.code || '"' );
       end if;
     end if;
     end loop;
    if not fval and cd is not null then htp.formselectoption( cd, 'SELECTED' ); end if;
    htp.formselectclose;
    if css is not null
     then
      htp.p( '</label>');
    end if;
  else

    open c2(cd, xtr_a, xtr_b);
    fetch c2 into c2rec;
    close c2;
    if showdesc
     then
      htp.bold(c2rec.description);
     else
      htp.bold(c2rec.code);
    end if;
  end if;
 exception
  when others then htp.p( sqlerrm );
 end lov_list;

 procedure lov_ship( cd in varchar2, lname in varchar2, val in varchar2 default null, isedit in boolean DEFAULT TRUE )
 as

  cursor c1( lname varchar2 ) is select ship_id,shipname || '-' || voy ||'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;' ||'  (Ship No '|| sap_ship_id ||')' nm from strang.ships_airway where ship_airway = lname order by shipname,voy;
  cursor c2( shd integer ) is select ship_id,shipname || '-' || voy || '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;' ||'  (Ship No '|| sap_ship_id ||')' nm from strang.ships_airway where ship_id = shd;
  cursor c3 is select ship_id from strang.ships_airway where estdepart = (select max(estdepart) from strang.ships_airway);

  c2rec	c2%ROWTYPE;
  c3rec c3%ROWTYPE;
  frec  boolean;

 begin
  if val is null
   then
    open c3;
    fetch c3 into c3rec;
    close c3;
  end if;

  if isedit
   then
    frec := FALSE;
    htp.formselectopen( cd );
    for c1rec in c1( lname ) loop
     frec := TRUE;
     if c1rec.ship_id = nvl(val,c3rec.ship_id)
        then
         htp.formselectoption( c1rec.nm, 'SELECTED', cattributes=>'VALUE="' || c1rec.ship_id || '"' );
        else
         htp.formselectoption( c1rec.nm, cattributes=>'VALUE="' || c1rec.ship_id || '"' );
     end if;
   end loop;
   if not frec then htp.formselectoption( 'No Value Found', cattributes=>'VALUE="XX"' ); end if;
   htp.formselectclose;
   else
   open c2(nvl(val,c3rec.ship_id));
   fetch c2 into c2rec;
   close c2;
   htp.bold( c2rec.nm );
  end if;
 exception
  when others then htp.p( sqlerrm );
 end lov_ship;

 procedure customer_list( custype in varchar2, parm in varchar2, custid in varchar2 default null, ismand in boolean DEFAULT FALSE, isedit in boolean DEFAULT TRUE, css in varchar2 default null, forceid in varchar2 default null )
 as

  cursor c1( custype varchar2 ) is select customer_id, customer from strang.customers where customer_type = custype order by customer;
  cursor c2( custid integer) is select customer from strang.customers where customer_id = custid;

  c2rec	c2%ROWTYPE;
 begin

  if isedit
   then
    if css is null and forceid is null
     then
      htp.formselectopen( parm);
     elsif css is null
     then
      htp.formselectopen( parm, cattributes=>'id="' || nvl(forceid,'styledSelect1') || '"' );
     else
      htp.p( '<label class="' || css || '" for="styledSelect1">' );
      htp.formselectopen( parm, cattributes=>'id="' || nvl(forceid,'styledSelect1') || '"' );
    end if;
    if not ismand then htp.formselectoption( NULL ); end if;
    for c1rec in c1( custype ) loop
     if (custid is not null) and (custid = c1rec.customer_id)
      then
       htp.formselectoption( c1rec.customer, 'SELECTED', cattributes=>'VALUE="' || c1rec.customer_id || '"' );
      else
       htp.formselectoption( c1rec.customer, cattributes=>'VALUE="' || c1rec.customer_id || '"' );
     end if;
    end loop;
    htp.formselectclose;
    if css is not null
     then
      htp.p( '</label>');
    end if;
   else
    open c2(custid);
    fetch c2 into c2rec;
    close c2;
    htp.p(c2rec.customer);
  end if;
 exception
  when others then htp.p( sqlerrm );
 end customer_list;

function pop_up_window(v_features in varchar2, v_title in varchar2 default '_blank')
 return varchar2

as

 v_txt varchar2(32767);

begin
v_txt := '<script LANGUAGE="JavaScript">';
v_txt := v_txt || chr(10) || '<!--';
v_txt := v_txt || chr(10) || 'function popUpWindow(vmsg)';
v_txt := v_txt || chr(10) || '{';
v_txt := v_txt || chr(10) || 'window.open(vmsg,"' || v_title || '","' || v_features || '")';
v_txt := v_txt || chr(10) || '}';
v_txt := v_txt || chr(10) || '// -->';
v_txt := v_txt || chr(10) || '</script>';

return( v_txt );

exception when others then
 return(null);
end pop_up_window;

-- BEGINNING OF CODES
 procedure lov(surl in varchar2, call_name in varchar2, parm in varchar2, lrange in varchar2 default '*', src in varchar2 default null, msg in varchar2 default null, accin varchar2 default 'EDIT', src1 in varchar2 default null, is_popup in char default 'T' )
 as

  cursor c2(lname varchar2, vala varchar2, valb varchar2, src varchar2, src1 varchar2) is
   select /*+ ALL_ROWS */ rowid,lov_name,code,description,cola,colb,colc,cold,cole,colf,colg,colh,coli,colj
   from strang.lov
   where lov_name = lname and
         (
          (src is null and src1 is null and
           substr(upper(code),1,1) >= vala and
           substr(upper(code),1,1) <= valb) or
          (src is not null and src1 is null and code like src || '%') or
          (src is not null and src1 is not null and code like src || '%' and upper(description) like upper(src1) || '%') or
          (src is null and src1 is not null and upper(description) like upper(src1) || '%')
          )
   order by code, decode(lov_name, 'UNRATTAB', to_date(gl.guess_date(cola))) desc;
--   order by code;
  cursor c3(lname varchar2) is select count('x') tot from strang.lov where lov_name = lname;
  cursor c4(lname varchar2, vala varchar2, valb varchar2) is
   select count('x') tot
   from strang.lov
   where lov_name = lname and substr(upper(code),1,1) >= vala and substr(upper(code),1,1) <= valb;
  cursor c5(lname varchar2) is select max(nvl(to_number(colj),0)) colj from strang.lov where lov_name = lname;

 c3rec		c3%ROWTYPE;
 c5rec		c5%ROWTYPE;
 tot_af		integer;
 tot_gm		integer;
 tot_nr		integer;
 tot_sz		integer;
 tot_09		integer;
 low_val	char(1);
 high_val	char(1);
 sts		varchar2(100);

 vaccess	varchar2(20);
 vaccess2	varchar2(20);
 p2_null	boolean;
 p3_null	boolean;
 p5d_null	boolean;
 p5e_null	boolean;
 p5f_null	boolean;
 p4_null	boolean;
 p5_null	boolean;
 p5g_null	boolean;
 p5h_null	boolean;
 p5i_null	boolean;
 p5j_null	boolean;
 candel		boolean;
 v_row          number;
/*
Controls 	- Desc
Gstcodes	- Desc,Cola
Ctrtype		- Desc,Cola,Colb
Units		- Desc
Invcontrols	- Desc
Packtypes	- Desc
Movements	- Desc
Locations	- Desc
Countries	- Desc,Cola
Contracts	- Desc
Currency        - Desc
Probtypes
Debtor_Branch	- Desc
Debtor_Code	- Desc
Job_Branch	- Desc
Warehouses	- Desc
Profit_Centre	- Desc
Cost_Centre	- Desc

*/

begin
 if not dapi.init( surl, 'STRANGP.LOV', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'LOV');
    return;
 end if;

  vaccess := data_access( parm );
  candel := FALSE;
  vaccess2 := data_access( 'DELLOV' );
  if vaccess2 = 'EDIT' then candel := TRUE; end if;

  if parm not in ('INVENT','TARIFF')
   then
    if lrange = '*'
     then
      -- Check range of values and see if it should be broken down
      open c3(parm);
      fetch c3 into c3rec;
      close c3;
      low_val := 'A';
      high_val := 'F';
     else
      low_val := substr(lrange,1,1);
      high_val := substr(lrange,2,1);
    end if;
    if nvl(c3rec.tot,0) > 20 or lrange <> '*'
     then
      open c4(parm,'A','F');
      fetch c4 into tot_af;
      close c4;
      open c4(parm,'G','M');
      fetch c4 into tot_gm;
      close c4;
      open c4(parm,'N','R');
      fetch c4 into tot_nr;
      close c4;
      open c4(parm,'S','Z');
      fetch c4 into tot_sz;
      close c4;
      open c4(parm,'A','F');
      fetch c4 into tot_af;
      close c4;
      open c4(parm,'0','9');
      fetch c4 into tot_09;
      close c4;
      if lrange = '*' and nvl(tot_af,0) = 0
       then
        if lrange = '*' and nvl(tot_gm,0) = 0
         then
          if lrange = '*' and nvl(tot_nr,0) = 0
           then
            if lrange = '*' and nvl(tot_sz,0) = 0
             then
              if lrange = '*' and nvl(tot_09,0) = 0
               then
                low_val := chr(1);
                high_val := chr(255);
               else
                low_val := '0';
                high_val := '9';
              end if;
             else
              low_val := 'S';
              high_val := 'Z';
            end if;
           else
            low_val := 'N';
            high_val := 'R';
          end if;
         else
          low_val := 'G';
          high_val := 'M';
        end if;
      end if;
     else
      low_val := '0';
      high_val := 'Z';
    end if;
  end if;

  if is_popup = 'T' then main_title( 'Manage List of Values' || ': ' || parm, dispmenu=>FALSE, helpid=>'STR01' ); else main_title( 'Manage List of Values' || ': ' || parm, helpid=>'STR01' ); end if;
  htp.nl;
  if vaccess = 'NONE' then htp.bold( 'Access Denied' ); htp.htmlclose; return; end if;
--  if vaccess = 'READ' then htp.bold( 'Access Denied' ); htp.htmlclose; return; end if;
  htp.p( '<CENTER>' );
  if msg is not null then header_msg( msg ); end if;
  if parm not in ('INVENT','TARIFF')
   then
    if nvl(c3rec.tot,0) > 20 or lrange <> '*'
     then
      htp.tableopen( cattributes=>'class="str3_table"' );
      htp.tablerowopen;
       if nvl(tot_af,0) > 0 then htp.tabledata( htf.anchor( 'strangp.lov?surl=' || surl || '&call_name=&parm=' || replace(parm,' ','+') || '&lrange=AF','[A-F]'), cattributes=>'style="text-align:center"'); end if;
       if nvl(tot_gm,0) > 0 then htp.tabledata( htf.anchor( 'strangp.lov?surl=' || surl || '&call_name=&parm=' || replace(parm,' ','+') || '&lrange=GM','[G-M]'), cattributes=>'style="text-align:center"'); end if;
       if nvl(tot_nr,0) > 0 then htp.tabledata( htf.anchor( 'strangp.lov?surl=' || surl || '&call_name=&parm=' || replace(parm,' ','+') || '&lrange=NR','[N-R]'), cattributes=>'style="text-align:center"'); end if;
       if nvl(tot_sz,0) > 0 then htp.tabledata( htf.anchor( 'strangp.lov?surl=' || surl || '&call_name=&parm=' || replace(parm,' ','+') || '&lrange=SZ','[S-Z]'), cattributes=>'style="text-align:center"'); end if;
       if nvl(tot_09,0) > 0 then htp.tabledata( htf.anchor( 'strangp.lov?surl=' || surl || '&call_name=&parm=' || replace(parm,' ','+') || '&lrange=09','[0-9]'), cattributes=>'style="text-align:center"'); end if;
      htp.tablerowclose;
      htp.tablerowopen;
       if nvl(tot_af,0) > 0 then htp.tabledata( to_char(tot_af), cattributes=>'style="text-align:center"'); end if;
       if nvl(tot_gm,0) > 0 then htp.tabledata( to_char(tot_gm), cattributes=>'style="text-align:center"'); end if;
       if nvl(tot_nr,0) > 0 then htp.tabledata( to_char(tot_nr), cattributes=>'style="text-align:center"'); end if;
      htp.tableclose;
       if nvl(tot_sz,0) > 0 then htp.tabledata( to_char(tot_sz), cattributes=>'style="text-align:center"'); end if;
       if nvl(tot_09,0) > 0 then htp.tabledata( to_char(tot_09), cattributes=>'style="text-align:center"'); end if;
      htp.tablerowclose;
    end if;
  end if;
  htp.nl;
  htp.tableopen;
   htp.tablerowopen;
    htp.tabledata( 'Code', cattributes=>'valign="TOP" align="CENTER"'  );
    htp.tabledata( htf.formopen( 'strangp.lov' ) || htf.formhidden( 'SURL', surl ) || htf.formhidden( 'CALL_NAME', call_name ) || htf.formhidden( 'PARM', parm ) || htf.formhidden( 'LRANGE', low_val || high_val ) || htf.formtext( 'SRC', 10, 30, null ), cattributes=>'valign="TOP" align="CENTER"'  );
    htp.tabledata( 'Description', cattributes=>'valign="TOP" align="CENTER"'  );
    htp.tabledata( htf.formtext( 'SRC1', 40, 40, null ), cattributes=>'valign="TOP" align="CENTER"' );
    htp.tabledata( htf.formsubmit( null, 'Search' ) || htf.formclose, cattributes=>'valign="TOP" align="CENTER"' );
   htp.tablerowclose;
  htp.tableclose;
  --htp.nl;
  htp.tableopen( cattributes=>'class="str1_table"' );
  if vaccess = 'EDIT'
   then
    htp.formopen( 'strangp.accept_lov' );
    htp.formhidden( 'SURL', surl );
    htp.formhidden( 'PARM', parm );
    htp.formhidden( 'SRC', src);
    htp.formhidden( 'SRC1', src1);
    htp.formhidden( 'IS_POPUP', is_popup );
    /*
    htp.formhidden( 'p5d', NULL);
    htp.formhidden( 'p5e', NULL);
    htp.formhidden( 'p5f', NULL);
    htp.formhidden( 'P5G', NULL);
    htp.formhidden( 'P5H', NULL);
    htp.formhidden( 'P5I', NULL);
    htp.formhidden( 'P5J', NULL);
    */
    htp.formhidden( 'LRANGE', low_val || high_val );
  end if;
    htp.tablerowopen;
    -- Code
    if parm = 'INVENT'
     then
      htp.tabledata( 'Inventory', cattributes=>'class="str1_cell_center_middle"' );
    elsif parm = 'TARIFF'
     then
      htp.tabledata( 'Tariff', cattributes=>'class="str1_cell_center_middle"' );
     else
      htp.tabledata( 'Code', cattributes=>'class="str1_cell_center_middle"' );
    end if;

    if parm in ('CONTROLS','GSTCODES','CTRTYPE','UNITS','INVCONTROLS','PACKTYPES','MOVEMENTS','LOCATIONS','COUNTRIES','CONTRACTS','CURRENCY','DEBTOR_BRANCH','DEBTOR_CODE','JOB_BRANCH','PROFIT_CENTRE','COST_CENTRE','WAREHOUSES',
                'UNCUOTAB','UNDECTAB','UNMODTAB','UNCP1TAB','UNCMPTAB','UNCTYTAB','UNCAPTAB','UNREGTAB',
                'UNTODTAB','UNCURTAB','UNTR1TAB','UNTR2TAB','UNMOTTAB','UNLOCTAB','UNTOPTAB','UNSHDTAB',
                'UNBNKTAB','UNBRATAB','UNWHSTAB','UNTARTAB','UNPKGTAB','UNPRFTAB','UNCP4TAB',
                'UNCP3TAB','UNATDTAB','UNCTNTAB','UNINDTAB','UNSEATAB'
               )
     then
      htp.tabledata( 'Description', cattributes=>'class="str1_cell_center_middle"' );
    elsif parm = 'INVENT'
     then
      htp.tabledata( 'Description', cattributes=>'class="str1_cell_center_middle"' );
    elsif parm = 'UNRATTAB'
     then
      htp.tabledata( 'Exchange Rate', cattributes=>'class="str1_cell_center_middle"' );
    end if;


    -- Cola
    if parm in ('COUNTRIES')
     then
      htp.tabledata( 'Additional Value', cattributes=>'class="str1_cell_center_middle"' );
    end if;

    -- Cola
    if parm in ('UNCTNTAB')
     then
      htp.tabledata( 'Additional Value', cattributes=>'class="str1_cell_center_middle"' );
    end if;


    -- Cola
    if parm in ('COST_CENTRE')
     then
      htp.tabledata( 'Transaction Type', cattributes=>'class="str1_cell_center_middle"' );
      htp.tabledata( 'GST Applicable', cattributes=>'class="str1_cell_center_middle"' );
    end if;

    -- Cola
    if parm in ('CONTROLS')
     then
      htp.tabledata( 'State', cattributes=>'class="str1_cell_center_middle"' );
    end if;

    -- Cola, Colb
    if parm in ('PACKTYPES')
     then
      htp.tabledata( 'OTML Type', cattributes=>'class="str1_cell_center_middle"' );
      htp.tabledata( 'UNPKGTAB Description', cattributes=>'class="str1_cell_center_middle"' );
    end if;

    if parm in ('GSTCODES')
     then
      htp.tabledata( 'GST', cattributes=>'class="str1_cell_center_middle"' );
      htp.tabledata( 'GST Type', cattributes=>'class="str1_cell_center_middle"' );
    end if;

    if parm in ('LOCATIONS')
     then
      htp.tabledata( 'State', cattributes=>'class="str1_cell_center_middle"' );
      htp.tabledata( 'Country', cattributes=>'class="str1_cell_center_middle"' );
    end if;

    -- Colb and Colc
    if parm = 'CTRTYPE'
     then
      htp.tabledata( 'Mass Container Print', cattributes=>'class="str1_cell_center_middle"' );
      htp.tabledata( 'Consolidate Measurement', cattributes=>'class="str1_cell_center_middle"' );
      htp.tabledata( 'Manifest Description', cattributes=>'class="str1_cell_center_middle"' );
    end if;

    -- Colb and Colc
    if parm = 'INVENT'
     then
    -- Description, cola, Colb and Colc
      htp.tabledata( 'Tariff', cattributes=>'class="str1_cell_center_middle"' );
    end if;

    if parm = 'TARIFF'
     then
      htp.tabledata( 'Description', cattributes=>'class="str1_cell_center_middle"' );
      htp.tabledata( 'Precision 1', cattributes=>'class="str1_cell_center_middle"' );
      htp.tabledata( 'Precision 2', cattributes=>'class="str1_cell_center_middle"' );
      htp.tabledata( 'Rate', cattributes=>'class="str1_cell_center_middle"' );
      htp.tabledata( 'Unit', cattributes=>'class="str1_cell_center_middle"' );
      htp.tabledata( 'Old Rate', cattributes=>'class="str1_cell_center_middle"' );
      htp.tabledata( 'Excise', cattributes=>'class="str1_cell_center_middle"' );
      htp.tabledata( 'Excise Calc', cattributes=>'class="str1_cell_center_middle"' );
      htp.tabledata( 'Charge', cattributes=>'class="str1_cell_center_middle"' );
      htp.tabledata( 'Unit', cattributes=>'class="str1_cell_center_middle"' );
      htp.tabledata( 'Single Charge', cattributes=>'class="str1_cell_center_middle"' );
    end if;
--      htp.tabledata( '&nbsp;', cattributes=>'class="str1_cell_center_middle"' );


-- UN CODES FOR SADS
    -- Cola
    if parm in ('UNREGTAB')
     then
      htp.tabledata( 'City Code', cattributes=>'class="str1_cell_center_middle"' );
    end if;


    if parm in ('UNPKGTAB')
     then
      htp.tabledata( 'Bulk', cattributes=>'class="str1_cell_center_middle"' );
    end if;

    -- Cola, Colb

    if parm in ('UNCP3TAB')
     then
      htp.tabledata( 'RUL_COD', cattributes=>'class="str1_cell_center_middle"' );
      htp.tabledata( 'CP3_AGR', cattributes=>'class="str1_cell_center_middle"' );
    end if;

    if parm in ('UNPRFTAB')
     then
      htp.tabledata( 'RUL_COD', cattributes=>'class="str1_cell_center_middle"' );
      htp.tabledata( 'PRF_QUO', cattributes=>'class="str1_cell_center_middle"' );
    end if;

-- Cola, Colb, Colc
    if parm in ('UNRATTAB')
     then
      htp.tabledata( 'Valid From', cattributes=>'class="str1_cell_center_middle"' );
      htp.tabledata( 'Valid Until', cattributes=>'class="str1_cell_center_middle"' );
 --     htp.tabledata( 'CUR_REF', cattributes=>'class="str1_cell_center_middle"' );
    end if;

    if parm in ('UNMODTAB')
     then
      htp.tabledata( 'MOD_FLW', cattributes=>'class="str1_cell_center_middle"' );
      htp.tabledata( 'CUS_SER', cattributes=>'class="str1_cell_center_middle"' );
      htp.tabledata( 'ASS_SER', cattributes=>'class="str1_cell_center_middle"' );
    end if;

    if parm in ('UNCAPTAB')
     then
      htp.tabledata( 'EEA_EOV', cattributes=>'class="str1_cell_center_middle"' );
      htp.tabledata( 'CAP_DSC', cattributes=>'class="str1_cell_center_middle"' );
      htp.tabledata( 'CAP_LIC', cattributes=>'class="str1_cell_center_middle"' );
    end if;

-- Cola, Colb, Colc, Cold
    if parm in ('UNCP4TAB')
     then
      htp.tabledata( 'CPR_COD', cattributes=>'class="str1_cell_center_middle"' );
      htp.tabledata( 'CPP_COD', cattributes=>'class="str1_cell_center_middle"' );
      htp.tabledata( 'SPE_TRA', cattributes=>'class="str1_cell_center_middle"' );
      htp.tabledata( 'GEN_TRA', cattributes=>'class="str1_cell_center_middle"' );
    end if;

-- Cola, Colb, Colc, Cold, Cole, Colf
    if parm in ('UNBNKTAB','UNWHSTAB','UNCUOTAB','UNDECTAB')
     then
      htp.tabledata( 'ADDRESS1', cattributes=>'class="str1_cell_center_middle"' );
      htp.tabledata( 'ADDRESS2', cattributes=>'class="str1_cell_center_middle"' );
      htp.tabledata( 'ADDRESS3', cattributes=>'class="str1_cell_center_middle"' );
      htp.tabledata( 'ADDRESS4', cattributes=>'class="str1_cell_center_middle"' );
      htp.tabledata( 'TELEPHONE', cattributes=>'class="str1_cell_center_middle"' );
      htp.tabledata( 'FAX', cattributes=>'class="str1_cell_center_middle"' );
    end if;

-- Cola, Colb, Colc, Cold, Cole, Colf, Colg

    if parm in ('UNBRATAB')
     then
      htp.tabledata( 'BRA_NAM', cattributes=>'class="str1_cell_center_middle"' );
      htp.tabledata( 'BRA_ADR', cattributes=>'class="str1_cell_center_middle"' );
      htp.tabledata( 'BRA_AD2', cattributes=>'class="str1_cell_center_middle"' );
      htp.tabledata( 'BRA_AD3', cattributes=>'class="str1_cell_center_middle"' );
      htp.tabledata( 'BRA_AD4', cattributes=>'class="str1_cell_center_middle"' );
      htp.tabledata( 'BRA_TEL', cattributes=>'class="str1_cell_center_middle"' );
      htp.tabledata( 'BRA_FAX', cattributes=>'class="str1_cell_center_middle"' );
    end if;

    if parm in ('UNCMPTAB')
     then
      htp.tabledata( 'CMP_AD3', cattributes=>'class="str1_cell_center_middle"' );
      htp.tabledata( 'CMP_ADR', cattributes=>'class="str1_cell_center_middle"' );
      htp.tabledata( 'CMP_AD2', cattributes=>'class="str1_cell_center_middle"' );
      htp.tabledata( 'CMP_AD4', cattributes=>'class="str1_cell_center_middle"' );
      htp.tabledata( 'CMP_TEL', cattributes=>'class="str1_cell_center_middle"' );
      htp.tabledata( 'CMP_FAX', cattributes=>'class="str1_cell_center_middle"' );
      htp.tabledata( 'CMP_TLX', cattributes=>'class="str1_cell_center_middle"' );
    end if;

-- Cola, Colb, Colc, Cold, Cole, Colf, Colg, Colh, Coli
    if parm in ('UNSHDTAB')
     then
      htp.tabledata( 'EEA_DOV', cattributes=>'class="str1_cell_center_middle"' );
      htp.tabledata( 'EEA_EOV', cattributes=>'class="str1_cell_center_middle"' );
      htp.tabledata( 'SHD_ADR', cattributes=>'class="str1_cell_center_middle"' );
      htp.tabledata( 'SHD_AD2', cattributes=>'class="str1_cell_center_middle"' );
      htp.tabledata( 'SHD_AD3', cattributes=>'class="str1_cell_center_middle"' );
      htp.tabledata( 'SHD_AD4', cattributes=>'class="str1_cell_center_middle"' );
      htp.tabledata( 'SHD_TEL', cattributes=>'class="str1_cell_center_middle"' );
      htp.tabledata( 'SHD_FAX', cattributes=>'class="str1_cell_center_middle"' );
      htp.tabledata( 'SHD_PUB', cattributes=>'class="str1_cell_center_middle"' );
    end if;

   htp.tablerowclose;

  if accin = 'EDIT'
   then
  for c2rec in c2( parm, low_val, high_val, src, src1 ) loop
   p2_null := FALSE;
   p5d_null := TRUE; --htp.formhidden( 'p5d', null );
   p5e_null := TRUE; --htp.formhidden( 'p5e', null );
   p5f_null := TRUE; --htp.formhidden( 'p5f', null );
   p3_null := FALSE;
   p4_null := FALSE;
   p5_null := FALSE;
   p5g_null := TRUE; --htp.formhidden( 'P5g', null );
   p5h_null := TRUE; --htp.formhidden( 'P5h', null );
   p5i_null := TRUE; --htp.formhidden( 'P5i', null );
   p5j_null := TRUE; --htp.formhidden( 'P5j', null );
   htp.tablerowopen;
-- Code
   if vaccess = 'EDIT'
    then
    if parm in ('PROFIT_CENTRE')
     then
      htp.tabledata( htf.formhidden( 'P0', c2rec.code ) || htf.formtext( 'P1', 20, 20, c2rec.code ), cattributes=>'class="str1_cell_left_middle"' );
     else
      htp.tabledata( htf.formhidden( 'P0', c2rec.code ) || htf.formtext( 'P1', 30, 100, c2rec.code ), cattributes=>'class="str1_cell_left_middle"' );
    end if;
-- Description
      if parm in ('CONTROLS','GSTCODES','CTRTYPE','UNITS','INVCONTROLS','PACKTYPES','MOVEMENTS','LOCATIONS','CONTRACTS','CURRENCY','DEBTOR_BRANCH','DEBTOR_CODE','JOB_BRANCH','COST_CENTRE','PROFIT_CENTRE','WAREHOUSES',
                  'UNCUOTAB','UNDECTAB','UNMODTAB','UNCP1TAB','UNCMPTAB','UNCTYTAB','UNCAPTAB','UNREGTAB',
		  'UNTODTAB','UNCURTAB','UNTR1TAB','UNTR2TAB','UNMOTTAB','UNLOCTAB','UNTOPTAB','UNSHDTAB',
		  'UNBNKTAB','UNBRATAB','UNWHSTAB','UNRATTAB','UNTARTAB','UNPKGTAB','UNPRFTAB','UNCP4TAB',
		  'UNCP3TAB','UNATDTAB','UNCTNTAB','UNINDTAB','UNSEATAB'
                  )
       then
        htp.tabledata( htf.formtext( 'P2', 30, 1000, replace(c2rec.description,'"','&#34;') ), cattributes=>'class="str1_cell_left_middle"' );
      elsif parm in ('TARIFF')
       then
        htp.tabledata( htf.formtext( 'p5d', 30, 100, replace(c2rec.cold,'"','&#34;') ), cattributes=>'class="str1_cell_left_middle"' );
        htp.tabledata( htf.formtext( 'p5e', 3, 100, replace(c2rec.cole,'"','&#34;') ), cattributes=>'class="str1_cell_left_middle"' );
        htp.tabledata( htf.formtext( 'p5f', 4, 100, replace(c2rec.colf,'"','&#34;') ), cattributes=>'class="str1_cell_left_middle"' );
        htp.tabledata( htf.formtext( 'P2',  10, 100, replace(c2rec.description,'"','&#34;') ), cattributes=>'class="str1_cell_left_middle"' );
        p5d_null := FALSE; --htp.formhidden( 'p5d', null );
        p5e_null := FALSE; --htp.formhidden( 'p5e', null );
        p5f_null := FALSE; --htp.formhidden( 'p5f', null );
      elsif parm in ('INVENT')
       then
        htp.tabledata( htf.formtext( 'P2', 90, 1000, replace(c2rec.description,'"','&#34;') ), cattributes=>'class="str1_cell_left_middle"' );
      elsif parm in ('COUNTRIES')
       then
        htp.tabledata( htf.formtext( 'P2', 40, 1000, replace(c2rec.description,'"','&#34;') ), cattributes=>'class="str1_cell_left_middle"' );
       else
        p2_null := TRUE; --htp.formhidden( 'P2', null );
      end if;
-- Cola
      if parm in ('COST_CENTRE')
       then
        htp.p( '<TD ' || 'class="str1_cell_left_middle">' );
        htp.formselectopen( 'P3' );
         htp.formselectoption( null );
         if c2rec.cola = 'S' then htp.formselectoption( 'S', 'SELECTED' ); else htp.formselectoption( 'S' ); end if;
         if c2rec.cola = 'C' then htp.formselectoption( 'C', 'SELECTED' ); else htp.formselectoption( 'C' ); end if;
        htp.formselectclose;
        htp.p( '</TD>' );
        htp.p( '<TD ' || 'class="str1_cell_left_middle">' );
        htp.formselectopen( 'P4' );
         htp.formselectoption( null );
         if c2rec.colb = 'GST' then htp.formselectoption( 'GST', 'SELECTED' ); else htp.formselectoption( 'GST' ); end if;

         if c2rec.colb = 'NO_GST' then htp.formselectoption( 'NO_GST', 'SELECTED' ); else htp.formselectoption( 'NO_GST' ); end if;
        htp.formselectclose;
        htp.p( '</TD>' );
      elsif parm in ('GSTCODES','COUNTRIES','CTRTYPE','TARIFF','INVENT','LOCATIONS','CONTROLS','PACKTYPES',
      		    'UNCTNTAB','UNCUOTAB','UNDECTAB','UNMODTAB','UNCMPTAB','UNCAPTAB','UNREGTAB','UNSHDTAB','UNBNKTAB',
                    'UNBRATAB','UNWHSTAB','UNRATTAB','UNTARTAB','UNPKGTAB','UNPRFTAB','UNCP4TAB','UNCP3TAB'
      		    )
       then
        if parm = 'LOCATIONS'
         then
          htp.tabledata( htf.formtext( 'P3', 20, 100, replace(c2rec.cola,'"','&#34;') ), cattributes=>'class="str1_cell_left_middle"' );
         elsif parm = 'PACKTYPES'
          then
          htp.p( '<TD ' || 'class="str1_cell_left_middle">' );
          htp.formselectopen( 'P3' );
          if c2rec.cola is null or c2rec.cola = 'LC' then htp.formselectoption( 'LC', 'SELECTED' ); else htp.formselectoption( 'LC' ); end if;
          if c2rec.cola = 'CT' then htp.formselectoption( 'CT', 'SELECTED' ); else htp.formselectoption( 'CT' ); end if;
          htp.formselectclose;
          htp.p( '</TD>' );
         elsif parm = 'TARIFF'
          then
            htp.p( '<TD ' || 'class="str1_cell_left">' );
	    lov_list( 'UNITS', 'P3', c2rec.cola, TRUE, FALSE, TRUE );
	    htp.p( '</TD>' );
         else
          htp.tabledata( htf.formtext( 'P3', 10, 100, replace(c2rec.cola,'"','&#34;') ), cattributes=>'class="str1_cell_left_middle"' );
         end if;
      else
        p3_null := TRUE; --htp.formhidden( 'P3', null );
      end if;
-- Colb
      if parm in ('CTRTYPE','TARIFF','GSTCODES','LOCATIONS','PACKTYPES',
                  'UNCUOTAB','UNDECTAB','UNMODTAB','UNCMPTAB','UNCAPTAB','UNSHDTAB','UNBNKTAB',
                  'UNBRATAB','UNWHSTAB','UNRATTAB','UNTARTAB','UNPRFTAB','UNCP4TAB','UNCP3TAB'
                  )
       then
        if parm = 'GSTCODES'
         then
          htp.p( '<TD ' || 'class="str1_cell_left_middle">' );
          htp.formselectopen( 'P4' );
          if c2rec.colb is null or c2rec.colb = 'No GST' then htp.formselectoption( 'No GST', 'SELECTED' ); else htp.formselectoption( 'No GST' ); end if;
          if c2rec.colb = 'Inc GST' then htp.formselectoption( 'Inc GST', 'SELECTED' ); else htp.formselectoption( 'Inc GST' ); end if;
          if c2rec.colb = 'Add GST' then htp.formselectoption( 'Add GST', 'SELECTED' ); else htp.formselectoption( 'Add GST' ); end if;
          htp.formselectclose;
          htp.p( '</TD>' );
         elsif parm = 'LOCATIONS'
          then
           htp.tabledata( htf.formtext( 'P4', 20, 100, replace(c2rec.colb,'"','&#34;') ), cattributes=>'class="str1_cell_left_middle"' );
         elsif parm = 'PACKTYPES'
          then
	     htp.p( '<TD ' || 'class="str1_cell_left">' );
	     lov_list( 'UNPKGTAB', 'P4', c2rec.colb, TRUE, TRUE, FALSE );
	     htp.p( '</TD>' );
--           htp.tabledata( htf.formtext( 'P4', 20, 100, replace(c2rec.colb,'"','&#34;') ), cattributes=>'class="str1_cell_left_middle"' );
         else
          htp.tabledata( htf.formtext( 'P4', 10, 100, replace(c2rec.colb,'"','&#34;') ), cattributes=>'class="str1_cell_left_middle"' );
        end if;
       else
        p4_null := TRUE; --htp.formhidden( 'P4', null );
      end if;
-- Colc

      if parm = 'TARIFF'
       then
          htp.tabledata( htf.formtext( 'P5', 10, 100, replace(c2rec.colc,'"','&#34;') ), cattributes=>'class="str1_cell_left_middle"' );
--
          htp.p( '<TD ' || 'class="str1_cell_left_middle">' );
          htp.formselectopen( 'P5g' );
          if c2rec.colg is null or c2rec.colg = 'NONE' then htp.formselectoption( 'NONE', 'SELECTED' ); else htp.formselectoption( 'NONE' ); end if;
          if c2rec.colg = 'BOTH' then htp.formselectoption( 'BOTH', 'SELECTED' ); else htp.formselectoption( 'BOTH' ); end if;
          if c2rec.colg = 'HIGHER' then htp.formselectoption( 'HIGHER', 'SELECTED' ); else htp.formselectoption( 'HIGHER' ); end if;
          if c2rec.colg = 'LOWER' then htp.formselectoption( 'LOWER', 'SELECTED' ); else htp.formselectoption( 'LOWER' ); end if;
          htp.formselectclose;
          htp.p( '</TD>' );
          htp.tabledata( htf.formtext( 'P5h', 10, 100, replace(c2rec.colh,'"','&#34;') ), cattributes=>'class="str1_cell_left_middle"' );
	  htp.p( '<TD ' || 'class="str1_cell_left">' );
	  lov_list( 'UNITS', 'P5i', c2rec.coli, FALSE, FALSE, TRUE );
	  htp.p( '</TD>' );
          htp.tabledata( htf.formtext( 'P5j', 10, 100, replace(c2rec.colj,'"','&#34;') ), cattributes=>'class="str1_cell_left_middle"' );
          p5g_null := FALSE; --htp.formhidden( 'P5g', null );
          p5h_null := FALSE; --htp.formhidden( 'P5h', null );
          p5i_null := FALSE; --htp.formhidden( 'P5i', null );
          p5j_null := FALSE; --htp.formhidden( 'P5j', null );
       elsif parm in ('CTRTYPE','UNCUOTAB','UNDECTAB','UNMODTAB','UNCMPTAB','UNCAPTAB','UNSHDTAB','UNBNKTAB',
                      'UNBRATAB','UNWHSTAB','UNTARTAB','UNCP4TAB'
                      )
        then
          htp.tabledata( htf.formtext( 'P5', 10, 100, replace(c2rec.colc,'"','&#34;') ), cattributes=>'class="str1_cell_left_middle"' );

       else
        p5_null := TRUE; --htp.formhidden( 'P5', null );
      end if;
-- Cold
      if parm in ('UNCUOTAB','UNDECTAB','UNCMPTAB','UNSHDTAB','UNBNKTAB',
                  'UNBRATAB','UNWHSTAB','UNTARTAB','UNCP4TAB'
                 )
      then
          htp.tabledata( htf.formtext( 'p5d', 10, 100, replace(c2rec.cold,'"','&#34;') ), cattributes=>'class="str1_cell_left_middle"' );
       else
        p5d_null := TRUE; --htp.formhidden( 'p5d', null );
      end if;

-- Cole & Colf
      if parm in ('UNCUOTAB','UNDECTAB','UNCMPTAB','UNSHDTAB','UNBNKTAB',
                  'UNBRATAB','UNWHSTAB','UNTARTAB'
                 )
      then
          htp.tabledata( htf.formtext( 'p5e', 10, 100, replace(c2rec.cole,'"','&#34;') ), cattributes=>'class="str1_cell_left_middle"' );
          htp.tabledata( htf.formtext( 'p5f', 10, 100, replace(c2rec.colf,'"','&#34;') ), cattributes=>'class="str1_cell_left_middle"' );
       else
        p5e_null := TRUE; --htp.formhidden( 'p5e', null );
        p5f_null := TRUE; --htp.formhidden( 'p5f', null );
      end if;

-- Colg
      if parm in ('UNCMPTAB','UNSHDTAB','UNBRATAB')
      then
          htp.tabledata( htf.formtext( 'P5g', 10, 100, replace(c2rec.colg,'"','&#34;') ), cattributes=>'class="str1_cell_left_middle"' );
       else
        p5g_null := TRUE; --htp.formhidden( 'P5g', null );
      end if;
-- Colh & Coli
      if parm = 'UNSHDTAB'
      then
          htp.tabledata( htf.formtext( 'P5h', 10, 100, replace(c2rec.colh,'"','&#34;') ), cattributes=>'class="str1_cell_left_middle"' );
          htp.tabledata( htf.formtext( 'P5i', 10, 100, replace(c2rec.coli,'"','&#34;') ), cattributes=>'class="str1_cell_left_middle"' );
       else
        p5h_null := TRUE; --htp.formhidden( 'P5h', null );
        p5i_null := TRUE; --htp.formhidden( 'P5i', null );
      end if;
      if parm = 'UNRATTAB'
      then
        htp.formhidden( 'P5J', c2rec.colj);
		htp.formhidden( 'P5I', c2rec.rowid);
      end if;
-- >>>
      if candel
       then
        if parm in ('UNRATTAB')
		 then
 		  htp.tabledata( htf.anchor( 'strangp.accept_lov?surl=' || surl || '&parm=' || replace(parm,' ','+') || '&src=' || replace(src,' ','+') || '&src1=' || replace(src1,' ','+') || '&lrange=' || low_val || high_val ||
                                   '&action=' || 'Delete' || '&p0=' || replace(c2rec.code,' ','+') || '&p1=&p2=&p5d=&p5e=&p5f=&p3=' || replace(c2rec.cola,' ','+') || '&p4=&p5=&p5g=&p5h=&p5i=' || replace(c2rec.rowid,'+','~') || '&p5j=', 'Delete' ) );
		else
		  htp.tabledata( htf.anchor( 'strangp.accept_lov?surl=' || surl || '&parm=' || replace(parm,' ','+') || '&src=' || replace(src,' ','+') || '&src1=' || replace(src1,' ','+') || '&lrange=' || low_val || high_val ||
                                   '&action=' || 'Delete' || '&p0=' || replace(c2rec.code,' ','+') || '&p1=&p2=&p5d=&p5e=&p5f=&p3=' || replace(c2rec.cola,' ','+') || '&p4=&p5=&p5g=&p5h=&p5i=&p5j=', 'Delete' ) );
        end if;
	  end if;
    else
     htp.tabledata( htf.bold( c2rec.code ), cattributes=>'class="str1_cell_left_middle"' );
     htp.tabledata( htf.bold( c2rec.description ), cattributes=>'class="str1_cell_left_middle"' );
     htp.tabledata( htf.bold( c2rec.cola ), cattributes=>'class="str1_cell_left_middle"' );
     htp.tabledata( htf.bold( c2rec.colb ), cattributes=>'class="str1_cell_left_middle"' );
     htp.tabledata( htf.bold( c2rec.colc ), cattributes=>'class="str1_cell_left_middle"' );
    end if;

    -- Put here to try and get around an IE6 issue of displaying blank lines when using Formhidden
    if parm in ('COST_CENTRE') then p3_null := FALSE; p4_null := FALSE; end if;
    if parm in ('UNRATTAB') then p2_null := FALSE; p3_null := FALSE; p4_null := FALSE; p5_null := FALSE; end if;

    if p2_null or p3_null or p4_null or p5_null
     then
      htp.p('<td class="str1_bg_left">' );
      if p2_null then htp.formhidden( 'P2', null ); end if;
      if p5d_null then htp.formhidden( 'p5d', null ); end if;
      if p5e_null then htp.formhidden( 'p5e', null ); end if;
      if p5f_null then htp.formhidden( 'p5f', null ); end if;
      if p3_null then htp.formhidden( 'P3', null ); end if;
      if p4_null then htp.formhidden( 'P4', null ); end if;
      if p5_null then htp.formhidden( 'P5', null ); end if;
      if p5g_null then htp.formhidden( 'P5g', null ); end if;
      if p5h_null then htp.formhidden( 'P5h', null ); end if;
      if p5i_null then htp.formhidden( 'P5i', null ); end if;
      if p5j_null then htp.formhidden( 'P5j', null ); end if;
      htp.p( '&nbsp;' );
      htp.p( '</TD>' );
    end if;

   htp.tablerowclose;
   end loop;
  end if;

  if vaccess = 'EDIT' and accin = 'INSERT'
   then
    for j in 1..5 loop
     htp.tablerowopen;
    if parm in ('PROFIT_CENTRE')
     then
      htp.tabledata( htf.formhidden( 'P0', null ) || htf.formtext( 'P1', 20, 20, null ), cattributes=>'class="str1_cell_left_middle"' );
     else
      htp.tabledata( htf.formhidden( 'P0', null ) || htf.formtext( 'P1', 30, 100, null ), cattributes=>'class="str1_cell_left_middle"' );
    end if;

      if parm in ('CONTROLS','GSTCODES','CTRTYPE','UNITS','INVCONTROLS','PACKTYPES','MOVEMENTS','LOCATIONS','CONTRACTS','CURRENCY','DEBTOR_BRANCH',
                  'DEBTOR_CODE','JOB_BRANCH','COST_CENTRE','PROFIT_CENTRE','WAREHOUSES','UNRATTAB')
       then
       htp.tabledata( htf.formtext( 'p5d', 10, 100, null ), cattributes=>'class="str1_cell_left_middle"' );
        htp.tabledata( htf.formtext( 'P2', 30, 1000, null ), cattributes=>'class="str1_cell_left_middle"' );
      elsif parm in ('TARIFF')
       then
       htp.tabledata( htf.formtext( 'p5e', 10, 100, null ), cattributes=>'class="str1_cell_left_middle"' );
       htp.tabledata( htf.formtext( 'p5f', 10, 100, null ), cattributes=>'class="str1_cell_left_middle"' );
        htp.tabledata( htf.formtext( 'P2', 10, 1000, null ), cattributes=>'class="str1_cell_left_middle"' );
      elsif parm in ('INVENT')
       then
        htp.tabledata( htf.formtext( 'P2', 90, 1000, null ), cattributes=>'class="str1_cell_left_middle"' );
      elsif parm in ('COUNTRIES')
       then
        htp.tabledata( htf.formtext( 'P2', 40, 1000, null ), cattributes=>'class="str1_cell_left_middle"' );
       else
        htp.formhidden( 'P2', null );
      end if;

      if parm in ('COST_CENTRE')
       then
        htp.p( '<TD ' || 'class="str1_cell_left_middle">' );
        htp.formselectopen( 'P3' );
         htp.formselectoption( null, 'SELECTED' );
          htp.formselectoption( 'S' );
          htp.formselectoption( 'C' );
        htp.formselectclose;
        htp.p( '</TD>' );
        htp.p( '<TD ' || 'class="str1_cell_left_middle">' );
        htp.formselectopen( 'P4' );
         htp.formselectoption( null, 'SELECTED' );
         htp.formselectoption( 'GST' );
         htp.formselectoption( 'NO_GST' );
        htp.formselectclose;
        htp.p( '</TD>' );

      elsif parm in ('GSTCODES','COUNTRIES','CTRTYPE','TARIFF','INVENT','LOCATIONS','CONTROLS')
       then
        htp.tabledata( htf.formtext( 'P3', 10, 100, null ), cattributes=>'class="str1_cell_left_middle"' );
       else
        if parm in('UNRATTAB') then null; else htp.formhidden( 'P3', null ); end if;
      end if;
     if parm in ('CTRTYPE','TARIFF','GSTCODES','LOCATIONS')
      then
       htp.tabledata( htf.formtext( 'P4', 10, 100, null ), cattributes=>'class="str1_cell_left_middle"' );
       else
        if parm in('COST_CENTRE','UNRATTAB') then null; else htp.formhidden( 'P4', null ); end if;
      end if;
     if parm in ('UNRATTAB')
      then
       htp.tabledata( htf.formtext( 'P3', 10, 100, null ), cattributes=>'class="str1_cell_left_middle"' );
       htp.tabledata( htf.formtext( 'P4', 10, 100, null ), cattributes=>'class="str1_cell_left_middle"' );
       v_row := null;
       open c5(parm);
        fetch c5 into c5rec;
        v_row := c5rec.colj;
       close c5;
 --      -- find max value colj for UNRATTAB
 --      -- select max(to_number(colj) into v_row from lov where lov_name = 'UNRATTAB';
 --      -- nvl(0);
 --
       v_row := nvl(v_row, 0) + j;
       htp.formhidden( 'P5J', v_row );
     end if;
     if parm in ('TARIFF')
      then
       htp.tabledata( htf.formtext( 'P5', 10, 100, null ), cattributes=>'class="str1_cell_left_middle"' );
       htp.tabledata( htf.formtext( 'P5G', 10, 100, null ), cattributes=>'class="str1_cell_left_middle"' );
       htp.tabledata( htf.formtext( 'P5H', 10, 100, null ), cattributes=>'class="str1_cell_left_middle"' );
       htp.tabledata( htf.formtext( 'P5I', 10, 100, null ), cattributes=>'class="str1_cell_left_middle"' );
       htp.tabledata( htf.formtext( 'P5J', 10, 100, null ), cattributes=>'class="str1_cell_left_middle"' );
      elsif parm in ('CTRTYPE')
      then
       htp.tabledata( htf.formtext( 'P5', 10, 100, null ), cattributes=>'class="str1_cell_left_middle"' );
       htp.tabledata( htf.formtext( 'p5d', 10, 100, null ), cattributes=>'class="str1_cell_left_middle"' );
       htp.tabledata( htf.formtext( 'p5e', 10, 100, null ), cattributes=>'class="str1_cell_left_middle"' );
       htp.tabledata( htf.formtext( 'p5f', 10, 100, null ), cattributes=>'class="str1_cell_left_middle"' );
       htp.tabledata( htf.formtext( 'P5G', 10, 100, null ), cattributes=>'class="str1_cell_left_middle"' );
       htp.tabledata( htf.formtext( 'P5H', 10, 100, null ), cattributes=>'class="str1_cell_left_middle"' );
       htp.tabledata( htf.formtext( 'P5I', 10, 100, null ), cattributes=>'class="str1_cell_left_middle"' );
       htp.tabledata( htf.formtext( 'P5J', 10, 100, null ), cattributes=>'class="str1_cell_left_middle"' );
       elsif parm not in ('UNRATTAB','CTRTYPE','TARIFF')
        then
        htp.formhidden( 'P5', null );
      end if;

    htp.tablerowclose;
    end loop;
  end if;

  htp.tableclose;
  htp.nl;
  if vaccess = 'EDIT'
   then
    htp.formhidden( 'P0', null );
    htp.formhidden( 'P1', null );
    htp.formhidden( 'P2', null );
    htp.formhidden( 'p5d', null );
    htp.formhidden( 'p5e', null );
    htp.formhidden( 'p5f', null );
    htp.formhidden( 'P3', null );
    htp.formhidden( 'P4', null );
    htp.formhidden( 'P5', null );
    htp.formhidden( 'P5g', null );
    htp.formhidden( 'P5h', null );
    htp.formhidden( 'P5i', null );
    htp.formhidden( 'P5j', null );
    if accin = 'INSERT'
     then
       htp.formsubmit( 'ACTION', 'Insert New Values' );
       htp.formsubmit( 'ACTION', 'Modify Values' );
     else
       htp.formsubmit( 'ACTION', 'Insert New Values' );
    end if;
    htp.formsubmit( 'ACTION', 'Return' );
   htp.formclose;
  end if;
  htp.p( '</CENTER>' );
  htp.htmlclose;

exception when others then
 error_details( 'STRANGP', 'LOV',null,dapi.GLOBAL_ACCOUNT.acctid,errmsg=>sqlerrm,extdet=>'PARM:' || parm);
end lov;

procedure accept_lov( surl in varchar2, parm in varchar2, lrange in varchar2, action in varchar2, src in varchar2,
                      p0 in owa.vc_arr default strangp.empty_array, p1 in owa.vc_arr default strangp.empty_array,
                      p2 in owa.vc_arr default strangp.empty_array, p3 in owa.vc_arr default strangp.empty_array,
                      p4 in owa.vc_arr default strangp.empty_array, p5 in owa.vc_arr default strangp.empty_array,
                      p5d in owa.vc_arr default strangp.empty_array,p5e in owa.vc_arr default strangp.empty_array,
                      p5f in owa.vc_arr default strangp.empty_array, p5g in owa.vc_arr default strangp.empty_array,
                      p5h in owa.vc_arr default strangp.empty_array, p5i in owa.vc_arr default strangp.empty_array,
                      p5j in owa.vc_arr default strangp.empty_array, src1 in varchar2 default null, is_popup in char default 'T' )
as

 cursor c1( lname varchar2, cd varchar2 ) is select 'x' from strang.lov where lov_name = lname and code = cd;
 cursor c1a( lname varchar2, cd varchar2, ca varchar2 ) is select 'x' from strang.lov where lov_name = lname and code = cd and cola = ca;
 cursor c2( inv varchar2 ) is select recno from strang.pos where inventoryno = inv;
 cursor c3( tarf varchar2 ) is select 'x' from strang.lov where lov_name = 'TARIFF' and code = tarf;
 cursor c4(lname varchar2, lcode varchar2, f_date varchar2, t_date varchar2, rid rowid) is
  select *
  from   strang.lov
  where  lov_name = lname
         and code = upper(lcode)
         and rowid <> rid
         and ( ( to_date(f_date) >= to_date(cola) and to_date(f_date) <= to_date(colb))
              or
               (to_date(t_date) >= to_date(cola) and to_date(t_date) <= to_date(colb))
             )
  ;

 c2rec		c2%ROWTYPE;
 c3rec		c3%ROWTYPE;
 c4rec		c4%ROWTYPE;



 sts		varchar2(100);
 dummy		char(1);
 msg		varchar2(1000);
 nctr		integer;
 uctr		integer;
 dctr		integer;
 v_from         varchar2(100);
 v_to           varchar2(100);

begin
 if not dapi.init( surl, 'STRANGP.ACCEPT_LOV', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'ACCEPT_LOV');
    return;
 end if;

  for j in p0.first..p0.last loop
  nctr := 0;
  uctr := 0;
  dctr := 0;
  if p0(j) is null and p1(j) is not null
   then
    -- New Record
    if parm <> 'CONTROLS'
     then
      if parm = 'UNRATTAB'
      then
      /*
      open c1a( parm, upper(p1(j)), upper(p3(j)) );
      fetch c1a into dummy;
      if c1a%FOUND
       then
        close c1a;
        commit;
        lov(surl,null,parm,lrange,src,Value || ':' || upper(p1(j)) ||  ' Date: '|| ':' || upper(p3(j)) || ' ' || 'Currency Period Already Exists',src1=>src1);
        return;
       else
        close c1a;
      end if;
      */
      null;
      else
      open c1( parm, upper(p1(j)) );
      fetch c1 into dummy;
      if c1%FOUND
       then
        close c1;
        commit;
        lov(surl,null,parm,lrange,src,'Value' || ':' || upper(p1(j)) || ' ' || 'already exists',src1=>src1, is_popup=>is_popup);
        return;
       else
        close c1;
      end if;
     end if;
    end if;
    if parm = 'INVENT' and p3(j) is not null
     then
      open c3(p3(j));
      fetch c3 into c3rec;
      if c3%NOTFOUND
       then
        close c3;
        lov(surl,null,parm,lrange,src,'This Tariff code does not exist in the Tariff Table' || ':' || p3(j),src1=>src1, is_popup=>is_popup);
        return;
      end if;
      close c3;
    end if;
    if parm = 'TARIFF' and (p2(j) is null or p4(j) is null or p5(j) is null)
     then
      commit;
      lov(surl,null,parm,lrange,src,'For Tariff, values must exist for Rate, Old Rate and Excise',src1=>src1, is_popup=>is_popup);
      return;
     elsif parm = 'TARIFF' and gl.guess_number(p2(j)) is null
      then
       lov(surl,null,parm,lrange,src,'Tariff ' || p1(j) || ': Rate is non-numeric',src1=>src1, is_popup=>is_popup);
       return;
     elsif parm = 'TARIFF' and gl.guess_number(p4(j)) is null
      then
       lov(surl,null,parm,lrange,src,'Tariff ' || p1(j) || ': Old Rate is non-numeric',src1=>src1, is_popup=>is_popup);
       return;
     elsif parm = 'TARIFF' and gl.guess_number(p5(j)) is null
      then
       lov(surl,null,parm,lrange,src,'Tariff ' || p1(j) || ': Excise is non-numeric',src1=>src1, is_popup=>is_popup);
       return;
     else
      if parm = 'COST_CENTRE' and p3(j) is null
       then
        lov(surl,null,parm,lrange,src,'Must Specify a Transaction Type',src1=>src1, is_popup=>is_popup);
        return;
       elsif
         parm = 'TARIFF'
         then
        insert into strang.lov(lov_name,code,description,cola,colb,colc,cold,cole,colf,colg,colh,coli,colj) values
        (parm,upper(p1(j)),p2(j),p3(j),p4(j),p5(j),p5d(j),p5e(j),p5f(j),p5g(j),p5h(j),p5i(j),p5j(j));
       else
        insert into strang.lov(lov_name,code,description,cola,colb,colc) values (parm,upper(p1(j)),p2(j),upper(p3(j)),upper(p4(j)),p5(j));
     end if;
    end if;
    nctr := nctr + 1;

  elsif (p0(j) is not null and p1(j) is null) or (action = 'Delete')
   then
    -- Delete LOV
    -- If Invent check does not delete in PO
    if parm = 'INVENT'
     then
      open c2(p0(j));
      fetch c2 into c2rec;
      if c2%FOUND
       then
        close c2;
        commit;
        lov(surl,null,parm,lrange,src,'Cannot Delete' || ':' || upper(p0(j)) || ' ' || ' ' || 'it already exists in the PO Table' || ' (Recno ' || c2rec.recno || ' ).',src1=>src1, is_popup=>is_popup);
        return;
      end if;
      close c2;
      delete from strang.lov where lov_name = parm and code = p0(j) and nvl(cola,'!') = nvl(p3(j),'!');
     else
      delete from strang.lov where lov_name = parm and code = p0(j) and nvl(cola,'!') = nvl(p3(j),'!');
    end if;
    dctr := dctr + 1;
    -- Cascade Delete

  elsif p0(j) is not null and p1(j) is not null and p0(j) <> upper(p1(j))
   then
    -- Update Primary Key
    if parm <> 'CONTROLS'
     then
      open c1( parm, upper(p1(j)) );
      fetch c1 into dummy;
      if c1%FOUND
       then
        close c1;
        commit;
        lov(surl,null,parm,lrange,src,'Value' || ':' || upper(p1(j)) || ' ' || 'already exists',src1=>src1, is_popup=>is_popup);
        return;
       else
        close c1;
      end if;
    end if;
    if parm = 'INVENT' and p3(j) is not null
     then
      open c3(p3(j));
      fetch c3 into c3rec;
      if c3%NOTFOUND
       then
        close c3;
        lov(surl,null,parm,lrange,src,'This Tariff code does not exist in the Tariff Table' || ':' || p3(j),src1=>src1, is_popup=>is_popup);
        return;
      end if;
      close c3;
    end if;
    if parm = 'TARIFF' and (p2(j) is null or p4(j) is null or p5(j) is null)
     then
      commit;
      lov(surl,null,parm,lrange,src,'For Tariff, values must exist for Rate, Old Rate and Excise',src1=>src1, is_popup=>is_popup);
      return;
    elsif parm = 'TARIFF' and gl.guess_number(p2(j)) is null
     then
      lov(surl,null,parm,lrange,src,'Tariff ' || p1(j) || ': Rate is non-numeric',src1=>src1, is_popup=>is_popup);
      return;
    elsif parm = 'TARIFF' and gl.guess_number(p4(j)) is null
     then
      lov(surl,null,parm,lrange,src,'Tariff ' || p1(j) || ': Old Rate is non-numeric',src1=>src1, is_popup=>is_popup);
      return;
    elsif parm = 'TARIFF' and gl.guess_number(p5(j)) is null
     then
      lov(surl,null,parm,lrange,src,'Tariff ' || p1(j) || ': Excise is non-numeric',src1=>src1, is_popup=>is_popup);
      return;
    end if;
    if parm = 'CONTROLS'
     then
      update strang.lov
       set
        code = upper(p1(j)),
        description = p2(j),
        cola = p3(j),
        colb = p4(j),
        colc = p5(j)
      where
       lov_name = parm and
       code = p0(j) and
       nvl(cola,'!') = nvl(p3(j),'!');
     elsif parm = 'TARIFF'
      then
       update strang.lov
        set
        code = upper(p1(j)),
        description = p2(j),
        cola = p3(j),
        colb = p4(j),
        colc = p5(j),
        cold = p5d(j),
        cole = p5e(j),
        colf = p5f(j),
        colg = p5g(j),
        colh = p5h(j),
        coli = p5i(j),
        colj = p5j(j)
      where
       lov_name = parm and
       code = p0(j);
     elsif parm = 'UNRATTAB'
      then
       update strang.lov
        set
        code = upper(p1(j))
      , description = p2(j)
      , cola = upper(p3(j))
      , colb = upper(p4(j))
      -- , colc = p5(j)
      where
       rowid = p5i(j)
       /*
       lov_name = parm and
       code = p0(j) and
       colj = p5j(j)
       */
       ;
     else
       update strang.lov
        set
        code = upper(p1(j)),
        description = p2(j),
        cola = p3(j),
        colb = p4(j),
        colc = p5(j)
      where
       lov_name = parm and
       code = p0(j);
    end if;
    if parm = 'COST_CENTRE'
     then
      update strang.lov
       set
        cola = upper(p3(j)),
        colb = p4(j)
      where
       lov_name = parm and
       code = p0(j);
      if upper(p3(j)) not in ('S','C') and parm = 'COST_CENTRE'
       then
        update strang.lov
         set
          cola = 'S'
        where
         lov_name = parm and
         code = p0(j);
      end if;
      if upper(p4(j)) not in ('GST','NO_GST') and parm = 'COST_CENTRE'
       then
        update strang.lov
         set
          colb = 'GST'
        where
         lov_name = parm and
         code = p0(j);
      end if;
    end if;

    uctr := uctr + 1;
  elsif p0(j) is null and p1(j) is null
   then
    -- Do Nothing
    null;
  else
    -- Update Values
    if parm = 'INVENT' and p3(j) is not null
     then
      open c3(p3(j));
      fetch c3 into c3rec;
      if c3%NOTFOUND
       then
        close c3;
        lov(surl,null,parm,lrange,src,'This Tariff code does not exist in the Tariff Table' || ':' || p3(j),src1=>src1, is_popup=>is_popup);
        return;
      end if;
      close c3;
    end if;
    if parm = 'TARIFF' and (p2(j) is null or p4(j) is null or p5(j) is null)
     then
      commit;
      lov(surl,null,parm,lrange,src,'For Tariff, values must exist for Rate, Old Rate and Excise',src1=>src1, is_popup=>is_popup);
      return;
    elsif parm = 'TARIFF' and gl.guess_number(p2(j)) is null
     then
      lov(surl,null,parm,lrange,src,'Tariff ' || p1(j) || ': Rate is non-numeric',src1=>src1, is_popup=>is_popup);
      return;
    elsif parm = 'TARIFF' and gl.guess_number(p4(j)) is null
     then
      lov(surl,null,parm,lrange,src,'Tariff ' || p1(j) || ': Old Rate is non-numeric',src1=>src1, is_popup=>is_popup);
      return;
    elsif parm = 'TARIFF' and gl.guess_number(p5(j)) is null
     then
      lov(surl,null,parm,lrange,src,'Tariff ' || p1(j) || ': Excise is non-numeric',src1=>src1, is_popup=>is_popup);
      return;
    end if;
    if parm = 'CONTROLS'
     then
      update strang.lov
       set
        description = p2(j),
        cola = p3(j),
        colb = p4(j),
        colc = p5(j)
      where
       lov_name = parm and
       code = p0(j) and
       nvl(cola,'!') = nvl(p3(j),'!');
      elsif parm = 'TARIFF'
       then
        update strang.lov
         set
         description = p2(j),
         cola = p3(j),
         colb = p4(j),
         colc = p5(j),
         cold = p5d(j),
         cole = p5e(j),
         colf = p5f(j),
         colg = p5g(j),
         colh = p5h(j),
         coli = p5i(j),
         colj = p5j(j)
       where
        lov_name = parm and
        code = p0(j);
      elsif parm = 'UNRATTAB'
       then
        -- Validate 'From' date
        v_from := gl.guess_date(p3(j));
        if v_from is null
         then
          lov(surl,null,parm,lrange,src,'[' || p1(j) || ' - ' || p2(j) || '] Invalid FROM date: ' || p3(j),src1=>src1, is_popup=>is_popup);
          return;
        end if;
        -- Validate 'To' date
        v_to := gl.guess_date(nvl(p4(j), to_char(sysdate,'DD-MON-YYYY')));
        if v_to is null
         then
          lov(surl,null,parm,lrange,src,'[' || p1(j) || ' - ' || p2(j) || '] Invalid TO date: ' || p4(j),src1=>src1, is_popup=>is_popup);
          return;
        end if;
        if to_date(v_from) > to_date(v_to)
         then
          lov(surl,null,parm,lrange,src,'[' || p1(j) || ' - ' || p2(j) || '] FROM date is after TO date: ' || v_from || ' - ' || v_to,src1=>src1, is_popup=>is_popup);
          return;
        end if;

        -- Check for overlapping dates for same code
        open c4('UNRATTAB',p1(j), p3(j), p4(j), p5i(j));
        fetch c4 into c4rec;
        if c4%FOUND
         then
          close c4;
          lov(surl,null,parm,lrange,src,'[' || p1(j) || ' - ' || p2(j) || '] Dates conflict with [' || c4rec.code || ']: ' || c4rec.cola || ' - ' || c4rec.colb,src1=>src1);
          return;
        end if;
        close c4;

        update strang.lov
         set
         code = upper(p1(j))
       , description = p2(j)
       , cola = upper(p3(j))
       , colb = upper(p4(j))
       where
        rowid = p5i(j)
        ;
      else
      update strang.lov
       set
        description = p2(j),
        cola = upper(p3(j)),
        colb = upper(p4(j)),
        colc = p5(j)
      where
       lov_name = parm and
       code = p0(j);
    end if;
    uctr := uctr + 1;
   end if;
  end loop;

  commit;

  if nctr > 0
   then
    msg := nctr || ' ' || ' ' || 'Records Successfully Inserted';
  elsif uctr > 0
   then
    msg := uctr || ' ' || ' ' || 'Records Successfully Updated';
  end if;

  if action = 'Return'
   then
    oltp.display_screen(surl=>surl,sname=>'Administration',rnd=>to_char(sysdate,'SSSSS'),access_in=>NULL,rid=>NULL);
   elsif action = 'Insert New Values'
    then
     lov(surl,null,parm,lrange,src,msg,'INSERT',src1=>src1, is_popup=>is_popup);
   else
     lov(surl,null,parm,lrange,src,msg,src1=>src1, is_popup=>is_popup);
  end if;
exception when others then
 error_details( 'STRANGP', 'ACCEPT_LOV',null,null,errmsg=>sqlerrm,extdet=>'PARM:' || parm);
end accept_lov;

procedure after_lov(surl in varchar2, rid in varchar2, scid in varchar2, call_name in varchar2, parm in varchar2, access_id in varchar2 default null, msg in varchar2 default null, is_popup in char default 'F' )
as
 cursor c1(rid rowid) is select * from strang.lov where rowid = rid;
 c1rec	c1%ROWTYPE;
begin
 open c1(rid);
 fetch c1 into c1rec;
 close c1;
 lov(surl,call_name,parm,null,c1rec.code, is_popup=>is_popup);
exception when others then
 error_details( 'STRANGP', 'AFTER_LOV',null,null,errmsg=>sqlerrm,extdet=>'PARM:' || parm);
end after_lov;
-- END OF CODES

procedure receive(surl in varchar2, rid in varchar2, scid in varchar2, call_name in varchar2, parm in varchar2, access_id in varchar2 default null, msg in varchar2 default null, vrecctr in varchar2 default null, norder in varchar2 default null, n_local in char default 'L', rows_show in integer default null )
as

 cursor c2(rid rowid) is select rowid from strang.receivals where deliveryno = (select deliveryno from strang.detailrs where rowid=rid);
 cursor c3(rid rowid) is select rowid from strang.receivals where deliveryno = (select deliveryno from strang.pos where rowid=rid);

 c2rec		c2%ROWTYPE;
 c3rec		c3%ROWTYPE;
 sts		varchar2(100);
 nrid		varchar2(100);
 nord		varchar2(10);
 rs		integer;

begin
 if not dapi.init( surl, 'STRANGP.RECEIVE', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'RECEIVE');
    return;
 end if;

 if parm in ('RECEIVALS','RECEIVALS-SINGULAR')
  then
   nrid := replace(rid,'~','+');
 elsif parm = 'DETAILRS'
  then
   open c2(rid);
   fetch c2 into c2rec;
   close c2;
   nrid := rowidtochar( c2rec.rowid );
 elsif parm = 'POS'
  then
   open c3(replace(rid,'~','+'));
   fetch c3 into c3rec;
   close c3;
   nrid := rowidtochar( c3rec.rowid );
 end if;

 -- xx get default from pref
 rs := nvl(rs,G_ROWS);
 nord := nvl(nord,'DND'); -- DNA,DND, CURRA,CURRD, GST
 if nrid is null and parm = 'RECEIVALS'
  then
   receive_top(surl=>surl,rid=>nrid,scid=>scid,call_name=>call_name,parm=>'RECEIVALS',access_id=>access_id,msg=>msg);
   return;
 end if;
 if parm = 'RECEIVALS-SINGULAR'
  then
   receive_single(surl=>surl,rid=>nrid,scid=>scid,call_name=>call_name,parm=>'RECEIVALS',access_id=>access_id,msg=>msg,norder=>nvl(norder,nord),n_local=>n_local);
   return;
 elsif parm in ('DETAILRS','POS')
  then
   receive_single(surl=>surl,rid=>nrid,scid=>scid,call_name=>call_name,parm=>parm,access_id=>access_id,msg=>msg,norder=>nvl(norder,nord),n_local=>n_local);
   return;
 end if;
 receive_top2(surl=>surl,rid=>nrid,scid=>scid,call_name=>call_name,parm=>'RECEIVALS',access_id=>access_id,msg=>msg,rows_show=>nvl(rows_show,rs),norder=>nvl(norder,nord),n_local=>n_local);

exception when others then
 error_details( 'STRANGP', 'RECEIVE',null,null,errmsg=>sqlerrm,extdet=>'PARM:' || parm);
end receive;

procedure receive_single(surl in varchar2, rid in varchar2, scid in varchar2, call_name in varchar2, parm in varchar2, access_id in varchar2 default null, msg in varchar2 default null, vrecctr in varchar2 default null, norder in varchar2 default null, n_local in char default 'L' )
as
   nrid		varchar2(100);
begin
 if not dapi.init( surl, 'STRANGP.RECEIVE_SINGLE', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'RECEIVE_SINGLE');
    return;
 end if;
 nrid := replace(rid,'~','+');

 htp.htmlopen;
  htp.title( gl.extract_master_parameter('BAR_TITLE'));
   htp.htmlopen;
   htp.p('
   <iframe src="strangp.receive_top?surl=' || gl.rndsurl(surl) || '&rid=' || replace(nrid,'+','~') || '&scid=' || scid || '&call_name=' || call_name || '&parm=' || replace(parm,' ','+') || '&access_id=' || access_id || '&msg=' || replace(msg,' ','+') || '&norder=' || norder || '&n_local=' || n_local || '" height="28%" width="100%" name="STRANG_TOP" sandbox="allow-top-navigation allow-scripts allow-forms allow-popups allow-same-origin allow-modals allow-popups-to-escape-sandbox" frameborder="0"></iframe>
   <iframe src="strangp.receive_bottom?surl=' || gl.rndsurl(surl) || '&rid=' || replace(nrid,'+','~') || '&scid=' || scid || '&call_name=' || call_name || '&parm=' || replace(parm,' ','+') || '&access_id=' || access_id || '&recctr=' || nvl(vrecctr,'1') || '&popup=F' || '&force_single_disp=T'|| '" height="37%" width="100%" name="STRANG_BOTTOM" sandbox="allow-top-navigation allow-scripts allow-forms allow-popups allow-same-origin allow-modals allow-popups-to-escape-sandbox" frameborder="0"></iframe>
   <iframe src="strangp.receive_po?surl=' || gl.rndsurl(surl) || '&rid=' || replace(nrid,'+','~') || '&scid=' || scid || '&call_name=' || call_name || '&parm=' || replace(parm,' ','+') || '&access_id=' || access_id || '&popup=F' || '&force_single_disp=T' || '" height="35%" width="100%" name="STRANG_BOTTOM_PO" sandbox="allow-top-navigation allow-scripts allow-forms allow-popups allow-same-origin allow-modals allow-popups-to-escape-sandbox" frameborder="0"></iframe>
   ');
   htp.htmlclose;
end receive_single;

procedure receive_top(surl in varchar2, rid in varchar2, scid in varchar2, call_name in varchar2, parm in varchar2, access_id in varchar2 default null, msg in varchar2 default null, norder in varchar2 default null, n_local in char default 'L' )
as

 cursor c2( rid rowid ) is select * from strang.receivals where rowid = rid;
 cursor c3( sname varchar2 ) is select screen_id from oltp_overview where screen_name = sname;
 cursor c4( scid integer ) is select * from oltp_object where screen_id = scid and original_column = 'CUSTOMER_TYPE';
 cursor c5( sto varchar2 ) is select max(deliveryno) + 1 dlr from strang.receivals;
 cursor c5x( sto varchar2, dlr varchar2 ) is select max(deliveryno) + 1 dlr from strang.receivals where substr(to_char(deliveryno),1,1) = dlr;
 cursor c6( dlrv number ) is select 'x' from dual where exists (select 'x' from strang.detailrs where movement_no is not null and deliveryno = dlrv );
 cursor c7(vste varchar2) is select customer_id from strang.lov l, strang.customers c where lov_name = 'CONTROLS' and code = 'DEFAULT RECEIVAL CUSTOMER' and description = customer and customer_type = 'CUSTOMER' and cola = vste;
 cursor c8(vste varchar2) is select description from strang.lov where lov_name = 'CONTROLS' and code = 'DEFAULT GST CODE' and cola = vste;
 cursor c9 is select code,description,cola from strang.lov where lov_name = 'COUNTRIES' order by cola;
 cursor c10(vste varchar2) is select description from strang.lov where lov_name = 'CONTROLS' and code = 'SEE_ALL_DELIVERIES' and cola = vste;
 cursor c11(vste varchar2) is select description from strang.lov where lov_name = 'CONTROLS' and code = 'DELIVERYNO' and cola = vste;

 c2rec		c2%ROWTYPE;
 c3rec		c3%ROWTYPE;
 c3arec		c3%ROWTYPE;
 c4rec		c4%ROWTYPE;
 c5rec		c5%ROWTYPE;
 c6rec		c6%ROWTYPE;
 c10rec 	c10%ROWTYPE;
 c11rec 	c11%ROWTYPE;
 sts		varchar2(100);
 vaccess	varchar2(20);
 ttl		varchar2(200);
 seclevel	varchar2(100);
 vste		varchar2(10);
 v_link 	varchar2(1000);

begin
 if not dapi.init( surl, 'STRANGP.RECEIVE_TOP', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'RECEIVE_TOP');
    return;
 end if;

 vaccess := data_access( 'RECEIVAL' );

 vste := customer_state(dapi.GLOBAL_ACCOUNT.acctid);
 ttl := 'Receivals';
 seclevel := security_role( dapi.GLOBAL_ACCOUNT.acctid );

 main_title( helpid=>'STR02');
 if vaccess = 'NONE' then htp.bold( 'Access Denied' ); htp.htmlclose; return; end if;
 if msg is not null
  then
   ttl := msg;
 end if;
 htp.p( '<CENTER>' );
 if access_id <> 'z'
  then
   open c2(replace(rid,'~','+'));
   fetch c2 into c2rec;
   close c2;
  else
   c2rec.curr := 'AUD';
 end if;

 if vaccess = 'EDIT'
  then
   htp.formopen( 'strangp.accept_receive_top', ctarget=>'_top' );
   htp.formhidden( 'SURL', surl );
   htp.formhidden( 'SCID', scid );
   htp.formhidden( 'PARM', 'RECEIVALS' );
   htp.formhidden( 'ACCESS_ID', access_id );
   htp.formhidden( 'NORDER', norder );
   htp.formhidden( 'N_LOCAL', n_local );
   if access_id = 'z'
    then
     htp.formhidden( 'RID', null );
     open c10(vste);
     fetch c10 into c10rec;
     close c10;
     if c10rec.description = 'YES'
      then
       open c11(vste);
       fetch c11 into c11rec;
       close c11;
       open c5x(currsite,substr(c11rec.description,1,1));
       fetch c5x into c5rec;
       close c5x;
       if c5rec.dlr is null then c5rec.dlr := c11rec.description; end if;
      else
       open c11(vste);
       fetch c11 into c11rec;
       close c11;
       open c5x(currsite,substr(c11rec.description,1,1));
       fetch c5x into c5rec;
       close c5x;
       if c5rec.dlr is null then c5rec.dlr := c11rec.description; end if;
    end if;
     open c7(vste);
     fetch c7 into c2rec.cust_customer_id;
     close c7;
     open c8(vste);
     fetch c8 into c2rec.gstc_gstcode;
     close c8;
    else
     htp.formhidden( 'RID', replace(rid,'~','+') );
   end if;
 end if;

 open c3('Customers');
 fetch c3 into c3rec;
 close c3;
 open c3('Receival');
 fetch c3 into c3arec;
 close c3;
 open c4(c3rec.screen_id);
 fetch c4 into c4rec;
 close c4;

 htp.nl;
 htp.tableopen( cattributes=>'class="str1_table"' );
  htp.tablerowopen;
   htp.tabledata( 'Delivery #',cattributes=>'class="str1_hd_left"');
   if access_id = 'z'
    then
     htp.tabledata( c5rec.dlr,cattributes=>'class="str1_hd_left"');
     if vaccess = 'EDIT' then htp.formhidden( 'P1', c5rec.dlr ); end if;
    else
     htp.tabledata( c2rec.deliveryno,cattributes=>'class="str1_hd_left"');
     if vaccess = 'EDIT' then htp.formhidden( 'P1', null ); end if;
   end if;
   htp.tabledata( 'Customer',cattributes=>'class="str1_hd_left"');
   if vaccess = 'EDIT'
    then
     if seclevel in ( 'LEVEL 8' )
      then
       htp.p( '<TD ' || 'class="str1_bg_left">' );
       htp.formhidden( 'P6', c2rec.cust_customer_id );
       customer_list( 'CUSTOMER', 'P6', c2rec.cust_customer_id, TRUE, isedit=>FALSE );
       htp.p( '</TD>' );
       htp.tabledata('ID '|| c2rec.cust_customer_id,cattributes=>'class="str1_hd_left"');
      else
       htp.p( '<TD ' || 'class="str1_bg_left">' );
       customer_list( 'CUSTOMER', 'P6', c2rec.cust_customer_id, TRUE );
       htp.p( '</TD>' );
       htp.tabledata( 'ID '|| c2rec.cust_customer_id,cattributes=>'class="str1_bg_left"');
     end if;
    else
     htp.p( '<TD ' || 'class="str1_bg_left">' );
     customer_list( 'CUSTOMER', 'P6', c2rec.cust_customer_id, TRUE, isedit=>FALSE );
     htp.p( '</TD>' );
     htp.tabledata( 'ID '|| c2rec.cust_customer_id,cattributes=>'class="str1_bg_left"');
   end if;
   htp.tabledata( 'Currency',cattributes=>'class="str1_hd_left"');
   if vaccess = 'EDIT'
    then
     htp.p( '<TD ' || 'class="str1_bg_left">' );
     htp.formselectopen( 'P5' );
     for c9rec in c9 loop
      if c9rec.cola = c2rec.curr
       then
        htp.formselectoption( c9rec.cola, 'SELECTED' );
       else
        htp.formselectoption( c9rec.cola );
      end if;
     end loop;
     htp.formselectclose;
     htp.p( '</TD>' );
    else
     htp.tabledata( c2rec.curr,cattributes=>'class="str1_bg_left"');
   end if;
  htp.tabledata( 'Value ('||c2rec.curr||')',cattributes=>'class="str1_hd_left"');              -- this line
  htp.tabledata( strang.f_display_po_total(c2rec.deliveryno),cattributes=>'class="str1_bg_left"');  -- this line
  htp.tablerowclose;

  htp.tablerowopen;
   htp.tabledata( 'Date',cattributes=>'class="str1_hd_left"');
   if vaccess = 'EDIT'
    then
     if seclevel in ( 'LEVEL 8' ) or pos_is_789(c2rec.deliveryno)
      then
       htp.tabledata( htf.formhidden( 'P3', to_char(nvl(c2rec.currdate,sysdate),LNG_MASK)) || to_char(nvl(c2rec.currdate,sysdate),LNG_MASK),cattributes=>'class="str1_bg_left"');
      else
       htp.tabledata( htf.formtext('P3',15,20,to_char(nvl(c2rec.currdate,sysdate),LNG_MASK)),cattributes=>'class="str1_bg_left"');
     end if;
    else
     htp.tabledata( to_char(nvl(c2rec.currdate,sysdate),LNG_MASK),cattributes=>'class="str1_bg_left"');
   end if;
   htp.tabledata( 'Supplier',cattributes=>'class="str1_hd_left"');
   if vaccess = 'EDIT'
    then
     if seclevel in ( 'LEVEL 8' )
      then
       htp.p( '<TD ' || 'class="str1_bg_left">' );
       htp.formhidden( 'P8', c2rec.supplier_customer_id );
       customer_list( 'SUPPLIER', 'P8', c2rec.supplier_customer_id, FALSE, isedit=>FALSE, forceid=>'suppm' );
       htp.p(htf.bold('&nbsp;' || 'ID  '|| strang.f_get_vendor_id(c2rec.supplier_customer_id)||'&nbsp;&nbsp;&nbsp;'));
       htp.p( '</TD>' );
      else
       htp.p( '<TD ' || 'class="str1_bg_left">' );
       customer_list( 'SUPPLIER', 'P8', c2rec.supplier_customer_id, FALSE, forceid=>'suppm' );
       htp.p( '</TD>' );
       htp.tabledata( 'ID  '|| strang.f_get_vendor_id(c2rec.supplier_customer_id),cattributes=>'class="str1_bg_left"');
     end if;
    else
     htp.p( '<TD ' || 'class="str1_bg_left">' );
     customer_list( 'SUPPLIER', 'P8', c2rec.supplier_customer_id, FALSE, isedit=>FALSE, forceid=>'suppm' );
     htp.p( '</TD>' );
     htp.tabledata( 'Vendor ID  '|| strang.f_get_vendor_id(c2rec.supplier_customer_id),cattributes=>'class="str1_bg_left"');
   end if;
   if c2rec.curr = 'AUD' and c2rec.exrate is null then c2rec.exrate := 1; end if;
   --htp.tabledata( htf.bold('Exchange Rate'),cattributes=>'class="str1_bg_left"');
   /*
   if vaccess = 'EDIT'
    then
     htp.tabledata( htf.formtext('P7',15,20,to_char(c2rec.exrate,G_STR_FRMT_05)),cattributes=>'class="str1_bg_left"');
    else
     htp.tabledata( to_char(c2rec.exrate,G_STR_FRMT_05),cattributes=>'class="str1_bg_left"');
   end if;
   */
  htp.tabledata( 'Default GST Code',cattributes=>'class="str1_hd_left"');
   if vaccess = 'EDIT'
    then
     if seclevel in ( 'LEVEL 8' )
      then
       htp.p( '<TD ' || 'class="str1_bg_left" colspan="3">' );
       htp.formhidden( 'P4', c2rec.gstc_gstcode );
       lov_list( 'GSTCODES', 'P4', c2rec.gstc_gstcode, TRUE, TRUE, TRUE, isedit=>FALSE );
      else
       htp.p( '<TD ' || 'class="str1_bg_left" colspan="3">' );
       lov_list( 'GSTCODES', 'P4', c2rec.gstc_gstcode, TRUE, TRUE, TRUE );
     end if;
    else
     htp.p( '<TD ' || 'class="str1_bg_left" colspan="3">' );
     lov_list( 'GSTCODES', 'P4', c2rec.gstc_gstcode, TRUE, TRUE, TRUE, isedit=>FALSE );
   end if;
   htp.p( '</TD>' );
  htp.tablerowclose;

  htp.tablerowopen;
   htp.tabledata( 'Notes',cattributes=>'class="str1_hd_left"');
   if vaccess = 'EDIT'
    then
     htp.tabledata( htf.formtext( 'P3N', 140, 203, c2rec.r_notes ),cattributes=>'class="str1_bg_left" COLSPAN="3"');
    else
     htp.tabledata( c2rec.r_notes,cattributes=>'class="str1_bg_left" COLSPAN="3"');
   end if;
   htp.p( '<td class="str1_bg_left" COLSPAN="5">' );

 htp.tableopen( cattributes=>'class="str1_table4"' );
 htp.tablerowopen;
 if vaccess = 'EDIT'
  then
   if access_id = 'z'
    then
     if seclevel in ( 'LEVEL 8' )
      then
       null;
      else
       htp.tabledata( htf.formsubmit( 'ACTION', 'Insert New Delivery' ));
     end if;
     htp.tabledata( htf.formsubmit( 'ACTION', 'Cancel' ) || htf.formclose);

    else
     open c6( c2rec.deliveryno );
     fetch c6 into c6rec;
     if c6%NOTFOUND
      then
       if not(seclevel in ( 'LEVEL 8' ))
        then
         htp.tabledata( htf.formsubmit( 'ACTION', 'Update Delivery' ));
         htp.tabledata( htf.formsubmit( 'ACTION', 'Delete Delivery' ) || htf.formclose);
        else
         htp.tabledata( htf.formsubmit( 'ACTION', 'Update Delivery' ) || htf.formclose);
       end if;
      else
         htp.tabledata( htf.formsubmit( 'ACTION', 'Update Delivery' ) || htf.formclose);
     end if;
     close c6;

     if seclevel in ( 'LEVEL 8' )
      then
       null;
      else
      htp.tabledata( htf.formopen( 'oltp.process_query', ctarget=>'_top' ) || htf.formhidden( 'SURL', surl ) || htf.formhidden( 'ID', 'z' ) || htf.formhidden( 'RND', to_char(sysdate,'SSSSS') ) || htf.formhidden( 'ACCESS_IN', 'EDIT' ) || htf.formhidden( 'RID', null ) ||
                  htf.formhidden( 'SCID', c3arec.screen_id ) || htf.formhidden( 'PARM1', 'CUSTOMER' ) || htf.formhidden( 'PARM2', c4rec.oltp_id ) || htf.formhidden( 'PARM3', null ) || htf.formhidden( 'PARM4', '=' ) ||
                  htf.formhidden( 'SORT', null ) ||
                  htf.formsubmit( null, 'New Receival' ) ||
                  htf.formclose);
      htp.tabledata( htf.formopen( 'strangp.mng_cust', cattributes=>'onsubmit="javascript: window.open('''',''CUSTOMER_WINDOW'',''top=100,left=100,height=800,width=1200,location=no,resizable=yes,scrollbars=yes,status=no''); this.target=''CUSTOMER_WINDOW'';"' ) || htf.formhidden( 'SURL', surl ) || htf.formhidden( 'ID', 'z' ) || htf.formhidden( 'RID', null ) || htf.formhidden( 'IS_POPUP', 'T' ) || htf.formsubmit( null, 'New Customer/Supplier' ) || htf.formclose);
     end if;
    if seclevel in ( 'LEVEL 7' )
      then
      -- htp.tabledata( htf.formopen( 'strangp.mng_cust', ctarget=>'CUSTOMER_WINDOW' ) || htf.formhidden( 'SURL', surl ) || htf.formhidden( 'ID', 'z' ) || htf.formhidden( 'RID', null ) || htf.formsubmit( null, 'New Customer/Supplier' ) || htf.formclose,cattributes=>'VALIGN="TOP"');
      htp.p(pop_up_window( 'height=800,width=500,scrollbars=yes,resizable=yes'));
      v_link := '''strangp.ost_185_screen?surl=' || surl || '&action=NEW''';
      htp.tabledata('<form><input type="button" onClick="popUpWindow(' || v_link || ')" value="' || 'OST 185 Batch' || '"></form>');
      htp.tabledata('<form><input type="button" onClick="popUpWindow(' || v_link || ')" value="' || 'Generate OST 185' || '"></form>');
      htp.p(pop_up_window( 'height=600,width=500,scrollbars=yes,resizable=yes'));
      v_link := '''strangp.ost_185_batch?surl=' || surl || '''';
     end if;
     --htp.anchor2( 'oltp.process_query?id=z&rnd=' || to_char(sysdate,'SSSSS') || '&access_in=EDIT&surl=' || surl || '&rid=&scid=' || c3arec.screen_id || '&parm1=CUSTOMER&parm2=' || c4rec.oltp_id || '&parm3=&parm4==&sort=','New Receival', ctarget=>'_top');
     --htp.anchor2( 'oltp.process_query?id=z&rnd=' || to_char(sysdate,'SSSSS') || '&access_in=EDIT&surl=' || surl || '&rid=&scid=' || c3rec.screen_id || '&parm1=CUSTOMER&parm2=' || c4rec.oltp_id || '&parm3=&parm4==&sort=','New Customer/Supplier',ctarget=>'CUSTOMER_WINDOW');
     -- htp.anchor2( 'oltp.process_query?id=z&rnd=' || to_char(sysdate,'SSSSS') || '&access_in=EDIT&surl=' || surl || '&rid=&scid=' || c3rec.screen_id || '&parm1=SUPPLIER&parm2=' || c4rec.oltp_id || '&parm3=&parm4==&sort=','New Supplier',ctarget=>'CUSTOMER_WINDOW');
   end if;
  else
     htp.tabledata( '&nbsp;');
  -- htp.anchor2( 'oltp.process_query?id=z&rnd=' || to_char(sysdate,'SSSSS') || '&access_in=EDIT&surl=' || surl || '&rid=&scid=' || c3rec.screen_id || '&parm1=CUSTOMER&parm2=' || c4rec.oltp_id || '&parm3=&parm4==&sort=','New Customer/Supplier',ctarget=>'CUSTOMER_WINDOW');
  -- htp.anchor2( 'oltp.process_query?id=z&rnd=' || to_char(sysdate,'SSSSS') || '&access_in=EDIT&surl=' || surl || '&rid=&scid=' || c3rec.screen_id || '&parm1=SUPPLIER&parm2=' || c4rec.oltp_id || '&parm3=&parm4==&sort=','New Supplier',ctarget=>'CUSTOMER_WINDOW');
 end if;
 search( surl, 'RECEIVALS', rid, samerow=>TRUE, xtra1=>norder, xtra2=>n_local );
 htp.tablerowclose;
 htp.tableclose;

   htp.p( '</td>' );
  htp.tablerowclose;
 htp.tableclose;
 htp.bold( ttl );
 htp.p( '</CENTER>' );
 htp.htmlclose;
exception when others then
 error_details( 'STRANGP', 'RECEIVE_TOP',null,null,errmsg=>sqlerrm,extdet=>'PARM:' || parm);
end receive_top;

procedure accept_receive_top( surl in varchar2, rid in owa.vc_arr, scid in varchar2, parm in varchar2, access_id in varchar2, p1 in owa.vc_arr, p3 in owa.vc_arr, p4 in owa.vc_arr, p5 in owa.vc_arr, p6 in owa.vc_arr, p8 in owa.vc_arr, p3n in owa.vc_arr, action in varchar2, norder in varchar2 default null, n_local in char default 'L' )
as

 cursor c1( dlrv number ) is select 'x' from strang.receivals where deliveryno = dlrv;

 c1rec		c1%ROWTYPE;
 sts		varchar2(100);
 dt		date;
 newrid		rowid;
 xrate		number(6,4);
 tmp		char(1);
 nlog		varchar2(9);
 vrid		varchar2(100);
 vp1		varchar2(4000);
 vp3		varchar2(4000);
 vp4		varchar2(4000);
 vp5		varchar2(4000);
 vp6		varchar2(4000);
-- vp7		varchar2(4000);
 vp8		varchar2(4000);
 vp3n		varchar2(4000);

begin
 if not dapi.init( surl, 'STRANGP.ACCEPT_RECEIVE_TOP', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'ACCEPT_RECEIVE_TOP');
    return;
 end if;

/*
  for j in rid.first..rid.last loop
   htp.p( j || ':[' || rid(j) || '][' || p1(j) || '][' || p3(j) || '][' || p4(j) || '][' || p5(j) || '][' || p6(j) || '][' || p8(j) || '][' || p3n(j) || ']' ); htp.nl;
  end loop;
  return;
*/

 for j in rid.first..rid.last loop
  vrid := replace(rid(j),'~','+');
  vp1 := p1(j);
  vp3 := p3(j);
  vp4 := p4(j);
  vp5 := p5(j);
  vp6 := p6(j);
  vp8 := p8(j);
  vp3n := p3n(j);

  if action in ('Update Delivery', 'Insert New Delivery')
   then
    begin dt := to_date(vp3,LNG_MASK); exception when others then receive( surl, vrid, scid, null, parm, access_id, 'Invalid Date Entered. Must be in format' || ':' || LNG_MASK ); return; end;
    -- begin xrate := to_number(vp7); exception when others then receive( surl, vrid, scid, null, parm, access_id, 'The Exchange Rate is too large a number' || ':' || vp7 ); return; end;
    if vrid is null
     then
     insert into strang.receivals(deliveryno,currdate,curr,exrate,gstc_gstcode,cust_customer_id,supplier_customer_id,r_notes) values
       (vp1,dt,vp5,decode(vp5,'AUD',1,xrate),vp4,to_number(vp6),to_number(vp8), vp3n) returning rowid into newrid;
      -- Insert two dummy records
      nlog := null;
      insert  into strang.detailrs(deliveryno,itemno,sa,cl,pktpe_packtype,owner,partvolume,partweight,qty,logno) values
       (vp1,1,'S','C','UNIT','1',0,0,1,nlog);
      insert into strang.pos(deliveryno,recno,po,ctry_countrycode,gstc_gstcode,unit_unitused,qty,manual_grn,grn) values
       (vp1,1,0,'AU',vp4,'NO',1,'F',null); -- When a po record is created, if receivals.cust_customer_id = 1, the pos.grn is set to 0. Changed default for grn to null as requested by Sallie

    else
     update strang.receivals
      set
       currdate = dt,
       curr = vp5,
--       exrate = to_number(vp7),
       gstc_gstcode = vp4,
       cust_customer_id = to_number(vp6),
       supplier_customer_id = to_number(vp8),
       r_notes = vp3n
     where rowid = chartorowid(replace(vrid,'~','+'));
     newrid := chartorowid(replace(vrid,'~','+'));
   end if;

  elsif action = 'Cancel'
   then
    -- receive( surl, rid, scid, null, parm, 'x', 'Action Cancelled' );
    menu( surl, to_char(sysdate,'SSSS'), 'RECEIVALS');
    return;

  elsif action = 'Delete Delivery'
   then
    main_title( 'User Summary',helpid=>'STR66',dispmenu=>FALSE);
    htp.header( 2, 'Are You Sure you want to Delete this Record?', 'CENTER' );
    htp.nl;
    htp.p( '<CENTER>' );
    htp.tableopen;
    htp.tablerowopen;
    htp.p( '<td class="str1_bg_left">' );
    htp.formopen( 'strangp.accept_receive_top', ctarget=>'_top' );
    htp.formhidden( 'SURL', surl );
    htp.formhidden( 'RID', replace(vrid,'~','+') );
    htp.formhidden( 'SCID', scid );
    htp.formhidden( 'PARM', parm );
    htp.formhidden( 'ACCESS_ID', access_id );
    htp.formhidden( 'ACTION', 'DELX' );
    htp.formhidden( 'P1', vp1 );
    htp.formhidden( 'P3', vp3 );
    htp.formhidden( 'P4', vp4 );
    htp.formhidden( 'P5', vp5 );
    htp.formhidden( 'P6', vp6 );
--    htp.formhidden( 'P7', vp7 );
    htp.formhidden( 'P8', vp8 );
    htp.formhidden( 'P3N', vp3n );
    htp.formhidden( 'NORDER', norder );
    htp.formhidden( 'N_LOCAL', n_local );
    htp.formsubmit( null, 'Yes' );
    htp.formclose;
    htp.p( '</td>' );
    htp.p( '<td class="str1_bg_left">' );
    htp.formopen( 'strangp.receive', ctarget=>'_top' );
    htp.formhidden( 'SURL', surl );
    htp.formhidden( 'PARM', 'RECEIVALS-SINGULAR' );
    htp.formhidden( 'RID', replace(vrid,'~','+') );
    htp.formhidden( 'SCID', scid );
    htp.formhidden( 'CALL_NAME', null );
    htp.formhidden( 'ACCESS_ID', 'x' );
    htp.formhidden( 'MSG', 'Receival Deletion Cancelled' );
    htp.formhidden( 'NORDER', norder );
    htp.formhidden( 'N_LOCAL', n_local );
    htp.formsubmit( null, 'No' );
    htp.formclose;
    htp.p( '</td>' );
    htp.tablerowclose;
    htp.tableclose;
    htp.p( '</CENTER>' );
    htp.htmlclose;
    return;

  elsif action = 'DELX'
   then
    delete from strang.pos where deliveryno = (select deliveryno from strang.receivals where rowid = chartorowid(replace(vrid,'~','+')) );
    delete from strang.detailrs where deliveryno = (select deliveryno from strang.receivals where rowid = chartorowid(replace(vrid,'~','+')) );
    delete from strang.receivals where rowid = chartorowid(replace(vrid,'~','+'));
    menu( surl, to_char(sysdate,'SSSS'), 'RECEIVALS', norder=>norder, n_local=>n_local);
    return;
  end if;

 end loop;

 commit;

 if vrid is null or action in ('Update Delivery', 'Insert New Delivery')
  then
   -- Display 3 screen
   receive_single( surl, rowidtochar(newrid), scid, null, parm, 'x', 'Delivery Record successfully Inserted', norder=>norder, n_local=>n_local );
   return;
 end if;

 if action = 'Delete Delivery' -- Delete
   then
   receive( surl, null, scid, null, parm, 'z', 'Delivery Record Deleted', norder=>norder, n_local=>n_local );
  else
   receive( surl, vrid, scid, null, parm, 'x', 'Delivery Record(s) successfully Updated', norder=>norder, n_local=>n_local );
 end if;

exception when others then
 error_details( 'STRANGP', 'ACCEPT_RECEIVE_TOP',null,null,errmsg=>sqlerrm,extdet=>'RID:' || vrid);
end accept_receive_top;

procedure ost_185_screen(surl in varchar2, action in varchar2 default 'NEW', msg in varchar default null)
as

 cursor c1 is
select count(*)
from
(select distinct p.deliveryno, p.recno
from strang.pos p, strang.detailrs dr, strang.receivals r
where p.off_site_receipt is null and
  p.po_item_no is not null and
  p.deliveryno = r.deliveryno and
  p.deliveryno = dr.deliveryno and
  dr.deliveryno = p.deliveryno and
  r.cust_customer_id = 1   and
  dr.detaildesc not like '%PERSONAL EFFECT%' and
  substr(dr.logno,5,2) in ('BS','BA','CA'));

 cursor c3 ( acid integer, time_out integer ) is
  select count(*) tot
  from   login_session
  where  nvl(is_connected, 'F') = 'T'
         and aid <> acid
         and (nvl(date_updated, date_created) + time_out/1440) > sysdate
         and account_type not in ('A', 'C')
  ;

 cursor c4 ( acid integer, time_out integer ) is
  select l.*, a.username, a.account_name
  from   login_session l, account a
  where  nvl(l.is_connected, 'F') = 'T'
         and l.aid <> acid
         and l.aid = a.acctid
         and (nvl(l.date_updated, l.date_created) + time_out/1440) > sysdate
         and l.account_type not in ('A', 'C')
  order  by l.date_created
  ;

 c1rec    c1%ROWTYPE;
 stype     integer;
 ltype     varchar2(100);
 sts       varchar2(100);
 rec_ctr   integer;
 timeout   integer;
 login_cnt integer;
 profid    integer;

begin
 if not dapi.init( surl, 'STRANGP.OST_185_SCREEN', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'OST_185_SCREEN' );
    return;
 end if;

 begin timeout := to_number(gl.extract_master_parameter('DISCONNECT_AFTER')); exception when others then timeout := 180; end;

 main_title( 'OST 185 Report',helpid=>'STR01');

 open c3(dapi.GLOBAL_ACCOUNT.acctid, timeout);
 fetch c3 into login_cnt;
 close c3;

 if msg is not null
  then
   header_msg( msg );
 end if;

   open c1;
   fetch c1 into rec_ctr;
   close c1;
   if rec_ctr > 0 and action not in ('CONFIRM','CANCEL','MESSAGE')
    then
      htp.p('Report has aready been run today (' || rec_ctr || ' records processed).<BR><BR>Do you wish to re-run it? ');
      htp.anchor2('strangp.ost_185_screen?surl=' || surl || '&action=CONFIRM','[Yes]');
      htp.anchor2('strangp.ost_185_screen?surl=' || surl || '&action=CANCEL&msg=Action Cancelled','[No]');
   elsif action in ('CANCEL', 'MESSAGE')
    then
     null;
   elsif nvl(login_cnt, 0) > 0
    then
     header_msg( 'Cannot run report. The following users are logged on:');
     htp.tableopen( cattributes=>'class="str1_table"' );
     htp.tablerowopen;
     htp.tableheader('Username', cattributes=>'class="str1_bg_left"');
     htp.tableheader('Account name', cattributes=>'class="str1_bg_left"');
     htp.tableheader('Date connected', cattributes=>'class="str1_bg_left"');
     htp.tableheader('Date updated', cattributes=>'class="str1_bg_left"');
     htp.tablerowclose;
     for c4rec in c4(dapi.GLOBAL_ACCOUNT.acctid, timeout) loop
      htp.tablerowopen;
      htp.tabledata(c4rec.username, cattributes=>'class="str1_bg_left"');
      htp.tablerowclose;
      htp.tabledata(c4rec.account_name, cattributes=>'class="str1_bg_left"');
      htp.tabledata(to_char(c4rec.date_created, 'dd-MON-yyyy hh24:mi:ss'), cattributes=>'class="str1_bg_left"');
      htp.tabledata(to_char(c4rec.date_updated, 'dd-MON-yyyy hh24:mi:ss'), cattributes=>'class="str1_bg_left"');
     end loop;
     htp.tableclose;
   else
     update strang.pos set off_site_receipt = null where off_site_receipt >= trunc(sysdate);
     generate_ost185( surl, sysdate );
     return;
   end if;
   htp.nl;
   htp.nl;
   htp.p('<a href="" onClick="self.close()">[Close Window]</a>');
  htp.bodyclose;

 htp.htmlclose;

exception when others then
 error_details( 'STRANGP', 'OST_185_SCREEN',null,null,errmsg=>sqlerrm);
end ost_185_screen;

procedure ost_185_batch(surl in varchar2, msg in varchar default null)
as

cursor c1 is
 select *
 from   user_scheduler_jobs
 where  job_name = 'OST_185_BATCH'
 ;

cursor c2 (j_name varchar2) is
 select * from user_scheduler_job_run_details
 where  job_name = j_name
 order  by log_date desc
 ;


 stype     integer;
 ltype     varchar2(100);
 sts       varchar2(100);
 c1rec     c1%ROWTYPE;
 c2rec     c2%ROWTYPE;

begin
 if not dapi.init( surl, 'STRANGP.OST_185_BATCH', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'OST_185_BATCH');
    return;
 end if;

 main_title( 'OST 185 Batch Job Definition',helpid=>'STR02');

 if msg is not null
  then
   header_msg( msg );
 end if;

 open c1;
 fetch c1 into c1rec;
 close c1;

 open c2 (nvl(c1rec.job_name, 'OST_185_BATCH'));
 fetch c2 into c2rec;
 close c2;

 htp.formopen('strangp.accept_ost_185_batch');
 htp.formhidden('surl', surl);
 htp.formhidden('job_name', nvl(c1rec.job_name, 'OST_185_BATCH'));

 htp.tableopen( cattributes=>'class="str1_table"' );
 htp.tablerowopen;
  htp.tabledata('Start Date<BR><I>DD-MON-YYYY</I>', cattributes=>'class="str1_bg_left"');
  htp.tabledata(htf.formtext('P1', 20, 15, to_char(nvl(c1rec.start_date, sysdate), LNG_MASK)), cattributes=>'class="str1_cell_left"');
 htp.tablerowclose;
 htp.tablerowopen;
  htp.tabledata('Run Time<BR><I>HH24:MM</I>', cattributes=>'class="str1_bg_left"');
  htp.tabledata(htf.formtext('P2', 20, 15, to_char(nvl(c1rec.start_date, sysdate), 'hh24:mi')), cattributes=>'class="str1_cell_left"');
 htp.tablerowclose;
 htp.tablerowopen;
  htp.tabledata('Last Run Time: ', cattributes=>'class="str1_bg_left"');
  htp.tabledata(nvl(to_char(c2rec.log_date, 'DD-MON-YYYY HH24:MI'), 'Job not run'), cattributes=>'class="str1_cell_left"');
 htp.tablerowclose;
 htp.tablerowopen;
  htp.tabledata('Result: ', cattributes=>'class="str1_bg_left"');
  htp.tabledata(nvl(c2rec.additional_info, c2rec.status), cattributes=>'class="str1_cell_left"');
 htp.tablerowclose;
 htp.tablerowopen;
  htp.tabledata('Next Run Time: ', cattributes=>'class="str1_bg_left"');
  htp.tabledata(nvl(to_char(c1rec.next_run_date, 'DD-MON-YYYY HH24:MI'), 'Job not enabled'), cattributes=>'class="str1_cell_left"');
 htp.tablerowclose;
 htp.tableclose;

 htp.formsubmit( 'ACTION', 'Update');
 htp.formsubmit( 'ACTION', 'Cancel');

 htp.formclose;

 htp.nl;
 htp.nl;
 htp.p('<a href="" onClick="self.close()">[Close Window]</a>');
 htp.bodyclose;

 htp.htmlclose;

exception when others then
 error_details( 'STRANGP', 'OST_185_BATCH',null,null,errmsg=>sqlerrm);
end ost_185_batch;

procedure accept_ost_185_batch( surl in varchar2, job_name in varchar2, p1 in varchar2, p2 in varchar2, action in varchar2 default 'CANCEL')
as


 stype     integer;
 ltype     varchar2(100);

 sts       varchar2(100);

 start_dte date;

begin
 if not dapi.init( surl, 'STRANGP.ACCEPT_OST_185_BATCH', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'ACCEPT_OST_185_BATCH' );
    return;
 end if;

 if upper(action) in ('CANCEL')
  then
   ost_185_batch(surl, 'Update Cancelled');
   return;
 elsif upper(action) in ('UPDATE')
  then
   begin
    start_dte := to_date(trim(p1) || ' ' || trim(p2), 'DD-MON-YYYY HH24:MI');
   exception when others then
    ost_185_batch(surl, 'Date must be format "' || LNG_MASK || '".<BR>Time must be format "hh24:mm"');
    return;
   end;
   if start_dte < sysdate
    then
   begin dbms_scheduler.drop_job(job_name); exception when others then null; end;
     ost_185_batch(surl, 'Date cannot be in the past: ' || to_char(start_dte, 'DD-MON-YYYY HH24:MI'));
     return;
   end if;
   dbms_scheduler.create_job( job_name=> job_name
                            , job_type=> 'STORED_PROCEDURE'
                            , job_action=> 'strangp.generate_ost185'
                            , start_date=> start_dte
                            , repeat_interval=> 'FREQ=DAILY;INTERVAL=1'
                            , number_of_arguments=> 3
                            , enabled=> FALSE
                            , comments=> 'Generate OST185'
                           )
   ;
   dbms_scheduler.set_job_argument_value( job_name => job_name
                                        , argument_position => 1
                                        , argument_value => surl
                                        )
   ;

   dbms_scheduler.set_job_argument_value( job_name => job_name
                                        , argument_position => 2
                                        , argument_value => sysdate
                                        )
   ;

   dbms_scheduler.set_job_argument_value( job_name => job_name
                                        , argument_position => 3
                                        , argument_value => 'TRUE'
                                        )
   ;

   dbms_scheduler.enable(job_name);
   ost_185_batch(surl, 'Batch job created: ' || to_char(start_dte, 'DD-MON-YYYY HH24:MI'));
   return;
 end if;

ost_185_batch(surl, 'Invlid action: ' || action);
return;

exception when others then
 error_details( 'STRANGP', 'ACCEPT_OST_185_BATCH',null,null,errmsg=>sqlerrm);
end accept_ost_185_batch;

procedure receive_bottom(surl in varchar2, rid in varchar2, scid in varchar2, call_name in varchar2, parm in varchar2, access_id in varchar2 default null, recctr in integer default 1, msg in varchar2 default NULL, force_single_disp in char default 'F', popup in char default 'F' )
as

 cursor c2( rid rowid ) is select * from strang.receivals where rowid = rid;

 cursor c3( dlrvy number ) is
  select r.rowid,r.*
  from strang.detailrs r
  where deliveryno = dlrvy
  order by itemno,logno;

 cursor c3t( dlrvy number ) is
  select count('x') tot
  from strang.detailrs
  where deliveryno = dlrvy
  order by itemno,logno;

 cursor c4( dlrvy number ) is select count('x') tot,min(itemno) vmn, max(itemno) vmx from strang.detailrs where deliveryno = dlrvy;

 cursor c5(hwb varchar2) is select mawb from strang.hawbs where hawb = hwb;
 cursor c6(dlry number, sto varchar2) is select max(itemno) tot from strang.detailrs where deliveryno = dlry; --  and site_owner = sto
 cursor c7(dlry number) is select max(itemno) + 1 tot from strang.detailrs where deliveryno = dlry;
 cursor c9 is select code,description,cola from strang.lov where lov_name = 'WAREHOUSES' order by code;
 cursor c10(v_entry number) is select * from strang.duty where entry_no = v_entry;
 cursor c11i( vmv varchar2, vsl varchar2 ) is select s.*, m.CUSTOMS_CLEARED_DATE, m.bol from strang.ships_airway s, strang.movements m where m.movement_no = vmv and m.ship_id = s.ship_id and nvl(vsl,'|') = nvl(m.seal,'|');
 cursor c11l( vmv varchar2, vsl varchar2 ) is select s.*, m.CUSTOMS_CLEARED_DATE, m.local_bol from strang.ships_airway s, strang.movements m where m.movement_no = vmv and m.local_ship_id = s.ship_id and nvl(vsl,'|') = nvl(m.seal,'|');
 cursor c11c( vmv varchar2, vsl varchar2 ) is select s.*, m.CUSTOMS_CLEARED_DATE, m.bol from strang.ships_airway s, strang.movements m where m.movement_no = vmv and m.convoy_id = s.ship_id and nvl(vsl,'|') = nvl(m.seal,'|');

 c2rec		c2%ROWTYPE;
 c3rec		c3%ROWTYPE;
 c4rec		c4%ROWTYPE;
 c5rec		c5%ROWTYPE;
 c7rec		c7%ROWTYPE;
 c9rec		c9%ROWTYPE;
 c10rec         c10%ROWTYPE;
 vrecctr	integer;
 sts		varchar2(100);
 vaccess	varchar2(20);
 ttl		varchar2(200);
 seclevel	varchar2(100);
 vtot		integer;
 si_rec		c11i%ROWTYPE;
 sl_rec		c11l%ROWTYPE;
 sc_rec		c11c%ROWTYPE;
 url		varchar2(1000);

begin
 if not dapi.init( surl, 'STRANGP.RECEIVE_BOTTOM', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'RECEIVE_BOTTOM' );
    return;
 end if;

 vaccess := data_access( 'DETAILRS' );

 seclevel := security_role( dapi.GLOBAL_ACCOUNT.acctid );
 open c2( replace(rid,'~','+') );
 fetch c2 into c2rec;
 close c2;

 open c3t( c2rec.deliveryno );
 fetch c3t into vtot;
 close c3t;

 if access_id = 'z'
  then
   ttl := 'Please Enter in Receival Details';
   main_title( helpid=>'STR03', dispmenu=>FALSE);
   return;
  else
   if recctr > 0
    then
     open c4( c2rec.deliveryno );
     fetch c4 into c4rec;
     close c4;
     vrecctr := recctr;
     if recctr > c4rec.tot then vrecctr := c4rec.tot; end if;
     ttl := nvl(msg,'Update Detail' || ' (' || vrecctr || '/' || c4rec.tot || ')');
     main_title( helpid=>'STR04', dispmenu=>FALSE);
    else
     vrecctr := 0;
     ttl := nvl(msg,'Insert New Detail');

     main_title( helpid=>'STR04', dispmenu=>FALSE);
   end if;
 end if;
 if vaccess = 'READ' and vrecctr = 0
  then
   vrecctr := 1;
 end if;

 if vaccess = 'NONE' then htp.bold( 'Access Denied' ); htp.htmlclose; return; end if;
 htp.p( '<CENTER>' );
 if vaccess = 'EDIT'
  then
   htp.formopen( '!strangp.accept_receive_detailr' );
   htp.formhidden( 'SURL', surl );
   htp.formhidden( 'RID', replace(rid,'~','+') );
   htp.formhidden( 'SCID', scid );
   htp.formhidden( 'PARM', parm );
   htp.formhidden( 'ACCESS_ID', access_id );
   -- Added at Sallies Request, behaviour is now on insert to stay on current screen
   if vrecctr = 0
    then
     open c7(c2rec.deliveryno);
     fetch c7 into c7rec;
     close c7;
     c7rec.tot := nvl(c7rec.tot,1);
     htp.formhidden( 'RECCTR', c7rec.tot);
    else
     htp.formhidden( 'RECCTR', vrecctr);
   end if;
   if FORCE_SINGLE_DISP = 'T'
    then
     htp.formhidden( 'FORCE_SINGLE_DISP', 'T');
    else
     if vtot > 1 or FORCE_SINGLE_DISP = 'Z'
      then
       htp.formhidden( 'FORCE_SINGLE_DISP', 'F');
      else
       htp.formhidden( 'FORCE_SINGLE_DISP', 'F');
     end if;
   end if;
 end if;

 if vrecctr > 0
  then
   open c3( c2rec.deliveryno );
   for j in 1..vrecctr loop
   fetch c3 into c3rec;
    if c3%NOTFOUND then exit; end if;
   end loop;
   close c3;
 else
   -- New record, copied, defaults reset
   c3rec.PKTPE_PACKTYPE := 'UNIT';
   c3rec.qty := 1;
   c3rec.partweight := 0;
   c3rec.partvolume := 0;
 end if;

 -- Multi Display
 if (vtot > 1 and force_single_disp = 'F') or (force_single_disp = 'Z')
  then
   htp.tableopen( cattributes=>'class="str1_table"' );
    htp.tablerowopen;
     htp.tabledata( htf.bold( 'Item #' ),cattributes=>'class="str1_bg_center"');
     htp.tabledata( htf.bold( 'Log No' ),cattributes=>'class="str1_bg_center"');
     htp.tabledata( htf.bold( 'Air or Sea' ),cattributes=>'class="str1_bg_center"');
     htp.tabledata( htf.bold( 'C or L' ),cattributes=>'class="str1_bg_center"');
     htp.tabledata( htf.bold( 'Handling<br />Unit/Case#' ),cattributes=>'class="str1_bg_center"');
     htp.tabledata( htf.bold( 'Qty' ),cattributes=>'class="str1_bg_center"');
     htp.tabledata( htf.bold( 'Pack Type' ),cattributes=>'class="str1_bg_center"');
     htp.tabledata( htf.bold( 'Weight' ),cattributes=>'class="str1_bg_center"');
     htp.tabledata( htf.bold( 'Volume' ),cattributes=>'class="str1_bg_center"');
     htp.tabledata( htf.bold( 'ECN' ),cattributes=>'class="str1_bg_center"');
     htp.tabledata( htf.bold( 'Hazard' ),cattributes=>'class="str1_bg_center"');
     htp.tabledata( htf.bold( 'Warehouse' ),cattributes=>'class="str1_bg_center"');
     htp.tabledata( htf.bold( 'Description' ),cattributes=>'class="str1_bg_center"');
     htp.tabledata( htf.bold( 'Entry No' ),cattributes=>'class="str1_bg_center"');
     htp.tabledata( htf.bold( 'Line No' ),cattributes=>'class="str1_bg_center"');
     htp.tabledata( htf.bold( 'HAWB' ),cattributes=>'class="str1_bg_center"');
     htp.tabledata( htf.bold( 'Action' ),cattributes=>'class="str1_bg_center"');
    htp.tablerowclose;
    for c3rec in c3(c2rec.deliveryno) loop
     if vaccess = 'EDIT'
      then
       htp.tablerowopen;
        htp.tabledata( htf.formhidden( 'DETRID', rowidtochar( c3rec.rowid )) || c3rec.itemno,cattributes=>'class="str1_bg_left"');
        htp.tabledata( c3rec.logno,cattributes=>'class="str1_bg_left"');
        htp.tabledata( c3rec.sa,cattributes=>'class="str1_bg_left"');
        htp.tabledata( c3rec.cl,cattributes=>'class="str1_bg_left"');
        htp.tabledata( c3rec.handling_unit,cattributes=>'class="str1_bg_left"');
        htp.tabledata( c3rec.qty,cattributes=>'class="str1_bg_left"');
        htp.tabledata( c3rec.pktpe_packtype,cattributes=>'class="str1_bg_left"');
        htp.tabledata( c3rec.partweight,cattributes=>'class="str1_bg_left"');
        htp.tabledata( c3rec.partvolume,cattributes=>'class="str1_bg_left"');
        htp.tabledata( c3rec.ecn,cattributes=>'class="str1_bg_left"');
        htp.tabledata( c3rec.hazard,cattributes=>'class="str1_bg_left"');
        htp.tabledata( c3rec.warehouse,cattributes=>'class="str1_bg_left"');
        htp.tabledata( c3rec.detaildesc,cattributes=>'class="str1_bg_left"');
        htp.tabledata( c3rec.entry_no,cattributes=>'class="str1_bg_left"');
        htp.tabledata( c3rec.line_no,cattributes=>'class="str1_bg_left"');
        htp.tabledata( c3rec.hawb_hawbno,cattributes=>'class="str1_bg_left"');
        htp.tabledata( '&nbsp;',cattributes=>'class="str1_bg_left"');
       htp.tablerowclose;
      else
       htp.tablerowopen;
        htp.tabledata( c3rec.itemno,cattributes=>'class="str1_bg_left"');
        htp.tabledata( c3rec.logno,cattributes=>'class="str1_bg_left"');
        htp.tabledata( c3rec.sa,cattributes=>'class="str1_bg_left"');
        htp.tabledata( c3rec.cl,cattributes=>'class="str1_bg_left"');
        htp.tabledata( c3rec.handling_unit,cattributes=>'class="str1_bg_left"');
        htp.tabledata( c3rec.qty,cattributes=>'class="str1_bg_left"');
        htp.tabledata( c3rec.pktpe_packtype,cattributes=>'class="str1_bg_left"');
        htp.tabledata( c3rec.partweight,cattributes=>'class="str1_bg_left"');
        htp.tabledata( c3rec.partvolume,cattributes=>'class="str1_bg_left"');
        htp.tabledata( c3rec.ecn,cattributes=>'class="str1_bg_left"');
        htp.tabledata( c3rec.hazard,cattributes=>'class="str1_bg_left"');
        htp.tabledata( c3rec.warehouse,cattributes=>'class="str1_bg_left"');
        htp.tabledata( c3rec.detaildesc,cattributes=>'class="str1_bg_left"');
        htp.tabledata( c3rec.entry_no,cattributes=>'class="str1_bg_left"');
        htp.tabledata( c3rec.line_no,cattributes=>'class="str1_bg_left"');
        htp.tabledata( c3rec.hawb_hawbno,cattributes=>'class="str1_bg_left"');
        htp.tabledata( '&nbsp;',cattributes=>'class="str1_bg_left"');
       htp.tablerowclose;
     end if;
    end loop;
   htp.tableclose;
   htp.nl;
   htp.bold( ttl );
   htp.nl;
   htp.bold( '<a href="" onClick="self.close()">' || LNG.GLB_TXT_033 || '</a>');
   htp.p( '</CENTER>' );
   htp.htmlclose;
   --htp.header(3,'trace detailrs- total = ' || vtot || '[' || vrecctr || ']' );
   return;
 end if;

 if vaccess = 'EDIT' then htp.formhidden( 'DETRID', rowidtochar( c3rec.rowid )); end if;

 -- Single Display
 htp.tableopen( cattributes=>'class="str1_table"' );
  htp.tablerowopen;
     htp.tabledata( 'Item #',cattributes=>'class="str1_hd_left"');
     if c3rec.rowid is null
      then
       open c6( c2rec.deliveryno, currsite );
       fetch c6 into c3rec.itemno;
       close c6;
       c3rec.itemno := nvl(c3rec.itemno,0) + 1;
     end if;
     htp.tabledata( c3rec.itemno, cattributes=>'class="str1_hd_left"' );
     if vaccess = 'EDIT' then htp.formhidden( 'P1', c3rec.itemno ); end if;
     htp.tabledata( 'Log No',cattributes=>'class="str1_hd_left"');
     if vaccess = 'EDIT'
      then
      if seclevel in ( 'LEVEL 8' )
       then
         htp.tabledata( htf.formhidden( 'P2', c3rec.logno ) || c3rec.logno, cattributes=>'class="str1_bg_left"' );
       else
       if c3rec.rowid is null or c3rec.logno is null
        then
           htp.tabledata( htf.formradio( 'A1','T','CHECKED' ) || ' ' || 'Use Todays' || htf.nl ||
                         htf.formradio( 'A1','N' ) || ' ' || 'Create New',cattributes=>'class="str1_bg_left"');
        else
         htp.tabledata( htf.formtext( 'P2', 9, 9, c3rec.logno), cattributes=>'class="str1_bg_left"' );
       end if;
      end if;
      else
         htp.tabledata( c3rec.logno, cattributes=>'class="str1_bg_left"' );
     end if;
      htp.tabledata( 'I/O',cattributes=>'class="str1_hd_left"');
     if vaccess = 'EDIT'
      then
       htp.p( '<TD ' || 'class="str1_bg_left">' );
        htp.formselectopen( 'N1' );
        if nvl(c3rec.io,'I') = 'I'
         then
          htp.formselectoption( 'Inbound', 'SELECTED', cattributes=>'VALUE="I"' );
          htp.formselectoption( 'Outbound', cattributes=>'VALUE="O"' );
         else
          htp.formselectoption( 'Inbound', cattributes=>'VALUE="I"' );
          htp.formselectoption( 'Outbound', 'SELECTED', cattributes=>'VALUE="O"' );
        end if;
        htp.formselectclose;
       htp.p( '</TD>' );
      else
      case c3rec.io
       when 'I' then htp.tabledata( 'Inbound', cattributes=>'class="str1_bg_left"' );
       when 'O' then  htp.tabledata( 'Outbound', cattributes=>'class="str1_bg_left"' );
       else htp.tabledata( c3rec.io, cattributes=>'class="str1_bg_left"' );
      end case;
    end if;
/*
    htp.p( '<td class="str1_bg_center" colspan="3" rowspan="3">' );

      htp.tableopen( cattributes=>'class="str1_int"' );
       htp.tablerowopen;
        htp.tableheader( 'Consolidation Details', cattributes=>'colspan="3"');
       htp.tablerowclose;
       htp.tablerowopen;
        htp.tableheader( 'Movement No');
        htp.tableheader( 'Seal');
        htp.tableheader( 'HAWB');
       htp.tablerowclose;
       htp.tablerowopen;
        htp.tabledata( nvl(c3rec.movement_no,'&nbsp;'));
        htp.tabledata( nvl(c3rec.camov_seal,'&nbsp;'));
        htp.tabledata( nvl(to_char(c3rec.hawb_hawbno),'&nbsp;'));
       htp.tablerowclose;
       htp.tablerowopen;
        htp.tabledata( nvl(c3rec.movement_no_2,'&nbsp;'));
        htp.tabledata( nvl(c3rec.camov_seal_2,'&nbsp;'));
        htp.tabledata( nvl(to_char(c3rec.hawb_hawbno_2),'&nbsp;'));
       htp.tablerowclose;
      htp.tableclose;

     htp.p( '</td>' );
*/
     htp.tabledata( 'DAN',cattributes=>'class="str1_hd_left"');
     if vaccess = 'EDIT'
      then
       htp.p( '<TD ' || 'class="str1_bg_left">' );
        htp.formtext( 'N5', 20, 20, html_format(c3rec.dan));
       htp.p( '</TD>' );
      else
       htp.p( '<TD ' || 'class="str1_bg_left">' );
        htp.p( c3rec.dan );
       htp.p( '</TD>' );
     end if;

  htp.tablerowclose;

  htp.tablerowopen;
     htp.tabledata( 'Air or Sea',cattributes=>'class="str1_hd_left"');
     if vaccess = 'EDIT'
      then
      if seclevel in ( 'LEVEL 8' )
       then
        if c3rec.sa = 'A'
         then
          htp.tabledata( htf.formhidden( 'P3', c3rec.sa ) || 'Air', cattributes=>'class="str1_bg_left"' );
         else
          htp.tabledata( htf.formhidden( 'P3', c3rec.sa ) || 'Sea', cattributes=>'class="str1_bg_left"' );
        end if;
       else
       htp.p( '<TD ' || 'class="str1_bg_left">' );
        htp.formselectopen( 'P3' );
        if c3rec.sa = 'A'
         then
          htp.formselectoption( 'Air', 'SELECTED', cattributes=>'VALUE="A"' );
          htp.formselectoption( 'Sea', cattributes=>'VALUE="S"' );
         else
          htp.formselectoption( 'Air', cattributes=>'VALUE="A"' );
          htp.formselectoption( 'Sea', 'SELECTED', cattributes=>'VALUE="S"' );
        end if;
        htp.formselectclose;
       htp.p( '</TD>' );
       end if;
      else
         htp.tabledata( c3rec.sa, cattributes=>'class="str1_bg_left"' );
     end if;
     htp.tabledata( 'C or L',cattributes=>'class="str1_hd_left"');
     if vaccess = 'EDIT'
      then
      if seclevel in ( 'LEVEL 8' )
       then
        if c3rec.cl = 'L'
         then
          htp.tabledata( htf.formhidden( 'P8', c3rec.cl ) || 'C', cattributes=>'class="str1_bg_left" ' );
         else
          htp.tabledata( htf.formhidden( 'P8', c3rec.cl ) || 'L', cattributes=>'class="str1_bg_left"' );
        end if;
       else
       htp.p( '<TD ' || 'class="str1_bg_left">' );
        htp.formselectopen( 'P8' );
        if c3rec.cl = 'L'
         then
          htp.formselectoption( 'C', cattributes=>'VALUE="C"' );
          htp.formselectoption( 'L', 'SELECTED', cattributes=>'VALUE="L"' );
         else
          htp.formselectoption( 'C', 'SELECTED', cattributes=>'VALUE="C"' );
          htp.formselectoption( 'L', cattributes=>'VALUE="L"' );
        end if;
        htp.formselectclose;
       htp.p( '</TD>' );
       end if;
     else
      htp.tabledata( c3rec.cl, cattributes=>'class="str1_bg_left"' );
    end if;
     htp.tabledata( '&nbsp;',cattributes=>'class="str1_bg_left"' );
     htp.tabledata( '&nbsp;',cattributes=>'class="str1_bg_left"' );
     htp.tabledata( 'RFTS',cattributes=>'class="str1_hd_left"');
     if vaccess = 'EDIT'
      then
       htp.p( '<TD ' || 'class="str1_bg_left">' );
        htp.formtext( 'N6', 20, 20, html_format(c3rec.rfts));
       htp.p( '</TD>' );
      else
       htp.p( '<TD ' || 'class="str1_bg_left">' );
        htp.p( c3rec.rfts );
       htp.p( '</TD>' );
     end if;
  --   htp.tabledata( 'OTML Handling Unit (HU)',cattributes=>'class="str1_hd_left"');
  htp.tablerowclose;

  htp.tablerowopen;
  if vaccess = 'EDIT'
   then
      if c3rec.movement_no is null
       then
        htp.tabledata( '&nbsp;',cattributes=>'class="str1_bg_left" colspan="6"');
       else
       htp.tabledata( '2nd Leg',cattributes=>'class="str1_hd_left"');
       htp.p( '<TD ' || 'class="str1_bg_left">' );
        htp.formselectopen( 'N2' );
        if c3rec.sa_2 = 'A'
         then
          htp.formselectoption( 'Air', 'SELECTED', cattributes=>'VALUE="A"' );
          htp.formselectoption( 'Sea', cattributes=>'VALUE="S"' );
         else
          htp.formselectoption( 'Air', cattributes=>'VALUE="A"' );
          htp.formselectoption( 'Sea', 'SELECTED', cattributes=>'VALUE="S"' );
        end if;
        htp.formselectclose;
       htp.p( '</TD>' );
       htp.tabledata( 'C or L',cattributes=>'class="str1_hd_left"');
       htp.p( '<TD ' || 'class="str1_bg_left">' );
        htp.formselectopen( 'N3' );
        if c3rec.cl_2 = 'L'
         then
          htp.formselectoption( 'C', cattributes=>'VALUE="C"' );
          htp.formselectoption( 'L', 'SELECTED', cattributes=>'VALUE="L"' );
         else
          htp.formselectoption( 'C', 'SELECTED', cattributes=>'VALUE="C"' );
          htp.formselectoption( 'L', cattributes=>'VALUE="L"' );
        end if;
        htp.formselectclose;
       htp.p( '</TD>' );
        htp.tabledata( 'Secondary Leg',cattributes=>'class="str1_hd_left"');
        htp.p( '<TD ' || 'class="str1_bg_left">' );
         htp.formselectopen( 'N4' );
         --  C,L,I,CL,CI,LI
         htp.formselectoption( null, cattributes=>'VALUE=""' );
         if c3rec.legs_2 = 'C' then htp.formselectoption( 'C', 'SELECTED', cattributes=>'VALUE="C"' ); else htp.formselectoption( 'C', cattributes=>'VALUE="C"' ); end if;
         if c3rec.legs_2 = 'L' then htp.formselectoption( 'L', 'SELECTED', cattributes=>'VALUE="L"' ); else htp.formselectoption( 'L', cattributes=>'VALUE="L"' ); end if;
         if c3rec.legs_2 = 'I' then htp.formselectoption( 'I', 'SELECTED', cattributes=>'VALUE="I"' ); else htp.formselectoption( 'I', cattributes=>'VALUE="I"' ); end if;
         if c3rec.legs_2 = 'CL' then htp.formselectoption( 'CL', 'SELECTED', cattributes=>'VALUE="CL"' ); else htp.formselectoption( 'CL', cattributes=>'VALUE="CL"' ); end if;
         if c3rec.legs_2 = 'CI' then htp.formselectoption( 'CI', 'SELECTED', cattributes=>'VALUE="CI"' ); else htp.formselectoption( 'CI', cattributes=>'VALUE="CI"' ); end if;
         if c3rec.legs_2 = 'LI' then htp.formselectoption( 'LI', 'SELECTED', cattributes=>'VALUE="LI"' ); else htp.formselectoption( 'LI', cattributes=>'VALUE="LI"' ); end if;
         htp.formselectclose;
        htp.p( '</TD>' );
--     end if;
    end if;
     htp.tabledata( 'HB',cattributes=>'class="str1_hd_left"');
     if vaccess = 'EDIT'
      then
       htp.p( '<TD ' || 'class="str1_bg_left">' );
        htp.formtext( 'N7', 20, 100, html_format(c3rec.hb));
       htp.p( '</TD>' );
      else
       htp.p( '<TD ' || 'class="str1_bg_left">' );
        htp.p( c3rec.hb );
       htp.p( '</TD>' );
     end if;

   else
    -- xxx finish for RO
      if c3rec.movement_no is null
       then
        htp.tabledata( '&nbsp;',cattributes=>'class="str1_bg_left" colspan="8"');
       else
        htp.tabledata( 'I/O',cattributes=>'class="str1_hd_left"');
        htp.tabledata( c3rec.io,cattributes=>'class="str1_bg_left"');
        htp.tabledata( '2nd Leg',cattributes=>'class="str1_hd_left"');
        htp.tabledata( c3rec.sa_2,cattributes=>'class="str1_bg_left"');
        htp.tabledata( 'C or L',cattributes=>'class="str1_hd_left"');
        htp.tabledata( c3rec.cl_2,cattributes=>'class="str1_bg_left"');
        htp.tabledata( 'Secondary Leg',cattributes=>'class="str1_hd_left"');
        htp.p( '<TD ' || 'class="str1_bg_left">' );
         htp.p( c3rec.legs_2 );
        htp.p( '</TD>' );
     end if;

  end if;
  htp.tablerowclose;

  if c3rec.legs_2 is null or instr(c3rec.legs_2,'I') = 0
   then
    open c11i(c3rec.movement_no, c3rec.camov_seal);
    fetch c11i into si_rec;
    close c11i;
   else
    open c11i(c3rec.movement_no_2, c3rec.camov_seal_2);
    fetch c11i into si_rec;
    close c11i;
  end if;
  if c3rec.legs_2 is null or instr(nvl(c3rec.legs_2,'|'),'L') = 0
   then
     open c11l(c3rec.movement_no, c3rec.camov_seal);
     fetch c11l into sl_rec;
     close c11l;
   else
    open c11l(c3rec.movement_no_2, c3rec.camov_seal_2);
    fetch c11l into sl_rec;
    close c11l;
  end if;
  if c3rec.legs_2 is null or instr(c3rec.legs_2,'C') = 0
   then
    open c11c(c3rec.movement_no, c3rec.camov_seal);
    fetch c11c into sc_rec;
    close c11c;
   else
    open c11c(c3rec.movement_no_2, c3rec.camov_seal_2);
    fetch c11c into sc_rec;
    close c11c;
  end if;

  htp.tablerowopen;
     htp.tabledata( 'Qty',cattributes=>'class="str1_hd_left"');
     if vaccess = 'EDIT'
      then
      if seclevel in ( 'LEVEL 8' )
       then
        htp.tabledata( htf.formhidden( 'P6', c3rec.qty ) || c3rec.qty, cattributes=>'class="str1_bg_left"' );
       else
        htp.tabledata( htf.formtext( 'P6', 15, 15, c3rec.qty), cattributes=>'class="str1_bg_left"' );
       end if;
      else
       htp.tabledata( c3rec.qty, cattributes=>'class="str1_bg_left"' );
     end if;
     htp.tabledata( 'Pack Type',cattributes=>'class="str1_hd_left"');
     if vaccess = 'EDIT'
      then
      if seclevel in ( 'LEVEL 8' )
       then
        htp.tabledata( htf.formhidden( 'P7', c3rec.pktpe_packtype ) || c3rec.pktpe_packtype, cattributes=>'class="str1_bg_left"' );
       else
        htp.p( '<TD ' || 'class="str1_bg_left">' );
         htp.formtext( 'P7', 10, 4, c3rec.pktpe_packtype );
        htp.p( '</TD>' );
       end if;
      else
       htp.tabledata( c3rec.pktpe_packtype, cattributes=>'class="str1_cell_right"' );
     end if;

    htp.p( '<td class="str1_bg_center" colspan="4" rowspan="4">' );

      htp.tableopen( cattributes=>'class="str1_int"' );
       htp.tablerowopen;
        htp.tableheader( 'Shipping Details');
        htp.tableheader( 'Movement No');
        htp.tableheader( 'Ship');
        htp.tableheader( 'ID');
        htp.tableheader( 'Seal');
        htp.tableheader( 'HAWB');
        htp.tableheader( 'Line No/Bill');
        htp.tableheader( 'Est Arrive');
        htp.tableheader( 'Customs Cleared');
        htp.tableheader( 'Entry No');
       htp.tablerowclose;
       htp.tablerowopen;
        htp.tableheader( 'International Ship');
        htp.tabledata( nvl(c3rec.movement_no,'&nbsp;'));
        htp.tabledata( si_rec.shipname || ' ' || si_rec.voy);
        htp.tabledata( si_rec.ship_id);
        htp.tabledata( nvl(c3rec.camov_seal,'&nbsp;'));
        htp.tabledata( nvl(to_char(c3rec.hawb_hawbno),'&nbsp;'));
        htp.tabledata( to_char(c3rec.line_no) || '/' || si_rec.bol);
        htp.tabledata( nvl(to_char(si_rec.estarrive,'DD-MON-YYYY'),'&nbsp;'));
        htp.tabledata( nvl(to_char(si_rec.customs_cleared_date,'DD-MON-YYYY'),'&nbsp;'));
        htp.tabledata( nvl(to_char(c3rec.entry_no),'&nbsp;'));
       htp.tablerowclose;
       htp.tablerowopen;
        htp.tableheader( 'Local Ship');
        if c3rec.legs_2 is null or instr(nvl(c3rec.legs_2,'|'),'L') = 0
         then
          htp.tabledata( nvl(c3rec.movement_no,'&nbsp;'));
          htp.tabledata( sl_rec.shipname || ' ' || sl_rec.voy);
          htp.tabledata( sl_rec.ship_id);
          htp.tabledata( nvl(c3rec.camov_seal,'&nbsp;'));
          htp.tabledata( nvl(to_char(c3rec.hawb_hawbno),'&nbsp;'));
          htp.tabledata( nvl(to_char(c3rec.local_line_no),'&nbsp;'));
          htp.tabledata( nvl(to_char(sl_rec.estarrive,'DD-MON-YYYY'),'&nbsp;'));
          htp.tabledata( '&nbsp;');
          htp.tabledata( '&nbsp;');
         else
          htp.tabledata( nvl(c3rec.movement_no_2,'&nbsp;'));
          htp.tabledata( sl_rec.shipname || ' ' || sl_rec.voy);
          htp.tabledata( sl_rec.ship_id);
          htp.tabledata( nvl(c3rec.camov_seal_2,'&nbsp;'));
          htp.tabledata( nvl(to_char(c3rec.hawb_hawbno_2),'&nbsp;'));
          htp.tabledata( nvl(to_char(c3rec.local_line_no),'&nbsp;'));
          htp.tabledata( nvl(to_char(sl_rec.estarrive,'DD-MON-YYYY'),'&nbsp;'));
          htp.tabledata( '&nbsp;');
          htp.tabledata( '&nbsp;');
        end if;
       htp.tablerowclose;
       htp.tablerowopen;
        htp.tableheader( 'Convoy');
        htp.tabledata( nvl(c3rec.movement_no_2,'&nbsp;'));
        htp.tabledata( sc_rec.shipname || ' ' || sc_rec.voy);
        htp.tabledata( sc_rec.ship_id);
        htp.tabledata( '&nbsp;');
        htp.tabledata( '&nbsp;');
        htp.tabledata( '&nbsp;');
        htp.tabledata( nvl(to_char(sc_rec.estarrive,'DD-MON-YYYY'),'&nbsp;'));
        htp.tabledata( '&nbsp;');
        htp.tabledata( '&nbsp;');
       htp.tablerowclose;
      htp.tableclose;

     htp.p( '</td>' );

     htp.tablerowclose;

     htp.tablerowopen;
     htp.tabledata( 'Weight (Kg)',cattributes=>'class="str1_hd_left"');
     if vaccess = 'EDIT'
      then
      if seclevel in ( 'LEVEL 8' )
       then
        htp.tabledata( htf.formhidden( 'P5', c3rec.partweight ) || c3rec.partweight, cattributes=>'class="str1_bg_left"' );
       else
        htp.tabledata( htf.formtext( 'P5', 10, 20, c3rec.partweight), cattributes=>'class="str1_bg_left"' );
      end if;
      else
       htp.tabledata( c3rec.partweight, cattributes=>'class="str1_cell_right"' );
     end if;
     htp.tabledata( 'Volume (m3)',cattributes=>'class="str1_hd_left"');
     htp.p( '<td class="str1_bg_left">' );
     if vaccess = 'EDIT'
      then
       if seclevel in ( 'LEVEL 8' )
        then
         htp.p( htf.formhidden( 'P4', ltrim(to_char(c3rec.partvolume,G_STR_FRMT_07)) ) );
         htp.p( htf.formhidden( 'N8', ltrim(to_char(c3rec.lngth,G_STR_FRMT_07)) ) );
         htp.p( htf.formhidden( 'N9', ltrim(to_char(c3rec.width,G_STR_FRMT_07)) ) );
         htp.p( htf.formhidden( 'N10', ltrim(to_char(c3rec.height,G_STR_FRMT_07)) ) );
         htp.p( ltrim(to_char(c3rec.partvolume,G_STR_FRMT_07)) );
        else
         htp.p( htf.formtext( 'P4', 5, 20, ltrim(to_char(c3rec.partvolume,G_STR_FRMT_07))) );
         htp.p( ' L' );
         htp.p( htf.formtext( 'N8', 3, 20, ltrim(to_char(c3rec.lngth,G_STR_FRMT_07))) );
         htp.p( ' W' );
         htp.p( htf.formtext( 'N9', 3, 20, ltrim(to_char(c3rec.width,G_STR_FRMT_07))) );
         htp.p( ' H' );
         htp.p( htf.formtext( 'N10', 3, 20, ltrim(to_char(c3rec.height,G_STR_FRMT_07))) );
       end if;
      else
       htp.p( ltrim(to_char(c3rec.partvolume,G_STR_FRMT_07)) );
     end if;
     htp.p( '</td>' );
  htp.tablerowclose;

  htp.tablerowopen;
   htp.tabledata( 'Handling',cattributes=>'class="str1_hd_left"');
     if vaccess = 'EDIT'
      then
      if seclevel in ( 'LEVEL 8' )
       then
        htp.tabledata( htf.formhidden( 'P6i', c3rec.handling_unit ) || c3rec.handling_unit, cattributes=>'class="str1_bg_left"' );
       else
        htp.tabledata( htf.formtext( 'P6i', 12, 15, c3rec.handling_unit), cattributes=>'class="str1_bg_left"' );
       end if;
      else
       htp.tabledata( c3rec.handling_unit, cattributes=>'class="str1_bg_left" ' );
     end if;
     htp.tabledata( 'Hazard',cattributes=>'class="str1_hd_left"');
     if vaccess = 'EDIT'
      then
      if seclevel in ( 'LEVEL 8' )
       then
        htp.tabledata( htf.formhidden( 'D5', c3rec.hazard ) || c3rec.hazard, cattributes=>'class="str1_bg_left"' );
       else
        htp.tabledata( htf.formtext( 'D5', 30, 120, c3rec.hazard), cattributes=>'class="str1_bg_left"' );
      end if;
      else
       htp.tabledata( c3rec.hazard, cattributes=>'class="str1_bg_left"' );
     end if;
    htp.tablerowclose;

     htp.tablerowopen;
   htp.tabledata( 'Warehouse',cattributes=>'class="str1_hd_left"');
   if vaccess = 'EDIT'
    then
     htp.p( '<TD ' || 'class="str1_bg_left">' );
     htp.formselectopen( 'P9' );
     for c9rec in c9 loop
      if c9rec.code = c3rec.warehouse
       then
        htp.formselectoption( c9rec.code, 'SELECTED' );
       else
        htp.formselectoption( c9rec.code );
      end if;
     end loop;
     htp.formselectclose;
     htp.p( '</TD>' );
    else
     htp.tabledata( c3rec.warehouse,cattributes=>'class="str1_bg_left"');
   end if;
     htp.tabledata( 'ECN',cattributes=>'class="str1_hd_left"');
     if vaccess = 'EDIT'
      then
      if seclevel in ( 'LEVEL 8' )
       then
        htp.tabledata( htf.formhidden( 'D6', c3rec.ecn ) || c3rec.ecn, cattributes=>'class="str1_bg_left"' );
       else
        htp.tabledata( htf.formtext( 'D6', 20, 15, c3rec.ecn), cattributes=>'class="str1_bg_left"' );
      end if;
      else
       htp.tabledata( c3rec.ecn, cattributes=>'class="str1_bg_left"' );
     end if;
   /*
     htp.tabledata( htf.bold( 'Movement No' ),cattributes=>'class="str1_bg_left"');
     htp.tabledata( nvl(c3rec.movement_no,'&nbsp;'), cattributes=>'class="str1_bg_left"' );
     htp.tabledata( htf.bold( 'Seal' ),cattributes=>'class="str1_bg_left"');
     htp.tabledata( nvl(c3rec.camov_seal,'&nbsp;'), cattributes=>'class="str1_bg_left"' );
--     htp.tabledata( htf.bold( '' ),cattributes=>'class="str1_bg_left"');
--     htp.p( '<TD ' || 'class="str1_bg_left" COLSPAN=1>' );
--     htp.p( '</TD>' );
     if vaccess = 'EDIT'
      then
       htp.p( '<TD ' || 'class="str1_bg_left" COLSPAN=9>' );
       if c3rec.logno is not null and seclevel not in ( 'LEVEL 8' ) then htp.anchor2( 'strangp.edit_ecn_log?surl=' || surl || '&lg=' || c3rec.logno || '&rid=' || replace( rid, '+', '~' ) || '&scid=' || replace(scid,' ','+') || '&call_name=' || replace(call_name,' ','+') || '&parm=' || replace(parm,' ','+') || '&access_id=' || replace(access_id,' ','+') || '&recctr=' || to_char(vrecctr), 'ECN Assign', ctarget=>'ASSIGN_BY_LOG' ); end if;
       if seclevel in ( 'LEVEL 5','LEVEL 7','LEVEL 8' )
       then
        htp.anchor2( 'strangp.entry_maintain?surl=' || surl || '&strt=' || c3rec.entry_no || '&rid=' || replace(c3rec.rowid,'+','~') || '&vrecctr=' || vrecctr, 'Entry Maintain', ctarget=>'_top' );
        htp.anchor2( 'strangp.container_maintain?surl=' || surl || '&strt=' || c3rec.movement_no || '&strt2=' || c3rec.camov_seal || '&rid=' || replace(c3rec.rowid,'+','~') || '&vrecctr=' || vrecctr, 'Container Maintain', ctarget=>'_top' );
        htp.anchor2( 'strangp.log_maintain?surl=' || surl || '&strt=' || c3rec.logno || '&rid=' || replace(c3rec.rowid,'+','~') || '&vrecctr=' || vrecctr, 'Log Maintain', ctarget=>'_top' );
 --       htp.anchor2( 'strangp.delivery_maintain?surl=' || surl || '&strt=' || c3rec.deliveryno || '&rid=' || replace(c3rec.rowid,'+','~') || '&vrecctr=' || vrecctr, 'Delivery Maintain', ctarget=>'_top' );
        end if;
       htp.p( '</TD>' );
     end if;
--     htp.tabledata( htf.bold( '' ),cattributes=>'class="str1_bg_left"');
--     htp.p( '<TD ' || 'class="str1_bg_left" COLSPAN=1>' );
--     htp.p( '</TD>' );
     */
  htp.tablerowclose;

  htp.tablerowopen;
     htp.tabledata( 'Description',cattributes=>'class="str1_hd_left"');
     if vaccess = 'EDIT'
      then
       htp.p( '<TD ' || 'class="str1_bg_left" COLSPAN="3">' );
        htp.formtext( 'D8', 70, 90, html_format(c3rec.detaildesc));
       htp.p( '</TD>' );
      else
       htp.p( '<TD ' || 'class="str1_bg_left" COLSPAN="3">' );
        htp.p( c3rec.detaildesc );
       htp.p( '</TD>' );
     end if;
  /*
     htp.tabledata( htf.bold( 'Entry No' ),cattributes=>'class="str1_bg_left"');
     if c3rec.entry_no is not null
      then
       htp.p( '<TD ' || 'class="str1_bg_left">' );
       htp.tableopen;
       htp.tablerowopen;
        htp.p( '<td class="str1_bg_left">' );
         open c10(c3rec.entry_no);
         fetch c10 into c10rec;
         if c10%FOUND
          then
           htp.anchor2( 'strangp.duty_edit?surl=' || surl || '&entry=' || strang.ent.get_entry_no(c3rec.entry_no), strang.ent.get_entry_no(c3rec.entry_no), ctarget=>'_top');
         else
           htp.p( strang.ent.get_entry_no(c3rec.entry_no));
         end if;
         close c10;
        htp.p( '</TD>' );
       htp.tabledata( '&nbsp;&nbsp;&nbsp;&nbsp;' );
        search( surl, 'ENTRY_NO', c3rec.rowid, samerow=>TRUE, buttons_only=>TRUE, override_top=>'_top' );
       htp.tablerowclose;
       htp.tableclose;
       htp.p( '</TD>' );
      else
       htp.tabledata( '&nbsp;', cattributes=>'class="str1_bg_left"' );
     end if;
     open c5(c3rec.hawb_hawbno);
     htp.tabledata( htf.bold( 'Line No' ),cattributes=>'class="str1_bg_left"');
     htp.tabledata( htf.bold(c3rec.line_no), cattributes=>'class="str1_bg_left"' );
     htp.tabledata( htf.bold( 'HAWB' ),cattributes=>'class="str1_bg_left"');
     fetch c5 into c5rec;
     close c5;
     if c5rec.mawb is not null
      then
       htp.tabledata( htf.bold( c3rec.hawb_hawbno), cattributes=>'class="str1_bg_left"' ); -- || '(' || c5rec.mawb || ')'
      else
       htp.tabledata( htf.bold( c3rec.hawb_hawbno), cattributes=>'class="str1_bg_left"' );
     end if;
--
--     htp.tabledata( htf.bold( '' ),cattributes=>'class="str1_bg_left"');
     if vaccess = 'EDIT'
      then
       htp.p( '<TD ' || 'class="str1_bg_left" COLSPAN=1>' );
       htp.anchor2( 'strangp.po_item_no_maintain?surl=' || surl || '&strt=' || c3rec.deliveryno || '&rid=' || replace(c3rec.rowid,'+','~') || '&vrecctr=' || vrecctr, 'PO Maintain', ctarget=>'_top' );
       htp.p( '</TD>' );
       htp.p( '<TD ' || 'class="str1_bg_left" COLSPAN=1>' );
       htp.anchor2( 'strangp.po_inventory_maintain?surl=' || surl || '&strt=' || c3rec.deliveryno || '&rid=' || replace(c3rec.rowid,'+','~') || '&vrecctr=' || vrecctr, 'PO2 Maintain', ctarget=>'_top' );
       htp.p( '</TD>' );
       htp.p( '<TD ' || 'class="str1_bg_left" COLSPAN=1>' );
       htp.anchor2( 'strangp.po_inventdate_maintain?surl=' || surl || '&strt=' || c3rec.deliveryno || '&rid=' || replace(c3rec.rowid,'+','~') || '&vrecctr=' || vrecctr, 'PO3 Maintain', ctarget=>'_top' );
       htp.p( '</TD>' );
       htp.tabledata( '&nbsp;' ,cattributes=>'class="str1_bg_left" COLSPAN=1');
     else
       htp.tabledata( '&nbsp;' ,cattributes=>'class="str1_bg_left" COLSPAN=4');
     end if;
 */
     htp.p( '<TD ' || 'class="str1_bg_left" colspan="4">' );

     htp.tableopen( cattributes=>'class="str1_table4"' );
     htp.tablerowopen;
     if vaccess = 'EDIT'
      then
       if seclevel in ( 'LEVEL 5','LEVEL 7','LEVEL 8' )
       then
          url := 'strangp.container_maintain?surl=' || surl || '&strt=' || c3rec.movement_no || '&strt2=' || c3rec.camov_seal || '&rid=' || replace(c3rec.rowid,'+','~') || '&vrecctr=' || vrecctr || '&force_single_disp=' || force_single_disp || '&popup=' || 'T';
          url := htf.anchor( 'javascript: window.open(''' || url || ''',''' || 'ASSIGN_BY_CONT' || ''',''height=' || '600' || ',width=' || '1200' || ',scrollbars=yes,resizable=yes'');void('''');', 'Container Maintain' );
        htp.tabledata(url, cattributes=>'class="str1_bg_left"' );

          url := 'strangp.entry_maintain?surl=' || surl || '&strt=' || c3rec.entry_no || '&rid=' || replace(c3rec.rowid,'+','~') || '&vrecctr=' || vrecctr || '&force_single_disp=' || force_single_disp || '&popup=' || 'T';
          url := htf.anchor( 'javascript: window.open(''' || url || ''',''' || 'ASSIGN_BY_CONT' || ''',''height=' || '600' || ',width=' || '1200' || ',scrollbars=yes,resizable=yes'');void('''');', 'Entry Maintain' );
        htp.tabledata(url, cattributes=>'class="str1_bg_left"' );

          url := 'strangp.log_maintain?surl=' || surl || '&strt=' || c3rec.logno || '&rid=' || replace(c3rec.rowid,'+','~') || '&vrecctr=' || vrecctr || '&force_single_disp=' || force_single_disp || '&popup=' || 'T';
          url := htf.anchor( 'javascript: window.open(''' || url || ''',''' || 'LOG_MAINT' || ''',''height=' || '600' || ',width=' || '1200' || ',scrollbars=yes,resizable=yes'');void('''');', 'Log Maintain' );
        htp.tabledata(url, cattributes=>'class="str1_bg_left"' );
       end if;
     end if;
     if vaccess = 'EDIT'
      then
       htp.p( '<TD ' || 'class="str1_bg_left">' );
        if c3rec.logno is not null and seclevel not in ( 'LEVEL 8' )
         then
          url := 'strangp.edit_ecn_log?surl=' || surl || '&lg=' || c3rec.logno || '&rid=' || replace( rid, '+', '~' ) || '&scid=' || replace(scid,' ','+') || '&call_name=' || replace(call_name,' ','+') || '&parm=' || replace(parm,' ','+') || '&access_id=' || replace(access_id,' ','+') || '&recctr=' || to_char(vrecctr) || '&force_single_disp=' || force_single_disp || '&popup=' || 'T';
          url := htf.anchor( 'javascript: window.open(''' || url || ''',''' || 'ASSIGN_BY_LOG' || ''',''height=' || '600' || ',width=' || '1200' || ',scrollbars=yes,resizable=yes'');void('''');', 'ECN Assign' );
          htp.p(url);
         end if;
       htp.p( '</TD>' );
     end if;
          url := 'strangp.po_item_no_maintain?surl=' || surl || '&strt=' || c3rec.deliveryno || '&rid=' || replace(c3rec.rowid,'+','~') || '&vrecctr=' || vrecctr || '&force_single_disp=' || force_single_disp || '&popup=' || 'T';
          url := htf.anchor( 'javascript: window.open(''' || url || ''',''' || 'PO_MAINT_1' || ''',''height=' || '600' || ',width=' || '1200' || ',scrollbars=yes,resizable=yes'');void('''');', 'PO Maintain' );
        htp.tabledata(url, cattributes=>'class="str1_bg_left"' );

          url := 'strangp.po_inventory_maintain?surl=' || surl || '&strt=' || c3rec.deliveryno || '&rid=' || replace(c3rec.rowid,'+','~') || '&vrecctr=' || vrecctr || '&force_single_disp=' || force_single_disp || '&popup=' || 'T';
          url := htf.anchor( 'javascript: window.open(''' || url || ''',''' || 'PO_MAINT_2' || ''',''height=' || '600' || ',width=' || '1200' || ',scrollbars=yes,resizable=yes'');void('''');', 'PO2 Maintain' );
        htp.tabledata(url, cattributes=>'class="str1_bg_left"' );

          url := 'strangp.po_inventdate_maintain?surl=' || surl || '&strt=' || c3rec.deliveryno || '&rid=' || replace(c3rec.rowid,'+','~') || '&vrecctr=' || vrecctr || '&force_single_disp=' || force_single_disp || '&popup=' || 'T';
          url := htf.anchor( 'javascript: window.open(''' || url || ''',''' || 'PO_MAINT_3' || ''',''height=' || '600' || ',width=' || '1200' || ',scrollbars=yes,resizable=yes'');void('''');', 'PO3 Maintain' );
        htp.tabledata(url, cattributes=>'class="str1_bg_left"' );

     if vaccess = 'EDIT'
      then
       if c3rec.rowid is not null
        then
         htp.tabledata( htf.formimage( 'Save_Record',INSTALL_PARAMETERS.IMAGE_LOCATION || 'str/' || 'adminc_save.gif' ));
         if seclevel in ( 'LEVEL 8' )
          then
            null;
          else
           htp.tabledata( htf.formimage( 'Insert_Record',INSTALL_PARAMETERS.IMAGE_LOCATION || 'str/' || 'adminc_insert.gif' ));
           htp.tabledata( htf.formimage( 'Split_Record',INSTALL_PARAMETERS.IMAGE_LOCATION || 'str/' || 'adminc_split.gif' ));
           if c3rec.movement_no is null
            then
             htp.tabledata( htf.formimage( 'Delete_Record',INSTALL_PARAMETERS.IMAGE_LOCATION || 'str/' || 'adminc_delete.gif' ));
           end if;
         end if;
        else
         htp.tabledata( htf.formimage( 'Save_Record',INSTALL_PARAMETERS.IMAGE_LOCATION || 'str/' || 'adminc_save.gif' ));
       end if;
     end if;

-- gl.dbg('T[' || c4rec.tot || '][' || c4rec.vmn || '][' || c4rec.vmx || '][' || vrecctr || ']');
     if recctr = 0
      then
       htp.tabledata( htf.formimage( 'Cancel',INSTALL_PARAMETERS.IMAGE_LOCATION || 'str/' || 'adminc_cancel.gif' ) || htf.formclose);

     elsif vrecctr = 1 and vrecctr < c4rec.tot
     then
      if vaccess = 'EDIT'
       then
        htp.tabledata( htf.formimage( 'Next_Record',INSTALL_PARAMETERS.IMAGE_LOCATION || 'str/' || 'adminc_next.gif' ));
        htp.tabledata( htf.formimage( 'Last_Record',INSTALL_PARAMETERS.IMAGE_LOCATION || 'str/' || 'adminc_last.gif' ) || htf.formclose);
       else
        htp.tabledata( htf.anchor( 'strangp.receive_bottom?surl=' || surl || '&rid=' || replace( rid, '+', '~' ) || '&scid=' || replace(scid,' ','+') || '&call_name=' || replace(call_name,' ','+') || '&parm=' || replace(parm,' ','+') || '&access_id=' || replace(access_id,' ','+') || '&recctr=' || to_char(vrecctr+1) || '&force_single_disp=' || force_single_disp || '&popup=' || popup, htf.img( INSTALL_PARAMETERS.IMAGE_LOCATION || 'str/' || 'adminc_next.gif',calt=>'Next Record' ) ));
        htp.tabledata( htf.anchor( 'strangp.receive_bottom?surl=' || surl || '&rid=' || replace( rid, '+', '~' ) || '&scid=' || replace(scid,' ','+') || '&call_name=' || replace(call_name,' ','+') || '&parm=' || replace(parm,' ','+') || '&access_id=' || replace(access_id,' ','+') || '&recctr=' || to_char(c4rec.tot) || '&force_single_disp=' || force_single_disp || '&popup=' || popup, htf.img( INSTALL_PARAMETERS.IMAGE_LOCATION || 'str/' || 'adminc_last.gif',calt=>'Last Record' ) ));
      end if;

     elsif vrecctr > 1 and vrecctr < c4rec.tot
       then
        if vaccess = 'EDIT'
         then
          htp.tabledata( htf.formimage( 'First_Record',INSTALL_PARAMETERS.IMAGE_LOCATION || 'str/' || 'adminc_first.gif' ));
          htp.tabledata( htf.formimage( 'Previous_Record',INSTALL_PARAMETERS.IMAGE_LOCATION || 'str/' || 'adminc_previous.gif'));
          htp.tabledata( htf.formimage( 'Next_Record',INSTALL_PARAMETERS.IMAGE_LOCATION || 'str/' || 'adminc_next.gif' ));
          htp.tabledata( htf.formimage( 'Last_Record',INSTALL_PARAMETERS.IMAGE_LOCATION || 'str/' || 'adminc_last.gif' ) || htf.formclose);
        else
          htp.tabledata( htf.anchor( 'strangp.receive_bottom?surl=' || surl || '&rid=' || replace( rid, '+', '~' ) || '&scid=' || replace(scid,' ','+') || '&call_name=' || replace(call_name,' ','+') || '&parm=' || replace(parm,' ','+') || '&access_id=' || replace(access_id,' ','+') || '&recctr=' || to_char(1) || '&force_single_disp=' || force_single_disp || '&popup=' || popup, htf.img( INSTALL_PARAMETERS.IMAGE_LOCATION || 'str/' || 'adminc_first.gif',calt=>'First Record' ) ));
          htp.tabledata( htf.anchor( 'strangp.receive_bottom?surl=' || surl || '&rid=' || replace( rid, '+', '~' ) || '&scid=' || replace(scid,' ','+') || '&call_name=' || replace(call_name,' ','+') || '&parm=' || replace(parm,' ','+') || '&access_id=' || replace(access_id,' ','+') || '&recctr=' || to_char(vrecctr-1) || '&force_single_disp=' || force_single_disp || '&popup=' || popup, htf.img( INSTALL_PARAMETERS.IMAGE_LOCATION || 'str/' || 'adminc_previous.gif',calt=>'Previous Record' ) ));
          htp.tabledata( htf.anchor( 'strangp.receive_bottom?surl=' || surl || '&rid=' || replace( rid, '+', '~' ) || '&scid=' || replace(scid,' ','+') || '&call_name=' || replace(call_name,' ','+') || '&parm=' || replace(parm,' ','+') || '&access_id=' || replace(access_id,' ','+') || '&recctr=' || to_char(vrecctr+1) || '&force_single_disp=' || force_single_disp || '&popup=' || popup, htf.img( INSTALL_PARAMETERS.IMAGE_LOCATION || 'str/' || 'adminc_next.gif',calt=>'Next Record' ) ));
          htp.tabledata( htf.anchor( 'strangp.receive_bottom?surl=' || surl || '&rid=' || replace( rid, '+', '~' ) || '&scid=' || replace(scid,' ','+') || '&call_name=' || replace(call_name,' ','+') || '&parm=' || replace(parm,' ','+') || '&access_id=' || replace(access_id,' ','+') || '&recctr=' || to_char(c4rec.tot) || '&force_single_disp=' || force_single_disp || '&popup=' || popup, htf.img( INSTALL_PARAMETERS.IMAGE_LOCATION || 'str/' || 'adminc_last.gif',calt=>'Last Record' ) ));
        end if;

      elsif vrecctr = c4rec.tot and vrecctr > 1
       then
        if vrecctr > 1
         then
          if vaccess = 'EDIT'
           then
            htp.tabledata( htf.formimage( 'First_Record',INSTALL_PARAMETERS.IMAGE_LOCATION || 'str/' || 'adminc_first.gif' ));
            htp.tabledata( htf.formimage( 'Previous_Record',INSTALL_PARAMETERS.IMAGE_LOCATION || 'str/' || 'adminc_previous.gif' ) || htf.formclose);
          else
            htp.tabledata( htf.anchor( 'strangp.receive_bottom?surl=' || surl || '&rid=' || replace( rid, '+', '~' ) || '&scid=' || replace(scid,' ','+') || '&call_name=' || replace(call_name,' ','+') || '&parm=' || replace(parm,' ','+') || '&access_id=' || replace(access_id,' ','+') || '&recctr=' || to_char(1) || '&force_single_disp=' || force_single_disp || '&popup=' || popup, htf.img( INSTALL_PARAMETERS.IMAGE_LOCATION || 'str/' || 'adminc_first.gif',calt=>'First Record' ) ));
            htp.tabledata( htf.anchor( 'strangp.receive_bottom?surl=' || surl || '&rid=' || replace( rid, '+', '~' ) || '&scid=' || replace(scid,' ','+') || '&call_name=' || replace(call_name,' ','+') || '&parm=' || replace(parm,' ','+') || '&access_id=' || replace(access_id,' ','+') || '&recctr=' || to_char(vrecctr-1) || '&force_single_disp=' || force_single_disp || '&popup=' || popup, htf.img( INSTALL_PARAMETERS.IMAGE_LOCATION || 'str/' || 'adminc_previous.gif',calt=>'Previous Record' ) ));
          end if;
        end if;

      else
       if vrecctr > 1 then
        if vaccess = 'EDIT'
         then
          htp.tabledata( htf.formimage( 'First_Record',INSTALL_PARAMETERS.IMAGE_LOCATION || 'str/' || 'adminc_first.gif' ));
          htp.tabledata( htf.formimage( 'Previous_Record',INSTALL_PARAMETERS.IMAGE_LOCATION || 'str/' || 'adminc_previous.gif') || htf.formclose);
        else
          htp.tabledata( htf.anchor( 'strangp.receive_bottom?surl=' || surl || '&rid=' || replace( rid, '+', '~' ) || '&scid=' || replace(scid,' ','+') || '&call_name=' || replace(call_name,' ','+') || '&parm=' || replace(parm,' ','+') || '&access_id=' || replace(access_id,' ','+') || '&recctr=' || to_char(1) || '&force_single_disp=' || force_single_disp || '&popup=' || popup, htf.img( INSTALL_PARAMETERS.IMAGE_LOCATION || 'str/' || 'adminc_first.gif',calt=>'First Record' ) ));
          htp.tabledata( htf.anchor( 'strangp.receive_bottom?surl=' || surl || '&rid=' || replace( rid, '+', '~' ) || '&scid=' || replace(scid,' ','+') || '&call_name=' || replace(call_name,' ','+') || '&parm=' || replace(parm,' ','+') || '&access_id=' || replace(access_id,' ','+') || '&recctr=' || to_char(vrecctr-1) || '&force_single_disp=' || force_single_disp || '&popup=' || popup, htf.img( INSTALL_PARAMETERS.IMAGE_LOCATION || 'str/' || 'adminc_previous.gif',calt=>'Previous Record' ) ));
        end if;
       else if vaccess = 'EDIT' then htp.tabledata( '&nbsp;' || htf.formclose ); else htp.tabledata( '&nbsp;' || htf.formclose ); end if;
       end if;
     end if;

     if c4rec.tot > 1 then
     htp.tabledata( htf.formopen( 'strangp.receive_bottom' ) || htf.formhidden( 'SURL', surl ) || htf.formhidden( 'RID', replace(rid,'~','+') ) ||
            htf.formhidden( 'SCID', scid ) || htf.formtext( 'RECCTR', 2, 5, vrecctr ) || htf.formhidden( 'CALL_NAME', call_name ) ||
            htf.formhidden( 'PARM', parm ) || htf.formhidden( 'ACCESS_ID', access_id ) || htf.formhidden( 'FORCE_SINGLE_DISP', force_single_disp ) || htf.formhidden( 'POPUP', popup ) || htf.formsubmit( null, 'GoTo' ) || htf.formclose );
     else
      htp.tabledata('&nbsp;');
     end if;

    if seclevel in ( 'LEVEL 5','LEVEL 7','LEVEL 8' )
     then
      htp.tabledata( htf.formopen( 'strangp.menu', ctarget=>'_top' ) || htf.formhidden( 'SURL', surl ) || htf.formhidden( 'RID', NULL ) ||
            htf.formhidden( 'RND', to_char(sysdate, 'SSSSS' )) || htf.formhidden( 'ACTION', 'SEARCH' ) || htf.formhidden( 'MTYPE', 'ENTRY_NO' ) ||
            htf.formtext( 'MSEARCH', 20, 100 ) || htf.formsubmit( null, 'Entry' ) || htf.formclose );
    end if;
    htp.tablerowclose;
    htp.tableclose;

    htp.p( '</TD>' );

  htp.tablerowclose;
 htp.tableclose;
 htp.bold( ttl );
 htp.nl;
 if popup = 'T' then htp.bold( '<a href="" onClick="self.close()">' || LNG.GLB_TXT_033 || '</a>'); end if;
 htp.p( '</CENTER>' );
 --htp.header(3,'trace detailrs- total = ' || vtot || '[' || vrecctr || '][' || recctr || '][' || c4rec.tot || ']' );
 htp.htmlclose;

exception when others then
 error_details( 'STRANGP', 'RECEIVE_BOTTOM',null,null,errmsg=>sqlerrm,extdet=>'PARM:' || parm);
end receive_bottom;

procedure accept_receive_detailr( num_entries in number, name_array in owa.vc_arr, value_array in owa.vc_arr, reserved in owa.vc_arr )
as

 cursor c2( rid rowid ) is select deliveryno from strang.receivals where rowid = rid;
 cursor c3( dlryno number, itn integer, lgn varchar2, rid rowid ) is
  select 'x' tot
  from strang.detailrs
  where itemno = itn and
        deliveryno = dlryno and
        logno = lgn and
        rowid <> rid;
 --cursor c4( dlryno number, sto varchar2 ) is select max(recno) tot from strang.pos where deliveryno = dlryno and site_owner = sto;
 cursor c5( str varchar2, vste varchar2 ) is select description from strang.lov where lov_name = 'CONTROLS' and cola = vste and code = str and exists
                               (select 'x' from strang.lov where lov_name = 'CONTROLS' and cola = vste and code = str || '_DATE' and description = to_char(sysdate,'DD-MON-YYYY'));
 cursor c6( rid rowid ) is select movement_no, camov_seal from strang.detailrs where rowid = rid;
 cursor c7( pk varchar2 ) is select 'x' from strang.lov where lov_name = 'PACKTYPES' and code = pk;
 cursor c8( rid rowid ) is select count('x') ctr from strang.detailrs where deliveryno = (select deliveryno from strang.detailrs where rowid = rid );
 cursor c9( whse varchar2 ) is select 'x' from strang.lov where lov_name = 'WAREHOUSES' and code = whse;


 c2rec		c2%ROWTYPE;
 c3rec		c3%ROWTYPE;
 --c4rec		c4%ROWTYPE;
 c6rec		c6%ROWTYPE;
 c7rec		c7%ROWTYPE;
 c8rec		c8%ROWTYPE;
 c9rec		c9%ROWTYPE;

 np3		varchar2(9);
 vlogno		varchar2(9);
 pv		number(8,3);
 pw		number(9,1);
 qt		integer;
 nmb1		number;
 nrowid		rowid;
 itn		number(5,2);
 am		number(9,2);
 tam		number(9,2);
 gs		number(9,2);
 sts		varchar2(100);
 vste		varchar2(10);

surl 		varchar2(4000);
rid 		varchar2(100);
scid 		varchar2(100);
parm 		varchar2(100);
access_id 	varchar2(100);
recctr 		integer;
detrid 		varchar2(100);
p1 		varchar2(4000);
p2 		varchar2(4000);
p3 		varchar2(4000);
p4 		number;
p5 		varchar2(4000);
p6 		varchar2(4000);
p6i 		varchar2(4000);
p7 		varchar2(4000);
p8 		varchar2(4000);
p9 		varchar2(4000);
a1 		varchar2(4000);
d5 		varchar2(4000);
d6 		varchar2(4000);
d8 		varchar2(4000);
n1 		varchar2(4000);
n2 		varchar2(4000);
n3 		varchar2(4000);
n4 		varchar2(4000);
n5 		varchar2(4000);
n6 		varchar2(4000);
n7 		number;
n8 		number;
n9 		number;
n10 		number;
cancel 		varchar2(4000);
save_record 	varchar2(4000);
previous_record varchar2(4000);
next_record 	varchar2(4000);
first_record 	varchar2(4000);
last_record 	varchar2(4000);
insert_record 	varchar2(4000);
delete_record 	varchar2(4000);
split_record 	varchar2(4000);
force_single_disp char(1);
popup		char(1);

begin

for j in name_array.first..name_array.last loop
 case upper(name_array(j))
  when 'SURL'			then surl 		:= value_array(j);
  when 'RID'			then rid 		:= value_array(j);
  when 'SCID'			then scid 		:= value_array(j);
  when 'PARM'			then parm 		:= value_array(j);
  when 'ACCESS_ID'		then access_id 		:= value_array(j);
  when 'RECCTR'			then recctr 		:= value_array(j);
  when 'DETRID'			then detrid 		:= value_array(j);
  when 'P1'			then p1 		:= value_array(j);
  when 'P2'			then p2 		:= value_array(j);
  when 'P3'			then p3 		:= value_array(j);
  when 'P4'			then p4 		:= gl.guess_number(value_array(j));
  when 'P5'			then p5 		:= value_array(j);
  when 'P6'			then p6 		:= value_array(j);
  when 'P6I'			then p6i 		:= value_array(j);
  when 'P7'			then p7 		:= value_array(j);
  when 'P8'			then p8 		:= value_array(j);
  when 'P9'			then p9 		:= value_array(j);
  when 'A1'			then a1 		:= value_array(j);
  when 'D5'			then d5 		:= value_array(j);
  when 'D6'			then d6 		:= value_array(j);
  when 'D8'			then d8 		:= value_array(j);
  when 'N1'			then n1 		:= value_array(j);
  when 'N2'			then n2 		:= value_array(j);
  when 'N3'			then n3 		:= value_array(j);
  when 'N4'			then n4 		:= value_array(j);
  when 'N5'			then n5 		:= value_array(j);
  when 'N6'			then n6 		:= value_array(j);
  when 'N7'			then n7 		:= gl.guess_number(value_array(j));
  when 'N8'			then n8 		:= gl.guess_number(value_array(j));
  when 'N9'			then n9 		:= gl.guess_number(value_array(j));
  when 'N10'			then n10 		:= gl.guess_number(value_array(j));
  when 'CANCEL'			then cancel 		:= value_array(j);
  when 'CANCEL.X'		then cancel 		:= value_array(j);
  when 'SAVE_RECORD'		then save_record 	:= value_array(j);
  when 'SAVE_RECORD.X'		then save_record 	:= value_array(j);
  when 'FIRST_RECORD'		then first_record 	:= value_array(j);
  when 'FIRST_RECORD.X'		then first_record 	:= value_array(j);
  when 'PREVIOUS_RECORD'	then previous_record 	:= value_array(j);
  when 'PREVIOUS_RECORD.X'	then previous_record 	:= value_array(j);
  when 'NEXT_RECORD'		then next_record 	:= value_array(j);
  when 'NEXT_RECORD.X'		then next_record 	:= value_array(j);
  when 'LAST_RECORD'		then last_record 	:= value_array(j);
  when 'LAST_RECORD.X'		then last_record 	:= value_array(j);
  when 'INSERT_RECORD'		then insert_record 	:= value_array(j);
  when 'INSERT_RECORD.X'	then insert_record 	:= value_array(j);
  when 'DELETE_RECORD'		then delete_record 	:= value_array(j);
  when 'DELETE_RECORD.X'	then delete_record 	:= value_array(j);
  when 'SPLIT_RECORD'		then split_record 	:= value_array(j);
  when 'SPLIT_RECORD.X'		then split_record 	:= value_array(j);
  when 'FORCE_SINGLE_DISP'	then force_single_disp:= value_array(j);
  when 'POPUP'			then popup		:= value_array(j);
  else null;
end case;
end loop;

 if n8 is not null and n9 is not null and n10 is not null
  then
   p4 := (n8*n9*n10);
 end if;
 if cancel is not null
  then
   receive_bottom(surl,rid,scid,null,parm,'x',1,Cancel,force_single_disp=>force_single_disp, popup=>popup );
   return;
 end if;

 if delete_record is not null
  then
   confirm_delete_detailrs(surl,rid,scid,detrid,parm,access_id,recctr, 'Confirm Delete of Detail',force_single_disp=>force_single_disp, popup=>popup  );
   return;
 end if;

 if not dapi.init( surl, 'STRANGP.ACCEPT_RECEIVE_DETAILR', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'ACCEPT_RECEIVE_DETAILR' );
    return;
 end if;

 vste := customer_state(dapi.GLOBAL_ACCOUNT.acctid);

 open c2( chartorowid( replace(rid,'~','+') ) );
 fetch c2 into c2rec;
 close c2;

 begin itn := to_number( p1 ); exception when others then receive_bottom(surl,rid,scid,null,parm,access_id,recctr,'Invalid Item No' || ': ' || p1,force_single_disp=>force_single_disp, popup=>popup ); return; end;

 open c3( c2rec.deliveryno, itn, p2, detrid );
 fetch c3 into c3rec;
 if c3%FOUND
  then
    close c3;
    receive_bottom(surl,rid,scid,null,parm,access_id,recctr,'Item No and Log No already exists' || ': ' || p1 || '-' || p2,force_single_disp=>force_single_disp, popup=>popup );
    return;
  end if;
  close c3;

  begin pv := to_number( replace(p4,',','') ); exception when others then receive_bottom(surl,rid,scid,null,parm,access_id,recctr,'Invalid Number Entered for Part Volume' || ': ' || p4,force_single_disp=>force_single_disp, popup=>popup ); return; end;
  begin pw := to_number( replace(p5,',','') ); exception when others then receive_bottom(surl,rid,scid,null,parm,access_id,recctr,'Invalid Number Entered for Part Weight' || ': ' || p5,force_single_disp=>force_single_disp, popup=>popup ); return; end;
  begin qt := to_number( replace(p6,',','') ); exception when others then receive_bottom(surl,rid,scid,null,parm,access_id,recctr,'Invalid Number Entered for Quantity' || ': ' || p6 ,force_single_disp=>force_single_disp, popup=>popup); return; end;
  open c7(upper(p7));
  fetch c7 into c7rec;
  if c7%NOTFOUND
   then
    close c7;
    receive_bottom(surl,rid,scid,null,parm,access_id,recctr,'Invalid Pack Type Entered' || ': ' || p7,force_single_disp=>force_single_disp, popup=>popup );
    return;
  end if;
  close c7;
  open c9(upper(p9));
  fetch c9 into c9rec;
  if c9%NOTFOUND
   then
    close c9;
    receive_bottom(surl,rid,scid,null,parm,access_id,recctr,'Invalid Pack Type Entered' || ': ' || p9,force_single_disp=>force_single_disp, popup=>popup );
    return;
  end if;
  close c9;
  if detrid is null
   then
    begin
     if a1 = 'T'
      then
       open c5( 'LOGNO' || p3, vste );
       fetch c5 into np3;
       if c5%NOTFOUND
        then
         np3 := nvl(p2,new_log_no( p3, vste ) );
       end if;
       close c5;
      else
       np3 := nvl(p2,new_log_no( p3, vste ) );
     end if;
     --- add detailrs new
     insert into strang.detailrs( deliveryno, itemno, logno, sa, partvolume, partweight, qty, pktpe_packtype, cl, owner, entry_no, hazard, ecn, detaildesc, warehouse, io,sa_2,cl_2,legs_2,dan,rfts,hb,lngth,width,height ) values
      ( c2rec.deliveryno, itn, np3, p3, pv, pw, nvl(qt,1), upper(p7), p8,'1',nmb1, d5, d6, d8, p9, n1,n2,n3,n4,n5,n6,n7,n8,n9,n10 ) returning rowid into nrowid;
    exception
      when others then
            receive_bottom(surl,rid,scid,null,parm,access_id,recctr,'Error on Insert' || ': ' || sqlerrm,force_single_disp=>force_single_disp, popup=>popup );
            return;
    end;
   else
    -- Update The Row
    begin
    if a1 is null
     then
      np3 := p2;
     else
      if a1 = 'T'
       then
        open c5( 'LOGNO' || p3, vste );
        fetch c5 into np3;
        if c5%NOTFOUND
         then
          np3 := nvl(p2,new_log_no( p3, vste ) );
        end if;
        close c5;
       else
        np3 := nvl(p2,new_log_no( p3, vste ) );
      end if;
    end if;
    update strang.detailrs
        set
         logno = np3,
         sa = p3,
         partvolume = pv,
         partweight = pw,
         qty = qt,
         handling_unit = strang.f_sap_format(p6i,'HANDLING_UNIT'),
         pktpe_packtype = upper(p7),
         warehouse = upper(p9),
         cl = p8,
         hazard = d5,
         ecn = d6,
         detaildesc = d8,
         io = n1,
         sa_2 = n2,
         cl_2 = n3,
         legs_2 = n4,
         dan = n5,
         rfts = n6,
         hb = n7,
         lngth = n8,
         width = n9,
         height = n10
       where rowid = chartorowid( detrid );
        exception
             when others then
              receive_bottom(surl,rid,scid,null,parm,access_id,'Details','Error on Update' || ': ' || sqlerrm,force_single_disp=>force_single_disp, popup=>popup );
              return;
       end;
   end if;

 commit;

 if previous_record is not null
  then
   receive_bottom(surl,rid,scid,null,parm,access_id,recctr - 1,null,force_single_disp=>force_single_disp, popup=>popup );
   return;
 elsif next_record is not null
  then
   receive_bottom(surl,rid,scid,null,parm,access_id,recctr + 1,null,force_single_disp=>force_single_disp, popup=>popup );
   return;
 elsif first_record is not null
  then
   receive_bottom(surl,rid,scid,null,parm,access_id,1,null,force_single_disp=>force_single_disp, popup=>popup );
   return;
 elsif last_record is not null
  then
   open c8( chartorowid(detrid) );
   fetch c8 into c8rec;
   close c8;
   receive_bottom(surl,rid,scid,null,parm,access_id,c8rec.ctr,null,force_single_disp=>force_single_disp, popup=>popup );
   return;
 elsif insert_record is not null
  then
   receive_bottom(surl,rid,scid,null,parm,access_id,0,null,force_single_disp=>'T', popup=>'F' );
   return;
 elsif split_record is not null
  then
   split_detailrs(surl,detrid,scid,null,parm,access_id,recctr,null,force_single_disp=>force_single_disp, popup=>popup );
   return;
 elsif save_record is not null
  then
   receive_bottom(surl,rid,scid,null,parm,access_id,recctr,'Record Saved',force_single_disp=>'T', popup=>popup );
 end if;

exception when others then
 error_details( 'STRANGP', 'ACCEPT_RECEIVE_DETAILR',null,null,errmsg=>sqlerrm,extdet=>'PARM:' || parm);
end accept_receive_detailr;

procedure split_detailrs(surl in varchar2, rid in varchar2, scid in varchar2, call_name in varchar2, parm in varchar2, access_id in varchar2 default null, recctr in integer default 1, msg in varchar2 default NULL, force_single_disp in char default 'F', popup in char default 'F' )
as

 cursor c2( rid rowid ) is select * from strang.detailrs where rowid = rid;

 c2rec		c2%ROWTYPE;

 sts		varchar2(100);
 vaccess	varchar2(20);

begin
 if not dapi.init( surl, 'STRANGP.SPLIT_DETAILRS', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'SPLIT_DETAILRS' );
    return;
 end if;

  vaccess := data_access( 'DETAILRS' );

  open c2(chartorowid(replace(rid,'~','+')));
  fetch c2 into c2rec;
  close c2;

  main_title( 'Split Detailr Record',helpid=>'STR03');

  htp.nl;
  htp.p( '<CENTER>' );
  htp.formopen( 'strangp.accept_split_detailrs' );
   htp.formhidden( 'SURL', surl );
   htp.formhidden( 'RID', replace(rid,'~','+') );
   htp.formhidden( 'SCID', scid );
   htp.formhidden( 'PARM', parm );
   htp.formhidden( 'ACCESS_ID', access_id );
   htp.formhidden( 'RECCTR', recctr);
   htp.formhidden( 'FORCE_SINGLE_DISP', force_single_disp);
   htp.formhidden( 'POPUP', popup);
    htp.tabledata( htf.bold( c2rec.qty ),cattributes=>'class="str1_bg_left"');
  htp.tableopen( cattributes=>'class="str1_table"' );
   htp.tablerowopen;
    htp.tabledata( htf.bold( 'Quantity' ),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.bold( 'Number of Splits' ),cattributes=>'class="str1_bg_left"');
   htp.tablerowclose;
   htp.tablerowopen;
    htp.tabledata( htf.formradio( 'P1', 'A', 'CHECKED'),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.bold( 'Automatic' ),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formtext( 'P2', 5, 10 ),cattributes=>'class="str1_bg_left"');
   htp.tablerowclose;
   htp.tablerowopen;
    htp.tabledata( htf.formradio( 'P1', 'M'),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.bold( 'Manual' ),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formtext( 'P2', 5, 10 ),cattributes=>'class="str1_bg_left"');
   htp.tablerowclose;
  htp.tableclose;
  htp.nl;
  htp.formsubmit( 'ACTION', 'Split Detailr Record' );
  htp.formsubmit( 'ACTION', 'Cancel' );
  htp.formclose;
  htp.p( '</CENTER>' );
  htp.htmlclose;
exception when others then
 error_details( 'STRANGP', 'SPLIT_DETAILRS',null,null,errmsg=>sqlerrm,extdet=>'PARM:' || parm);
end split_detailrs;

procedure accept_split_detailrs(surl in varchar2, rid in varchar2, scid in varchar2, parm in varchar2, access_id in varchar2 default null, recctr in integer default 1, action in varchar2, p1 in varchar2, p2 in owa.vc_arr, force_single_disp in char default 'F', popup in char default 'F' )
as

 cursor c2( rid rowid ) is select * from strang.detailrs where rowid = rid;
 cursor c3( dlr number ) is select rowid from strang.receivals where deliveryno = dlr;
 cursor c4( dlr number ) is
  select max(itemno) mx
  from strang.detailrs
  where deliveryno = dlr;


 c2rec		c2%ROWTYPE;
 c3rec		c3%ROWTYPE;
 c4rec		c4%ROWTYPE;
 nmb		integer;
 sts		varchar2(100);
 vaccess	varchar2(20);

begin
 if not dapi.init( surl, 'STRANGP.ACCEPT_SPLIT_DETAILRS', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'ACCEPT_SPLIT_DETAILRS' );
    return;
 end if;

  vaccess := data_access( 'DETAILRS' );

  open c2(chartorowid(replace(rid,'~','+')));
  fetch c2 into c2rec;
  close c2;
  c2rec.partweight := nvl(c2rec.partweight,0);
  c2rec.partvolume := nvl(c2rec.partvolume,0);
  c2rec.qty := nvl(c2rec.qty,0);

  open c3(c2rec.deliveryno);
  fetch c3 into c3rec;
  close c3;
  if action = 'Cancel'
   then
    receive_bottom(surl,c3rec.rowid,scid,null,parm,access_id,recctr,'Action Cancelled',force_single_disp=>'T', popup=>popup );
    return;
  end if;

  if p1 = 'A'
   then
    begin nmb := nvl(to_number(p2(1)),0); exception when others then receive_bottom(surl,c3rec.rowid,scid,null,parm,access_id,recctr,'Invalid Split Number. Operation Cancelled',force_single_disp=>'T', popup=>popup ); return; end;
   else
    begin nmb := nvl(to_number(p2(2)),0); exception when others then receive_bottom(surl,c3rec.rowid,scid,null,parm,access_id,recctr,'Invalid Split Number. Operation Cancelled',force_single_disp=>'T', popup=>popup ); return; end;
  end if;
  if nmb > c2rec.qty then receive_bottom(surl,c3rec.rowid,scid,null,parm,access_id,recctr,'Split Number Greater than Quantity. Operation Cancelled',force_single_disp=>'T', popup=>popup ); return; end if;
  if nmb = 0 then receive_bottom(surl,c3rec.rowid,scid,null,parm,access_id,recctr,'Invalid Value Entered. Number must be greater than 0. Operation Cancelled.',force_single_disp=>'T', popup=>popup ); return; end if;
  open c4(c2rec.deliveryno);
  fetch c4 into c4rec;
  close c4;
  c4rec.mx := nvl(c4rec.mx,1);

  if p1 = 'A'
   then
    for j in 1..nmb loop
     if j = 1
      then
       insert into strang.detailrs
        (itemno,logno,hawb_hawbno,camov_seal,detaildesc,hazard,ecn,sa,cl,
         pktpe_packtype,owner,partvolume,partweight,qty,movement_no,
         deliveryno,entry_no,line_no,warehouse,handling_unit) values
        (c4rec.mx+j,c2rec.logno,c2rec.hawb_hawbno,c2rec.camov_seal,c2rec.detaildesc,c2rec.hazard,c2rec.ecn,c2rec.sa,c2rec.cl,
         c2rec.pktpe_packtype,c2rec.owner,round(c2rec.partvolume/nmb,5),trunc(c2rec.partweight/nmb) + mod(c2rec.partweight,nmb),trunc(c2rec.qty/nmb) + mod(c2rec.qty,nmb),c2rec.movement_no,
         c2rec.deliveryno,c2rec.entry_no,c2rec.line_no,c2rec.warehouse,c2rec.handling_unit);
      else
       insert into strang.detailrs
        (itemno,logno,hawb_hawbno,camov_seal,detaildesc,hazard,ecn,sa,cl,
         pktpe_packtype,owner,partvolume,partweight,qty,movement_no,
         deliveryno,entry_no,line_no,warehouse,handling_unit) values
        (c4rec.mx+j,c2rec.logno,c2rec.hawb_hawbno,c2rec.camov_seal,c2rec.detaildesc,c2rec.hazard,c2rec.ecn,c2rec.sa,c2rec.cl,
         c2rec.pktpe_packtype,c2rec.owner,round(c2rec.partvolume/nmb,5),trunc(c2rec.partweight/nmb),trunc(c2rec.qty/nmb),c2rec.movement_no,
         c2rec.deliveryno,c2rec.entry_no,c2rec.line_no,c2rec.warehouse,c2rec.handling_unit);
      end if;
    end loop;
    delete from strang.detailrs where rowid = chartorowid(replace(rid,'~','+'));
    commit;
    receive_bottom(surl,c3rec.rowid,scid,null,parm,access_id,recctr,'Records Split',force_single_disp=>'T', popup=>popup );
    return;
  end if;

  htp.p( '<CENTER>' );
  main_title( 'Manual Split Detailr Record',helpid=>'STR04');

  htp.nl;
  htp.formopen( 'strangp.accept_manual_split' );
   htp.formhidden( 'SURL', surl );
   htp.formhidden( 'RID', replace(rid,'~','+') );
   htp.formhidden( 'SCID', scid );
   htp.formhidden( 'PARM', parm );
   htp.formhidden( 'ACCESS_ID', access_id );
   htp.formhidden( 'RECCTR', recctr);
   htp.formhidden( 'FORCE_SINGLE_DISP', force_single_disp);
   htp.formhidden( 'POPUP', popup);
  htp.tableopen( cattributes=>'class="str1_table"' );
   htp.tablerowopen;
    htp.tabledata( '&nbsp;',cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.bold( 'Quantity' ),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.bold( c2rec.qty ),cattributes=>'class="str1_bg_left"');
    htp.tabledata( 'Weight',cattributes=>'class="str1_bg_left"');
    htp.tabledata( 'Volume',cattributes=>'class="str1_bg_left"');
   htp.tablerowclose;
   for j in 1..nmb loop
    htp.tablerowopen;
     htp.tabledata( to_char(j),cattributes=>'class="str1_cell_right"');
     if j = 1
      then
       htp.tabledata( htf.formtext('P1',5,5,to_char(trunc(c2rec.qty/nmb) + mod(c2rec.qty,nmb))),cattributes=>'class="str1_bg_left"');
      else
       htp.tabledata( htf.formtext('P1',5,5,to_char(trunc(c2rec.qty/nmb))),cattributes=>'class="str1_bg_left"');
     end if;
     htp.tabledata( '&nbsp;',cattributes=>'class="str1_bg_left"');
     if j = 1
      then
       htp.tabledata( htf.formtext( 'P2', 10, 20, to_char(trunc(c2rec.partweight/nmb) + mod(c2rec.partweight,nmb))),cattributes=>'class="str1_bg_left"');
       htp.tabledata( htf.formtext( 'P3', 10, 20, to_char(round(c2rec.partvolume/nmb,5))),cattributes=>'class="str1_bg_left"');
      else
       htp.tabledata( htf.formtext( 'P2', 10, 20, to_char(trunc(c2rec.partweight/nmb))),cattributes=>'class="str1_bg_left"');
       htp.tabledata( htf.formtext( 'P3', 10, 20, to_char(round(c2rec.partvolume/nmb,5))),cattributes=>'class="str1_bg_left"');
     end if;
    htp.tablerowclose;
   end loop;
   htp.tableclose;
   htp.nl;
   htp.formsubmit( 'ACTION', 'Manual Split' );
   htp.formsubmit( 'ACTION', 'Cancel' );
   htp.formclose;
   htp.htmlclose;
exception when others then
 error_details( 'STRANGP', 'ACCEPT_SPLIT_DETAILRS',null,null,errmsg=>sqlerrm,extdet=>'PARM:' || parm);
end accept_split_detailrs;

procedure accept_manual_split(surl in varchar2, rid in varchar2, scid in varchar2, parm in varchar2, access_id in varchar2 default null, recctr in integer default 1, action in varchar2, p1 in owa.vc_arr, p2 in owa.vc_arr, p3 in owa.vc_arr, force_single_disp in char default 'F', popup in char default 'F' )
as

 cursor c2( rid rowid ) is select * from strang.detailrs where rowid = rid;
 cursor c3( dlr number ) is select rowid from strang.receivals where deliveryno = dlr;
 cursor c4( dlr number ) is select max(itemno) mx from strang.detailrs where deliveryno = dlr;

 c2rec		c2%ROWTYPE;
 c3rec		c3%ROWTYPE;
 c4rec		c4%ROWTYPE;

 nmb		integer;
 nmb2		integer;
 nmb3		number;
 nmb4		number;
 sts		varchar2(100);
 vaccess	varchar2(20);
 tot_nmb	number;
 tot_weight	number;
 tot_volume	number;

begin
 if not dapi.init( surl, 'STRANGP.ACCEPT_MANUAL_SPLIT', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'ACCEPT_MANUAL_SPLIT');
    return;
 end if;

  vaccess := data_access( 'DETAILRS' );

  open c2(chartorowid(replace(rid,'~','+')));
  fetch c2 into c2rec;
  close c2;
  c2rec.partweight := nvl(c2rec.partweight,0);
  c2rec.partvolume := nvl(c2rec.partvolume,0);
  c2rec.qty := nvl(c2rec.qty,0);

  open c3(c2rec.deliveryno);
  fetch c3 into c3rec;
  close c3;
  if action = 'Cancel'
   then
    receive_bottom(surl,c3rec.rowid,scid,null,parm,access_id,recctr,'Action Cancelled',force_single_disp=>'T', popup=>popup );
    return;
  end if;
  begin nmb := p1.last; exception when others then receive_bottom(surl,c3rec.rowid,scid,null,parm,access_id,recctr,'Invalid Split Number. Operation Cancelled',force_single_disp=>'T', popup=>popup ); return; end;

  if nmb > c2rec.qty then receive_bottom(surl,c3rec.rowid,scid,null,parm,access_id,recctr,'Split Number Greater than Quantity. Operation Cancelled',force_single_disp=>'T', popup=>popup ); return; end if;
  open c4(c2rec.deliveryno);
  fetch c4 into c4rec;
  close c4;
  c4rec.mx := nvl(c4rec.mx,0);

  tot_nmb := 0;
  tot_weight := 0;
  tot_volume := 0;
  for j in 1..nmb loop
   begin nmb2 := to_number(p1(j)); exception when others then nmb2 := 0; end;
   begin nmb3 := to_number(p2(j)); exception when others then nmb3 := 0; end;
   begin nmb4 := to_number(p3(j)); exception when others then nmb4 := 0; end;
   --if nmb2 < 1 or nmb2 > c2rec.qty then nmb2 := 1; end if;

   update strang.detailrs
    set
     partvolume = nmb4,
     partweight = nmb3,
     qty = nmb2
   where
    itemno = c4rec.mx+j and
    deliveryno = c2rec.deliveryno;
   if sql%notfound
    then
     insert into strang.detailrs
         (itemno,logno,hawb_hawbno,camov_seal,detaildesc,hazard,ecn,sa,cl,pktpe_packtype,owner,
          partvolume,partweight,qty,
          movement_no,deliveryno,entry_no,line_no,warehouse,handling_unit) values
         (c4rec.mx+j,c2rec.logno,c2rec.hawb_hawbno,c2rec.camov_seal,c2rec.detaildesc,c2rec.hazard,c2rec.ecn,c2rec.sa,c2rec.cl,
          c2rec.pktpe_packtype,c2rec.owner,
          nmb4,nmb3,nmb2,
          c2rec.movement_no,c2rec.deliveryno,c2rec.entry_no,c2rec.line_no,c2rec.warehouse,strang.f_sap_format(c2rec.handling_unit,'HANDLING_UNIT'));
    end if;

    tot_nmb := tot_nmb + nmb2;
    tot_weight := tot_weight + nmb3;
    tot_volume := tot_volume + nmb4;
  end loop;

  if tot_nmb <> c2rec.qty
   then
    rollback;
    receive_bottom(surl,c3rec.rowid,scid,null,parm,access_id,recctr,'Quantity total does not match' || ':' || to_char(tot_nmb) || '-' || to_char(c2rec.qty),force_single_disp=>'T', popup=>popup );
    return;
  elsif tot_weight <> c2rec.partweight
   then
    rollback;
    receive_bottom(surl,c3rec.rowid,scid,null,parm,access_id,recctr,'Weight total does not match' || ':' || to_char(tot_weight) || '-' || to_char(c2rec.partweight),force_single_disp=>'T', popup=>popup );
    return;
  elsif tot_volume <> c2rec.partvolume
   then
    rollback;
    receive_bottom(surl,c3rec.rowid,scid,null,parm,access_id,recctr,'Volume total does not match' || ':' || to_char(tot_volume) || '-' || to_char(c2rec.partvolume),force_single_disp=>'T', popup=>popup );
    return;
  else
   delete from strang.detailrs where rowid = chartorowid(replace(rid,'~','+'));
  end if;

  commit;
  receive_bottom(surl,c3rec.rowid,scid,null,parm,access_id,recctr,'Records Split',force_single_disp=>'T', popup=>popup );
exception when others then
 error_details( 'STRANGP', 'ACCEPT_MANUAL_SPLIT',null,null,errmsg=>sqlerrm,extdet=>'PARM:' || parm);
end accept_manual_split;

procedure receive_po(surl in varchar2, rid in varchar2, scid in varchar2, call_name in varchar2, parm in varchar2, access_id in varchar2 default null, recctr in integer default 1, msg in varchar2 default NULL, force_single_disp in char default 'F', popup in char default 'F' )
as

 cursor c2( rid rowid ) is select * from strang.receivals where rowid = rid;
 cursor c3( dlrvy number ) is
  select s.rowid,s.*
  from strang.pos s
  where deliveryno = dlrvy
  order by recno,inventoryno;
 cursor c3t( dlrvy number ) is
  select count('x') tot
  from strang.pos
  where deliveryno = dlrvy
  order by recno,inventoryno;
 cursor c4( dlrvy number ) is select count('x') tot, max(recno) mx from strang.pos where deliveryno = dlrvy;
 cursor c5( dlryno number ) is select max(recno) tot from strang.pos where deliveryno = dlryno;
 cursor c6( vste varchar2 ) is select description from strang.lov where lov_name = 'CONTROLS' and code = 'DEFAULT COUNTRY CODE' and cola = vste;
 cursor c7( dlryno number ) is
  select nvl(l.cola,'LC') wbill
  from strang.lov l, strang.detailrs dr
  where lov_name = 'PACKTYPES' and
  dr.pktpe_packtype = l.code and
  dr.deliveryno = dlryno and
  dr.itemno in
  (select min(itemno)
   from strang.detailrs
   where deliveryno = dlryno)
;

 c2rec    c2%ROWTYPE;
 c3rec    c3%ROWTYPE;
 c4rec    c4%ROWTYPE;
 c5rec    c5%ROWTYPE;
 ltype    varchar2(100);
 stype    integer;
 sts    varchar2(100);
 vrecctr  integer;
 vaccess  varchar2(20);
 ttl    varchar2(200);
 vste   varchar2(10);
 seclevel varchar2(100);
 vtot	integer;
 url	varchar2(1000);

begin
 if not dapi.init( surl, 'STRANGP.RECEIVE_PO', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'RECEIVE_PO');
    return;
 end if;

 vaccess := data_access( 'POS' );
 vste := customer_state(dapi.GLOBAL_ACCOUNT.acctid);
 seclevel := security_role( dapi.GLOBAL_ACCOUNT.acctid );

 open c2( replace(rid,'~','+') );
 fetch c2 into c2rec;
 close c2;

 open c3t( c2rec.deliveryno );
 fetch c3t into vtot;
 close c3t;

 if access_id = 'z'
  then
   ttl := 'Please Enter in Receival Details';
   main_title( helpid=>'STR07', dispmenu=>FALSE);
   return;
  else
   if recctr > 0
    then
     open c4( c2rec.deliveryno );
     fetch c4 into c4rec;
     close c4;
     vrecctr := recctr;
     if recctr > c4rec.tot then vrecctr := c4rec.tot; end if;
     ttl := nvl(msg,'Update Purchase Order' ||  '(' || vrecctr || '/' || c4rec.tot || ')');
     main_title( helpid=>'STR07', dispmenu=>FALSE);
    else
     vrecctr := 0;
     ttl := nvl(msg,'Insert New Purchase Order');
     main_title( helpid=>'STR07', dispmenu=>FALSE);
   end if;
 end if;
 if vaccess = 'NONE' then htp.bold( 'Access Denied' ); htp.htmlclose; return; end if;
 if vaccess = 'EDIT'
  then
   if vtot > 1 and force_single_disp = 'F'
    then
     htp.formopen( 'strangp.accept_receive_po_arr' );
    else
     htp.formopen( '!strangp.accept_receive_po', cattributes=>'name="strangpo" id="strangpo"' );
   end if;
   htp.formhidden( 'SURL', surl );
   htp.formhidden( 'RID', replace(rid,'~','+') );
   htp.formhidden( 'SCID', scid );
   htp.formhidden( 'PARM', parm );
   htp.formhidden( 'ACCESS_ID', access_id );
   htp.formhidden( 'RECCTR', vrecctr);
   if FORCE_SINGLE_DISP = 'T'
    then
     htp.formhidden( 'FORCE_SINGLE_DISP', 'T');
    else
     if vtot > 1 or force_single_disp = 'Z'
      then
       htp.formhidden( 'FORCE_SINGLE_DISP', 'F');
      else
       htp.formhidden( 'FORCE_SINGLE_DISP', 'F');
     end if;
   end if;
 end if;

 if vaccess = 'READ' and vrecctr = 0
  then
   vrecctr := 1;
 end if;

 if vrecctr > 0
  then
   open c3( c2rec.deliveryno );
   for j in 1..vrecctr loop
   fetch c3 into c3rec;
    if c3%NOTFOUND then exit; end if;
   end loop;
   close c3;
end if;

 if recctr = 0
  then
    -- defaults set for when new record inserted, existing one copied and key columns set to a preset default
    c5rec.tot := NULL;
    open c5( c2rec.deliveryno );
    fetch c5 into c5rec;
    close c5;
    open c6(vste);
    fetch c6 into c3rec.ctry_countrycode;
    close c6;
    c3rec.unit_unitused := 'NO';
    c3rec.qty := 1;
    c3rec.grn_status := 0;
    c3rec.grn := null;
    c3rec.grn_item := null;
    c3rec.critical_flag := ' ';
--    c3rec.po_item_no := 1;
/*    open c7(c2rec.deliveryno);
    fetch c7 into c3rec.po_waybill_type ;
    close c7;
    if c3rec.po_waybill_type is null
      then c3rec.po_waybill_type := 'LC';
    end if;
*/ -- 20150526
 end if;

 htp.p( '<CENTER>' );
 -- Multi Display
 if (vtot > 1 and force_single_disp = 'F') or (force_single_disp = 'Z')
  then
   htp.tableopen( cattributes=>'class="str1_table"' );
    htp.tablerowopen;
     htp.tabledata( htf.bold( 'Recorder<br />No' ),cattributes=>'class="str1_bg_center"');
     htp.tabledata( htf.bold( 'Purchase<br />Order' ),cattributes=>'class="str1_bg_center"');
     htp.tabledata( htf.bold( 'Supplier<br />Inv' ),cattributes=>'class="str1_bg_center"');
     htp.tabledata( htf.bold( 'OTML<br />PO Item' ),cattributes=>'class="str1_bg_center"');
     htp.tabledata( htf.bold( 'Inventory' ),cattributes=>'class="str1_bg_center"');
     htp.tabledata( htf.bold( 'Qty' ),cattributes=>'class="str1_bg_center"');
     htp.tabledata( htf.bold( 'Unit' ),cattributes=>'class="str1_bg_center"');
     htp.tabledata( htf.bold( 'State' ),cattributes=>'class="str1_bg_center"');
     htp.tabledata( htf.bold( 'OTML<br />Delivery<br />No' ),cattributes=>'class="str1_bg_center"');
     htp.tabledata( htf.bold( 'OTML<br />Delivery<br />Qty' ),cattributes=>'class="str1_bg_center"');
     htp.tabledata( htf.bold( 'Excise<br />Qty' ),cattributes=>'class="str1_bg_center"');
     htp.tabledata( htf.bold( 'Excise<br />Unit' ),cattributes=>'class="str1_bg_center"');
     htp.tabledata( htf.bold( 'Action' ),cattributes=>'class="str1_bg_center"');
    htp.tablerowclose;
    for c3rec in c3( c2rec.deliveryno ) loop
     htp.tablerowopen;
      htp.tabledata( c3rec.recno,cattributes=>'class="str1_bg_left"');
      htp.tabledata( c3rec.po,cattributes=>'class="str1_bg_left"');
      htp.tabledata( c3rec.supinv,cattributes=>'class="str1_bg_left"');
      htp.tabledata( c3rec.po_item_no,cattributes=>'class="str1_bg_left"');
      htp.tabledata( c3rec.inventoryno,cattributes=>'class="str1_bg_left"');
      htp.tabledata( c3rec.qty,cattributes=>'class="str1_bg_left"');
      htp.tabledata( c3rec.unit_unitused,cattributes=>'class="str1_bg_left"');
      htp.tabledata( c3rec.state,cattributes=>'class="str1_bg_left"');
      htp.tabledata( c3rec.sap_delno,cattributes=>'class="str1_bg_left"');
      htp.tabledata( c3rec.sap_delno_item,cattributes=>'class="str1_bg_left"');
      htp.tabledata( c3rec.excise_qty,cattributes=>'class="str1_bg_left"');
      htp.tabledata( c3rec.excise_unit,cattributes=>'class="str1_bg_left"');
      htp.tabledata( '&nbsp;',cattributes=>'class="str1_bg_left"');
    htp.tablerowclose;
    end loop;
   htp.tableclose;
   htp.nl;
   htp.bold( ttl );
   htp.nl;
   htp.bold( '<a href="" onClick="self.close()">' || LNG.GLB_TXT_033 || '</a>');
   htp.p( '</CENTER>' );
   htp.htmlclose;
-- htp.header(3,'trace receive_po - total = ' || vtot || '[' || recctr || ']');

   return;
 end if;


 -- Single Display
 if vaccess = 'EDIT' then htp.formhidden( 'DETRID', rowidtochar( c3rec.rowid )); end if;
 htp.tableopen( cattributes=>'class="str1_table"' );
  htp.tablerowopen;
   htp.tabledata( 'Record No',cattributes=>'class="str1_hd_left"');
   if recctr = 0
    then
     htp.tabledata( htf.bold( to_char(nvl(c5rec.tot,0) + 1) ),cattributes=>'class="str1_bg_left"');
     htp.formhidden( 'P0', to_char(nvl(c5rec.tot,0) + 1) );
    else
     htp.tabledata( htf.bold( c3rec.recno ),cattributes=>'class="str1_bg_left"');
     htp.formhidden( 'P0', to_char(c3rec.recno) );
   end if;
   htp.formhidden( 'P1', c3rec.recno );

    if vaccess = 'EDIT'
     then
       url := 'strangp.pool_popup?surl=' || surl || '&rid=' || replace(c3rec.rowid,'+','~');
       url := htf.anchor( 'javascript: window.open(''' || url || ''',''' || 'POLOOK' || ''',''height=' || '600' || ',width=' || '1200' || ',scrollbars=yes,resizable=yes'');void('''');', 'Lookup' );
      htp.tabledata( url,cattributes=>'class="str1_hd_left"');
      htp.p( '<td class="str1_bg_left">' );
       -- Lookup is always read-only.
       if c3rec.po_pool_lookup is null
        then
         c3rec.po_pool_lookup := 'N';
         if c2rec.cust_customer_id = 1 then c3rec.po_pool_lookup := 'Y'; end if;
       end if;
       htp.formhidden( 'S4', c3rec.po_pool_lookup );
        if c3rec.po_pool_lookup = 'Y'
         then
          htp.p( 'Yes' );
         else
          htp.p( 'No' );
        end if;
       /*
        htp.formselectopen( 'S4' );
        if c3rec.po_pool_lookup = 'Y'
         then
          htp.formselectoption( 'Yes', 'SELECTED', cattributes=>'VALUE="'|| 'Y' ||'"');
          htp.formselectoption( 'No', cattributes=>'VALUE="'|| 'N' ||'"');
        elsif c3rec.po_pool_lookup = 'N'
         then
          htp.formselectoption( 'Yes', cattributes=>'VALUE="'|| 'Y' ||'"');
          htp.formselectoption( 'No', 'SELECTED', cattributes=>'VALUE="'|| 'N' ||'"');
        else
         if c2rec.cust_customer_id = 1 and nvl(c3rec.manual_grn,'|') <> 'Y'
          then
           htp.formselectoption( 'Yes', 'SELECTED', cattributes=>'VALUE="'|| 'Y' ||'"');
           htp.formselectoption( 'No', cattributes=>'VALUE="'|| 'N' ||'"');
          else
           htp.formselectoption( 'Yes', cattributes=>'VALUE="'|| 'Y' ||'"');
           htp.formselectoption( 'No', 'SELECTED', cattributes=>'VALUE="'|| 'N' ||'"');
         end if;
        end if;
        htp.formselectclose;
       */
      htp.p( '</td>' );
      htp.tabledata( 'Manual GRN',cattributes=>'class="str1_hd_left"');
      -- if intsuppm is not null it means receivals supplier id - see "suppm" id has been updated in top frame. Now if this is saved, if not null, will trigger an update of receivals.supplier_customer_i, see 'SUPPLIER', 'P8'
      htp.tabledata( '<div id="manual_grn">' || c3rec.manual_grn || '</div>' || htf.formhidden( 'N11',c3rec.manual_grn,cattributes=>'id="manual_grn2"') || htf.formhidden( 'INTSUPPM',null,cattributes=>'id="intsuppm"'),cattributes=>'class="str1_bg_left"');
     else
      htp.tabledata( 'Lookup',cattributes=>'class="str1_hd_left"');
      htp.tabledata( c3rec.po_pool_lookup, cattributes=>'class="str1_bg_left"' );
      htp.tabledata( 'Manual GRN',cattributes=>'class="str1_hd_left"');
      htp.tabledata( '<div id="manual_grn">' || c3rec.manual_grn || '</div>' || htf.formhidden( 'N11',c3rec.manual_grn,cattributes=>'id="manual_grn2"') || htf.formhidden( 'INTSUPPM',null,cattributes=>'id="intsuppm"'),cattributes=>'class="str1_bg_left"');
    end if;
  htp.tablerowclose;

  htp.tablerowopen;
   htp.tabledata( 'Purchase Order',cattributes=>'class="str1_hd_left"');
   if vaccess = 'EDIT'
    then
     if nvl(c3rec.po_pool_lookup,'|') = 'Y'
      then
       htp.tabledata( '<div id="po2">' || c3rec.po || '</div>' || htf.formhidden( 'P3', c3rec.po, cattributes=>'id="po"'),cattributes=>'class="str1_bg_left"');
      else
       htp.tabledata( htf.formtext( 'P3', 12, 15, c3rec.po,cattributes=>'id="po"'),cattributes=>'class="str1_bg_left"');
     end if;
    else
     htp.tabledata( c3rec.po,cattributes=>'class="str1_bg_left"');
   end if;
   htp.tabledata( 'OTML PO Item',cattributes=>'class="str1_hd_left"');
   if vaccess = 'EDIT'
    then
     if nvl(c3rec.po_pool_lookup,'|') = 'Y'
      then
       htp.tabledata( '<div id="po_item_no2">' || c3rec.po_item_no || '</div>' || htf.formhidden( 'P51', c3rec.po_item_no, cattributes=>'id="po_item_no"'),cattributes=>'class="str1_bg_left"');
      else
       htp.tabledata( htf.formtext( 'P51', 5, 10, c3rec.po_item_no,cattributes=>'id="po_item_no"' ),cattributes=>'class="str1_bg_left"');
     end if;
    else
     htp.tabledata( c3rec.po_item_no,cattributes=>'class="str1_bg_left"');
   end if;
     htp.tabledata( 'GRN Details',cattributes=>'class="str1_hd_left"');
    if vaccess = 'EDIT'
     then
      -- If the pos.grn_status is 7,8,9 then the following fields become read-only:
      if c3rec.grn_status in (7,8,9)
       then
        htp.tabledata( htf.formhidden( 'S3', html_format(c3rec.grn_status)) || c3rec.grn_status, cattributes=>'class="str1_bg_left"' );
       else
/*
[X] Pos.grn_status :  The user should only be able to update pos.grn_status with one of the following values 2,3,4,7.  The system can allocate 0,1,2,8 and 9.
[ ] If the pos.grn_status is 2 (critical), it can only be changed to 3 or 4.
[ ] If the pos.grn_status is 4, it can only be changed to 2.
*/
        htp.p( '<td class="str1_bg_left">' );
         htp.formselectopen( 'S3' );
         if c3rec.grn_status not in (2,3,4,7)
          then
           htp.formselectoption( c3rec.grn_status );
         end if;
         if c3rec.grn_status = 2
          then
           htp.formselectoption(2,'SELECTED');
           htp.formselectoption(3);
           htp.formselectoption(4);
         elsif c3rec.grn_status = 4
          then
           htp.formselectoption(2);
           htp.formselectoption(4,'SELECTED');
         else
          htp.formselectoption(2);
          if c3rec.grn_status = 3 then htp.formselectoption(3,'SELECTED'); else htp.formselectoption(3); end if;
          htp.formselectoption(4);
          if c3rec.grn_status = 7 then htp.formselectoption(7,'SELECTED'); else htp.formselectoption(7); end if;
         end if;
         htp.formselectclose;
        htp.p( '</td>' );
      end if;
     else
      htp.tabledata( c3rec.grn_status, cattributes=>'class="str1_bg_left"' );
    end if;
  htp.tablerowclose;

  htp.tablerowopen;
   htp.tabledata( 'Supplier Inv',cattributes=>'class="str1_hd_left"');
   if vaccess = 'EDIT'
    then
       if c3rec.grn_status in (7,8,9) -- nvl(c3rec.po_pool_lookup,'|') = 'Y' Supplier invoice (supinv) should only be readonly when grn_status= 7,8,9
        then
         htp.tabledata( '<div id="short_text2">' || c3rec.supinv || '</div>' || htf.formhidden( 'P5', c3rec.supinv,cattributes=>'id="short_text"' ),cattributes=>'class="str1_bg_left"');
        else
         htp.tabledata( htf.formtext( 'P5', 12, 15, c3rec.supinv,cattributes=>'id="short_text"' ),cattributes=>'class="str1_bg_left"');
       end if;
    else
     htp.tabledata( c3rec.supinv,cattributes=>'class="str1_bg_left"');
   end if;
   if vaccess = 'EDIT'
    then
       url := 'strangp.lov?surl=' || surl || '&call_name=strangp.lov&parm=INVENT&lrange=&src=' || c3rec.inventoryno;
       url := 'javascript: window.open(''' || url || ''',''' || 'INVENT_SEARCH' || ''',''height=' || '800' || ',width=' || '1000' || ',scrollbars=yes,resizable=yes'');void('''');';
       htp.tabledata( htf.anchor(url,'Inventory'),cattributes=>'class="str1_hd_left"');
       htp.p( '<TD ' || 'class="str1_bg_left">' );
       if nvl(c3rec.po_pool_lookup,'|') = 'Y'
        then
         htp.formhidden( 'P2', c3rec.inventoryno,cattributes=>'id="inventoryno"' );
         htp.p( '<div id="inventoryno2">' || c3rec.inventoryno || '</div>' );
        else
         htp.formtext( 'P2', 12, 15, c3rec.inventoryno,cattributes=>'id="inventoryno"' );
       end if;
       htp.p( '</TD>' );
    else
     htp.tabledata( 'Inventory',cattributes=>'class="str1_hd_left"');
     htp.tabledata( c3rec.inventoryno,cattributes=>'class="str1_bg_left"');
   end if;

    htp.p( '<td class="str1_bg_center" colspan="2" rowspan="2">' );

      htp.tableopen( cattributes=>'class="str1_int"' );
       htp.tablerowopen;
        htp.tableheader( 'Critical Flag');
        htp.tableheader( 'GRN');
        htp.tableheader( 'GRN Item');
        htp.tableheader( 'Offsite Receipt Date');
       htp.tablerowclose;
       htp.tablerowopen;
        htp.tabledata( '<div id="critical_flag">' || nvl(c3rec.critical_flag,'&nbsp;') || '</div>' || htf.formhidden( 'CF', c3rec.critical_flag, cattributes=>'id="critical_flag2"' ));
        htp.tabledata( nvl(to_char(c3rec.grn),'&nbsp;'));
        htp.tabledata( nvl(to_char(c3rec.grn_item),'&nbsp;'));
        htp.tabledata( nvl(to_char(c3rec.off_site_receipt,'DD-MON-YYYY HH24:MI'),'&nbsp;'));
       htp.tablerowclose;
      htp.tableclose;

     htp.p( '</td>' );
  htp.tablerowclose;

  htp.tablerowopen;
   htp.tabledata( 'Qty',cattributes=>'class="str1_hd_left"');
   if vaccess = 'EDIT'
    then
     htp.tabledata( htf.formtext( 'D6', 12, 15, c3rec.qty), cattributes=>'class="str1_bg_left"' );
    else
     htp.tabledata( c3rec.qty, cattributes=>'class="str1_bg_left"' );
   end if;
   htp.tabledata( 'Unit',cattributes=>'class="str1_hd_left"');
   if vaccess = 'EDIT'
    then
     htp.tabledata( htf.formtext( 'D7', 8, 10, c3rec.unit_unitused), cattributes=>'class="str1_bg_left"' );
    else
     htp.tabledata( c3rec.unit_unitused, cattributes=>'class="str1_bg_left"' );
   end if;
  htp.tablerowclose;

  htp.tablerowopen;
    htp.tabledata( 'Ordered Qty',cattributes=>'class="str1_hd_left"');
    if vaccess = 'EDIT'
     then
      -- note: logic regarding this has changed numerous times as requested by Sallie
      if c3rec.grn_status in (7,8,9) -- nvl(c3rec.po_pool_lookup,'|') = 'Y' -- Changed as requested by Sallie from c3rec.off_site_receipt is not null, change again: Can you please make sap_delno_qty editable until it becomes status 7,8,9
       then
        htp.tabledata( '<div id="sap_delno_qty2">' || c3rec.sap_delno_qty || '</div>' || htf.formhidden( 'S1', html_format(c3rec.sap_delno_qty),cattributes=>'id="sap_delno_qty"'), cattributes=>'class="str1_bg_left"' );
       else
        htp.tabledata( htf.formtext( 'S1', 12, 15, html_format(c3rec.sap_delno_qty),cattributes=>'id="sap_delno_qty"'), cattributes=>'class="str1_bg_left"' );
      end if;
     else
      htp.tabledata( c3rec.sap_delno_qty, cattributes=>'class="str1_bg_left"' );
    end if;
    htp.tabledata( 'Ordered Unit',cattributes=>'class="str1_hd_left"');
    if vaccess = 'EDIT'
     then
      if nvl(c3rec.po_pool_lookup,'|') = 'Y'
       then
        htp.tabledata( '<div id="sap_delno_unit2">' || c3rec.sap_delno_unit || '</div>' || htf.formhidden( 'P2D', html_format(c3rec.sap_delno_unit), cattributes=>'id="sap_delno_unit"'),cattributes=>'class="str1_bg_left"');
       else
        htp.tabledata( htf.formtext( 'P2D', 8, 8, html_format(c3rec.sap_delno_unit),cattributes=>'id="sap_delno_unit"'), cattributes=>'class="str1_bg_left"' );
      end if;
     else
      htp.tabledata( c3rec.sap_delno_unit, cattributes=>'class="str1_bg_left"' );
    end if;
   htp.tabledata( 'GST Code',cattributes=>'class="str1_hd_left"');
   if vaccess = 'EDIT'
    then
     if seclevel in ( 'LEVEL 8' )
      then
       htp.p( '<TD ' || 'class="str1_bg_left">' );
       htp.formhidden( 'P52', null);
       htp.formhidden( 'D4', nvl(c3rec.gstc_gstcode,c2rec.gstc_gstcode) );
       lov_list( 'GSTCODES', 'D4', nvl(c3rec.gstc_gstcode,c2rec.gstc_gstcode), FALSE, TRUE, TRUE, isedit=>FALSE );
       htp.p( '</TD>' );
      else
       htp.p( '<TD ' || 'class="str1_bg_left">' );
       lov_list( 'GSTCODES', 'D4', nvl(c3rec.gstc_gstcode,c2rec.gstc_gstcode), FALSE, TRUE, TRUE );
       htp.p( '</TD>' );
     end if;
    else
     htp.p( '<TD ' || 'class="str1_bg_left">' );
     lov_list( 'GSTCODES', 'D4', nvl(c3rec.gstc_gstcode,c2rec.gstc_gstcode), FALSE, TRUE, TRUE, isedit=>FALSE );
     htp.p( '</TD>' );
   end if;
  htp.tablerowclose;

  htp.tablerowopen;
   htp.tabledata( 'Country',cattributes=>'class="str1_hd_left"');
   if vaccess = 'EDIT'
    then
     htp.p( '<TD ' || 'class="str1_bg_left">' );
     lov_list( 'UNCTYTAB', 'P4', c3rec.ctry_countrycode, TRUE, TRUE, TRUE );
     htp.p( '</TD>' );
    else
     htp.p( '<TD ' || 'class="str1_bg_left">' );
     lov_list( 'UNCTYTAB', 'P4', c3rec.ctry_countrycode, TRUE, TRUE, TRUE, isedit=>FALSE );
     htp.p( '</TD>' );
   end if;
   htp.tabledata( 'Shipping Instr',cattributes=>'class="str1_hd_left"');
   if vaccess = 'EDIT'
    then
     if nvl(c3rec.po_pool_lookup,'|') = 'Y'
      then
       htp.tabledata( '<div id="shipping_text2">' || c3rec.shipping_text || '</div>' || htf.formhidden( 'S5', html_format(c3rec.shipping_text), cattributes=>'id="shipping_text"'),cattributes=>'class="str1_bg_left"');
      else
       htp.tabledata( htf.formtext( 'S5', 30, 30, html_format(c3rec.shipping_text),cattributes=>'id="shipping_text"'), cattributes=>'class="str1_bg_left"' );
     end if;
    else
     htp.tabledata( c3rec.shipping_text, cattributes=>'class="str1_bg_left"' );
   end if;
   /*
   htp.tabledata( '&nbsp;',cattributes=>'class="str1_bg_left"');
   htp.tabledata( '&nbsp;',cattributes=>'class="str1_bg_left"');
   */
   htp.tabledata( 'Goods Receipt No.',cattributes=>'class="str1_hd_left"');
   -- Po.grn and pos.grn_item are always readonly.  Even if manual_grn is flagged.  This is because the enduser will receipt in SAP and the GRN and GRN_item will be returned in interface3.
   --if vaccess = 'EDIT' and c3rec.manual_grn = 'Y'
   -- then
   --  htp.tabledata( htf.formtext( 'PGRN', 11, 17, html_format(c3rec.grn)) || ' Item ' || htf.formtext( 'PGRNI', 11, 17, html_format(c3rec.grn_item)), cattributes=>'class="str1_bg_left"' );
   --els
   if vaccess = 'EDIT'
    then
     htp.tabledata( c3rec.grn_item || htf.formhidden( 'PGRN', html_format(c3rec.grn)) || htf.formhidden( 'PGRNI', html_format(c3rec.grn_item)), cattributes=>'class="str1_bg_left"' );
    else
     htp.tabledata( c3rec.grn_item, cattributes=>'class="str1_bg_left"' );
   end if;
  htp.tablerowclose;


  htp.tablerowopen;
   htp.tabledata( 'Amount',cattributes=>'class="str1_hd_left"');
   if vaccess = 'EDIT'
    then
     if seclevel in ( 'LEVEL 8' )
      then
       htp.tabledata( htf.formhidden( 'D3', ltrim(to_char(c3rec.amount,G_STR_FRMT_06))) || ltrim(to_char(c3rec.amount,G_STR_FRMT_06)), cattributes=>'class="str1_bg_left"' );
      else
       htp.tabledata( htf.formtext( 'D3', 15, 15, ltrim(to_char(c3rec.amount,G_STR_FRMT_06))), cattributes=>'class="str1_bg_left"' );
     end if;
    else
     htp.tabledata( ltrim(to_char(c3rec.amount,G_STR_FRMT_06)), cattributes=>'class="str1_bg_left"' );
   end if;
   htp.tabledata( 'GST',cattributes=>'class="str1_hd_left"');
   if vaccess = 'EDIT'
    then
     if seclevel in ( 'LEVEL 8' )
      then
       htp.tabledata( htf.formhidden( 'D5', ltrim(to_char(c3rec.gst,G_STR_FRMT_06))) || ltrim(to_char(c3rec.gst,G_STR_FRMT_06)), cattributes=>'class="str1_bg_left"' );
      else
       htp.tabledata( htf.formtext( 'D5', 12, 12, ltrim(to_char(c3rec.gst,G_STR_FRMT_06))), cattributes=>'class="str1_bg_left"' );
     end if;
    else
     htp.tabledata( ltrim(to_char(c3rec.gst,G_STR_FRMT_06)), cattributes=>'class="str1_bg_left"' );
   end if;
   if vste in ('SYD','BNE','PER','MEL','ADL')
    then
     htp.tabledata( 'State',cattributes=>'class="str1_hd_left"');
     if VACCESS = 'EDIT'
     then
       htp.p( '<TD ' || 'class="str1_bg_left">' );
       lov_list( 'STATE', 'ST', c3rec.state, FALSE, FALSE, TRUE );
       htp.p( '</TD>' );
      htp.p( '</TD>' );
     else
      htp.p( '<TD ' || 'class="str1_bg_left">' );
      lov_list( 'STATE', 'ST', c3rec.state, FALSE, FALSE, TRUE, isedit=>FALSE );
    end if;
   else
     htp.tabledata( '&nbsp;',cattributes=>'class="str1_hd_left"');
     if VACCESS = 'EDIT'
     then
      htp.tabledata( c3rec.state || htf.formhidden( 'STATE', c3rec.state ) ,cattributes=>'class="str1_bg_left"');
     else
      htp.tabledata( '&nbsp;',cattributes=>'class="str1_bg_left"');
     end if;
  end if;
  htp.tablerowclose;

  htp.tablerowopen;
   htp.tabledata( 'Total Amount',cattributes=>'class="str1_hd_left"');
   if vaccess = 'EDIT'
    then
     htp.tabledata( htf.formtext( 'D8', 15, 15, ltrim(to_char(c3rec.tamount,G_STR_FRMT_06))), cattributes=>'class="str1_bg_left"' );
    else
     htp.tabledata( ltrim(to_char(c3rec.tamount,G_STR_FRMT_06)), cattributes=>'class="str1_bg_left"' );
   end if;
     htp.tabledata( 'Freight Charge' ,cattributes=>'class="str1_hd_left"');
   if vaccess = 'EDIT'
    then
     htp.tabledata( htf.formtext( 'D8a', 15, 15, ltrim(to_char(c3rec.delivery_charge,G_STR_FRMT_06))), cattributes=>'class="str1_bg_left"' );
    else
     htp.tabledata( ltrim(to_char(c3rec.delivery_charge,G_STR_FRMT_06)), cattributes=>'class="str1_bg_left"' );
   end if;



---------------------------------------------------------------
/*
  htp.tablerowopen;
   htp.tabledata( htf.bold( 'OTML Delivery No' ),cattributes=>'class="str1_bg_left"');
   if vaccess = 'EDIT'
    then
     htp.tabledata( htf.formtext( 'p53', 12, 15, c3rec.sap_delno), cattributes=>'class="str1_bg_left"' );
    else
     htp.tabledata( c3rec.sap_delno, cattributes=>'class="str1_bg_left"' );
   end if;
   htp.tabledata( htf.bold( 'OTML Delivery Qty' ),cattributes=>'class="str1_bg_left"');
   if vaccess = 'EDIT'
    then
     htp.tabledata( htf.formtext( 'p53a', 10, 15, c3rec.sap_delno_item), cattributes=>'class="str1_bg_left"' );
    else
     htp.tabledata( c3rec.sap_delno_item, cattributes=>'class="str1_bg_left"' );
   end if;
   htp.tabledata( htf.bold( 'Excise Qty'),cattributes=>'class="str1_bg_left"');
   if vaccess = 'EDIT'
    then
     htp.tabledata( htf.formtext( 'D6e', 12, 15, c3rec.excise_qty), cattributes=>'class="str1_bg_left"' );
    else
     htp.tabledata( c3rec.excise_qty, cattributes=>'class="str1_bg_left"' );
   end if;
   htp.tabledata( htf.bold( 'Excise Unit' ),cattributes=>'class="str1_bg_left"');
   if vaccess = 'EDIT'
    then
     htp.tabledata( htf.formtext( 'D7e', 8, 10, c3rec.excise_unit), cattributes=>'class="str1_bg_left"' );
--	  htp.p( '<TD ' || 'class="str1_bg_left">' );
--	  lov_list( 'UNITS', 'D7E', c3rec.excise_unit, FALSE, TRUE, FALSE, isedit=>FALSE );
--	  htp.p( '</TD>' );
    else
     htp.tabledata( c3rec.excise_unit, cattributes=>'class="str1_bg_left"' );
   end if;
   htp.tabledata( htf.bold( '' ),cattributes=>'class="str1_bg_left"');
       htp.p( '<TD ' || 'class="str1_bg_left" COLSPAN=1>' );
       htp.p( '</TD>' );
  htp.tablerowclose;
*/

   htp.p( '<TD ' || 'class="str1_bg_left" colspan="2">' );
   htp.tableopen( cattributes=>'class="str1_table4"' );
   htp.tablerowopen;
   if vaccess = 'EDIT'
    then
     if c3rec.rowid is not null
      then
       htp.tabledata( htf.formimage( 'Save_Record',INSTALL_PARAMETERS.IMAGE_LOCATION || 'str/' || 'adminc_save.gif' ));
       htp.tabledata( htf.formimage( 'Insert_Record',INSTALL_PARAMETERS.IMAGE_LOCATION || 'str/' || 'adminc_insert.gif' ));
       if seclevel in ( 'LEVEL 8' )
        then
         null;
        else
         if nvl(c3rec.po_pool_lookup,'|') = 'Y' then null; else htp.tabledata( htf.formimage( 'Copy_Record',INSTALL_PARAMETERS.IMAGE_LOCATION || 'str/' || 'adminc_copy.gif' )); end if;
       end if;
       if vrecctr <> '0' then htp.tabledata( htf.formimage( 'Delete_Record',INSTALL_PARAMETERS.IMAGE_LOCATION || 'str/' || 'adminc_delete.gif' )); end if;
      else
       htp.tabledata( htf.formimage( 'Save_Record',INSTALL_PARAMETERS.IMAGE_LOCATION || 'str/' || 'adminc_save.gif' ));
       if recctr > 0
        then
         htp.tabledata( htf.formimage( 'Insert_Record',INSTALL_PARAMETERS.IMAGE_LOCATION || 'str/' || 'adminc_insert.gif' ));
       end if;
     end if;
   end if;

    if recctr = 0
     then
      if vrecctr <> '0' then htp.tabledata( htf.formimage( 'Cancel',INSTALL_PARAMETERS.IMAGE_LOCATION || 'str/' || 'adminc_cancel.gif' )); end if;

    elsif vrecctr = 1 and vrecctr < c4rec.tot
    then
     if vaccess = 'EDIT'
      then
       htp.tabledata( htf.formimage( 'Next_Record',INSTALL_PARAMETERS.IMAGE_LOCATION || 'str/' || 'adminc_next.gif' ));
       htp.tabledata( htf.formimage( 'Last_Record',INSTALL_PARAMETERS.IMAGE_LOCATION || 'str/' || 'adminc_last.gif' ));
      else
       htp.tabledata( htf.anchor( 'strangp.receive_po?surl=' || surl || '&rid=' || replace( rid, '+', '~' ) || '&scid=' || replace(scid,' ','+') || '&call_name=' || replace(call_name,' ','+') || '&parm=' || replace(parm,' ','+') || '&access_id=' || replace(access_id,' ','+') || '&recctr=' || to_char(vrecctr+1) || '&force_single_disp=' || force_single_disp || '&popup=' || popup, htf.img( INSTALL_PARAMETERS.IMAGE_LOCATION || 'str/' || 'adminc_next.gif',calt=>'Next Record' ) ));
       htp.tabledata( htf.anchor( 'strangp.receive_po?surl=' || surl || '&rid=' || replace( rid, '+', '~' ) || '&scid=' || replace(scid,' ','+') || '&call_name=' || replace(call_name,' ','+') || '&parm=' || replace(parm,' ','+') || '&access_id=' || replace(access_id,' ','+') || '&recctr=' || to_char(c4rec.tot) || '&force_single_disp=' || force_single_disp || '&popup=' || popup, htf.img( INSTALL_PARAMETERS.IMAGE_LOCATION || 'str/' || 'adminc_last.gif',calt=>'Last Record' ) ));
      end if;

    elsif vrecctr > 1 and vrecctr < c4rec.tot
    then
     if vaccess = 'EDIT'
      then
       htp.tabledata( htf.formimage( 'First_Record',INSTALL_PARAMETERS.IMAGE_LOCATION || 'str/' || 'adminc_first.gif' ));
       htp.tabledata( htf.formimage( 'Previous_Record',INSTALL_PARAMETERS.IMAGE_LOCATION || 'str/' || 'adminc_previous.gif' ));
       htp.tabledata( htf.formimage( 'Next_Record',INSTALL_PARAMETERS.IMAGE_LOCATION || 'str/' || 'adminc_next.gif' ));
       htp.tabledata( htf.formimage( 'Last_Record',INSTALL_PARAMETERS.IMAGE_LOCATION || 'str/' || 'adminc_last.gif' ));
      else
       htp.tabledata( htf.anchor( 'strangp.receive_po?surl=' || surl || '&rid=' || replace( rid, '+', '~' ) || '&scid=' || replace(scid,' ','+') || '&call_name=' || replace(call_name,' ','+') || '&parm=' || replace(parm,' ','+') || '&access_id=' || replace(access_id,' ','+') || '&recctr=1' || '&force_single_disp=' || force_single_disp || '&popup=' || popup, htf.img( INSTALL_PARAMETERS.IMAGE_LOCATION || 'str/' || 'adminc_first.gif',calt=>'First Record' ) ));
       htp.tabledata( htf.anchor( 'strangp.receive_po?surl=' || surl || '&rid=' || replace( rid, '+', '~' ) || '&scid=' || replace(scid,' ','+') || '&call_name=' || replace(call_name,' ','+') || '&parm=' || replace(parm,' ','+') || '&access_id=' || replace(access_id,' ','+') || '&recctr=' || to_char(vrecctr-1) || '&force_single_disp=' || force_single_disp || '&popup=' || popup, htf.img( INSTALL_PARAMETERS.IMAGE_LOCATION || 'str/' || 'adminc_previous.gif',calt=>'Previous Record' ) ));
       htp.tabledata( htf.anchor( 'strangp.receive_po?surl=' || surl || '&rid=' || replace( rid, '+', '~' ) || '&scid=' || replace(scid,' ','+') || '&call_name=' || replace(call_name,' ','+') || '&parm=' || replace(parm,' ','+') || '&access_id=' || replace(access_id,' ','+') || '&recctr=' || to_char(vrecctr+1) || '&force_single_disp=' || force_single_disp || '&popup=' || popup, htf.img( INSTALL_PARAMETERS.IMAGE_LOCATION || 'str/' || 'adminc_next.gif',calt=>'Next Record' ) ));
       htp.tabledata( htf.anchor( 'strangp.receive_po?surl=' || surl || '&rid=' || replace( rid, '+', '~' ) || '&scid=' || replace(scid,' ','+') || '&call_name=' || replace(call_name,' ','+') || '&parm=' || replace(parm,' ','+') || '&access_id=' || replace(access_id,' ','+') || '&recctr=' || to_char(c4rec.tot) || '&force_single_disp=' || force_single_disp || '&popup=' || popup, htf.img( INSTALL_PARAMETERS.IMAGE_LOCATION || 'str/' || 'adminc_last.gif',calt=>'Last Record' ) ));
      end if;

    elsif vrecctr = c4rec.tot and vrecctr > 1
     then
      if vaccess = 'EDIT'
       then
        htp.tabledata( htf.formimage( 'First_Record',INSTALL_PARAMETERS.IMAGE_LOCATION || 'str/' || 'adminc_first.gif' ));
        htp.tabledata( htf.formimage( 'Previous_Record',INSTALL_PARAMETERS.IMAGE_LOCATION || 'str/' || 'adminc_previous.gif' ));
      else
        htp.tabledata( htf.anchor( 'strangp.receive_po?surl=' || surl || '&rid=' || replace( rid, '+', '~' ) || '&scid=' || replace(scid,' ','+') || '&call_name=' || replace(call_name,' ','+') || '&parm=' || replace(parm,' ','+') || '&access_id=' || replace(access_id,' ','+') || '&recctr=1' || '&force_single_disp=' || force_single_disp || '&popup=' || popup, htf.img( INSTALL_PARAMETERS.IMAGE_LOCATION || 'str/' || 'adminc_first.gif',calt=>'First Record' ) ));
        htp.tabledata( htf.anchor( 'strangp.receive_po?surl=' || surl || '&rid=' || replace( rid, '+', '~' ) || '&scid=' || replace(scid,' ','+') || '&call_name=' || replace(call_name,' ','+') || '&parm=' || replace(parm,' ','+') || '&access_id=' || replace(access_id,' ','+') || '&recctr=' || to_char(vrecctr-1) || '&force_single_disp=' || force_single_disp || '&popup=' || popup, htf.img( INSTALL_PARAMETERS.IMAGE_LOCATION || 'str/' || 'adminc_previous.gif',calt=>'Previous Record' ) ));
      end if;

   end if;
   htp.formclose;
   if c4rec.tot > 1 then
   htp.tabledata( htf.formopen( 'strangp.receive_po' ) || htf.formhidden( 'SURL', surl ) || htf.formhidden( 'RID', replace(rid,'~','+') ) ||
          htf.formhidden( 'SCID', scid ) || htf.formtext( 'RECCTR', 2, 5, vrecctr ) || htf.formhidden( 'CALL_NAME', call_name ) ||
          htf.formhidden( 'PARM', parm ) || htf.formhidden( 'ACCESS_ID', access_id ) || htf.formhidden( 'FORCE_SINGLE_DISP', force_single_disp ) || htf.formhidden( 'POPUP', popup ) || htf.formsubmit( null, 'Goto' ) || htf.formclose );
    else
     htp.tabledata('&nbsp;');
    end if;
    htp.tablerowclose;
    htp.tableclose;
   htp.p( '</TD>' );

  htp.tablerowclose;
 htp.tableclose;
 htp.bold( ttl );
 htp.nl;
 if popup = 'T' then htp.bold( '<a href="" onClick="self.close()">' || LNG.GLB_TXT_033 || '</a>'); end if;
 htp.p( '</CENTER>' );
-- htp.header(3,'trace receive_po - total = ' || vtot || '[' || recctr || ']');

 htp.htmlclose;

exception when others then
 error_details( 'STRANGP', 'RECEIVE_PO',null,null,errmsg=>sqlerrm,extdet=>'PARM:' || parm);
end receive_po;

procedure confirm_delete_detailrs(surl in varchar2, rid in varchar2, scid in varchar2, detrid in varchar2, parm in varchar2, access_id in varchar2 default null, recctr in integer default 1, msg in varchar2 default NULL, force_single_disp in char default 'F', popup in char default 'F' )
as

 cursor c2( rid rowid ) is select * from strang.detailrs where rowid = rid;

 c2rec		c2%ROWTYPE;
 sts		varchar2(100);
 vaccess	varchar2(20);
 ttl		varchar2(200);

begin
 if not dapi.init( surl, 'STRANGP.CONFIRM_DELETE_DETAILRS', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'CONFIRM_DELETE_DETAILRS');
    return;
 end if;

 vaccess := data_access( 'POS');

 open c2( replace(detrid,'~','+') );
 fetch c2 into c2rec;
 close c2;
 if vaccess <> 'EDIT' then htp.bold( 'Access Denied' ); htp.htmlclose; return; end if;
 main_title( 'Confirm Delete of ' || c2rec.itemno,helpid=>'STR05',dispmenu=>FALSE);
 htp.p( '<CENTER>' );
 htp.formopen( 'strangp.accept_delete_detailrs' );
 htp.formhidden( 'SURL', surl );
 htp.formhidden( 'RID', replace(rid,'~','+') );
 htp.formhidden( 'SCID', scid );
 htp.formhidden( 'PARM', parm );
 htp.formhidden( 'DETRID', replace(detrid,'~','+') );
 htp.formhidden( 'ACCESS_ID', access_id );
 htp.formhidden( 'RECCTR', recctr);
 htp.formhidden( 'FORCE_SINGLE_DISP', force_single_disp);
 htp.formhidden( 'POPUP', popup);
 htp.formsubmit( 'ACTION', 'Do not Delete' );
 htp.formsubmit( 'ACTION', 'Delete Detail Record' );
 htp.p( '</CENTER>' );
 htp.htmlclose;

exception when others then
 error_details( 'STRANGP', 'CONFIRM_DELETE_DETAILRS',null,null,errmsg=>sqlerrm,extdet=>'PARM:' || parm);
end confirm_delete_detailrs;

procedure confirm_delete_po(surl in varchar2, rid in varchar2, scid in varchar2, detrid in varchar2, parm in varchar2, access_id in varchar2 default null, recctr in integer default 1, msg in varchar2 default NULL, force_single_disp in char default 'F', popup in char default 'F' )
as

 cursor c2( rid rowid ) is select * from strang.pos where rowid = rid;


 c2rec		c2%ROWTYPE;

 sts		varchar2(100);
 vaccess	varchar2(20);
 ttl		varchar2(200);

begin
 if not dapi.init( surl, 'STRANGP.CONFIRM_DELETE_PO', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'CONFIRM_DELETE_PO');
    return;
 end if;

 vaccess := data_access( 'POS' );

 open c2( replace(detrid,'~','+') );
 fetch c2 into c2rec;
 close c2;
 if vaccess <> 'EDIT' then htp.bold( 'Access Denied' ); htp.htmlclose; return; end if;
 htp.formhidden( 'SURL', surl );
 main_title( 'Confirm Delete of ' || c2rec.po,helpid=>'STR06');
 htp.p( '<CENTER>' );
 htp.formopen( 'strangp.accept_delete_po' );
 htp.formhidden( 'RID', replace(rid,'~','+') );
 htp.formhidden( 'SCID', scid );
 htp.formhidden( 'PARM', parm );
 htp.formhidden( 'DETRID', replace(detrid,'~','+') );
 htp.formhidden( 'ACCESS_ID', access_id );
 htp.formhidden( 'RECCTR', recctr);
 htp.formhidden( 'FORCE_SINGLE_DISP', force_single_disp);
 htp.formhidden( 'POPUP', popup);
 htp.formsubmit( 'ACTION', 'Do not Delete' );
 htp.formsubmit( 'ACTION', 'Delete Purchase Order Record' );
 htp.p( '</CENTER>' );
 htp.htmlclose;

exception when others then
 error_details( 'STRANGP', 'CONFIRM_DELETE_PO',null,null,errmsg=>sqlerrm,extdet=>'PARM:' || parm);
end confirm_delete_po;

procedure accept_delete_detailrs(surl in varchar2, rid in varchar2, scid in varchar2, detrid in varchar2, parm in varchar2, access_id in varchar2 default null, recctr in integer, action in varchar2, force_single_disp in char default 'F', popup in char default 'F' )
as

 cursor c2( rid rowid ) is select deliveryno from strang.receivals where rowid = rid;
 cursor c6( rid rowid ) is select movement_no, camov_seal from strang.detailrs where rowid = rid;

 c2rec		c2%ROWTYPE;
 c6rec		c6%ROWTYPE;
 sts		varchar2(100);
 newrid		rowid;

begin
 if not dapi.init( surl, 'STRANGP.ACCEPT_DELETE_DETAILRS', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'ACCEPT_DELETE_DETAILRS');
    return;
 end if;

 open c2( chartorowid( replace(rid,'~','+') ) );
 fetch c2 into c2rec;
 close c2;

 if action = 'Delete Detail Record'
  then
   open c6( chartorowid( detrid ));
   fetch c6 into c6rec;
   close c6;
   delete from strang.detailrs where rowid = chartorowid( detrid );
   if c6rec.movement_no is not null
    then
     recalc_weight( c6rec.movement_no, sl=>c6rec.camov_seal );
   end if;
   commit;
   receive_bottom(surl,rid,scid,null,parm,access_id,recctr - 1,'Record Deleted',force_single_disp=>force_single_disp, popup=>popup );
  else
   receive_bottom(surl,rid,scid,null,parm,access_id,recctr,'Action Cancelled',force_single_disp=>force_single_disp, popup=>popup );
 end if;
exception when others then
 error_details( 'STRANGP', 'ACCEPT_DELETE_DETAILRS',null,null,errmsg=>sqlerrm,extdet=>'PARM:' || parm);
end accept_delete_detailrs;

procedure accept_delete_po(surl in varchar2, rid in varchar2, scid in varchar2, detrid in varchar2, parm in varchar2, access_id in varchar2 default null, recctr in integer, action in varchar2, force_single_disp in char default 'F', popup in char default 'F' )
as

 cursor c2( rid rowid ) is select deliveryno from strang.receivals where rowid = rid;

 c2rec		c2%ROWTYPE;
 sts		varchar2(100);
 newrid		rowid;

begin
 if not dapi.init( surl, 'STRANGP.ACCEPT_DELETE_PO', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'ACCEPT_DELETE_PO');
    return;
 end if;

 open c2( chartorowid( replace(rid,'~','+') ) );
 fetch c2 into c2rec;
 close c2;

 if action = 'Delete Purchase Order Record'
  then
   delete from strang.pos where rowid = chartorowid( detrid );
   commit;
   receive_po(surl,rid,scid,null,parm,access_id,recctr - 1,'Record Deleted',force_single_disp=>force_single_disp, popup=>popup );
  else
   receive_po(surl,rid,scid,null,parm,access_id,recctr,'Action Cancelled',force_single_disp=>force_single_disp, popup=>popup );
 end if;
exception when others then
 error_details( 'STRANGP', 'ACCEPT_DELETE_PO',null,null,errmsg=>sqlerrm,extdet=>'PARM:' || parm);
end accept_delete_po;

procedure accept_receive_po( num_entries in number, name_array in owa.vc_arr, value_array in owa.vc_arr, reserved in owa.vc_arr )
as

 cursor c2( rid rowid ) is select * from strang.receivals where rowid = rid;
 cursor c3( dlryno number, rno integer, rid rowid ) is select 'x' tot from strang.pos where recno = rno and deliveryno = dlryno and rowid <> rid;
 cursor c4( lname varchar2, inv varchar2 ) is select 'x' from strang.lov where lov_name = lname and code = inv;
 cursor c5( cde varchar2 ) is select to_number(cola) cola, colb from strang.lov where lov_name = 'GSTCODES' and code = cde;

 cursor c6( rid rowid ) is select * from strang.pos where rowid = rid;
 cursor c7( rid rowid ) is select max(recno)+1 mx from strang.pos where deliveryno = (select deliveryno from strang.pos where rowid = rid );
 cursor c8( rid rowid ) is select count('x') ctr from strang.pos where deliveryno = (select deliveryno from strang.pos where rowid = rid );

 c2rec    c2%ROWTYPE;
 c3rec    c3%ROWTYPE;
 c4rec    c4%ROWTYPE;
 c5rec    c5%ROWTYPE;
 c6rec    c6%ROWTYPE;
 c7rec    c7%ROWTYPE;
 c8rec    c8%ROWTYPE;
 ltype    varchar2(100);
 stype    integer;

 pv   number(8,3);
 pw   number(9,1);
 qt   number;
 itn  number(5,2);
 qte  number;
 am   number(9,2);
 tam  number(9,2);
 dc   number(9,2);
 gs   number(9,2);
 lno            integer;
 vmsg   varchar2(100);
 sts    varchar2(100);
 newrid   rowid;

surl 		varchar2(4000);
rid 		varchar2(100);
scid 		varchar2(100);
parm 		varchar2(100);
access_id 	varchar2(100);
recctr 		integer;
detrid 		varchar2(100);
p0 		varchar2(4000);
p1 		varchar2(4000);
p2 		varchar2(4000);
p2d 		varchar2(4000);
p3 		varchar2(4000);
p4 		varchar2(4000);
p5 		varchar2(4000);
p51 		varchar2(4000);
p52 		varchar2(4000);
p53		integer;
p53a 		integer;
pgrn 		number;
pgrni 		varchar2(4000);
d3 		varchar2(4000);
d4 		varchar2(4000);
d5 		varchar2(4000);
d6 		varchar2(4000);
d7 		varchar2(4000);
st 		varchar2(4000);
d6e 		varchar2(4000);
d7e 		varchar2(4000);
d8 		varchar2(4000);
d8a 		varchar2(4000);
s1 		number;
s4 		char(1);
cf 		char(1);
n11 		char(1);
s2 		varchar2(4000);
s3 		varchar2(4000);
s5 		varchar2(4000);
ss3 		number;
cancel 		varchar2(4000);
save_record 	varchar2(4000);
first_record 	varchar2(4000);
last_record 	varchar2(4000);
previous_record varchar2(4000);
next_record 	varchar2(4000);
insert_record 	varchar2(4000);
delete_record 	varchar2(4000);
copy_record 	varchar2(4000);
force_single_disp char(1);
popup		char(1);
ngrn		integer;
rec_suppid	integer; -- only update receival if not null, meaning populated from popup

begin
for j in name_array.first..name_array.last loop

 case upper(name_array(j))
  when 'SURL'			then surl 		:= value_array(j);
  when 'RID'			then rid 		:= value_array(j);
  when 'SCID'			then scid 		:= value_array(j);
  when 'PARM'			then parm 		:= value_array(j);
  when 'ACCESS_ID'		then access_id 		:= value_array(j);
  when 'RECCTR'			then recctr 		:= value_array(j);
  when 'DETRID'			then detrid 		:= value_array(j);
  when 'P0'			then p0 		:= value_array(j);
  when 'P1'			then p1 		:= value_array(j);
  when 'P2'			then p2 		:= value_array(j);
  when 'P2D'			then p2d 		:= value_array(j);
  when 'P3'			then p3 		:= value_array(j);
  when 'P4'			then p4 		:= value_array(j);
  when 'P5'			then p5 		:= value_array(j);
  when 'P51'			then p51 		:= value_array(j);
  when 'P52'			then p52 		:= value_array(j);
  when 'P53'			then p53 		:= gl.guess_number(value_array(j));
  when 'P53A'			then p53a 		:= gl.guess_number(value_array(j));
  when 'PGRN'			then pgrn 		:= gl.guess_number(value_array(j));
  when 'PGRNI'			then pgrni 		:= value_array(j);
  when 'D3'			then d3 		:= value_array(j);
  when 'D4'			then d4 		:= value_array(j);
  when 'D5'			then d5 		:= value_array(j);
  when 'D6'			then d6 		:= value_array(j);
  when 'D6E'			then d6e		:= value_array(j);
  when 'D7'			then d7 		:= value_array(j);
  when 'ST'			then st 		:= value_array(j);
  when 'D6E'			then d6e 		:= value_array(j);
  when 'D7E'			then d7e 		:= value_array(j);
  when 'D8'			then d8 		:= value_array(j);
  when 'D8A'			then d8a 		:= value_array(j);
  when 'CF'			then cf 		:= substr(value_array(j),1,1);
  when 'S1'			then s1 		:= gl.guess_number(value_array(j));
  when 'S2'			then s2 		:= value_array(j);
  when 'S3'			then s3 		:= value_array(j);
  when 'S4'			then s4 		:= substr(value_array(j),1,1);
  when 'S5'			then s5 		:= substr(value_array(j),1,30);
  when 'N11'			then n11 		:= substr(value_array(j),1,1);
  when 'CANCEL'			then cancel 		:= value_array(j);
  when 'CANCEL.X'		then cancel 		:= value_array(j);
  when 'SAVE_RECORD'		then save_record 	:= value_array(j);
  when 'SAVE_RECORD.X'		then save_record 	:= value_array(j);
  when 'FIRST_RECORD'		then first_record 	:= value_array(j);
  when 'FIRST_RECORD.X'		then first_record 	:= value_array(j);
  when 'LAST_RECORD.X'		then last_record 	:= value_array(j);
  when 'LAST_RECORD'		then last_record 	:= value_array(j);
  when 'PREVIOUS_RECORD'	then previous_record 	:= value_array(j);
  when 'PREVIOUS_RECORD.X'	then previous_record 	:= value_array(j);
  when 'NEXT_RECORD'		then next_record 	:= value_array(j);
  when 'NEXT_RECORD.X'		then next_record 	:= value_array(j);
  when 'INSERT_RECORD'		then insert_record 	:= value_array(j);
  when 'INSERT_RECORD.X'	then insert_record 	:= value_array(j);
  when 'DELETE_RECORD'		then delete_record 	:= value_array(j);
  when 'DELETE_RECORD.X'	then delete_record 	:= value_array(j);
  when 'COPY_RECORD'		then copy_record 	:= value_array(j);
  when 'COPY_RECORD.X'		then copy_record 	:= value_array(j);
  when 'FORCE_SINGLE_DISP'	then force_single_disp:= value_array(j);
  when 'POPUP'			then popup		:= value_array(j);
  when 'INTSUPPM'		then rec_suppid		:= gl.guess_number(value_array(j));
  else null;
end case;

end loop;

/*
[ ] If the user selected a from lookup a record where critical_flag = X, the status is automatically updated to 2, whether or not manual_grn is null.
[ ] If manual_grn is not null and critical_flag <> X , the status is automatically set to 1.
'N11',c3rec.manual_grn
Confirmed with Sallie that status is: pos.grn_status = NGRN

the status should be 0 not 2 as critical_flag<>'X'

When staying on the same record as in the above scenario,  I then  selected a different record from lookup, that did not have a critical_flag, the grn_status was not updated to reflect the latest situation.  That is it should have been changed to 0 as both critical_flag and manual_grn were null
*/
 -- s3 = grn_status
 if cf = 'X' then ngrn := 2; s3 := 2; end if;
 if n11 is not null and nvl(cf,'|') <> 'X' then ngrn := 1; s3 := 1; end if;
 if trim(cf) is null and n11 is null and s3 not in (2,3,4,7) then ngrn := 0; s3 := 0; pgrn := 0; end if; -- set 0 as critical_flag and manual_grn are null

 open c2( chartorowid( replace(rid,'~','+') ) );
 fetch c2 into c2rec;
 close c2;

 if cancel is not null
  then
   receive_po(surl,rid,scid,null,parm,access_id,1,null,force_single_disp=>force_single_disp, popup=>popup );
   return;
 elsif first_record is not null
  then
   receive_po(surl,rid,scid,null,parm,access_id,1,null,force_single_disp=>force_single_disp, popup=>popup );
   return;
 elsif previous_record is not null
  then
   receive_po(surl,rid,scid,null,parm,access_id,recctr - 1,null,force_single_disp=>force_single_disp, popup=>popup );
   return;
 elsif next_record is not null
  then
   receive_po(surl,rid,scid,null,parm,access_id,recctr + 1,null,force_single_disp=>force_single_disp, popup=>popup );
   return;
 elsif last_record is not null
  then
   open c8( chartorowid(detrid) );
   fetch c8 into c8rec;
   close c8;
   receive_po(surl,rid,scid,null,parm,access_id,c8rec.ctr,null,force_single_disp=>force_single_disp, popup=>popup );
   return;
 elsif insert_record is not null
  then
   receive_po(surl,rid,scid,null,parm,access_id,0,null,force_single_disp=>force_single_disp, popup=>popup );
   return;
 elsif copy_record is not null
  then
   open c6( chartorowid(detrid) );
   fetch c6 into c6rec;
   close c6;
   open c7( chartorowid(detrid) );
   fetch c7 into c7rec;
   close c7;
   ngrn := null;
   if upper(c6rec.critical_flag) = 'Y' then ngrn := 2; end if;
   if upper(c6rec.manual_grn) = 'Y' and upper(c6rec.critical_flag) = 'N' then ngrn := 1; end if;
   if upper(c6rec.manual_grn) = 'N' and upper(c6rec.critical_flag) = 'N' and upper(c6rec.po_pool_lookup) = 'Y' then ngrn := 0; end if;
   insert into strang.pos(recno,inventoryno,po,supinv,amount,qty,unit_unitused,excise_qty,excise_unit,ctry_countrycode,gstc_gstcode,gst,tamount,delivery_charge,deliveryno,po_item_no,
                          sap_delno, sap_delno_item,state,po_pool_lookup,manual_grn,critical_flag,
                          grn_status,grn) values
    (nvl(c7rec.mx,1),upper(c6rec.inventoryno),c6rec.po,c6rec.supinv,c6rec.amount,c6rec.qty,c6rec.unit_unitused,c6rec.excise_qty,c6rec.excise_unit,c6rec.ctry_countrycode,c6rec.gstc_gstcode,c6rec.gst,c6rec.tamount,c6rec.delivery_charge,c6rec.deliveryno,c6rec.po_item_no,
     c6rec.sap_delno,nvl(c6rec.sap_delno_item,c6rec.qty),c6rec.state,c6rec.po_pool_lookup,nvl(c6rec.manual_grn,'F'),nvl(cf,c6rec.critical_flag),
     ngrn,null)
    returning rowid into newrid; -- changed to null from decode(c2rec.cust_customer_id,1,0,null) as requested by Sallie
   commit;
   open c8( newrid );
   fetch c8 into c8rec;
   close c8;
   receive_po(surl,rid,scid,null,parm,access_id,c8rec.ctr,null,force_single_disp=>force_single_disp, popup=>popup );
   return;
 elsif delete_record is not null
  then
   confirm_delete_po(surl,rid,scid,detrid,parm,access_id,recctr,'Confirm Delete of Purchase',force_single_disp=>force_single_disp, popup=>popup  );
   return;
 end if;

 if not dapi.init( surl, 'STRANGP.ACCEPT_RECEIVE_PO', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'ACCEPT_RECEIVE_PO');
    return;
 end if;

 itn := to_number( p1 );
 lno := to_number( p51 );
 open c3( c2rec.deliveryno, itn, detrid );
 fetch c3 into c3rec;
 if c3%FOUND
  then
    close c3;
    receive_po(surl,rid,scid,null,parm,access_id,recctr,'This Record already exists' || ': ' || p1 || '-' || p2,force_single_disp=>force_single_disp, popup=>popup );
    return;
  end if;
  close c3;

  begin qt := to_number( d6 ); exception when others then receive_po(surl,rid,scid,null,parm,access_id,recctr,'Invalid Number Entered for Quantity' || ': ' || d6,force_single_disp=>force_single_disp, popup=>popup ); return; end;
  begin qte := to_number( d6e ); exception when others then receive_po(surl,rid,scid,null,parm,access_id,recctr,'Invalid Number Entered for Quantity' || ': ' || d6e,force_single_disp=>force_single_disp, popup=>popup ); return; end;
  begin am := to_number( d3 ); exception when others then receive_po(surl,rid,scid,null,parm,access_id,recctr,'Invalid Number Entered for Amount' || ': ' || d3,force_single_disp=>force_single_disp, popup=>popup ); return; end;
  begin tam := to_number( d8 ); exception when others then receive_po(surl,rid,scid,null,parm,access_id,recctr,'Invalid Number Entered for Total Amount' || ': ' || d8,force_single_disp=>force_single_disp, popup=>popup ); return; end;
  begin gs := to_number( d5 ); exception when others then receive_po(surl,rid,scid,null,parm,access_id,recctr,'Invalid Number Entered for GST' || ': ' || d5,force_single_disp=>force_single_disp, popup=>popup ); return; end;
  begin dc := to_number( nvl(d8a,'0.00') ); exception when others then receive_po(surl,rid,scid,null,parm,access_id,recctr,'Invalid Number Entered for Total Amount' || ': ' || d8a,force_single_disp=>force_single_disp, popup=>popup ); return; end;
  --begin ss3 := to_number( s3 ); exception when others then receive_po(surl,rid,scid,null,parm,access_id,recctr,'Invalid Number Entered for GRN Status' || ': ' || s3,force_single_disp=>force_single_disp, popup=>popup ); return; end;

  open c4( 'INVENT', p2 );
  fetch c4 into c4rec;
  /*
  -- Inventory Check currently disabled as requested by Strang
  if c4%NOTFOUND
   then
    close c4;
    receive_po(surl,rid,scid,null,parm,access_id,recctr,'Inventory Number does not exist: ' || p2 );
    return;
  end if;
  */
  close c4;

  if d7 is not null
   then
    open c4( 'UNITS', upper(d7) );
    fetch c4 into c4rec;
    -- Inventory Check currently disabled as requested by Strang
    if c4%NOTFOUND
     then
      close c4;
      receive_po(surl,rid,scid,null,parm,access_id,recctr,'Invalid Unit Entered',force_single_disp=>force_single_disp, popup=>popup );
      return;
    end if;
    close c4;
  end if;

  if am is null and tam is null and gs is null
   then

    -- Do not do any checking. Put in at the request of Sallie.
    NULL;

   else

    if gs is null and tam is null
     then
      open c5(d4);
      fetch c5 into c5rec;
      close c5;
      if c5rec.colb = 'No GST'
       then
        gs := c5rec.cola;
        tam := am;
      elsif c5rec.colb = 'Inc GST'
       then
        gs := c5rec.cola;
        tam := am;
        am := ((100 * tam) / (100 + nvl(gs,0) ));
        gs := am * (c5rec.cola/100);
      else
        gs := c5rec.cola;
        tam := am * (1 + (gs/100));
        gs := am * (c5rec.cola/100);
      end if;
     else
      if c5rec.colb = 'Inc GST'
       then
        vmsg := 'Warning: GST is inclusive. You should not specify GST';
      elsif c5rec.colb = 'No GST'
        then
         vmsg := 'Warning: GST is exempt. You should not specify GST';
      end if;
    end if;

    if am is null and tam is not null and gs is not null
     then
      open c5(d4);
      fetch c5 into c5rec;
      close c5;
      am := tam - nvl(gs,0);
      if c5rec.colb = 'Add GST'
       then
        vmsg := 'Warning: NET Amount Specified. You should specify Amount';
      end if;
     else
      -- removed as requested
      NULL;
      /*
      if c5rec.colb = 'Inc GST'
       then
        vmsg := 'Warning: GST is inclusive. You should not specify amount.';
      end if;
      */
    end if;

    if tam is null
     then
      open c5(d4);
      fetch c5 into c5rec;
      close c5;
      if c5rec.colb = 'No GST'
       then
        gs := c5rec.cola;
        tam := am;
      elsif c5rec.colb = 'Inc GST'
       then
        gs := c5rec.cola;
        tam := am;
        am := ((100 * tam) / (100 + nvl(gs,0) ));
        gs := am * (c5rec.cola/100);
      else
        gs := c5rec.cola;
        tam := am * (1 + (gs/100));
        gs := am * (c5rec.cola/100);
      end if;
      if c5rec.colb = 'Inc GST'
       then
        vmsg := 'Warning: GST is inclusive. You should specify Total Amount';
      elsif c5rec.colb = 'Add GST'
       then
        vmsg := 'Warning: NET Amount Specified. You should not specify Total Amount';
      end if;
    end if;

  end if; /* To: are all values null */

  if detrid is null
   then
    begin
        insert into strang.pos(deliveryno,recno,inventoryno,po,ctry_countrycode,
                               supinv,gstc_gstcode,gst,amount,tamount,delivery_charge,qty,unit_unitused,excise_qty,excise_unit,po_item_no,
                               off_site_receipt,
                               sap_delno,sap_delno_item,state,
                               sap_delno_qty,sap_delno_unit,
                               grn_status,grn_item,po_pool_lookup,manual_grn,grn,
                               shipping_text,critical_flag) values
            ( c2rec.deliveryno, to_number(p0), strang.f_sap_format(p2,'INVENTORYNO'),strang.f_sap_format(p3,'PO'),p4,
              p5,d4 ,gs,am,tam,dc,qt,upper(d7),qte,upper(d7e),lno,
              p52,
              strang.f_sap_format( to_char(p53),'DELIVERYNO'),strang.f_sap_format(pgrn,'GRN'),st,
              s1,p2d,
              s3,pgrni,s4,n11,null,
              s5,cf) returning rowid into newrid; -- note Sallie specified "grn should be set to null for all, which contradicts previously saying decode(c2rec.cust_customer_id,1,0,null)
    exception
      when others then
            receive_po(surl,rid,scid,null,parm,access_id,recctr,'Error on Insert into POS ' || ': ' || sqlerrm,force_single_disp=>force_single_disp, popup=>popup );
            return;
    end;
   else
    -- Update The Row
    begin
         update strang.pos
          set
 	   gstc_gstcode = d4,
 	   sap_delno = strang.f_sap_format(p53,'DELIVERYNO'),
 	   sap_delno_item = nvl(p53a,qt),
 	   sap_delno_qty = s1,
 	   sap_delno_unit = p2d,
 	   state = st,
           amount = am,
           ctry_countrycode = p4,
           delivery_charge = dc,
           excise_qty = qte,
           excise_unit = upper(d7e),
           gst = gs,
           inventoryno = strang.f_sap_format(p2,'INVENTORYNO'),
           po = strang.f_sap_format(p3,'PO'),
           po_item_no = lno,
           qty = qt,
           supinv = p5,
           tamount = tam ,
           unit_unitused = upper(d7),
           grn_status = s3,
           shipping_text = s5,
           critical_flag = cf,
           manual_grn = n11,
           grn = strang.f_sap_format(pgrn,'GRN')
       where rowid = chartorowid( detrid );
        exception
             when others then
              receive_po(surl,rid,scid,null,parm,access_id,recctr,'Error on Update' || ': ' || sqlerrm,force_single_disp=>force_single_disp, popup=>popup );
              return;
       end;
   end if;

 commit;
 if rec_suppid is not null
  then
   update strang.receivals set supplier_customer_id = rec_suppid where rowid = chartorowid( replace(rid,'~','+') );
 end if;

 if save_record is not null
  then
   if detrid is null
    then
     open c8( newrid );
     fetch c8 into c8rec;
     close c8;
     receive_po(surl,rid,scid,null,parm,access_id,c8rec.ctr,nvl(vmsg,'Record Saved'),force_single_disp=>force_single_disp, popup=>popup );
    else
     receive_po(surl,rid,scid,null,parm,access_id,recctr,nvl(vmsg,'Record Saved'),force_single_disp=>force_single_disp, popup=>popup );
   end if;
 end if;

exception when others then
 error_details( 'STRANGP', 'ACCEPT_RECEIVE_PO',null,null,errmsg=>sqlerrm,extdet=>'PARM:' || parm);
end accept_receive_po;

procedure movement(surl in varchar2, rid in varchar2, scid in varchar2, call_name in varchar2, parm in varchar2, access_id in varchar2 default null, msg in varchar2 default null, xtra1 in varchar2 default null, xtra2 in varchar2 default null, xtra3 in varchar2 default null, rows_show in integer default G_ROWS, norder in varchar2 default null, n_local in char default 'L', force_single_disp in char default 'F' )
as

 cursor c2(rid rowid) is select * from strang.movements where rowid = rid;
 cursor c2d(rid rowid) is
  select ship_id
       , complete
	   , container_type
	   , iso_container_type
	   , vgm
	   , tare
	   , dispatch_date
	   , departure
	   , arrival
	   , bol
	   , booking_ref
	   , move_description
	   , physical_pack
	   , computer_pack
  from   strang.movements
  where  rowid = rid
  ;

 cursor c2a(rid rowid, mtype varchar2, xtra1 varchar2, norder varchar2, n_local varchar2, xtra2 in varchar2, xtra3 in varchar2) is
  select m.rowid, m.*
  from strang.movements m
  where movement_type = mtype and
         io = decode(xtra1,'IN','I','OUT','O',io) and
        (
         (xtra2 = 'A') or
         (xtra2 = 'I' and local_ship_id is null) or
         (xtra2 = 'L' and local_ship_id is not null) or
         (substr(xtra2,1,1) = 'C' and consignee_location = substr(xtra2,2))
        ) and
        (
         (xtra3 = 'A') or
         (xtra3 <> 'A' and ship_id = to_number(xtra3))
        ) and
        (
         (norder = 'MOVEMENTA' and nvl(m.movement_no,' ') >= (select nvl(r.movement_no,' ') from strang.movements r where r.rowid = rid)) or
         (norder = 'MOVEMENTD' and nvl(m.movement_no,' ') <= (select nvl(r.movement_no,' ') from strang.movements r where r.rowid = rid)) or
         (norder = 'SEALA' and nvl(m.seal,' ') >= (select nvl(r.seal,' ') from strang.movements r where r.rowid = rid)) or
         (norder = 'SEALD' and nvl(m.seal,' ') <= (select nvl(r.seal,' ') from strang.movements r where r.rowid = rid)) or
         (norder = 'PACKINGA' and decode(nvl(m.complete,'Z'),'A',1,'W',2,'D',3,'F',4,'P',5,'S',6,'Z',9) >= (select decode(nvl(r.complete,'Z'),'A',1,'W',2,'D',3,'F',4,'P',5,'S',6,'Z',9) from strang.movements r where r.rowid = rid)) or
         (norder = 'PACKINGD' and decode(nvl(m.complete,'Z'),'A',1,'W',2,'D',3,'F',4,'P',5,'S',6,'Z',9) <= (select decode(nvl(r.complete,'Z'),'A',1,'W',2,'D',3,'F',4,'P',5,'S',6,'Z',9) from strang.movements r where r.rowid = rid))
        )
  order by decode( norder, 'MOVEMENTA', m.movement_no,
                           'MOVEMENTD', utl_raw.cast_to_varchar2(utl_raw.reverse(utl_raw.cast_to_raw(nvl(m.movement_no,' ')))),
                           'SEALA', m.seal,
                           'SEALD', utl_raw.cast_to_varchar2(utl_raw.reverse(utl_raw.cast_to_raw(nvl(m.seal,' ')))),
                           'PACKINGA', decode(m.complete,'A',1,'W',2,'D',3,'F',4,'P',5,'S',6),
                           'PACKINGD', decode(m.complete,'A',9,'W',8,'D',7,'F',6,'P',5,'S',4)
                  );

 cursor c6(cd varchar2, vste varchar2) is select description from strang.lov where lov_name = 'CONTROLS' and code = cd and cola = vste;
 cursor c3(shp integer) is select s.rowid,s.* from strang.ships_airway s where ship_id = shp;
 cursor c4(mvid varchar2) is select count('x') tot from strang.detailrs where movement_no = mvid;
 cursor c5 is select chargecode from strang.charges order by chargecode;
 --  and nvl(estarrive,sysdate) > add_months(sysdate,-2)

 c2rec		c2%ROWTYPE;
 c2drec		c2d%ROWTYPE;
 c3rec		c3%ROWTYPE;
 c4rec		c4%ROWTYPE;
 c6rec		c6%ROWTYPE;

 sts		varchar2(100);
 vaccess	varchar2(20);
 seclevel	varchar2(100);
 mf		varchar2(100);
 vste		varchar2(10);
 vsel		varchar2(100);
 vname		varchar2(100);
 url		varchar2(1000);
 ctr		integer;
 rctr		integer;
 last_rid	varchar2(100);

begin
 if not dapi.init( surl, 'STRANGP.MOVEMENT', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'MOVEMENT');
    return;
 end if;

 vste := customer_state(dapi.GLOBAL_ACCOUNT.acctid);

 seclevel := security_role( dapi.GLOBAL_ACCOUNT.acctid );
 vaccess := data_access( 'MOVEMENT' );

 if parm = 'CARGO'
  then
   main_title( 'Cargo Movement',helpid=>'STR07');
 elsif parm = 'CONMOV'
  then
   main_title( 'Consignment Movement',helpid=>'STR08');
 elsif parm = 'AIRWAY'
  then
   main_title( 'Air Freight Movement',helpid=>'STR09');
 elsif parm = 'CONVOY'
  then
   main_title( 'Convoy Movement',helpid=>'STR10');
 end if;
 htp.p( '<CENTER>' );
 if vaccess = 'NONE' then htp.bold( 'Access Denied' ); htp.htmlclose; return; end if;

 if access_id = 'z'
  then
   c2rec.complete := 'F';
   c2rec.dispatch_date := sysdate;
   if parm = 'CARGO'
    then
     open c6( 'CARGODEPARTLOC', vste );
     fetch c6 into c6rec;
     close c6;
     c2rec.departure := c6rec.description;
     open c6( 'CARGOARRIVELOC', vste );
     fetch c6 into c6rec;
     close c6;
     c2rec.arrival := c6rec.description;
     open c6( 'TARE_DEFAULT', vste );
     fetch c6 into c6rec;
     close c6;
     begin c2rec.tare := c6rec.description; exception when others then null; end;
     if msg = 'Insert New Movement as Copy' -- Insert New Movement as Copy
      then
       -- gl.dbg('Record: ' || replace(rid,'~','+'));
       open c2d(replace(rid,'~','+'));
       fetch c2d into c2drec;
       if c2d%FOUND
        then
         c2rec.ship_id := c2drec.ship_id;
         c2rec.complete := c2drec.complete;
         c2rec.container_type := c2drec.container_type;
         c2rec.iso_container_type := c2drec.iso_container_type;
         c2rec.vgm := c2drec.vgm;
         c2rec.tare := c2drec.tare;
         c2rec.dispatch_date := c2drec.dispatch_date;
         c2rec.departure := c2drec.departure;
         c2rec.arrival := c2drec.arrival;
         c2rec.bol := c2drec.bol;
         c2rec.booking_ref  := c2drec.booking_ref;
         c2rec.move_description := c2drec.move_description;
         c2rec.physical_pack := c2drec.physical_pack;
         c2rec.computer_pack := c2drec.computer_pack;
       end if;
       close c2d;
     end if;

   elsif parm = 'CONMOV'
    then
     open c6( 'CONDEPARTLOC', vste );
     fetch c6 into c6rec;
     close c6;
     c2rec.departure := c6rec.description;
     open c6( 'CONARRIVELOC', vste );
     fetch c6 into c6rec;
     close c6;
     c2rec.arrival := c6rec.description;
   elsif parm = 'AIRWAY'
    then
     open c6( 'AIRARRIVELOC', vste );
     fetch c6 into c6rec;
     close c6;
     c2rec.arrival := c6rec.description;
     open c6( 'AIRDEPARTLOC', vste );
     fetch c6 into c6rec;
     close c6;
     c2rec.departure := c6rec.description;
     open c6( 'AIRCHARGECODE', vste );
     fetch c6 into c6rec;
     close c6;
     c2rec.chargecode := c6rec.description;

   elsif parm = 'CONVOY'
    then
     -- add convoy here
     null;
   end if;

  else
   open c2(replace(rid,'~','+'));
   fetch c2 into c2rec;
   close c2;
   if (mf is not null) and (vaccess = 'EDIT') and (c2rec.complete in ('N','F'))
    then
     -- Check if the 'Controlling Office'. If not then Read Only Access
     if mf <> c2rec.controlling_office
      then
       vaccess := 'READ';
     end if;
   end if;

 end if;

 if FORCE_SINGLE_DISP = 'F'
  then
   htp.tableopen( cattributes=>'class="str1_table"' );
    if parm in ('CARGO','CONMOV')
     then
      htp.tablerowopen;
       htp.p( '<th class="str1_bg_left" colspan="6">' );
         htp.p( htf.bold('Inbount/Outbound Filter') || ' ' );
         htp.p( '<FORM ACTION="formc" METHOD="POST">' );
         htp.p( '<SELECT NAME="site" onChange="parent.location.href = this.options[this.selectedIndex].value;">' );
           if xtra1 = 'IN' then vsel := 'SELECTED'; else vsel := null; end if;
           htp.p( '<OPTION ' || vsel || ' VALUE="' || 'strangp.menu?surl=' || surl || '&rnd=' || to_char(sysdate,'ddddd') || '&mtype=' || parm || '&msearch=' || null || '&action=' || 'SEARCH' || '&rid=' || replace(rid,'+','~') || '&xtra1=IN' || '&xtra2=' || xtra2 || '&xtra3=' || xtra3 || '&rows_show=' || rows_show || '&norder=' || norder || '&n_local=' || n_local || '">' || 'Inbound' || '</OPTION>' );

           if xtra1 = 'OUT' then vsel := 'SELECTED'; else vsel := null; end if;
           htp.p( '<OPTION ' || vsel || ' VALUE="' || 'strangp.menu?surl=' || surl || '&rnd=' || to_char(sysdate,'ddddd') || '&mtype=' || parm || '&msearch=' || null || '&action=' || 'SEARCH' || '&rid=' || replace(rid,'+','~') || '&xtra1=OUT' || '&xtra2=' || xtra2 || '&xtra3=' || xtra3 || '&rows_show=' || rows_show || '&norder=' || norder || '&n_local=' || n_local || '">' || 'Outbound' || '</OPTION>' );

           if nvl(xtra1,'ALL') = 'ALL' then vsel := 'SELECTED'; else vsel := null; end if;
           htp.p( '<OPTION ' || vsel || ' VALUE="' || 'strangp.menu?surl=' || surl || '&rnd=' || to_char(sysdate,'ddddd') || '&mtype=' || parm || '&msearch=' || null || '&action=' || 'SEARCH' || '&rid=' || replace(rid,'+','~') || '&xtra1=ALL' || '&xtra2=' || xtra2 || '&xtra3=' || xtra3 || '&rows_show=' || rows_show || '&norder=' || norder || '&n_local=' || n_local || '">' || 'All' || '</OPTION>' );

         htp.p( '</SELECT>' );
         htp.p( '</FORM>' );
       htp.p( '</th>' );
       htp.p( '<th class="str1_bg_left" colspan="6">' );
         htp.p( htf.bold('Destination Filter') || ' ' );
         htp.p( '<FORM ACTION="formd" METHOD="POST">' );
         htp.p( '<SELECT NAME="site" onChange="parent.location.href = this.options[this.selectedIndex].value;">' );
           if xtra2 = 'A' then vsel := 'SELECTED'; else vsel := null; end if;
           htp.p( '<OPTION ' || vsel || ' VALUE="' || 'strangp.menu?surl=' || surl || '&rnd=' || to_char(sysdate,'ddddd') || '&mtype=' || parm || '&msearch=' || null || '&action=' || 'SEARCH' || '&rid=' || replace(rid,'+','~') || '&xtra1=' || xtra1 || '&xtra2=' || 'A' || '&xtra3=' || xtra3 || '&rows_show=' || rows_show || '&norder=' || norder || '&n_local=' || n_local || '">' || 'Show All' || '</OPTION>' );
           if xtra2 = 'I' then vsel := 'SELECTED'; else vsel := null; end if;
           htp.p( '<OPTION ' || vsel || ' VALUE="' || 'strangp.menu?surl=' || surl || '&rnd=' || to_char(sysdate,'ddddd') || '&mtype=' || parm || '&msearch=' || null || '&action=' || 'SEARCH' || '&rid=' || replace(rid,'+','~') || '&xtra1=' || xtra1 || '&xtra2=' || 'I' || '&xtra3=' || xtra3 || '&rows_show=' || rows_show || '&norder=' || norder || '&n_local=' || n_local || '">' || 'International' || '</OPTION>' );
           if xtra2 = 'L' then vsel := 'SELECTED'; else vsel := null; end if;
           htp.p( '<OPTION ' || vsel || ' VALUE="' || 'strangp.menu?surl=' || surl || '&rnd=' || to_char(sysdate,'ddddd') || '&mtype=' || parm || '&msearch=' || null || '&action=' || 'SEARCH' || '&rid=' || replace(rid,'+','~') || '&xtra1=' || xtra1 || '&xtra2=' || 'L' || '&xtra3=' || xtra3 || '&rows_show=' || rows_show || '&norder=' || norder || '&n_local=' || n_local || '">' || 'Local' || '</OPTION>' );
           for crec in (select distinct cola from strang.lov where lov_name = 'DELIVERY LOCATIONS' and cold = 'LOCATION' order by 1) loop
            if xtra2 = 'C' || crec.cola then vsel := 'SELECTED'; else vsel := null; end if;
            htp.p( '<OPTION ' || vsel || ' VALUE="' || 'strangp.menu?surl=' || surl || '&rnd=' || to_char(sysdate,'ddddd') || '&mtype=' || parm || '&msearch=' || null || '&action=' || 'SEARCH' || '&rid=' || replace(rid,'+','~') || '&xtra1=' || xtra1 || '&xtra2=' || 'C' || crec.cola || '&xtra3=' || xtra3 || '&rows_show=' || rows_show || '&norder=' || norder || '&n_local=' || n_local || '">' || crec.cola || '</OPTION>' );
           end loop;
         htp.p( '</SELECT>' );
         htp.p( '</FORM>' );
       htp.p( '</th>' );
       htp.p( '<th class="str1_bg_left" colspan="6">' );
         htp.p( htf.bold('Ship Filter') || ' ' );
         htp.p( '<FORM ACTION="forme" METHOD="POST">' );
         htp.p( '<SELECT NAME="site" onChange="parent.location.href = this.options[this.selectedIndex].value;">' );
           if xtra2 = 'A' then vsel := 'SELECTED'; else vsel := null; end if;
           htp.p( '<OPTION ' || vsel || ' VALUE="' || 'strangp.menu?surl=' || surl || '&rnd=' || to_char(sysdate,'ddddd') || '&mtype=' || parm || '&msearch=' || null || '&action=' || 'SEARCH' || '&rid=' || replace(rid,'+','~') || '&xtra1=' || xtra1 || '&xtra2=' || xtra2 || '&xtra3=' || 'A' || '&rows_show=' || rows_show || '&norder=' || norder || '&n_local=' || n_local || '">' || 'Show All' || '</OPTION>' );
           for crec in (select shipname || ' ' || voy sname,ship_id from strang.ships_airway order by 1) loop
            if xtra3 = to_char(crec.ship_id) then vsel := 'SELECTED'; else vsel := null; end if;
            htp.p( '<OPTION ' || vsel || ' VALUE="' || 'strangp.menu?surl=' || surl || '&rnd=' || to_char(sysdate,'ddddd') || '&mtype=' || parm || '&msearch=' || null || '&action=' || 'SEARCH' || '&rid=' || replace(rid,'+','~') || '&xtra1=' || xtra1 || '&xtra2=' || xtra2 || '&xtra3=' || crec.ship_id || '&rows_show=' || rows_show || '&norder=' || norder || '&n_local=' || n_local || '">' || crec.sname || '</OPTION>' );
           end loop;
         htp.p( '</SELECT>' );
         htp.p( '</FORM>' );
       htp.p( '</th>' );
       rctr := 0;
       for c2rec in c2a(replace(rid,'~','+'),parm,nvl(xtra1,'A'),nvl(norder,'MOVEMENTA'),nvl(n_local,'LA'),nvl(xtra2,'A'),nvl(xtra3,'A')) loop
        rctr := rctr + 1;
        if rctr > rows_show then exit; end if;
        last_rid := replace(c2rec.rowid,'~','+');
       end loop;
       search( surl, parm, last_rid, samerow=>TRUE, first_rid=>rid, xtra1=>xtra1, xtra2=>xtra2, xtra3=>xtra3, colspan=>'2', norder=>norder );
      htp.tablerowclose;
    end if;

    htp.tablerowopen;
     htp.tableheader( '&nbsp;',cattributes=>'class="str1_bg_left"');

     htp.tableheader( htf.bold('In/Outbound'),cattributes=>'class="str1_bg_left"');
     htp.p( '<th class="str1_bg_left">' );
     if parm = 'CARGO'
      then
       vname := 'Container';
     elsif parm = 'CONMOV'
      then
       vname := 'Consignment';
     elsif parm = 'AIRWAY'
      then
       vname := 'MAWB';
     elsif parm = 'CONVOY'
      then
       vname := 'Convoy';
     end if;
     if norder = 'MOVEMENTA'
      then
       htp.anchor2( 'strangp.movement?surl=' || surl || '&scid=' || scid || '&parm=' || parm || '&call_name=' || call_name || '&access_id=' || access_id || '&rid=' || rid || '&rows_show=' || rows_show || '&norder=MOVEMENTD' || '&n_local=' || n_local || '&xtra1=' || xtra1 || '&xtra2=' || xtra2, vname, ctarget=>'_top');
      else
       htp.anchor2( 'strangp.movement?surl=' || surl || '&scid=' || scid || '&parm=' || parm || '&call_name=' || call_name || '&access_id=' || access_id || '&rid=' || rid || '&rows_show=' || rows_show || '&norder=MOVEMENTA' || '&n_local=' || n_local || '&xtra1=' || xtra1 || '&xtra2=' || xtra2 , vname, ctarget=>'_top');
     end if;
      htp.p( '</td>' );
     if norder = 'SEALA'
      then
       htp.tableheader( htf.anchor2( 'strangp.movement?surl=' || surl || '&scid=' || scid || '&parm=' || parm || '&call_name=' || call_name || '&access_id=' || access_id || '&rid=' || rid || '&rows_show=' || rows_show || '&norder=SEALD' || '&n_local=' || n_local || '&xtra1=' || xtra1 || '&xtra2=' || xtra2, 'Seal', ctarget=>'_top'), cattributes=>'class="str1_bg_left"' );
      else
       htp.tableheader( htf.anchor2( 'strangp.movement?surl=' || surl || '&scid=' || scid || '&parm=' || parm || '&call_name=' || call_name || '&access_id=' || access_id || '&rid=' || rid || '&rows_show=' || rows_show || '&norder=SEALA' || '&n_local=' || n_local || '&xtra1=' || xtra1 || '&xtra2=' || xtra2, 'Seal', ctarget=>'_top'), cattributes=>'class="str1_bg_left"' );
     end if;

     htp.tableheader( htf.bold('Full/Empty'),cattributes=>'class="str1_bg_left"');
     htp.tableheader( htf.bold('ISO Container Type'),cattributes=>'class="str1_bg_left"');
     htp.tableheader( htf.bold('Current Location'),cattributes=>'class="str1_bg_left"');
     htp.tableheader( htf.bold('Destination'),cattributes=>'class="str1_bg_left"');
     htp.tableheader( htf.bold('Warehouse'),cattributes=>'class="str1_bg_left"');
     htp.tableheader( htf.bold('Urgency'),cattributes=>'class="str1_bg_left"');
     htp.tableheader( htf.bold('Overdimensional'),cattributes=>'class="str1_bg_left"');
     htp.tableheader( htf.bold('Int''l Ship ID'),cattributes=>'class="str1_bg_left"');
     htp.tableheader( htf.bold('Int''l Bill of Lading'),cattributes=>'class="str1_bg_left"');
     htp.tableheader( htf.bold('Ship and Voyage'),cattributes=>'class="str1_bg_left"');
     htp.tableheader( htf.bold('Local Ship ID'),cattributes=>'class="str1_bg_left"');
     htp.tableheader( htf.bold('Local BOL'),cattributes=>'class="str1_bg_left"');
     htp.tableheader( htf.bold('Local Ship'),cattributes=>'class="str1_bg_left"');
     htp.tableheader( htf.bold('Convoy'),cattributes=>'class="str1_bg_left"');
     htp.tableheader( htf.bold('Convoy Name'),cattributes=>'class="str1_bg_left"');
     htp.tableheader( htf.bold('Container'),cattributes=>'class="str1_bg_left"');

     if norder = 'PACKINGA'
      then
       htp.tableheader( htf.anchor2( 'strangp.movement?surl=' || surl || '&scid=' || scid || '&parm=' || parm || '&call_name=' || call_name || '&access_id=' || access_id || '&rid=' || rid || '&rows_show=' || rows_show || '&norder=PACKINGD' || '&n_local=' || n_local || '&xtra1=' || xtra1 || '&xtra2=' || xtra2 || '&xtra3=' || xtra3, 'Packing List', ctarget=>'_top'), cattributes=>'class="str1_bg_left"' );
      else
       htp.tableheader( htf.anchor2( 'strangp.movement?surl=' || surl || '&scid=' || scid || '&parm=' || parm || '&call_name=' || call_name || '&access_id=' || access_id || '&rid=' || rid || '&rows_show=' || rows_show || '&norder=PACKINGA' || '&n_local=' || n_local || '&xtra1=' || xtra1 || '&xtra2=' || xtra2 || '&xtra3=' || xtra3, 'Packing List', ctarget=>'_top'), cattributes=>'class="str1_bg_left"' );
     end if;
    htp.tablerowclose;

    ctr := 0;
    for c2rec in c2a(replace(rid,'~','+'),parm,nvl(xtra1,'A'),nvl(norder,'MOVEMENTA'),nvl(n_local,'LA'),nvl(xtra2,'A'),nvl(xtra3,'A')) loop
     ctr := ctr + 1;
     if ctr > rows_show then exit; end if;
     htp.tablerowopen;
      htp.tabledata( to_char(ctr), cattributes=>'class="str1_bg_left"');
      if c2rec.io = 'I'
       then
        htp.tabledata( 'Inbound', cattributes=>'class="str1_bg_left"');
      elsif c2rec.io = 'O'
       then
        htp.tabledata( 'Outbound', cattributes=>'class="str1_bg_left"');
      else
        htp.tabledata( c2rec.io, cattributes=>'class="str1_bg_left"');
      end if;
      htp.tabledata( htf.anchor('strangp.movement?surl=' || surl || '&scid=' || scid || '&parm=' || parm || '&call_name=' || call_name || '&access_id=' || access_id || '&rid=' || to_char(replace(c2rec.rowid,'+','~')) || '&rows_show=' || rows_show || '&norder=' || norder || '&n_local=' || n_local || '&force_single_disp=T' || '&xtra1=' || xtra1 || '&xtra2=' || xtra2 || '&xtra3=' || xtra3, c2rec.movement_no), cattributes=>'class="str1_bg_left"' );
      htp.tabledata( c2rec.seal, cattributes=>'class="str1_bg_left"');
      c3rec := null;
      open c3( c2rec.ship_id );
      fetch c3 into c3rec;
      close c3;
      htp.tabledata( c2rec.full_mt, cattributes=>'class="str1_bg_left"');
      htp.tabledata( c2rec.iso_container_type, cattributes=>'class="str1_bg_left"');
      htp.tabledata( c2rec.current_location, cattributes=>'class="str1_bg_left"');
      htp.tabledata( c2rec.consignee_location, cattributes=>'class="str1_bg_left"');
      htp.tabledata( c2rec.warehouse_destination, cattributes=>'class="str1_bg_left"');
      htp.tabledata( c2rec.urgency, cattributes=>'class="str1_bg_left"');
      htp.tabledata( c2rec.overdimensional, cattributes=>'class="str1_bg_left"');
      htp.tabledata( htf.anchor2( 'strangp.shp?surl=' || surl || '&rid=' || replace(rowidtochar(c3rec.rowid),'+','~') || '&parm=X' || parm || '&scid=' || scid || '&access_id=' || access_id,c2rec.ship_id,ctarget=>'_TOP' ), cattributes=>'class="str1_bg_left"');
      htp.tabledata( c2rec.bol, cattributes=>'class="str1_bg_left"');
      htp.tabledata( c3rec.shipname || c3rec.voy, cattributes=>'class="str1_bg_left"');
      htp.tabledata( c2rec.local_ship_id, cattributes=>'class="str1_bg_left"');
      htp.tabledata( c2rec.local_bol, cattributes=>'class="str1_bg_left"');
      c3rec := null;
      open c3( c2rec.local_ship_id );
      fetch c3 into c3rec;
      close c3;
      htp.tabledata( c3rec.shipname || c3rec.voy, cattributes=>'class="str1_bg_left"');
      htp.tabledata( c2rec.convoy_id, cattributes=>'class="str1_bg_left"');
      c3rec := null;
      open c3( c2rec.convoy_id );
      fetch c3 into c3rec;
      close c3;
      htp.tabledata( c3rec.shipname || c3rec.voy, cattributes=>'class="str1_bg_left"');
      htp.tabledata( c2rec.movement_no || ' ' || c2rec.seal, cattributes=>'class="str1_bg_left"');

      htp.p( '<td class="str1_bg_left">' );
      case c2rec.complete
       when 'F' then htp.p( 'INCOMPLETE' );
       when 'P' then htp.p( 'PACKING COMPLETE' );
       when 'A' then htp.p( 'ARRIVED AT PORT' );
       when 'D' then htp.p( 'DESPATCHED' );
       when 'W' then htp.p( 'AWAITING SHIPMENT');
       when 'S' then htp.p( 'SHIPPED');
       else htp.p( '&nbsp;' );
      end case;
      htp.p( '</td>' );
     htp.tablerowclose;
    end loop;

    htp.tableclose;

   if msg is not null
    then
     header_msg( msg );
   end if;

   --htp.bold('Trace M=' || force_single_disp || ':' || norder || '-' || n_local || '[' || xtra1 || '][' || nvl(xtra2,'A') || '][' || nvl(xtra3,'A') || '][' || rows_show || ']');
   htp.p( '</CENTER>' );
   htp.htmlclose;
   return;
 end if;

 htp.tableopen;
 htp.tablerowopen;
 htp.p( '<td class="str2_align_center">' );

 if vaccess = 'EDIT'
  then
   htp.formopen( 'strangp.accept_movement' );
   htp.formhidden( 'SURL', surl );
   htp.formhidden( 'SCID', scid );
   htp.formhidden( 'PARM', parm );
   htp.formhidden( 'ACCESS_ID', access_id );
   htp.formhidden( 'XTRA1', nvl(xtra1,'A') );
   htp.formhidden( 'XTRA2', nvl(xtra2,'A') );
   htp.formhidden( 'XTRA3', nvl(xtra3,'A') );
   htp.formhidden( 'NORDER', nvl(norder,'MOVEMENTA') );
   htp.formhidden( 'N_LOCAL', nvl(n_local,'LA') );

   if access_id = 'z'
    then
     htp.formhidden( 'RID', null );
    else
   htp.formhidden( 'RID', replace(rid,'~','+') );
   end if;
 end if;

 htp.tableopen( cattributes=>'class="str1_table"' );
  if mf <> c2rec.controlling_office and mf is not null
   then
    htp.tablerowopen;
     htp.tabledata( htf.bold('Controlling Office'),cattributes=>'class="str1_bg_left"');
     htp.tabledata( htf.bold(c2rec.controlling_office),cattributes=>'class="str1_bg_left"');
    htp.tablerowclose;
  end if;
  htp.tablerowopen;
   if parm = 'CARGO'
    then
     htp.tabledata( htf.bold('Container #'),cattributes=>'class="str1_bg_left"');
   elsif parm = 'CONMOV'
    then
     htp.tabledata( htf.bold('Consignment'),cattributes=>'class="str1_bg_left"');
   elsif parm = 'AIRWAY'
    then
     htp.tabledata( htf.bold('MAWB'),cattributes=>'class="str1_bg_left"');
   elsif parm = 'CONVOY'
    then
     htp.tabledata( htf.bold('Convoy'),cattributes=>'class="str1_bg_left"');
   end if;

   if access_id = 'z'
    then
     htp.tabledata( htf.formtext('P1',20,40,c2rec.movement_no),cattributes=>'class="str1_bg_left"');
    else
     htp.tabledata( htf.bold(c2rec.movement_no),cattributes=>'class="str1_bg_left"');
     if vaccess = 'EDIT' then htp.formhidden( 'P1', null ); end if;
   end if;

   htp.p( '<td class="str1_bg_left">' );
   if seclevel in ( 'LEVEL 8' )
    then
     htp.tabledata( '&nbsp;');
    else
     open c3( c2rec.ship_id );
     fetch c3 into c3rec;
     close c3;
     if parm = 'AIRWAY'
      then
       htp.anchor2( 'strangp.shp?surl=' || surl || '&rid=' || replace(rowidtochar(c3rec.rowid),'+','~') || '&parm=X' || parm || '&scid=' || scid || '&access_id=' || access_id,'Carrier and Flight',ctarget=>'NEWSHIP' );
      else
       htp.anchor2( 'strangp.shp?surl=' || surl || '&rid=' || replace(rowidtochar(c3rec.rowid),'+','~') || '&parm=X' || parm || '&scid=' || scid || '&access_id=' || access_id,'Ship and Voyage',ctarget=>'NEWSHIP' );
     end if;
   end if;
   htp.p( '</TD>' );
  htp.tablerowclose;

  if parm = 'CONVOY'
   then
    if vaccess = 'EDIT'
     then
      htp.tablerowopen;
/*
full_mt                            varchar2(10),
del_date                           date,
del_transport_company              varchar2(100),
del_truck_rego                     varchar2(10),
hb                                 varchar2(100),
container_park                     varchar2(100),
customs_auth_no                    varchar2(100),

snail_inspect                      date,
wharf_collect                      date,
aqis_depot                         varchar2(50),
aqis_clearance                     date,
offhired_date                      date,
cmt                                varchar2(4000),
owner                              varchar2(20),
consignee                          varchar2(50),
consignee_location                 varchar2(50),
docket_no                          varchar2(50),
receive_date                       date,
receive_location                   varchar2(50),
split                              char(1),
local_ship_id                      number(16),
local_bol                          varchar2(20),
--local_hb                           varchar2(20),
convoy_id                          number(16),
truck_id                           varchar2(20),
io                                 varchar2(1),
status                             varchar2(100),
urgency                            varchar2(100),
remark                             varchar2(100),
remark_detail                      varchar2(100),
current_location                   varchar2(100),
warehouse_destination              varchar2(20),
tabubil_yard_date                  date,
kiunga_wharf_date                  date,
otml_yard_date                     date,
berth4_date                        date,
international_wharf_date           date,
bige_date                          date,
brisbane_date                      date,
other_location_date                date,
set_point                          varchar2(20),
local_ship_discharge_date          date,
int_ship_discharge_date            date,
convoy_delivery_location           varchar2(50)
full_mt,del_date,del_transport_company,del_truck_rego,hb,container_park,customs_auth_no,
*/

      htp.tablerowopen;
       htp.tabledata( htf.bold('Full MT'),cattributes=>'class="str1_bg_left"');
       htp.tabledata( htf.formtext('CV40',10,10, html_format(c2rec.full_mt)),cattributes=>'class="str1_bg_left"');
      htp.tablerowclose;
      htp.tablerowopen;
       htp.tabledata( htf.bold('Del Date'),cattributes=>'class="str1_bg_left"');
       htp.tabledata( htf.formtext('CV41',30,30, to_char(c2rec.del_date,'DD-MON-YYYY HH24:MI')) || ' ' || htf.italic('DD-MON-YYYY HH24:MI'),cattributes=>'class="str1_bg_left"');
      htp.tablerowclose;
      htp.tablerowopen;
       htp.tabledata( htf.bold('Del Transport Company'),cattributes=>'class="str1_bg_left"');
       htp.tabledata( htf.formtext('CV42',100,100, html_format(c2rec.del_transport_company)),cattributes=>'class="str1_bg_left"');
      htp.tablerowclose;
      htp.tablerowopen;
       htp.tabledata( htf.bold('Del Truck Rego'),cattributes=>'class="str1_bg_left"');
       htp.tabledata( htf.formtext('CV43',10,10, html_format(c2rec.del_truck_rego)),cattributes=>'class="str1_bg_left"');
      htp.tablerowclose;
      htp.tablerowopen;
       htp.tabledata( htf.bold('HB'),cattributes=>'class="str1_bg_left"');
       htp.tabledata( htf.formtext('CV44',100,100, html_format(c2rec.hb)),cattributes=>'class="str1_bg_left"');
      htp.tablerowclose;
      htp.tablerowopen;
       htp.tabledata( htf.bold('Container Park'),cattributes=>'class="str1_bg_left"');
       htp.tabledata( htf.formtext('CV45',100,100, html_format(c2rec.container_park)),cattributes=>'class="str1_bg_left"');
      htp.tablerowclose;
      htp.tablerowopen;
       htp.tabledata( htf.bold('Customs Auth No'),cattributes=>'class="str1_bg_left"');
       htp.tabledata( htf.formtext('CV46',100,100, html_format(c2rec.customs_auth_no)),cattributes=>'class="str1_bg_left"');
      htp.tablerowclose;
      htp.tablerowopen;
       htp.tabledata( htf.bold('Snail Inspect'),cattributes=>'class="str1_bg_left"');
       htp.tabledata( htf.formtext('CV1',30,30, to_char(c2rec.snail_inspect,'DD-MON-YYYY HH24:MI')) || ' ' || htf.italic('DD-MON-YYYY HH24:MI'),cattributes=>'class="str1_bg_left"');
      htp.tablerowclose;
      htp.tablerowopen;
       htp.tabledata( htf.bold('Wharf Collection'),cattributes=>'class="str1_bg_left"');
       htp.tabledata( htf.formtext('CV2',30,30, to_char(c2rec.wharf_collect,'DD-MON-YYYY HH24:MI')) || ' ' || htf.italic('DD-MON-YYYY HH24:MI'),cattributes=>'class="str1_bg_left"');
      htp.tablerowclose;
      htp.tablerowopen;
       htp.tabledata( htf.bold('AQIS Depot'),cattributes=>'class="str1_bg_left"');
       htp.tabledata( htf.formtext('CV3',50,50, html_format(c2rec.aqis_depot)),cattributes=>'class="str1_bg_left"');
      htp.tablerowclose;
      htp.tablerowopen;
       htp.tabledata( htf.bold('AQIS Clearance'),cattributes=>'class="str1_bg_left"');
       htp.tabledata( htf.formtext('CV4',30,30, to_char(c2rec.aqis_clearance,'DD-MON-YYYY HH24:MI')) || ' ' || htf.italic('DD-MON-YYYY HH24:MI'),cattributes=>'class="str1_bg_left"');
      htp.tablerowclose;
      htp.tablerowopen;
       htp.tabledata( htf.bold('Offhired Date'),cattributes=>'class="str1_bg_left"');
       htp.tabledata( htf.formtext('CV5',30,30, to_char(c2rec.offhired_date,'DD-MON-YYYY HH24:MI')) || ' ' || htf.italic('DD-MON-YYYY HH24:MI'),cattributes=>'class="str1_bg_left"');
      htp.tablerowclose;
      htp.tablerowopen;
       htp.tabledata( htf.bold('Comments'),cattributes=>'class="str1_bg_left"');
       htp.tabledata( htf.formtext('CV6',60,4000, html_format(c2rec.cmt)),cattributes=>'class="str1_bg_left"');
      htp.tablerowclose;
      htp.tablerowopen;
       htp.tabledata( htf.bold('Owner'),cattributes=>'class="str1_bg_left"');
       htp.tabledata( htf.formtext('CV7',20,20, html_format(c2rec.owner)),cattributes=>'class="str1_bg_left"');
      htp.tablerowclose;
      htp.tablerowopen;
       htp.tabledata( htf.bold('Consignee'),cattributes=>'class="str1_bg_left"');
       htp.tabledata( htf.formtext('CV8',50,50, html_format(c2rec.consignee)),cattributes=>'class="str1_bg_left"');
      htp.tablerowclose;
      htp.tablerowopen;
       htp.tabledata( htf.bold('Consignee Location'),cattributes=>'class="str1_bg_left"');
       htp.tabledata( htf.formtext('CV9',50,50, html_format(c2rec.consignee_location)),cattributes=>'class="str1_bg_left"');
      htp.tablerowclose;
      htp.tablerowopen;
       htp.tabledata( htf.bold('Docket Number'),cattributes=>'class="str1_bg_left"');
       htp.tabledata( htf.formtext('CV10',50,50, html_format(c2rec.docket_no)),cattributes=>'class="str1_bg_left"');
      htp.tablerowclose;
--      htp.tablerowopen;
--       htp.tabledata( htf.bold('Receive Date'),cattributes=>'class="str1_bg_left"');
--       htp.tabledata( htf.formtext('CV11',30,30, to_char(c2rec.receive_date,'DD-MON-YYYY HH24:MI')) || ' ' || htf.italic('DD-MON-YYYY HH24:MI'),cattributes=>'class="str1_bg_left"');
--      htp.tablerowclose;
--      htp.tablerowopen;
--       htp.tabledata( htf.bold('Receive Location'),cattributes=>'class="str1_bg_left"');
--       htp.tabledata( htf.formtext('CV12',50,50, html_format(c2rec.receive_location)),cattributes=>'class="str1_bg_left"');
--      htp.tablerowclose;
      htp.tablerowopen;
       htp.tabledata( htf.bold('Split'),cattributes=>'class="str1_bg_left"');
       htp.tabledata( htf.formtext('CV13',1,1, c2rec.split),cattributes=>'class="str1_bg_left"');
      htp.tablerowclose;
      htp.tablerowopen;
       htp.tabledata( htf.bold('Local Ship Id'),cattributes=>'class="str1_bg_left"');
       if c2rec.local_ship_id is null
        then
         htp.tabledata( htf.formtext('CV14',10,10, html_format(c2rec.local_ship_id)),cattributes=>'class="str1_bg_left"');
        else
         url := 'strangp.convoy?surl=' || surl || '&vpk=' || c2rec.local_ship_id || '&ispopup=T';
         htp.tabledata( htf.formtext('CV14',10,10, html_format(c2rec.local_ship_id)) || ' ' || htf.anchor( 'javascript: window.open(''' || url || ''',''' || 'POPUPS' || ''',''height=' || '800' || ',width=' || '1600' || ',scrollbars=yes,resizable=yes'');void('''');', 'Convoy Details' ),cattributes=>'class="str1_bg_left"');
       end if;
      htp.tablerowclose;
      htp.tablerowopen;
       htp.tabledata( htf.bold('Local BOL'),cattributes=>'class="str1_bg_left"');
       htp.tabledata( htf.formtext('CV15',20,20, html_format(c2rec.local_bol)),cattributes=>'class="str1_bg_left"');
      htp.tablerowclose;
 --     htp.tablerowopen;
 --      htp.tabledata( htf.bold('Local HB'),cattributes=>'class="str1_bg_left"');
 --      htp.tabledata( htf.formtext('CV16',20,20, html_format(c2rec.local_hb)),cattributes=>'class="str1_bg_left"');
 --     htp.tablerowclose;
      htp.tablerowopen;
       htp.tabledata( htf.bold('Convoy Id'),cattributes=>'class="str1_bg_left"');
       htp.tabledata( htf.formtext('CV17',10,10, html_format(c2rec.convoy_id)),cattributes=>'class="str1_bg_left"');
      htp.tablerowclose;
      htp.tablerowopen;
       htp.tabledata( htf.bold('Truck Id'),cattributes=>'class="str1_bg_left"');
       htp.tabledata( htf.formtext('CV18',20,20, html_format(c2rec.truck_id)),cattributes=>'class="str1_bg_left"');
      htp.tablerowclose;
      htp.tablerowopen;
       htp.tabledata( htf.bold('IO'),cattributes=>'class="str1_bg_left"');
       htp.p( '<td class="str1_bg_left">' );
        htp.formselectopen( 'CV19' );
         if nvl(c2rec.io,'I') = 'I'
         then
          htp.formselectoption( 'Inbound', 'SELECTED', cattributes=>'VALUE="'|| 'I' ||'"');
          htp.formselectoption( 'Outbound', cattributes=>'VALUE="'|| 'O' ||'"');
         else
          htp.formselectoption( 'Inbound', cattributes=>'VALUE="'|| 'I' ||'"');
          htp.formselectoption( 'Outbound', 'SELECTED', cattributes=>'VALUE="'|| 'O' ||'"');
        end if;
        htp.formselectclose;
       htp.p( '</td>' );
      htp.tablerowclose;
      htp.tablerowopen;
       htp.tabledata( htf.bold('Status'),cattributes=>'class="str1_bg_left"');
       htp.tabledata( htf.formtext('CV20',50,100, html_format(c2rec.status)),cattributes=>'class="str1_bg_left"');
      htp.tablerowclose;
      htp.tablerowopen;
       htp.tabledata( htf.bold('Urgency'),cattributes=>'class="str1_bg_left"');
       htp.tabledata( htf.formtext('CV21',50,100, html_format(c2rec.urgency)),cattributes=>'class="str1_bg_left"');
      htp.tablerowclose;
      htp.tablerowopen;
       htp.tabledata( htf.bold('Remark'),cattributes=>'class="str1_bg_left"');
       htp.tabledata( htf.formtext('CV22',50,100, html_format(c2rec.remark)),cattributes=>'class="str1_bg_left"');
      htp.tablerowclose;
      htp.tablerowopen;
       htp.tabledata( htf.bold('Remark Detail'),cattributes=>'class="str1_bg_left"');
       htp.tabledata( htf.formtext('CV23',50,100, html_format(c2rec.remark_detail)),cattributes=>'class="str1_bg_left"');
      htp.tablerowclose;
      htp.tablerowopen;
       htp.tabledata( htf.bold('Current Location'),cattributes=>'class="str1_bg_left"');
       htp.tabledata( htf.formtext('CV24',50,100, html_format(c2rec.current_location)),cattributes=>'class="str1_bg_left"');
      htp.tablerowclose;
      htp.tablerowopen;
       htp.tabledata( htf.bold('Warehouse Destination'),cattributes=>'class="str1_bg_left"');
       htp.tabledata( htf.formtext('CV25',20,20, html_format(c2rec.warehouse_destination)),cattributes=>'class="str1_bg_left"');
      htp.tablerowclose;
      htp.tablerowopen;
       htp.tabledata( htf.bold('Tabubil Yard Date'),cattributes=>'class="str1_bg_left"');
       htp.tabledata( htf.formtext('CV26',30,30, to_char(c2rec.tabubil_yard_date,'DD-MON-YYYY HH24:MI')) || ' ' || htf.italic('DD-MON-YYYY HH24:MI'),cattributes=>'class="str1_bg_left"');
      htp.tablerowclose;
      htp.tablerowopen;
       htp.tabledata( htf.bold('Kiunga Wharf Date'),cattributes=>'class="str1_bg_left"');
       htp.tabledata( htf.formtext('CV27',30,30, to_char(c2rec.kiunga_wharf_date,'DD-MON-YYYY HH24:MI')) || ' ' || htf.italic('DD-MON-YYYY HH24:MI'),cattributes=>'class="str1_bg_left"');
      htp.tablerowclose;
      htp.tablerowopen;
       htp.tabledata( htf.bold('OTM Yard Date'),cattributes=>'class="str1_bg_left"');
       htp.tabledata( htf.formtext('CV28',30,30, to_char(c2rec.otml_yard_date,'DD-MON-YYYY HH24:MI')) || ' ' || htf.italic('DD-MON-YYYY HH24:MI'),cattributes=>'class="str1_bg_left"');
      htp.tablerowclose;
      htp.tablerowopen;
       htp.tabledata( htf.bold('Berth4 Date'),cattributes=>'class="str1_bg_left"');
       htp.tabledata( htf.formtext('CV29',30,30, to_char(c2rec.berth4_date,'DD-MON-YYYY HH24:MI')) || ' ' || htf.italic('DD-MON-YYYY HH24:MI'),cattributes=>'class="str1_bg_left"');
      htp.tablerowclose;
      htp.tablerowopen;
       htp.tabledata( htf.bold('International Wharf Date'),cattributes=>'class="str1_bg_left"');
       htp.tabledata( htf.formtext('CV30',30,30, to_char(c2rec.international_wharf_date,'DD-MON-YYYY HH24:MI')) || ' ' || htf.italic('DD-MON-YYYY HH24:MI'),cattributes=>'class="str1_bg_left"');
      htp.tablerowclose;
      htp.tablerowopen;
       htp.tabledata( htf.bold('BIGE Date'),cattributes=>'class="str1_bg_left"');
       htp.tabledata( htf.formtext('CV31',30,30, to_char(c2rec.bige_date,'DD-MON-YYYY HH24:MI')) || ' ' || htf.italic('DD-MON-YYYY HH24:MI'),cattributes=>'class="str1_bg_left"');
      htp.tablerowclose;
      htp.tablerowopen;
       htp.tabledata( htf.bold('Brisbane Date'),cattributes=>'class="str1_bg_left"');
       htp.tabledata( htf.formtext('CV32',30,30, to_char(c2rec.brisbane_date,'DD-MON-YYYY HH24:MI')) || ' ' || htf.italic('DD-MON-YYYY HH24:MI'),cattributes=>'class="str1_bg_left"');
      htp.tablerowclose;
      htp.tablerowopen;
       htp.tabledata( htf.bold('Other Location Date'),cattributes=>'class="str1_bg_left"');
       htp.tabledata( htf.formtext('CV33',30,30, to_char(c2rec.other_location_date,'DD-MON-YYYY HH24:MI')) || ' ' || htf.italic('DD-MON-YYYY HH24:MI'),cattributes=>'class="str1_bg_left"');
      htp.tablerowclose;
      htp.tablerowopen;
       htp.tabledata( htf.bold('Local Ship Discharge Date'),cattributes=>'class="str1_bg_left"');
       htp.tabledata( htf.formtext('CV35',30,30, to_char(c2rec.local_ship_discharge_date,'DD-MON-YYYY HH24:MI')) || ' ' || htf.italic('DD-MON-YYYY HH24:MI'),cattributes=>'class="str1_bg_left"');
      htp.tablerowclose;
      htp.tablerowopen;
       htp.tabledata( htf.bold('International Ship Discharge Date'),cattributes=>'class="str1_bg_left"');
       htp.tabledata( htf.formtext('CV36',30,30, to_char(c2rec.int_ship_discharge_date,'DD-MON-YYYY HH24:MI')) || ' ' || htf.italic('DD-MON-YYYY HH24:MI'),cattributes=>'class="str1_bg_left"');
      htp.tablerowclose;
      htp.tablerowopen;
       htp.tabledata( htf.bold('Set Point'),cattributes=>'class="str1_bg_left"');
       htp.tabledata( htf.formtext('CV37',20,20, html_format(c2rec.set_point)),cattributes=>'class="str1_bg_left"');
      htp.tablerowclose;
      htp.tablerowopen;
       htp.tabledata( htf.bold('Convoy Delivery Location'),cattributes=>'class="str1_bg_left"');
       htp.tabledata( htf.formtext('CV38',20,20, html_format(c2rec.convoy_delivery_location)),cattributes=>'class="str1_bg_left"');
      htp.tablerowclose;
     else
      htp.tablerowopen;

    end if;
  end if;

  htp.tablerowopen;
   if parm = 'CARGO'
    then
     htp.tabledata( htf.bold('Seal'),cattributes=>'class="str1_bg_left"');
     if vaccess = 'EDIT'
      then
       if access_id = 'z'
        then
         htp.tabledata( htf.formtext('P2',20,20,c2rec.seal),cattributes=>'class="str1_bg_left"');
        else
         htp.tabledata( htf.bold(c2rec.seal),cattributes=>'class="str1_bg_left"');
         htp.formhidden( 'P2', null );
       end if;
      else
       htp.tabledata( htf.bold(c2rec.seal),cattributes=>'class="str1_bg_left"');
     end if;
     htp.tabledata( '&nbsp;' );
   else
     htp.formhidden( 'P2', null );
   end if;
  htp.tablerowclose;

  htp.tablerowopen;
   if parm = 'CARGO'
    then
     htp.tabledata( htf.bold('Ship and Voyage'),cattributes=>'class="str1_bg_left"');
     htp.p( '<TD ' || 'class="str1_cell_left">' );
     if vaccess = 'EDIT' and nvl(c3rec.status,'INCOMPLETE') <> 'COMPLETE'
      then
       lov_ship( 'P3', 'S', c2rec.ship_id );
      else
       if vaccess = 'EDIT' then htp.formhidden( 'P3', c2rec.ship_id ); end if;
       lov_ship( 'P3', 'S', c2rec.ship_id, isedit=>FALSE );
     end if;
     htp.p( '</TD>' );
     if seclevel in ( 'LEVEL 1','LEVEL 6', 'LEVEL 8')
      then
       htp.tabledata( '&nbsp;');
      else
       htp.tabledata( htf.anchor2( 'strangp.edit_bol?surl=' || surl || '&rid=' || replace(rowidtochar(c3rec.rowid),'+','~') || '&rid2=' || replace(rowidtochar(rid),'+','~') || '&parm=' || parm || '&scid=' || scid || '&access_id=' || access_id || '&shpid=' || c2rec.ship_id,'Assign BOL',ctarget=>'NEWECN' ),cattributes=>'class="str1_bg_left"');
     end if;
   elsif parm = 'CONMOV'
    then
     htp.tabledata( htf.bold('Ship and Voyage'),cattributes=>'class="str1_bg_left"');
     htp.p( '<TD ' || 'class="str1_cell_left">' );
     if vaccess = 'EDIT' and nvl(c3rec.status,'INCOMPLETE') <> 'COMPLETE'
      then
       lov_ship( 'P3', 'S', c2rec.ship_id );
      else
       if vaccess = 'EDIT' then htp.formhidden( 'P3', c2rec.ship_id ); end if;
       lov_ship( 'P3', 'S', c2rec.ship_id, isedit=>FALSE );
     end if;
     htp.p( '</TD>' );
     if seclevel in ( 'LEVEL 1','LEVEL 6', 'LEVEL 8')
      then
       htp.tabledata( '&nbsp;');
      else
       htp.tabledata( htf.anchor2( 'strangp.edit_bol?surl=' || surl || '&rid=' || replace(rowidtochar(c3rec.rowid),'+','~') || '&rid2=' || replace(rowidtochar(rid),'+','~') || '&parm=' || parm || '&scid=' || scid || '&access_id=' || access_id || '&shpid=' || c2rec.ship_id,'Assign BOL',ctarget=>'NEWECN' ),cattributes=>'class="str1_bg_left"');
     end if;
   elsif parm = 'AIRWAY'
    then
     htp.tabledata( htf.bold('Carrier and Flight'),cattributes=>'class="str1_bg_left"');
     htp.p( '<TD ' || 'class="str1_cell_left">' );
     if vaccess = 'EDIT' and nvl(c3rec.status,'INCOMPLETE') <> 'COMPLETE'
      then
       lov_ship( 'P3', 'A', c2rec.ship_id );
      else
       if vaccess = 'EDIT' then htp.formhidden( 'P3', c2rec.ship_id ); end if;
       lov_ship( 'P3', 'A', c2rec.ship_id, isedit=>FALSE );
     end if;
     htp.p( '</TD>' );
     if seclevel in ( 'LEVEL 1','LEVEL 6', 'LEVEL 8')
      then
       htp.tabledata( '&nbsp;');
      else
       htp.tabledata( htf.anchor2( 'strangp.edit_mawb_ecn?surl=' || surl || '&rid=' || replace(rowidtochar(c3rec.rowid),'+','~') || '&parm=' || parm || '&scid=' || scid || '&access_id=' || access_id || '&mwb=' || c2rec.movement_no,'Assign ECN / Handling Unit',ctarget=>'NEWECN' ),cattributes=>'class="str1_bg_left"');
     end if;
   elsif parm = 'CONVOY'
    then
     htp.tabledata( htf.bold('Convoy'),cattributes=>'class="str1_bg_left"');
     htp.p( '<TD ' || 'class="str1_cell_left">' );
     if vaccess = 'EDIT' and nvl(c3rec.status,'INCOMPLETE') <> 'COMPLETE'
      then
       lov_ship( 'P3', 'C', c2rec.ship_id );
      else
       if vaccess = 'EDIT' then htp.formhidden( 'P3', c2rec.ship_id ); end if;
       lov_ship( 'P3', 'C', c2rec.ship_id, isedit=>FALSE );
     end if;
     htp.p( '</TD>' );
     if seclevel in ( 'LEVEL 1','LEVEL 6', 'LEVEL 8')
      then
       htp.tabledata( '&nbsp;');
      else
       htp.tabledata( htf.anchor2( 'strangp.edit_mawb_ecn?surl=' || surl || '&rid=' || replace(rowidtochar(c3rec.rowid),'+','~') || '&parm=' || parm || '&scid=' || scid || '&access_id=' || access_id || '&mwb=' || c2rec.movement_no,'Assign ECN / Handling Unit',ctarget=>'NEWECN' ),cattributes=>'class="str1_bg_left"');
     end if;
   end if;
  htp.tablerowclose;

  htp.tablerowopen;
   htp.tabledata( htf.bold('Packing List'),cattributes=>'class="str1_bg_left"');
   htp.p( '<TD ' || 'class="str1_cell_left">');
   if vaccess = 'EDIT'
    then
     htp.formselectopen( 'P4' );
     if c2rec.complete = 'F'
      then
       htp.formselectoption( 'INCOMPLETE', 'SELECTED', cattributes=>'VALUE="F"' );
      else
       htp.formselectoption( 'INCOMPLETE', cattributes=>'VALUE="F"' );
     end if;
     if c2rec.complete = 'P'
      then
       htp.formselectoption( 'PACKING COMPLETE', 'SELECTED', cattributes=>'VALUE="P"' );
      else
       htp.formselectoption( 'PACKING COMPLETE', cattributes=>'VALUE="P"' );
     end if;
     if c2rec.complete = 'A'
      then
       htp.formselectoption( 'ARRIVED AT PORT', 'SELECTED', cattributes=>'VALUE="A"' );
      else
       htp.formselectoption( 'ARRIVED AT PORT', cattributes=>'VALUE="A"' );
     end if;
     if c2rec.complete = 'D'
     then
       htp.formselectoption( 'DESPATCHED', 'SELECTED', cattributes=>'VALUE="D"' );
      else
       htp.formselectoption( 'DESPATCHED', cattributes=>'VALUE="D"' );
     end if;
     if c2rec.complete = 'W'
     then
       htp.formselectoption( 'AWAITING SHIPMENT', 'SELECTED', cattributes=>'VALUE="W"' );
      else
       htp.formselectoption( 'AWAITING SHIPMENT', cattributes=>'VALUE="W"' );
     end if;
     if c2rec.complete = 'S'
     then
       htp.formselectoption( 'SHIPPED', 'SELECTED', cattributes=>'VALUE="S"' );
      else
       htp.formselectoption( 'SHIPPED', cattributes=>'VALUE="S"' );
     end if;
   else
    if c2rec.complete = 'F' then htp.bold( 'INCOMPLETE' ); elsif c2rec.complete = 'P' then htp.bold( 'PACKING COMPLETE' ); elsif c2rec.complete = 'A' then htp.bold( 'ARRIVED AT PORT' ); else htp.bold( 'DESPATCHED' ); end if;
   end if;
   htp.p( '</TD>' );
   if seclevel in ( 'LEVEL 1','LEVEL 6', 'LEVEL 8')
    then
     htp.tabledata( '&nbsp;');
    else
     if parm in ('CARGO','CONMOV')
      then
       htp.tabledata( htf.anchor2( 'strangp.edit_ecn?surl=' || surl || '&rid=' || replace(rowidtochar(rid),'+','~') || '&rid2=' || '&parm=' || parm || '&scid=' || scid || '&access_id=' || access_id || '&shpid=' || c2rec.ship_id,'Assign ECN / Handling Unit',ctarget=>'NEWECN' ),cattributes=>'class="str1_bg_left"');
      else
       htp.tabledata( htf.anchor2( 'strangp.edit_mawb?surl=' || surl || '&rid=' || translate(rid,'+ ','~+') || '&parm=' || parm || '&scid=' || scid || '&access_id=' || access_id || '&mwb=' || c2rec.movement_no,'HAWB Values',ctarget=>'HAWB'),cattributes=>'class="str1_bg_left"');
     end if;
  end if;
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( htf.bold('Invoice'),cattributes=>'class="str1_bg_left"');
   htp.tabledata( htf.bold(c2rec.invoiceno),cattributes=>'class="str1_bg_left"');
   if vaccess = 'EDIT' then htp.tabledata( htf.anchor2( 'strangp.cascade_movement?surl=' || surl || '&rid=' || replace(rowidtochar(rid),'+','~') || '&parm=' || parm || '&scid=' || scid || '&access_id=' || access_id || '&oldid=' || c2rec.movement_no || '&oldseal=' || replace(c2rec.seal,' ','+') || '&mtype=' || parm,'Cascade Update' ),cattributes=>'class="str1_bg_left"'); end if;
  htp.tablerowclose;
 htp.tableclose;
 htp.nl;

 if parm = 'AIRWAY'
  then
   htp.tableopen( cattributes=>'class="str1_table"' );
     htp.tablerowopen;
      htp.tabledata( htf.bold('Carrier'),cattributes=>'class="str1_bg_left"');
      if vaccess = 'EDIT' and nvl(c3rec.status,'INCOMPLETE') <> 'COMPLETE'
       then
        htp.tabledata( htf.formtext('PX1',15,15,c2rec.carrier),cattributes=>'class="str1_bg_left"');
       else
        if vaccess = 'EDIT' then htp.formhidden( 'PX1', c2rec.carrier ); end if;
        htp.tabledata( c2rec.carrier,cattributes=>'class="str1_bg_left"');
      end if;
    htp.tablerowclose;
     htp.tablerowopen;
      htp.tabledata( htf.bold('Flight'),cattributes=>'class="str1_bg_left"');
      if vaccess = 'EDIT' and nvl(c3rec.status,'INCOMPLETE') <> 'COMPLETE'
       then
        htp.tabledata( htf.formtext('PX2',15,15,c2rec.flight),cattributes=>'class="str1_bg_left"');
       else
        if vaccess = 'EDIT' then htp.formhidden( 'PX2', c2rec.flight ); end if;
        htp.tabledata( c2rec.carrier,cattributes=>'class="str1_bg_left"');
      end if;
    htp.tablerowclose;
     htp.tablerowopen;
      htp.tabledata( htf.bold('Charge Code'),cattributes=>'class="str1_bg_left"');
      if vaccess = 'EDIT' and nvl(c3rec.status,'INCOMPLETE') <> 'COMPLETE'
       then
         htp.p( '<TD ' || 'class="str1_cell_left">' );
         htp.formselectopen( 'PX3' );
         for c5rec in c5 loop
          if c5rec.chargecode = c2rec.chargecode
           then
            htp.formselectoption( c5rec.chargecode, 'SELECTED' );
           else
            htp.formselectoption( c5rec.chargecode );
          end if;
         end loop;
         htp.formselectclose;
         htp.p( '</TD>' );
       else
        if vaccess = 'EDIT' then htp.formhidden( 'PX3', c2rec.chargecode ); end if;
        htp.tabledata( c2rec.chargecode,cattributes=>'class="str1_bg_left"');
      end if;
    htp.tablerowclose;
   htp.tableclose;
   htp.nl;
 else
  htp.formhidden( 'PX1',null);
  htp.formhidden( 'PX2',null);
  htp.formhidden( 'PX3',null);
 end if;

 htp.tableopen( cattributes=>'class="str1_table"' );
  if parm = 'CARGO'
   then
    htp.tablerowopen;
     htp.tabledata( htf.bold('Cargo Type'),cattributes=>'class="str1_bg_left"');
     if c2rec.complete = 'F'
      then
       htp.p( '<TD ' || 'class="str1_cell_left">' );
       if vaccess = 'EDIT'
        then
         lov_list( 'CTRTYPE', 'P5', nvl(c2rec.container_type,'GENERAL'), TRUE, FALSE, FALSE );
        else
         lov_list( 'CTRTYPE', 'P5', nvl(c2rec.container_type,'GENERAL'), TRUE, FALSE, FALSE, isedit=>FALSE );
       end if;
       htp.p( '</TD>' );
      else
       htp.tabledata( htf.bold( c2rec.container_type ),cattributes=>'class="str1_bg_left"');
       if vaccess = 'EDIT' then htp.formhidden( 'P5', c2rec.container_type ); end if;
     end if;
    htp.tablerowclose;
  else
   htp.formhidden( 'P5', null );
  end if;

  if parm = 'CARGO'
   then
    htp.tablerowopen;
     htp.tabledata( htf.bold('ISO Container Type'),cattributes=>'class="str1_bg_left"');
     if c2rec.complete = 'F'
      then
       htp.p( '<TD ' || 'class="str1_cell_left">' );
       if vaccess = 'EDIT'
        then
         lov_list( 'UNCTNTAB', 'P5i', nvl(c2rec.iso_container_type,'22G1'), TRUE, FALSE, FALSE );
        else
         lov_list( 'UNCTNTAB', 'P5i', nvl(c2rec.iso_container_type,'22G1'), TRUE, FALSE, FALSE, isedit=>FALSE );
       end if;
       htp.p( '</TD>' );
      else
       htp.tabledata( htf.bold( c2rec.iso_container_type ),cattributes=>'class="str1_bg_left"');
       if vaccess = 'EDIT' then htp.formhidden( 'P5i', c2rec.iso_container_type ); end if;
     end if;
    htp.tablerowclose;
  else
   htp.formhidden( 'P5i', null );
  end if;

  if parm = 'CARGO'
   then
    htp.tablerowopen;
     htp.tabledata( htf.bold('Verified Gross Mass (KG)'),cattributes=>'class="str1_bg_left"');
     if c2rec.complete = 'F' and vaccess = 'EDIT'
      then
       htp.tabledata( htf.formtext('P6i',15,20,to_char(c2rec.vgm)),cattributes=>'class="str1_bg_left"');
      else
       htp.tabledata( htf.bold(to_char(c2rec.vgm)),cattributes=>'class="str1_bg_left"');
       htp.formhidden( 'P6i', to_char(c2rec.vgm) );
     end if;
    htp.tablerowclose;
   else
    htp.formhidden( 'P6i', null );
  end if;


  if parm = 'CARGO'
   then
    htp.tablerowopen;
     htp.tabledata( htf.bold('Tare(Kg)'),cattributes=>'class="str1_bg_left"');
     if c2rec.complete = 'F' and vaccess = 'EDIT'
      then
       htp.tabledata( htf.formtext('P6',15,20,to_char(c2rec.tare)),cattributes=>'class="str1_bg_left"');
      else
       htp.tabledata( htf.bold(to_char(c2rec.tare)),cattributes=>'class="str1_bg_left"');
       htp.formhidden( 'P6', to_char(c2rec.tare) );
     end if;
    htp.tablerowclose;
   else
    htp.formhidden( 'P6', null );
  end if;

  if parm in ('CARGO','CONMOV')
   then
    htp.tablerowopen;
     htp.tabledata( htf.bold('Dispatch Date'),cattributes=>'class="str1_bg_left"');
     if c2rec.complete = 'F' and vaccess = 'EDIT'
      then
       htp.tabledata( htf.formtext('P7',15,20,to_char(c2rec.dispatch_date,LNG_MASK)),cattributes=>'class="str1_bg_left"');
      else
       htp.tabledata( htf.bold(to_char(c2rec.dispatch_date,LNG_MASK)),cattributes=>'class="str1_bg_left"');
       htp.formhidden( 'P7', to_char(c2rec.dispatch_date,LNG_MASK) );
     end if;
    htp.tablerowclose;
   else
    htp.tablerowopen;
     htp.tabledata( htf.bold('Flight Date'),cattributes=>'class="str1_bg_left"');
     if c2rec.complete = 'F' and vaccess = 'EDIT'
      then
       htp.tabledata( htf.formtext('P7',15,20,to_char(c2rec.dispatch_date,LNG_MASK)),cattributes=>'class="str1_bg_left"');
      else
       htp.tabledata( htf.bold(to_char(c2rec.dispatch_date,LNG_MASK)),cattributes=>'class="str1_bg_left"');
       htp.formhidden( 'P7', to_char(c2rec.dispatch_date,LNG_MASK));
     end if;
    htp.tablerowclose;
  end if;

  htp.tablerowopen;
   htp.tabledata( htf.bold('Departure Location'),cattributes=>'class="str1_bg_left"');
   if c2rec.complete = 'F' and vaccess = 'EDIT'
    then
     htp.p( '<TD ' || 'class="str1_cell_left">' );
     lov_list( 'LOCATIONS', 'P8', c2rec.departure, FALSE, TRUE, FALSE );
     htp.p( '</TD>' );
    else
       htp.tabledata( htf.bold(c2rec.departure),cattributes=>'class="str1_bg_left"');
       htp.formhidden( 'P8', c2rec.departure );
   end if;
  htp.tablerowclose;

  htp.tablerowopen;
   htp.tabledata( htf.bold('Arrival Location'),cattributes=>'class="str1_bg_left"');
   if c2rec.complete = 'F' and vaccess = 'EDIT'
    then
     htp.p( '<TD ' || 'class="str1_cell_left">' );
     lov_list( 'LOCATIONS', 'P9', c2rec.arrival, FALSE, TRUE, FALSE );
     htp.p( '</TD>' );
    else
       htp.tabledata( htf.bold(c2rec.arrival),cattributes=>'class="str1_bg_left"');
       htp.formhidden( 'P9', c2rec.arrival );
   end if;
  htp.tablerowclose;

  if parm in ('CARGO','CONMOV')
   then
    htp.tablerowopen;
     htp.tabledata( htf.bold('BOL'),cattributes=>'class="str1_bg_left"');
     if c2rec.complete = 'F' and vaccess = 'EDIT'
      then
       htp.tabledata( htf.formtext('P10',20,20,c2rec.bol),cattributes=>'class="str1_bg_left"');
      else
       htp.tabledata( htf.bold(c2rec.bol),cattributes=>'class="str1_bg_left"');
       htp.formhidden( 'P10', c2rec.bol );
     end if;
    htp.tablerowclose;
   else
    htp.formhidden( 'P10', null );
  end if;

  if parm in ('CARGO','CONMOV')
   then
    htp.tablerowopen;
     htp.tabledata( htf.bold('Booking Reference'),cattributes=>'class="str1_bg_left"');
     if c2rec.complete = 'F' and vaccess = 'EDIT'
      then
       htp.tabledata( htf.formtext('P10a',20,20,c2rec.booking_ref),cattributes=>'class="str1_bg_left"');
      else
       htp.tabledata( htf.bold(c2rec.booking_ref),cattributes=>'class="str1_bg_left"');
       htp.formhidden( 'P10a', c2rec.booking_ref );
     end if;
    htp.tablerowclose;
   else
    htp.formhidden( 'P10a', null );
  end if;

  htp.tablerowopen;
   htp.tabledata( htf.bold('Comments'),cattributes=>'class="str1_bg_left"');
   if c2rec.complete = 'F' and vaccess = 'EDIT'
    then
     htp.tabledata( htf.formtext('P11',70,100,c2rec.move_description),cattributes=>'class="str1_bg_left"');
    else
     htp.tabledata( htf.bold(c2rec.move_description),cattributes=>'class="str1_bg_left"');
     htp.formhidden( 'P11', c2rec.move_description );
   end if;
  htp.tablerowclose;

  htp.tablerowopen;
   htp.tabledata( htf.bold('Physical Packing Completed By'),cattributes=>'class="str1_bg_left"');
   if c2rec.complete = 'F' and vaccess = 'EDIT'
    then
     htp.tabledata( htf.formtext('PP',30,35,c2rec.physical_pack),cattributes=>'class="str1_bg_left"');
    else
     htp.tabledata( htf.bold(c2rec.physical_pack),cattributes=>'class="str1_bg_left"');
     htp.formhidden( 'PP', c2rec.physical_pack );
   end if;
  htp.tablerowclose;

  htp.tablerowopen;
   htp.tabledata( htf.bold('Computer Packing Completed By'),cattributes=>'class="str1_bg_left"');
   if c2rec.complete = 'F' and vaccess = 'EDIT'
    then
     htp.tabledata( htf.formtext('CP',30,35,c2rec.computer_pack),cattributes=>'class="str1_bg_left"');
    else
     htp.tabledata( htf.bold(c2rec.computer_pack),cattributes=>'class="str1_bg_left"');
     htp.formhidden( 'CP', c2rec.computer_pack );
   end if;
  htp.tablerowclose;


  if vaccess = 'EDIT'
  then
   if access_id = 'z'
    then
     if parm = 'CARGO'
      then
       htp.tablerowopen;
        htp.tabledata( htf.bold('Number of New Movements'),cattributes=>'class="str1_bg_left"');
        htp.tabledata( htf.formtext('P12',10,10,'1'),cattributes=>'class="str1_bg_left"');
       htp.tablerowclose;
      else
       htp.formhidden( 'P12', '1' );
     end if;
   end if;
  end if;

  htp.tableclose;

  htp.nl;
  url := 'strangp.assign_det?surl=' || surl || '&FL=T&rid=' || translate(rid,'+ ','~+') || '&scid=' || scid || '&parm=' || parm || '&access_id=' || access_id || '&ispopup=T';
  url := 'javascript: window.open(''' || url || ''',''' || 'ASSIGN' || ''',''height=' || '800' || ',width=' || '1000' || ',scrollbars=yes,resizable=yes'');void('''');';
  htp.anchor( url,'Packing List');
  if c2rec.complete <> 'F' and c2rec.movement_type = 'AIRWAY'
   then
     if seclevel in ( 'LEVEL 1','LEVEL 6', 'LEVEL 8')
      then
       NULL;
      else
       htp.anchor( 'strangp.assign_hawb?surl=' || surl || '&rid=' || translate(rid,'+ ','~+') || '&scid=' || scid || '&parm=' || parm || '&access_id=' || access_id, '[' || 'Generate HAWBs' || ']');
     end if;
  end if;
  htp.nl;
  htp.nl;
 htp.tableopen( cattributes=>'class="str1_table2"' );
  htp.tablerowopen;
   htp.tabledata( htf.bold('Weight'),cattributes=>'class="str1_bg_left"');
   htp.tabledata( htf.bold(to_char(c2rec.sumweight,G_STR_FRMT_04)),cattributes=>'class="str1_cell_right"');
   htp.tabledata( htf.bold('Volume'),cattributes=>'class="str1_bg_left"');
   htp.tabledata( htf.bold(to_char(c2rec.sumvolume,G_STR_FRMT_03)),cattributes=>'class="str1_cell_right"');
   htp.tabledata( htf.bold('Revenue Tonne'),cattributes=>'class="str1_bg_left"');
   htp.tabledata( htf.bold(to_char(c2rec.revton,G_STR_FRMT_03)),cattributes=>'class="str1_cell_right"');
   if parm = 'AIRWAY'
    then
     htp.tabledata( htf.bold('Chargeable Weight'),cattributes=>'class="str1_bg_left"');
     htp.tabledata( htf.bold(to_char(c2rec.chargeweight,G_STR_FRMT_04)),cattributes=>'class="str1_cell_right"');
   end if;
  htp.tablerowclose;
 htp.tableclose;

 htp.p( '</TD>' );
 htp.tablerowclose;
 htp.tableclose;

 htp.nl;
 htp.tableopen( cattributes=>'class="str1_table4"' );
 htp.tablerowopen;
 if vaccess = 'EDIT'
  then
   if access_id = 'z'
    then
     htp.tabledata( htf.formsubmit( 'ACTION', 'Insert New Movement' ),cattributes=>'VALIGN="TOP"');
     htp.tabledata( htf.formsubmit( 'ACTION', 'Insert New Convoy' ),cattributes=>'VALIGN="TOP"');
    else
     htp.tabledata( htf.formsubmit( 'ACTION', 'Update Movement' ),cattributes=>'VALIGN="TOP"');
     htp.tabledata( htf.formsubmit( 'ACTION', 'Insert New Movement' ),cattributes=>'VALIGN="TOP"');
     htp.tabledata( htf.formsubmit( 'ACTION', 'Insert New Convoy' ),cattributes=>'VALIGN="TOP"');
     if c2rec.complete not in ('S')
      then
         htp.tabledata( htf.formsubmit( 'ACTION', 'Insert New Movement as Copy' ),cattributes=>'VALIGN="TOP"');
     end if;
     open c4( c2rec.movement_no );
     fetch c4 into c4rec;
     close c4;
     if c4rec.tot = 0
      then
       htp.tabledata( htf.formsubmit( 'ACTION', 'Delete' ),cattributes=>'VALIGN="TOP"');
     end if;
   end if;
   htp.formclose;
 end if;
 search( surl, parm, rid, samerow=>TRUE );
 htp.tablerowclose;
 htp.tableclose;

 if msg is not null
  then
   header_msg( msg );
 end if;

 htp.p( '</CENTER>' );
 htp.htmlclose;
exception when others then
 error_details( 'STRANGP', 'MOVEMENT',null,null,errmsg=>sqlerrm,extdet=>'PARM:' || parm);
end movement;

procedure accept_movement( surl in varchar2, scid in integer, parm in varchar2, access_id in varchar2, rid in varchar2, action in varchar2,
                           p1 in varchar2, p2 in varchar2, p3 in varchar2, p4 in varchar2 default 'F', p5 in varchar2, p5i in varchar2, p6i in varchar2, p6 in varchar2, p7 in varchar2,
                           p8 in varchar2, p9 in varchar2, p10 in varchar2, p10a in varchar2, p11 in varchar2, p12 in varchar2 default '1',
                           px1 in varchar2, px2 in varchar2, px3 in varchar2, pp in varchar2, cp in varchar2,
                           cv1 in varchar2  default null, cv2 in  varchar2 default null, cv3 in  varchar2 default null, cv4 in  varchar2 default null, cv5 in  varchar2 default null, cv6 in  varchar2 default null, cv7  in varchar2 default null, cv8 in  varchar2 default null, cv9 in  varchar2 default null, cv10 in varchar2 default null,
                           cv11 in varchar2 default null, cv12 in varchar2 default null, cv13 in varchar2 default null, cv14 in varchar2 default null, cv15 in varchar2 default null, cv16 in varchar2 default null, cv17 in varchar2 default null, cv18 in varchar2 default null, cv19 in varchar2 default null, cv20 in varchar2 default null,
                           cv21 in varchar2 default null, cv22 in varchar2 default null, cv23 in varchar2 default null, cv24 in varchar2 default null, cv25 in varchar2 default null, cv26 in varchar2 default null, cv27 in varchar2 default null, cv28 in varchar2 default null, cv29 in varchar2 default null, cv30 in varchar2 default null,
                           cv31 in varchar2 default null, cv32 in varchar2 default null, cv33 in varchar2 default null, cv34 in varchar2 default null, cv35 in varchar2 default null, cv36 in varchar2 default null, cv37 in varchar2 default null, cv38 in varchar2 default null, cv39 in varchar2 default null, cv40 in varchar2 default null,
                           cv41 in varchar2 default null, cv42 in varchar2 default null, cv43 in varchar2 default null, cv44 in varchar2 default null, cv45 in varchar2 default null, cv46 in varchar2 default null, cv47 in varchar2 default null,
			   xtra1 in varchar2 default null, xtra2 in varchar2 default null, xtra3 in varchar2 default null, rows_show in integer default G_ROWS, norder in varchar2 default null, n_local in char default 'L', force_single_disp in char default 'F'
                          )
as

 cursor c1( mvid varchar2, mtype varchar2) is select 'x' from strang.movements where movement_no = mvid;
 cursor c2( mvid varchar2, sl varchar2, mtype varchar2) is select 'x' from strang.movements where movement_no = mvid and movement_type = mtype and nvl(seal,'|') = nvl(sl,'|');
 cursor c4( rid rowid ) is select movement_no,seal,ship_id from strang.movements where rowid = rid;
 cursor c5( mvid varchar2 ) is select 'x' from strang.movements where movement_no = mvid and movement_type in ('CONMOV','AIRWAY');
 cursor c6( ctrtyp varchar2) is select l.description from strang.lov l where l.lov_name='CTRTYPE' and l.code = ctrtyp; -- 20140907

 c1rec		c1%ROWTYPE;
 c2rec		c2%ROWTYPE;
 c4rec		c4%ROWTYPE;
 c5rec		c5%ROWTYPE;
 c6rec		c6%ROWTYPE; -- 20140907

 newrid		rowid;
 sts		varchar2(100);
 nmb1		integer;
 nmb2		integer;
 nmb3		integer;
 nmb14		integer;
 nmb17		integer;
 dt		date;
 dt1		date;
 dt2		date;
 dt4		date;
 dt5		date;
 dt11		date;
 dt26		date;
 dt27		date;
 dt28		date;
 dt29		date;
 dt30		date;
 dt31		date;
 dt32		date;
 dt33		date;
 dt35		date;
 dt36		date;
 dt41		date;
 mf		varchar2(100);
 vste		varchar2(10);
 p11x           varchar2(100);

begin
 if not dapi.init( surl, 'STRANGP.ACCEPT_MOVEMENT', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'ACCEPT_MOVEMENT');
    return;
 end if;

 vste := customer_state(dapi.GLOBAL_ACCOUNT.acctid);

 if action = 'Insert New Movement' and access_id <> 'z'
  then
   movement(surl,null,scid,null,parm,'z','Insert New Movement',xtra1=>xtra1,xtra2=>xtra2,xtra3=>xtra3,norder=>norder,n_local=>n_local);
   return;
 end if;
 if action = 'Insert New Convoy' and access_id <> 'z'
  then
   movement(surl,null,scid,null,'CONVOY','z','Insert New Convoy',xtra1=>xtra1,xtra2=>xtra2,xtra3=>xtra3,norder=>norder,n_local=>n_local);
   return;
 end if;

 if action in ('Insert New Movement as Copy') and access_id <> 'z' -- Insert New Movement as Copy
  then
   movement(surl,rid,scid,null,parm,'z',action,xtra1=>xtra1,xtra2=>xtra2,xtra3=>xtra3,norder=>norder,n_local=>n_local);
   return;
 end if;

 begin dt := to_date(p7,LNG_MASK); exception when others then movement( surl, rid, scid, null, parm, access_id, 'Invalid Date Entered' || ':' || p7 || ' ' || 'must be of format' || ':' || LNG_MASK,xtra1=>xtra1,xtra2=>xtra2,xtra3=>xtra3,norder=>norder,n_local=>n_local ); return; end;
 begin nmb1 := to_number(p6); exception when others then movement( surl, rid, scid, null, parm, access_id, 'Invalid Tare Entered' || ':' || p6 || ' ' || 'must be of format' || ':' || '999,999',xtra1=>xtra1,xtra2=>xtra2,xtra3=>xtra3,norder=>norder,n_local=>n_local ); return; end;
 begin nmb2 := to_number(p12); exception when others then nmb2 := 1; end;
 begin nmb3 := to_number(p6i); exception when others then movement( surl, rid, scid, null, parm, access_id, 'Verified Gross Mass:' || p6i || ' ' || 'must be of format' || ':' || '999,999',xtra1=>xtra1,xtra2=>xtra2,xtra3=>xtra3,norder=>norder,n_local=>n_local ); return; end;
 begin nmb14 := to_number(cv14); exception when others then movement( surl, rid, scid, null, parm, access_id, 'local_ship_id:' || cv14 || ' ' || 'must be of format' || ':' || '999,999',xtra1=>xtra1,xtra2=>xtra2,xtra3=>xtra3,norder=>norder,n_local=>n_local ); return; end;
 begin nmb17 := to_number(cv14); exception when others then movement( surl, rid, scid, null, parm, access_id, 'convoy_id:' || cv17 || ' ' || 'must be of format' || ':' || '999,999',xtra1=>xtra1,xtra2=>xtra2,xtra3=>xtra3,norder=>norder,n_local=>n_local ); return; end;

 begin dt1 := to_date(cv1,'DD-MON-YYYY HH24:MI'); exception when others then movement( surl, rid, scid, null, parm, access_id, 'Invalid Snail Inspect Date Entered' || ':' || cv1 || ' ' || 'must be of format' || ':' || LNG_MASK,xtra1=>xtra1,xtra2=>xtra2,xtra3=>xtra3,norder=>norder,n_local=>n_local ); return; end;
 begin dt2 := to_date(cv2,'DD-MON-YYYY HH24:MI'); exception when others then movement( surl, rid, scid, null, parm, access_id, 'Invalid Wharf Date Entered' || ':' || cv2 || ' ' || 'must be of format' || ':' || LNG_MASK,xtra1=>xtra1,xtra2=>xtra2,xtra3=>xtra3,norder=>norder,n_local=>n_local ); return; end;
 begin dt4 := to_date(cv4,'DD-MON-YYYY HH24:MI'); exception when others then movement( surl, rid, scid, null, parm, access_id, 'Invalid AQIS ClearanceDate Entered' || ':' || cv4 || ' ' || 'must be of format' || ':' || LNG_MASK,xtra1=>xtra1,xtra2=>xtra2,xtra3=>xtra3,norder=>norder,n_local=>n_local ); return; end;
 begin dt5 := to_date(cv5,'DD-MON-YYYY HH24:MI'); exception when others then movement( surl, rid, scid, null, parm, access_id, 'Invalid Offhired Date Entered' || ':' || cv5 || ' ' || 'must be of format' || ':' || LNG_MASK,xtra1=>xtra1,xtra2=>xtra2,xtra3=>xtra3,norder=>norder,n_local=>n_local ); return; end;
-- begin dt11 := to_date(cv11,'DD-MON-YYYY HH24:MI'); exception when others then movement( surl, rid, scid, null, parm, access_id, 'Invalid ReceiveDate Entered' || ':' || cv11 || ' ' || 'must be of format' || ':' || LNG_MASK,xtra1=>xtra1,xtra2=>xtra2,xtra3=>xtra3,norder=>norder,n_local=>n_local ); return; end;
 begin dt26 := to_date(cv26,'DD-MON-YYYY HH24:MI'); exception when others then movement( surl, rid, scid, null, parm, access_id, 'Invalid Tabubil YardDate Entered' || ':' || cv26 || ' ' || 'must be of format' || ':' || LNG_MASK,xtra1=>xtra1,xtra2=>xtra2,xtra3=>xtra3,norder=>norder,n_local=>n_local ); return; end;
 begin dt27 := to_date(cv27,'DD-MON-YYYY HH24:MI'); exception when others then movement( surl, rid, scid, null, parm, access_id, 'Invalid Kiunga WharfDate Entered' || ':' || cv27 || ' ' || 'must be of format' || ':' || LNG_MASK,xtra1=>xtra1,xtra2=>xtra2,xtra3=>xtra3,norder=>norder,n_local=>n_local ); return; end;
 begin dt28 := to_date(cv28,'DD-MON-YYYY HH24:MI'); exception when others then movement( surl, rid, scid, null, parm, access_id, 'Invalid OTM YardDate Entered' || ':' || cv28 || ' ' || 'must be of format' || ':' || LNG_MASK,xtra1=>xtra1,xtra2=>xtra2,xtra3=>xtra3,norder=>norder,n_local=>n_local ); return; end;
 begin dt29 := to_date(cv29,'DD-MON-YYYY HH24:MI'); exception when others then movement( surl, rid, scid, null, parm, access_id, 'Invalid Berth4Date Entered' || ':' || cv29 || ' ' || 'must be of format' || ':' || LNG_MASK,xtra1=>xtra1,xtra2=>xtra2,xtra3=>xtra3,norder=>norder,n_local=>n_local ); return; end;
 begin dt30 := to_date(cv30,'DD-MON-YYYY HH24:MI'); exception when others then movement( surl, rid, scid, null, parm, access_id, 'Invalid International WharfDate Entered' || ':' || cv30 || ' ' || 'must be of format' || ':' || LNG_MASK,xtra1=>xtra1,xtra2=>xtra2,xtra3=>xtra3,norder=>norder,n_local=>n_local ); return; end;
 begin dt31 := to_date(cv31,'DD-MON-YYYY HH24:MI'); exception when others then movement( surl, rid, scid, null, parm, access_id, 'Invalid BIGEDate Entered' || ':' || cv31 || ' ' || 'must be of format' || ':' || LNG_MASK,xtra1=>xtra1,xtra2=>xtra2,xtra3=>xtra3,norder=>norder,n_local=>n_local ); return; end;
 begin dt32 := to_date(cv32,'DD-MON-YYYY HH24:MI'); exception when others then movement( surl, rid, scid, null, parm, access_id, 'Invalid BrisbaneDate Entered' || ':' || cv32 || ' ' || 'must be of format' || ':' || LNG_MASK,xtra1=>xtra1,xtra2=>xtra2,xtra3=>xtra3,norder=>norder,n_local=>n_local ); return; end;
 begin dt33 := to_date(cv33,'DD-MON-YYYY HH24:MI'); exception when others then movement( surl, rid, scid, null, parm, access_id, 'Invalid Other LocationDate Entered' || ':' || cv33 || ' ' || 'must be of format' || ':' || LNG_MASK,xtra1=>xtra1,xtra2=>xtra2,xtra3=>xtra3,norder=>norder,n_local=>n_local ); return; end;
 begin dt35 := to_date(cv35,'DD-MON-YYYY HH24:MI'); exception when others then movement( surl, rid, scid, null, parm, access_id, 'Invalid Local Ship DischargeDate Entered' || ':' || cv35 || ' ' || 'must be of format' || ':' || LNG_MASK,xtra1=>xtra1,xtra2=>xtra2,xtra3=>xtra3,norder=>norder,n_local=>n_local ); return; end;
 begin dt36 := to_date(cv36,'DD-MON-YYYY HH24:MI'); exception when others then movement( surl, rid, scid, null, parm, access_id, 'Invalid International Ship Discharge Date Entered' || ':' || cv36 || ' ' || 'must be of format' || ':' || LNG_MASK,xtra1=>xtra1,xtra2=>xtra2,xtra3=>xtra3,norder=>norder,n_local=>n_local ); return; end;
 begin dt41 := to_date(cv41,'DD-MON-YYYY HH24:MI'); exception when others then movement( surl, rid, scid, null, parm, access_id, 'Invalid Del Date Entered' || ':' || cv41 || ' ' || 'must be of format' || ':' || LNG_MASK,xtra1=>xtra1,xtra2=>xtra2,xtra3=>xtra3,norder=>norder,n_local=>n_local ); return; end;

 if p1 is null and access_id = 'z'
  then
    movement( surl, rid, scid, null, parm, access_id, 'A Movement Number must be entered',xtra1=>xtra1,xtra2=>xtra2,xtra3=>xtra3,norder=>norder,n_local=>n_local);
    return;
 end if;

 if p2 is null and access_id = 'z' and parm = 'CARGO'
  then
    movement( surl, rid, scid, null, parm, access_id, 'A Cargo Seal must be entere',xtra1=>xtra1,xtra2=>xtra2,xtra3=>xtra3,norder=>norder,n_local=>n_local );
    return;
 end if;

 if action = 'Delete'
  then
   delete from strang.movements where rowid = chartorowid( rid );
   movement( surl, newrid, scid, null, parm, 'z', 'New Record Successfully Deleted',xtra1=>xtra1,xtra2=>xtra2,xtra3=>xtra3,norder=>norder,n_local=>n_local);
   return;
 end if;


 if access_id = 'z'
  then
   -- Check for Uniqueness
   if parm = 'CARGO'
    then
     open c5(p1);
     fetch c5 into c5rec;
     if c5%FOUND
      then
       close c5;
       movement( surl, rid, scid, null, parm, access_id, 'The Movement Number must be Unique. This value already exists',xtra1=>xtra1,xtra2=>xtra2,xtra3=>xtra3,norder=>norder,n_local=>n_local );
       return;
     end if;
     close c5;
     open c2(p1,p2,parm);
     fetch c2 into c2rec;
     if c2%FOUND
      then
       close c2;
       movement( surl, rid, scid, null, parm, access_id, 'The Movement Number and Seal must be Unique. This value already exists',xtra1=>xtra1,xtra2=>xtra2,xtra3=>xtra3,norder=>norder,n_local=>n_local );
       return;
     end if;
     close c2;
    else
     open c1(p1,parm);
     fetch c1 into c1rec;
     if c1%FOUND
      then
       close c1;
       movement( surl, rid, scid, null, parm, access_id, 'The Movement Number must be Unique. This value already exists',xtra1=>xtra1,xtra2=>xtra2,xtra3=>xtra3,norder=>norder,n_local=>n_local );
       return;
     end if;
     close c1;
   end if;
   mf := control_code( 'OFFICE', vste );
    p11x := p11;      -- 20140907
   if parm = 'CARGO' -- 20140907
    then
     open c6(p5);
     fetch c6 into c6rec;
     if p11x is null
      then
       p11x := c6rec.description;
      else
       if c6rec.description is not null and upper(p11x) not like '%' || upper(c6rec.description) || '%'
        then
         p11x := c6rec.description || ' / '|| p11x;
       end if;
     end if;
    close c6;
   end if;
  insert into strang.movements(movement_type,movement_no,seal,ship_id,complete,container_type, iso_container_type,vgm,tare,dispatch_date,departure,arrival,bol,
                               booking_ref, move_description,manifest_created,controlling_office,carrier,flight,chargecode, physical_pack, computer_pack,
                               full_mt,del_date,del_transport_company,del_truck_rego,hb,container_park,customs_auth_no,
                               snail_inspect,wharf_collect,aqis_depot,aqis_clearance,offhired_date,cmt,owner,consignee,consignee_location,docket_no,
                               split,local_ship_id,local_bol,convoy_id,truck_id,io,status,
                               urgency,remark,remark_detail,current_location,warehouse_destination,tabubil_yard_date,kiunga_wharf_date,otml_yard_date,berth4_date,international_wharf_date,
                               bige_date,brisbane_date,other_location_date,set_point,local_ship_discharge_date,int_ship_discharge_date,convoy_delivery_location
                              ) values
    (parm,decode(parm,'AIRWAY',p1,replace(p1,' ','')),p2,p3,p4,p5,p5i,nmb3,nmb1,dt,p8,p9,upper(p10),upper(p10a),
     p11x,mf,mf,px1,px2,px3,pp,cp,
     cv40,dt41,cv42,cv43,cv44,cv45,cv46,
     dt1,dt,cv3,dt4,dt5,cv6,cv7,cv8,cv9,cv10,
     cv13,nmb14,cv15,nmb17,cv18,cv19,cv20,
     cv21,cv22,cv23,cv24,cv25,dt26,dt27,dt28,dt29,dt30,
     dt31,dt32,dt33,dt35,dt36,cv37,cv38
     )
    returning rowid into newrid;
  else
   -- This call is used to extract the Ship Id and compare
   open c4( replace(rid,'~','+') );
   fetch c4 into c4rec;
   close c4;
   mf := control_code( 'OFFICE', vste );
   update strang.movements
    set
     ship_id = p3,
     complete = p4,
     container_type = p5,
     iso_container_type = p5i,
     vgm = nmb3,
     tare = nmb1,
     dispatch_date = dt,
     departure = p8,
     arrival = p9,
     bol = upper(p10),
     booking_ref = upper(p10a),
     move_description = p11,
     controlling_office = mf,
     carrier = px1,
     flight = px2,
     chargecode = px3,
     physical_pack = upper(pp),
     computer_pack = upper(cp),
     full_mt = 			     cv40,
     del_date = 		     dt41,
     del_transport_company = 	     cv42,
     del_truck_rego = 		     cv43,
     hb = 			     cv44,
     container_park = 		     cv45,
     customs_auth_no = 		     cv46,
     snail_inspect = 		     dt1,
     wharf_collect = 		     dt2,
     aqis_depot = 		     cv3,
     aqis_clearance = 		     dt4,
     offhired_date = 		     dt5,
     cmt = 			     cv6,
     owner = 			     cv7,
     consignee = 		     cv8,
     consignee_location = 	     cv9,
     docket_no = 		     cv10,
     split = 			     cv13,
     local_ship_id = 		     nmb14,
     local_bol = 		     cv15,
 --    local_hb = 		     cv16,
     convoy_id = 		     nmb17,
     truck_id = 		     cv18,
     io = 			     cv19,
     status = 			     cv20,
     urgency = 			     cv21,
     remark = 			     cv22,
     remark_detail = 		     cv23,
     current_location = 	     cv24,
     warehouse_destination = 	     cv25,
     tabubil_yard_date = 	     dt26,
     kiunga_wharf_date = 	     dt27,
     otml_yard_date = 		     dt28,
     berth4_date = 		     dt29,
     international_wharf_date =      dt30,
     bige_date = 		     dt31,
     brisbane_date = 		     dt32,
     other_location_date = 	     dt33,
     local_ship_discharge_date =     dt35,
     int_ship_discharge_date = 	     dt36,
     set_point = 		     cv37,
     convoy_delivery_location =      cv38,
     interface4_date = null
   where
    rowid = chartorowid( replace(rid,'~','+') );
    -- interface4_date set to null as requested by Sallie
  newrid := replace(rid,'~','+');
  -- Reset the Line No and Entry No to NULL if the SHIP_ID Changes
  if c4rec.ship_id <> p3
   then
    update strang.detailrs
     set
      line_no = NULL,
      entry_no = NULL
    where
     movement_no = c4rec.movement_no and
     nvl(camov_seal,'x') = nvl(c4rec.seal,'x');
  end if;
 end if;

 commit;
 open c4( newrid );
 fetch c4 into c4rec;
 close c4;

 recalc_weight(c4rec.movement_no,null,c4rec.seal);


 if parm = 'CARGO' and substr(p5,1,7)='HASTING' and nvl(p4,'F') in ('S','P')
  then
   generate_ost356( surl,c4rec.movement_no,c4rec.seal );
 end if;


 if access_id = 'z'
  then
   if nmb2 > 1
    then
     mass_movement( surl, newrid, scid, null, parm, 'x', nmb2, 'New Record Successfully Inserted' );
    else
     movement( surl, newrid, scid, null, parm, 'x', 'New Record Successfully Inserted',xtra1=>xtra1,xtra2=>xtra2,xtra3=>xtra3,norder=>norder,n_local=>n_local );
   end if;
  else
   movement( surl, rid, scid, null, parm, access_id, 'Record Successfully Updated',xtra1=>xtra1,xtra2=>xtra2,xtra3=>xtra3,norder=>norder,n_local=>n_local);
 end if;
exception when others then
 error_details( 'STRANGP', 'ACCEPT_MOVEMENT',null,null,errmsg=>sqlerrm,extdet=>'PARM:' || parm || '[' || xtra1 || '][' || xtra2 || '][' || norder || '][' || n_local || ']');
end accept_movement;

procedure mass_movement( surl in varchar2, rid in varchar2, scid in varchar2, call_name in varchar2, parm in varchar2, access_id in varchar2 default null, nmb in integer, msg in varchar2 default null )
as

 cursor c2(rid rowid) is select * from strang.movements where rowid = rid;


 c2rec		c2%ROWTYPE;

 sts		varchar2(100);
 vaccess	varchar2(20);

begin
 if not dapi.init( surl, 'STRANGP.MOVEMENT', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'MOVEMENT');
    return;
 end if;

 vaccess := data_access( 'MOVEMENT' );
 open c2(chartorowid(replace(rid,'~','+')));
 fetch c2 into c2rec;
 close c2;
 main_title( 'Mass Movement Entry',helpid=>'STR11');
 if msg is not null
  then
   header_msg( msg );
 end if;
 htp.p( '<CENTER>' );
 if vaccess = 'NONE' then htp.bold( 'Access Denied' ); htp.htmlclose; return; end if;

 htp.formopen( 'strangp.accept_mass_movement' );
 htp.formhidden( 'SURL', surl );
 htp.formhidden( 'RID', replace(rid,'~','+') );
 htp.formhidden( 'PARM', parm );
 htp.formhidden( 'SCID', scid );
 htp.formhidden( 'ACCESS_ID', access_id );

 htp.tableopen( cattributes=>'class="str1_table"' );
  htp.tablerowopen;
   htp.tabledata( '&nbsp;', cattributes=>'class="str1_bg_center"');
   htp.tabledata( htf.bold( 'Movement No'), cattributes=>'class="str1_bg_center"');
   htp.tabledata( htf.bold( 'Seal'), cattributes=>'class="str1_bg_center"');
   htp.tabledata( htf.bold( 'Tare(Kg)'), cattributes=>'class="str1_bg_center"');
   htp.tabledata( htf.bold( 'Delivery No'), cattributes=>'class="str1_bg_center"');
   htp.tabledata( htf.bold( 'Item No'), cattributes=>'class="str1_bg_center"');
  htp.tablerowclose;

  htp.tablerowopen;
   htp.formhidden( 'P1', c2rec.movement_no );
   htp.formhidden( 'P2', c2rec.seal );
   htp.formhidden( 'P5', c2rec.tare );
   htp.tabledata( '1', cattributes=>'class="str1_cell_right"');
   htp.tabledata( htf.bold( c2rec.movement_no ), cattributes=>'class="str1_cell_center"');
   htp.tabledata( htf.bold( c2rec.seal ), cattributes=>'class="str1_cell_center"');
   htp.tabledata( htf.bold( c2rec.tare ), cattributes=>'class="str1_cell_center"');
   htp.tabledata( htf.formtext( 'P3', 10, 20 ), cattributes=>'class="str1_cell_center"');
   htp.tabledata( htf.formtext( 'P4', 10, 20 ), cattributes=>'class="str1_cell_center"');
  htp.tablerowclose;
 for j in 1..(nmb-1) loop
  htp.tablerowopen;
   htp.tabledata( to_char(j+1), cattributes=>'class="str1_cell_right"');
   htp.tabledata( htf.formtext( 'P1', 10, 40, c2rec.movement_no ), cattributes=>'class="str1_cell_center"');
   htp.tabledata( htf.formtext( 'P2', 10, 40, c2rec.seal ), cattributes=>'class="str1_cell_center"');
   htp.tabledata( htf.formtext( 'P5', 10, 20, c2rec.tare ), cattributes=>'class="str1_cell_center"');
   htp.tabledata( htf.formtext( 'P3', 10, 20 ), cattributes=>'class="str1_cell_center"');
   htp.tabledata( htf.formtext( 'P4', 10, 20 ), cattributes=>'class="str1_cell_center"');
  htp.tablerowclose;
 end loop;

 htp.tableclose;
 htp.nl;
 htp.formsubmit( null, 'Insert New Movements' );
 htp.formclose;
 htp.htmlclose;
exception when others then
 error_details( 'STRANGP', 'MASS_MOVEMENT',null,null,errmsg=>sqlerrm,extdet=>'PARM:' || parm);
end mass_movement;

procedure accept_mass_movement( surl in varchar2, rid in varchar2, scid in varchar2, parm in varchar2, access_id in varchar2 default null, p1 in owa.vc_arr, p2 in owa.vc_arr, p3 in owa.vc_arr, p4 in owa.vc_arr, p5 in owa.vc_arr )
as

 cursor c1(mv varchar2, sl varchar2) is select 'x' cntr from strang.movements where nvl(movement_no,'|') = nvl(mv,'|') and nvl(seal,'|') = nvl(sl,'|');
 cursor c2(rid rowid) is select * from strang.movements where rowid = rid;

 c1rec		c1%ROWTYPE;
 c2rec		c2%ROWTYPE;

 sts		varchar2(100);
 nmb		number;
 dlr		number;
 tr		number;

begin
 if not dapi.init( surl, 'STRANGP.ACCEPT_MASS_MOVEMENT', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'ACCEPT_MASS_MOVEMENT');
    return;
 end if;

  open c2(chartorowid(replace(rid,'~','+')));
  fetch c2 into c2rec;
  close c2;

  for j in p1.first..p1.last loop
   begin nmb := to_number(p4(j)); exception when others then nmb := null; end;
   begin dlr := to_number(p3(j)); exception when others then dlr := null; end;
   begin tr := to_number(p5(j)); exception when others then tr := null; end;

   if j = 1
    then
     if dlr is not null
      then
       update strang.detailrs
        set
         movement_no = p1(j),
         camov_seal = p2(j)
        where deliveryno = dlr and
              itemno = nmb and
              cl = 'C' and
              sa = 'S' and
              movement_no is null and
              camov_seal is null;
       recalc_weight(p1(j),c2rec.container_type,p2(j),c2rec.movement_type);
     end if;

    else

     if p1(j) is not null
      then
       open c1(p1(j),p2(j));
       fetch c1 into c1rec;
       if c1%NOTFOUND
        then
         close c1;
         insert into strang.movements(invoiceno,movement_no,bol,movement_type,seal,container_type,move_description,
          complete,departure,arrival,dispatch_date,sumvolume,sumweight,revton,
	  iso_container_type, booking_ref, physical_pack, computer_pack,
          chargeweight,ship_id,manifest_created,controlling_office,tare) values
         (c2rec.invoiceno,p1(j),c2rec.bol,c2rec.movement_type,p2(j),c2rec.container_type,c2rec.move_description,
          c2rec.complete,c2rec.departure,c2rec.arrival,c2rec.dispatch_date,c2rec.sumvolume,c2rec.sumweight,c2rec.revton,
	  c2rec.iso_container_type, c2rec.booking_ref, c2rec.physical_pack, c2rec.computer_pack,
          c2rec.chargeweight,c2rec.ship_id,c2rec.manifest_created,c2rec.controlling_office,tr);
        else
         close c1;
       end if;
     end if;
     if dlr is not null
      then
       update strang.detailrs
        set
         movement_no = p1(j),
         camov_seal = p2(j)
        where deliveryno = dlr and
              itemno = nmb and
              cl = 'C' and
              sa = 'S' and
              movement_no is null and
              camov_seal is null;
       recalc_weight(p1(j),c2rec.container_type,p2(j),c2rec.movement_type);
     end if;
   end if;
  end loop;
  commit;
  movement( surl, rid, scid, null, parm, 'x', 'Records Successfully Inserted' );
exception when others then
 error_details( 'STRANGP', 'ACCEPT_MASS_MOVEMENT',null,null,errmsg=>sqlerrm,extdet=>'PARM:' || parm);
end accept_mass_movement;

function control_code( cd in varchar2, vste in varchar2 )
 return varchar2
as

 cursor c1( cd varchar2, vste varchar2 ) is select description from strang.lov where lov_name = 'CONTROLS' and code = cd and cola = vste;

 c1rec	c1%ROWTYPE;

begin
 open c1( cd, vste );
 fetch c1 into c1rec;
 close c1;
 return( c1rec.description );
exception
 when others
  then return( NULL );
end control_code;

procedure shp(surl in varchar2, rid in varchar2, scid in varchar2, parm in varchar2, access_id in varchar2 default null, msg in varchar2 default null, call_name in varchar2 default null, vdef in char default 'S', mtype in varchar2 default null, rows_show in integer default G_ROWS, norder in varchar2 default null, n_local in char default 'L', force_single_disp in char default 'F', xtra1 in varchar2 default 'ALL')
as

 cursor c2(rid rowid) is select * from strang.ships_airway where rowid = rid;
 cursor c2a(rid rowid, vcode varchar2, norder varchar2, n_local varchar2, xtra1 varchar2) is
  select s.rowid, s.*
  from strang.ships_airway s
  where ship_airway = nvl(vcode,ship_airway) and
         (
         (upper(xtra1) = 'IN' and s.io = 'I') or
         (upper(xtra1) = 'OUT' and s.io = 'O') or
         (upper(xtra1) = 'ALL' or xtra1 is null)
         ) and
        (
         (norder = 'SHIPNAMEA' and nvl(s.shipname,' ') >= (select nvl(shipname,' ') from strang.ships_airway r where r.rowid = rid)) or
         (norder = 'SHIPNAMED' and nvl(s.shipname,' ') <= (select nvl(shipname,' ') from strang.ships_airway r where r.rowid = rid)) or
         (norder = 'VOYA' and nvl(s.voy,' ') >= (select nvl(voy,' ') from strang.ships_airway r where r.rowid = rid)) or
         (norder = 'VOYD' and nvl(s.voy,' ') <= (select nvl(voy,' ') from strang.ships_airway r where r.rowid = rid)) or
         (norder = 'STATUSA' and nvl(s.status,' ') >= (select nvl(status,' ') from strang.ships_airway r where r.rowid = rid)) or
         (norder = 'STATUSD' and nvl(s.status,' ') <= (select nvl(status,' ') from strang.ships_airway r where r.rowid = rid)) or
         (norder = 'SHIPA' and nvl(s.sap_ship_id,0) >= (select nvl(sap_ship_id,0) from strang.ships_airway r where r.rowid = rid)) or
         (norder = 'SHIPD' and nvl(s.sap_ship_id,0) <= (select nvl(sap_ship_id,0) from strang.ships_airway r where r.rowid = rid)) or
         (norder = 'ESTDA' and nvl(s.estdepart,sysdate-999) >= (select nvl(estdepart,sysdate-999) from strang.ships_airway r where r.rowid = rid)) or
         (norder = 'ESTDD' and nvl(s.estdepart,sysdate-999) <= (select nvl(estdepart,sysdate-999) from strang.ships_airway r where r.rowid = rid)) or
         (norder = 'ESTAA' and nvl(s.estarrive,sysdate+999) >= (select nvl(estarrive,sysdate+999) from strang.ships_airway r where r.rowid = rid)) or
         (norder = 'ESTAD' and nvl(s.estarrive,sysdate+999) <= (select nvl(estarrive,sysdate+999) from strang.ships_airway r where r.rowid = rid)) or
         (norder = 'PORTLOADA' and nvl(s.portload,' ') >= (select nvl(portload,' ') from strang.ships_airway r where r.rowid = rid)) or
         (norder = 'PORTLOADD' and nvl(s.portload,' ') <= (select nvl(portload,' ') from strang.ships_airway r where r.rowid = rid)) or
         (norder = 'PORTDISCA' and nvl(s.portdisc,' ') >= (select nvl(portdisc,' ') from strang.ships_airway r where r.rowid = rid)) or
         (norder = 'PORTDISCD' and nvl(s.portdisc,' ') <= (select nvl(portdisc,' ') from strang.ships_airway r where r.rowid = rid)) or
         (norder is null)
        )
  order by decode( norder, 'SHIPNAMEA', s.shipname,
                           'SHIPNAMED', utl_raw.cast_to_varchar2(utl_raw.reverse(utl_raw.cast_to_raw(nvl(s.shipname,' ')))),
                           'VOYA', s.voy,
                           'VOYDD', utl_raw.cast_to_varchar2(utl_raw.reverse(utl_raw.cast_to_raw(nvl(s.voy,' ')))),
                           'STATUSA', s.status,
                           'STATUSD', utl_raw.cast_to_varchar2(utl_raw.reverse(utl_raw.cast_to_raw(nvl(s.status,' ')))),
                           'SHIPA', lpad(s.sap_ship_id,20,'0'),
                           'SHIPD', lpad((9999999999-s.sap_ship_id),20,'0'),
                           'ESTDA', to_char(s.estdepart,'YYYYMMDD'),
                           'ESTDD', lpad((9999999999-to_char(s.estdepart,'SSSSS')),20,'0'),
                           'ESTAA', to_char(s.estarrive,'YYYYMMDD'),
                           'ESTAD', lpad((9999999999-to_char(s.estarrive,'SSSSS')),20,'0'),
                           'PORTLOADA', s.portload,
                           'PORTLOADD', utl_raw.cast_to_varchar2(utl_raw.reverse(utl_raw.cast_to_raw(nvl(s.portload,' ')))),
                           'PORTDISCA', s.portdisc,
                           'PORTDISCD', utl_raw.cast_to_varchar2(utl_raw.reverse(utl_raw.cast_to_raw(nvl(s.portdisc,' '))))
                 );

 cursor c3(cname varchar2) is select customer_id from strang.customers where customer = cname and customer_type = 'AGENT';
 cursor c4(shid integer) is select count('x') tot from strang.movements where ship_id = shid;
 cursor c5(vshipid integer) is
  select 'x'
  from strang.movements m, strang.detailrs d
  where d.movement_no = m.movement_no and
        nvl(m.seal,'|') = nvl(d.camov_seal,'|') and
        d.entry_no is not null and
        m.ship_id = vshipid;
 cursor c6(vshipid integer) is select count(*) tot from strang.sads_by_ship_log where ship_id = vshipid;
 cursor c8(vname varchar2) is select * from strang.lov where lov_name = vname order by code;


 c2rec		c2%ROWTYPE;
 c3rec		c3%ROWTYPE;
 c4rec		c4%ROWTYPE;
 c5rec		c5%ROWTYPE;
 c6rec		c6%ROWTYPE;

 sts		varchar2(100);
 vaccess	varchar2(20);
-- vaccess2	varchar2(20); 20140529
 mf		varchar2(100);
 vste		varchar2(10);
 seclevel	varchar2(100);
 found_entry    boolean;
 url		varchar2(1000);
 ctr		integer;
 last_rid	varchar2(100);
 vsel		varchar2(100);

begin
 if not dapi.init( surl, 'STRANGP.SHP', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'SHP');
    return;
 end if;

 vste := customer_state(dapi.GLOBAL_ACCOUNT.acctid);
 vaccess := data_access( 'SHP' );

 mf := control_code( 'OFFICE', vste );
 seclevel := security_role( dapi.GLOBAL_ACCOUNT.acctid );
 main_title( 'Ship/Air/Convoy Management',helpid=>'STR12');

 htp.p( '<CENTER>' );
 htp.nl;

 if vaccess = 'NONE' then htp.bold( 'Access Denied' ); htp.htmlclose; return; end if;
 if access_id = 'z'
  then
   -- Populate with Default Values
--   begin c2rec.insurance   := control_code( 'CUSTOMS_INSURANCE', vste ); exception when others then null; end;
--   begin c2rec.vat         := control_code( 'CUSTOMS_VAT', vste ); exception when others then null; end;
--   begin c2rec.other_costs := control_code( 'CUSTOMS_OTHER_COSTS', vste ); exception when others then null; end;
--   begin c2rec.freight     := control_code( 'CUSTOMS_FREIGHT', vste ); exception when others then null; end;
--   begin c2rec.licence_no  := control_code( 'CUSTOMS_LICENCE_NO', vste ); exception when others then null; end;
--   begin c2rec.p2acode     := control_code( 'CUSTOMS_P2ACODE', vste ); exception when others then null; end;
--   begin c2rec.cpc         := control_code( 'CUSTOMS_CPC', vste ); exception when others then null; end;
--   begin c2rec.rate        := control_code( 'CUSTOMS_RATE', vste ); exception when others then null; end;
--   open c3( control_code( 'AGENTNAME', vste ));
--   fetch c3 into c3rec;
--   close c3;
--   begin c2rec.customs_agent  := c3rec.customer_id; exception when others then null; end;
   c2rec.status := 'INCOMPLETE';
   c2rec.ship_airway := vdef;
  else
   open c2(replace(rid,'~','+'));
   fetch c2 into c2rec;
   close c2;
   if (mf is not null) and (vaccess = 'EDIT') and (c2rec.status = 'INCOMPLETE')
    then
     -- Check if the 'Controlling Office'. If not then Read Only Access
     if (mf <> nvl(c2rec.controlling_office,mf)) -- and (vaccess2 = 'NONE') 20140529
      then
       if seclevel = 'LEVEL 7' then null; else vaccess := 'READ'; end if;
     end if;
   end if;
 end if;
 c2rec.status := nvl(c2rec.status,'INCOMPLETE');

 c2rec.sad_cuo_code := nvl(c2rec.sad_cuo_code,'POM');
 c2rec.sad_cuo_bord := nvl(c2rec.sad_cuo_bord,'POM');
 c2rec.sad_054_lop_cod := nvl(c2rec.sad_054_lop_cod,'PGPOM');
 c2rec.sad_057_loc_goods := nvl(c2rec.sad_057_loc_goods,'POM1');

 if FORCE_SINGLE_DISP = 'F'
  then
    ctr := 0;
    for c2rec in c2a(replace(rid,'~','+'),vdef,norder,n_local,xtra1) loop
     ctr := ctr + 1;
     if ctr > rows_show then exit; end if;
     last_rid := replace(c2rec.rowid,'~','+');
    end loop;
    htp.tableopen( cattributes=>'class="str1_table"' );
      htp.tablerowopen;
       htp.p( '<th class="str1_bg_left" colspan="2">' );
        htp.p('Filter');
      htp.p( '</th>' );
      htp.p('<th class="str1_bg_center" colspan="2">');
       htp.p( '<FORM ACTION="formc" METHOD="POST">' );
        htp.p( '<SELECT NAME="site" onChange="parent.location.href = this.options[this.selectedIndex].value;">' );
        if xtra1 = 'IN' then vsel := 'SELECTED'; else vsel := null; end if;
        htp.p( '<OPTION ' || vsel || ' VALUE="' || 'strangp.shp?surl=' || surl || '&scid=' || scid || '&parm=' || parm || '&call_name=' || call_name || '&access_id=' || access_id || '&mtype=' || mtype || '&rid=' || rid || '&rows_show=' || rows_show || '&norder=' || norder || '&n_local=' || n_local || '&vdef=' || vdef || '&xtra1=' || 'IN">' || 'Inbound' || '</OPTION>' );

        if xtra1 = 'OUT' then vsel := 'SELECTED'; else vsel := null; end if;
        htp.p( '<OPTION ' || vsel || ' VALUE="' || 'strangp.shp?surl=' || surl || '&scid=' || scid || '&parm=' || parm || '&call_name=' || call_name || '&access_id=' || access_id || '&mtype=' || mtype || '&rid=' || rid || '&rows_show=' || rows_show || '&norder=' || norder || '&n_local=' || n_local || '&vdef=' || vdef || '&xtra1=' || 'OUT">' || 'Outbound' || '</OPTION>' );

        if xtra1 = 'ALL' then vsel := 'SELECTED'; else vsel := null; end if;
        htp.p( '<OPTION ' || vsel || ' VALUE="' || 'strangp.shp?surl=' || surl || '&scid=' || scid || '&parm=' || parm || '&call_name=' || call_name || '&access_id=' || access_id || '&mtype=' || mtype || '&rid=' || rid || '&rows_show=' || rows_show || '&norder=' || norder || '&n_local=' || n_local || '&vdef=' || vdef || '&xtra1=' || 'ALL">' || 'All' || '</OPTION>' );

        htp.p( '</SELECT>' );
        htp.p( '</FORM>' );
       htp.p( '</th>' );
       htp.p('<th class="str1_bg_center" colspan="1">');
        htp.p( nvl(msg,'&nbsp;') );
       htp.p('</th>' );
       htp.p('<th class="str1_bg_center" colspan="4">');
       search( surl, 'SHIP_AIRWAY', last_rid, samerow=>FALSE, first_rid=>rid, xtra1=>xtra1, xtra2=>n_local, xtra3=>norder );
    if vaccess = 'EDIT'
     then
      htp.formopen( 'strangp.accept_shp_mass' );
      htp.formhidden( 'SURL', surl );
      htp.formhidden( 'SCID', scid );
      htp.formhidden( 'RID', rid );
      htp.formhidden( 'PARM', parm );
      htp.formhidden( 'ACCESS_ID', access_id );
      htp.formhidden( 'MTYPE', mtype );
      htp.formhidden( 'ROWS_SHOW', rows_show );
      htp.formhidden( 'NORDER', norder );
      htp.formhidden( 'N_LOCAL', n_local );
      htp.formhidden( 'FORCE_SINGLE_DISP', 'T' );
      htp.formhidden( 'XTRA1', xtra1 );
      if mtype = 'CONVOY'
       then
        htp.formhidden( 'P2', null ); -- now redundant
       else
        htp.formhidden( 'P1', null );
        htp.formhidden( 'P2', null );
        htp.formhidden( 'P3', null );
        htp.formhidden( 'P4', null );
      end if;
    end if;
       htp.p('</th>' );
       if mtype = 'CONVOY' and vaccess = 'EDIT'
        then
         htp.p('<th class="str1_bg_center" colspan="2">' || htf.formsubmit( 'ACTION', 'Modify') || '&nbsp;</th>');
         htp.p('<th class="str1_bg_center" colspan="2">' || htf.formsubmit( 'ACTION', 'Create New Convoy') || '&nbsp;</th>');
         --htp.p('<th class="str1_bg_center" colspan="1">' || '&nbsp;</th>');
       elsif mtype = 'CONVOY'
        then
         htp.p('<th class="str1_bg_center" colspan="7">&nbsp;</th>');
       end if;
      htp.tablerowclose;
    htp.tablerowopen;
     htp.tableheader( '&nbsp;',cattributes=>'class="str1_bg_left"');
     if mtype = 'CONVOY'
      then
       htp.tableheader( htf.bold('Convoy Id'));
      else
       htp.tableheader( htf.bold('Ship / Air'));
     end if;
     if mtype = 'CONVOY'
      then
       if norder = 'SHIPNAMEA'
        then
         htp.tableheader( htf.anchor2( 'strangp.shp?surl=' || surl || '&scid=' || scid || '&parm=' || parm || '&call_name=' || call_name || '&access_id=' || access_id || '&mtype=' || mtype || '&rid=' || rid || '&rows_show=' || rows_show || '&norder=SHIPNAMED' || '&n_local=' || n_local || '&vdef=' || vdef || '&xtra1=' || xtra1 , 'Convoy', ctarget=>'_top') );
        else
         htp.tableheader( htf.anchor2( 'strangp.shp?surl=' || surl || '&scid=' || scid || '&parm=' || parm || '&call_name=' || call_name || '&access_id=' || access_id || '&mtype=' || mtype || '&rid=' || rid || '&rows_show=' || rows_show || '&norder=SHIPNAMEA' || '&n_local=' || n_local || '&vdef=' || vdef || '&xtra1=' || xtra1 , 'Convoy	', ctarget=>'_top') );
       end if;
      else
       if norder = 'SHIPNAMEA'
        then
         htp.tableheader( htf.anchor2( 'strangp.shp?surl=' || surl || '&scid=' || scid || '&parm=' || parm || '&call_name=' || call_name || '&access_id=' || access_id || '&mtype=' || mtype || '&rid=' || rid || '&rows_show=' || rows_show || '&norder=SHIPNAMED' || '&n_local=' || n_local || '&vdef=' || vdef || '&xtra1=' || xtra1 , 'Ship Name / MAWB', ctarget=>'_top') );
        else
         htp.tableheader( htf.anchor2( 'strangp.shp?surl=' || surl || '&scid=' || scid || '&parm=' || parm || '&call_name=' || call_name || '&access_id=' || access_id || '&mtype=' || mtype || '&rid=' || rid || '&rows_show=' || rows_show || '&norder=SHIPNAMEA' || '&n_local=' || n_local || '&vdef=' || vdef || '&xtra1=' || xtra1 , 'Ship Name / MAWB', ctarget=>'_top') );
       end if;
     end if;
     if mtype = 'CONVOY'
      then
       if norder = 'VOYA'
        then
         htp.tableheader( htf.anchor2( 'strangp.shp?surl=' || surl || '&scid=' || scid || '&parm=' || parm || '&call_name=' || call_name || '&access_id=' || access_id || '&mtype=' || mtype || '&rid=' || rid || '&rows_show=' || rows_show || '&norder=VOYD' || '&n_local=' || n_local || '&vdef=' || vdef || '&xtra1=' || xtra1 , 'Convoy Subname', ctarget=>'_top') );
        else
         htp.tableheader( htf.anchor2( 'strangp.shp?surl=' || surl || '&scid=' || scid || '&parm=' || parm || '&call_name=' || call_name || '&access_id=' || access_id || '&mtype=' || mtype || '&rid=' || rid || '&rows_show=' || rows_show || '&norder=VOYA' || '&n_local=' || n_local || '&vdef=' || vdef || '&xtra1=' || xtra1 , 'Convoy Subname', ctarget=>'_top') );
       end if;
      else
       if norder = 'VOYA'
        then
         htp.tableheader( htf.anchor2( 'strangp.shp?surl=' || surl || '&scid=' || scid || '&parm=' || parm || '&call_name=' || call_name || '&access_id=' || access_id || '&mtype=' || mtype || '&rid=' || rid || '&rows_show=' || rows_show || '&norder=VOYD' || '&n_local=' || n_local || '&vdef=' || vdef || '&xtra1=' || xtra1 , 'Voyage/Flight', ctarget=>'_top') );
        else
         htp.tableheader( htf.anchor2( 'strangp.shp?surl=' || surl || '&scid=' || scid || '&parm=' || parm || '&call_name=' || call_name || '&access_id=' || access_id || '&mtype=' || mtype || '&rid=' || rid || '&rows_show=' || rows_show || '&norder=VOYA' || '&n_local=' || n_local || '&vdef=' || vdef || '&xtra1=' || xtra1 , 'Voyage/Flight', ctarget=>'_top') );
       end if;
       if norder = 'SHIPA'
        then
         htp.tableheader( htf.anchor2( 'strangp.shp?surl=' || surl || '&scid=' || scid || '&parm=' || parm || '&call_name=' || call_name || '&access_id=' || access_id || '&mtype=' || mtype || '&rid=' || rid || '&rows_show=' || rows_show || '&norder=SHIPD' || '&n_local=' || n_local || '&vdef=' || vdef || '&xtra1=' || xtra1 , 'OTML Ship Number', ctarget=>'_top') );
        else
         htp.tableheader( htf.anchor2( 'strangp.shp?surl=' || surl || '&scid=' || scid || '&parm=' || parm || '&call_name=' || call_name || '&access_id=' || access_id || '&mtype=' || mtype || '&rid=' || rid || '&rows_show=' || rows_show || '&norder=SHIPA' || '&n_local=' || n_local || '&vdef=' || vdef || '&xtra1=' || xtra1 , 'OTML Ship Number', ctarget=>'_top') );
       end if;
     end if;
     if norder = 'ESTDA'
      then
       htp.tableheader( htf.anchor2( 'strangp.shp?surl=' || surl || '&scid=' || scid || '&parm=' || parm || '&call_name=' || call_name || '&access_id=' || access_id || '&mtype=' || mtype || '&rid=' || rid || '&rows_show=' || rows_show || '&norder=ESTDD' || '&n_local=' || n_local || '&vdef=' || vdef || '&xtra1=' || xtra1 , 'Est Dept', ctarget=>'_top') );
      else
       htp.tableheader( htf.anchor2( 'strangp.shp?surl=' || surl || '&scid=' || scid || '&parm=' || parm || '&call_name=' || call_name || '&access_id=' || access_id || '&mtype=' || mtype || '&rid=' || rid || '&rows_show=' || rows_show || '&norder=ESTDA' || '&n_local=' || n_local || '&vdef=' || vdef || '&xtra1=' || xtra1 , 'Est Dept', ctarget=>'_top') );
     end if;
     if norder = 'ESTAA'
      then
       htp.tableheader( htf.anchor2( 'strangp.shp?surl=' || surl || '&scid=' || scid || '&parm=' || parm || '&call_name=' || call_name || '&access_id=' || access_id || '&mtype=' || mtype || '&rid=' || rid || '&rows_show=' || rows_show || '&norder=ESTAD' || '&n_local=' || n_local || '&vdef=' || vdef || '&xtra1=' || xtra1 , 'Est Arr', ctarget=>'_top') );
      else
       htp.tableheader( htf.anchor2( 'strangp.shp?surl=' || surl || '&scid=' || scid || '&parm=' || parm || '&call_name=' || call_name || '&access_id=' || access_id || '&mtype=' || mtype || '&rid=' || rid || '&rows_show=' || rows_show || '&norder=ESTAA' || '&n_local=' || n_local || '&vdef=' || vdef || '&xtra1=' || xtra1 , 'Est Arr', ctarget=>'_top') );
     end if;
     if norder = 'PORTLOADA'
      then
       htp.tableheader( htf.anchor2( 'strangp.shp?surl=' || surl || '&scid=' || scid || '&parm=' || parm || '&call_name=' || call_name || '&access_id=' || access_id || '&mtype=' || mtype || '&rid=' || rid || '&rows_show=' || rows_show || '&norder=PORTLOADD' || '&n_local=' || n_local || '&vdef=' || vdef || '&xtra1=' || xtra1 , 'Dept Loc', ctarget=>'_top') );
      else
       htp.tableheader( htf.anchor2( 'strangp.shp?surl=' || surl || '&scid=' || scid || '&parm=' || parm || '&call_name=' || call_name || '&access_id=' || access_id || '&mtype=' || mtype || '&rid=' || rid || '&rows_show=' || rows_show || '&norder=PORTLOADA' || '&n_local=' || n_local || '&vdef=' || vdef || '&xtra1=' || xtra1 , 'Dept Loc', ctarget=>'_top') );
     end if;
     if norder = 'PORTIDISCA'
      then
       htp.tableheader( htf.anchor2( 'strangp.shp?surl=' || surl || '&scid=' || scid || '&parm=' || parm || '&call_name=' || call_name || '&access_id=' || access_id || '&mtype=' || mtype || '&rid=' || rid || '&rows_show=' || rows_show || '&norder=PORTIDISCD' || '&n_local=' || n_local || '&vdef=' || vdef || '&xtra1=' || xtra1 , 'Arr Loc', ctarget=>'_top') );
      else
       htp.tableheader( htf.anchor2( 'strangp.shp?surl=' || surl || '&scid=' || scid || '&parm=' || parm || '&call_name=' || call_name || '&access_id=' || access_id || '&mtype=' || mtype || '&rid=' || rid || '&rows_show=' || rows_show || '&norder=PORTIDISCA' || '&n_local=' || n_local || '&vdef=' || vdef || '&xtra1=' || xtra1 , 'Arr Loc', ctarget=>'_top') );
     end if;
      if mtype = 'CONVOY'
       then
        htp.tableheader( 'Masterplan');
        --htp.tableheader( 'No of Convoy Sections');
        htp.tableheader( 'Loading');
        htp.tableheader( 'Loading Compiled');
      end if;
     if norder = 'STATUSA'
      then
       htp.tableheader( htf.anchor2( 'strangp.shp?surl=' || surl || '&scid=' || scid || '&parm=' || parm || '&call_name=' || call_name || '&access_id=' || access_id || '&mtype=' || mtype || '&rid=' || rid || '&rows_show=' || rows_show || '&norder=STATUSD' || '&n_local=' || n_local || '&vdef=' || vdef || '&xtra1=' || xtra1 , 'Status', ctarget=>'_top') );
      else
       htp.tableheader( htf.anchor2( 'strangp.shp?surl=' || surl || '&scid=' || scid || '&parm=' || parm || '&call_name=' || call_name || '&access_id=' || access_id || '&mtype=' || mtype || '&rid=' || rid || '&rows_show=' || rows_show || '&norder=STATUSA' || '&n_local=' || n_local || '&vdef=' || vdef || '&xtra1=' || xtra1 , 'Status', ctarget=>'_top') );
     end if;
      if vaccess = 'EDIT'
       then
        htp.tableheader( 'Options');
      end if;
    htp.tablerowclose;
    ctr := 0;
    for c2rec in c2a(replace(rid,'~','+'),vdef,norder,n_local,xtra1) loop
     ctr := ctr + 1;
     if ctr > rows_show then exit; end if;
     htp.tablerowopen;
      htp.tabledata( to_char(ctr), cattributes=>'class="str1_bg_left"');
      htp.p( '<td class="str1_bg_left">' );
       if mtype = 'CONVOY'
        then
         htp.p( c2rec.ship_id );
        else
         case c2rec.ship_airway
          when 'A' then htp.p( 'Air International' );
          when 'D' then htp.p( 'Air Local' );
          when 'S' then htp.p( 'Ship International' );
          when 'L' then htp.p( 'Ship Local' );
          when 'C' then htp.p( 'Convoy' );
          else
           htp.p( 'Unknown ships_airway:' || c2rec.ship_airway );
         end case;
       end if;
      htp.p( '</td>' );
      htp.tabledata( htf.anchor('strangp.shp?surl=' || surl || '&scid=' || scid || '&parm=' || parm || '&call_name=' || call_name || '&access_id=' || access_id || '&rid=' || to_char(replace(c2rec.rowid,'+','~')) || '&mtype=' || mtype || '&rows_show=' || rows_show || '&norder=SHIPNAMEA' || '&n_local=' || n_local || '&force_single_disp=T' || '&vdef=' || vdef, c2rec.shipname), cattributes=>'class="str1_bg_left"' );
      htp.tabledata( c2rec.voy, cattributes=>'class="str1_bg_left"' );
      if mtype = 'CONVOY'
       then
        null;
       else
        htp.tabledata( c2rec.sap_ship_id, cattributes=>'class="str1_bg_left"');
      end if;
      htp.tabledata( to_char(c2rec.estdepart,'DD-MON-YYYY'), cattributes=>'class="str1_bg_left"');
      htp.tabledata( to_char(c2rec.estarrive,'DD-MON-YYYY'), cattributes=>'class="str1_bg_left"');
      htp.tabledata( c2rec.portload, cattributes=>'class="str1_bg_left"');
      htp.tabledata( c2rec.portdisc, cattributes=>'class="str1_bg_left"');
      if mtype = 'CONVOY'
       then
      -- editeable fields: convoy_type, convoy_no, loading, loading_compled, status
      if vaccess = 'EDIT'
       then
         htp.tabledata( htf.formtext( 'P1', 15, 20, html_format(c2rec.masterplan)), cattributes=>'class="str1_bg_left"');
         --htp.tabledata( htf.formtext( 'P2', 5, 10, html_format(c2rec.convoy_no)), cattributes=>'class="str1_bg_left"');
         htp.tabledata( htf.formtext( 'P3', 15, 50, html_format(c2rec.loading)), cattributes=>'class="str1_bg_left"');
         htp.tabledata( htf.formtext( 'P4', 15, 50, html_format(c2rec.loading_compiled_by)), cattributes=>'class="str1_bg_left"');
        else
         htp.tabledata( c2rec.masterplan, cattributes=>'class="str1_bg_left"');
         --htp.tabledata( c2rec.convoy_no, cattributes=>'class="str1_bg_left"');
         htp.tabledata( c2rec.loading, cattributes=>'class="str1_bg_left"');
         htp.tabledata( c2rec.loading_compiled_by, cattributes=>'class="str1_bg_left"');
       end if;
      end if;
      htp.p( '<td class="str1_bg_left">');
      if vaccess = 'EDIT'
       then
         -- status = INCOMPLETE, COMPLETE, FINAL (auto final on conditions) : as per current behavior for individual
        htp.formselectopen( 'P5' );
         if c2rec.status = 'INCOMPLETE' then htp.formselectoption( 'INCOMPLETE', 'SELECTED' ); else htp.formselectoption( 'INCOMPLETE' ); end if;
         if c2rec.status = 'COMPLETE' then htp.formselectoption( 'COMPLETE', 'SELECTED' ); else htp.formselectoption( 'COMPLETE' ); end if;
         if c2rec.status = 'FINAL' then htp.formselectoption( 'FINAL', 'SELECTED' ); else htp.formselectoption( 'FINAL' ); end if;
         if c2rec.status = 'CUSTOMS COMPLETE' then htp.formselectoption( 'CUSTOMS COMPLETE', 'SELECTED' ); else htp.formselectoption( 'CUSTOMS COMPLETE' ); end if;
        htp.formselectclose;
        htp.formhidden( 'RIDARR', c2rec.rowid );
       else
        htp.p( c2rec.status );
      end if;
      htp.p( '</td>' );
      if vaccess = 'EDIT'
       then
        htp.p( '<td class="str1_bg_left">' );
        open c4(c2rec.ship_id);
        fetch c4 into c4rec;
        close c4;
        if c4rec.tot = 0 and seclevel not in ('LEVEL 8')
         then
          htp.anchor( 'strangp.accept_shp?surl=' || surl || '&scid=' || scid || '&parm=' || parm || '&access_id=' || access_id || '&mtype=' || mtype || '&force_single_disp=T&rid=' || replace(rid,'~','+') || '&p1=&p2=&p3=&p3i=&p4=&p5=&p6=&p7=&p8=&p9=&p9m=&p10=&p11=&p12=&p13=&p14=&p15=&ACTION=Delete+Ship%2FAir%2FConv','Delete' );
         else
          htp.p( c4rec.tot || ' Movements' );
        end if;
        htp.p( '</td>' );
      end if;
     htp.tablerowclose;
    end loop;
   htp.tableclose;

   htp.p( '</CENTER>' );
   -- htp.bold('Trace SHAC=[' || mtype || '][' || force_single_disp || '][' || norder || '][' || n_local || '][' || vdef || '][' || xtra1 || ']' );
   htp.htmlclose;
   return;
 end if;

--
--
--

 htp.tableopen;
 htp.tablerowopen;
 htp.p( '<td class="str2_align_center">' );
 if vaccess = 'EDIT'
  then
   htp.formopen( 'strangp.accept_shp' );
   htp.formhidden( 'SURL', surl );
   htp.formhidden( 'SCID', scid );
   htp.formhidden( 'PARM', parm );
   htp.formhidden( 'ACCESS_ID', access_id );
   htp.formhidden( 'MTYPE', mtype );
   htp.formhidden( 'FORCE_SINGLE_DISP', 'T' );
 end if;

 if access_id = 'z'
  then
   htp.formhidden( 'RID', null );
  else
   htp.formhidden( 'RID', replace(rid,'~','+') );
 end if;

 htp.tableopen( cattributes=>'class="str3_int"' );
  if (mf <> c2rec.controlling_office) and (mf is not null) and (c2rec.status = 'INCOMPLETE')
   then
    htp.tablerowopen;
     htp.tableheader( 'Controlling Office',cattributes=>'class="str1_hd_left"');
     htp.tabledata( htf.bold(c2rec.controlling_office),cattributes=>'class="str1_bg_left"');
    htp.tablerowclose;
  end if;

  htp.tablerowopen;
   if c2rec.ship_airway = 'C'
   then
     htp.tableheader( 'Convoy Id',cattributes=>'class="str1_hd_left"' );
   else
     htp.tableheader( 'Ship / Air / Convoy',cattributes=>'class="str1_hd_left"' );
   end if;
     if vaccess = 'EDIT' and nvl(c2rec.status,'INCOMPLETE') <> 'CUSTOMS COMPLETE' and seclevel not in ('LEVEL 8')
      then
	   htp.p( '<td class="str1_bg_left">' );
	   if c2rec.ship_airway = 'C' then
	    htp.formhidden( 'P1', c2rec.ship_airway);
	   else
	        htp.formselectopen( 'P1' );
		 if c2rec.ship_airway = 'A'
		  then
		   htp.formselectoption( 'Air International', 'SELECTED', cattributes=>'VALUE="A"');
		  else
		   htp.formselectoption( 'Air International', cattributes=>'VALUE="A"');
		 end if;
		 if c2rec.ship_airway = 'D'
		  then
		   htp.formselectoption( 'Air Local', 'SELECTED', cattributes=>'VALUE="D"');
		  else
		   htp.formselectoption( 'Air Local', cattributes=>'VALUE="D"');
		 end if;
		 if c2rec.ship_airway = 'S'
		  then
		   htp.formselectoption( 'Ship International', 'SELECTED', cattributes=>'VALUE="S"');
		  else
		   htp.formselectoption( 'Ship International', cattributes=>'VALUE="S"');
		 end if;
		 if c2rec.ship_airway = 'L'
		  then
		   htp.formselectoption( 'Ship Local', 'SELECTED', cattributes=>'VALUE="L"');
		  else
		   htp.formselectoption( 'Ship Local', cattributes=>'VALUE="L"');
		 end if;
		 if c2rec.ship_airway = 'C'
		  then
		   htp.formselectoption( 'Convoy', 'SELECTED', cattributes=>'VALUE="C"');
		  else
		   htp.formselectoption( 'Convoy', cattributes=>'VALUE="C"');
		 end if;
		 htp.formselectclose;
                end if;
                htp.p(' ' || htf.italic(c2rec.ship_id));
                if c2rec.ship_airway = 'C' and c2rec.ship_id is not null
                 then
                  url := 'strangp.convoy?surl=' || surl || '&vpk=' || c2rec.ship_id || '&ispopup=T';
                  url := htf.anchor( 'javascript: window.open(''' || url || ''',''' || 'POPUPS' || ''',''height=' || '800' || ',width=' || '1600' || ',scrollbars=yes,resizable=yes'');void('''');', '[Convoy Details]' );
                  htp.p( '&nbsp;' || url );
                 -- htp.p( '&nbsp;' || htf.anchor( 'strangp.menu?surl=' || surl || '&rnd=' || to_char(sysdate, 'SSSSS' ) || '&MTYPE=CONVOY','[Convoy Movements]' ));
               end if;
	   htp.p( '</td>' );

      else
       htp.tabledata( c2rec.ship_airway || ' - ' || htf.italic(c2rec.ship_id));
       if c2rec.ship_airway = 'C'
        then
           url := 'strangp.convoy?surl=' || surl || '&vpk=' || c2rec.ship_id || '&ispopup=T';
           url := htf.anchor( 'javascript: window.open(''' || url || ''',''' || 'POPUPS' || ''',''height=' || '800' || ',width=' || '1600' || ',scrollbars=yes,resizable=yes'');void('''');', 'Convoy Details' );
           if c2rec.ship_id is not null
            then
             htp.tabledata( url );
           end if;
       end if;
       if seclevel in ('LEVEL 8') then
         htp.formhidden('P1',C2REC.ship_airway);
       end if ;
     end if;

  htp.tablerowclose;
  htp.tablerowopen;
   if c2rec.ship_airway = 'C'
    then
     htp.tableheader( 'Convoy Name',cattributes=>'class="str1_hd_left"');
    else
     htp.tableheader( 'Ship Name / MAWB',cattributes=>'class="str1_hd_left"');
   end if;
     if vaccess = 'EDIT' and nvl(c2rec.status,'INCOMPLETE') <> 'CUSTOMS COMPLETE' and seclevel not in ('LEVEL 8')
      then
       htp.tabledata( htf.formtext('P2',30,30,c2rec.shipname),cattributes=>'class="str1_bg_left"');
      else
       htp.tabledata( c2rec.shipname);
       if seclevel in ('LEVEL 8') then
         htp.formhidden('P2',C2REC.shipname);
       end if ;
     end if;
  htp.tablerowclose;
  htp.tablerowopen;
   if c2rec.ship_airway = 'C'
    then
     htp.tableheader( 'Convoy Subname',cattributes=>'class="str1_hd_left"');
    else
     htp.tableheader( 'Voyage / Flight',cattributes=>'class="str1_hd_left"' );
   end if;
     if vaccess = 'EDIT' and nvl(c2rec.status,'INCOMPLETE') <> 'CUSTOMS COMPLETE'  and seclevel not in ('LEVEL 8')
      then
       htp.tabledata( htf.formtext('P3',10,10,c2rec.voy),cattributes=>'class="str1_bg_left"');
      else
       htp.tabledata( c2rec.voy );
       if seclevel in ('LEVEL 8') then
         htp.formhidden('P3',C2REC.voy);
       end if ;
     end if;
  htp.tablerowclose;
   if c2rec.ship_airway = 'C'
    then
     htp.formhidden('P3i',C2REC.sap_ship_id);
    else
    htp.tablerowopen;
     htp.tableheader( 'OTML Ship Number',cattributes=>'class="str1_hd_left"' );
     if vaccess = 'EDIT' and nvl(c2rec.status,'INCOMPLETE') <> 'CUSTOMS COMPLETE'  and seclevel not in ('LEVEL 8')
      then
       htp.tabledata( htf.formtext('P3i',10,10,c2rec.sap_ship_id),cattributes=>'class="str1_bg_left"');
      elsif vaccess = 'EDIT'
       then
       htp.tabledata( c2rec.sap_ship_id );
       if seclevel in ('LEVEL 8') then
         htp.formhidden('P3i',C2REC.sap_ship_id);
       end if;
      else
        htp.tabledata( c2rec.sap_ship_id );
     end if;
    htp.tablerowclose;
   end if;
  htp.tablerowopen;
     htp.tableheader( 'Status',cattributes=>'class="str1_hd_left"' );
     htp.p( '<TD ' || 'class="str1_cell_left">');
     if vaccess = 'EDIT'
      then
       htp.formselectopen( 'P1A' );
       if c2rec.status = 'INCOMPLETE'
        then
         htp.formselectoption( 'INCOMPLETE', 'SELECTED' );
        else
         htp.formselectoption( 'INCOMPLETE' );
       end if;
       if c2rec.status = 'COMPLETE'
        then
         htp.formselectoption( 'COMPLETE', 'SELECTED' );
        else
         htp.formselectoption( 'COMPLETE' );
       end if;
       if c2rec.status = 'FINAL'
        then
         htp.formselectoption( 'FINAL', 'SELECTED' );
        else
         htp.formselectoption( 'FINAL' );
       end if;
       if c2rec.status = 'CUSTOMS COMPLETE'
        then
         htp.formselectoption( 'CUSTOMS COMPLETE', 'SELECTED' );
        else
         htp.formselectoption( 'CUSTOMS COMPLETE' );
       end if;
       htp.formselectclose;

      else
       htp.bold( c2rec.status );
     end if;
     htp.p( '</TD>' );
  htp.tablerowclose;
 htp.tableclose;
 if vaccess = 'EDIT' and nvl(c2rec.status,'INCOMPLETE') = 'CUSTOMS COMPLETE'
  then
   htp.nl;
   htp.anchor( 'javascript: window.open(''' || 'strangs.accept_sads_by_ship?surl=' || surl || '&shipid=' || c2rec.ship_id  || '&vact=START' || ''',''' || 'Generate SAD' || ''',''height=800,width=1200,scrollbars=yes,resizable=yes'');void('''');', '[Generate SAD]' );
   open c6(c2rec.ship_id);
   fetch c6 into c6rec;
   close c6;
   if c6rec.tot > 0
    then
     htp.p('&nbsp;&nbsp;');
     htp.anchor( 'javascript: window.open(''' || 'strangs.accept_sads_by_ship?surl=' || surl || '&shipid=' || c2rec.ship_id  || '&vact=STATUS' || ''',''' || 'Generate SAD' || ''',''height=800,width=1200,scrollbars=yes,resizable=yes'');void('''');', '[SAD Logs]' );
   end if;
   htp.nl;
 end if;
 htp.nl;

 htp.tableopen( cattributes=>'class="str4_table"' );
  htp.tablerowopen;
 if nvl(c2rec.ship_airway,'!') <> 'C'
  then
     htp.tableheader( 'Estimated Departure',cattributes=>'class="str1_hd_left"' );
     if vaccess = 'EDIT' and nvl(c2rec.status,'INCOMPLETE') <> 'CUSTOMS COMPLETE'
      then
       htp.tabledata( htf.formtext('P4',30,30, to_char(c2rec.estdepart,'DD-MON-YYYY HH24:MI')) || ' ' || htf.italic('DD-MON-YYYY HH24:MI'),cattributes=>'class="str1_bg_left"');
      else
       htp.tabledata( to_char(c2rec.estdepart,'DD-MON-YYYY HH24:MI'),cattributes=>'class="str1_bg_left"' );
     end if;
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tableheader( 'Departure Location',cattributes=>'class="str1_hd_left"' );
   htp.p( '<TD ' || 'class="str1_bg_left">' );
   if vaccess = 'EDIT' and nvl(c2rec.status,'INCOMPLETE') <> 'CUSTOMS COMPLETE'
    then
     lov_list( 'LOCATIONS', 'P5', c2rec.portload, FALSE, TRUE, FALSE );
    else
     lov_list( 'LOCATIONS', 'P5', c2rec.portload, FALSE, TRUE, FALSE, isedit=>FALSE );
   end if;
   htp.p( '</TD>' );
  htp.tablerowclose;
  htp.tablerowopen;
     htp.tableheader( 'Estimated Arrival',cattributes=>'class="str1_hd_left"' );
     if vaccess = 'EDIT' and nvl(c2rec.status,'INCOMPLETE') <> 'CUSTOMS COMPLETE'
      then
       htp.tabledata( htf.formtext('P6',30,30, to_char(c2rec.estarrive,'DD-MON-YYYY HH24:MI')) || ' ' || htf.italic('DD-MON-YYYY HH24:MI'),cattributes=>'class="str1_bg_left"');
      else
       htp.tabledata( to_char(c2rec.estarrive,'DD-MON-YYYY HH24:MI'),cattributes=>'class="str1_bg_left"');
     end if;
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tableheader( 'Arrival Location',cattributes=>'class="str1_hd_left"' );
   htp.p( '<TD ' || 'class="str1_bg_left">' );
   if vaccess = 'EDIT' and nvl(c2rec.status,'INCOMPLETE') <> 'CUSTOMS COMPLETE'
    then
     lov_list( 'LOCATIONS', 'P7', c2rec.portdisc, FALSE, TRUE, FALSE );
    else
     lov_list( 'LOCATIONS', 'P7', c2rec.portdisc, FALSE, TRUE, FALSE, isedit=>FALSE );
   end if;
   htp.p( '</TD>' );
  htp.tablerowclose;
  end if;
 htp.tableclose;

 if c2rec.ship_airway = 'C'
  then
   htp.nl;
   htp.tableopen( cattributes=>'class="str4_table"' );
   if vaccess = 'EDIT' and nvl(c2rec.status,'INCOMPLETE') <> 'CUSTOMS COMPLETE'
    then
--     htp.tablerowopen;
--      htp.tabledata( htf.bold('Actual Arrival');
--      htp.tabledata( htf.formtext('PCONV1', 20, 30, to_char(c2rec.actual_arrival,'DD-MON-YYYY HH24:MI')) || ' ' || htf.italic('DD-MON-YYYY HH24:MI'),cattributes=>'class="str1_bg_left"');
--     htp.tablerowclose;
     htp.tablerowopen;
      htp.tableheader( 'Inbound/Outbound',cattributes=>'class="str1_hd_left"');
       htp.p( '<td class="str1_bg_left">' );
        if c2rec.io = 'I'
         then
          htp.p( 'Inbound' || htf.formhidden('PCONV16',c2rec.io) );
        elsif c2rec.io = 'O'
         then
          htp.p( 'Outbound' || htf.formhidden('PCONV16',c2rec.io));
        else
         htp.formselectopen( 'PCONV16' );
          if nvl(c2rec.io,'I') = 'I'
          then
           htp.formselectoption( 'Inbound', 'SELECTED', cattributes=>'VALUE="'|| 'I' ||'"');
           htp.formselectoption( 'Outbound', cattributes=>'VALUE="'|| 'O' ||'"');
          else
           htp.formselectoption( 'Inbound', cattributes=>'VALUE="'|| 'I' ||'"');
           htp.formselectoption( 'Outbound', 'SELECTED', cattributes=>'VALUE="'|| 'O' ||'"');
         end if;
        htp.formselectclose;
        end if;
       htp.p( '</td>' );
      htp.tabledata( '&nbsp;' );

      htp.p('<td rowspan="11" style="vertical-align: top;">' );
       htp.tableopen( cattributes=>'class="str3_int"' );
        htp.tablerowopen;
         htp.tableheader( 'Escort ID', cattributes=>'class="str1_hd_left"' );
         htp.tableheader( 'Call Sign', cattributes=>'class="str1_hd_left"' );
         htp.tableheader( 'Driver', cattributes=>'class="str1_hd_left"' );
        htp.tablerowclose;
        htp.tablerowopen;
         htp.tabledata( htf.formtext('PCONV18', 20, 50, html_format(c2rec.escort1_id)) );
         htp.tabledata( htf.formtext('PCONV31', 10, 10, html_format(c2rec.escort1_callsign)) );
         htp.p( '<td>' );
          htp.formselectopen( 'PCONV19' );
          htp.formselectoption( null );
          for c8rec in c8( 'OPERATORS' ) loop
           if c8rec.cola || ' ' || c8rec.code = c2rec.escort1_driver
            then
             htp.formselectoption( c8rec.cola || ' ' || c8rec.code, 'SELECTED' );
            else
             htp.formselectoption( c8rec.cola || ' ' || c8rec.code );
           end if;
         end loop;
         htp.formselectclose;
         htp.p( '</td >' );
        htp.tablerowclose;
        htp.tablerowopen;
         htp.tabledata( htf.formtext('PCONV21', 20, 50, html_format(c2rec.escort2_id)) );
         htp.tabledata( htf.formtext('PCONV32', 10, 10, html_format(c2rec.escort2_callsign)) );
         htp.p( '<td>' );
          htp.formselectopen( 'PCONV22' );
          htp.formselectoption( null );
          for c8rec in c8( 'OPERATORS' ) loop
           if c8rec.cola || ' ' || c8rec.code = c2rec.escort2_driver
            then
             htp.formselectoption( c8rec.cola || ' ' || c8rec.code, 'SELECTED' );
            else
             htp.formselectoption( c8rec.cola || ' ' || c8rec.code );
           end if;
         end loop;
         htp.formselectclose;
         htp.p( '</td >' );
        htp.tablerowclose;
        htp.tablerowopen;
         htp.tableheader( 'Passengers', cattributes=>'colspan="2" class="str1_hd_left"' );
         htp.tabledata( htf.formtext('PCONV28', 50, 100, html_format(c2rec.passengers)), cattributes=>'colspan="2"' );
        htp.tablerowclose;
        htp.tablerowopen;
         htp.tableheader( 'Support Truck Type', cattributes=>'class="str1_hd_left"' );
         htp.tableheader( 'Support Truck ID', cattributes=>'class="str1_hd_left"' );
         htp.tableheader( 'Support Truck Operators', cattributes=>'class="str1_hd_left"' );
        htp.tablerowclose;
        htp.tablerowopen;
         htp.tabledata( htf.formtext('PCONV24', 20, 50, html_format(c2rec.support_truck_type)) );
         htp.tabledata( htf.formtext('PCONV25', 10, 10, html_format(c2rec.support_truck_id)) );
         htp.p( '<td>' );
          htp.formselectopen( 'PCONV26' );
          htp.formselectoption( null );
          for c8rec in c8( 'OPERATORS' ) loop
           if c8rec.cola || ' ' || c8rec.code = c2rec.support_truck_operator1
            then
             htp.formselectoption( c8rec.cola || ' ' || c8rec.code, 'SELECTED' );
            else
             htp.formselectoption( c8rec.cola || ' ' || c8rec.code );
           end if;
         end loop;
         htp.formselectclose;
         htp.p( '</td >' );
        htp.tablerowclose;
        htp.tablerowopen;
         htp.tabledata( '&nbsp;' );
         htp.tabledata( '&nbsp;' );
         htp.p( '<td>' );
          htp.formselectopen( 'PCONV27' );
          htp.formselectoption( null );
          for c8rec in c8( 'OPERATORS' ) loop
           if c8rec.cola || ' ' || c8rec.code = c2rec.support_truck_operator2
            then
             htp.formselectoption( c8rec.cola || ' ' || c8rec.code, 'SELECTED' );
            else
             htp.formselectoption( c8rec.cola || ' ' || c8rec.code );
           end if;
         end loop;
         htp.formselectclose;
         htp.p( '</td >' );
        htp.tablerowclose;
        htp.tablerowopen;
         htp.tableheader( '&nbsp;', cattributes=>'class="str1_hd_left"' );
         htp.tableheader( 'Equipment', cattributes=>'class="str1_hd_left"' );
         htp.tableheader( 'Equipment Operators', cattributes=>'class="str1_hd_left"' );
        htp.tablerowclose;
        htp.tablerowopen;
         htp.tabledata( '&nbsp;' );
         htp.tabledata( htf.formtext('PCONV4', 20, 20, html_format(c2rec.equipment_1)) );
         htp.p( '<td>' );
          htp.formselectopen( 'PCONV7' );
          htp.formselectoption( null );
          for c8rec in c8( 'OPERATORS' ) loop
           if c8rec.cola || ' ' || c8rec.code = c2rec.equipment_operator_1
            then
             htp.formselectoption( c8rec.cola || ' ' || c8rec.code, 'SELECTED' );
            else
             htp.formselectoption( c8rec.cola || ' ' || c8rec.code );
           end if;
         end loop;
         htp.formselectclose;
         htp.p( '</td >' );
        htp.tablerowclose;
        htp.tablerowopen;
         htp.tabledata( '&nbsp;' );
         htp.tabledata( htf.formtext('PCONV5', 20, 20, html_format(c2rec.equipment_2)) );
         htp.p( '<td>' );
          htp.formselectopen( 'PCONV8' );
          htp.formselectoption( null );
          for c8rec in c8( 'OPERATORS' ) loop
           if c8rec.cola || ' ' || c8rec.code = c2rec.equipment_operator_2
            then
             htp.formselectoption( c8rec.cola || ' ' || c8rec.code, 'SELECTED' );
            else
             htp.formselectoption( c8rec.cola || ' ' || c8rec.code );
           end if;
         end loop;
         htp.formselectclose;
         htp.p( '</td >' );
        htp.tablerowclose;
        htp.tablerowopen;
         htp.tabledata( '&nbsp;' );
         htp.tabledata( htf.formtext('PCONV6', 20, 20, html_format(c2rec.equipment_3)) );
         htp.p( '<td>' );
          htp.formselectopen( 'PCONV9' );
          htp.formselectoption( null );
          for c8rec in c8( 'OPERATORS' ) loop
           if c8rec.cola || ' ' || c8rec.code = c2rec.equipment_operator_3
            then
             htp.formselectoption( c8rec.cola || ' ' || c8rec.code, 'SELECTED' );
            else
             htp.formselectoption( c8rec.cola || ' ' || c8rec.code );
           end if;
         end loop;
         htp.formselectclose;
         htp.p( '</td >' );
        htp.tablerowclose;
       htp.tableclose;
      htp.p('</td>' );

      htp.p('<td rowspan="11" style="vertical-align: top;">' );
       htp.tableopen( cattributes=>'class="str3_int"' );
        htp.tablerowopen;
         htp.tableheader( 'Fuel Loading Details', cattributes=>'colspan="2" class="str1_hd_left"' );
        htp.tablerowclose;
        htp.tablerowopen;
         htp.tableheader( 'Hose Connected',cattributes=>'class="str1_hd_left"' );
         htp.tabledata( htf.formtext('PCONV33', 10, 10, html_format(c2rec.hose_connected)) );
        htp.tablerowclose;
        htp.tablerowopen;
         htp.tableheader( 'Commenced Fuel Load',cattributes=>'class="str1_hd_left"' );
         htp.tabledata( htf.formtext('PCONV34', 10, 10, html_format(c2rec.commenced_fuel_load)) );
        htp.tablerowclose;
        htp.tablerowopen;
         htp.tableheader( 'Completed Fuel Load',cattributes=>'class="str1_hd_left"' );
         htp.tabledata( htf.formtext('PCONV35', 10, 10, html_format(c2rec.completed_fuel_load)) );
        htp.tablerowclose;
        htp.tablerowopen;
         htp.tableheader( 'Hose Disconnected',cattributes=>'class="str1_hd_left"' );
         htp.tabledata( htf.formtext('PCONV36', 10, 10, html_format(c2rec.hose_disconnected)) );
        htp.tablerowclose;
        htp.tablerowopen;
         htp.tableheader( 'Fuel Operator 1',cattributes=>'class="str1_hd_left"' );
         htp.p( '<td>' );
          htp.formselectopen( 'PCONV37' );
          htp.formselectoption( null );
          for c8rec in c8( 'OPERATORS' ) loop
           if c8rec.cola || ' ' || c8rec.code = c2rec.fuel_operator_1
            then
             htp.formselectoption( c8rec.cola || ' ' || c8rec.code, 'SELECTED' );
            else
             htp.formselectoption( c8rec.cola || ' ' || c8rec.code );
           end if;
         end loop;
         htp.formselectclose;
         htp.p( '</td >' );
        htp.tablerowclose;
        htp.tablerowopen;
         htp.tableheader( 'Fuel Operator 2',cattributes=>'class="str1_hd_left"' );
         htp.p( '<td>' );
          htp.formselectopen( 'PCONV38' );
          htp.formselectoption( null );
          for c8rec in c8( 'OPERATORS' ) loop
           if c8rec.cola || ' ' || c8rec.code = c2rec.fuel_operator_2
            then
             htp.formselectoption( c8rec.cola || ' ' || c8rec.code, 'SELECTED' );
            else
             htp.formselectoption( c8rec.cola || ' ' || c8rec.code );
           end if;
         end loop;
         htp.formselectclose;
         htp.p( '</td >' );
        htp.tablerowclose;
        htp.tablerowopen;
         htp.tableheader( 'Fuel Operator 3',cattributes=>'class="str1_hd_left"' );
         htp.p( '<td>' );
          htp.formselectopen( 'PCONV39' );
          htp.formselectoption( null );
          for c8rec in c8( 'OPERATORS' ) loop
           if c8rec.cola || ' ' || c8rec.code = c2rec.fuel_operator_3
            then
             htp.formselectoption( c8rec.cola || ' ' || c8rec.code, 'SELECTED' );
            else
             htp.formselectoption( c8rec.cola || ' ' || c8rec.code );
           end if;
         end loop;
         htp.formselectclose;
         htp.p( '</td >' );
        htp.tablerowclose;
        htp.tablerowopen;
         htp.tableheader( 'Fuel Operator 4',cattributes=>'class="str1_hd_left"' );
         htp.p( '<td>' );
          htp.formselectopen( 'PCONV40' );
          htp.formselectoption( null );
          for c8rec in c8( 'OPERATORS' ) loop
           if c8rec.cola || ' ' || c8rec.code = c2rec.fuel_operator_4
            then
             htp.formselectoption( c8rec.cola || ' ' || c8rec.code, 'SELECTED' );
            else
             htp.formselectoption( c8rec.cola || ' ' || c8rec.code );
           end if;
         end loop;
         htp.formselectclose;
         htp.p( '</td >' );
        htp.tablerowclose;
        htp.tablerowopen;
         htp.tableheader( 'Fuel Operator 5',cattributes=>'class="str1_hd_left"' );
         htp.p( '<td>' );
          htp.formselectopen( 'PCONV41' );
          htp.formselectoption( null );
          for c8rec in c8( 'OPERATORS' ) loop
           if c8rec.cola || ' ' || c8rec.code = c2rec.fuel_operator_5
            then
             htp.formselectoption( c8rec.cola || ' ' || c8rec.code, 'SELECTED' );
            else
             htp.formselectoption( c8rec.cola || ' ' || c8rec.code );
           end if;
         end loop;
         htp.formselectclose;
         htp.p( '</td >' );
        htp.tablerowclose;
        htp.tablerowopen;
         htp.tableheader( 'Fuel Operator 6',cattributes=>'class="str1_hd_left"' );
         htp.p( '<td>' );
          htp.formselectopen( 'PCONV42' );
          htp.formselectoption( null );
          for c8rec in c8( 'OPERATORS' ) loop
           if c8rec.cola || ' ' || c8rec.code = c2rec.fuel_operator_6
            then
             htp.formselectoption( c8rec.cola || ' ' || c8rec.code, 'SELECTED' );
            else
             htp.formselectoption( c8rec.cola || ' ' || c8rec.code );
           end if;
         end loop;
         htp.formselectclose;
         htp.p( '</td >' );
        htp.tablerowclose;
       htp.tableclose;
      htp.p('</td>' );

     htp.tablerowclose;

     htp.tablerowopen;
      htp.tableheader( 'Convoy Type',cattributes=>'class="str1_hd_left"');
      htp.tabledata( htf.formtext('PCONV2', 20, 20, html_format(c2rec.convoy_type)),cattributes=>'class="str1_bg_left"');
     htp.tablerowclose;
     htp.tablerowopen;
      htp.tableheader( 'Convoy Sections',cattributes=>'class="str1_hd_left"');
      htp.p( '<td class="str1_bg_left">' );
      htp.formselectopen( 'PCONV3' );
      for j in 1..16 loop
       if to_char(c2rec.convoy_no) = to_char(j)
        then
          htp.formselectoption( to_char(j), 'SELECTED' );
        else
          htp.formselectoption( to_char(j) );
       end if;
      end loop;
      htp.p( '</td>' );
     htp.tablerowclose;
     htp.tableheader( 'Estimated Departure',cattributes=>'class="str1_hd_left"' );
      if vaccess = 'EDIT' and nvl(c2rec.status,'INCOMPLETE') <> 'CUSTOMS COMPLETE'
       then
        htp.tabledata( htf.formtext('P4',30,30, to_char(c2rec.estdepart,'DD-MON-YYYY HH24:MI')) || ' ' || htf.italic('DD-MON-YYYY HH24:MI'),cattributes=>'class="str1_bg_left"');
       else
        htp.tabledata( to_char(c2rec.estdepart,'DD-MON-YYYY HH24:MI') );
      end if;
     htp.tablerowclose;
     htp.tablerowopen;
      htp.tableheader( 'Estimated Arrival',cattributes=>'class="str1_hd_left"' );
      if vaccess = 'EDIT' and nvl(c2rec.status,'INCOMPLETE') <> 'CUSTOMS COMPLETE'
       then
        htp.tabledata( htf.formtext('P6',30,30, to_char(c2rec.estarrive,'DD-MON-YYYY HH24:MI')) || ' ' || htf.italic('DD-MON-YYYY HH24:MI'),cattributes=>'class="str1_bg_left"');
       else
        htp.tabledata( to_char(c2rec.estarrive,'DD-MON-YYYY HH24:MI'),cattributes=>'class="str1_bg_left"');
      end if;
    htp.tablerowclose;
    htp.tablerowopen;
     htp.tableheader( 'From',cattributes=>'class="str1_hd_left"' );
     htp.p( '<TD ' || 'class="str1_bg_left">' );
     if vaccess = 'EDIT' and nvl(c2rec.status,'INCOMPLETE') <> 'CUSTOMS COMPLETE'
      then
       lov_list( 'DELIVERY LOCATIONS', 'P5', nvl(c2rec.portload,'TABUBIL'), FALSE, TRUE, FALSE );
      else
       lov_list( 'DELIVERY LOCATIONS', 'P5', c2rec.portload, FALSE, TRUE, FALSE, isedit=>FALSE );
     end if;
     htp.p( '</TD>' );
    htp.tablerowclose;
    htp.tablerowopen;
     htp.tableheader( 'To',cattributes=>'class="str1_hd_left"' );
     htp.p( '<TD ' || 'class="str1_bg_left">' );
     if vaccess = 'EDIT' and nvl(c2rec.status,'INCOMPLETE') <> 'CUSTOMS COMPLETE'
      then
       lov_list( 'DELIVERY LOCATIONS', 'P7', nvl(c2rec.portdisc,'KIUNGA'), FALSE, TRUE, FALSE );
      else
       lov_list( 'DELIVERY LOCATIONS', 'P7', c2rec.portdisc, FALSE, TRUE, FALSE, isedit=>FALSE );
     end if;
     htp.p( '</TD>' );
    htp.tablerowclose;
     htp.tablerowopen;
      htp.tableheader( 'Arrival Convoy No 1 and 2',cattributes=>'class="str1_hd_left"');
      htp.tabledata( htf.formtext('PCONV10', 10, 10, html_format(c2rec.arrival_convoy_1)) || '&nbsp;&nbsp;' ||  htf.formtext('PCONV11', 10, 10, html_format(c2rec.arrival_convoy_2)),cattributes=>'class="str1_bg_left"');
     htp.tablerowclose;
     htp.tablerowopen;
      htp.tableheader( 'Start Unload',cattributes=>'class="str1_hd_left"');
      htp.tabledata( htf.formtext('PCONV12', 10, 10, html_format(c2rec.start_unload)),cattributes=>'class="str1_bg_left"');
     htp.tablerowclose;
     htp.tablerowopen;
      htp.tableheader( 'Finish Load',cattributes=>'class="str1_hd_left"');
      htp.tabledata( htf.formtext('PCONV13', 10, 10, html_format(c2rec.finish_load)),cattributes=>'class="str1_bg_left"');
     htp.tablerowclose;
     htp.tablerowopen;
      htp.tableheader( 'Actual Time of Departure',cattributes=>'class="str1_hd_left"');
      htp.tabledata( htf.formtext('PCONV14', 10, 10, html_format(c2rec.atd_convoy_1)) || '&nbsp;&nbsp;' || htf.formtext('PCONV15', 10, 10, html_format(c2rec.atd_convoy_2)),cattributes=>'class="str1_bg_left"');
     htp.tablerowclose;
     htp.tablerowopen;
      htp.tableheader( 'Loading',cattributes=>'class="str1_hd_left"');
      htp.tabledata( htf.formtext('PCONV43', 20, 50, html_format(c2rec.loading)),cattributes=>'class="str1_bg_left"');
     htp.tablerowclose;
     htp.tablerowopen;
      htp.tableheader( 'Loading Compiled By',cattributes=>'class="str1_hd_left"');
      htp.tabledata( htf.formtext('PCONV44', 20, 10, html_format(c2rec.loading_compiled_by)),cattributes=>'class="str1_bg_left"');
     htp.tablerowclose;
     htp.tablerowopen;
      htp.tableheader( 'Masterplan',cattributes=>'class="str1_hd_left"');
      htp.tabledata( htf.formhidden( 'PCONV45', c2rec.masterplan) || c2rec.masterplan,cattributes=>'class="str1_bg_left"');
     htp.tablerowclose;

/* used?
     htp.tablerowopen;
      htp.tableheader( 'Discharge Date',cattributes=>'class="str1_hd_left"');
      htp.tabledata( htf.formtext('PCONV29', 20, 30, to_char(c2rec.discharge_date,'DD-MON-YYYY HH24:MI')) || ' ' || htf.italic('DD-MON-YYYY HH24:MI'),cattributes=>'class="str1_bg_left"');
     htp.tablerowclose;
*/

    else
     -- Read only
     htp.tablerowopen;
      htp.tableheader( 'Inbound/Outbound',cattributes=>'class="str1_hd_left"');
      if c2rec.io = 'I'
       then
        htp.tabledata( 'Inbound',cattributes=>'class="str1_bg_left"' );
      elsif c2rec.io = 'O'
       then
        htp.tabledata( 'Outbound',cattributes=>'class="str1_bg_left"' );
      else
        htp.tabledata( c2rec.io,cattributes=>'class="str1_bg_left"' );
      end if;
      htp.tabledata( '&nbsp;' );
      htp.p('<td rowspan="11" style="vertical-align: top;">' );
       htp.tableopen( cattributes=>'class="str3_int"' );
        htp.tablerowopen;
         htp.tableheader( 'Escort ID', cattributes=>'class="str1_hd_left"' );
         htp.tableheader( 'Call Sign', cattributes=>'class="str1_hd_left"' );
         htp.tableheader( 'Driver', cattributes=>'class="str1_hd_left"' );
        htp.tablerowclose;
        htp.tablerowopen;
         htp.tabledata( c2rec.escort1_id );
         htp.tabledata( c2rec.escort1_callsign );
         htp.tabledata( c2rec.escort1_driver );
        htp.tablerowclose;
        htp.tablerowopen;
         htp.tabledata( c2rec.escort2_id );
         htp.tabledata( c2rec.escort2_callsign );
         htp.tabledata( c2rec.escort2_driver );
        htp.tablerowclose;
        htp.tablerowopen;
         htp.tableheader( 'Passengers', cattributes=>'colspan="2" class="str1_hd_left"' );
         htp.tabledata( c2rec.passengers, cattributes=>'colspan="2"' );
        htp.tablerowclose;
        htp.tablerowopen;
         htp.tableheader( 'Support Truck Type', cattributes=>'class="str1_hd_left"' );
         htp.tableheader( 'Support Truck ID', cattributes=>'class="str1_hd_left"' );
         htp.tableheader( 'Support Truck Operators', cattributes=>'class="str1_hd_left"' );
        htp.tablerowclose;
        htp.tablerowopen;
         htp.tabledata( c2rec.support_truck_type );
         htp.tabledata( c2rec.support_truck_id );
         htp.tabledata( c2rec.support_truck_operator1 );
        htp.tablerowclose;
        htp.tablerowopen;
         htp.tabledata( '&nbsp;' );
         htp.tabledata( '&nbsp;' );
         htp.tabledata( c2rec.support_truck_operator2 );
        htp.tablerowclose;
        htp.tablerowopen;
         htp.tableheader( '&nbsp;', cattributes=>'class="str1_hd_left"' );
         htp.tableheader( 'Equipment', cattributes=>'class="str1_hd_left"' );
         htp.tableheader( 'Equipment Operators', cattributes=>'class="str1_hd_left"' );
        htp.tablerowclose;
        htp.tablerowopen;
         htp.tabledata( '&nbsp;' );
         htp.tabledata( c2rec.equipment_1 );
         htp.tabledata( c2rec.equipment_operator_1 );
        htp.tablerowclose;
        htp.tablerowopen;
         htp.tabledata( '&nbsp;' );
         htp.tabledata( c2rec.equipment_2 );
         htp.tabledata( c2rec.equipment_operator_2 );
        htp.tablerowclose;
        htp.tablerowopen;
         htp.tabledata( '&nbsp;' );
         htp.tabledata( c2rec.equipment_3 );
         htp.tabledata( c2rec.equipment_operator_3 );
        htp.tablerowclose;
       htp.tableclose;
      htp.p('</td>' );

      htp.p('<td rowspan="11" style="vertical-align: top;">' );
       htp.tableopen( cattributes=>'class="str3_int"' );
        htp.tablerowopen;
         htp.tableheader( 'Fuel Loading Details', cattributes=>'colspan="2" class="str1_hd_left"' );
        htp.tablerowclose;
        htp.tablerowopen;
         htp.tableheader( 'Hose Connected',cattributes=>'class="str1_hd_left"' );
         htp.tabledata( c2rec.hose_connected );
        htp.tablerowclose;
        htp.tablerowopen;
         htp.tableheader( 'Commenced Fuel Load',cattributes=>'class="str1_hd_left"' );
         htp.tabledata( c2rec.commenced_fuel_load );
        htp.tablerowclose;
        htp.tablerowopen;
         htp.tableheader( 'Completed Fuel Load',cattributes=>'class="str1_hd_left"' );
         htp.tabledata( c2rec.completed_fuel_load );
        htp.tablerowclose;
        htp.tablerowopen;
         htp.tableheader( 'Hose Disconnected',cattributes=>'class="str1_hd_left"' );
         htp.tabledata( c2rec.hose_disconnected );
        htp.tablerowclose;
        htp.tablerowopen;
         htp.tableheader( 'Fuel Operator 1',cattributes=>'class="str1_hd_left"' );
         htp.tabledata( c2rec.fuel_operator_1 );
        htp.tablerowclose;
        htp.tablerowopen;
         htp.tableheader( 'Fuel Operator 2',cattributes=>'class="str1_hd_left"' );
         htp.tabledata( c2rec.fuel_operator_2 );
        htp.tablerowclose;
        htp.tablerowopen;
         htp.tableheader( 'Fuel Operator 3',cattributes=>'class="str1_hd_left"' );
         htp.tabledata( c2rec.fuel_operator_3 );
        htp.tablerowclose;
        htp.tablerowopen;
         htp.tableheader( 'Fuel Operator 4',cattributes=>'class="str1_hd_left"' );
         htp.tabledata( c2rec.fuel_operator_4 );
        htp.tablerowclose;
        htp.tablerowopen;
         htp.tableheader( 'Fuel Operator 5',cattributes=>'class="str1_hd_left"' );
         htp.tabledata( c2rec.fuel_operator_5 );
        htp.tablerowclose;
        htp.tablerowopen;
         htp.tableheader( 'Fuel Operator 6',cattributes=>'class="str1_hd_left"' );
         htp.tabledata( c2rec.fuel_operator_6 );
        htp.tablerowclose;
       htp.tableclose;
      htp.p('</td>' );

     htp.tablerowclose;

     htp.tablerowopen;
      htp.tableheader( 'Convoy Type',cattributes=>'class="str1_hd_left"');
      htp.tabledata( c2rec.convoy_type,cattributes=>'class="str1_bg_left"');
     htp.tablerowclose;
     htp.tablerowopen;
      htp.tableheader( 'Convoy Sections',cattributes=>'class="str1_hd_left"');
      htp.tabledata( c2rec.convoy_no,cattributes=>'class="str1_bg_left"');
     htp.tablerowclose;
     htp.tableheader( 'Estimated Departure',cattributes=>'class="str1_hd_left"' );
        htp.tabledata( to_char(c2rec.estdepart,'DD-MON-YYYY HH24:MI'),cattributes=>'class="str1_bg_left"' );
     htp.tablerowclose;
     htp.tablerowopen;
      htp.tableheader( 'Estimated Arrival',cattributes=>'class="str1_hd_left"' );
        htp.tabledata( to_char(c2rec.estarrive,'DD-MON-YYYY HH24:MI'),cattributes=>'class="str1_bg_left"');
    htp.tablerowclose;
    htp.tablerowopen;
     htp.tableheader( 'From',cattributes=>'class="str1_hd_left"' );
     htp.p( '<TD ' || 'class="str1_bg_left">' );
       lov_list( 'LOCATIONS', 'P5', c2rec.portload, FALSE, TRUE, FALSE, isedit=>FALSE );
     htp.p( '</TD>' );
    htp.tablerowclose;
    htp.tablerowopen;
     htp.tableheader( 'To',cattributes=>'class="str1_hd_left"' );
     htp.p( '<TD ' || 'class="str1_bg_left">' );
       lov_list( 'LOCATIONS', 'P7', c2rec.portdisc, FALSE, TRUE, FALSE, isedit=>FALSE );
     htp.p( '</TD>' );
    htp.tablerowclose;
     htp.tablerowopen;
      htp.tableheader( 'Arrival Convoy No 1 and 2',cattributes=>'class="str1_hd_left"');
      htp.tabledata( c2rec.arrival_convoy_1 || '&nbsp;&nbsp;' || c2rec.arrival_convoy_2,cattributes=>'class="str1_bg_left"');
     htp.tablerowclose;
     htp.tablerowopen;
      htp.tableheader( 'Start Unload',cattributes=>'class="str1_hd_left"');
      htp.tabledata( c2rec.start_unload,cattributes=>'class="str1_bg_left"');
     htp.tablerowclose;
     htp.tablerowopen;
      htp.tableheader( 'Finish Load',cattributes=>'class="str1_hd_left"');
      htp.tabledata( c2rec.finish_load,cattributes=>'class="str1_bg_left"');
     htp.tablerowclose;
     htp.tablerowopen;
      htp.tableheader( 'Actual Time of Departure',cattributes=>'class="str1_hd_left"');
      htp.tabledata( c2rec.atd_convoy_1 || '&nbsp;&nbsp;' || c2rec.atd_convoy_2,cattributes=>'class="str1_bg_left"');
     htp.tablerowclose;
     htp.tablerowopen;
      htp.tableheader( 'Loading',cattributes=>'class="str1_hd_left"');
      htp.tabledata( c2rec.loading,cattributes=>'class="str1_bg_left"');
     htp.tablerowclose;
     htp.tablerowopen;
      htp.tableheader( 'Loading Compiled By',cattributes=>'class="str1_hd_left"');
      htp.tabledata( c2rec.loading_compiled_by,cattributes=>'class="str1_bg_left"');
     htp.tablerowclose;
     htp.tablerowopen;
      htp.tableheader( 'Masterplan',cattributes=>'class="str1_hd_left"');
      htp.tabledata( c2rec.masterplan,cattributes=>'class="str1_bg_left"');
     htp.tablerowclose;
   end if;
   htp.tableclose;
 end if;

 if nvl(c2rec.ship_airway,'X') = 'C'
  then
   htp.formhidden( 'P8', c2rec.customer_id );
   htp.formhidden( 'P9', c2rec.shipcountry );
   htp.formhidden( 'P10', c2rec.shipmaster );
   htp.formhidden( 'P9M', c2rec.nationality_master );
   htp.formhidden( 'P11', c2rec.shipweight );
   htp.formhidden( 'P12', c2rec.austcrew );
   htp.formhidden( 'P13', c2rec.pngcrew );
   htp.formhidden( 'P14', c2rec.frncrew );
   htp.formhidden( 'P15', c2rec.finaldest );
   htp.formhidden( 'P16', c2rec.manifest_reg );
   htp.formhidden( 'PC1', c2rec.sad_cuo_code );
   htp.formhidden( 'PC2', c2rec.sad_cuo_bord );
   htp.formhidden( 'PC3', c2rec.sad_054_lop_cod );
   htp.formhidden( 'PC4', c2rec.sad_057_loc_goods );

  else
 htp.nl;
 htp.tableopen( cattributes=>'class="str4_table"' );
  htp.tablerowopen;
   htp.tableheader( 'Agent',cattributes=>'class="str1_hd_left"' );
   htp.p( '<TD ' || 'class="str1_cell_left">' );
   if vaccess = 'EDIT' and nvl(c2rec.status,'INCOMPLETE') <> 'CUSTOMS COMPLETE'
    then
     if seclevel in ( 'LEVEL 8' )
      then
       htp.formhidden( 'P8', c2rec.customer_id );
       customer_list( 'AGENT', 'P8', c2rec.customer_id, FALSE, isedit=>FALSE );
      else
       customer_list( 'AGENT', 'P8', c2rec.customer_id, FALSE );
     end if;
    else
     customer_list( 'AGENT', 'P8', c2rec.customer_id, FALSE, isedit=>FALSE );
   end if;
   htp.p( '</TD>' );
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tableheader( 'Country of Origin',cattributes=>'class="str1_hd_left"' );
   htp.p( '<TD ' || 'class="str1_bg_left">' );
   if vaccess = 'EDIT' and nvl(c2rec.status,'INCOMPLETE') <> 'CUSTOMS COMPLETE'
    then
     if seclevel in ( 'LEVEL 8' )
      then
       htp.formhidden( 'P9', c2rec.shipcountry );
       lov_list( 'COUNTRIES', 'P9', c2rec.shipcountry, FALSE, TRUE, FALSE, isedit=>FALSE );
      else
       lov_list( 'COUNTRIES', 'P9', c2rec.shipcountry, FALSE, TRUE, FALSE );
     end if;
    else
     lov_list( 'COUNTRIES', 'P9', c2rec.shipcountry, FALSE, TRUE, FALSE, isedit=>FALSE );
   end if;
   htp.p( '</TD>' );
  htp.tablerowclose;
  htp.tablerowopen;
     htp.tableheader( 'Master / Pilot',cattributes=>'class="str1_hd_left"' );
     if vaccess = 'EDIT' and nvl(c2rec.status,'INCOMPLETE') <> 'CUSTOMS COMPLETE'
      then
       if seclevel in ( 'LEVEL 8' )
        then
         htp.tabledata( htf.formhidden( 'P10', c2rec.shipmaster ) || htf.bold(c2rec.shipmaster),cattributes=>'class="str1_bg_left"');
        else
         htp.tabledata( htf.formtext('P10',25,25, c2rec.shipmaster),cattributes=>'class="str1_bg_left"');
       end if;
      else
        htp.tabledata( c2rec.shipmaster,cattributes=>'class="str1_bg_left"' );
     end if;
   htp.tablerowclose;
   htp.tableheader( 'Nationality of the Master',cattributes=>'class="str1_hd_left"' );
   htp.p( '<TD ' || 'class="str1_bg_left">' );
   if vaccess = 'EDIT' and nvl(c2rec.status,'INCOMPLETE') <> 'CUSTOMS COMPLETE'
    then
     if seclevel in ( 'LEVEL 8' )
      then
       htp.formhidden( 'P9M', c2rec.nationality_master );
       lov_list( 'COUNTRIES', 'P9M', c2rec.nationality_master, FALSE, TRUE, FALSE, isedit=>FALSE );
      else
       lov_list( 'COUNTRIES', 'P9M', c2rec.nationality_master, FALSE, TRUE, FALSE );
     end if;
    else
     lov_list( 'COUNTRIES', 'P9M', c2rec.nationality_master, FALSE, TRUE, FALSE, isedit=>FALSE );
   end if;
   htp.p( '</TD>' );
  htp.tablerowclose;
  htp.tablerowopen;
     htp.tableheader( 'Weight',cattributes=>'class="str1_hd_left"' );
     if vaccess = 'EDIT' and nvl(c2rec.status,'INCOMPLETE') <> 'CUSTOMS COMPLETE'
      then
       if seclevel in ( 'LEVEL 8' )
        then
         htp.tabledata( htf.formhidden( 'P11', c2rec.shipweight ) || htf.bold(to_number(c2rec.shipweight)),cattributes=>'class="str1_bg_left"');
        else
         htp.tabledata( htf.formtext('P11',10,20, to_number(c2rec.shipweight)),cattributes=>'class="str1_bg_left"');
       end if;
      else
       htp.tabledata( htf.bold(to_number(c2rec.shipweight)),cattributes=>'class="str1_bg_left"');
     end if;
  htp.tablerowclose;
  htp.tablerowopen;
     htp.tableheader( 'Australian Crew',cattributes=>'class="str1_hd_left"' );
     if vaccess = 'EDIT' and nvl(c2rec.status,'INCOMPLETE') <> 'CUSTOMS COMPLETE'
      then
       if seclevel in ( 'LEVEL 8' )
        then
         htp.tabledata( htf.formhidden( 'P12', c2rec.austcrew ) || htf.bold(to_number(c2rec.austcrew)),cattributes=>'class="str1_bg_left"');
        else
         htp.tabledata( htf.formtext('P12',5,20, to_number(c2rec.austcrew)),cattributes=>'class="str1_bg_left"');
       end if;
      else
       htp.tabledata( htf.bold(to_number(c2rec.austcrew)),cattributes=>'class="str1_bg_left"');
     end if;
  htp.tablerowclose;
  htp.tablerowopen;
     htp.tableheader( 'PNG Crew',cattributes=>'class="str1_hd_left"' );
     if vaccess = 'EDIT' and nvl(c2rec.status,'INCOMPLETE') <> 'CUSTOMS COMPLETE'
      then
       if seclevel in ( 'LEVEL 8' )
        then
         htp.tabledata( htf.formhidden( 'P13', c2rec.pngcrew ) || htf.bold(to_number(c2rec.pngcrew)),cattributes=>'class="str1_bg_left"');
        else
         htp.tabledata( htf.formtext('P13',5,20, to_number(c2rec.pngcrew)),cattributes=>'class="str1_bg_left"');
       end if;
      else
       htp.tabledata( htf.bold(to_number(c2rec.pngcrew)),cattributes=>'class="str1_bg_left"');
     end if;
  htp.tablerowclose;
  htp.tablerowopen;
     htp.tableheader( 'Foreign Crew',cattributes=>'class="str1_hd_left"' );
     if vaccess = 'EDIT' and nvl(c2rec.status,'INCOMPLETE') <> 'CUSTOMS COMPLETE'
      then
       if seclevel in ( 'LEVEL 8' )
        then
         htp.tabledata( htf.formhidden( 'P14', c2rec.frncrew ) || htf.bold( to_number(c2rec.frncrew)),cattributes=>'class="str1_bg_left"');
        else
         htp.tabledata( htf.formtext('P14',5,20, to_number(c2rec.frncrew)),cattributes=>'class="str1_bg_left"');
       end if;
      else
       htp.tabledata( htf.bold( to_number(c2rec.frncrew)),cattributes=>'class="str1_bg_left"');
     end if;
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tableheader( 'Final Destination',cattributes=>'class="str1_hd_left"' );
   htp.p( '<TD ' || 'class="str1_bg_left">' );
   if vaccess = 'EDIT' and nvl(c2rec.status,'INCOMPLETE') <> 'CUSTOMS COMPLETE'
    then
     lov_list( 'LOCATIONS', 'P15', c2rec.finaldest, FALSE, TRUE, FALSE );
    else
     lov_list( 'LOCATIONS', 'P15', c2rec.finaldest, FALSE, TRUE, FALSE, isedit=>FALSE );
   end if;
   htp.p( '</TD>' );
  htp.tablerowclose;
  htp.tablerowopen;
     htp.tableheader( 'Manifest Reg.',cattributes=>'class="str1_hd_left"' );
     if vaccess = 'EDIT' and nvl(c2rec.manifest_reg,'INCOMPLETE') <> 'CUSTOMS COMPLETE'
      then
       if seclevel in ( 'LEVEL 8' )
        then
         htp.tabledata( htf.formhidden( 'P16', c2rec.manifest_reg ) || htf.bold( to_number(c2rec.frncrew)),cattributes=>'class="str1_bg_left"');
        else
         htp.tabledata( htf.formtext('P16',20,28, to_char(c2rec.manifest_reg)),cattributes=>'class="str1_bg_left"');
       end if;
      else
       htp.tabledata( htf.bold( to_char(c2rec.manifest_reg)),cattributes=>'class="str1_bg_left"');
     end if;
  htp.tablerowclose;
 htp.tableclose;
 htp.nl;

   htp.tableopen( cattributes=>'class="str3_int"' );
   htp.tablerowopen;
     htp.tableheader( 'Customs Clearance Office',cattributes=>'class="str1_hd_left"' );
     if vaccess = 'EDIT'
      then
       if seclevel in ( 'LEVEL 5','LEVEL 7','LEVEL 8' )
        then
         htp.tabledata( htf.formtext('PC1',5,20, c2rec.sad_cuo_code),cattributes=>'class="str1_bg_left"');
        else
         htp.tabledata( htf.formhidden( 'PC1', c2rec.sad_cuo_code ) || htf.bold( c2rec.sad_cuo_code),cattributes=>'class="str1_bg_left"');
       end if;
      else
       htp.tabledata( htf.bold( c2rec.sad_cuo_code),cattributes=>'class="str1_bg_left"');
     end if;
  htp.tablerowclose;
  htp.tablerowopen;
     htp.tableheader( 'Border Customs Office',cattributes=>'class="str1_hd_left"' );
     if vaccess = 'EDIT'
      then
       if seclevel in ( 'LEVEL 5','LEVEL 7','LEVEL 8' )
        then
         htp.tabledata( htf.formtext('PC2',5,20, c2rec.sad_cuo_bord),cattributes=>'class="str1_bg_left"');
        else
         htp.tabledata( htf.formhidden( 'PC2', c2rec.sad_cuo_bord ) || htf.bold( c2rec.sad_cuo_bord),cattributes=>'class="str1_bg_left"');
       end if;
      else
       htp.tabledata( htf.bold( c2rec.sad_cuo_bord),cattributes=>'class="str1_bg_left"');
     end if;
  htp.tablerowclose;
  htp.tablerowopen;
     htp.tableheader( 'Place of Unloading',cattributes=>'class="str1_hd_left"' );
     if vaccess = 'EDIT'
      then
       if seclevel in ( 'LEVEL 5','LEVEL 7','LEVEL 8' )
        then
         htp.tabledata( htf.formtext('PC3',5,20, c2rec.sad_054_lop_cod),cattributes=>'class="str1_bg_left"');
        else
         htp.tabledata( htf.formhidden( 'PC3', c2rec.sad_054_lop_cod ) || htf.bold( c2rec.sad_054_lop_cod),cattributes=>'class="str1_bg_left"');
       end if;
      else
       htp.tabledata( htf.bold( c2rec.sad_054_lop_cod),cattributes=>'class="str1_bg_left"');
     end if;
  htp.tablerowclose;
  htp.tablerowopen;
     htp.tableheader( 'Location of Goods',cattributes=>'class="str1_hd_left"' );
     if vaccess = 'EDIT'
      then
       if seclevel in ( 'LEVEL 5','LEVEL 7','LEVEL 8' )
        then
         htp.tabledata( htf.formtext('PC4',5,20, c2rec.sad_057_loc_goods),cattributes=>'class="str1_bg_left"');
        else
         htp.tabledata( htf.formhidden( 'PC4', c2rec.sad_057_loc_goods ) || htf.bold( c2rec.sad_057_loc_goods),cattributes=>'class="str1_bg_left"');
       end if;
      else
       htp.tabledata( htf.bold( c2rec.sad_057_loc_goods),cattributes=>'class="str1_bg_left"');
     end if;
  htp.tablerowclose;
 htp.tableclose;

 end if;

 htp.nl;

 if vaccess = 'EDIT' and nvl(c2rec.status,'INCOMPLETE') in ('CUSTOMS COMPLETE')
  then
   htp.formhidden( 'P1', null );
   htp.formhidden( 'P2', null );
   htp.formhidden( 'P3', null );
   htp.formhidden( 'P3i', null );
   htp.formhidden( 'P4', null );
   htp.formhidden( 'P5', null );
   htp.formhidden( 'P6', null );
   htp.formhidden( 'P7', null );
   htp.formhidden( 'P8', null );
   htp.formhidden( 'P9', null );
   htp.formhidden( 'P9M', null );
   htp.formhidden( 'P10', null );
   htp.formhidden( 'P11', null );
   htp.formhidden( 'P12', null );
   htp.formhidden( 'P13', null );
   htp.formhidden( 'P14', null );
   htp.formhidden( 'P15', null );
   --htp.formhidden( 'PC1', null );
   --htp.formhidden( 'PC2', null );
   --htp.formhidden( 'PC3', null );
   --htp.formhidden( 'PC4', null );
 end if;

 if vaccess = 'EDIT'
  then
   if access_id = 'z'
    then
     if nvl(c2rec.ship_airway,'X') = 'C'
      then
        htp.formsubmit( 'ACTION', 'Insert New Convoy' );
      else
       htp.formsubmit( 'ACTION', 'Insert New Ship' ); htp.formsubmit( 'ACTION', 'Insert New Air' );
     end if;
    else
     if nvl(c2rec.ship_airway,'X') = 'C'
      then
       htp.formsubmit( 'ACTION', 'Update Convoy' );
       if seclevel not in ('LEVEL 8') then
        htp.formsubmit( 'ACTION', 'Create New Convoy' );
       end if;
      else
       htp.formsubmit( 'ACTION', 'Update Ship/Air' );
       if seclevel not in ('LEVEL 8') then
        htp.formsubmit( 'ACTION', 'Create New Ship' );htp.formsubmit( 'ACTION', 'Create New Air' );
       end if;
     end if;
     open c4(c2rec.ship_id);
     fetch c4 into c4rec;
     close c4;
     if c4rec.tot = 0 and seclevel not in ('LEVEL 8')
      then
       if nvl(c2rec.ship_airway,'X') = 'C'
        then
         htp.formsubmit( 'ACTION', 'Delete Convoy' );
        else
         htp.formsubmit( 'ACTION', 'Delete Ship/Air' );
       end if;
     end if;
   end if;
   htp.formclose;
 end if;

   htp.tableopen( cattributes=>'class="str1_table4"' );
    htp.tablerowopen;
    if c2rec.ship_airway = 'S' and nvl(c2rec.status,'INCOMPLETE') not in ('FINAL','CUSTOMS COMPLETE')
     then
      htp.p( '<td class="str1_bg_left">' );
       htp.formopen( 'strangp.edit_bol', ctarget=>'NEWECN' );
       htp.formhidden( 'SURL', surl );
       htp.formhidden( 'RID', replace(rid,'~','+') );
       htp.formhidden( 'PARM', parm );
       htp.formhidden( 'SCID', scid );
       htp.formhidden( 'ACCESS_ID', access_id );
       htp.formhidden( 'SHPID', c2rec.ship_id );
       htp.formsubmit( null, 'Assign BOL' );
       htp.formclose;
      htp.p( '</TD>' );
   end if;
  search( surl, 'SHIP_AIRWAY', rid, samerow=>TRUE );
  htp.tablerowclose;

     if seclevel in ('LEVEL 5','LEVEL 7','LEVEL 8')
      then
--htp.formsubmit( 'ACTION', Customs Info );

 if nvl(c2rec.status,'INCOMPLETE') in ('FINAL') and seclevel in ('LEVEL 5','LEVEL 7')
  then
    open c5( c2rec.ship_id );
    fetch c5 into c5rec;
    if c5%FOUND
     then
      found_entry := TRUE;
     else
      found_entry := FALSE;
    end if;
    close c5;
    htp.tablerowopen;
    htp.p( '<td class="str1_bg_left">' );
    -- Allocate
    if not found_entry
     then

--      htp.anchor( 'strangp.confirm_genduty?surl=' || surl || '&rid=' || replace(rid,'+','~') || '&scid=' || scid || '&parm=' || replace(parm,' ','+') || '&access_id=' || access_id || '&msg=DUTY' , '[' || 'Generate Entry Nos' || ']' );
      htp.formsubmit( cvalue =>'Allocate Entry Nos', cattributes => 'onclick="window.location=''strangp.confirm_genduty?surl=' || surl || '&rid=' || replace(rid,'+','~') || '&scid=' || scid || '&parm=' || replace(parm,' ','+') || '&access_id=' || access_id || '&msg=DUTY'''|| '"' );
    end if;
    -- UnAllocate
    if found_entry
     then
--      htp.anchor( 'strangp.confirm_genduty?surl=' || surl || '&rid=' || replace(rid,'+','~') || '&scid=' || scid || '&parm=' || replace(parm,' ','+') || '&access_id=' || access_id || '&msg=UNALLOCATE' , '[' || 'Unallocate Entry Nos' || ']' );
      htp.formsubmit( cvalue =>'Unallocate Entry Nos', cattributes => 'onclick="window.location=''strangp.confirm_genduty?surl=' || surl || '&rid=' || replace(rid,'+','~') || '&scid=' || scid || '&parm=' || replace(parm,' ','+') || '&access_id=' || access_id || '&msg=UNALLOCATE'''|| '"' );

    end if;
    htp.p( '</TD>' );
    htp.tablerowclose;
   end if;
  end if;
 htp.tableclose;
 htp.nl;
 /*
 if nvl(c2rec.status,'INCOMPLETE') <> 'INCOMPLETE'
  then
   htp.anchor( 'strangp.genduty?surl=' || surl || '&rid=' || rid || '&scid=' || scid || '&parm=' || replace(parm,' ','+') || '&access_id=' || access_id || '&msg=LINE_NO' , 'Generate Line Nos' );
   htp.nl;
   display_report( surl, dapi.GLOBAL_ACCOUNT.acctid, 'REPORT B','Ship Manifests',c2rec.shipname,c2rec.ship_id);
 end if;
 display_report( surl, dapi.GLOBAL_ACCOUNT.acctid, 'REPORT B','Bill of Lading for Combined Transport',c2rec.shipname,c2rec.ship_id);
 display_report( surl, dapi.GLOBAL_ACCOUNT.acctid, 'REPORT B','Drawback',c2rec.shipname,c2rec.ship_id);
 display_report( surl, dapi.GLOBAL_ACCOUNT.acctid, 'REPORT B','Repair and Return',c2rec.shipname,c2rec.ship_id);
 display_report( surl, dapi.GLOBAL_ACCOUNT.acctid, 'REPORT B','PartShipment',c2rec.shipname,c2rec.ship_id);
 display_report( surl, dapi.GLOBAL_ACCOUNT.acctid, 'REPORT B','ECN Report',c2rec.shipname,c2rec.ship_id);
 */
 if substr(parm,1,1) = 'X'
  then
   htp.bold( '<a href="" onClick="self.close()">' || LNG.GLB_TXT_033 || '</a>'); htp.nl;
 end if;
 if msg is not null
  then
   header_msg( msg );
 end if;
 htp.p( '</CENTER>' );
 htp.htmlclose;
exception when others then
 error_details( 'STRANGP', 'SHP',null,null,errmsg=>sqlerrm,extdet=>'PARM:' || parm);
end shp;

procedure accept_shp_mass( surl in varchar2, scid in integer, parm in varchar2, access_id in varchar2, rid in varchar2, action in varchar2, mtype in varchar2 default null, rows_show in integer default G_ROWS, norder in varchar2 default null, n_local in char default 'L', force_single_disp in char default 'F', xtra1 in varchar2 default 'ALL',
                           p1 in owa.vc_arr, p2 in owa.vc_arr, p3 in owa.vc_arr, p4 in owa.vc_arr, p5 in owa.vc_arr, ridarr in owa.vc_arr )
as

 cursor c2(rid rowid) is select status,ship_id,shipname,voy from strang.ships_airway where rowid = rid;

 c2rec		c2%ROWTYPE;
 vste		varchar2(10);
 vdef		char(1);
 vrid		rowid;
 vp1		varchar2(1000);
 vp2		varchar2(1000);
 vp3		varchar2(1000);
 vp4		varchar2(1000);
 vp5		varchar2(1000);
begin
 if not dapi.init( surl, 'STRANGP.ACCEPT_SHP', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'ACCEPT_SHP');
    return;
 end if;

 case mtype
  when 'SHIP_AIRWAY'  then vdef := 'S';
  when 'SHIP_AIRWAY_LOCAL' then vdef := 'L';
  when 'SHIP_AIRWAY_INT' then vdef := 'S';
  when 'AIRWAY_LOCAL' then vdef := 'D';
  when 'AIRWAY_INT' then vdef := 'A';
  when 'CONVOY' then vdef := 'C';
  else vdef := null;
 end case;
 vste := customer_state(dapi.GLOBAL_ACCOUNT.acctid);

 if action = 'Create New Convoy'
  then
   shp(surl,null,scid,parm,'z','Create New Convoy', vdef=>'C', mtype=>mtype, rows_show=>rows_show, norder=>norder, n_local=>n_local, force_single_disp=>force_single_disp );
   return;
 end if;

 for j in ridarr.first..ridarr.last loop
  vrid := ridarr(j);
  if vrid is not null
   then
    vp5 := p5(j);
    c2rec := null;
    open c2(chartorowid( replace(vrid,'~','+') ));
    fetch c2 into c2rec;
    close c2;
    if vdef = 'C'
     then
      vp1 := p1(j);
      --vp2 := gl.guess_number(p2(j));
      vp3 := p3(j);
      vp4 := p4(j);
      update strang.ships_airway
       set
        masterplan = vp1,
        --convoy_no = vp2,
        loading = vp3,
        loading_compiled_by = vp4
      where
       rowid = chartorowid( replace(vrid,'~','+') );
    end if;
    update strang.ships_airway
     set
      status = nvl(vp5,'INCOMPLETE')
    where
     rowid = chartorowid( replace(vrid,'~','+') );

    if nvl(c2rec.status,'|') <> nvl(vp5,'INCOMPLETE') -- only run if status has changed
     then
      if nvl(vp5,'INCOMPLETE') in ('COMPLETE','FINAL','CUSTOMS COMPLETE')
       then
        update strang.movements
         set
          complete = 'S'
        where
         ship_id = c2rec.ship_id;
       end if;
       if nvl(vp5,'INCOMPLETE') = 'INCOMPLETE'
        then
         update strang.movements
          set
           complete = 'W'
         where
          ship_id = c2rec.ship_id and
          complete = 'S';
        end if;
        if nvl(vp5,'INCOMPLETE') in ('FINAL') and nvl(c2rec.status,'INCOMPLETE') not in ('FINAL')
         then
          generate_ost256( surl, c2rec.ship_id );
          generate_ost156( surl, c2rec.ship_id );
          generate_ost157( surl, c2rec.ship_id );
          generate_ccdets( surl, c2rec.ship_id );
          generate_ccpo( surl, c2rec.ship_id );
          -- populate tracking_header and tracking_details
          generate_containers( c2rec.ship_id );
        end if;
      else
        if nvl(c2rec.status,'INCOMPLETE') in ('FINAL') and nvl(vp5,'INCOMPLETE') not in ('FINAL')
         then
          delete from strang.tracking_details where upper(ship) = upper(c2rec.shipname) and upper(voyage) = upper(c2rec.voy);
         end if;
       end if;
   end if;
 end loop;
 commit;

 if action = 'Modify'
  then
   shp( surl, rid, scid, parm, access_id, 'Record(s) Successfully Updated', vdef=>vdef, mtype=>mtype, rows_show=>rows_show, norder=>norder, n_local=>n_local, force_single_disp=>'F' );
  else
   shp( surl, rid, scid, parm, access_id, 'Record(s) Successfully Updated', vdef=>vdef, mtype=>mtype, rows_show=>rows_show, norder=>norder, n_local=>n_local, force_single_disp=>force_single_disp );
 end if;

exception when others then
 error_details( 'STRANGP', 'ACCEPT_SHP_MASS',null,null,errmsg=>sqlerrm,extdet=>'PARM:' || parm);
end accept_shp_mass;

procedure generate_containers( shpid in integer )
as

 cursor c1(shpid integer) is
  select movement_no, bol, container_type
  from strang.movements
  where ship_id = shpid;

 cursor c2(shpid integer) is select * from strang.ships_airway where ship_id = shpid;

 cursor c3(mv varchar2) is select * from strang.tracking_header where containerno = mv;

 cursor c4(sno integer, sname varchar2, vy varchar2) is select * from strang.tracking_details where id = sno and ship = sname and voyage = vy;

 cursor c5(sno integer) is select nvl(max(rno),0) + 1 mx from strang.tracking_details where id = sno;

 cursor c6(v_cntr varchar2) is select * from strang.containers where upper(trim(containerno)) = upper(trim(v_cntr));

 c2rec	 c2%ROWTYPE;
 c3rec   c3%ROWTYPE;
 c4rec   c4%ROWTYPE;
 c6rec   c6%ROWTYPE;
 sno	 integer;
 calcrno integer;

begin

 open c2(shpid);
 fetch c2 into c2rec;
 close c2;
 for c1rec in c1(shpid) loop
  c6rec.cat_company := null;
  open c6(c3rec.containerno);
  fetch c6 into c6rec;
  close c6;
  open c3( c1rec.movement_no );
  fetch c3 into c3rec;
  if c3%FOUND
   then
    -- check if ship and voyage already inserted
    open c4(c3rec.id, c2rec.shipname, c2rec.voy);
    fetch c4 into c4rec;
    if c4%FOUND
     then
      update strang.tracking_details
       set
        departure_location = c2rec.portload,
        etd_date = c2rec.estdepart,
        arrival_location = nvl(c2rec.finaldest,c2rec.portdisc),
        eta_date = c2rec.estarrive,
        current_location = nvl(c2rec.finaldest,c2rec.portdisc),
        date_at_current_loc = c2rec.estarrive
      where
       id = c3rec.id and
       rno = c4rec.rno;
     else
      open c5(c3rec.id);
      fetch c5 into calcrno;
      close c5;
      insert into strang.tracking_details(id,rno,remark,movement_type,departure_location,etd_date,arrival_location,eta_date,ship,voyage,current_location,date_at_current_loc)
       values(c3rec.id,calcrno,'Bill of lading: ' || c1rec.bol,'NORTHBOUND SHIP',c2rec.portload,c2rec.estdepart,nvl(c2rec.finaldest,c2rec.portdisc),c2rec.estarrive,c2rec.shipname,c2rec.voy,nvl(c2rec.finaldest,c2rec.portdisc),c2rec.estarrive);
    end if;
    close c4;
    if c3rec.cat_code is null or c3rec.cat_company is null
     then
      c3rec.cat_code := nvl(c3rec.cat_code, c1rec.container_type);
      c3rec.cat_company := nvl(c3rec.cat_company, c6rec.cat_company);
      update strang.tracking_header
      set    cat_code = c3rec.cat_code
        ,    cat_company = c3rec.cat_company
      where  id = c3rec.id;
    end if;

   else

    -- insert new
    select strang.s_tracking_header.nextval into sno from dual;
    insert into strang.tracking_header(id,containerno,cat_code,cat_company) values
     (sno,c1rec.movement_no,c1rec.container_type,c6rec.cat_company);
    insert into strang.tracking_details(id,rno,remark,movement_type,departure_location,etd_date,arrival_location,eta_date,ship,voyage,current_location,date_at_current_loc)
     values(sno,1,'Bill of lading: ' || c1rec.bol,'SHIP',c2rec.portload,c2rec.estdepart,nvl(c2rec.finaldest,c2rec.portdisc),c2rec.estarrive,c2rec.shipname,c2rec.voy,nvl(c2rec.finaldest,c2rec.portdisc),c2rec.estarrive);

  end if;
  close c3;
 end loop;
 commit;
end generate_containers;

procedure accept_shp( surl in varchar2, scid in integer, parm in varchar2, access_id in varchar2, rid in varchar2, action in varchar2,
                      p1 in varchar2, p1a in varchar2, p2 in varchar2, p3 in varchar2, p3i in varchar2, p4 in varchar2, p5 in varchar2, p6 in varchar2, p7 in varchar2,
                      p8 in varchar2, p9 in varchar2, p9m in varchar2, p10 in varchar2, p11 in varchar2, p12 in varchar2, p13 in varchar2, p14 in varchar2, p15 in varchar2, p16 in varchar2,
                      pc1 in varchar2 default null, pc2 in varchar2 default null, pc3 in varchar2 default null, pc4 in varchar2 default null,
                      pconv1 in varchar2 default null, pconv2 in varchar2 default null, pconv3 in varchar2 default null, pconv4 in varchar2 default null, pconv5 in varchar2 default null,
                      pconv6 in varchar2 default null, pconv7 in varchar2 default null, pconv8 in varchar2 default null, pconv9 in varchar2 default null, pconv10 in varchar2 default null,
                      pconv11 in varchar2 default null, pconv12 in varchar2 default null, pconv13 in varchar2 default null, pconv14 in varchar2 default null, pconv15 in varchar2 default null,
                      pconv16 in varchar2 default null, pconv17 in varchar2 default null, pconv18 in varchar2 default null, pconv19 in varchar2 default null, pconv20 in varchar2 default null,
                      pconv21 in varchar2 default null, pconv22 in varchar2 default null, pconv23 in varchar2 default null, pconv24 in varchar2 default null, pconv25 in varchar2 default null,
                      pconv26 in varchar2 default null, pconv27 in varchar2 default null, pconv28 in varchar2 default null, pconv29 in varchar2 default null, pconv30 in varchar2 default null,
                      pconv31 in varchar2 default null, pconv32 in varchar2 default null, pconv33 in varchar2 default null, pconv34 in varchar2 default null, pconv35 in varchar2 default null,
                      pconv36 in varchar2 default null, pconv37 in varchar2 default null, pconv38 in varchar2 default null, pconv39 in varchar2 default null, pconv40 in varchar2 default null,
                      pconv41 in varchar2 default null, pconv42 in varchar2 default null, pconv43 in varchar2 default null, pconv44 in varchar2 default null, pconv45 in varchar2 default null,
                      mtype in varchar2 default null, rows_show in integer default G_ROWS, norder in varchar2 default null, n_local in char default 'L', force_single_disp in char default 'F', xtra1 in varchar2 default 'ALL')
as

 cursor c1(sto varchar2) is select max(ship_id) ship_id from strang.ships_airway;
 cursor c2(rid rowid) is select status,ship_id,shipname,voy from strang.ships_airway where rowid = rid;
 cursor c10(v_shipname varchar2, v_voy varchar2) is select rowid from strang.ships_airway where upper(shipname) = upper(v_shipname) and upper(voy) = upper(v_voy);
 cursor c11(vste varchar2) is select description from strang.lov where lov_name = 'CONTROLS' and code = 'DELIVERYNO' and cola = vste;

 c1rec		c1%ROWTYPE;
 c2rec		c2%ROWTYPE;
 c10rec		c10%ROWTYPE;
 c11rec 	c11%ROWTYPE;

 newrid		rowid;
 sts		varchar2(100);
 nmb1		number;
 nmb2		integer;
 nmb3		integer;
 nmb4		integer;
 nmb5		number;
 nmb6		integer;
 nmb7		integer;
 nmb8		integer;
 nmb9		integer;
 nmb10		integer;
 dt1		date;
 dt2		date;
 dt3		date;
 dt4		date;
 mf		varchar2(100);
 vste		varchar2(10);
 vdef		char(1);
 vconv11	varchar2(100);
 vconv15	varchar2(100);
 vconv33	varchar2(100);
 vconv34	varchar2(100);
 vconv35	varchar2(100);
 vconv36	varchar2(100);
 vconv45	varchar2(100);
 e_msg		varchar2(32767);

begin
 if not dapi.init( surl, 'STRANGP.ACCEPT_SHP', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'ACCEPT_SHP');
    return;
 end if;

 case mtype
  when 'SHIP_AIRWAY'  then vdef := 'S';
  when 'SHIP_AIRWAY_LOCAL' then vdef := 'L';
  when 'SHIP_AIRWAY_INT' then vdef := 'S';
  when 'AIRWAY_LOCAL' then vdef := 'D';
  when 'AIRWAY_INT' then vdef := 'A';
  when 'CONVOY' then vdef := 'C';
  else vdef := null;
 end case;

 vste := customer_state(dapi.GLOBAL_ACCOUNT.acctid);
 if action = 'Create New Ship'
  then
   shp(surl,null,scid,parm,'z','Create New Ship', vdef=>'S', mtype=>mtype, rows_show=>rows_show, norder=>norder, n_local=>n_local, force_single_disp=>force_single_disp );
   return;
 end if;
 if action = 'Create New Air'
  then
   shp(surl,null,scid,parm,'z','Create New Air', vdef=>'A', mtype=>mtype, rows_show=>rows_show, norder=>norder, n_local=>n_local, force_single_disp=>force_single_disp );
   return;
 end if;
 if action = 'Create New Convoy'
  then
   shp(surl,null,scid,parm,'z','Create New Convoy', vdef=>'C', mtype=>mtype, rows_show=>rows_show, norder=>norder, n_local=>n_local, force_single_disp=>force_single_disp );
   return;
 end if;

 if action in ('Delete Ship/Air')
  then
   delete from strang.ships_airway where rowid = chartorowid( replace(rid,'~','+') );
   shp(surl,null,scid,parm,'z','Ships/Airway Deleted', vdef=>vdef, mtype=>mtype, rows_show=>rows_show, norder=>norder, n_local=>n_local, force_single_disp=>force_single_disp );
   return;
 end if;

 if action in ('Delete Convoy')
  then
   for crec in (select m.rowid from strang.movements m where convoy_id = (select ship_id from strang.ships_airway where rowid = chartorowid( replace(rid,'~','+') )) and truck_id = (select truck_id from strang.ships_airway where rowid = chartorowid( replace(rid,'~','+') )) ) loop
    update strang.movements m set convoy_id = null, truck_id = null, interface4_date = null where rowid = crec.rowid;
   end loop;
   delete from strang.convoy_details where ship_id in (select ship_id from strang.ships_airway where rowid = chartorowid( replace(rid,'~','+') ));
   delete from strang.ships_airway where rowid = chartorowid( replace(rid,'~','+') );
   shp(surl,null,scid,parm,'z','Convoy Deleted', vdef=>vdef, mtype=>mtype, rows_show=>rows_show, norder=>norder, n_local=>n_local, force_single_disp=>force_single_disp );
   return;
 end if;

 begin dt1 := to_date(p4,'DD-MON-YYYY HH24:MI'); exception when others then e_msg := e_msg || '[Invalid Date Entered' || ':' || p4 || ' ' || 'must be of format' || ':' || 'DD-MON-YYYY HH24:MI' || ']'; end;
 begin dt2 := to_date(p6,'DD-MON-YYYY HH24:MI'); exception when others then e_msg := e_msg || '[Invalid Date Entered' || ':' || p6 || ' ' || 'must be of format' || ':' || 'DD-MON-YYYY HH24:MI' || ']'; end;
-- begin dt3 := to_date(pconv1,'DD-MON-YYYY HH24:MI'); exception when others then shp( surl, rid, scid, parm, access_id, 'Invalid Date Entered' || ':' || pconv1 || ' ' || 'must be of format' || ':' || 'DD-MON-YYYY HH24:MI', mtype=>mtype ); return; end;
 begin dt4 := to_date(pconv29,'DD-MON-YYYY HH24:MI'); exception when others then e_msg := e_msg || '[Invalid Date Entered' || ':' || pconv1 || ' ' || 'must be of format' || ':' || 'DD-MON-YYYY HH24:MI' || ']'; end;
 if (dt1 is not null) and (dt2 is not null) and (dt2 < dt1 )
  then
   e_msg := e_msg || '[Departure Date must be less than Arrival Date]';
 end if;
 begin nmb1 := to_number(p11); exception when others then e_msg := e_msg || '[Invalid Weight Entered' || ':' || p11 || ' ' || 'must be a whole number' || ']'; end;
 begin nmb2 := to_number(p12); exception when others then e_msg := e_msg || '[Invalid Australian Crew Entered' || ':' || p12 || ' ' || 'must be a whole number' || ']'; end;
 begin nmb3 := to_number(p13); exception when others then e_msg := e_msg || '[Invalid PNG Crew Entered' || ':' || p13 || ' ' || 'must be a whole number' || ']'; end;
 begin nmb4 := to_number(p14); exception when others then e_msg := e_msg || '[Invalid Foreign Entered' || ':' || p14 || ' ' || 'must be a whole number' || ']'; end;
-- begin nmb5 := to_number(pconv10); exception when others then shp( surl, rid, scid, parm, access_id, 'Invalid Arrival Convoy 1 entered' || ':' || pconv10 || ' ' || 'must be a whole number', mtype=>mtype, rows_show=>rows_show, norder=>norder, n_local=>n_local, force_single_disp=>force_single_disp ); return; end;
-- begin nmb6 := to_number(pconv11); exception when others then shp( surl, rid, scid, parm, access_id, 'Invalid Arrival Convoy 1 entered' || ':' || pconv11 || ' ' || 'must be a whole number', mtype=>mtype, rows_show=>rows_show, norder=>norder, n_local=>n_local, force_single_disp=>force_single_disp ); return; end;
-- begin nmb7 := to_number(pconv12); exception when others then shp( surl, rid, scid, parm, access_id, 'Invalid Start Unload entered' || ':' || pconv12 || ' ' || 'must be a whole number', mtype=>mtype, rows_show=>rows_show, norder=>norder, n_local=>n_local, force_single_disp=>force_single_disp ); return; end;
-- begin nmb8 := to_number(pconv13); exception when others then shp( surl, rid, scid, parm, access_id, 'Invalid Finish Load entered' || ':' || pconv13 || ' ' || 'must be a whole number', mtype=>mtype, rows_show=>rows_show, norder=>norder, n_local=>n_local, force_single_disp=>force_single_disp ); return; end;
-- begin nmb9 := to_number(pconv14); exception when others then shp( surl, rid, scid, parm, access_id, 'Invalid ATD Convoy 1 entered' || ':' || pconv14 || ' ' || 'must be a whole number', mtype=>mtype, rows_show=>rows_show, norder=>norder, n_local=>n_local, force_single_disp=>force_single_disp ); return; end;
-- begin nmb10 := to_number(pconv15); exception when others then shp( surl, rid, scid, parm, access_id, 'Invalid ATD Convoy 2 entered' || ':' || pconv15 || ' ' || 'must be a whole number', mtype=>mtype, rows_show=>rows_show, norder=>norder, n_local=>n_local, force_single_disp=>force_single_disp ); return; end;
 G_ERR := null;
 vconv11 := guess_time(pconv11);
 if G_ERR is not null
  then
    e_msg := e_msg || '[Arrival Convoy:' || G_ERR || ']';
 end if;
 G_ERR := null;
 vconv15 := guess_time(pconv15);
 if G_ERR is not null
  then
    e_msg := e_msg || '[Departure Convoy:' || G_ERR || ']';
 end if;
 G_ERR := null;
 vconv33 := guess_time(pconv33);
 if G_ERR is not null
  then
    e_msg := e_msg || '[Hose Connected:' || G_ERR || ']';
 end if;
 G_ERR := null;
 vconv34 := guess_time(pconv34);
 if G_ERR is not null
  then
    e_msg := e_msg || '[Commenced Fuel Load:' || G_ERR || ']';
 end if;
 G_ERR := null;
 vconv35 := guess_time(pconv35);
 if G_ERR is not null
  then
    e_msg := e_msg || '[Completed Fuel Load:' || G_ERR || ']';
 end if;
 G_ERR := null;
 vconv36 := guess_time(pconv36);
 if G_ERR is not null
  then
    e_msg := e_msg || '[Hose Disconnected:' || G_ERR || ']';
 end if;

 if p2 is null and access_id = 'z'
  then
    e_msg := e_msg || '[A Ship Name must be Entered]';
 end if;

 if p3 is null and access_id = 'z'
  then
    e_msg := e_msg || '[A Voyage must be Entered]';
 end if;

 if e_msg is not null and access_id = 'z'
  then
   shp( surl, rid, scid, parm, 'x', e_msg, vdef=>vdef, mtype=>mtype, rows_show=>rows_show, norder=>norder, n_local=>n_local, force_single_disp=>force_single_disp );
   return;
 end if;

 if access_id = 'z'
  then
   open c10(p2,p3);
   fetch c10 into c10rec;
   if c10%FOUND
    then
     close c10;
     shp( surl, c10rec.rowid, scid, parm, 'x', 'This Ship/Airway/Conv Record already exists.' || e_msg, vdef=>vdef, mtype=>mtype, rows_show=>rows_show, norder=>norder, n_local=>n_local, force_single_disp=>force_single_disp );
     return;
   end if;
   close c10;
   open c11(vste);
   fetch c11 into c11rec;
   close c11;
   open c1(currsite);
   fetch c1 into c1rec;
   close c1;
   if c1rec.ship_id is null then c1rec.ship_id := c11rec.description; end if;
   c1rec.ship_id := nvl(c1rec.ship_id,0) + 1;
   mf := control_code( 'OFFICE', vste );
   if vdef = 'C' then vconv45 := 'WK' || to_char(dt1,'WW YYYY'); end if;
   insert into strang.ships_airway(ship_airway,ship_id,shipname,voy,sap_ship_id, shipmaster,estdepart,estarrive,
                                   portload,portdisc,shipcountry,shipweight,austcrew,pngcrew,
                                   frncrew,finaldest,customer_id,status,
                                   manifest_created,controlling_office,nationality_master, manifest_reg,
                                   sad_cuo_code, sad_cuo_bord, sad_054_lop_cod, sad_057_loc_goods,
                                   convoy_type,convoy_no,equipment_1,equipment_2,
                                   equipment_3,equipment_operator_1,equipment_operator_2,equipment_operator_3,arrival_convoy_1,
                                   arrival_convoy_2,start_unload,finish_load,atd_convoy_1,atd_convoy_2,io,escort1_driver,
                                   escort1_id,escort2_driver,escort2_id,support_truck_type,
                                   support_truck_operator1,support_truck_operator2,support_truck_id,passengers,discharge_date,
                                   escort1_callsign,escort2_callsign,hose_connected,commenced_fuel_load,completed_fuel_load,hose_disconnected,
                                   fuel_operator_1,fuel_operator_2,fuel_operator_3,fuel_operator_4,fuel_operator_5,fuel_operator_6,
                                   loading,loading_compiled_by,masterplan
      ) values
    (p1,c1rec.ship_id,p2,p3,p3i,p10,dt1,dt2,
     p5,p7,p9,nmb1,nmb2,nmb3,nmb4,p15,p8,nvl(p1a,'INCOMPLETE'),
     mf,mf,p9m, p16,
     pc1, pc2, pc3, pc4,
     pconv2,pconv3,pconv4,pconv5,
     pconv6,pconv7,pconv8,pconv9,pconv10,
     vconv11,pconv12,pconv13,pconv14,vconv15,pconv16,pconv18,pconv19,
     pconv21,pconv22,pconv24,
     pconv25,pconv26,pconv27,pconv28,dt4,
     pconv31,pconv32,vconv33,vconv34,vconv35,vconv36,
     pconv37,pconv38,pconv39,pconv40,pconv41,pconv42,
     pconv43,pconv44,vconv45)
    returning rowid into newrid;

  else
   open c2(chartorowid( replace(rid,'~','+') ));
   fetch c2 into c2rec;
   close c2;
   if (c2rec.shipname <> p2) or (c2rec.voy <> p3 )
    then
     -- Shipname or Voyage changed, check for uniqueness
     open c10(p2,p3);
     fetch c10 into c10rec;
     if c10%FOUND
      then
       close c10;
       shp( surl, rid, scid, parm, 'x', 'This Ship/Airway/Conv Record already exists', vdef=>vdef, mtype=>mtype, rows_show=>rows_show, norder=>norder, n_local=>n_local, force_single_disp=>force_single_disp );
       return;
     end if;
     close c10;
   end if;
   if nvl(c2rec.status,'INCOMPLETE') <> 'CUSTOMS COMPLETE'
    then
    update strang.ships_airway
     set
      ship_airway = p1,
      shipname = p2,
      voy = p3,
      sap_ship_id = p3i,
      shipmaster = p10,
      estdepart = dt1,
      estarrive = dt2,
      portload = p5,
      portdisc = p7,
      shipcountry = p9,
      nationality_master = p9m,
      shipweight = nmb1,
      austcrew = nmb2,
      pngcrew = nmb3,
      frncrew = nmb4,
      finaldest = p15,
      customer_id = p8,
      status = nvl(p1a,'INCOMPLETE'),
      controlling_office = mf,
      manifest_reg = p16,
      sad_cuo_code = pc1,
      sad_cuo_bord = pc2,
      sad_054_lop_cod = pc3,
      sad_057_loc_goods = pc4,
      arrival_convoy_1 = pconv10,
      arrival_convoy_2 = vconv11,
      start_unload = pconv12,
      finish_load = pconv13,
      atd_convoy_1 = pconv14,
      atd_convoy_2 = vconv15,
      convoy_type = pconv2,
      convoy_no = pconv3,
      equipment_1 = pconv4,
      equipment_operator_1 = pconv7,
      equipment_2 = pconv5,
      equipment_operator_2 = pconv8,
      equipment_3 = pconv6,
      equipment_operator_3 = pconv9,
      escort1_id= pconv18,
      escort1_driver= pconv19,
      escort2_id= pconv21,
      escort2_driver= pconv22,
      support_truck_type= pconv24,
      support_truck_id = pconv25,
      support_truck_operator1 = pconv26,
      support_truck_operator2 = pconv27,
      passengers = pconv28,
      escort1_callsign = pconv31,
      escort2_callsign = pconv32,
      hose_connected = vconv33,
      commenced_fuel_load = vconv34,
      completed_fuel_load = vconv35,
      hose_disconnected = vconv36,
      fuel_operator_1 = pconv37,
      fuel_operator_2 = pconv38,
      fuel_operator_3 = pconv39,
      fuel_operator_4 = pconv40,
      fuel_operator_5 = pconv41,
      fuel_operator_6 = pconv42,
      loading = pconv43,
      loading_compiled_by = pconv44,
      masterplan = pconv45
    where
     rowid = chartorowid( replace(rid,'~','+') );
   else
    update strang.ships_airway
     set
      manifest_reg = p16,
      status = nvl(p1a,'INCOMPLETE')
    where
     rowid = chartorowid( replace(rid,'~','+') );
   end if;
   -- If the Ship is Marked as COMPLETE then update all Movements to S which stands for SHIPPED
   if nvl(p1a,'INCOMPLETE') in ('COMPLETE','FINAL','CUSTOMS COMPLETE')
    then
     update strang.movements
      set
       complete = 'S'
     where
      ship_id = c2rec.ship_id;
    end if;
   if nvl(p1a,'INCOMPLETE') = 'INCOMPLETE'
    then
     update strang.movements
      set
       complete = 'W'
     where
      ship_id = c2rec.ship_id and
      complete = 'S';
    end if;
    if nvl(p1a,'INCOMPLETE') in ('FINAL') and nvl(c2rec.status,'INCOMPLETE') not in ('FINAL')
     then
      generate_ost256( surl, c2rec.ship_id );
      generate_ost156( surl, c2rec.ship_id );
      generate_ost157( surl, c2rec.ship_id );
      generate_ccdets( surl, c2rec.ship_id );
      generate_ccpo( surl, c2rec.ship_id );
      -- populate tracking_header and tracking_details
      generate_containers( c2rec.ship_id );
    end if;
    if nvl(c2rec.status,'INCOMPLETE') in ('FINAL') and nvl(p1a,'INCOMPLETE') not in ('FINAL')
     then
      delete from strang.tracking_details where upper(ship) = upper(c2rec.shipname) and upper(voyage) = upper(c2rec.voy);
    end if;
 end if;

 commit;

 if access_id = 'z'
  then
   shp( surl, newrid, scid, parm, 'x', 'New Record Successfully Inserted', vdef=>vdef, mtype=>mtype, rows_show=>rows_show, norder=>norder, n_local=>n_local, force_single_disp=>force_single_disp );
  else
   shp( surl, rid, scid, parm, access_id, nvl(e_msg,'Record Successfully Updated'), vdef=>vdef, mtype=>mtype, rows_show=>rows_show, norder=>norder, n_local=>n_local, force_single_disp=>force_single_disp );
 end if;
exception when others then
 error_details( 'STRANGP', 'ACCEPT_SHP',null,null,errmsg=>sqlerrm,extdet=>'PARM:' || parm);
end accept_shp;

/* 20140529 removed procedure shp2 & procedure accept_shp2 */

procedure entry_maintain(surl in varchar2, strt in varchar2, strt2 in varchar2 default null, rid in varchar2, vrecctr in varchar2, msg in varchar2 default null, force_single_disp in char default 'F', popup in char default 'F' )
as

 sts		varchar2(100);
 vaccess	varchar2(20);
 vste		varchar2(10);
 seclevel	varchar2(100);

begin
 if not dapi.init( surl, 'STRANGP.ENTRY_MAINTAIN', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'ENTRY_MAINTAIN');
    return;
 end if;

 vste := customer_state(dapi.GLOBAL_ACCOUNT.acctid);

 vaccess := data_access( 'ENTRY_MAINTAIN' );
 seclevel := security_role( dapi.GLOBAL_ACCOUNT.acctid );

 main_title( 'Choose Entry Number',helpid=>'STR13',dispmenu=>FALSE);

 header_msg( nvl(msg,'Entry Maintain') );

 htp.p( '<CENTER>' );
 if vaccess = 'NONE' then htp.bold( 'Access Denied' ); htp.htmlclose; return; end if;

 htp.formopen( 'strangp.entry_maintain_mass' );
 htp.formhidden( 'SURL', surl );
 htp.formhidden( 'RID', rid );
 htp.formhidden( 'VRECCTR', vrecctr );
 htp.formhidden( 'PK1', NULL );
 htp.formhidden( 'PK2', NULL );
 htp.formhidden( 'PK3', NULL );
 htp.formhidden( 'V1', NULL );
 htp.formhidden( 'V1i', NULL );
 htp.formhidden( 'V8i', NULL );
 htp.formhidden( 'V8ii', NULL );
 htp.formhidden( 'V2', NULL );
 htp.formhidden( 'V3', NULL );
 htp.formhidden( 'V4', NULL );
 htp.formhidden( 'V5', NULL );
 htp.formhidden( 'V6', NULL );
 htp.formhidden( 'V7', NULL );
 htp.formhidden( 'V8', NULL );
 htp.formhidden( 'ERRMSG', NULL );
   htp.formhidden( 'FORCE_SINGLE_DISP', force_single_disp);
   htp.formhidden( 'POPUP', popup);
 htp.nl;
 htp.tableopen( cattributes=>'class="str1_table"' );
  if strt is NULL
   then
    htp.tablerowopen;
       htp.tabledata( htf.bold('Entry From'),cattributes=>'class="str1_bg_right"');
       htp.tabledata( htf.formtext('P1',20,30),cattributes=>'class="str1_bg_left"');
    htp.tablerowclose;
    htp.tablerowopen;
       htp.tabledata( htf.bold('Entry To'),cattributes=>'class="str1_bg_right"');
       htp.tabledata( htf.formtext('P2',20,30),cattributes=>'class="str1_bg_left"');
    htp.tablerowclose;
  else
    htp.tablerowopen;
       htp.tabledata( htf.bold('Entry From'),cattributes=>'class="str1_bg_right"');
       htp.tabledata( htf.formtext('P1',20,30, strang.ent.get_entry_no(strt)),cattributes=>'class="str1_bg_left"');
    htp.tablerowclose;
    htp.tablerowopen;
       htp.tabledata( htf.bold('Entry To'),cattributes=>'class="str1_bg_right"');
       htp.tabledata( htf.formtext('P2',20,30, strang.ent.get_entry_no(nvl(strt2, strt))),cattributes=>'class="str1_bg_left"');
    htp.tablerowclose;
  end if;
 htp.tableclose;
 htp.nl;
 htp.tableopen( cattributes=>'cellpadding=2 cellspacing=2 border=0' );
  htp.tablerowopen;
   htp.tabledata( htf.formsubmit( null, 'Submit' ) || htf.formclose );
   if popup = 'T'
    then
   htp.tabledata( htf.formopen( 'strangp.receive', ctarget=>'_top' ) || htf.formhidden( 'SURL', surl ) || htf.formhidden( 'RID', replace(rid,'~','+') ) ||
                  htf.formhidden( 'SCID', NULL ) || htf.formhidden( 'VRECCTR', vrecctr ) || htf.formhidden( 'CALL_NAME', null ) || htf.formhidden( 'PARM', 'DETAILRS' ) || htf.formhidden( 'ACCESS_ID', 'x' ) || htf.formsubmit( null, 'Cancel', cattributes=>'onClick="self.close(); return;"' ) || htf.formclose );
    else
   htp.tabledata( htf.formopen( 'strangp.receive', ctarget=>'_top' ) || htf.formhidden( 'SURL', surl ) || htf.formhidden( 'RID', replace(rid,'~','+') ) ||
                  htf.formhidden( 'SCID', NULL ) || htf.formhidden( 'VRECCTR', vrecctr ) || htf.formhidden( 'CALL_NAME', null ) || htf.formhidden( 'PARM', 'DETAILRS' ) || htf.formhidden( 'ACCESS_ID', 'x' ) || htf.formsubmit( null, 'Cancel' ) || htf.formclose );
   end if;
  htp.tablerowclose;
 htp.tableclose;

 htp.nl;
   htp.nl;
 if popup = 'T' then htp.p('<a href="" onClick="self.close()">[Close Window]</a>'); end if;
 htp.p( '</CENTER>' );
 htp.htmlclose;
exception when others then
 error_details( 'STRANGP', 'ENTRY_MAINTAIN',null,null,errmsg=>sqlerrm,extdet=>'Strt:' || strt);
end entry_maintain;

procedure entry_maintain_mass(surl in varchar2, p1 in varchar2, p2 in varchar2, rid in varchar2, vrecctr in varchar2, pk1 in owa.vc_arr, pk2 in owa.vc_arr, pk3 in owa.vc_arr,
                              v1 in owa.vc_arr, v2 in owa.vc_arr, v3 in owa.vc_arr, v4 in owa.vc_arr, v5 in owa.vc_arr, v6 in owa.vc_arr, v7 in owa.vc_arr, v8 in owa.vc_arr, v1i in owa.vc_arr, v8i in owa.vc_arr, v8ii in owa.vc_arr, errmsg in owa.vc_arr, msg in varchar2 default null, force_single_disp in char default 'F', popup in char default 'F' )
as

 cursor c2(ent_from number, ent_to number) is
  select /*+ ALL_ROWS */ distinct dr.entry_no, p.deliveryno, p.recno, p.sap_delno, p.sap_delno_item, p.po, p.po_item_no, p.supinv, p.tamount, p.qty, p.unit_unitused, t.cola tunit, i.code,  i.description, i.cola cola
  from strang.lov i, strang.pos p, strang.detailrs dr, strang.lov t
  where dr.entry_no >= ent_from and
        dr.entry_no <= ent_to and
        dr.deliveryno = p.deliveryno and
        p.inventoryno = i.code and
        i.lov_name = 'INVENT' and
        t.lov_name = 'TARIFF' and
        t.code = i.cola
 union all
  select /*+ ALL_ROWS */ distinct dr.entry_no, p.deliveryno, p.recno, p.sap_delno, p.sap_delno_item, p.po, p.po_item_no, p.supinv, p.tamount, p.qty, p.unit_unitused, null tunit, i.code,  i.description, i.cola cola
  from strang.lov i, strang.pos p, strang.detailrs dr
  where dr.entry_no >= ent_from and
        dr.entry_no <= ent_to and
        dr.deliveryno = p.deliveryno and
        p.inventoryno = i.code and
        i.lov_name = 'INVENT' and
        (i.cola is null or i.cola not in (select t.code from strang.lov t where t.lov_name = 'TARIFF'))
 union all
  select /*+ ALL_ROWS */ distinct dr.entry_no, p.deliveryno, p.recno, p.sap_delno, p.sap_delno_item, p.po, p.po_item_no, p.supinv, p.tamount, p.qty, p.unit_unitused, null tunit, p.inventoryno code, null description, null cola
  from strang.pos p, strang.detailrs dr
  where dr.entry_no >= ent_from and
        dr.entry_no <= ent_to and
        dr.deliveryno = p.deliveryno and
        (p.inventoryno is null or p.inventoryno not in (select i.code from strang.lov i where i.lov_name = 'INVENT'))
order by 1,2,3;

 foundrec	boolean;
 sts		varchar2(100);
 vaccess	varchar2(20);
 vste		varchar2(10);
 seclevel	varchar2(100);
 ent_from	number;
 ent_to		number;
 stp		varchar2(1000);

 function vld( p_k1 in varchar2, p_k2 in varchar2, p_k3 in varchar2, fld in varchar2, defval in varchar2 )
  return varchar2
 as
 begin
  for j in pk1.first..pk1.last loop
   if pk1(j) = p_k1 and pk2(j) = p_k2 and pk3(j) = p_k3
    then
     if fld = 'ERRMSG'
      then
       return( errmsg(j) );
     elsif fld = 'V1'
      then
       stp := 'strang.f_sap_format - PO';
       return( strang.f_sap_format(v1(j),'PO') );
     elsif fld = 'V2'
      then
       return( v2(j) );
     elsif fld = 'V3'
      then
       return( v3(j) );
     elsif fld = 'V4'
      then
       return( v4(j) );
     elsif fld = 'V5'
      then
       return( v5(j) );
     elsif fld = 'V6'
      then
       stp := 'strang.f_sap_format - INVENTORYNO';
       return( strang.f_sap_format(v6(j),'INVENTORYNO') );
     elsif fld = 'V7'
      then
       return( v7(j) );
     elsif fld = 'V8'
      then
       return( v8(j) );
     elsif fld = 'V1i'
      then
       stp := 'strang.f_sap_format - DELIVERYNO';
       return( strang.f_sap_format(v1i(j),'DELIVERYNO') );
     elsif fld = 'V8i'
      then
       return( v8i(j) );
     elsif fld = 'V8ii'
      then
       return( v8ii(j) );
     end if;
   end if;
  end loop;
  return( defval );
 end vld;

begin
 if not dapi.init( surl, 'STRANGP.ENTRY_MAINTAIN_MASS', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'ENTRY_MAINTAIN_MASS');
    return;
 end if;

 if instr(p1, '.') > 0
  then
   stp := 'strang.ent.get_entry_no - P1';
   begin ent_from := to_number(strang.ent.get_entry_no(p1)); exception when others then entry_maintain( surl, p1, p2, rid, vrecctr, 'Entry From Number is not a Valid Number' ); return; end;
 else
   stp := 'strang.ent.get_entry_no - D';
   begin ent_from := to_number('1' || '.' || strang.ent.get_entry_no(p1, 'D')); exception when others then entry_maintain( surl, p1, p2, rid, vrecctr, 'Entry From Number is not a Valid Number' ); return; end;
 end if;
 if instr(p2, '.') > 0
  then
   stp := 'strang.ent.get_entry_no - P2';
   begin ent_to := to_number(strang.ent.get_entry_no(p2)); exception when others then entry_maintain( surl, p1, p2, rid, vrecctr, 'Entry To Number is not a Valid Number' ); return; end;
 else
   stp := 'strang.ent.get_entry_no - P2 D';
   begin ent_to := to_number('1' || '.' || strang.ent.get_entry_no(p2, 'D')); exception when others then entry_maintain( surl, p1, p2, rid, vrecctr, 'Entry To Number is not a Valid Number' ); return; end;
 end if;
 if ent_from <= 0 or ent_from > ent_to then entry_maintain( surl, p1, p2, rid, vrecctr, 'Entry Number Range is Invalid', force_single_disp=>force_single_disp, popup=>popup ); return; end if;


 vste := customer_state(dapi.GLOBAL_ACCOUNT.acctid);
 vaccess := data_access( 'ENTRY_MAINTAIN' );
 seclevel := security_role( dapi.GLOBAL_ACCOUNT.acctid );

 main_title( 'Entry Maintain Mass Edit',helpid=>'STR14',dispmenu=>FALSE);

 header_msg( nvl(msg,'Entry Maintain Mass Edit') );
   stp := 'St 8';

 htp.p( '<CENTER>' );
 if vaccess = 'NONE' then htp.bold( 'Access Denied' ); htp.htmlclose; return; end if;
 htp.bold( 'Entries From' || ':' || strang.ent.get_entry_no(ent_from) || '&nbsp;&nbsp;&nbsp;' || 'To' || ':' || strang.ent.get_entry_no(ent_to));
 htp.nl;

 htp.formopen( 'strangp.accept_entry_maintain_mass' );
 htp.formhidden( 'SURL', surl );
 htp.formhidden( 'RID', rid );
 htp.formhidden( 'VRECCTR', vrecctr );
 htp.formhidden( 'P1', ent_from );
 htp.formhidden( 'P2', ent_to );
   htp.formhidden( 'FORCE_SINGLE_DISP', force_single_disp);
   htp.formhidden( 'POPUP', popup);
 htp.nl;
 htp.tableopen( cattributes=>'class="str1_table"' );
  htp.tablerowopen;
    htp.tableheader( 'Entry No');
    htp.tableheader( 'Delivery No');
    htp.tableheader( 'PO Record No.');
    htp.tableheader( 'Purchase Order');
    htp.tableheader( 'PO Item');
    htp.tableheader( 'Supplier Invoice');
    htp.tableheader( 'Inventory Number');
    htp.tableheader( 'Description');
    htp.tableheader( 'Tariff');
    htp.tableheader( 'Quantity');
    htp.tableheader( 'Amount Orig Curr');
    htp.tableheader( 'Corrected Unit');
    htp.tableheader( 'Old Unit');
    htp.tableheader( 'Data Entry Validation Message');
  htp.tablerowclose;
  foundrec := FALSE;
   stp := 'St 9';
  for c2rec in c2(ent_from, ent_to) loop
   foundrec := TRUE;
   htp.tablerowopen;
    htp.tabledata( htf.formhidden( 'PK1', c2rec.entry_no ) || htf.bold(c2rec.entry_no),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formhidden( 'PK2', c2rec.deliveryno ) || htf.bold(c2rec.deliveryno),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formhidden( 'PK3', c2rec.recno ) || htf.bold(c2rec.recno),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formtext( 'V1',12,15,vld(c2rec.entry_no,c2rec.deliveryno,c2rec.recno,'V1',c2rec.po)),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formtext( 'V8ii',8,15,vld(c2rec.entry_no,c2rec.deliveryno,c2rec.recno,'V8ii',c2rec.po_item_no)) || htf.formhidden( 'V1i',vld(c2rec.entry_no,c2rec.deliveryno,c2rec.recno,'V1i',c2rec.sap_delno)) || htf.formhidden( 'V8i',vld(c2rec.entry_no,c2rec.deliveryno,c2rec.recno,'V8i',c2rec.sap_delno_item)),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formtext( 'V2',8,15,vld(c2rec.entry_no,c2rec.deliveryno,c2rec.recno,'V2',c2rec.supinv)),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formtext( 'V6',12,100,vld(c2rec.entry_no,c2rec.deliveryno,c2rec.recno,'V6',c2rec.code)),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formtext( 'V7',20,1000,nvl(vld(c2rec.entry_no,c2rec.deliveryno,c2rec.recno,'V7',c2rec.description),c2rec.description)),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formtext( 'V8',11,20,nvl(vld(c2rec.entry_no,c2rec.deliveryno,c2rec.recno,'V8',c2rec.cola),c2rec.cola)),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formtext( 'V4',5,10,vld(c2rec.entry_no,c2rec.deliveryno,c2rec.recno,'V4',c2rec.qty)),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formtext( 'V3',10,20,vld(c2rec.entry_no,c2rec.deliveryno,c2rec.recno,'V3',trim(to_char(c2rec.tamount,G_MONEY_FORMAT)))),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formtext( 'V5',5,8,vld(c2rec.entry_no,c2rec.deliveryno,c2rec.recno,'V5',c2rec.tunit)),cattributes=>'class="str1_bg_left"');
    htp.tabledata( nvl(c2rec.unit_unitused,'&nbsp;'),cattributes=>'class="str1_bg_left"');
    htp.tabledata( nvl(vld(c2rec.entry_no,c2rec.deliveryno,c2rec.recno,'ERRMSG','&nbsp;'),'Success'),cattributes=>'class="str1_bg_left"');
   htp.tablerowclose;
  end loop;
 htp.tableclose;
 htp.nl;
   stp := 'St 10';
 if not foundrec then htp.init; entry_maintain( surl, p1, p2, rid, vrecctr, 'No Entries found that Satisfy this Query', force_single_disp=>force_single_disp, popup=>popup ); return; end if;
 htp.tableopen( cattributes=>'cellpadding=2 cellspacing=2 border=0' );
  htp.tablerowopen;
   htp.tabledata( htf.formsubmit( null, 'Modify Data' ) || htf.formclose );
   if popup = 'T'
    then
   htp.tabledata( htf.formopen( 'strangp.receive', ctarget=>'_top' ) || htf.formhidden( 'SURL', surl ) || htf.formhidden( 'RID', replace(rid,'~','+') ) ||
                  htf.formhidden( 'SCID', NULL ) || htf.formhidden( 'VRECCTR', vrecctr ) || htf.formhidden( 'CALL_NAME', null ) || htf.formhidden( 'PARM', 'DETAILRS' ) || htf.formhidden( 'ACCESS_ID', 'x' ) || htf.formsubmit( null, 'Cancel', cattributes=>'onClick="self.close(); return;"' ) || htf.formclose );
    else
   htp.tabledata( htf.formopen( 'strangp.receive', ctarget=>'_top' ) || htf.formhidden( 'SURL', surl ) || htf.formhidden( 'RID', replace(rid,'~','+') ) ||
                  htf.formhidden( 'SCID', NULL ) || htf.formhidden( 'VRECCTR', vrecctr ) || htf.formhidden( 'CALL_NAME', null ) || htf.formhidden( 'PARM', 'DETAILRS' ) || htf.formhidden( 'ACCESS_ID', 'x' ) || htf.formsubmit( null, 'Cancel' ) || htf.formclose );
   end if;
  htp.tablerowclose;
 htp.tableclose;
 htp.nl;
   htp.nl;
 if popup = 'T' then htp.p('<a href="" onClick="self.close()">[Close Window]</a>'); end if;
 htp.p( '</CENTER>' );
 htp.htmlclose;
exception when others then
 error_details( 'STRANGP', 'ENTRY_MAINTAIN_MASS',null,null,errmsg=>sqlerrm,extdet=>'P1:' || p1 || '-' || 'P2:' || p2 || '[step=' || stp || ']');
end entry_maintain_mass;

procedure accept_entry_maintain_mass(surl in varchar2, p1 in varchar2, p2 in varchar2, rid in varchar2, vrecctr in varchar2, pk1 in owa.vc_arr, pk2 in owa.vc_arr, pk3 in owa.vc_arr,
                              v1 in owa.vc_arr, v2 in owa.vc_arr, v3 in owa.vc_arr, v4 in owa.vc_arr, v5 in owa.vc_arr, v6 in owa.vc_arr, v7 in owa.vc_arr, v8 in owa.vc_arr, v1i in owa.vc_arr, v8i in owa.vc_arr, v8ii in owa.vc_arr, force_single_disp in char default 'F', popup in char default 'F' )
as

 cursor c3(lname varchar2, lcode varchar2) is select * from strang.lov where lov_name = lname and code = lcode;


 c3rec		c3%ROWTYPE;

 sts		varchar2(100);
 vaccess	varchar2(20);
 vste		varchar2(10);
 errmsg		owa.vc_arr;
 errfound	boolean;
 dupl_values	boolean;
 errunit	char(1);
 msg		varchar2(1000);
 nmb1		STRANG.POS.TAMOUNT%TYPE;
 nmb2		STRANG.POS.QTY%TYPE;
 oinv		STRANG.POS.INVENTORYNO%TYPE;
 dupctr_a	integer;
 dupctr_b	integer;
 tmp		number;
 tmp2		number;

begin
 if not dapi.init( surl, 'STRANGP.ACCEPT_ENTRY_MAINTAIN_MASS', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'ACCEPT_ENTRY_MAINTAIN_MASS');
    return;
 end if;

 vste := customer_state(dapi.GLOBAL_ACCOUNT.acctid);
 vaccess := data_access( 'ENTRY_MAINTAIN' );
 if vaccess = 'NONE' then htp.bold( 'Access Denied' ); htp.htmlclose; return; end if;

 errfound := FALSE;

 for j in pk1.first..pk1.last loop
  errmsg(j) := NULL;
  if pk1(j) is not null
   then
    -- Validate Numbers Entered
    begin
      nmb1 := to_number( replace(replace(v3(j),',',''),'$','') );
    exception when others then
     begin
       nmb1 := to_number( v3(j), G_MONEY_FORMAT );
      exception when others then
       errfound := TRUE;
       errmsg(j) := errmsg(j) || ' ' || 'Invalid Total Amount Entered.';
       nmb1 := NULL;
     end;
    end;
    begin
      nmb2 := to_number( v4(j) );
      if nmb2 < 0
       then
        errfound := TRUE;
        errmsg(j) := errmsg(j) || ' ' || 'Quantity cannot be less than 0.';
        nmb2 := NULL;
      end if;
      exception when others then
       errfound := TRUE;
       errmsg(j) := errmsg(j) || ' ' || 'Invalid Quantity Entered.';
       nmb2 := NULL;
    end;

    oinv := trim( v6(j) );

    if v1(j) is null
     then
       errfound := TRUE;
       errmsg(j) := errmsg(j) || ' ' || 'Purchase Order cannot be blank.';
    end if;

    if v8ii(j) is null
     then
       errfound := TRUE;
       errmsg(j) := errmsg(j) || ' ' || 'PO Item cannot be blank.';
    end if;

    if v2(j) is null
     then
       errfound := TRUE;
       errmsg(j) := errmsg(j) || ' ' || 'Supplier Invoice cannot be blank.';
    end if;

    -- Check Unit
    c3rec.code := NULL;
    errunit := 'F';
    if v5(j) is not null
     then
      open c3( 'UNITS', upper(v5(j)));
      fetch c3 into c3rec;
      if c3%NOTFOUND
       then
        close c3;
        errfound := TRUE;
        errmsg(j) := errmsg(j) || ' ' || 'Incorrect Current Unit.';
       else
        errunit := 'T';
        close c3;
      end if;
    end if;

    -- 'Update Purchase Order'
    update strang.pos
     set
      sap_delno = nvl(strang.f_sap_format(v1i(j),'DELIVERYNO'),sap_delno),
      sap_delno_item = nvl(v8i(j),sap_delno_item),
      po = nvl(strang.f_sap_format(v1(j),'PO'),po),
      po_item_no = nvl(v8ii(j),po_item_no),
      supinv = nvl(v2(j),supinv),
      tamount = nvl(nmb1,tamount),
      qty = nvl(nmb2,qty),
      unit_unitused = decode(errunit,'F',upper(v5(j)),'T',unit_unitused),
      inventoryno = nvl(strang.f_sap_format(oinv,'INVENTORYNO'),inventoryno)
    where
     deliveryno = pk2(j) and
     recno = pk3(j);


    -- 'Update Purchase Order' Quantities for new Form 15  19-Apr-07 %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

    if v5(j) = 'KG' or v5(j) = 'TONNE'
    then

     if v5(j) = 'KG'
       then
        tmp2 := null;
        select sum(nvl(partweight,0)) into tmp2 from strang.detailrs where deliveryno=pk2(j);
        select count('x') into tmp from strang.pos where deliveryno = pk2(j);
        tmp2 := round(tmp2/tmp,0);
        if tmp2 < 1
         then
          tmp2 := 1;
        end if;
     elsif v5(j) = 'TONNE'
      then
        tmp2 := null;
        select sum(nvl(partweight,0)) into tmp2 from strang.detailrs where deliveryno=pk2(j);
        select count('x') into tmp from strang.pos where deliveryno = pk2(j);
        tmp2 := round((tmp2/tmp)/1000,3);
        if tmp2 < 0.001
         then
         tmp2 := 0.001;
        end if;

     end if;
     update strang.pos
      set
      qty = tmp2
     where
      deliveryno = pk2(j) and
      recno = pk3(j);
    end if;


    -- Check if Inventory Exists
    if oinv is not null
     then

      -- Check if multiple inventory numbers have been entered, and if
      dupl_values := FALSE;
      dupctr_a := 0;
      dupctr_b := 0;
      for k in pk1.first..pk1.last loop
       if oinv is not null and trim(v6(k)) is not null and oinv = trim(v6(k))
        then
         -- Check if the Description is different and not null
         if trim(v7(j)) is not null and trim(v7(k)) is not null and trim(v7(j)) <> trim(v7(k))
          then
           dupctr_a := dupctr_a + 1;
         end if;
         -- Check if the Tariff number is different and not null
         if trim(v8(j)) is not null and trim(v8(k)) is not null and trim(v8(j)) <> trim(v8(k))
          then
           dupctr_b := dupctr_b + 1;
         end if;
       end if;
      end loop;

      if dupctr_a > 0
       then
        errmsg(j) := errmsg(j) || ' ' || 'Different descriptions exist for the same Inventory Number.';
        dupl_values := TRUE;
      end if;

      if dupctr_b > 0
       then
        errmsg(j) := errmsg(j) || ' ' || 'Different Tariff Numbers exist for the same Inventory Number.';
        dupl_values := TRUE;
      end if;

      if dupl_values
       then
        --
        errfound := TRUE;

       else
        open c3('INVENT',v6(j));
        fetch c3 into c3rec;
        if c3%FOUND
         then
          close c3;
          update strang.lov
           set
            description = nvl(v7(j),description)
          where
           lov_name = 'INVENT' and
           code = oinv;
         else
          close c3;
          insert into strang.lov(lov_name,code,description,cola) values ('INVENT',v6(j),v7(j),v8(j));
        end if;
      end if;

      -- Check if Tariff Exists
      if v8(j) is null
       then
        null;
       else
        open c3('TARIFF',v8(j));
        fetch c3 into c3rec;
        if c3%FOUND
         then
          close c3;
          update strang.lov
           set
            cola = v8(j)
          where
           lov_name = 'INVENT' and
           code = oinv;
         else
          close c3;
          errfound := TRUE;
          errmsg(j) := errmsg(j) || ' ' || 'Tariff value not found - ' || htf.anchor2( 'strangp.accept_lov?surl=' || surl || '&parm=TARIFF&SRC=&LRANGE=&P0=&P1=&P2=&P3=&P4=&P5=&ACTION=' || replace('Insert New Values',' ','+'),'Insert New Tariff.', ctarget=>'INSWIND');
        end if;
      end if;
    end if;

  end if;
 end loop;
 commit;
 if errfound then msg := 'Errors found Modifying Data. Please Review each Entry Record to see what the Error was.'; end if;

 entry_maintain_mass(surl, p1, p2, rid,vrecctr, pk1, pk2, pk3, v1, v2, v3, v4, v5, v6, v7, v8, v1i, v8i, v8ii, errmsg, msg, force_single_disp=>force_single_disp, popup=>popup );

exception when others then
 error_details( 'STRANGP', 'ACCEPT_ENTRY_MAINTAIN_MASS',null,null,errmsg=>sqlerrm,extdet=>'P1:' || p1 || '-' || 'P2:' || p2);
end accept_entry_maintain_mass;

-- xxxxxx 20160615
procedure po_inventory_maintain(surl in varchar2, strt in varchar2, rid in varchar2, vrecctr in varchar2, msg in varchar2 default null, force_single_disp in char default 'F', popup in char default 'F' )
as

 vaccess	varchar2(20);

 sts		varchar2(100);
 vste		varchar2(10);
 seclevel	varchar2(100);

begin
 if not dapi.init( surl, 'STRANGP.PO_INVENTORY_MAINTAIN', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'PO_INVENTORY_MAINTAIN');
    return;
 end if;

 vste := customer_state(dapi.GLOBAL_ACCOUNT.acctid);
 vaccess := data_access( 'POS' );
 seclevel := security_role( dapi.GLOBAL_ACCOUNT.acctid );

 main_title( 'Choose Inventory Number',helpid=>'STR15',dispmenu=>FALSE);

 header_msg( nvl(msg,'Update By Inventory') );

 htp.p( '<CENTER>' );
 if vaccess = 'NONE' then htp.bold( 'Access Denied' ); htp.htmlclose; return; end if;

 htp.formopen( 'strangp.poinventory_maintain_mass' );
 htp.formhidden( 'SURL', surl );
 htp.formhidden( 'RID', rid );
 htp.formhidden( 'VRECCTR', vrecctr );
 htp.formhidden( 'PK2', NULL );
 htp.formhidden( 'PK3', NULL );
 htp.formhidden( 'V1', NULL );
 htp.formhidden( 'V2', NULL );
 htp.formhidden( 'V9', NULL );
 htp.formhidden( 'V1i', NULL );
 htp.formhidden( 'V8i', NULL );
 htp.formhidden( 'V3_1', NULL );
 htp.formhidden( 'V3_1_1', NULL );
 htp.formhidden( 'V3_2', NULL );
 htp.formhidden( 'V3', NULL );
 htp.formhidden( 'V4', NULL );
 htp.formhidden( 'V5', NULL );
 htp.formhidden( 'V6', NULL );
 htp.formhidden( 'V7', NULL );
 htp.formhidden( 'V8', NULL );
 htp.formhidden( 'ERRMSG', NULL );
   htp.formhidden( 'FORCE_SINGLE_DISP', force_single_disp);
   htp.formhidden( 'POPUP', popup);
 htp.nl;
 htp.tableopen( cattributes=>'class="str1_table"' );
  htp.tablerowopen;
     htp.tabledata( htf.bold('Inventory Number'),cattributes=>'class="str1_bg_right"');
     htp.tabledata( htf.formtext('P1',20,30, ''),cattributes=>'class="str1_bg_left"');
  htp.tablerowclose;
 htp.tableclose;
 htp.nl;
 htp.tableopen( cattributes=>'cellpadding=2 cellspacing=2 border=0' );
  htp.tablerowopen;
   htp.tabledata( htf.formsubmit( null, 'Submit' ) || htf.formclose );
   if popup = 'T'
    then
   htp.tabledata( htf.formopen( 'strangp.receive', ctarget=>'_top' ) || htf.formhidden( 'SURL', surl ) || htf.formhidden( 'RID', replace(rid,'~','+') ) ||
                  htf.formhidden( 'SCID', NULL ) || htf.formhidden( 'VRECCTR', vrecctr ) || htf.formhidden( 'CALL_NAME', null ) || htf.formhidden( 'PARM', 'DETAILRS' ) || htf.formhidden( 'ACCESS_ID', 'x' ) || htf.formsubmit( null, 'Cancel', cattributes=>'onClick="self.close(); return;"' ) || htf.formclose );
    else
   htp.tabledata( htf.formopen( 'strangp.receive', ctarget=>'_top' ) || htf.formhidden( 'SURL', surl ) || htf.formhidden( 'RID', replace(rid,'~','+') ) ||
                  htf.formhidden( 'SCID', NULL ) || htf.formhidden( 'VRECCTR', vrecctr ) || htf.formhidden( 'CALL_NAME', null ) || htf.formhidden( 'PARM', 'DETAILRS' ) || htf.formhidden( 'ACCESS_ID', 'x' ) || htf.formsubmit( null, 'Cancel' ) || htf.formclose );
   end if;
  htp.tablerowclose;
 htp.tableclose;

 htp.nl;
 htp.nl;
 if popup = 'T' then htp.p('<a href="" onClick="self.close()">[Close Window]</a>'); end if;
 htp.p( '</CENTER>' );
 htp.htmlclose;
exception when others then
 error_details( 'STRANGP', 'po_inventory_MAINTAIN',null,null,errmsg=>sqlerrm,extdet=>'Strt:' || strt);
end po_inventory_maintain;

procedure poinventory_maintain_mass(surl in varchar2, p1 in varchar2, rid in varchar2, vrecctr in varchar2, pk2 in owa.vc_arr, pk3 in owa.vc_arr,
                              v1 in owa.vc_arr, v2 in owa.vc_arr, v9 in owa.vc_arr, v3_1 in owa.vc_arr, v3_1_1 in owa.vc_arr, v3_2 in owa.vc_arr, v3 in owa.vc_arr, v4 in owa.vc_arr, v5 in owa.vc_arr, v6 in owa.vc_arr, v7 in owa.vc_arr, v8 in owa.vc_arr, v1i in owa.vc_arr, v8i in owa.vc_arr, errmsg in owa.vc_arr, msg in varchar2 default null, force_single_disp in char default 'F', popup in char default 'F' )
as

 cursor c2(inventno varchar2) is
  select /*+ ALL_ROWS */ distinct p.deliveryno, p.recno, p.sap_delno, p.sap_delno_item,p.po, p.po_item_no, p.supinv, p.grn, p.amount, p.gstc_gstcode, p.gst, p.tamount, p.qty, p.unit_unitused, i.code,  i.description
  from strang.lov i, strang.pos p
  where p.inventoryno = inventno and
        p.inventoryno = i.code and
        i.lov_name = 'INVENT' and
        p.sap_delno is null
 union all
  select /*+ ALL_ROWS */ distinct p.deliveryno, p.recno, p.sap_delno, p.sap_delno_item, p.po, p.po_item_no, p.supinv, p.grn, p.amount, p.gstc_gstcode, p.gst, p.tamount, p.qty, p.unit_unitused, p.inventoryno code, null description
  from strang.pos p
  where p.inventoryno = inventno and
        p.sap_delno is null and
       ( p.inventoryno not in (select i.code from strang.lov i where i.lov_name = 'INVENT'))
order by 1,2,3;

 foundrec	boolean;
 sts		varchar2(100);
 vaccess	varchar2(20);
 vste		varchar2(10);
 seclevel	varchar2(100);
 inventno	integer;

 function vld( p_k2 in varchar2, p_k3 in varchar2, fld in varchar2, defval in varchar2 )
  return varchar2
 as
 begin
  for j in pk2.first..pk2.last loop
   if pk2(j) = p_k2 and pk3(j) = p_k3
    then
     if fld = 'ERRMSG'
      then
       return( errmsg(j) );
     elsif fld = 'V1'
      then
       return( strang.f_sap_format(v1(j),'PO') );
     elsif fld = 'V1i'
      then
       return( strang.f_sap_format(v1i(j),'DELIVERYNO') );
     elsif fld = 'V2'
      then
       return( v2(j) );
     elsif fld = 'V3_1'
      then
       return( v3_1(j) );
     elsif fld = 'V3_1_1'
      then
       return( v3_1_1(j) );
     elsif fld = 'V3_2'
      then
       return( v3_2(j) );
     elsif fld = 'V3'
      then
       return( v3(j) );
     elsif fld = 'V4'
      then
       return( v4(j) );
     elsif fld = 'V5'
      then
       return( v5(j) );
     elsif fld = 'V6'
      then
       return( strang.f_sap_format(v6(j),'INVENTORYNO') );
     elsif fld = 'V7'
      then
       return( v7(j) );
     elsif fld = 'V8'
      then
       return( v8(j) );
     elsif fld = 'V8i'
      then
       return( v8i(j) );
     elsif fld = 'V9'
      then
       return( strang.f_sap_format(v9(j),'GRN') );
     end if;
   end if;
  end loop;
  return( defval );
 end vld;

begin
 if not dapi.init( surl, 'STRANGP.POINVENTORY_MAINTAIN_MASS', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'POINVENTORY_MAINTAIN_MASS');
    return;
 end if;

 begin inventno := to_char(p1); exception when others then po_inventory_maintain( surl, p1, rid, vrecctr, 'Inventory Number is not a Valid', force_single_disp=>force_single_disp, popup=>popup ); return; end;

 vste := customer_state(dapi.GLOBAL_ACCOUNT.acctid);
 vaccess := data_access( 'PO_INVENTORY_MAINTAIN' );
 seclevel := security_role( dapi.GLOBAL_ACCOUNT.acctid );

 main_title( 'PO Inventory Maintain Mass Edit',helpid=>'STR16',dispmenu=>FALSE);

 header_msg( nvl(msg,'PO Inventory Maintain Mass Edit') );

 htp.p( '<CENTER>' );
 if vaccess = 'NONE' then htp.bold( 'Access Denied' ); htp.htmlclose; return; end if;
 htp.bold( 'Inventory Number' || ':' || to_char(inventno));
 htp.nl;

 htp.formopen( 'strangp.accept_poinvent_maintain_mass' );
 htp.formhidden( 'SURL', surl );
 htp.formhidden( 'RID', rid );
 htp.formhidden( 'VRECCTR', vrecctr );
 htp.formhidden( 'P1', p1 );
   htp.formhidden( 'FORCE_SINGLE_DISP', force_single_disp);
   htp.formhidden( 'POPUP', popup);
 htp.nl;
 htp.tableopen( cattributes=>'class="str1_table"' );
  htp.tablerowopen;
    htp.tableheader( 'Delivery No');
    htp.tableheader( 'RecNo');
--    htp.tableheader( 'OTML Delno');
--    htp.tableheader( 'OTML Line');
    htp.tableheader( 'Purchase Order');
    htp.tableheader( 'PO Item');
    htp.tableheader( 'Supplier Inv');
    htp.tableheader( 'Goods Receipt');
    htp.tableheader( 'Net Amount');
    htp.tableheader( 'GST Code');
    htp.tableheader( 'GST');
    htp.tableheader( 'Total Amount');
    htp.tableheader( 'Qty');
    htp.tableheader( 'Unit');
    htp.tableheader( 'Inventory');
    htp.tableheader( 'Description');
    htp.tableheader( 'Data Entry Validation Message');
  htp.tablerowclose;
  foundrec := FALSE;
  for c2rec in c2(inventno) loop
   foundrec := TRUE;
   htp.tablerowopen;
    htp.tabledata( htf.formhidden( 'PK2', c2rec.deliveryno ) || htf.bold(c2rec.deliveryno),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formhidden( 'PK3', c2rec.recno ) || htf.bold(c2rec.recno) || htf.formhidden( 'V1i',vld(c2rec.deliveryno,c2rec.recno,'V1i',c2rec.sap_delno)) || htf.formhidden( 'V8i',vld(c2rec.deliveryno,c2rec.recno,'V8i',c2rec.sap_delno_item)),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formtext( 'V1',12,15,vld(c2rec.deliveryno,c2rec.recno,'V1',c2rec.po)),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formtext( 'V8',5,10,vld(c2rec.deliveryno,c2rec.recno,'V8',c2rec.po_item_no)),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formtext( 'V2',8,15,vld(c2rec.deliveryno,c2rec.recno,'V2',c2rec.supinv)),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formtext( 'V9',12,15,vld(c2rec.deliveryno,c2rec.recno,'V9',c2rec.grn)),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formtext( 'V3_1',10,20,vld(c2rec.deliveryno,c2rec.recno,'V3_1',trim(to_char(c2rec.amount,G_MONEY_FORMAT)))),cattributes=>'class="str1_bg_left"');
     htp.p( '<TD ' || 'class="str1_cell_left">' );
     lov_list( 'GSTCODES', 'V3_1_1', c2rec.gstc_gstcode, TRUE, FALSE, FALSE, isedit=>TRUE );
     htp.p( '</TD>' );
    htp.tabledata( htf.formtext( 'V3_2',10,20,vld(c2rec.deliveryno,c2rec.recno,'V3_2',trim(to_char(c2rec.gst,G_MONEY_FORMAT)))),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formtext( 'V3',10,20,vld(c2rec.deliveryno,c2rec.recno,'V3',trim(to_char(c2rec.tamount,G_MONEY_FORMAT)))),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formtext( 'V4',10,12,vld(c2rec.deliveryno,c2rec.recno,'V4',c2rec.qty)),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formtext( 'V5',5,8,vld(c2rec.deliveryno,c2rec.recno,'V5',c2rec.unit_unitused)),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formtext( 'V6',12,100,vld(c2rec.deliveryno,c2rec.recno,'V6',c2rec.code)),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formtext( 'V7',20,1000,nvl(vld(c2rec.deliveryno,c2rec.recno,'V7',c2rec.description),c2rec.description)),cattributes=>'class="str1_bg_left"');
    htp.tabledata( nvl(vld(c2rec.deliveryno,c2rec.recno,'ERRMSG','&nbsp;'),'Success'),cattributes=>'class="str1_bg_left"');
   htp.tablerowclose;
  end loop;
 htp.tableclose;
 htp.nl;
 if not foundrec then htp.init; po_inventory_maintain( surl, p1, rid, vrecctr, 'No Records found that Satisfy this Query', force_single_disp=>force_single_disp, popup=>popup ); return; end if;
 htp.tableopen( cattributes=>'cellpadding=2 cellspacing=2 border=0' );
  htp.tablerowopen;
   htp.tabledata( htf.formsubmit( null, 'Modify Data' ) || htf.formclose );
   if popup = 'T'
    then
   htp.tabledata( htf.formopen( 'strangp.receive', ctarget=>'_top' ) || htf.formhidden( 'SURL', surl ) || htf.formhidden( 'RID', replace(rid,'~','+') ) ||
                  htf.formhidden( 'SCID', NULL ) || htf.formhidden( 'VRECCTR', vrecctr ) || htf.formhidden( 'CALL_NAME', null ) || htf.formhidden( 'PARM', 'DETAILRS' ) || htf.formhidden( 'ACCESS_ID', 'x' ) || htf.formsubmit( null, 'Cancel', cattributes=>'onClick="self.close(); return;"' ) || htf.formclose );
    else
   htp.tabledata( htf.formopen( 'strangp.receive', ctarget=>'_top' ) || htf.formhidden( 'SURL', surl ) || htf.formhidden( 'RID', replace(rid,'~','+') ) ||
                  htf.formhidden( 'SCID', NULL ) || htf.formhidden( 'VRECCTR', vrecctr ) || htf.formhidden( 'CALL_NAME', null ) || htf.formhidden( 'PARM', 'DETAILRS' ) || htf.formhidden( 'ACCESS_ID', 'x' ) || htf.formsubmit( null, 'Cancel' ) || htf.formclose );
   end if;
  htp.tablerowclose;
 htp.tableclose;
 htp.nl;
 htp.nl;
 if popup = 'T' then htp.bold( '<a href="" onClick="self.close()">' || LNG.GLB_TXT_033 || '</a>'); htp.nl; end if;
 htp.p( '</CENTER>' );
 htp.htmlclose;
exception when others then
 error_details( 'STRANGP', 'poinventory_MAINTAIN_MASS',null,null,errmsg=>sqlerrm,extdet=>'P1:' || p1 );
end poinventory_maintain_mass;

procedure accept_poinvent_maintain_mass(surl in varchar2, p1 in varchar2, rid in varchar2, vrecctr in varchar2, pk2 in owa.vc_arr, pk3 in owa.vc_arr,
                              v1 in owa.vc_arr, v2 in owa.vc_arr, v9 in owa.vc_arr, v3_1 in owa.vc_arr, v3_1_1 in owa.vc_arr,v3_2 in owa.vc_arr,v3 in owa.vc_arr, v4 in owa.vc_arr, v5 in owa.vc_arr, v6 in owa.vc_arr, v7 in owa.vc_arr, v8 in owa.vc_arr, v1i in owa.vc_arr, v8i in owa.vc_arr, force_single_disp in char default 'F', popup in char default 'F' )
as

 cursor c3(lname varchar2, lcode varchar2) is select * from strang.lov where lov_name = lname and code = lcode;
 cursor c5( cde varchar2 ) is select to_number(cola) cola, colb from strang.lov where lov_name = 'GSTCODES' and code = cde;


 c3rec		c3%ROWTYPE;
 c5rec		c5%ROWTYPE;

 sts		varchar2(100);
 vaccess	varchar2(20);
 vste		varchar2(10);
 errmsg		owa.vc_arr;
 errfound	boolean;
 dupl_values	boolean;
 errunit	char(1);
 msg		varchar2(1000);
 nmb1_1		STRANG.POS.AMOUNT%TYPE;
 nmb1_2		STRANG.POS.GST%TYPE;
 nmb1		STRANG.POS.TAMOUNT%TYPE;
 nmb2		STRANG.POS.QTY%TYPE;
 nmb3		STRANG.POS.GRN%TYPE;
 oinv		STRANG.POS.INVENTORYNO%TYPE;
 dupctr_a	integer;
 dupctr_b	integer;
 tmp		number;
 tmp2		number;
 vmsg   varchar2(100);

begin
 if not dapi.init( surl, 'STRANGP.ACCEPT_ENTRY_MAINTAIN_MASS', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'ACCEPT_ENTRY_MAINTAIN_MASS');
    return;
 end if;

 vste := customer_state(dapi.GLOBAL_ACCOUNT.acctid);
 vaccess := data_access( 'PO_INVENTORY_MAINTAIN' );
 if vaccess = 'NONE' then htp.bold( 'Access Denied' ); htp.htmlclose; return; end if;

 errfound := FALSE;

 for j in pk2.first..pk2.last loop
  errmsg(j) := NULL;
  if pk2(j) is not null
   then
    -- Validate Numbers Entered
    begin
      nmb1_1 := to_number( replace(replace(v3_1(j),',',''),'$','') );
    exception when others then
     begin
       nmb1_1 := to_number( v3_1(j), G_MONEY_FORMAT );
      exception when others then
       errfound := TRUE;
       errmsg(j) := errmsg(j) || ' ' || 'Invalid Net Amount Entered.';
       nmb1 := NULL;
     end;
    end;
    begin
      nmb1_2 := to_number( replace(replace(v3_2(j),',',''),'$','') );
    exception when others then
     begin
       nmb1_2 := to_number( v3_2(j), G_MONEY_FORMAT );
      exception when others then
       errfound := TRUE;
       errmsg(j) := errmsg(j) || ' ' || 'Invalid GST Amount Entered.';
       nmb1 := NULL;
     end;
    end;
    begin
      nmb1 := to_number( replace(replace(v3(j),',',''),'$','') );
    exception when others then
     begin
       nmb1 := to_number( v3(j), G_MONEY_FORMAT );
      exception when others then
       errfound := TRUE;
       errmsg(j) := errmsg(j) || ' ' || 'Invalid Total Amount Entered.';
       nmb1 := NULL;
     end;
    end;
    begin
      nmb2 := to_number( v4(j) );
      if nmb2 < 0
       then
        errfound := TRUE;
        errmsg(j) := errmsg(j) || ' ' || 'Quantity cannot be less than 0.';
        nmb2 := NULL;
      end if;
      exception when others then
       errfound := TRUE;
       errmsg(j) := errmsg(j) || ' ' || 'Invalid Quantity Entered.';
       nmb2 := NULL;
    end;
    begin
      nmb2 := to_number( v1i(j) );
      exception when others then
       errfound := TRUE;
       errmsg(j) := errmsg(j) || ' ' || 'Invalid SAP Delno Entered.';
       nmb2 := NULL;
    end;
    begin
      nmb2 := to_number( v8i(j) );
      exception when others then
       errfound := TRUE;
       errmsg(j) := errmsg(j) || ' ' || 'Invalid SAP Line Entered.';
       nmb2 := NULL;
    end;
    begin
      nmb3 := to_number( v9(j) );
      exception when others then
       errfound := TRUE;
       errmsg(j) := errmsg(j) || ' ' || 'Invalid GRN Entered.';
       nmb3 := NULL;
    end;

    oinv := trim( v6(j) );

    if v1(j) is null
     then
       errfound := TRUE;
       errmsg(j) := errmsg(j) || ' ' || 'Purchase Order cannot be blank.';
    end if;

    if v2(j) is null
     then
       errfound := TRUE;
       errmsg(j) := errmsg(j) || ' ' || 'Supplier Invoice cannot be blank.';
    end if;

    -- Check Unit
    c3rec.code := NULL;
    errunit := 'F';
    if v5(j) is not null
     then
      open c3( 'UNITS', upper(v5(j)));
      fetch c3 into c3rec;
      if c3%NOTFOUND
       then
        close c3;
        errfound := TRUE;
        errmsg(j) := errmsg(j) || ' ' || 'Incorrect Unit.';
        errunit := 'T';
       else
        close c3;
      end if;
    end if;

    -- Check and calculate gst and totalamount

    if nmb1_1 is not null
     then
     if nmb1_2 is null and nmb1 is null
     then
      open c5(v3_1_1(j));
      fetch c5 into c5rec;
      close c5;
      if to_number(c5rec.cola) = 0
      then
        nmb1_2 := 0 ;
        nmb1 := nmb1_1 ;
      else
        if c5rec.colb = 'Inc GST' then
          nmb1_2 := c5rec.cola;
          nmb1 := nmb1_1;
          nmb1_1 := ((100 * nmb1) / (100 + nvl(nmb1_2,0) ));
          nmb1_2 := nmb1_1 * (c5rec.cola/100);
        else
          nmb1_2 := c5rec.cola;
          nmb1 := nmb1_1 * (1 + (nmb1_2/100));
          nmb1_2 := nmb1_1 * (c5rec.cola/100);
        end if;
      end if;
     end if;
    end if;

    -- 'Update Purchase Order'
    update strang.pos
     set
      po = nvl(strang.f_sap_format( v1(j), 'PO' ),po),
      po_item_no = nvl(to_number( v8(j) ),null),
      sap_delno = nvl(strang.f_sap_format( v1i(j), 'DELIVERYNO' ),null),
      sap_delno_item = nvl(to_number( v8i(j) ),null),
      supinv = nvl(v2(j),supinv),
      grn = nvl(strang.f_sap_format( v9(j), 'GRN' ),null),
      amount = nvl(nmb1_1,amount),
      gstc_gstcode = nvl(v3_1_1(j),gstc_gstcode),
      gst = nvl(nmb1_2,gst),
      tamount = nvl(nmb1,tamount),
      qty = nvl(to_number(v4(j)),qty),
      unit_unitused = decode(errunit,'F',upper(v5(j)),'T',unit_unitused),
      inventoryno = nvl(strang.f_sap_format( oinv, 'INVENTORYNO'),inventoryno)
--      inventoryno = nvl(oinv,inventoryno)
    where
     deliveryno = pk2(j) and
     recno = pk3(j);


    -- Check if Inventory Exists
    if oinv is not null
     then

      -- Check if multiple inventory numbers have been entered, and if
      dupl_values := FALSE;
      dupctr_a := 0;
      dupctr_b := 0;
      for k in pk2.first..pk2.last loop
       if oinv is not null and trim(v6(k)) is not null and oinv = trim(v6(k))
        then
         -- Check if the Description is different and not null
         if trim(v7(j)) is not null and trim(v7(k)) is not null and trim(v7(j)) <> trim(v7(k))
          then
           dupctr_a := dupctr_a + 1;
         end if;
       end if;
      end loop;

      if dupctr_a > 0
       then
        errmsg(j) := errmsg(j) || ' ' || 'Different descriptions exist for the same Inventory Number.';
        dupl_values := TRUE;
      end if;

      if dupl_values
       then
        --
        errfound := TRUE;

       else
        open c3('INVENT',v6(j));
        fetch c3 into c3rec;
        if c3%FOUND
         then
          close c3;
          update strang.lov
           set
            description = nvl(v7(j),description)
          where
           lov_name = 'INVENT' and
           code = oinv;
         else
          close c3;
          insert into strang.lov(lov_name,code,description) values ('INVENT',v6(j),v7(j));
        end if;
      end if;

    end if;
   end if;
 end loop;
 commit;
 if errfound then msg := 'Errors found Modifying Data. Please Review each Entry Record to see what the Error was.'; end if;

 poinventory_maintain_mass(surl, p1, rid,vrecctr, pk2, pk3, v1, v2, v9, v3_1 , v3_1_1 ,v3_2 ,v3, v4, v5, v6, v7, v8, v1i,v8i,errmsg, msg, force_single_disp=>force_single_disp, popup=>popup );

exception when others then
 error_details( 'STRANGP', 'accept_poinvent_maintain_mass',null,null,errmsg=>sqlerrm,extdet=>'P1:' || p1 );
end accept_poinvent_maintain_mass;
-- xxxxxx 20160714


-- xxxxxx 20160615
procedure po_inventdate_maintain(surl in varchar2, strt in varchar2, rid in varchar2, vrecctr in varchar2, msg in varchar2 default null, force_single_disp in char default 'F', popup in char default 'F' )
as


 sts		varchar2(100);
 vaccess	varchar2(20);
 vste		varchar2(10);
 seclevel	varchar2(100);

begin
 if not dapi.init( surl, 'STRANGP.PO_INVENTDATE_MAINTAIN', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'PO_INVENTDATE_MAINTAIN');
    return;
 end if;

 vste := customer_state(dapi.GLOBAL_ACCOUNT.acctid);
 vaccess := data_access( 'POS' );
 seclevel := security_role( dapi.GLOBAL_ACCOUNT.acctid );

 main_title( 'Choose Inventory Number',helpid=>'STR17',dispmenu=>FALSE);

 header_msg( nvl(msg,'Update By Inventory') );

 htp.p( '<CENTER>' );
 if vaccess = 'NONE' then htp.bold( 'Access Denied' ); htp.htmlclose; return; end if;

 htp.formopen( 'strangp.poinvdte_maintain_mass' );
 htp.formhidden( 'SURL', surl );
 htp.formhidden( 'RID', rid );
 htp.formhidden( 'VRECCTR', vrecctr );
 htp.formhidden( 'PK2', NULL );
 htp.formhidden( 'PK3', NULL );
 htp.formhidden( 'V1', NULL );
 htp.formhidden( 'V2', NULL );
 htp.formhidden( 'V9', NULL );
 htp.formhidden( 'V1i', NULL );
 htp.formhidden( 'V8i', NULL );
 htp.formhidden( 'V3_1', NULL );
 htp.formhidden( 'V3_1_1', NULL );
 htp.formhidden( 'V3_2', NULL );
 htp.formhidden( 'V3', NULL );
 htp.formhidden( 'V4', NULL );
 htp.formhidden( 'V5', NULL );
 htp.formhidden( 'V6', NULL );
 htp.formhidden( 'V7', NULL );
 htp.formhidden( 'V8', NULL );
 htp.formhidden( 'ERRMSG', NULL );
   htp.formhidden( 'FORCE_SINGLE_DISP', force_single_disp);
   htp.formhidden( 'POPUP', popup);
 htp.nl;
 htp.tableopen( cattributes=>'class="str1_table"' );
  htp.tablerowopen;
     htp.tabledata( htf.bold('Inventory Number'),cattributes=>'class="str1_bg_right"');
     htp.tabledata( htf.formtext('P1',20,30, ''),cattributes=>'class="str1_bg_left"');
  htp.tablerowclose;
  htp.tablerowopen;
     htp.tabledata( htf.bold('Date From'),cattributes=>'class="str1_bg_right"');
     htp.tabledata( htf.formtext('P2',20,30, to_char(add_months(sysdate,-3),'DD-MON-YYYY')),cattributes=>'class="str1_bg_left"');
  htp.tablerowclose;
 htp.tableclose;
 htp.nl;
 htp.tableopen( cattributes=>'cellpadding=2 cellspacing=2 border=0' );
  htp.tablerowopen;
   htp.tabledata( htf.formsubmit( null, 'Submit' ) || htf.formclose );
   if popup = 'T'
    then
     htp.tabledata( htf.formopen( 'strangp.receive', ctarget=>'_top' ) || htf.formhidden( 'SURL', surl ) || htf.formhidden( 'RID', replace(rid,'~','+') ) ||
                    htf.formhidden( 'SCID', NULL ) || htf.formhidden( 'VRECCTR', vrecctr ) || htf.formhidden( 'CALL_NAME', null ) || htf.formhidden( 'PARM', 'DETAILRS' ) || htf.formhidden( 'ACCESS_ID', 'x' ) || htf.formsubmit( null, 'Cancel', cattributes=>'onClick="self.close(); return;"' ) || htf.formclose );
    else
     htp.tabledata( htf.formopen( 'strangp.receive', ctarget=>'_top' ) || htf.formhidden( 'SURL', surl ) || htf.formhidden( 'RID', replace(rid,'~','+') ) ||
                    htf.formhidden( 'SCID', NULL ) || htf.formhidden( 'VRECCTR', vrecctr ) || htf.formhidden( 'CALL_NAME', null ) || htf.formhidden( 'PARM', 'DETAILRS' ) || htf.formhidden( 'ACCESS_ID', 'x' ) || htf.formsubmit( null, 'Cancel' ) || htf.formclose );
   end if;
  htp.tablerowclose;
 htp.tableclose;

 htp.nl;
 htp.nl;
 if popup = 'T' then htp.p('<a href="" onClick="self.close()">[Close Window]</a>'); end if;
 htp.p( '</CENTER>' );
 htp.htmlclose;
exception when others then
 error_details( 'STRANGP', 'po_inventdate_MAINTAIN',null,null,errmsg=>sqlerrm,extdet=>'Strt:' || strt);
end po_inventdate_maintain;

procedure poinvdte_maintain_mass(surl in varchar2, p1 in varchar2, p2 in varchar2, rid in varchar2, vrecctr in varchar2, pk2 in owa.vc_arr, pk3 in owa.vc_arr,
                              v1 in owa.vc_arr, v2 in owa.vc_arr, v9 in owa.vc_arr, v3_1 in owa.vc_arr, v3_1_1 in owa.vc_arr, v3_2 in owa.vc_arr, v3 in owa.vc_arr, v4 in owa.vc_arr, v5 in owa.vc_arr, v6 in owa.vc_arr, v7 in owa.vc_arr, v8 in owa.vc_arr, v1i in owa.vc_arr, v8i in owa.vc_arr, errmsg in owa.vc_arr, msg in varchar2 default null, force_single_disp in char default 'F', popup in char default 'F' )
as

 cursor c2(inventno varchar2, rdte varchar2) is
  select /*+ ALL_ROWS */ distinct p.deliveryno, p.recno, p.sap_delno, p.sap_delno_item,p.po, p.po_item_no, p.supinv, p.grn, p.amount, p.gstc_gstcode, p.gst, p.tamount, p.qty, p.unit_unitused, i.code,  i.description
  from strang.lov i, strang.pos p, strang.receivals r
  where p.inventoryno = inventno and
        p.inventoryno = i.code and
        i.lov_name = 'INVENT' and
        p.deliveryno = r.deliveryno and
        to_date(r.currdate,'DD-MON-YYYY') >= to_date(rdte,'DD-MON-YYYY')
 union all
  select /*+ ALL_ROWS */ distinct p.deliveryno, p.recno, p.sap_delno, p.sap_delno_item, p.po, p.po_item_no, p.supinv, p.grn, p.amount, p.gstc_gstcode, p.gst, p.tamount, p.qty, p.unit_unitused, p.inventoryno code, null description
  from strang.pos p, strang.receivals r
  where p.inventoryno = inventno and
        p.deliveryno = r.deliveryno and
        to_date(r.currdate,'DD-MON-YYYY') >= to_date(rdte,'DD-MON-YYYY') and
       ( p.inventoryno not in (select i.code from strang.lov i where i.lov_name = 'INVENT'))
order by 1,2,3;

 foundrec	boolean;
 sts		varchar2(100);
 vaccess	varchar2(20);
 vste		varchar2(10);
 seclevel	varchar2(100);
 inventno	integer;
 rdte		varchar2(20);
 function vld( p_k2 in varchar2, p_k3 in varchar2, fld in varchar2, defval in varchar2 )
  return varchar2
 as
 begin
  for j in pk2.first..pk2.last loop
   if pk2(j) = p_k2 and pk3(j) = p_k3
    then
     if fld = 'ERRMSG'
      then
       return( errmsg(j) );
     elsif fld = 'V1'
      then
       return( strang.f_sap_format(v1(j),'PO') );
     elsif fld = 'V1i'
      then
       return( strang.f_sap_format(v1i(j),'DELIVERYNO') );
     elsif fld = 'V2'
      then
       return( v2(j) );
     elsif fld = 'V3_1'
      then
       return( v3_1(j) );
     elsif fld = 'V3_1_1'
      then
       return( v3_1_1(j) );
     elsif fld = 'V3_2'
      then
       return( v3_2(j) );
     elsif fld = 'V3'
      then
       return( v3(j) );
     elsif fld = 'V4'
      then
       return( v4(j) );
     elsif fld = 'V5'
      then
       return( v5(j) );
     elsif fld = 'V6'
      then
       return( strang.f_sap_format(v6(j),'INVENTORYNO') );
     elsif fld = 'V7'
      then
       return( v7(j) );
     elsif fld = 'V8'
      then
       return( v8(j) );
     elsif fld = 'V8i'
      then
       return( v8i(j) );
     elsif fld = 'V9'
      then
       return( strang.f_sap_format(v9(j),'GRN') );
     end if;
   end if;
  end loop;
  return( defval );
 end vld;

begin
 if not dapi.init( surl, 'STRANGP.POINVDTE_MAINTAIN_MASS', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'POINVDTE_MAINTAIN_MASS');
    return;
 end if;

 begin inventno := to_char(p1); exception when others then po_inventdate_maintain( surl, p1, rid, vrecctr, 'Inventory Number is not a Valid', force_single_disp=>force_single_disp, popup=>popup ); return; end;
 begin rdte := to_date(p2,'DD-MON-YYYY'); exception when others then po_inventdate_maintain( surl, p1, rid, vrecctr, 'Date is not a Valid', force_single_disp=>force_single_disp, popup=>popup ); return; end;

 vste := customer_state(dapi.GLOBAL_ACCOUNT.acctid);
 vaccess := data_access( 'PO_INVENTDATE_MAINTAIN' );
 seclevel := security_role( dapi.GLOBAL_ACCOUNT.acctid );

 main_title( 'PO Inventory Maintain Mass Edit',helpid=>'STR18',dispmenu=>FALSE);

 header_msg( nvl(msg,'PO Inventory Maintain Mass Edit') );

 htp.p( '<CENTER>' );
 if vaccess = 'NONE' then htp.bold( 'Access Denied' ); htp.htmlclose; return; end if;
 htp.bold( 'Inventory Number' || ':' || to_char(inventno));
 htp.nl;

 htp.formopen( 'strangp.accept_poinvdte_maintain_mass' );
 htp.formhidden( 'SURL', surl );
 htp.formhidden( 'RID', rid );
 htp.formhidden( 'VRECCTR', vrecctr );
 htp.formhidden( 'P1', p1 );
 htp.formhidden( 'P2', p2 );
   htp.formhidden( 'FORCE_SINGLE_DISP', force_single_disp);
   htp.formhidden( 'POPUP', popup);
 htp.nl;
 htp.tableopen( cattributes=>'class="str1_table"' );
  htp.tablerowopen;
    htp.tableheader( 'Delivery No');
    htp.tableheader( 'RecNo');
--    htp.tableheader( 'OTML Delno');
--    htp.tableheader( 'OTML Line');
    htp.tableheader( 'Purchase Order');
    htp.tableheader( 'PO Item');
    htp.tableheader( 'Supplier Inv');
    htp.tableheader( 'Goods Receipt');
    htp.tableheader( 'Net Amount');
    htp.tableheader( 'GST Code');
    htp.tableheader( 'GST');
    htp.tableheader( 'Total Amount');
    htp.tableheader( 'Qty');
    htp.tableheader( 'Unit');
    htp.tableheader( 'Inventory');
    htp.tableheader( 'Description');
    htp.tableheader( 'Data Entry Validation Message');
  htp.tablerowclose;
  foundrec := FALSE;
  for c2rec in c2(inventno,rdte) loop
   foundrec := TRUE;
   htp.tablerowopen;
    htp.tabledata( htf.formhidden( 'PK2', c2rec.deliveryno ) || htf.bold(c2rec.deliveryno),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formhidden( 'PK3', c2rec.recno ) || htf.bold(c2rec.recno) || htf.formhidden( 'V1i',vld(c2rec.deliveryno,c2rec.recno,'V1i',c2rec.sap_delno)) || htf.formhidden( 'V8i',vld(c2rec.deliveryno,c2rec.recno,'V8i',c2rec.sap_delno_item)),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formtext( 'V2',8,15,vld(c2rec.deliveryno,c2rec.recno,'V2',c2rec.supinv)),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formtext( 'V1',12,15,vld(c2rec.deliveryno,c2rec.recno,'V1',c2rec.po)),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formtext( 'V8',5,10,vld(c2rec.deliveryno,c2rec.recno,'V8',c2rec.po_item_no)),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formtext( 'V9',12,15,vld(c2rec.deliveryno,c2rec.recno,'V9',c2rec.grn)),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formtext( 'V3_1',10,20,vld(c2rec.deliveryno,c2rec.recno,'V3_1',trim(to_char(c2rec.amount,G_MONEY_FORMAT)))),cattributes=>'class="str1_bg_left"');
     htp.p( '<TD ' || 'class="str1_cell_left">' );
     lov_list( 'GSTCODES', 'V3_1_1', c2rec.gstc_gstcode, TRUE, FALSE, FALSE, isedit=>TRUE );
     htp.p( '</TD>' );
    htp.tabledata( htf.formtext( 'V3_2',10,20,vld(c2rec.deliveryno,c2rec.recno,'V3_2',trim(to_char(c2rec.gst,G_MONEY_FORMAT)))),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formtext( 'V3',10,20,vld(c2rec.deliveryno,c2rec.recno,'V3',trim(to_char(c2rec.tamount,G_MONEY_FORMAT)))),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formtext( 'V4',10,12,vld(c2rec.deliveryno,c2rec.recno,'V4',c2rec.qty)),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formtext( 'V5',5,8,vld(c2rec.deliveryno,c2rec.recno,'V5',c2rec.unit_unitused)),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formtext( 'V6',12,100,vld(c2rec.deliveryno,c2rec.recno,'V6',c2rec.code)),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formtext( 'V7',20,1000,nvl(vld(c2rec.deliveryno,c2rec.recno,'V7',c2rec.description),c2rec.description)),cattributes=>'class="str1_bg_left"');
    htp.tabledata( nvl(vld(c2rec.deliveryno,c2rec.recno,'ERRMSG','&nbsp;'),'Success'),cattributes=>'class="str1_bg_left"');
   htp.tablerowclose;
  end loop;
 htp.tableclose;
 htp.nl;
 if not foundrec then htp.init; po_inventdate_maintain( surl, p1, rid, vrecctr, 'No Records found that Satisfy this Query', force_single_disp=>force_single_disp, popup=>popup ); return; end if;
 htp.tableopen( cattributes=>'cellpadding=2 cellspacing=2 border=0' );
  htp.tablerowopen;
   htp.tabledata( htf.formsubmit( null, 'Modify Data' ) || htf.formclose );
   if popup = 'T'
    then
   htp.tabledata( htf.formopen( 'strangp.receive', ctarget=>'_top' ) || htf.formhidden( 'SURL', surl ) || htf.formhidden( 'RID', replace(rid,'~','+') ) ||
                  htf.formhidden( 'SCID', NULL ) || htf.formhidden( 'VRECCTR', vrecctr ) || htf.formhidden( 'CALL_NAME', null ) || htf.formhidden( 'PARM', 'DETAILRS' ) || htf.formhidden( 'ACCESS_ID', 'x' ) || htf.formsubmit( null, 'Cancel', cattributes=>'onClick="self.close(); return;"' ) || htf.formclose );
    else
   htp.tabledata( htf.formopen( 'strangp.receive', ctarget=>'_top' ) || htf.formhidden( 'SURL', surl ) || htf.formhidden( 'RID', replace(rid,'~','+') ) ||
                  htf.formhidden( 'SCID', NULL ) || htf.formhidden( 'VRECCTR', vrecctr ) || htf.formhidden( 'CALL_NAME', null ) || htf.formhidden( 'PARM', 'DETAILRS' ) || htf.formhidden( 'ACCESS_ID', 'x' ) || htf.formsubmit( null, 'Cancel' ) || htf.formclose );
   end if;
  htp.tablerowclose;
 htp.tableclose;
 htp.nl;
 htp.nl;
 if popup = 'T' then htp.bold( '<a href="" onClick="self.close()">' || LNG.GLB_TXT_033 || '</a>'); htp.nl; end if;
 htp.p( '</CENTER>' );
 htp.htmlclose;
exception when others then
 error_details( 'STRANGP', 'poinvdte_MAINTAIN_MASS',null,null,errmsg=>sqlerrm,extdet=>'P1:' || p1 );
end poinvdte_maintain_mass;

procedure accept_poinvdte_maintain_mass(surl in varchar2, p1 in varchar2, p2 in varchar2, rid in varchar2, vrecctr in varchar2, pk2 in owa.vc_arr, pk3 in owa.vc_arr,
                              v1 in owa.vc_arr, v2 in owa.vc_arr, v9 in owa.vc_arr, v3_1 in owa.vc_arr, v3_1_1 in owa.vc_arr,v3_2 in owa.vc_arr,v3 in owa.vc_arr, v4 in owa.vc_arr, v5 in owa.vc_arr, v6 in owa.vc_arr, v7 in owa.vc_arr, v8 in owa.vc_arr, v1i in owa.vc_arr, v8i in owa.vc_arr, force_single_disp in char default 'F', popup in char default 'F' )
as

 cursor c3(lname varchar2, lcode varchar2) is select * from strang.lov where lov_name = lname and code = lcode;
 cursor c5( cde varchar2 ) is select to_number(cola) cola, colb from strang.lov where lov_name = 'GSTCODES' and code = cde;

 c3rec		c3%ROWTYPE;
 c5rec		c5%ROWTYPE;
 sts		varchar2(100);
 vaccess	varchar2(20);
 vste		varchar2(10);
 errmsg		owa.vc_arr;
 errfound	boolean;
 dupl_values	boolean;
 errunit	char(1);
 msg		varchar2(1000);
 nmb1_1		STRANG.POS.AMOUNT%TYPE;
 nmb1_2		STRANG.POS.GST%TYPE;
 nmb1		STRANG.POS.TAMOUNT%TYPE;
 nmb2		STRANG.POS.QTY%TYPE;
 nmb3		STRANG.POS.GRN%TYPE;
 oinv		STRANG.POS.INVENTORYNO%TYPE;
 dupctr_a	integer;
 dupctr_b	integer;
 tmp		number;
 tmp2		number;
 vmsg   varchar2(100);

begin
 if not dapi.init( surl, 'STRANGP.ACCEPT_POINVDTE_MAINTAIN_MASS', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'ACCEPT_POINVDTE_MAINTAIN_MASS');
    return;
 end if;

 vste := customer_state(dapi.GLOBAL_ACCOUNT.acctid);
 vaccess := data_access( 'PO_INVENTDATE_MAINTAIN' );
 if vaccess = 'NONE' then htp.bold( 'Access Denied' ); htp.htmlclose; return; end if;

 errfound := FALSE;

 for j in pk2.first..pk2.last loop
  errmsg(j) := NULL;
  if pk2(j) is not null
   then
    -- Validate Numbers Entered
    begin
      nmb1_1 := to_number( replace(replace(v3_1(j),',',''),'$','') );
    exception when others then
     begin
       nmb1_1 := to_number( v3_1(j), G_MONEY_FORMAT );
      exception when others then
       errfound := TRUE;
       errmsg(j) := errmsg(j) || ' ' || 'Invalid Net Amount Entered.';
       nmb1 := NULL;
     end;
    end;
    begin
      nmb1_2 := to_number( replace(replace(v3_2(j),',',''),'$','') );
    exception when others then
     begin
       nmb1_2 := to_number( v3_2(j), G_MONEY_FORMAT );
      exception when others then
       errfound := TRUE;
       errmsg(j) := errmsg(j) || ' ' || 'Invalid GST Amount Entered.';
       nmb1 := NULL;
     end;
    end;
    begin
      nmb1 := to_number( replace(replace(v3(j),',',''),'$','') );
    exception when others then
     begin
       nmb1 := to_number( v3(j), G_MONEY_FORMAT );
      exception when others then
       errfound := TRUE;
       errmsg(j) := errmsg(j) || ' ' || 'Invalid Total Amount Entered.';
       nmb1 := NULL;
     end;
    end;
    begin
      nmb2 := to_number( v4(j) );
      if nmb2 < 0
       then
        errfound := TRUE;
        errmsg(j) := errmsg(j) || ' ' || 'Quantity cannot be less than 0.';
        nmb2 := NULL;
      end if;
      exception when others then
       errfound := TRUE;
       errmsg(j) := errmsg(j) || ' ' || 'Invalid Quantity Entered.';
       nmb2 := NULL;
    end;
    begin
      nmb2 := to_number( v1i(j) );
      exception when others then
       errfound := TRUE;
       errmsg(j) := errmsg(j) || ' ' || 'Invalid SAP Delno Entered.';
       nmb2 := NULL;
    end;
    begin
      nmb2 := to_number( v8i(j) );
      exception when others then
       errfound := TRUE;
       errmsg(j) := errmsg(j) || ' ' || 'Invalid SAP Line Entered.';
       nmb2 := NULL;
    end;
    begin
      nmb3 := to_number( v9(j) );
      exception when others then
       errfound := TRUE;
       errmsg(j) := errmsg(j) || ' ' || 'Invalid GRN Entered.';
       nmb3 := NULL;
    end;

    oinv := trim( v6(j) );

    if v1(j) is null
     then
       errfound := TRUE;
       errmsg(j) := errmsg(j) || ' ' || 'Purchase Order cannot be blank.';
    end if;

    if v2(j) is null
     then
       errfound := TRUE;
       errmsg(j) := errmsg(j) || ' ' || 'Supplier Invoice cannot be blank.';
    end if;

    -- Check Unit
    c3rec.code := NULL;
    errunit := 'F';
    if v5(j) is not null
     then
      open c3( 'UNITS', upper(v5(j)));
      fetch c3 into c3rec;
      if c3%NOTFOUND
       then
        close c3;
        errfound := TRUE;
        errmsg(j) := errmsg(j) || ' ' || 'Incorrect Unit.';
        errunit := 'T';
       else
        close c3;
      end if;
    end if;

    -- Check and calculate gst and totalamount

    if nmb1_1 is not null
     then
     if nmb1_2 is null and nmb1 is null
     then
      open c5(v3_1_1(j));
      fetch c5 into c5rec;
      close c5;
      if to_number(c5rec.cola) = 0
      then
        nmb1_2 := 0 ;
        nmb1 := nmb1_1 ;
      else
        if c5rec.colb = 'Inc GST' then
          nmb1_2 := c5rec.cola;
          nmb1 := nmb1_1;
          nmb1_1 := ((100 * nmb1) / (100 + nvl(nmb1_2,0) ));
          nmb1_2 := nmb1_1 * (c5rec.cola/100);
        else
          nmb1_2 := c5rec.cola;
          nmb1 := nmb1_1 * (1 + (nmb1_2/100));
          nmb1_2 := nmb1_1 * (c5rec.cola/100);
        end if;
      end if;
     end if;
    end if;

    -- 'Update Purchase Order'
    update strang.pos
     set
      po = nvl(strang.f_sap_format( v1(j), 'PO' ),po),
      po_item_no = nvl(to_number( v8(j) ),null),
      sap_delno = nvl(strang.f_sap_format( v1i(j), 'DELIVERYNO' ),null),
      sap_delno_item = nvl(to_number( v8i(j) ),null),
      supinv = nvl(v2(j),supinv),
      grn = nvl(strang.f_sap_format( v9(j), 'GRN' ),null),
      amount = nvl(nmb1_1,amount),
      gstc_gstcode = nvl(v3_1_1(j),gstc_gstcode),
      gst = nvl(nmb1_2,gst),
      tamount = nvl(nmb1,tamount),
      qty = nvl(to_number(v4(j)),qty),
      unit_unitused = decode(errunit,'F',upper(v5(j)),'T',unit_unitused),
      inventoryno = nvl(strang.f_sap_format( oinv, 'INVENTORYNO'),inventoryno)
--      inventoryno = nvl(oinv,inventoryno)
    where
     deliveryno = pk2(j) and
     recno = pk3(j);


    -- Check if Inventory Exists
    if oinv is not null
     then

      -- Check if multiple inventory numbers have been entered, and if
      dupl_values := FALSE;
      dupctr_a := 0;
      dupctr_b := 0;
      for k in pk2.first..pk2.last loop
       if oinv is not null and trim(v6(k)) is not null and oinv = trim(v6(k))
        then
         -- Check if the Description is different and not null
         if trim(v7(j)) is not null and trim(v7(k)) is not null and trim(v7(j)) <> trim(v7(k))
          then
           dupctr_a := dupctr_a + 1;
         end if;
       end if;
      end loop;

      if dupctr_a > 0
       then
        errmsg(j) := errmsg(j) || ' ' || 'Different descriptions exist for the same Inventory Number.';
        dupl_values := TRUE;
      end if;

      if dupl_values
       then
        --
        errfound := TRUE;

       else
        open c3('INVENT',v6(j));
          close c3;
        fetch c3 into c3rec;
        if c3%FOUND
         then
          update strang.lov
           set
            description = nvl(v7(j),description)
          where
           lov_name = 'INVENT' and
           code = oinv;
         else
          close c3;
          insert into strang.lov(lov_name,code,description) values ('INVENT',v6(j),v7(j));
        end if;
      end if;

    end if;
   end if;
 end loop;
 commit;
 if errfound then msg := 'Errors found Modifying Data. Please Review each Entry Record to see what the Error was.'; end if;

 poinvdte_maintain_mass(surl, p1, p2,rid,vrecctr, pk2, pk3, v1, v2, v9, v3_1 , v3_1_1 ,v3_2 ,v3, v4, v5, v6, v7, v8, v1i,v8i,errmsg, msg, force_single_disp=>force_single_disp, popup=>popup );

exception when others then
 error_details( 'STRANGP', 'accept_poinvdte_maintain_mass',null,null,errmsg=>sqlerrm,extdet=>'P1:' || p1 );
end accept_poinvdte_maintain_mass;


-- xxxxxx 20160714
procedure po_item_no_maintain(surl in varchar2, strt in varchar2, strt2 in varchar2 default null, rid in varchar2, vrecctr in varchar2, msg in varchar2 default null, force_single_disp in char default 'F', popup in char default 'F' )
as


 sts		varchar2(100);
 vaccess	varchar2(20);
 vste		varchar2(10);
 seclevel	varchar2(100);

begin
 if not dapi.init( surl, 'STRANGP.PO_ITEM_NO_MAINTAIN', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'PO_ITEM_NO_MAINTAIN');
    return;
 end if;

 vste := customer_state(dapi.GLOBAL_ACCOUNT.acctid);
 vaccess := data_access( 'POS' );
 seclevel := security_role( dapi.GLOBAL_ACCOUNT.acctid );

 main_title( 'Choose Delivery Number',helpid=>'STR19',dispmenu=>FALSE);

 header_msg( nvl(msg,'PO Maintain') );

 htp.p( '<CENTER>' );
 if vaccess = 'NONE' then htp.bold( 'Access Denied' ); htp.htmlclose; return; end if;

 htp.formopen( 'strangp.poitemno_maintain_mass' );
 htp.formhidden( 'SURL', surl );
 htp.formhidden( 'RID', rid );
 htp.formhidden( 'VRECCTR', vrecctr );
 htp.formhidden( 'PK2', NULL );
 htp.formhidden( 'PK3', NULL );
 htp.formhidden( 'V1', NULL );
 htp.formhidden( 'V2', NULL );
  htp.formhidden( 'V9', NULL );
htp.formhidden( 'V1i', NULL );
 htp.formhidden( 'V8i', NULL );
 htp.formhidden( 'V3_1', NULL );
 htp.formhidden( 'V3_1_1', NULL );
 htp.formhidden( 'V3_2', NULL );
 htp.formhidden( 'V3', NULL );
 htp.formhidden( 'V4', NULL );
 htp.formhidden( 'V5', NULL );
 htp.formhidden( 'V6', NULL );
 htp.formhidden( 'V7', NULL );
 htp.formhidden( 'V8', NULL );
 htp.formhidden( 'V9i', NULL );
 htp.formhidden( 'ERRMSG', NULL );
   htp.formhidden( 'FORCE_SINGLE_DISP', force_single_disp);
   htp.formhidden( 'POPUP', popup);
 htp.nl;
 htp.tableopen( cattributes=>'class="str1_table"' );
  htp.tablerowopen;
     htp.tabledata( htf.bold('Delivery From'),cattributes=>'class="str1_bg_right"');
     htp.tabledata( htf.formtext('P1',20,30, strt),cattributes=>'class="str1_bg_left"');
  htp.tablerowclose;
  htp.tablerowopen;
     htp.tabledata( htf.bold('Delivery To'),cattributes=>'class="str1_bg_right"');
     htp.tabledata( htf.formtext('P2',20,30, nvl(strt2, strt)),cattributes=>'class="str1_bg_left"');
  htp.tablerowclose;
 htp.tableclose;
 htp.nl;
 htp.tableopen( cattributes=>'cellpadding=2 cellspacing=2 border=0' );
  htp.tablerowopen;
   htp.tabledata( htf.formsubmit( null, 'Submit' ) || htf.formclose );
   if popup = 'T'
    then
   htp.tabledata( htf.formopen( 'strangp.receive', ctarget=>'_top' ) || htf.formhidden( 'SURL', surl ) || htf.formhidden( 'RID', replace(rid,'~','+') ) ||
                  htf.formhidden( 'SCID', NULL ) || htf.formhidden( 'VRECCTR', vrecctr ) || htf.formhidden( 'CALL_NAME', null ) || htf.formhidden( 'PARM', 'DETAILRS' ) || htf.formhidden( 'ACCESS_ID', 'x' ) || htf.formsubmit( null, 'Cancel', cattributes=>'onClick="self.close(); return;"' ) || htf.formclose );
    else
   htp.tabledata( htf.formopen( 'strangp.receive', ctarget=>'_top' ) || htf.formhidden( 'SURL', surl ) || htf.formhidden( 'RID', replace(rid,'~','+') ) ||
                  htf.formhidden( 'SCID', NULL ) || htf.formhidden( 'VRECCTR', vrecctr ) || htf.formhidden( 'CALL_NAME', null ) || htf.formhidden( 'PARM', 'DETAILRS' ) || htf.formhidden( 'ACCESS_ID', 'x' ) || htf.formsubmit( null, 'Cancel' ) || htf.formclose );
   end if;
  htp.tablerowclose;
 htp.tableclose;

 htp.nl;
 htp.nl;
 if popup = 'T' then htp.p('<a href="" onClick="self.close()">[Close Window]</a>'); end if;
 htp.p( '</CENTER>' );
 htp.htmlclose;
exception when others then
 error_details( 'STRANGP', 'PO_ITEM_NO_MAINTAIN',null,null,errmsg=>sqlerrm,extdet=>'Strt:' || strt);
end po_item_no_maintain;

procedure POITEMNO_maintain_mass(surl in varchar2, p1 in varchar2, p2 in varchar2, rid in varchar2, vrecctr in varchar2, pk2 in owa.vc_arr, pk3 in owa.vc_arr,
                              v1 in owa.vc_arr, v2 in owa.vc_arr, v9 in owa.vc_arr, v3_1 in owa.vc_arr, v3_1_1 in owa.vc_arr, v3_2 in owa.vc_arr, v3 in owa.vc_arr, v4 in owa.vc_arr, v5 in owa.vc_arr, v6 in owa.vc_arr, v7 in owa.vc_arr, v8 in owa.vc_arr, v1i in owa.vc_arr, v8i in owa.vc_arr, v9i in owa.vc_arr, errmsg in owa.vc_arr, msg in varchar2 default null, force_single_disp in char default 'F', popup in char default 'F' )
as

 cursor c2(del_from integer, del_to integer) is
  select /*+ ALL_ROWS */ distinct p.deliveryno, p.recno, p.sap_delno, p.sap_delno_item,p.po, p.po_item_no, p.supinv, p.grn, p.amount, p.gstc_gstcode, p.gst, p.tamount, p.qty, p.unit_unitused, i.code,  i.description, p.grn_item, p.manual_grn, p.grn_status, p.critical_flag
  from strang.lov i, strang.pos p
  where p.deliveryno >= del_from and
        p.deliveryno <= del_to and
        p.inventoryno = i.code and
        i.lov_name = 'INVENT'
 union all
  select /*+ ALL_ROWS */ distinct p.deliveryno, p.recno, p.sap_delno, p.sap_delno_item, p.po, p.po_item_no, p.supinv, p.grn, p.amount, p.gstc_gstcode, p.gst, p.tamount, p.qty, p.unit_unitused, p.inventoryno code, null description, p.grn_item, p.manual_grn, p.grn_status, p.critical_flag
  from strang.pos p
  where p.deliveryno >= del_from and
        p.deliveryno <= del_to and
        (p.inventoryno is null or p.inventoryno not in (select i.code from strang.lov i where i.lov_name = 'INVENT'))
order by 1,2,3;

 foundrec	boolean;
 sts		varchar2(100);
 vaccess	varchar2(20);
 vste		varchar2(10);
 seclevel	varchar2(100);
 del_from	integer;
 del_to		integer;
 xnmb		integer;

 function vld( p_k2 in varchar2, p_k3 in varchar2, fld in varchar2, defval in varchar2 )
  return varchar2
 as
 begin
  for j in pk2.first..pk2.last loop
   if pk2(j) = p_k2 and pk3(j) = p_k3
    then
     if fld = 'ERRMSG'
      then
       return( errmsg(j) );
     elsif fld = 'V1'
      then
       return( strang.f_sap_format(v1(j),'PO') );
     elsif fld = 'V1i'
      then
       return( strang.f_sap_format(v1i(j),'DELIVERYNO') );
     elsif fld = 'V2'
      then
       return( v2(j) );
     elsif fld = 'V3_1'
      then
       return( v3_1(j) );
     elsif fld = 'V3_1_1'
      then
       return( v3_1_1(j) );
     elsif fld = 'V3_2'
      then
       return( v3_2(j) );
     elsif fld = 'V3'
      then
       return( v3(j) );
     elsif fld = 'V4'
      then
       return( v4(j) );
     elsif fld = 'V5'
      then
       return( v5(j) );
     elsif fld = 'V6'
      then
       return( strang.f_sap_format(v6(j),'INVENTORYNO') );
     elsif fld = 'V7'
      then
       return( v7(j) );
     elsif fld = 'V8'
      then
       return( v8(j) );
     elsif fld = 'V8i'
      then
       return( v8i(j) );
     elsif fld = 'V9i'
      then
       return( v9i(j) );
     elsif fld = 'V9'
      then
       return( strang.f_sap_format(v9(j),'GRN') );
     end if;
   end if;
  end loop;
  return( defval );
 end vld;

begin
 if not dapi.init( surl, 'STRANGP.POITEMNO_MAINTAIN_MASS', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'POITEMNO_MAINTAIN_MASS');
    return;
 end if;

 begin del_from := to_number(p1); exception when others then po_item_no_maintain( surl, p1, p2, rid, vrecctr, 'Delivery From Number is not a Valid Number', force_single_disp=>force_single_disp, popup=>popup ); return; end;
 begin del_to := to_number(p2); exception when others then po_item_no_maintain( surl, p1, p2, rid, vrecctr, 'Delivery To Number is not a Valid Number', force_single_disp=>force_single_disp, popup=>popup ); return; end;
 if del_from <= 0 or del_from > del_to then po_item_no_maintain( surl, p1, p2, rid, vrecctr, 'Delivery Number Range is Invalid', force_single_disp=>force_single_disp, popup=>popup ); return; end if;


 vste := customer_state(dapi.GLOBAL_ACCOUNT.acctid);
 vaccess := data_access( 'PO_ITEM_NO_MAINTAIN');
 seclevel := security_role( dapi.GLOBAL_ACCOUNT.acctid );

 main_title( 'PO Item No Maintain Mass Edit',helpid=>'STR20',dispmenu=>FALSE);

 header_msg( nvl(msg,'PO Item No Maintain Mass Edit') );

 htp.p( '<CENTER>' );
 if vaccess = 'NONE' then htp.bold( 'Access Denied' ); htp.htmlclose; return; end if;
 htp.bold( 'Deliveries From' || ':' || to_char(del_from) || '&nbsp;&nbsp;&nbsp;' || 'To' || ':' || to_char(del_to));
 htp.nl;

 htp.formopen( 'strangp.accept_poitemno_maintain_mass' );
 htp.formhidden( 'SURL', surl );
 htp.formhidden( 'RID', rid );
 htp.formhidden( 'VRECCTR', vrecctr );
 htp.formhidden( 'P1', p1 );
 htp.formhidden( 'P2', p2 );
   htp.formhidden( 'FORCE_SINGLE_DISP', force_single_disp);
   htp.formhidden( 'POPUP', popup);
 htp.nl;
 htp.tableopen( cattributes=>'class="str1_table"' );
  htp.tablerowopen;
    htp.tableheader( 'Delivery No');
    htp.tableheader( 'RecNo');
    htp.tableheader( 'Goods Receipt');
    htp.tableheader( 'Item');
    htp.tableheader( 'Flag');
    htp.tableheader( 'Status');
    htp.tableheader( 'Purchase Order');
    htp.tableheader( 'PO Item');
    htp.tableheader( 'Supplier Inv');
    htp.tableheader( 'Net Amount');
    htp.tableheader( 'GST Code');
    htp.tableheader( 'GST');
    htp.tableheader( 'Total Amount');
    htp.tableheader( 'Qty');
    htp.tableheader( 'Unit');
    htp.tableheader( 'Inventory No');
    htp.tableheader( 'Description');
    htp.tableheader( 'Data Entry Validation Message');
  htp.tablerowclose;
  foundrec := FALSE;
  for c2rec in c2(del_from, del_to) loop
   foundrec := TRUE;
   htp.tablerowopen; -- po item no maintain mass edit
    htp.tabledata( htf.formhidden( 'PK2', c2rec.deliveryno ) || htf.bold(c2rec.deliveryno),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formhidden( 'PK3', c2rec.recno ) || htf.bold(c2rec.recno),cattributes=>'class="str1_bg_left"');
    if c2rec.manual_grn = 'Y'
     then
      htp.tabledata( htf.formtext( 'V9',12,15,vld(c2rec.deliveryno,c2rec.recno,'V9',c2rec.grn)) || ' ' || c2rec.grn_item,cattributes=>'class="str1_bg_left"');
      htp.tabledata( htf.formtext( 'V9i',10,15,vld(c2rec.deliveryno,c2rec.recno,'V9i',c2rec.grn_item)),cattributes=>'class="str1_bg_left"');
      htp.tabledata( htf.formtext( 'V8i',5,10,vld(c2rec.deliveryno,c2rec.recno,'V8i',c2rec.critical_flag)),cattributes=>'class="str1_bg_left"'); --> change to critical flag
     else
      htp.tabledata( htf.formhidden( 'V9',vld(c2rec.deliveryno,c2rec.recno,'V9',c2rec.grn)) || vld(c2rec.deliveryno,c2rec.recno,'V9',c2rec.grn),cattributes=>'class="str1_bg_left"');
      htp.tabledata( htf.formhidden( 'V9i',vld(c2rec.deliveryno,c2rec.recno,'V9i',c2rec.grn_item)) || vld(c2rec.deliveryno,c2rec.recno,'V9i',c2rec.grn_item),cattributes=>'class="str1_bg_left"');
      htp.tabledata( htf.formhidden( 'V8i',vld(c2rec.deliveryno,c2rec.recno,'V8i',c2rec.critical_flag)) || vld(c2rec.deliveryno,c2rec.recno,'V8i',c2rec.critical_flag),cattributes=>'class="str1_bg_left"'); --> change to critical flag
    end if;
    if vld(c2rec.deliveryno,c2rec.recno,'V9',c2rec.grn) is not null and vld(c2rec.deliveryno,c2rec.recno,'V9i',c2rec.grn_item) is not null
     then
      htp.tabledata( htf.formhidden( 'V1i',vld(c2rec.deliveryno,c2rec.recno,'V9i',c2rec.grn_status)) || vld(c2rec.deliveryno,c2rec.recno,'V1i',c2rec.grn_status),cattributes=>'class="str1_bg_left"');
     else
      -- Pos.grn_status :  The user should only be able to update pos.grn_status with one of the following values 2,3,4,7.  The system can allocate 0,1,2,8 and 9.
        xnmb := vld(c2rec.deliveryno,c2rec.recno,'V9i',c2rec.grn_status);
        htp.p( '<td class="str1_bg_left">' );
         htp.formselectopen( 'V1i');
         if xnmb not in (2,3,4,7)
          then
           htp.formselectoption( xnmb );
         end if;
         if xnmb = 2
          then
           htp.formselectoption(2,'SELECTED');
           htp.formselectoption(3);
           htp.formselectoption(4);
         elsif xnmb = 4
          then
           htp.formselectoption(2);
           htp.formselectoption(4,'SELECTED');
         else
          htp.formselectoption(2);
          if xnmb = 3 then htp.formselectoption(3,'SELECTED'); else htp.formselectoption(3); end if;
          htp.formselectoption(4);
          if xnmb = 7 then htp.formselectoption(7,'SELECTED'); else htp.formselectoption(7); end if;
         end if;
         htp.formselectclose;
        htp.p( '</td>' );
    end if;
    htp.tabledata( htf.formtext( 'V1',12,15,vld(c2rec.deliveryno,c2rec.recno,'V1',c2rec.po)),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formtext( 'V8',5,10,vld(c2rec.deliveryno,c2rec.recno,'V8',c2rec.po_item_no)),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formtext( 'V2',8,15,vld(c2rec.deliveryno,c2rec.recno,'V2',c2rec.supinv)),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formtext( 'V3_1',10,20,vld(c2rec.deliveryno,c2rec.recno,'V3_1',trim(to_char(c2rec.amount,G_MONEY_FORMAT)))),cattributes=>'class="str1_bg_left"');
     htp.p( '<TD ' || 'class="str1_cell_left">' );
     lov_list( 'GSTCODES', 'V3_1_1', c2rec.gstc_gstcode, TRUE, FALSE, FALSE, isedit=>TRUE );
     htp.p( '</TD>' );
    htp.tabledata( htf.formtext( 'V3_2',10,20,vld(c2rec.deliveryno,c2rec.recno,'V3_2',trim(to_char(c2rec.gst,G_MONEY_FORMAT)))),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formtext( 'V3',10,20,vld(c2rec.deliveryno,c2rec.recno,'V3',trim(to_char(c2rec.tamount,G_MONEY_FORMAT)))),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formtext( 'V4',10,12,vld(c2rec.deliveryno,c2rec.recno,'V4',c2rec.qty)),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formtext( 'V5',5,8,vld(c2rec.deliveryno,c2rec.recno,'V5',c2rec.unit_unitused)),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formtext( 'V6',12,100,vld(c2rec.deliveryno,c2rec.recno,'V6',c2rec.code)),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formtext( 'V7',20,1000,nvl(vld(c2rec.deliveryno,c2rec.recno,'V7',c2rec.description),c2rec.description)),cattributes=>'class="str1_bg_left"');
    htp.tabledata( nvl(vld(c2rec.deliveryno,c2rec.recno,'ERRMSG','&nbsp;'),'Success'),cattributes=>'class="str1_bg_left"');
   htp.tablerowclose;
  end loop;
 htp.tableclose;
 htp.nl;
 if not foundrec then htp.init; po_item_no_maintain( surl, p1, p2, rid, vrecctr, 'No Records found that Satisfy this Query', force_single_disp=>force_single_disp, popup=>popup ); return; end if;
 htp.tableopen( cattributes=>'cellpadding=2 cellspacing=2 border=0' );
  htp.tablerowopen;
   htp.tabledata( htf.formsubmit( null, 'Modify Data' ) || htf.formclose );
   if popup = 'T'
    then
   htp.tabledata( htf.formopen( 'strangp.receive', ctarget=>'_top' ) || htf.formhidden( 'SURL', surl ) || htf.formhidden( 'RID', replace(rid,'~','+') ) ||
                  htf.formhidden( 'SCID', NULL ) || htf.formhidden( 'VRECCTR', vrecctr ) || htf.formhidden( 'CALL_NAME', null ) || htf.formhidden( 'PARM', 'DETAILRS' ) || htf.formhidden( 'ACCESS_ID', 'x' ) || htf.formsubmit( null, 'Cancel', cattributes=>'onClick="self.close(); return;"' ) || htf.formclose );
    else
   htp.tabledata( htf.formopen( 'strangp.receive', ctarget=>'_top' ) || htf.formhidden( 'SURL', surl ) || htf.formhidden( 'RID', replace(rid,'~','+') ) ||
                  htf.formhidden( 'SCID', NULL ) || htf.formhidden( 'VRECCTR', vrecctr ) || htf.formhidden( 'CALL_NAME', null ) || htf.formhidden( 'PARM', 'DETAILRS' ) || htf.formhidden( 'ACCESS_ID', 'x' ) || htf.formsubmit( null, 'Cancel' ) || htf.formclose );
   end if;
  htp.tablerowclose;
 htp.tableclose;
 htp.nl;
 htp.nl;
 if popup = 'T' then htp.bold( '<a href="" onClick="self.close()">' || LNG.GLB_TXT_033 || '</a>'); htp.nl; end if;
 htp.p( '</CENTER>' );
 htp.htmlclose;
exception when others then
 error_details( 'STRANGP', 'POITEMNO_MAINTAIN_MASS',null,null,errmsg=>sqlerrm,extdet=>'P1:' || p1 || '-' || 'P2:' || p2);
end poitemno_maintain_mass;

procedure accept_poitemno_maintain_mass(surl in varchar2, p1 in varchar2, p2 in varchar2, rid in varchar2, vrecctr in varchar2, pk2 in owa.vc_arr, pk3 in owa.vc_arr,
                              v1 in owa.vc_arr, v2 in owa.vc_arr, v9 in owa.vc_arr, v3_1 in owa.vc_arr, v3_1_1 in owa.vc_arr,v3_2 in owa.vc_arr,v3 in owa.vc_arr, v4 in owa.vc_arr, v5 in owa.vc_arr, v6 in owa.vc_arr, v7 in owa.vc_arr, v8 in owa.vc_arr, v1i in owa.vc_arr, v8i in owa.vc_arr, v9i in owa.vc_arr, force_single_disp in char default 'F', popup in char default 'F' )
as

 cursor c3(lname varchar2, lcode varchar2) is select * from strang.lov where lov_name = lname and code = lcode;
 cursor c5( cde varchar2 ) is select to_number(cola) cola, colb from strang.lov where lov_name = 'GSTCODES' and code = cde;

 c3rec		c3%ROWTYPE;
 c5rec		c5%ROWTYPE;
 sts		varchar2(100);
 vaccess	varchar2(20);
 vste		varchar2(10);
 errmsg		owa.vc_arr;
 errfound	boolean;
 dupl_values	boolean;
 errunit	char(1);
 msg		varchar2(1000);
 nmb1_1		STRANG.POS.AMOUNT%TYPE;
 nmb1_2		STRANG.POS.GST%TYPE;
 nmb1		STRANG.POS.TAMOUNT%TYPE;
 nmb2		STRANG.POS.QTY%TYPE;
 nmb3		STRANG.POS.GRN%TYPE;
 oinv		STRANG.POS.INVENTORYNO%TYPE;
 dupctr_a	integer;
 dupctr_b	integer;
 tmp		number;
 tmp2		number;
 vmsg   varchar2(100);

begin
   REDISPLAY_LOGIN_PAGE( sts, TRUE );
 if not dapi.init( surl, 'STRANGP.ACCEPT_ENTRY_MAINTAIN_MASS', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'ACCEPT_ENTRY_MAINTAIN_MASS');
    return;
 end if;

 vste := customer_state(dapi.GLOBAL_ACCOUNT.acctid);
 vaccess := data_access( 'PO_ITEM_NO_MAINTAIN' );
 if vaccess = 'NONE' then htp.bold( 'Access Denied' ); htp.htmlclose; return; end if;

 errfound := FALSE;

 for j in pk2.first..pk2.last loop
  errmsg(j) := NULL;
  if pk2(j) is not null
   then
    -- Validate Numbers Entered
    begin
      nmb1_1 := to_number( replace(replace(v3_1(j),',',''),'$','') );
    exception when others then
     begin
       nmb1_1 := to_number( v3_1(j), G_MONEY_FORMAT );
      exception when others then
       errfound := TRUE;
       errmsg(j) := errmsg(j) || ' ' || 'Invalid Net Amount Entered.';
       nmb1 := NULL;
     end;
    end;
    begin
      nmb1_2 := to_number( replace(replace(v3_2(j),',',''),'$','') );
    exception when others then
     begin
       nmb1_2 := to_number( v3_2(j), G_MONEY_FORMAT );
      exception when others then
       errfound := TRUE;
       errmsg(j) := errmsg(j) || ' ' || 'Invalid GST Amount Entered.';
       nmb1 := NULL;
     end;
    end;
    begin
      nmb1 := to_number( replace(replace(v3(j),',',''),'$','') );
    exception when others then
     begin
       nmb1 := to_number( v3(j), G_MONEY_FORMAT );
      exception when others then
       errfound := TRUE;
       errmsg(j) := errmsg(j) || ' ' || 'Invalid Total Amount Entered.';
       nmb1 := NULL;
     end;
    end;
    begin
      nmb2 := to_number( v4(j) );
      if nmb2 < 0
       then
        errfound := TRUE;
        errmsg(j) := errmsg(j) || ' ' || 'Quantity cannot be less than 0.';
        nmb2 := NULL;
      end if;
      exception when others then
       errfound := TRUE;
       errmsg(j) := errmsg(j) || ' ' || 'Invalid Quantity Entered.';
       nmb2 := NULL;
    end;
    begin
      nmb2 := to_number( v1i(j) );
      exception when others then
       errfound := TRUE;
       errmsg(j) := errmsg(j) || ' ' || 'Invalid SAP Delno Entered.';
       nmb2 := NULL;
    end;
    begin
      nmb2 := to_number( v8i(j) );
      exception when others then
       errfound := TRUE;
       errmsg(j) := errmsg(j) || ' ' || 'Invalid SAP Line Entered.';
       nmb2 := NULL;
    end;
    begin
      nmb3 := to_number( v9(j) );
      exception when others then
       errfound := TRUE;
       errmsg(j) := errmsg(j) || ' ' || 'Invalid GRN Entered.';
       nmb3 := NULL;
    end;

    oinv := trim( v6(j) );

    if v1(j) is null
     then
       errfound := TRUE;
       errmsg(j) := errmsg(j) || ' ' || 'Purchase Order cannot be blank.';
    end if;

    if v2(j) is null
     then
       errfound := TRUE;
       errmsg(j) := errmsg(j) || ' ' || 'Supplier Invoice cannot be blank.';
    end if;

    -- Check Unit
    c3rec.code := NULL;
    errunit := 'F';
    if v5(j) is not null
     then
      open c3( 'UNITS', upper(v5(j)));
      fetch c3 into c3rec;
      if c3%NOTFOUND
       then
        close c3;
        errfound := TRUE;
        errmsg(j) := errmsg(j) || ' ' || 'Incorrect Unit.';
        errunit := 'T';
       else
        close c3;
      end if;
    end if;

    -- Check and calculate gst and totalamount

    if nmb1_1 is not null
     then
     if nmb1_2 is null and nmb1 is null
     then
      open c5(v3_1_1(j));
      fetch c5 into c5rec;
      close c5;
      if to_number(c5rec.cola) = 0
      then
        nmb1_2 := 0 ;
        nmb1 := nmb1_1 ;
      else
        if c5rec.colb = 'Inc GST' then
          nmb1_2 := c5rec.cola;
          nmb1 := nmb1_1;
          nmb1_1 := ((100 * nmb1) / (100 + nvl(nmb1_2,0) ));
          nmb1_2 := nmb1_1 * (c5rec.cola/100);
        else
          nmb1_2 := c5rec.cola;
          nmb1 := nmb1_1 * (1 + (nmb1_2/100));
          nmb1_2 := nmb1_1 * (c5rec.cola/100);
        end if;
      end if;
     end if;
    end if;

    -- 'Update Purchase Order'
--      sap_delno = nvl(strang.f_sap_format( v1i(j), 'DELIVERYNO' ),null),
    update strang.pos
     set
      po = nvl(strang.f_sap_format( v1(j), 'PO' ),po),
      po_item_no = nvl(to_number( v8(j) ),null),
      grn_item = v9i(j),
      grn_status = v1i(j),
      critical_flag = v8i(j),
      supinv = nvl(v2(j),supinv),
      grn = nvl(strang.f_sap_format( v9(j), 'GRN' ),null),
      amount = nvl(nmb1_1,amount),
      gstc_gstcode = nvl(v3_1_1(j),gstc_gstcode),
      gst = nvl(nmb1_2,gst),
      tamount = nvl(nmb1,tamount),
      qty = nvl(to_number(v4(j)),qty),
      unit_unitused = decode(errunit,'F',upper(v5(j)),'T',unit_unitused),
      inventoryno = nvl(strang.f_sap_format( oinv, 'INVENTORYNO'),inventoryno)
--      inventoryno = nvl(oinv,inventoryno)
    where

     deliveryno = pk2(j) and
     recno = pk3(j);

    -- Check if Inventory Exists
    if oinv is not null
     then

      -- Check if multiple inventory numbers have been entered, and if
      dupl_values := FALSE;
      dupctr_a := 0;
      dupctr_b := 0;
      for k in pk2.first..pk2.last loop
       if oinv is not null and trim(v6(k)) is not null and oinv = trim(v6(k))
        then
         -- Check if the Description is different and not null
         if trim(v7(j)) is not null and trim(v7(k)) is not null and trim(v7(j)) <> trim(v7(k))
          then
           dupctr_a := dupctr_a + 1;
         end if;
       end if;
      end loop;

      if dupctr_a > 0
       then
        errmsg(j) := errmsg(j) || ' ' || 'Different descriptions exist for the same Inventory Number.';
        dupl_values := TRUE;
      end if;

      if dupl_values
       then
        --
        errfound := TRUE;

       else
        open c3('INVENT',v6(j));
        fetch c3 into c3rec;
        if c3%FOUND
         then
          close c3;
          update strang.lov
           set
            description = nvl(v7(j),description)
          where
           lov_name = 'INVENT' and
           code = oinv;
         else
          close c3;
          insert into strang.lov(lov_name,code,description) values ('INVENT',v6(j),v7(j));
        end if;
      end if;

    end if;
   end if;
 end loop;
 commit;
 if errfound then msg := 'Errors found Modifying Data. Please Review each Entry Record to see what the Error was.'; end if;

 poitemno_maintain_mass(surl, p1, p2, rid,vrecctr, pk2, pk3, v1, v2, v9, v3_1 , v3_1_1 ,v3_2 ,v3, v4, v5, v6, v7, v8, v1i,v8i,v9i,errmsg, msg, force_single_disp=>force_single_disp, popup=>popup );

exception when others then
 error_details( 'STRANGP', 'ACCEPT_POITEMNO_MAINTAIN_MASS',null,null,errmsg=>sqlerrm,extdet=>'P1:' || p1 || '-' || 'P2:' || p2);
end accept_poitemno_maintain_mass;


-- XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
-- XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX  below added 090107

procedure container_maintain(surl in varchar2, strt in varchar2, strt2 in varchar2 default null, rid in varchar2, vrecctr in varchar2, msg in varchar2 default null, force_single_disp in char default 'F', popup in char default 'F' )
as


 sts		varchar2(100);
 vaccess	varchar2(20);
 vste		varchar2(10);
 seclevel	varchar2(100);

begin
 if not dapi.init( surl, 'STRANGP.CONTAINER_MAINTAIN', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'CONTAINER_MAINTAIN');
    return;
 end if;

 vste := customer_state(dapi.GLOBAL_ACCOUNT.acctid);
 vaccess := data_access( 'CONTAINER_MAINTAIN' );
 seclevel := security_role( dapi.GLOBAL_ACCOUNT.acctid );

 main_title( 'Choose Container Number',helpid=>'STR21',dispmenu=>FALSE);

 header_msg( nvl(msg,'Container Maintain') );

 htp.p( '<CENTER>' );
 if vaccess = 'NONE' then htp.bold( 'Access Denied' ); htp.htmlclose; return; end if;

 htp.formopen( 'strangp.container_maintain_mass' );
 htp.formhidden( 'SURL', surl );
 htp.formhidden( 'RID', rid );
 htp.formhidden( 'VRECCTR', vrecctr );
 htp.formhidden( 'PK1', NULL );
 htp.formhidden( 'PK2', NULL );
 htp.formhidden( 'PK3', NULL );
 htp.formhidden( 'V1', NULL );
 htp.formhidden( 'V2', NULL );
 htp.formhidden( 'V3', NULL );
 htp.formhidden( 'V4', NULL );
 htp.formhidden( 'V5', NULL );
 htp.formhidden( 'V6', NULL );
 htp.formhidden( 'V7', NULL );
 htp.formhidden( 'V8', NULL );
 htp.formhidden( 'V1i', NULL );
 htp.formhidden( 'V8i', NULL );
 htp.formhidden( 'V8ii', NULL );
 htp.formhidden( 'V9i', NULL );
 htp.formhidden( 'V9', NULL );
 htp.formhidden( 'V10', NULL );
 htp.formhidden( 'ERRMSG', NULL );
   htp.formhidden( 'FORCE_SINGLE_DISP', force_single_disp);
   htp.formhidden( 'POPUP', popup);
 htp.nl;
 htp.tableopen( cattributes=>'class="str1_table"' );
  htp.tablerowopen;
     htp.tabledata( htf.bold('Container'),cattributes=>'class="str1_bg_right"');
     htp.tabledata( htf.formtext('P1',20,30, strt),cattributes=>'class="str1_bg_left"');
  htp.tablerowclose;
  htp.tablerowopen;
     htp.tabledata( htf.bold('Seal'),cattributes=>'class="str1_bg_right"');
     htp.tabledata( htf.formtext('P2',20,30, nvl(strt2, strt)),cattributes=>'class="str1_bg_left"');
  htp.tablerowclose;
 htp.tableclose;
 htp.nl;
 htp.tableopen( cattributes=>'cellpadding=2 cellspacing=2 border=0' );
  htp.tablerowopen;
   htp.tabledata( htf.formsubmit( null, 'Submit' ) || htf.formclose );
 htp.tableclose;
   if popup = 'T'
    then
   htp.tabledata( htf.formopen( 'strangp.receive', ctarget=>'_top' ) || htf.formhidden( 'SURL', surl ) || htf.formhidden( 'RID', replace(rid,'~','+') ) ||
                  htf.formhidden( 'SCID', NULL ) || htf.formhidden( 'VRECCTR', vrecctr ) || htf.formhidden( 'CALL_NAME', null ) || htf.formhidden( 'PARM', 'DETAILRS' ) || htf.formhidden( 'ACCESS_ID', 'x' ) || htf.formsubmit( null, 'Cancel', cattributes=>'onClick="self.close(); return;"' ) || htf.formclose );
    else
   htp.tabledata( htf.formopen( 'strangp.receive', ctarget=>'_top' ) || htf.formhidden( 'SURL', surl ) || htf.formhidden( 'RID', replace(rid,'~','+') ) ||
                  htf.formhidden( 'SCID', NULL ) || htf.formhidden( 'VRECCTR', vrecctr ) || htf.formhidden( 'CALL_NAME', null ) || htf.formhidden( 'PARM', 'DETAILRS' ) || htf.formhidden( 'ACCESS_ID', 'x' ) || htf.formsubmit( null, 'Cancel' ) || htf.formclose );
   end if;
  htp.tablerowclose;

 htp.nl;
   htp.nl;
 if popup = 'T' then htp.p('<a href="" onClick="self.close()">[Close Window]</a>'); end if;
 htp.p( '</CENTER>' );
 htp.htmlclose;
exception when others then
 error_details( 'STRANGP', 'CONTAINER_MAINTAIN',null,null,errmsg=>sqlerrm,extdet=>'Strt:' || strt);
end container_maintain;

procedure container_maintain_mass(surl in varchar2, p1 in varchar2, p2 in varchar2, rid in varchar2, vrecctr in varchar2, pk1 in owa.vc_arr, pk2 in owa.vc_arr, pk3 in owa.vc_arr,
                              v1 in owa.vc_arr, v2 in owa.vc_arr, v3 in owa.vc_arr, v4 in owa.vc_arr, v5 in owa.vc_arr, v6 in owa.vc_arr, v7 in owa.vc_arr, v8 in owa.vc_arr, v1i in owa.vc_arr, v8i in owa.vc_arr, v8ii in owa.vc_arr, v9 in owa.vc_arr, v9i in owa.vc_arr, v10 in owa.vc_arr, errmsg in owa.vc_arr, msg in varchar2 default null, force_single_disp in char default 'F', popup in char default 'F' )
as

 cursor c2(container varchar2, seal varchar2) is
  select /*+ ALL_ROWS */ distinct dr.movement_no,dr.camov_seal, p.deliveryno, p.recno, p.sap_delno, p.sap_delno_item, p.po, p.po_item_no, p.supinv, p.tamount, p.qty, p.unit_unitused,t.cola tunit, i.code,  i.description, i.cola cola, p.state, p.ahecc, p.delivery_charge
  from strang.lov i, strang.pos p, strang.detailrs dr, strang.lov t
  where dr.movement_no = container and
        dr.camov_seal = seal and
        dr.deliveryno = p.deliveryno and
        p.inventoryno = i.code and
        i.lov_name = 'INVENT' and
        t.lov_name = 'TARIFF' and
        t.code = i.cola
 union all
  select /*+ ALL_ROWS */ distinct dr.movement_no,dr.camov_seal, p.deliveryno, p.recno, p.sap_delno, p.sap_delno_item, p.po, p.po_item_no, p.supinv, p.tamount, p.qty, p.unit_unitused, null tunit, i.code,  i.description, i.cola cola, p.state, p.ahecc, p.delivery_charge
  from strang.lov i, strang.pos p, strang.detailrs dr
  where  dr.movement_no = container and
        dr.camov_seal = seal and
        dr.deliveryno = p.deliveryno and
        p.inventoryno = i.code and
        i.lov_name = 'INVENT' and
        (i.cola is null or i.cola not in (select t.code from strang.lov t where t.lov_name = 'TARIFF'))
 union all
  select /*+ ALL_ROWS */ distinct dr.movement_no,dr.camov_seal, p.deliveryno, p.recno, p.sap_delno, p.sap_delno_item, p.po, p.po_item_no, p.supinv, p.tamount, p.qty, p.unit_unitused, null tunit, p.inventoryno code, null description, null cola, p.state, p.ahecc, p.delivery_charge
  from strang.pos p, strang.detailrs dr
  where  dr.movement_no = container and
        dr.camov_seal = seal and
        dr.deliveryno = p.deliveryno and
        (p.inventoryno is null or p.inventoryno not in (select i.code from strang.lov i where i.lov_name = 'INVENT'))
order by 1,2,3,4;

 foundrec	boolean;
 sts		varchar2(100);
 vaccess	varchar2(20);
 vste		varchar2(10);
 seclevel	varchar2(100);
 container	varchar2(40);
 seal		varchar2(15);

 function vld( p_k1 in varchar2, p_k2 in varchar2, p_k3 in varchar2, fld in varchar2, defval in varchar2 )
  return varchar2
 as
 begin
  for j in pk1.first..pk1.last loop
   if pk1(j) = p_k1 and pk2(j) = p_k2 and pk3(j) = p_k3
    then
     if fld = 'ERRMSG'
      then
       return( errmsg(j) );
     elsif fld = 'V1'
      then
       return( strang.f_sap_format(v1(j),'PO') );
     elsif fld = 'V2'
      then
       return( v2(j) );
     elsif fld = 'V3'
      then
       return( v3(j) );
     elsif fld = 'V4'
      then
       return( v4(j) );
     elsif fld = 'V5'
      then
       return( v5(j) );
     elsif fld = 'V6'
      then
       return( strang.f_sap_format(v6(j),'INVENTORYNO') );
     elsif fld = 'V7'
      then
       return( v7(j) );
     elsif fld = 'V8'
      then
       return( v8(j) );
     elsif fld = 'V1i'
      then
       return( strang.f_sap_format(v1i(j),'DELIVERYNO') );
     elsif fld = 'V8i'
      then
       return( v8i(j) );
     elsif fld = 'v8ii'
      then
       return( v8ii(j) );
     elsif fld = 'V9i'
      then
       return( v9i(j) );
     elsif fld = 'V9'
      then
       return( v9(j) );
     elsif fld = 'V10'
      then
       return( v10(j) );
     end if;
   end if;
  end loop;
  return( defval );
 end vld;

begin
 if not dapi.init( surl, 'STRANGP.CONTAINER_MAINTAIN_MASS', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'CONTAINER_MAINTAIN_MASS');
    return;
 end if;

 begin container := p1; exception when others then container_maintain( surl, p1, p2, rid, vrecctr, 'Container is not a Valid Number' ); return; end;
 begin seal := p2; exception when others then container_maintain( surl, p1, p2, rid, vrecctr, 'Seal is not a Valid Number' ); return; end;
 if container = ' ' or seal = ' ' then container_maintain( surl, p1, p2, rid, vrecctr, 'Container is Invalid' ); return; end if;

 vste := customer_state(dapi.GLOBAL_ACCOUNT.acctid);
 vaccess := data_access( 'CONTAINER_MAINTAIN' );
 seclevel := security_role( dapi.GLOBAL_ACCOUNT.acctid );

 main_title( 'Container Maintain Mass Edit',helpid=>'STR22',dispmenu=>FALSE);

 header_msg( nvl(msg,'Container Maintain Mass Edit') );

 htp.p( '<CENTER>' );
 if vaccess = 'NONE' then htp.bold( 'Access Denied' ); htp.htmlclose; return; end if;
 htp.bold( 'Container' || ':' || container || '&nbsp;&nbsp;&nbsp;' || 'Seal' || ':' || seal);
 htp.nl;

 htp.formopen( 'strangp.accept_container_maintain_mass' );
 htp.formhidden( 'SURL', surl );
 htp.formhidden( 'RID', rid );
 htp.formhidden( 'VRECCTR', vrecctr );
 htp.formhidden( 'P1', p1 );
 htp.formhidden( 'P2', p2 );
   htp.formhidden( 'FORCE_SINGLE_DISP', force_single_disp);
   htp.formhidden( 'POPUP', popup);
 htp.nl;
 htp.tableopen( cattributes=>'class="str1_table"' );
  htp.tablerowopen;
    htp.tableheader( 'Container');
    htp.tableheader( 'Delivery No');
    htp.tableheader( 'PO RecNo');
    htp.tableheader( 'OTML Delno');
    htp.tableheader( 'OTML Qty');
    htp.tableheader( 'Purchase Order');
    htp.tableheader( 'PO Item');
    htp.tableheader( 'Supplier Invoice');
    htp.tableheader( 'Amount Orig Curr');
    htp.tableheader( 'Delivery Charge');
    htp.tableheader( 'Quantity');
    htp.tableheader( 'Corrected Unit');
    htp.tableheader( 'Old Unit');
    htp.tableheader( 'Inventory Number');
    htp.tableheader( 'Description');
    htp.tableheader( 'Tariff');
    htp.tableheader( 'AHECC');
    htp.tableheader( 'State');
    htp.tableheader( 'Data Entry Validation Message');
  htp.tablerowclose;
  foundrec := FALSE;
  for c2rec in c2(container, seal) loop
   foundrec := TRUE;
   htp.tablerowopen;
    htp.tabledata( htf.formhidden( 'PK1', c2rec.movement_no ) || htf.bold(c2rec.movement_no),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formhidden( 'PK2', c2rec.deliveryno ) || htf.bold(c2rec.deliveryno),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formhidden( 'PK3', c2rec.recno ) || htf.bold(c2rec.recno),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formtext( 'V1i',10,15,vld(c2rec.movement_no,c2rec.deliveryno,c2rec.recno,'V1i',c2rec.sap_delno)),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formtext( 'V8i',8,10,vld(c2rec.movement_no,c2rec.deliveryno,c2rec.recno,'V8i',c2rec.sap_delno_item)),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formtext( 'V1',12,15,vld(c2rec.movement_no,c2rec.deliveryno,c2rec.recno,'V1',c2rec.po)),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formtext( 'V8ii',5,10,vld(c2rec.movement_no,c2rec.deliveryno,c2rec.recno,'V8ii',c2rec.po_item_no)),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formtext( 'V2',8,15,vld(c2rec.movement_no,c2rec.deliveryno,c2rec.recno,'V2',c2rec.supinv)),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formtext( 'V3',10,20,vld(c2rec.movement_no,c2rec.deliveryno,c2rec.recno,'V3',trim(to_char(c2rec.tamount,G_MONEY_FORMAT)))),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formtext( 'V10',5,10,vld(c2rec.movement_no,c2rec.deliveryno,c2rec.recno,'V10',trim(to_char(c2rec.delivery_charge,G_MONEY_FORMAT)))),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formtext( 'V4',5,10,vld(c2rec.movement_no,c2rec.deliveryno,c2rec.recno,'V4',c2rec.qty)),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formtext( 'V5',5,8,vld(c2rec.movement_no,c2rec.deliveryno,c2rec.recno,'V5',c2rec.tunit)),cattributes=>'class="str1_bg_left"');
    htp.tabledata( nvl(c2rec.unit_unitused,'&nbsp;'),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formtext( 'V6',12,100,vld(c2rec.movement_no,c2rec.deliveryno,c2rec.recno,'V6',c2rec.code)),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formtext( 'V7',20,1000,nvl(vld(c2rec.movement_no,c2rec.deliveryno,c2rec.recno,'V7',c2rec.description),c2rec.description)),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formtext( 'V8',11,20,nvl(vld(c2rec.movement_no,c2rec.deliveryno,c2rec.recno,'V8',c2rec.cola),c2rec.cola)),cattributes=>'class="str1_bg_left"');
    htp.tabledata( nvl(vld(c2rec.movement_no,c2rec.deliveryno,c2rec.recno,'ERRMSG','&nbsp;'),'Success'),cattributes=>'class="str1_bg_left"');
    -- htp.tabledata( htf.formtext( 'V9i',11,20,vld(c2rec.movement_no,c2rec.deliveryno,c2rec.recno,'V9i',strang.f_ahecc(c2rec.ahecc,c2rec.state,c2rec.tamount,c2rec.delivery_charge,container,seal))),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formtext( 'V9i',11,20,strang.f_ahecc(c2rec.ahecc,c2rec.state,c2rec.tamount,c2rec.delivery_charge,container,seal)),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formtext( 'V9',3,8,vld(c2rec.movement_no,c2rec.deliveryno,c2rec.recno,'V9',c2rec.state)),cattributes=>'class="str1_bg_left"');
   htp.tablerowclose;
  end loop;
 htp.tableclose;
 htp.nl;
 if not foundrec then htp.init; container_maintain( surl, p1, p2, rid, vrecctr, 'No Containers found that Satisfy this Query', force_single_disp=>force_single_disp, popup=>popup ); return; end if;
 htp.tableopen( cattributes=>'cellpadding=2 cellspacing=2 border=0' );
  htp.tablerowopen;
   htp.tabledata( htf.formsubmit( null, 'Modify Data' ) || htf.formclose );
   if popup = 'T'
    then
   htp.tabledata( htf.formopen( 'strangp.receive', ctarget=>'_top' ) || htf.formhidden( 'SURL', surl ) || htf.formhidden( 'RID', replace(rid,'~','+') ) ||
                  htf.formhidden( 'SCID', NULL ) || htf.formhidden( 'VRECCTR', vrecctr ) || htf.formhidden( 'CALL_NAME', null ) || htf.formhidden( 'PARM', 'DETAILRS' ) || htf.formhidden( 'ACCESS_ID', 'x' ) || htf.formsubmit( null, 'Cancel', cattributes=>'onClick="self.close(); return;"' ) || htf.formclose );
    else
   htp.tabledata( htf.formopen( 'strangp.receive', ctarget=>'_top' ) || htf.formhidden( 'SURL', surl ) || htf.formhidden( 'RID', replace(rid,'~','+') ) ||
                  htf.formhidden( 'SCID', NULL ) || htf.formhidden( 'VRECCTR', vrecctr ) || htf.formhidden( 'CALL_NAME', null ) || htf.formhidden( 'PARM', 'DETAILRS' ) || htf.formhidden( 'ACCESS_ID', 'x' ) || htf.formsubmit( null, 'Cancel' ) || htf.formclose );
   end if;
  htp.tablerowclose;
 htp.tableclose;
 htp.nl;
   htp.nl;
   if popup = 'T' then htp.p('<a href="" onClick="self.close()">[Close Window]</a>'); end if;
 htp.p( '</CENTER>' );
 htp.htmlclose;
exception when others then
 error_details( 'STRANGP', 'CONTAINER_MAINTAIN_MASS',null,null,errmsg=>sqlerrm,extdet=>'P1:' || p1 || '-' || 'P2:' || p2);
end container_maintain_mass;


--  %%%%%%%%%%%%%%%%%%%%%%%%% new work 190407 %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

procedure accept_container_maintain_mass(surl in varchar2, p1 in varchar2, p2 in varchar2, rid in varchar2, vrecctr in varchar2, pk1 in owa.vc_arr, pk2 in owa.vc_arr, pk3 in owa.vc_arr,
                              v1 in owa.vc_arr, v2 in owa.vc_arr, v3 in owa.vc_arr, v4 in owa.vc_arr, v5 in owa.vc_arr, v6 in owa.vc_arr, v7 in owa.vc_arr, v8 in owa.vc_arr, v1i in owa.vc_arr, v8i in owa.vc_arr, v8ii in owa.vc_arr, v9 in owa.vc_arr, v9i in owa.vc_arr, v10 in owa.vc_arr, force_single_disp in char default 'F', popup in char default 'F' )
as

 cursor c3(lname varchar2, lcode varchar2) is select * from strang.lov where lov_name = lname and code = lcode;
 cursor c4 (v_deliveryno number, v_recno number) is
  select *
  from   strang.pos
  where  deliveryno = v_deliveryno
         and recno = v_recno
		 and rownum < 2
  FOR UPDATE;

 c3rec		c3%ROWTYPE;
 c4rec		c4%ROWTYPE;
 sts		varchar2(100);
 vaccess	varchar2(20);
 vste		varchar2(10);
 errmsg		owa.vc_arr;
 errfound	boolean;
 dupl_values	boolean;
 errunit	char(1);
 errstate	char(1);
 msg		varchar2(1000);
 nmb1		STRANG.POS.TAMOUNT%TYPE;
 nmb2		STRANG.POS.QTY%TYPE;
 nmb3		STRANG.POS.DELIVERY_CHARGE%TYPE;
 oinv		STRANG.POS.INVENTORYNO%TYPE;
 vahecc		STRANG.POS.AHECC%TYPE;
 dupctr_a	integer;
 dupctr_b	integer;
 tmp		number;
 tmp2		number;

begin
 if not dapi.init( surl, 'STRANGP.ACCEPT_CONTAINER_MAINTAIN_MASS', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'ACCEPT_CONTAINER_MAINTAIN_MASS');
    return;
 end if;

 vste := customer_state(dapi.GLOBAL_ACCOUNT.acctid);
 vaccess := data_access( 'CONTAINER_MAINTAIN' );
 if vaccess = 'NONE' then htp.bold( 'Access Denied' ); htp.htmlclose; return; end if;

 errfound := FALSE;

 for j in pk1.first..pk1.last loop
  errmsg(j) := NULL;
  if pk1(j) is not null
   then
    -- Validate Numbers Entered
    begin
      nmb1 := to_number( replace(replace(v3(j),',',''),'$','') );
    exception when others then
     begin
       nmb1 := to_number( v3(j), G_MONEY_FORMAT );
      exception when others then
       errfound := TRUE;
       errmsg(j) := errmsg(j) || ' ' || 'Invalid Total Amount Entered.';
       nmb1 := NULL;
     end;
    end;
    if v10(j) is not null
    then
      begin
        nmb3 := to_number( replace(replace(v10(j),',',''),'$','') );
      exception when others then
       begin
         nmb3 := to_number( v10(j), G_MONEY_FORMAT );
        exception when others then
         errfound := TRUE;
         errmsg(j) := errmsg(j) || ' ' || 'Invalid Delivery Charge Entered.';
         nmb3 := NULL;
       end;
      end;
    end if;
    begin
      nmb2 := to_number( v4(j) );
      if nmb2 < 0.001
       then
        errfound := TRUE;
        errmsg(j) := errmsg(j) || ' ' || 'Quantity cannot be less than 0.001';
        nmb2 := NULL;
      end if;
      exception when others then
       errfound := TRUE;
       errmsg(j) := errmsg(j) || ' ' || 'Invalid Quantity Entered.';
       nmb2 := NULL;
    end;
    begin
      nmb2 := to_number( v1i(j) );
      exception when others then
       errfound := TRUE;
       errmsg(j) := errmsg(j) || ' ' || 'Invalid SAP Delno Entered.';
       nmb2 := NULL;
    end;
    begin
       errmsg(j) := errmsg(j) || ' ' || 'Invalid SAP Line Entered.';
      nmb2 := to_number( v8i(j) );
      exception when others then
       errfound := TRUE;
       nmb2 := NULL;
    end;
    begin
      nmb2 := to_number( v8ii(j) );
      exception when others then
       errfound := TRUE;
       errmsg(j) := errmsg(j) || ' ' || 'Invalid PO Item Entered.';
       nmb2 := NULL;
    end;

    oinv := trim( v6(j) );

    if v1(j) is null
     then
       errfound := TRUE;
       errmsg(j) := errmsg(j) || ' ' || 'Purchase Order cannot be blank.';
    end if;

    if v2(j) is null
     then
       errfound := TRUE;
       errmsg(j) := errmsg(j) || ' ' || 'Supplier Invoice cannot be blank.';
    end if;

    -- Check Unit
    c3rec.code := NULL;
    errunit := 'F';
    if v5(j) is not null
     then
      open c3( 'UNITS', upper(v5(j)));
      fetch c3 into c3rec;
      if c3%NOTFOUND
       then
        close c3;
        errfound := TRUE;
        errmsg(j) := errmsg(j) || ' ' || 'Incorrect Current Unit.';
        errunit := 'T';
       else
        close c3;
      end if;
    end if;

    -- Check State
    c3rec.code := NULL;
    errstate := 'F';
    if v9(j) is not null
     then
      open c3( 'STATE', upper(v9(j)));
      fetch c3 into c3rec;
      if c3%NOTFOUND
       then
        close c3;
        errfound := TRUE;
        errmsg(j) := errmsg(j) || ' ' || 'State should be FOR, NSW, QLD, VIC, SA, NT, WA, ACT';
        errstate := 'T';
       else
        close c3;
      end if;
    end if;

    update strang.pos
     set
      sap_delno = nvl(strang.f_sap_format(v1i(j),'DELIVERYNO'),sap_delno),
      sap_delno_item = nvl(v8i(j),sap_delno_item),
      supinv = nvl(v2(j),supinv),
      po = nvl(strang.f_sap_format(v1(j),'PO'),po),
      po_item_no = nvl(v8ii(j),po_item_no),
      tamount = nvl(nmb1,tamount),
      qty = nvl(V4(j),qty),
      unit_unitused = decode(errunit,'F',upper(v5(j)),'T',unit_unitused),
      inventoryno = nvl(strang.f_sap_format(oinv,'INVENTORYNO'),inventoryno),
      state = decode(errstate,'F',upper(v9(j)),'T',state),
--      ahecc = nvl(v9i(j),ahecc), --strang.f_ahecc(v9i(j),decode(errstate,'F',upper(v9(j)),'T',state),nvl(nmb1,tamount),nmb3,p1,p2)  , --nvl(v9i(j),ahecc),
--      ahecc = vahecc,
      delivery_charge = nmb3 --v10(j)
    where
     deliveryno = pk2(j) and
     recno = pk3(j);

	open c4(pk2(j), pk3(j));
	fetch c4 into c4rec;
	if c4%FOUND
	 then
	  vahecc := strang.f_ahecc(v9i(j),c4rec.state,nvl(nmb1,c4rec.tamount),nmb3,p1,p2);
	  update strang.pos
	  set    ahecc = vahecc
	  where  current of c4;
	end if;
	close c4;

    -- 'Update Purchase Order' Quantities for new Form 15  19-Apr-07 %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

    if v5(j) = 'KG' or v5(j) = 'TONNE'
    then

     if v5(j) = 'KG'
       then
        tmp2 := null;
        select sum(nvl(partweight,0)) into tmp2 from strang.detailrs where deliveryno=pk2(j);
        select count('x') into tmp from strang.pos where deliveryno = pk2(j);
        tmp2 := round(tmp2/tmp,0);
        if tmp2 < 1
         then
          tmp2 := 1;
        end if;
     elsif v5(j) = 'TONNE'
      then
        tmp2 := null;
        select sum(nvl(partweight,0)) into tmp2 from strang.detailrs where deliveryno=pk2(j);
        select count('x') into tmp from strang.pos where deliveryno = pk2(j);
        tmp2 := round((tmp2/tmp)/1000,3);
        if tmp2 < 0.001
         then
         tmp2 := 0.001;
        end if;

     end if;
     update strang.pos
      set
      qty = tmp2
     where
      deliveryno = pk2(j) and
      recno = pk3(j);
    end if;


    -- Check if Inventory Exists
    if oinv is not null
     then

      -- Check if multiple inventory numbers have been entered, and if
      dupl_values := FALSE;
      dupctr_a := 0;
      dupctr_b := 0;
      for k in pk1.first..pk1.last loop
       if oinv is not null and trim(v6(k)) is not null and oinv = trim(v6(k))
        then
         -- Check if the Description is different and not null
         if trim(v7(j)) is not null and trim(v7(k)) is not null and trim(v7(j)) <> trim(v7(k))
          then
           dupctr_a := dupctr_a + 1;
         end if;
         -- Check if the Tariff number is different and not null
         if trim(v8(j)) is not null and trim(v8(k)) is not null and trim(v8(j)) <> trim(v8(k))
          then
           dupctr_b := dupctr_b + 1;
         end if;
       end if;
      end loop;

      if dupctr_a > 0
       then
        errmsg(j) := errmsg(j) || ' ' || 'Different descriptions exist for the same Inventory Number.';
        dupl_values := TRUE;
      end if;

      if dupctr_b > 0
       then
        errmsg(j) := errmsg(j) || ' ' || 'Different Tariff Numbers exist for the same Inventory Number.';
        dupl_values := TRUE;
      end if;

      if dupl_values
       then
        --
        errfound := TRUE;

       else
        open c3('INVENT',v6(j));
        fetch c3 into c3rec;
        if c3%FOUND
         then
          close c3;
          update strang.lov
           set
            description = nvl(v7(j),description)
          where
           lov_name = 'INVENT' and
           code = oinv;
         else
          close c3;
          insert into strang.lov(lov_name,code,description,cola) values ('INVENT',v6(j),v7(j),v8(j));
        end if;
      end if;

      -- Check if Tariff Exists
      if v8(j) is null
       then
        null;
       else
        open c3('TARIFF',v8(j));
        fetch c3 into c3rec;
        if c3%FOUND
         then
          close c3;
          update strang.lov
           set
            cola = v8(j)
          where
           lov_name = 'INVENT' and
           code = oinv;
         else
          close c3;
          errfound := TRUE;
          errmsg(j) := errmsg(j) || ' ' || 'Tariff value not found - ' || htf.anchor2( 'strangp.accept_lov?surl=' || surl || '&parm=TARIFF&SRC=&LRANGE=&P0=&P1=&P2=&P3=&P4=&P5=&ACTION=' || replace('Insert New Values',' ','+'),'Insert New Tariff.', ctarget=>'INSWIND');
        end if;
      end if;
    end if;

  end if;
 end loop;
 commit;
 if errfound then msg := 'Errors found Modifying Data. Please Review each Log Record to see what the Error was.'; end if;

 container_maintain_mass(surl, p1, p2, rid,vrecctr, pk1, pk2, pk3, v1, v2, v3, v4, v5, v6, v7, v8, v1i, v8i, v8ii, v9, v9i,v10, errmsg, msg, force_single_disp=>force_single_disp, popup=>popup );

exception when others then
 error_details( 'STRANGP', 'ACCEPT_CONTAINER_MAINTAIN_MASS',null,null,errmsg=>sqlerrm,extdet=>'P1:' || p1 || '-' || 'P2:' || p2);
end accept_container_maintain_mass;
-- 20170517

procedure log_maintain(surl in varchar2, strt in varchar2, rid in varchar2, vrecctr in varchar2, msg in varchar2 default null, force_single_disp in char default 'F', popup in char default 'F' )
as

 sts		varchar2(100);
 vaccess	varchar2(20);
 vste		varchar2(10);
 seclevel	varchar2(100);

begin
 if not dapi.init( surl, 'STRANGP.LOG_MAINTAIN', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'LOG_MAINTAIN');
    return;
 end if;

 vste := customer_state(dapi.GLOBAL_ACCOUNT.acctid);
 vaccess := data_access( 'LOG_MAINTAIN' );
 seclevel := security_role( dapi.GLOBAL_ACCOUNT.acctid );

 main_title( 'Choose Log Number',helpid=>'STR23',dispmenu=>FALSE);

 header_msg( nvl(msg,'Log Maintain') );

 htp.p( '<CENTER>' );
 if vaccess = 'NONE' then htp.bold( 'Access Denied' ); htp.htmlclose; return; end if;

 htp.formopen( 'strangp.log_maintain_mass' );
 htp.formhidden( 'SURL', surl );
 htp.formhidden( 'RID', rid );
 htp.formhidden( 'VRECCTR', vrecctr );
 htp.formhidden( 'PK1', NULL );
 htp.formhidden( 'PK2', NULL );
 htp.formhidden( 'PK3', NULL );
 htp.formhidden( 'V1', NULL );
 htp.formhidden( 'V2', NULL );
 htp.formhidden( 'V3', NULL );
 htp.formhidden( 'V4', NULL );
 htp.formhidden( 'V5', NULL );
 htp.formhidden( 'V6', NULL );
 htp.formhidden( 'V7', NULL );
 htp.formhidden( 'V8', NULL );
 htp.formhidden( 'V1i', NULL );
 htp.formhidden( 'V8i', NULL );
 htp.formhidden( 'V8ii', NULL );
 htp.formhidden( 'V9i', NULL );
 htp.formhidden( 'V9', NULL );
 htp.formhidden( 'V10', NULL );
 htp.formhidden( 'ERRMSG', NULL );
   htp.formhidden( 'FORCE_SINGLE_DISP', force_single_disp);
   htp.formhidden( 'POPUP', popup);
 htp.nl;
 htp.tableopen( cattributes=>'class="str1_table"' );
  htp.tablerowopen;
     htp.tabledata( htf.bold('Log No'),cattributes=>'class="str1_bg_right"');
     htp.tabledata( htf.formtext('P1',20,30, strt),cattributes=>'class="str1_bg_left"');
  htp.tablerowclose;
 htp.tableclose;
 htp.nl;
 htp.tableopen( cattributes=>'cellpadding=2 cellspacing=2 border=0' );
  htp.tablerowopen;
   htp.tabledata( htf.formsubmit( null, 'Submit' ) || htf.formclose );
   if popup = 'T'
    then
   htp.tabledata( htf.formopen( 'strangp.receive', ctarget=>'_top' ) || htf.formhidden( 'SURL', surl ) || htf.formhidden( 'RID', replace(rid,'~','+') ) ||
                  htf.formhidden( 'SCID', NULL ) || htf.formhidden( 'VRECCTR', vrecctr ) || htf.formhidden( 'CALL_NAME', null ) || htf.formhidden( 'PARM', 'DETAILRS' ) || htf.formhidden( 'ACCESS_ID', 'x' ) || htf.formsubmit( null, 'Cancel', cattributes=>'onClick="self.close(); return;"' ) || htf.formclose );
    else
   htp.tabledata( htf.formopen( 'strangp.receive', ctarget=>'_top' ) || htf.formhidden( 'SURL', surl ) || htf.formhidden( 'RID', replace(rid,'~','+') ) ||
                  htf.formhidden( 'SCID', NULL ) || htf.formhidden( 'VRECCTR', vrecctr ) || htf.formhidden( 'CALL_NAME', null ) || htf.formhidden( 'PARM', 'DETAILRS' ) || htf.formhidden( 'ACCESS_ID', 'x' ) || htf.formsubmit( null, 'Cancel' ) || htf.formclose );
   end if;
  htp.tablerowclose;
 htp.tableclose;

 htp.nl;
   htp.nl;
 if popup = 'T' then htp.p('<a href="" onClick="self.close()">[Close Window]</a>'); end if;
 htp.p( '</CENTER>' );
 htp.htmlclose;
exception when others then
 error_details( 'STRANGP', 'LOG_MAINTAIN',null,null,errmsg=>sqlerrm,extdet=>'Strt:' || strt);
end log_maintain;


procedure log_maintain_mass(surl in varchar2, p1 in varchar2, rid in varchar2, vrecctr in varchar2, pk1 in owa.vc_arr, pk2 in owa.vc_arr, pk3 in owa.vc_arr,
                              v1 in owa.vc_arr, v2 in owa.vc_arr, v3 in owa.vc_arr, v4 in owa.vc_arr, v5 in owa.vc_arr, v6 in owa.vc_arr, v7 in owa.vc_arr, v8 in owa.vc_arr, v1i in owa.vc_arr, v8i in owa.vc_arr, v8ii in owa.vc_arr, v9 in owa.vc_arr, v9i in owa.vc_arr, v10 in owa.vc_arr, errmsg in owa.vc_arr, msg in varchar2 default null, force_single_disp in char default 'F', popup in char default 'F' )
as
 cursor c2(logno varchar2) is
  select /*+ ALL_ROWS */ distinct dr.logno,dr.movement_no, p.deliveryno, p.recno, p.sap_delno, p.sap_delno_item, p.po, p.po_item_no, p.supinv, p.tamount, p.qty, p.unit_unitused,t.cola tunit, i.code,  i.description, i.cola cola, p.state, p.ahecc, p.delivery_charge
  from strang.lov i, strang.pos p, strang.detailrs dr, strang.lov t
  where dr.logno = p1 and
        dr.deliveryno = p.deliveryno and
        p.inventoryno = i.code and
        i.lov_name = 'INVENT' and
        t.lov_name = 'TARIFF' and
        t.code = i.cola
 union all
  select /*+ ALL_ROWS */ distinct dr.logno,dr.movement_no, p.deliveryno, p.recno, p.sap_delno, p.sap_delno_item, p.po, p.po_item_no, p.supinv, p.tamount, p.qty, p.unit_unitused, null tunit, i.code,  i.description, i.cola cola, p.state, p.ahecc, p.delivery_charge
  from strang.lov i, strang.pos p, strang.detailrs dr
  where  dr.logno = p1 and
        dr.deliveryno = p.deliveryno and
        p.inventoryno = i.code and
        i.lov_name = 'INVENT' and
        (i.cola is null or i.cola not in (select t.code from strang.lov t where t.lov_name = 'TARIFF'))
 union all
  select /*+ ALL_ROWS */ distinct dr.logno,dr.movement_no, p.deliveryno, p.recno, p.sap_delno, p.sap_delno_item, p.po, p.po_item_no, p.supinv, p.tamount, p.qty, p.unit_unitused, null tunit, p.inventoryno code, null description, null cola, p.state, p.ahecc, p.delivery_charge
  from strang.pos p, strang.detailrs dr
  where  dr.logno = p1 and
        dr.deliveryno = p.deliveryno and
        (p.inventoryno is null or p.inventoryno not in (select i.code from strang.lov i where i.lov_name = 'INVENT'))
order by 1,2,3,4;

 foundrec	boolean;
 sts		varchar2(100);
 vaccess	varchar2(20);
 vste		varchar2(10);
 seclevel	varchar2(100);
 logno		varchar2(15);

 function vld( p_k1 in varchar2, p_k2 in varchar2, p_k3 in varchar2, fld in varchar2, defval in varchar2 )
  return varchar2
 as
 begin
  for j in pk1.first..pk1.last loop
   if pk1(j) = p_k1 and pk2(j) = p_k2 and pk3(j) = p_k3
    then
     if fld = 'ERRMSG'
      then
       return( errmsg(j) );
     elsif fld = 'V1'
      then
       return( strang.f_sap_format(v1(j),'PO') );
     elsif fld = 'V2'
      then
       return( v2(j) );
     elsif fld = 'V3'
      then
       return( v3(j) );
     elsif fld = 'V4'
      then
       return( v4(j) );
     elsif fld = 'V5'
      then
       return( v5(j) );
     elsif fld = 'V6'
      then
       return( strang.f_sap_format(v6(j),'INVENTORYNO') );
     elsif fld = 'V7'
      then
       return( v7(j) );
     elsif fld = 'V8'
      then
       return( v8(j) );
     elsif fld = 'V1i'
      then
       return( strang.f_sap_format(v1i(j),'DELIVERYNO') );
     elsif fld = 'V8i'
      then
       return( v8i(j) );
     elsif fld = 'v8ii'
      then
       return( v8ii(j) );
     elsif fld = 'V9i'
      then
       return( v9i(j) );
     elsif fld = 'V9'
      then
       return( v9(j) );
     elsif fld = 'V10'
      then
       return( v10(j) );
     end if;
   end if;
  end loop;
  return( defval );
 end vld;

begin
 if not dapi.init( surl, 'STRANGP.LOG_MAINTAIN_MASS', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'LOG_MAINTAIN_MASS');
    return;
 end if;

 begin logno := p1; exception when others then log_maintain( surl, p1, rid, vrecctr, 'Log is not a Valid Number' ); return; end;
 if logno = ' ' then log_maintain( surl, p1, rid, vrecctr, 'Log number is Invalid' ); return; end if;

 vste := customer_state(dapi.GLOBAL_ACCOUNT.acctid);
 vaccess := data_access( 'LOG_MAINTAIN' );
 seclevel := security_role( dapi.GLOBAL_ACCOUNT.acctid );

 main_title( 'Log Maintain Mass Edit',helpid=>'STR24',dispmenu=>FALSE);

 header_msg( nvl(msg,'Log Maintain Mass Edit') );

 htp.p( '<CENTER>' );
 if vaccess = 'NONE' then htp.bold( 'Access Denied' ); htp.htmlclose; return; end if;
 htp.bold( 'Log Number' || ':' || logno );
 htp.nl;

 htp.formopen( 'strangp.accept_log_maintain_mass' );
 htp.formhidden( 'SURL', surl );
 htp.formhidden( 'RID', rid );
 htp.formhidden( 'VRECCTR', vrecctr );
 htp.formhidden( 'P1', p1 );
   htp.formhidden( 'FORCE_SINGLE_DISP', force_single_disp);
   htp.formhidden( 'POPUP', popup);
    htp.tabledata( htf.bold('Log No'),cattributes=>'class="str1_bg_left"');
 htp.nl;
 htp.tableopen( cattributes=>'class="str1_table"' );
  htp.tablerowopen;
    htp.tableheader( 'LogNo');
    htp.tableheader( 'Delivery No');
    htp.tableheader( 'Purchase Order');
    htp.tableheader( 'PO Item');
    htp.tableheader( 'Supplier Invoice');
    htp.tableheader( 'Amount Orig Curr');
    htp.tableheader( 'Delivery Charge');
    htp.tableheader( 'Quantity');
    htp.tableheader( 'Corrected Unit');
    htp.tableheader( 'Old Unit');
    htp.tableheader( 'Inventory Number');
    htp.tableheader( 'Description');
    htp.tableheader( 'Tariff');
    htp.tableheader( 'AHECC');
    htp.tableheader( 'State');
    htp.tableheader( 'Data Entry Validation Message');
  htp.tablerowclose;
  foundrec := FALSE;
  for c2rec in c2(logno) loop
   foundrec := TRUE;
   htp.tablerowopen;
    htp.tabledata( htf.formhidden( 'PK1', c2rec.logno ) || htf.bold(c2rec.logno),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formhidden( 'PK2', c2rec.deliveryno ) || htf.bold(c2rec.deliveryno) || htf.formhidden( 'PK3', c2rec.recno ) || htf.formhidden( 'V1i',vld(c2rec.logno,c2rec.deliveryno,c2rec.recno,'V1i',c2rec.sap_delno)) || htf.formhidden( 'V8i',vld(c2rec.logno,c2rec.deliveryno,c2rec.recno,'V8i',c2rec.sap_delno_item)),cattributes=>'class="str1_bg_left"');
    --htp.tabledata( htf.bold(c2rec.recno),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formtext( 'V1',12,15,vld(c2rec.logno,c2rec.deliveryno,c2rec.recno,'V1',c2rec.po)),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formtext( 'V8ii',5,10,vld(c2rec.logno,c2rec.deliveryno,c2rec.recno,'V8ii',c2rec.po_item_no)),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formtext( 'V2',8,15,vld(c2rec.logno,c2rec.deliveryno,c2rec.recno,'V2',c2rec.supinv)),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formtext( 'V3',10,20,vld(c2rec.logno,c2rec.deliveryno,c2rec.recno,'V3',trim(to_char(c2rec.tamount,G_MONEY_FORMAT)))),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formtext( 'V10',5,10,vld(c2rec.logno,c2rec.deliveryno,c2rec.recno,'V10',c2rec.delivery_charge)),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formtext( 'V4',5,10,vld(c2rec.logno,c2rec.deliveryno,c2rec.recno,'V4',c2rec.qty)),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formtext( 'V5',5,8,vld(c2rec.logno,c2rec.deliveryno,c2rec.recno,'V5',c2rec.tunit)),cattributes=>'class="str1_bg_left"');
    htp.tabledata( nvl(c2rec.unit_unitused,'&nbsp;'),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formtext( 'V6',12,100,vld(c2rec.logno,c2rec.deliveryno,c2rec.recno,'V6',c2rec.code)),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formtext( 'V7',20,1000,nvl(vld(c2rec.logno,c2rec.deliveryno,c2rec.recno,'V7',c2rec.description),c2rec.description)),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formtext( 'V8',11,20,nvl(vld(c2rec.logno,c2rec.deliveryno,c2rec.recno,'V8',c2rec.cola),c2rec.cola)),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formtext( 'V9i',11,20,vld(c2rec.logno,c2rec.deliveryno,c2rec.recno,'V9i',c2rec.ahecc)),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formtext( 'V9',3,8,vld(c2rec.logno,c2rec.deliveryno,c2rec.recno,'V9',c2rec.state)),cattributes=>'class="str1_bg_left"');
    htp.tabledata( nvl(vld(c2rec.logno,c2rec.deliveryno,c2rec.recno,'ERRMSG','&nbsp;'),'Success'),cattributes=>'class="str1_bg_left"');
   htp.tablerowclose;
  end loop;
 htp.tableclose;
 htp.nl;
 if not foundrec then htp.init; log_maintain( surl, p1, rid, vrecctr, 'No Logs found that Satisfy this Query', force_single_disp=>force_single_disp, popup=>popup ); return; end if;
 htp.tableopen( cattributes=>'cellpadding=2 cellspacing=2 border=0' );
  htp.tablerowopen;
   htp.tabledata( htf.formsubmit( null, 'Modify Data' ) || htf.formclose );
   if popup = 'T'
    then
   htp.tabledata( htf.formopen( 'strangp.receive', ctarget=>'_top' ) || htf.formhidden( 'SURL', surl ) || htf.formhidden( 'RID', replace(rid,'~','+') ) ||
                  htf.formhidden( 'SCID', NULL ) || htf.formhidden( 'VRECCTR', vrecctr ) || htf.formhidden( 'CALL_NAME', null ) || htf.formhidden( 'PARM', 'DETAILRS' ) || htf.formhidden( 'ACCESS_ID', 'x' ) || htf.formsubmit( null, 'Cancel', cattributes=>'onClick="self.close(); return;"' ) || htf.formclose );
    else
   htp.tabledata( htf.formopen( 'strangp.receive', ctarget=>'_top' ) || htf.formhidden( 'SURL', surl ) || htf.formhidden( 'RID', replace(rid,'~','+') ) ||
                  htf.formhidden( 'SCID', NULL ) || htf.formhidden( 'VRECCTR', vrecctr ) || htf.formhidden( 'CALL_NAME', null ) || htf.formhidden( 'PARM', 'DETAILRS' ) || htf.formhidden( 'ACCESS_ID', 'x' ) || htf.formsubmit( null, 'Cancel' ) || htf.formclose );
   end if;
  htp.tablerowclose;
 htp.tableclose;
 htp.nl;
   htp.nl;
 if popup = 'T' then htp.p('<a href="" onClick="self.close()">[Close Window]</a>'); end if;
 htp.p( '</CENTER>' );
 htp.htmlclose;
exception when others then
 error_details( 'STRANGP', 'LOG_MAINTAIN_MASS',null,null,errmsg=>sqlerrm,extdet=>'P1:' || p1);
end log_maintain_mass;



--  %%%%%%%%%%%%%%%%%%%%%%%%% new work 190407 %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
procedure accept_log_maintain_mass(surl in varchar2, p1 in varchar2, rid in varchar2, vrecctr in varchar2, pk1 in owa.vc_arr, pk2 in owa.vc_arr, pk3 in owa.vc_arr,
                              v1 in owa.vc_arr, v2 in owa.vc_arr, v3 in owa.vc_arr, v4 in owa.vc_arr, v5 in owa.vc_arr, v6 in owa.vc_arr, v7 in owa.vc_arr, v8 in owa.vc_arr, v1i in owa.vc_arr, v8i in owa.vc_arr, v8ii in owa.vc_arr, v9 in owa.vc_arr, v9i in owa.vc_arr, v10 in owa.vc_arr, force_single_disp in char default 'F', popup in char default 'F' )
as

 cursor c3(lname varchar2, lcode varchar2) is select * from strang.lov where lov_name = lname and code = lcode;


 c3rec		c3%ROWTYPE;



 sts		varchar2(100);
 vaccess	varchar2(20);
 vste		varchar2(10);
 errmsg		owa.vc_arr;
 errfound	boolean;
 dupl_values	boolean;
 errunit	char(1);
 errstate	char(1);
 msg		varchar2(1000);
 nmb1		STRANG.POS.TAMOUNT%TYPE;
 nmb2		STRANG.POS.QTY%TYPE;
 nmb3		STRANG.POS.DELIVERY_CHARGE%TYPE;
 oinv		STRANG.POS.INVENTORYNO%TYPE;
 dupctr_a	integer;
 dupctr_b	integer;
 tmp		number;
 tmp2		number;

begin
 if not dapi.init( surl, 'STRANGP.ACCEPT_LOG_MAINTAIN_MASS', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'ACCEPT_LOG_MAINTAIN_MASS');
    return;
 end if;

 vste := customer_state(dapi.GLOBAL_ACCOUNT.acctid);
 vaccess := data_access( 'LOG_MAINTAIN' );
 if vaccess = 'NONE' then htp.bold( 'Access Denied' ); htp.htmlclose; return; end if;

 errfound := FALSE;

 for j in pk1.first..pk1.last loop
  errmsg(j) := NULL;
  if pk1(j) is not null
   then
    -- Validate Numbers Entered
    begin
      nmb1 := to_number( replace(replace(v3(j),',',''),'$','') );
    exception when others then
     begin
       nmb1 := to_number( v3(j), G_MONEY_FORMAT );
      exception when others then
       errfound := TRUE;
       errmsg(j) := errmsg(j) || ' ' || 'Invalid Total Amount Entered.';
       nmb1 := NULL;
     end;
    end;
    if v10(j) is not null
    then
      begin
        nmb3 := to_number( replace(replace(v10(j),',',''),'$','') );
      exception when others then
       begin
         nmb3 := to_number( v10(j), G_MONEY_FORMAT );
        exception when others then
         errfound := TRUE;
         errmsg(j) := errmsg(j) || ' ' || 'Invalid Delivery Charge Entered.';
         nmb3 := NULL;
       end;
      end;
    end if;
    begin
      nmb2 := to_number( v4(j) );
      if nmb2 < 0.001
       then
        errfound := TRUE;
        errmsg(j) := errmsg(j) || ' ' || 'Quantity cannot be less than 0.001';
        nmb2 := NULL;
      end if;
      exception when others then
       errfound := TRUE;
       errmsg(j) := errmsg(j) || ' ' || 'Invalid Quantity Entered.';
       nmb2 := NULL;
    end;
    begin
      nmb2 := to_number( v1i(j) );
      exception when others then
       errfound := TRUE;
       errmsg(j) := errmsg(j) || ' ' || 'Invalid SAP Delno Entered.';
       nmb2 := NULL;
    end;
    begin
      nmb2 := to_number( v8i(j) );
      exception when others then
       errfound := TRUE;
       errmsg(j) := errmsg(j) || ' ' || 'Invalid SAP Line Entered.';
       nmb2 := NULL;
    end;
    begin
      nmb2 := to_number( v8ii(j) );
      exception when others then
       errfound := TRUE;
       errmsg(j) := errmsg(j) || ' ' || 'Invalid PO Item Entered.';
       nmb2 := NULL;
    end;

    oinv := trim( v6(j) );

    if v1(j) is null
     then
       errfound := TRUE;
       errmsg(j) := errmsg(j) || ' ' || 'Purchase Order cannot be blank.';
    end if;

    if v2(j) is null
     then
       errfound := TRUE;
       errmsg(j) := errmsg(j) || ' ' || 'Supplier Invoice cannot be blank.';
    end if;

    -- Check Unit
    c3rec.code := NULL;
    errunit := 'F';
    if v5(j) is not null
     then
      open c3( 'UNITS', upper(v5(j)));
      fetch c3 into c3rec;
      if c3%NOTFOUND
       then
        close c3;
        errfound := TRUE;
        errmsg(j) := errmsg(j) || ' ' || 'Incorrect Current Unit.';
        errunit := 'T';
       else
        close c3;
      end if;
    end if;

    -- Check State
    c3rec.code := NULL;
    errstate := 'F';
    if v9(j) is not null
     then
      open c3( 'STATE', upper(v9(j)));
      fetch c3 into c3rec;
      if c3%NOTFOUND
       then
        close c3;
        errfound := TRUE;
        errmsg(j) := errmsg(j) || ' ' || 'State should be FOR, NSW, QLD, VIC, SA, NT, WA, ACT';
        errstate := 'T';
       else
        close c3;
      end if;
    end if;

    update strang.pos
     set
      sap_delno = nvl(strang.f_sap_format(v1i(j),'DELIVERYNO'),sap_delno),
      po_item_no = nvl(v8ii(j),po_item_no),
      sap_delno_item = nvl(v8i(j),sap_delno_item),
      supinv = nvl(v2(j),supinv),
      po = nvl(strang.f_sap_format(v1(j),'PO'),po),
      tamount = nvl(nmb1,tamount),
      qty = nvl(V4(j),qty),
      unit_unitused = decode(errunit,'F',upper(v5(j)),'T',unit_unitused),
      inventoryno = nvl(strang.f_sap_format(oinv,'INVENTORYNO'),inventoryno),
      state = decode(errstate,'F',upper(v9(j)),'T',state),
      ahecc = nvl(v9i(j),ahecc),
      delivery_charge = nmb3 --v10(j)
    where
     deliveryno = pk2(j) and
     recno = pk3(j);

    -- 'Update Purchase Order' Quantities for new Form 15  19-Apr-07 %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

    if v5(j) = 'KG' or v5(j) = 'TONNE'
    then

     if v5(j) = 'KG'
       then
        tmp2 := null;
        select sum(nvl(partweight,0)) into tmp2 from strang.detailrs where deliveryno=pk2(j);
        select count('x') into tmp from strang.pos where deliveryno = pk2(j);
        tmp2 := round(tmp2/tmp,0);
        if tmp2 < 1
         then
          tmp2 := 1;
        end if;
     elsif v5(j) = 'TONNE'
      then
        tmp2 := null;
        select sum(nvl(partweight,0)) into tmp2 from strang.detailrs where deliveryno=pk2(j);
        select count('x') into tmp from strang.pos where deliveryno = pk2(j);
        tmp2 := round((tmp2/tmp)/1000,3);
        if tmp2 < 0.001
         then
         tmp2 := 0.001;
        end if;

     end if;
     update strang.pos
      set
      qty = tmp2
     where
      deliveryno = pk2(j) and
      recno = pk3(j);
    end if;


    -- Check if Inventory Exists
    if oinv is not null
     then

      -- Check if multiple inventory numbers have been entered, and if
      dupl_values := FALSE;
      dupctr_a := 0;
      dupctr_b := 0;
      for k in pk1.first..pk1.last loop
       if oinv is not null and trim(v6(k)) is not null and oinv = trim(v6(k))
        then
         -- Check if the Description is different and not null
         if trim(v7(j)) is not null and trim(v7(k)) is not null and trim(v7(j)) <> trim(v7(k))
          then
           dupctr_a := dupctr_a + 1;
         end if;
         -- Check if the Tariff number is different and not null
         if trim(v8(j)) is not null and trim(v8(k)) is not null and trim(v8(j)) <> trim(v8(k))
          then
           dupctr_b := dupctr_b + 1;
         end if;
       end if;
      end loop;

      if dupctr_a > 0
       then
        errmsg(j) := errmsg(j) || ' ' || 'Different descriptions exist for the same Inventory Number.';
        dupl_values := TRUE;
      end if;

      if dupctr_b > 0
       then
        errmsg(j) := errmsg(j) || ' ' || 'Different Tariff Numbers exist for the same Inventory Number.';
        dupl_values := TRUE;
      end if;

      if dupl_values
       then
        --
        errfound := TRUE;

       else
        open c3('INVENT',v6(j));
        fetch c3 into c3rec;
        if c3%FOUND
         then
          close c3;
          update strang.lov
           set
            description = nvl(v7(j),description)
          where
           lov_name = 'INVENT' and
           code = oinv;
         else
          close c3;
          insert into strang.lov(lov_name,code,description,cola) values ('INVENT',v6(j),v7(j),v8(j));
        end if;
      end if;

      -- Check if Tariff Exists
      if v8(j) is null
       then
        null;
       else
        open c3('TARIFF',v8(j));
        fetch c3 into c3rec;
        if c3%FOUND
         then
          close c3;
          update strang.lov
           set
            cola = v8(j)
          where
           lov_name = 'INVENT' and
           code = oinv;
         else
          close c3;
          errfound := TRUE;
          errmsg(j) := errmsg(j) || ' ' || 'Tariff value not found - ' || htf.anchor2( 'strangp.accept_lov?surl=' || surl || '&parm=TARIFF&SRC=&LRANGE=&P0=&P1=&P2=&P3=&P4=&P5=&ACTION=' || replace('Insert New Values',' ','+'),'Insert New Tariff.', ctarget=>'INSWIND');
        end if;
      end if;
    end if;

  end if;
 end loop;
 commit;
 if errfound then msg := 'Errors found Modifying Data. Please Review each Log Record to see what the Error was.'; end if;

 log_maintain_mass(surl, p1, rid,vrecctr, pk1, pk2, pk3, v1, v2, v3, v4, v5, v6, v7, v8, v1i, v8i, v8ii, v9, v9i,v10, errmsg, msg, force_single_disp=>force_single_disp, popup=>popup );

exception when others then
 error_details( 'STRANGP', 'ACCEPT_LOG_MAINTAIN_MASS',null,null,errmsg=>sqlerrm,extdet=>'P1:' || p1 );
end accept_log_maintain_mass;

--zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz



-- end 20170517
--zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz
-- new work 290508

procedure delivery_maintain(surl in varchar2, strt in varchar2, strt2 in varchar2 default null, rid in varchar2, vrecctr in varchar2, msg in varchar2 default null )

as


 sts		varchar2(100);
 vaccess	varchar2(20);
 vste		varchar2(10);
 seclevel	varchar2(100);

begin
 if not dapi.init( surl, 'STRANGP.DELIVERY_MAINTAIN', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'DELIVERY_MAINTAIN');
    return;
 end if;

 vste := customer_state(dapi.GLOBAL_ACCOUNT.acctid);

 vaccess := data_access( 'DELIVERY_MAINTAIN' );
 seclevel := security_role( dapi.GLOBAL_ACCOUNT.acctid );

 main_title( 'Choose Delivery Number',helpid=>'STR25');

 header_msg( nvl(msg,'Delivery Maintain') );

 htp.p( '<CENTER>' );
 if vaccess = 'NONE' then htp.bold( 'Access Denied' ); htp.htmlclose; return; end if;

 htp.formopen( 'strangp.delivery_maintain_mass' );
 htp.formhidden( 'SURL', surl );
 htp.formhidden( 'RID', rid );
 htp.formhidden( 'VRECCTR', vrecctr );
 htp.formhidden( 'PK1', NULL );
 htp.formhidden( 'PK2', NULL );
 htp.formhidden( 'PK3', NULL );
 htp.formhidden( 'V1', NULL );
 htp.formhidden( 'V2', NULL );
 htp.formhidden( 'V3', NULL );
 htp.formhidden( 'V4', NULL );
 htp.formhidden( 'V5', NULL );
 htp.formhidden( 'V6', NULL );
 htp.formhidden( 'V7', NULL );
 htp.formhidden( 'V8', NULL );
 htp.formhidden( 'ERRMSG', NULL );
 htp.nl;
 htp.tableopen( cattributes=>'class="str1_table"' );
  htp.tablerowopen;
     htp.tabledata( htf.bold('Delivery No From'),cattributes=>'class="str1_bg_right"');
     htp.tabledata( htf.formtext('P1',20,30, strt),cattributes=>'class="str1_bg_left"');
  htp.tablerowclose;
  htp.tablerowopen;
     htp.tabledata( htf.bold('Delivery No To'),cattributes=>'class="str1_bg_right"');
     htp.tabledata( htf.formtext('P2',20,30, nvl(strt2, strt)),cattributes=>'class="str1_bg_left"');
  htp.tablerowclose;
 htp.tableclose;
 htp.nl;
 htp.tableopen( cattributes=>'cellpadding=2 cellspacing=2 border=0' );
  htp.tablerowopen;
   htp.tabledata( htf.formsubmit( null, 'Submit' ) || htf.formclose );
   htp.tabledata( htf.formopen( 'strangp.receive', ctarget=>'_top' ) || htf.formhidden( 'SURL', surl ) || htf.formhidden( 'RID', replace(rid,'~','+') ) ||
                  htf.formhidden( 'SCID', NULL ) || htf.formhidden( 'VRECCTR', vrecctr ) || htf.formhidden( 'CALL_NAME', null ) || htf.formhidden( 'PARM', 'DETAILRS' ) || htf.formhidden( 'ACCESS_ID', 'x' ) || htf.formsubmit( null, 'Cancel' ) || htf.formclose );
  htp.tablerowclose;
 htp.tableclose;

 htp.nl;
 htp.p( '</CENTER>' );
 htp.htmlclose;
exception when others then
 error_details( 'STRANGP', 'DELIVERY_MAINTAIN',null,null,errmsg=>sqlerrm,extdet=>'Strt:' || strt);
end delivery_maintain;

procedure delivery_maintain_mass(surl in varchar2, p1 in varchar2, p2 in varchar2, rid in varchar2, vrecctr in varchar2, pk1 in owa.vc_arr, pk2 in owa.vc_arr, pk3 in owa.vc_arr,
                              v1 in owa.vc_arr, v2 in owa.vc_arr, v3 in owa.vc_arr, v4 in owa.vc_arr, v5 in owa.vc_arr, v6 in owa.vc_arr, v7 in owa.vc_arr, v8 in owa.vc_arr, errmsg in owa.vc_arr, msg in varchar2 default null )
as

 cursor c2(del_from integer, del_to integer) is
  select /*+ ALL_ROWS */ distinct dr.entry_no, p.deliveryno, p.recno, p.po, p.supinv, p.tamount, p.qty, p.unit_unitused, t.cola tunit, i.code,  i.description, i.cola cola
  from strang.lov i, strang.pos p, strang.detailrs dr, strang.lov t
  where dr.deliveryno >= del_from and
        dr.deliveryno <= del_to and
        dr.deliveryno = p.deliveryno and
        p.inventoryno = i.code and
        i.lov_name = 'INVENT' and
        t.lov_name = 'TARIFF' and
        t.code = i.cola
 union all
  select /*+ ALL_ROWS */ distinct dr.entry_no, p.deliveryno, p.recno, p.po, p.supinv, p.tamount, p.qty, p.unit_unitused, null tunit, i.code,  i.description, i.cola cola
  from strang.lov i, strang.pos p, strang.detailrs dr
  where dr.deliveryno >= del_from and
        dr.deliveryno <= del_to and
        dr.deliveryno = p.deliveryno and
        p.inventoryno = i.code and
        i.lov_name = 'INVENT' and
        (i.cola is null or i.cola not in (select t.code from strang.lov t where t.lov_name = 'TARIFF'))
 union all
  select /*+ ALL_ROWS */ distinct dr.entry_no, p.deliveryno, p.recno, p.po, p.supinv, p.tamount, p.qty, p.unit_unitused, null tunit, p.inventoryno code, null description, null cola
  from strang.pos p, strang.detailrs dr
  where dr.deliveryno >= del_from and
        dr.deliveryno <= del_to and
        dr.deliveryno = p.deliveryno and
        (p.inventoryno is null or p.inventoryno not in (select i.code from strang.lov i where i.lov_name = 'INVENT'))
order by 2,3;






 foundrec	boolean;
 sts		varchar2(100);
 vaccess	varchar2(20);
 vste		varchar2(10);

 seclevel	varchar2(100);
 del_from	integer;
 del_to		integer;
 function vldd( p_k1 in varchar2, p_k2 in varchar2, p_k3 in varchar2, fld in varchar2, defval in varchar2 )
  return varchar2
 as
 begin
  for j in pk2.first..pk2.last loop
   if pk2(j) = p_k2 and pk3(j) = p_k3
    then
     if fld = 'ERRMSG'
      then
       return( errmsg(j) );
     elsif fld = 'V1'
      then
       return( v1(j) );
     elsif fld = 'V2'
      then
       return( v2(j) );
     elsif fld = 'V3'
      then
       return( v3(j) );
     elsif fld = 'V4'
      then
       return( v4(j) );
     elsif fld = 'V5'
      then
       return( v5(j) );
     elsif fld = 'V6'
      then
       return( v6(j) );
     elsif fld = 'V7'
      then
       return( v7(j) );
     elsif fld = 'V8'
      then
       return( v8(j) );
     end if;
   end if;
  end loop;
  return( defval );
 end vldd;

begin
 if not dapi.init( surl, 'STRANGP.DELIVERY_MAINTAIN_MASS', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'DELIVERY_MAINTAIN_MASS');
    return;
 end if;

 begin del_from := to_number(p1); exception when others then delivery_maintain( surl, p1, p2, rid, vrecctr, 'Delivery From Number is not a Valid Number' ); return; end;
 begin del_to := to_number(p2); exception when others then delivery_maintain( surl, p1, p2, rid, vrecctr, 'Delivery To Number is not a Valid Number' ); return; end;
 if del_from <= 0 or del_from > del_to then delivery_maintain( surl, p1, p2, rid, vrecctr, 'Delivery Number Range is Invalid' ); return; end if;

 vste := customer_state(dapi.GLOBAL_ACCOUNT.acctid);
 vaccess := data_access( 'DELIVERY_MAINTAIN' );
 seclevel := security_role( dapi.GLOBAL_ACCOUNT.acctid );

 main_title( 'Delivery Maintain Mass Edit',helpid=>'STR26');

 header_msg( nvl(msg,'Delivery Maintain Mass Edit') );

 htp.p( '<CENTER>' );
 if vaccess = 'NONE' then htp.bold( 'Access Denied' ); htp.htmlclose; return; end if;
 htp.bold( 'Deliveries From' || ':' || to_char(del_from) || '&nbsp;&nbsp;&nbsp;' || 'To' || ':' || to_char(del_to));
 htp.nl;

 htp.formopen( 'strangp.accept_delivery_maintain_mass' );
 htp.formhidden( 'SURL', surl );
 htp.formhidden( 'RID', rid );
 htp.formhidden( 'VRECCTR', vrecctr );
 htp.formhidden( 'P1', p1 );
 htp.formhidden( 'P2', p2 );
 htp.nl;
 htp.tableopen( cattributes=>'class="str1_table"' );
  htp.tablerowopen;
    htp.tableheader( 'Entry No');
    htp.tableheader( 'Delivery No');
    htp.tableheader( 'PO Record No.');
    htp.tableheader( 'Purchase Order');
    htp.tableheader( 'Supplier Invoice');
    htp.tableheader( 'Amount Orig Curr');
    htp.tableheader( 'Quantity');
    htp.tableheader( 'Corrected Unit');
    htp.tableheader( 'Old Unit');
    htp.tableheader( 'Inventory Number');
    htp.tableheader( 'Description');
    htp.tableheader( 'Tariff');
    htp.tableheader( 'Data Entry Validation Message');
  htp.tablerowclose;
  foundrec := FALSE;
  for c2rec in c2(del_from, del_to) loop
   foundrec := TRUE;
   htp.tablerowopen;
    htp.tabledata( htf.formhidden( 'PK1', c2rec.entry_no ) || htf.bold(c2rec.entry_no),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formhidden( 'PK2', c2rec.deliveryno ) || htf.bold(c2rec.deliveryno),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formhidden( 'PK3', c2rec.recno ) || htf.bold(c2rec.recno),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formtext( 'V1',8,15,vldd(c2rec.entry_no,c2rec.deliveryno,c2rec.recno,'V1',c2rec.po)),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formtext( 'V2',8,15,vldd(c2rec.entry_no,c2rec.deliveryno,c2rec.recno,'V2',c2rec.supinv)),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formtext( 'V3',10,20,vldd(c2rec.entry_no,c2rec.deliveryno,c2rec.recno,'V3',trim(to_char(c2rec.tamount,G_MONEY_FORMAT)))),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formtext( 'V4',5,10,vldd(c2rec.entry_no,c2rec.deliveryno,c2rec.recno,'V4',c2rec.qty)),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formtext( 'V7',20,1000,nvl(vldd(c2rec.entry_no,c2rec.deliveryno,c2rec.recno,'V7',c2rec.description),c2rec.description)),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formtext( 'V5',5,8,vldd(c2rec.entry_no,c2rec.deliveryno,c2rec.recno,'V5',c2rec.tunit)),cattributes=>'class="str1_bg_left"');
    htp.tabledata( nvl(c2rec.unit_unitused,'&nbsp;'),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formtext( 'V6',10,100,vldd(c2rec.entry_no,c2rec.deliveryno,c2rec.recno,'V6',c2rec.code)),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formtext( 'V8',11,20,nvl(vldd(c2rec.entry_no,c2rec.deliveryno,c2rec.recno,'V8',c2rec.cola),c2rec.cola)),cattributes=>'class="str1_bg_left"');
    htp.tabledata( nvl(vldd(c2rec.entry_no,c2rec.deliveryno,c2rec.recno,'ERRMSG','&nbsp;'),'Success'),cattributes=>'class="str1_bg_left"');
   htp.tablerowclose;
  end loop;
 htp.tableclose;
 htp.nl;
 if not foundrec then htp.init; delivery_maintain( surl, p1, p2, rid, vrecctr, 'No Deliveries found that Satisfy this Query' ); return; end if;
 htp.tableopen( cattributes=>'cellpadding=2 cellspacing=2 border=0' );
  htp.tablerowopen;
   htp.tabledata( htf.formsubmit( null, 'Modify Data' ) || htf.formclose );
   htp.tabledata( htf.formopen( 'strangp.receive', ctarget=>'_top' ) || htf.formhidden( 'SURL', surl ) || htf.formhidden( 'RID', replace(rid,'~','+') ) ||
                  htf.formhidden( 'SCID', NULL ) || htf.formhidden( 'VRECCTR', vrecctr ) || htf.formhidden( 'CALL_NAME', null ) || htf.formhidden( 'PARM', 'DETAILRS' ) || htf.formhidden( 'ACCESS_ID', 'x' ) || htf.formsubmit( null, 'Cancel' ) || htf.formclose );
  htp.tablerowclose;
 htp.tableclose;
 htp.nl;
 htp.p( '</CENTER>' );
 htp.htmlclose;
exception when others then
 error_details( 'STRANGP', 'DELIVERY_MAINTAIN_MASS',null,null,errmsg=>sqlerrm,extdet=>'P1:' || p1 || '-' || 'P2:' || p2);
end delivery_maintain_mass;

procedure accept_delivery_maintain_mass(surl in varchar2, p1 in varchar2, p2 in varchar2, rid in varchar2, vrecctr in varchar2, pk1 in owa.vc_arr, pk2 in owa.vc_arr, pk3 in owa.vc_arr,
                              v1 in owa.vc_arr, v2 in owa.vc_arr, v3 in owa.vc_arr, v4 in owa.vc_arr, v5 in owa.vc_arr, v6 in owa.vc_arr, v7 in owa.vc_arr, v8 in owa.vc_arr )
as

 cursor c3(lname varchar2, lcode varchar2) is select * from strang.lov where lov_name = lname and code = lcode;


 c3rec		c3%ROWTYPE;



 sts		varchar2(100);
 vaccess	varchar2(20);
 vste		varchar2(10);
 errmsg		owa.vc_arr;
 errfound	boolean;
 dupl_values	boolean;
 errunit	char(1);
 msg		varchar2(1000);
 nmb1		STRANG.POS.TAMOUNT%TYPE;
 nmb2		STRANG.POS.QTY%TYPE;
 oinv		STRANG.POS.INVENTORYNO%TYPE;
 dupctr_a	integer;
 dupctr_b	integer;
 tmp		number;
 tmp2		number;

begin
 if not dapi.init( surl, 'STRANGP.ACCEPT_DELIVERY_MAINTAIN_MASS', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'ACCEPT_DELIVERY_MAINTAIN_MASS');
    return;
 end if;

 vste := customer_state(dapi.GLOBAL_ACCOUNT.acctid);
 vaccess := data_access( 'DELIVERY_MAINTAIN' );
 if vaccess = 'NONE' then htp.bold( 'Access Denied' ); htp.htmlclose; return; end if;

 errfound := FALSE;

 for j in pk2.first..pk2.last loop
  errmsg(j) := NULL;
  if pk1(j) is not null
   then
    -- Validate Numbers Entered
    begin
      nmb1 := to_number( replace(replace(v3(j),',',''),'$','') );
    exception when others then
     begin
       nmb1 := to_number( v3(j), G_MONEY_FORMAT );
      exception when others then
       errfound := TRUE;
       errmsg(j) := errmsg(j) || ' ' || 'Invalid Total Amount Entered.';
       nmb1 := NULL;
     end;
    end;
    begin
      nmb2 := to_number( v4(j) );
      if nmb2 < 0
       then
        errfound := TRUE;
        errmsg(j) := errmsg(j) || ' ' || 'Quantity cannot be less than 0.';
        nmb2 := NULL;
      end if;
      exception when others then
       errfound := TRUE;
       errmsg(j) := errmsg(j) || ' ' || 'Invalid Quantity Entered.';
       nmb2 := NULL;
    end;

    oinv := trim( v6(j) );

    if v1(j) is null
     then
       errfound := TRUE;
       errmsg(j) := errmsg(j) || ' ' || 'Purchase Order cannot be blank.';
    end if;

    if v2(j) is null
     then
       errfound := TRUE;
       errmsg(j) := errmsg(j) || ' ' || 'Supplier Invoice cannot be blank.';
    end if;

    -- Check Unit
    c3rec.code := NULL;
    errunit := 'F';
    if v5(j) is not null
     then
      open c3( 'UNITS', upper(v5(j)));
      fetch c3 into c3rec;
      if c3%NOTFOUND
       then
        close c3;
        errfound := TRUE;
        errmsg(j) := errmsg(j) || ' ' || 'Incorrect Current Unit.';
        errunit := 'T';
       else
        close c3;
      end if;
    end if;

    -- 'Update Purchase Order'
    update strang.pos
     set
      po = nvl(v1(j),po),
      supinv = nvl(v2(j),supinv),
      tamount = nvl(nmb1,tamount),
      qty = nvl(nmb2,qty),
      unit_unitused = decode(errunit,'F',upper(v5(j)),'T',unit_unitused),
      inventoryno = nvl(oinv,inventoryno)
    where
     deliveryno = pk2(j) and
     recno = pk3(j);

    -- 'Update Purchase Order' Quantities for new Form 15  19-Apr-07 %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

    if v5(j) = 'KG' or v5(j) = 'TONNE'
    then

     if v5(j) = 'KG'
       then
        tmp2 := null;
        select sum(nvl(partweight,0)) into tmp2 from strang.detailrs where deliveryno=pk2(j);
        select count('x') into tmp from strang.pos where deliveryno = pk2(j);
        tmp2 := round(tmp2/tmp,0);
        if tmp2 < 1
         then
          tmp2 := 1;
        end if;
     elsif v5(j) = 'TONNE'
      then
        tmp2 := null;
        select sum(nvl(partweight,0)) into tmp2 from strang.detailrs where deliveryno=pk2(j);
        select count('x') into tmp from strang.pos where deliveryno = pk2(j);
        tmp2 := round((tmp2/tmp)/1000,3);
        if tmp2 < 0.001
         then
         tmp2 := 0.001;
        end if;

     end if;
     update strang.pos
      set
      qty = tmp2
     where
      deliveryno = pk2(j) and
      recno = pk3(j);
    end if;


    -- Check if Inventory Exists
    if oinv is not null
     then

      -- Check if multiple inventory numbers have been entered, and if
      dupl_values := FALSE;
      dupctr_a := 0;
      dupctr_b := 0;
      for k in pk1.first..pk1.last loop
       if oinv is not null and trim(v6(k)) is not null and oinv = trim(v6(k))
        then
         -- Check if the Description is different and not null
         if trim(v7(j)) is not null and trim(v7(k)) is not null and trim(v7(j)) <> trim(v7(k))
          then
           dupctr_a := dupctr_a + 1;
         end if;
         -- Check if the Tariff number is different and not null
         if trim(v8(j)) is not null and trim(v8(k)) is not null and trim(v8(j)) <> trim(v8(k))
          then
           dupctr_b := dupctr_b + 1;
         end if;
       end if;
      end loop;

      if dupctr_a > 0
       then
        errmsg(j) := errmsg(j) || ' ' || 'Different descriptions exist for the same Inventory Number.';
        dupl_values := TRUE;
      end if;

      if dupctr_b > 0
       then
        errmsg(j) := errmsg(j) || ' ' || 'Different Tariff Numbers exist for the same Inventory Number.';
        dupl_values := TRUE;
      end if;

      if dupl_values
       then
        --
        errfound := TRUE;

       else
        open c3('INVENT',v6(j));
        fetch c3 into c3rec;
        if c3%FOUND
         then
          close c3;
          update strang.lov
           set
            description = nvl(v7(j),description)
          where
           lov_name = 'INVENT' and
           code = oinv;
         else
          close c3;
          insert into strang.lov(lov_name,code,description,cola) values ('INVENT',v6(j),v7(j),v8(j));
        end if;
      end if;

      -- Check if Tariff Exists
      if v8(j) is null
       then
        null;
       else
        open c3('TARIFF',v8(j));
        fetch c3 into c3rec;
        if c3%FOUND
         then
          close c3;
          update strang.lov
           set
            cola = v8(j)
          where
           lov_name = 'INVENT' and
           code = oinv;
         else
          close c3;
          errfound := TRUE;
          errmsg(j) := errmsg(j) || ' ' || 'Tariff value not found - ' || htf.anchor2( 'strangp.accept_lov?surl=' || surl || '&parm=TARIFF&SRC=&LRANGE=&P0=&P1=&P2=&P3=&P4=&P5=&ACTION=' || replace('Insert New Values',' ','+'),'Insert New Tariff.', ctarget=>'INSWIND');
        end if;
      end if;
    end if;

  end if;
 end loop;
 commit;
 if errfound then msg := 'Errors found Modifying Data. Please Review each Entry Record to see what the Error was.'; end if;

 delivery_maintain_mass(surl, p1, p2, rid,vrecctr, pk1, pk2, pk3, v1, v2, v3, v4, v5, v6, v7, v8, errmsg, msg );

exception when others then
 error_details( 'STRANGP', 'ACCEPT_DELIVERY_MAINTAIN_MASS',null,null,errmsg=>sqlerrm,extdet=>'P1:' || p1 || '-' || 'P2:' || p2);
end accept_delivery_maintain_mass;

--vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
procedure confirm_genduty(surl in varchar2, rid in varchar2, scid in varchar2, parm in varchar2, access_id in varchar2 default null, msg in varchar2 default null )
as

 cursor c2(rid rowid) is select * from strang.ships_airway where rowid = rid;

 cursor c3(vship_id integer)
 is
 select distinct r.curr
 from strang.receivals r, strang.detailrs dr, strang.movements m, strang.ships_airway s, strang.customers c
 where
   m.ship_id = vship_id and
   s.ship_id = m.ship_id and
   r.deliveryno = dr.deliveryno and
   r.cust_customer_id = c.customer_id and
   c.customs_agent is not null and
   dr.movement_no = m.movement_no and
   nvl(dr.camov_seal,'|') = nvl(seal,'|') and
   not exists(select 'x' from strang.lov l
              where l.lov_name = 'UNRATTAB' and
                    l.code = r.curr and
                    nvl(to_date(gl.guess_date(l.cola),'DD-MON-YYYY'),s.estarrive) <= s.estarrive and
		    nvl(to_date(gl.guess_date(l.colb),'DD-MON-YYYY'),s.estarrive) >= s.estarrive);


 c2rec		c2%ROWTYPE;
 c3rec		c3%ROWTYPE;

 sts		varchar2(100);
 vaccess	varchar2(20);
 vste		varchar2(10);
 currneeded     boolean;

begin
 if not dapi.init( surl, 'STRANGP.CONFIRM_GENDUTY', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'CONFIRM_GENDUTY');
    return;
 end if;

 vste := customer_state(dapi.GLOBAL_ACCOUNT.acctid);
 vaccess := data_access( 'SHP2' );

 main_title( 'Confirm',helpid=>'STR27');

 htp.p( '<CENTER>' );
 htp.nl;
 currneeded := false;
 open c2(replace(rid,'~','+'));
  fetch c2 into c2rec;
  if c2%NOTFOUND
  then
    currneeded :=true;
    htp.p('Ship Id '|| replace(rid,'~','+'));
    htp.nl;
  end if;
 close c2;
 htp.formopen( 'strangp.genduty' );
 htp.formhidden( 'SURL', surl );
 htp.formhidden( 'RID', replace(rid,'~','+') );
 htp.formhidden( 'SCID', scid );
 htp.formhidden( 'PARM', parm );
 htp.formhidden( 'ACCESS_ID', access_id );
 htp.formhidden( 'MSG', msg );
 htp.formsubmit( 'ACTION', 'Return to Previous Screen' );
 if msg = 'DUTY'
  then
    for c3rec in c3(c2rec.ship_id) loop
     htp.p('Currency Code Needed For ' || c3rec.curr );
     htp.nl;
     currneeded := true;
    end loop;
   if not currneeded then
     htp.formsubmit( 'ACTION', 'Confirm Allocation' );
   end if;
  else
   htp.formsubmit( 'ACTION', 'Confirm Unallocation' );
 end if;
 htp.formclose;
 htp.p( '</CENTER>' );
 htp.htmlclose;

exception when others then
 error_details( 'STRANGP', 'CONFIRM_GENDUTY',null,null,errmsg=>sqlerrm,extdet=>'PARM:' || parm);
end confirm_genduty;

procedure genduty(surl in varchar2, rid in varchar2, scid in varchar2, parm in varchar2, access_id in varchar2 default null, msg in varchar2 default null, action in varchar2 default null )
as

 cursor c2(rid rowid) is select * from strang.ships_airway where rowid = rid;

 c2rec		c2%ROWTYPE;

 sts		varchar2(100);
 vaccess	varchar2(20);
 vste		varchar2(10);

begin
 if not dapi.init( surl, 'STRANGP.GENDUTY', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'GENDUTY');
    return;
 end if;

 if action = 'Return to Previous Screen'
  then
--    shp2( surl, rid, scid, parm, access_id, 'Action not performed' );
    shp( surl, rid, scid, parm, access_id, 'Action not performed' );
    return;
 end if;

 vste := customer_state(dapi.GLOBAL_ACCOUNT.acctid);
 vaccess := data_access( 'SHP2' );

 if vaccess in ('NONE','READ') then htp.bold( 'Access Denied' ); htp.htmlclose; return; end if;
 if access_id <> 'z'
  then
   open c2(replace(rid,'~','+'));
   fetch c2 into c2rec;
   close c2;
   if c2rec.ship_airway = 'A'
    then
     generate_ships_manifest( c2rec.ship_id, nvl(msg,'LINE_NO'), 'AIRWAY', vste=>vste );
    else
     generate_ships_manifest( c2rec.ship_id, nvl(msg,'LINE_NO'), 'SHIP', vste=>vste );
   end if;

   if msg = 'LINE_NO'
    then
     shp( surl, rid, scid, parm, access_id, 'Line Nos Generated' );
    else
     if msg = 'DUTY'
      then
       shp( surl, rid, scid, parm, access_id, 'Duty Details Generated' );
      else
       shp( surl, rid, scid, parm, access_id, 'Details Unallocated' );
     end if;
   end if;
 end if;
exception when others then
 error_details( 'STRANGP', 'GENDUTY',null,null,errmsg=>sqlerrm,extdet=>'PARM:' || parm);
end genduty;

procedure inv(surl in varchar2, rid in varchar2, scid in varchar2, call_name in varchar2, parm in varchar2, access_id in varchar2 default null, msg in varchar2 default null )
as

 cursor c2( rid rowid ) is select * from strang.invoices where rowid = rid;
 cursor c6( rid rowid ) is select rowid from strang.invoices where invoiceno = (select inv_invoiceno from strang.invcharges where rowid = rid );
 cursor c3( invno varchar2 ) is select rowid,inv_invoiceno,quantity,cgunit,cgdesc,cge_chargecode,cgrate,gstc_gstcode,gst from strang.invcharges where inv_invoiceno = invno order by cge_chargecode;
 cursor c4 is select * from strang.charges order by upper(chargecode);
 cursor c5( invno varchar2 ) is select cust_customer_id from strang.receivals r, strang.movements m, strang.detailrs d where d.movement_no = m.movement_no and d.deliveryno = r.deliveryno and m.invoiceno = invno;
 cursor c7(cde varchar2) is
  select colb
  from strang.lov
  where lov_name = 'GSTCODES' and
        code = cde;
 cursor c8(cde varchar2,vste varchar2) is select description from strang.lov where lov_name = 'CONTROLS' and code = cde and cola = vste;
 cursor c9(invno varchar2 ) is select rowid,g.* from strang.general_ledger g where invoiceno = invno order by recno,transaction_type,profit_centre,cost_centre,total;
 cursor c10(cday number) is select invoiceno from strang.invoices where completed = 'COMPLETE' and status = 'GL INCOMPLETE' and (sysdate - invdate) > cday and rownum < 5;


 c2rec		c2%ROWTYPE;
 c5rec		c5%ROWTYPE;
 c6rec		c6%ROWTYPE;
 c7rec		c7%ROWTYPE;
 c8rec		c8%ROWTYPE;
 sts		varchar2(100);
 mn		char(3);
 fnd		boolean;
 glcomplete	boolean;
 print_status	boolean;
 ttl1		number;
 ttl2		number;
 ttl3		number;
 check_day	integer;
 vaccess	varchar2(20);
 nrid		varchar2(100);
 seclevel	varchar2(100);
 vste		varchar2(10);
 tmpstr		varchar2(32767);
 stp		varchar2(1000);

begin
 if not dapi.init( surl, 'STRANGP.INV', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'INV');
    return;
 end if;

 stp := 'a';
 if parm = 'INVCHARGES'
  then
   open c6(replace(rid,'~','+'));
   fetch c6 into c6rec;
   close c6;
   nrid := rowidtochar( c6rec.rowid );
  else
   nrid := replace(rid,'~','+');
 end if;

 stp := 'b';
 vste := customer_state(dapi.GLOBAL_ACCOUNT.acctid);
 vaccess := data_access( 'INVOICING' );
 seclevel := security_role( dapi.GLOBAL_ACCOUNT.acctid );

 main_title( 'Invoicing',helpid=>'STR28');

 htp.p( '<CENTER>' );
  if vaccess = 'NONE' then htp.bold( 'Access Denied' ); htp.htmlclose; return; end if;
 if access_id = 'z'
  then
   c2rec.invdate := sysdate;
   c2rec.billingmonth := to_char(sysdate, 'MON' );
   c2rec.billingyear := to_char(sysdate, 'YYYY' );
   open c8('CONTRACT',vste);
   fetch c8 into c8rec;
   close c8;
   c2rec.ctrk_contract := c8rec.description;
  else
   open c2(nrid);
   fetch c2 into c2rec;
   close c2;
 end if;

  stp := 'c';
 if msg is not null
  then
   header_msg( msg );
  else
   begin check_day := nvl(to_number(control_code( 'GL ALERT', vste )),7); exception when others then check_day := 7; end;

   -- Previous check
   if c2rec.completed = 'INCOMPLETE' and (sysdate - c2rec.invdate) > 7
    then
     header_msg( 'Warning: This Invoice is Over 1 Week Old' );
   end if;

   tmpstr := null;
   for c10rec in c10( check_day ) loop
    tmpstr := tmpstr || ',' || c10rec.invoiceno;
   end loop;
   tmpstr := substr(tmpstr,2);
   if tmpstr is not null
    then
     header_msg( 'Warning: The following General Ledgers are over ' || check_day || ' days old:' || tmpstr );
   end if;
 end if;

  stp := 'd';
 -- Fields to toggle read write and read only
 if c2rec.status = 'GL COMPLETE'
  then
   glcomplete := TRUE;
  else
   glcomplete := FALSE;
 end if;
 if c2rec.completed = 'COMPLETE'
  then
   print_status := TRUE;
  else
   print_status := FALSE;
 end if;

 htp.tableopen;
 htp.tablerowopen;
 htp.p( '<td class="str2_align_center">' );
 if vaccess = 'EDIT'
  then
   htp.formopen( 'strangp.accept_inv' );
   htp.formhidden( 'SURL', surl );
   htp.formhidden( 'SCID', scid );
   htp.formhidden( 'PARM', parm );
   htp.formhidden( 'ACCESS_ID', access_id );
   if access_id = 'z'
    then
     htp.formhidden( 'RID', null );
    else
   htp.formhidden( 'RID', replace(nrid,'~','+') );
   end if;
 end if;

  stp := 'e';
 htp.tableopen( cattributes=>'class="str1_table"' );
  htp.tablerowopen;
     htp.tabledata( htf.bold('Inv Number'),cattributes=>'class="str1_bg_right"');
     if vaccess = 'EDIT'
      then
       if not(access_id = 'z')
        then
         htp.tabledata( htf.bold(c2rec.invoiceno),cattributes=>'class="str1_bg_left"');
         htp.formhidden( 'P1', c2rec.invoiceno );
        else
         htp.tabledata( htf.formtext('P1',10,10,c2rec.invoiceno),cattributes=>'class="str1_bg_left"');
       end if;
      else
       htp.tabledata( htf.bold(c2rec.invoiceno),cattributes=>'class="str1_bg_left"');
     end if;
     htp.tabledata( htf.bold('Contract'),cattributes=>'class="str1_bg_right"');
     if vaccess = 'EDIT' and not glcomplete and not print_status
      then
       htp.p( '<TD ' || 'class="str1_cell_left">' );
       lov_list( 'CONTRACTS', 'P2', c2rec.ctrk_contract, FALSE, FALSE, FALSE );
       htp.p( '</TD>' );
       -- htp.tabledata( htf.formtext('P2',10,10,c2rec.ctrk_contract),cattributes=>'class="str1_bg_left"');
      else
       htp.tabledata( htf.formhidden( 'P2', c2rec.ctrk_contract ) || htf.bold(c2rec.ctrk_contract),cattributes=>'class="str1_bg_left"');
     end if;
     htp.tabledata( htf.bold('Inv Date'),cattributes=>'class="str1_bg_right"');
     if vaccess = 'EDIT' and not glcomplete and not print_status
      then
       htp.tabledata( htf.formtext('P3',10,20,to_char(c2rec.invdate,LNG_MASK)),cattributes=>'class="str1_bg_left"');
      else
       htp.tabledata( htf.formhidden( 'P3', to_char(c2rec.invdate,LNG_MASK) ) || htf.bold(to_char(c2rec.invdate,LNG_MASK)),cattributes=>'class="str1_bg_left"');
     end if;
     htp.tabledata( htf.bold('Print Status'),cattributes=>'class="str1_bg_right"'); -- change from Status
     htp.p( '<TD ' || 'class="str1_cell_left">');
     if vaccess = 'EDIT'
      then
       htp.formselectopen( 'P4' );
       if c2rec.completed = 'COMPLETE'
        then
         htp.formselectoption( 'COMPLETE', 'SELECTED' );
         htp.formselectoption( 'INCOMPLETE' );
        else
         htp.formselectoption( 'COMPLETE' );
         htp.formselectoption( 'INCOMPLETE', 'SELECTED' );
       end if;
       htp.formselectclose;
      else
       htp.bold( c2rec.completed );
     end if;
     htp.p( '</TD>' );
     htp.tabledata( htf.bold('Branch/Profit Centre'),cattributes=>'class="str1_bg_right"');
     if vaccess = 'EDIT' and not glcomplete and not print_status
      then
       htp.p( '<TD ' || 'class="str1_cell_left">' );
        lov_list( 'JOB_BRANCH', 'P9', nvl(c2rec.job_branch, control_code( 'JOB BRANCH', vste )), TRUE, FALSE, FALSE );
       htp.p( '</TD>' );
      else
       htp.tabledata( htf.formhidden( 'P9', c2rec.job_branch ) || htf.bold(c2rec.job_branch),cattributes=>'class="str1_bg_left"');
     end if;
   htp.tablerowclose;
   htp.tablerowopen;
     htp.tabledata( htf.bold('Billing Month'),cattributes=>'class="str1_bg_right"');
     htp.p( '<TD ' || 'class="str1_cell_left">');
     if vaccess = 'EDIT'
      then
       htp.formselectopen( 'P5' );
       for j in 1..12 loop
        mn := to_char( to_date( '01-' || lpad( to_char(j),2,'0') || '-2000','DD-MM-YYYY'),'MON');
        if mn = c2rec.billingmonth
         then
          htp.formselectoption( mn, 'SELECTED' );
         else
          htp.formselectoption( mn );
        end if;
       end loop;
       htp.formselectclose;
      else
       htp.bold( c2rec.billingmonth );
     end if;
     htp.p( '</TD>' );
     htp.tabledata( htf.bold('Billing Year'),cattributes=>'class="str1_bg_right"');
     htp.p( '<TD ' || 'class="str1_cell_left">');
     if vaccess = 'EDIT'
      then
       htp.formselectopen( 'P6' );
       for j in 1998..2020 loop
         if to_char(j) = c2rec.billingyear
         then
          htp.formselectoption( to_char(j), 'SELECTED' );
         else
          htp.formselectoption( to_char(j) );
        end if;
       end loop;
       htp.formselectclose;
      else
       htp.bold( c2rec.billingyear );
     end if;
     htp.p( '</TD>' );
     if vaccess = 'EDIT' and not glcomplete and not print_status
      then
       htp.p( '<TD ' || 'class="str1_cell_left" COLSPAN=2>' );
        htp.bold('Debtor Branch' || ' ');
        lov_list( 'DEBTOR_BRANCH', 'P10', nvl(c2rec.debtor_branch, control_code( 'DEBTOR BRANCH', vste )), TRUE, FALSE, FALSE );
       htp.p( '</TD>' );
      else
       htp.tabledata( htf.formhidden( 'P10', c2rec.debtor_branch ) || htf.bold('Debtor Branch') || ' ' || htf.bold(c2rec.debtor_branch),cattributes=>'class="str1_cell_left" COLSPAN=2');
     end if;
     if vaccess = 'EDIT' and not glcomplete and not print_status
      then
       htp.p( '<TD ' || 'class="str1_cell_left" COLSPAN=2>' );
        htp.bold('Debtor Code' || ' ');
        lov_list( 'DEBTOR_CODE', 'P11', nvl(c2rec.debtor_code, control_code( 'DEBTOR CODE', vste )), TRUE, FALSE, FALSE );
       htp.p( '</TD>' );
      else
       htp.tabledata( htf.formhidden( 'P11', c2rec.debtor_code ) || htf.bold('Debtor Code') || ' ' || htf.bold(c2rec.debtor_code),cattributes=>'class="str1_cell_left" COLSPAN=2');
     end if;
     htp.tabledata( htf.bold('Job Code'),cattributes=>'class="str1_bg_right"');
     if vaccess = 'EDIT' and not glcomplete and not print_status
      then
       htp.p( '<TD ' || 'class="str1_cell_left">' );
        htp.formtext('P12',10,10,nvl(c2rec.job_code, c2rec.invoiceno));
       htp.p( '</TD>' );
      else
       htp.tabledata( htf.formhidden( 'P12', c2rec.job_code ) || htf.bold(c2rec.job_code),cattributes=>'class="str1_bg_left"');
     end if;
     htp.formhidden( 'P7', '0' );
     /*
     htp.tabledata( htf.bold('Owner'),cattributes=>'class="str1_bg_right"');
     if vaccess = 'EDIT'
      then
       htp.tabledata( htf.formtext( 'P7', 3, 1, c2rec.owner ),cattributes=>'class="str1_bg_left"');
      else
       htp.tabledata( htf.bold( c2rec.owner ),cattributes=>'class="str1_bg_left"');
     end if;
     */
  htp.tablerowclose;
  htp.tablerowopen;
     htp.tabledata( htf.bold('Description'),cattributes=>'class="str1_bg_right"');
     if vaccess = 'EDIT'
      then
       htp.tabledata( htf.formtextareaopen( 'P8', 5, 75 ) || c2rec.invdesc || htf.formtextareaclose,cattributes=>'class="str1_cell_left" COLSPAN=9');
      else
       htp.tabledata( c2rec.invdesc,cattributes=>'class="str1_cell_left" COLSPAN=9');
     end if;
  htp.tablerowclose;
 htp.tableclose;
 htp.nl;
  stp := 'f';
 htp.tableopen;
  htp.tablerowopen;
     htp.tabledata( htf.bold('Charge Code'),cattributes=>'class="str1_bg_center"');
     htp.tabledata( htf.bold('Description'),cattributes=>'class="str1_bg_center"');
     htp.tabledata( htf.bold('Rate'),cattributes=>'class="str1_bg_center"');
     htp.tabledata( htf.bold('Unit'),cattributes=>'class="str1_bg_center"');
     htp.tabledata( htf.bold('Quantity'),cattributes=>'class="str1_bg_center"');
     htp.tabledata( htf.bold('Sub Total'),cattributes=>'class="str1_bg_center"');
     htp.tabledata( htf.bold('GST'),cattributes=>'class="str1_bg_center"');
     htp.tabledata( htf.bold('Sub GST'),cattributes=>'class="str1_bg_center"');
     htp.tabledata( htf.bold('Total Amount'),cattributes=>'class="str1_bg_center"');
     htp.tabledata( htf.bold('Delete'),cattributes=>'class="str1_bg_center"');
  htp.tablerowclose;
  ttl1 := 0;
  ttl2 := 0;
  ttl3 := 0;
  if vaccess = 'EDIT'
   then
    htp.formhidden( 'R7', null );
    if c2rec.completed = 'COMPLETE' or glcomplete
     then
       htp.formhidden( 'R0', null );
       htp.formhidden( 'R1', null );
       htp.formhidden( 'R2', null );
       htp.formhidden( 'R3', null );
       htp.formhidden( 'R4', null );
       htp.formhidden( 'R5', null );
       htp.formhidden( 'R6', null );
       htp.formhidden( 'R7', null );
    end if;
  end if;

    stp := 'g';
  for c3rec in c3( c2rec.invoiceno ) loop
  htp.tablerowopen;
   if c2rec.completed = 'COMPLETE' or vaccess <> 'EDIT' or glcomplete
    then
     htp.tabledata( c3rec.cge_chargecode,cattributes=>'class="str1_bg_left"');
    else
     htp.formhidden( 'R0', c3rec.cge_chargecode );
     htp.tabledata( htf.formtext( 'R1', 10, 10, c3rec.cge_chargecode ),cattributes=>'class="str1_bg_left"');
   end if;
   if c2rec.completed = 'COMPLETE' or vaccess <> 'EDIT' or glcomplete
    then
     htp.tabledata( c3rec.cgdesc,cattributes=>'class="str1_bg_left"');
    else
     htp.tabledata( htf.formtext( 'R2', 30, 30, c3rec.cgdesc ),cattributes=>'class="str1_bg_left"');
   end if;
   if c2rec.completed = 'COMPLETE' or vaccess <> 'EDIT' or glcomplete
    then
     htp.tabledata( ltrim(to_char(c3rec.cgrate,'99999999.9999')),cattributes=>'class="str1_bg_left"');
    else
     htp.tabledata( htf.formtext( 'R3', 9, 20, ltrim(to_char(c3rec.cgrate,'99999999.9999')), cattributes=>'align="RIGHT"' ),cattributes=>'class="str1_bg_left"');
   end if;
   if c2rec.completed = 'COMPLETE' or vaccess <> 'EDIT' or glcomplete
    then
     htp.tabledata( c3rec.cgunit,cattributes=>'class="str1_bg_left"');
    else
     htp.p( '<TD ' || 'class="str1_cell_left">' );
     lov_list( 'UNITS', 'R4', c3rec.cgunit, FALSE, FALSE, FALSE );
     htp.p( '</TD>' );
   end if;
   if c2rec.completed = 'COMPLETE' or vaccess <> 'EDIT' or glcomplete
    then
     htp.tabledata( ltrim(to_char(c3rec.quantity,'99999999.999')),cattributes=>'class="str1_bg_left"');
    else
     htp.tabledata( htf.formtext( 'R5', 8, 20, ltrim(to_char(c3rec.quantity,'99999999.999')), cattributes=>'align="RIGHT"' ),cattributes=>'class="str1_bg_left"');
   end if;
   htp.tabledata( to_char(round(c3rec.cgrate*c3rec.quantity,2),G_MONEY_FORMAT),cattributes=>'class="str1_cell_right"');
   ttl1 := ttl1 + round(nvl(c3rec.cgrate*c3rec.quantity,0),2);
   if c2rec.completed = 'COMPLETE' or vaccess <> 'EDIT' or glcomplete
    then
     htp.tabledata( c3rec.gstc_gstcode,cattributes=>'class="str1_bg_left"');
    else
     htp.p( '<TD ' || 'class="str1_cell_left">' );
     lov_list( 'GSTCODES', 'R6', c3rec.gstc_gstcode, FALSE, FALSE, FALSE );
     htp.p( '</TD>' );
   end if;
   htp.tabledata( to_char(round(c3rec.gst,2),G_MONEY_FORMAT),cattributes=>'class="str1_cell_right"');
   ttl2 := ttl2 + round(nvl(c3rec.gst,0),2);
   open c7(c3rec.gstc_gstcode);
   fetch c7 into c7rec;
   close c7;
   if c7rec.colb = 'Add GST'
    then
     htp.tabledata( to_char(round(c3rec.cgrate*c3rec.quantity+c3rec.gst,2),G_MONEY_FORMAT),cattributes=>'class="str1_cell_right"');
     ttl3 := ttl3 + round(nvl(c3rec.cgrate*c3rec.quantity+c3rec.gst,0),2);
    else
     htp.tabledata( to_char(round(c3rec.cgrate*c3rec.quantity,2),G_MONEY_FORMAT),cattributes=>'class="str1_cell_right"');
     ttl3 := ttl3 + round(nvl(c3rec.cgrate*c3rec.quantity,0),2);
   end if;
   if c2rec.completed = 'COMPLETE' or vaccess <> 'EDIT' or glcomplete
    then
     htp.tabledata( '&nbsp;',cattributes=>'class="str1_bg_left"');
    else
     htp.tabledata( htf.formcheckbox( 'R7', c3rec.rowid ),cattributes=>'class="str1_cell_center"');
   end if;
  htp.tablerowclose;
  end loop;

   stp := 'h';
if c2rec.completed = 'COMPLETE' or vaccess <> 'EDIT' or glcomplete
   then
    null;
   else
    for j in 1..3 loop
    htp.tablerowopen;
     htp.formhidden( 'R0', null );
     htp.formhidden( 'R2', null );
     htp.formhidden( 'R3', null );
     htp.formhidden( 'R4', null );
     htp.formhidden( 'R6', null );
     htp.p( '<TD ' || 'class="str1_cell_left">');
     htp.formselectopen( 'R1' );
     htp.formselectoption( NULL );
     for c4rec in c4 loop
      htp.formselectoption( c4rec.chargecode );
     end loop;
     htp.formselectclose;
     htp.p( '</TD>' );
     htp.tabledata( '&nbsp;',cattributes=>'class="str1_bg_left"');
     htp.tabledata( '&nbsp;',cattributes=>'class="str1_bg_left"');
     htp.tabledata( '&nbsp;',cattributes=>'class="str1_bg_left"');
     htp.tabledata( htf.formtext( 'R5', 8, 20, null, cattributes=>'align="RIGHT"' ),cattributes=>'class="str1_bg_left"');
     htp.tabledata( '&nbsp;',cattributes=>'class="str1_bg_left"');
     htp.tabledata( '&nbsp;',cattributes=>'class="str1_bg_left"');
     htp.tabledata( '&nbsp;',cattributes=>'class="str1_bg_left"');
     htp.tabledata( '&nbsp;',cattributes=>'class="str1_bg_left"');
     htp.tabledata( '&nbsp;',cattributes=>'class="str1_bg_left"');
    htp.tablerowclose;
    end loop;
  end if;
  htp.tablerowopen;
     htp.tabledata( '&nbsp;',cattributes=>'class="str1_bg_center"');
     htp.tabledata( '&nbsp;',cattributes=>'class="str1_bg_center"');
     htp.tabledata( '&nbsp;',cattributes=>'class="str1_bg_center"');
     htp.tabledata( '&nbsp;',cattributes=>'class="str1_bg_center"');
     htp.tabledata( htf.bold('Total'),cattributes=>'class="str1_bg_center"');
     htp.tabledata( htf.bold(to_char(round(ttl1,2),G_MONEY_FORMAT)),cattributes=>'class="str1_bg_right"');
     htp.tabledata( '&nbsp;',cattributes=>'class="str1_bg_right"');
     htp.tabledata( htf.bold(to_char(round(ttl2,2),G_MONEY_FORMAT)),cattributes=>'class="str1_bg_right"');
     htp.tabledata( htf.bold(to_char(round(ttl3,2),G_MONEY_FORMAT)),cattributes=>'class="str1_bg_right"');
     htp.tabledata( '&nbsp;',cattributes=>'class="str1_bg_left"');
  htp.tablerowclose;
 htp.tableclose;

   stp := 'i';
if vaccess <> 'EDIT' or glcomplete
  then
   null;
  else
   htp.formsubmit( 'ACTION', 'Populate GL' );
 end if;

 htp.nl;
 htp.tableopen;
  htp.tablerowopen;
     htp.tabledata( htf.bold('General Ledger'),cattributes=>'class="str1_bg_left"');
     -- add status here
     if (vaccess <> 'EDIT') or (c2rec.status = 'GL COMPLETE' and c2rec.transfer_date is not null)
      then
       htp.tabledata( htf.formhidden( 'PSTS', c2rec.status ) ||
                      htf.bold(c2rec.status),cattributes=>'class="str1_cell_left" COLSPAN="2"');
      else
       htp.p( '<TD ' || 'class="str1_cell_left" COLSPAN="2">');
        htp.formselectopen( 'PSTS' );
        if c2rec.status = 'GL COMPLETE'
         then
          htp.formselectoption( 'GL COMPLETE', 'SELECTED' );
         else
          htp.formselectoption( 'GL COMPLETE' );
        end if;
        if nvl(c2rec.status, 'GL INCOMPLETE') = 'GL INCOMPLETE'
         then
          htp.formselectoption( 'GL INCOMPLETE', 'SELECTED' );
         else
          htp.formselectoption( 'GL INCOMPLETE' );
        end if;
        htp.formselectclose;
       htp.p( '</TD>' );
     end if;

     if c2rec.status = 'GL COMPLETE'
      then
       if c2rec.transfer_date is null
        then
         htp.tabledata( 'Not Transferred',cattributes=>'class="str1_cell_center" COLSPAN="3"');
        else
         htp.tabledata( 'Transferred on ' || trim(to_char(c2rec.transfer_date,'DD Mon YYYY HH24:MI' )),cattributes=>'class="str1_cell_center" COLSPAN="3"');
       end if;
      else
       htp.tabledata( '&nbsp;',cattributes=>'class="str1_cell_center" COLSPAN="3"');
     end if;
  htp.tablerowclose;
     htp.tabledata( htf.bold('Cost Centre'),cattributes=>'class="str1_bg_center"');
  htp.tablerowopen;
     htp.tabledata( htf.bold('Transaction Type'),cattributes=>'class="str1_bg_center"');
     --htp.tabledata( htf.bold('Profit Centre'),cattributes=>'class="str1_bg_center"');
     htp.tabledata( htf.bold('Total (Incl. GST)'),cattributes=>'class="str1_bg_center"');
     htp.tabledata( htf.bold('GST'),cattributes=>'class="str1_bg_center"');
     htp.tabledata( htf.bold('Delete'),cattributes=>'class="str1_bg_center"');
  htp.tablerowclose;

   stp := 'j';
 if vaccess = 'EDIT'
   then
    htp.formhidden( 'G2', null ); -- moved to address issue when removing profit centres
    if c2rec.status = 'GL COMPLETE'
     then
       htp.formhidden( 'G0', null );
       htp.formhidden( 'G1', null );
       htp.formhidden( 'G3', null );
       htp.formhidden( 'G4', null );
       htp.formhidden( 'G5', null );
       htp.formhidden( 'G6', null );
    end if;
  end if;
  htp.formhidden( 'G6', null );
  fnd := FALSE;
  for c9rec in c9( c2rec.invoiceno ) loop
   fnd := TRUE;
   htp.tablerowopen;
    if c2rec.status = 'GL COMPLETE' or vaccess <> 'EDIT'
     then
      htp.tabledata( c9rec.transaction_type,cattributes=>'class="str1_cell_center"');
     else
      htp.p( '<TD ' || 'class="str1_cell_center">' );
       htp.formhidden( 'G0', c9rec.recno );
       htp.formselectopen( 'G1' );
       if c9rec.transaction_type = 'S'
        then
         htp.formselectoption( 'S', 'SELECTED' );
        else
         htp.formselectoption( 'S' );
       end if;
       if c9rec.transaction_type = 'C'
        then
         htp.formselectoption( 'C', 'SELECTED' );
        else
         htp.formselectoption( 'C' );
       end if;
       htp.formselectclose;
      htp.p( '</TD>' );
    end if;
    /*
    if c2rec.status = 'GL COMPLETE' or vaccess <> 'EDIT'
     then
      htp.tabledata( c9rec.profit_centre,cattributes=>'class="str1_bg_left"');
     else
       htp.p( '<TD ' || 'class="str1_cell_center">' );
        lov_list( 'PROFIT_CENTRE', 'G2', c9rec.profit_centre, TRUE, FALSE, FALSE );
       htp.p( '</TD>' );
    end if;
    */
    if c2rec.status = 'GL COMPLETE' or vaccess <> 'EDIT'
     then
      htp.tabledata( c9rec.cost_centre,cattributes=>'class="str1_bg_left"');
     else
       htp.p( '<TD ' || 'class="str1_cell_center">' );
        lov_list( 'COST_CENTRE', 'G3', c9rec.cost_centre, TRUE, FALSE, FALSE );
       htp.p( '</TD>' );
    end if;
   stp := 'k';
   if c2rec.status = 'GL COMPLETE' or vaccess <> 'EDIT'
     then
      htp.tabledata( to_char(round(c9rec.total,2),G_MONEY_FORMAT),cattributes=>'class="str1_bg_left"');
     else
      htp.tabledata( htf.formtext( 'G4', 12, 20, trim(to_char(round(c9rec.total,2),G_MONEY_FORMAT))),cattributes=>'class="str1_cell_center"');
    end if;
    if c2rec.status = 'GL COMPLETE' or vaccess <> 'EDIT'
     then
      htp.tabledata( to_char(round(c9rec.gst,2),G_MONEY_FORMAT),cattributes=>'class="str1_bg_left"');
     else
      htp.tabledata( htf.formtext( 'G5', 12, 20, trim(to_char(round(c9rec.gst,2),G_MONEY_FORMAT))),cattributes=>'class="str1_cell_center"');
    end if;
    if vaccess <> 'EDIT' -- was c2rec.status = 'GL COMPLETE' or : changed I think at recommendation of Sallie
     then
      htp.tabledata( '&nbsp;',cattributes=>'class="str1_bg_left"');
     else
      htp.tabledata( htf.formcheckbox( 'G6', c9rec.rowid ),cattributes=>'class="str1_cell_center"');
    end if;

   htp.tablerowclose;
  end loop;

   stp := 'l';
 if c2rec.status = 'GL COMPLETE' or vaccess <> 'EDIT'
   then
    null;
   else
    for j in 1..3 loop
    htp.tablerowopen;
     htp.formhidden( 'G0', null );
      htp.p( '<TD ' || 'class="str1_cell_center">' );
       htp.formselectopen( 'G1' );
         htp.formselectoption( null, 'SELECTED' );
         htp.formselectoption( 'S' );
         htp.formselectoption( 'C' );
       htp.formselectclose;
      htp.p( '</TD>' );
       htp.p( '<TD ' || 'class="str1_cell_center">' );
        lov_list( 'PROFIT_CENTRE', 'G2', null, FALSE, FALSE, FALSE );
       htp.p( '</TD>' );
       htp.p( '<TD ' || 'class="str1_cell_center">' );
        lov_list( 'COST_CENTRE', 'G3', null, FALSE, FALSE, FALSE );
       htp.p( '</TD>' );
       if j = 1 and not fnd
        then
         htp.tabledata( htf.formtext( 'G4', 12, 20, trim(to_char(round(ttl3,2),G_MONEY_FORMAT))),cattributes=>'class="str1_cell_center"');
         htp.tabledata( htf.formtext( 'G5', 12, 20, trim(to_char(round(ttl2,2),G_MONEY_FORMAT))),cattributes=>'class="str1_cell_center"');
        else
         htp.tabledata( htf.formtext( 'G4', 12, 20),cattributes=>'class="str1_cell_center"');
         htp.tabledata( htf.formtext( 'G5', 12, 20),cattributes=>'class="str1_cell_center"');
       end if;
      htp.tabledata( '&nbsp;',cattributes=>'class="str1_bg_left"');

    htp.tablerowclose;
    end loop;
  end if;
 htp.tableclose;

  stp := 'm';
 htp.nl;
 htp.tableopen( cattributes=>'class="str1_table4"' );
 htp.tablerowopen;
 if vaccess = 'EDIT'
  then
   if access_id = 'z'
    then
     htp.tabledata( htf.formsubmit( 'ACTION', 'Insert New Invoice' ),cattributes=>'VALIGN="TOP"');
    else
     htp.tabledata( htf.formsubmit( 'ACTION', 'Update Invoice' ),cattributes=>'VALIGN="TOP"');
     htp.tabledata( htf.formsubmit( 'ACTION', 'Invoice List' ),cattributes=>'VALIGN="TOP"');
     if c2rec.completed <> 'COMPLETE'
      then
       htp.tabledata( htf.formsubmit( 'ACTION', 'Delete Invoice' ),cattributes=>'VALIGN="TOP"');
     end if;
     htp.tabledata( htf.formsubmit( 'ACTION', 'Print Invoice' ),cattributes=>'VALIGN="TOP"');
     htp.tabledata( htf.formsubmit( 'ACTION', 'Draft Invoice' ),cattributes=>'VALIGN="TOP"');
     htp.tabledata( htf.formsubmit( 'ACTION', 'Insert New Invoice' ),cattributes=>'VALIGN="TOP"');
   end if;
   htp.formclose;
 end if;

  stp := 'n';
 search( surl, 'INVOICES', nrid, samerow=>TRUE );
 htp.tablerowclose;
 htp.tableclose;
 -- display_report( surl, dapi.GLOBAL_ACCOUNT.acctid, 'REPORT C','Invoicing',c2rec.invoiceno);
 -- display_report( surl, dapi.GLOBAL_ACCOUNT.acctid, 'REPORT C','Invoices Report',to_char(add_months(sysdate,-1),'DD-MON-YYY'),to_char(sysdate,'DD-MON-YYY'));
 -- display_report( surl, dapi.GLOBAL_ACCOUNT.acctid, 'REPORT C','Charges Report',substr(c2rec.invoiceno,3,10),substr(c2rec.invoiceno,3,10),substr(c2rec.invoiceno,1,2));
 -- display_report( surl, dapi.GLOBAL_ACCOUNT.acctid, 'REPORT C','Seafreight Statistics',c2rec.invoiceno);
 -- display_report( surl, dapi.GLOBAL_ACCOUNT.acctid, 'REPORT C','Airfreight Statistics',to_char(add_months(sysdate,-1),'DD-MON-YYY'),to_char(sysdate,'DD-MON-YYY'));
-- open c5( c2rec.invoiceno );
-- fetch c5 into c5rec;
-- close c5;
 -- display_report( surl, dapi.GLOBAL_ACCOUNT.acctid, 'REPORT C','GST Rebate - All Codes',to_char(add_months(sysdate,-1),'DD-MON-YYY'),to_char(sysdate,'DD-MON-YYY'),c5rec.cust_customer_id);
 -- display_report( surl, dapi.GLOBAL_ACCOUNT.acctid, 'REPORT C','GST Rebate - Net Only',c2rec.invoiceno);

   stp := 'o';
if seclevel = 'LEVEL 7'
  then
   download_gl( surl, rid, scid, call_name, parm, access_id, vste, vaccess );
 end if;

 htp.p( '</CENTER>' );
 htp.htmlclose;
exception when others then
 error_details( 'STRANGP', 'INV',null,null,errmsg=>sqlerrm,extdet=>'PARM:' || parm || '[' || stp || ']');
end inv;

procedure download_gl(surl in varchar2, rid in varchar2, scid in varchar2, call_name in varchar2, parm in varchar2, access_id in varchar2 default null, vste in varchar2, vaccess in varchar2 )
as
-- cursor c1 is select * from all_jobs where upper(what) like 'STRANGP.DO_DOWNLOAD_GL%';
 cursor c1 is select * from all_scheduler_jobs where upper(job_name) like '%DO_DOWNLOAD_GL%';
 cursor c2( cd varchar2 ) is select description from strang.lov where lov_name = 'CONTROLS' and code = cd and cola = 'SYD';
 c1rec  c1%ROWTYPE;
 c2rec  c2%ROWTYPE;
begin

 htp.line;
 htp.bold( 'Invoice Download Control' );
 htp.nl;
 htp.tableopen( cattributes=>'class="str1_table"' );
  htp.tablerowopen;
    htp.tabledata( htf.bold('Manual Run'), cattributes=>'class="str1_bg_left" COLSPAN="3"');
  htp.tablerowclose;
  htp.formopen( 'strangp.do_download_gl' );
   open c2( 'INVOICE_INTERFACE_DIRECTORY' );
   fetch c2 into c2rec;
   close c2;
  htp.tablerowopen;
    htp.tabledata( htf.bold('Directory'), cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formhidden( 'RUN_ONCE', 'T' ) ||
                   htf.formtext('VDIR', 40, 100, c2rec.description ), cattributes=>'class="str1_bg_left"');
  htp.tablerowclose;
   c2rec.description := NULL;
   open c2( 'INVOICE_INTERFACE_FILENAME' );
   fetch c2 into c2rec;
   close c2;
  htp.tablerowopen;
    htp.tabledata( htf.bold('File Name'), cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formtext('FNAME', 40, 100, c2rec.description ), cattributes=>'class="str1_bg_left"');
  htp.tablerowclose;
  htp.tablerowopen;
    htp.tabledata( htf.bold('From Invoice Date'), cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formtext('FRM', 30, 100, to_char(sysdate,'DD-MON-YYYY') ), cattributes=>'class="str1_bg_left"');
  htp.tablerowclose;
  htp.tablerowopen;
    htp.tabledata( htf.bold('To Invoice Date'), cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formtext('FTO', 30, 100, to_char(sysdate,'DD-MON-YYYY') ), cattributes=>'class="str1_bg_left"');
  htp.tablerowclose;
  htp.tablerowopen;
    htp.tabledata( '&nbsp;', cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.formsubmit( null, 'Manual Run'), cattributes=>'class="str1_bg_left"');
  htp.tablerowclose;
  htp.formclose;

  htp.tablerowopen;
    htp.tabledata( htf.bold('Batch Run Details'), cattributes=>'class="str1_bg_left" COLSPAN="3"');
  htp.tablerowclose;
  open c1;
  fetch c1 into c1rec;
  if c1%FOUND
   then
    close c1;
   -- htp.tablerowopen;
   --   htp.tabledata( htf.bold('Job Number'), cattributes=>'class="str1_bg_left"');
   --   htp.tabledata( htf.bold(c1rec.job), cattributes=>'class="str1_bg_left"');
   -- htp.tablerowclose;
    htp.tablerowopen;
    htp.tablerowopen;
      htp.tabledata( htf.bold('Name'), cattributes=>'class="str1_bg_left"');
      htp.tabledata( htf.bold(c1rec.job_name), cattributes=>'class="str1_bg_left"');
    htp.tablerowclose;
      htp.tabledata( htf.bold('Next Run at'), cattributes=>'class="str1_bg_left"');
      htp.tabledata( htf.bold(to_char(c1rec.next_run_date,'DD Mon YYYY HH24:MI')), cattributes=>'class="str1_bg_left"');
    htp.tablerowclose;
    htp.tablerowopen;
      htp.tabledata( htf.bold('Frequency'), cattributes=>'class="str1_bg_left"');
      htp.p('<TD ' || 'class="str1_cell_left">');
      if c1rec.repeat_interval like '%BYDAY%'
       then
        htp.bold(regexp_replace(c1rec.repeat_interval, '^(.+)(BYDAY=)([^;]*)(;)(.+)', '\3')); htp.nl;
      end if;
      if c1rec.repeat_interval like '%BYHOUR%'
       then
        htp.bold(replace(regexp_replace(c1rec.repeat_interval, '^(.+)(BYHOUR=)([^;]*)(;)(.+)', '\3'), ',', ':00, ') || ':00');
      end if;
      htp.p('</TD>');
    htp.tablerowclose;
    htp.tablerowopen;
      htp.tabledata( '&nbsp;', cattributes=>'class="str1_bg_left"');
--      htp.tabledata( htf.formopen( 'strangp.stop_batch_job' ) || htf.formsubmit( null, 'Stop Batch Job' ) || htf.formclose, cattributes=>'class="str1_cell_left"');
    htp.formopen( 'strangp.stop_batch_job' );
    htp.formhidden( 'SURL', surl );
    htp.formhidden( 'SCID', scid );
    htp.formhidden( 'PARM', parm );
    htp.formhidden( 'ACCESS_ID', access_id );
    htp.formhidden( 'RID', rid );

    htp.tabledata( htf.formsubmit( null, 'Stop Batch Job' ) || htf.formclose, cattributes=>'class="str1_bg_left"');
    htp.tablerowclose;
   else
    close c1;
    htp.tablerowopen;
      htp.tabledata( htf.bold('No Job is on the Queue'), cattributes=>'class="str1_bg_left" COLSPAN="2"');
    htp.tablerowclose;
    htp.tablerowopen;
      htp.tabledata( '&nbsp;', cattributes=>'class="str1_bg_left"');
--      htp.tabledata( htf.formopen( 'strangp.start_batch_job' ) || htf.formsubmit( null, 'Start Batch Job' ) || htf.formclose, cattributes=>'class="str1_bg_left"');
    htp.formopen( 'strangp.start_batch_job' );
    htp.formhidden( 'SURL', surl );
    htp.formhidden( 'SCID', scid );
    htp.formhidden( 'PARM', parm );
    htp.formhidden( 'ACCESS_ID', access_id );
    htp.formhidden( 'RID', rid );

    htp.tabledata( htf.formsubmit( null, 'Start Batch Job' ) || htf.formclose, cattributes=>'class="str1_cell_left"');
    htp.tablerowclose;
  end if;
 htp.tableclose;

end download_gl;

procedure do_download_gl( vdir in varchar2 default null, fname in varchar2 default null, frm in varchar2 default null, fto in varchar2 default null, run_once in char default 'F' )
as

 cursor c1( cd varchar2 ) is select description from strang.lov where lov_name = 'CONTROLS' and code = cd and cola = 'SYD';
 cursor c2( frm date, fto date ) is
  select *
  from strang.unload_strang
  where ((frm is null) or (frm is not null and invdate >= frm)) and
        ((fto is null) or (fto is not null and invdate <= fto));

 c2rec  c2%ROWTYPE;
 frec   boolean;
 fl     utl_file.file_type;
 dr     varchar2(1000);
 fn     varchar2(1000);
 bfr    varchar2(32767);
 sd     date;
 tm     varchar2(100);
 tmp    varchar2(100);
 tmn    integer;
 jb     number;
 ctr    integer;

begin
 if vdir is null
  then
   open c1( 'INVOICE_INTERFACE_DIRECTORY' );
   fetch c1 into dr;
   close c1;
  else
   dr := vdir;
 end if;

 if fname is null
  then
   open c1( 'INVOICE_INTERFACE_FILENAME' );
   fetch c1 into fn;
   close c1;
  else
   fn := fname;
 end if;

 sd := sysdate;
 fn := fn || to_char(sd,'DD_MON_YYYY_HH24_MI' ) || '.csv';

 open c2(to_date(frm,'DD-MON-YYYY'), to_date(fto,'DD-MON-YYYY') + (99999/100000));
 fetch c2 into c2rec;
  frec := c2%FOUND;
 close c2;

 ctr := 0;
 if frec
  then
   begin
    fl := utl_file.fopen( dr, fn, 'w', 32767 );
   exception
    when others then
     htp.htmlopen;
      htp.header(2,'Unload Could not Run' );
      htp.header(3,'File could not be created:' || dr || chr(92) || fn );
      htp.nl;
      htp.header(4,'Hit Back Button to return to previous screen and try again.' );
     htp.htmlclose;
     return;
   end;

   for c2rec in c2(to_date(frm,'DD-MON-YYYY'), to_date(fto,'DD-MON-YYYY') + (99999/100000)) loop
    if c2rec.total < 0 then
      tmp:= 'C' ;
   else
     tmp:= 'I' ;
   end if;
    bfr := '"' || tmp || '",' ||
         '"' ||
         c2rec.debtor_branch || '","' ||
         c2rec.debtor_code || '","' ||
--         to_char(c2rec.invdate,'DD-MON-YYYY') || '","' ||
         to_char(c2rec.invdate,'DDMMYYYY') || '","' ||
         c2rec.invoiceno || '",' ||
         c2rec.total || ',' ||
         c2rec.gst || ',"' ||
         c2rec.job_branch || '","' ||
--         c2rec.profit_centre || '","' ||
         c2rec.job_code || '","' ||
         c2rec.cost_centre || '","' ||
         c2rec.transaction_type || '","' ||
         substr(trim(replace(replace(replace(c2rec.invdesc,chr(13),' '),chr(10),' '),chr(11),' ')),1,60) || '"' ;

    utl_file.put_line( fl, bfr );
    ctr := ctr + 1;
   end loop;
   utl_file.fclose( fl );

   -- Update invoice to indicate unloaded
   update strang.invoices
    set
     transfer_date = sd
   where
    (invoiceno,invdate) in
    (select invoiceno,invdate
     from strang.unload_strang
    where ((frm is null) or (frm is not null and invdate >= to_date(frm,'DD-MON-YYYY'))) and
           ((fto is null) or (fto is not null and invdate <= to_date(fto,'DD-MON-YYYY') + (99999/100000)))
    );

   commit;
 end if;

 if run_once = 'T'
  then
   htp.htmlopen;
    htp.header(2,'Unload has run.' );
    if ctr = 0
     then
      htp.header( 3, 'No Rows Unloaded.' );
     else
      htp.header( 3, '# Rows Unloaded: ' || ctr );
    end if;
    htp.header(3,'Check output in file:' || dr || chr(92) || fn );
    htp.nl;
    htp.header(4,'Hit Back Button to return to previous screen' );
   htp.htmlclose;
   return;
 end if;

exception
 when others then
 error_details( 'STRANGP', 'DO_DOWNLOAD_GL',null,null,errmsg=>sqlerrm);
end do_download_gl;

procedure start_batch_job(surl in varchar2, rid in varchar2, scid in varchar2, parm in varchar2, access_id in varchar2 default null )
as
 cursor c1( cd varchar2 ) is select description from strang.lov where lov_name = 'CONTROLS' and code = cd and cola = 'SYD';
 jb	number;
 tm	varchar2(1000);

begin

 -- Resubmit
 open c1( 'INVOICE_INTERFACE_FREQUENCY' );
 fetch c1 into tm;
 close c1;

 dbms_scheduler.create_job(  job_name=> 'do_download_gl'
                           , job_type=> 'STORED_PROCEDURE'
                           , job_action=> 'strangp.do_download_gl'
                           , repeat_interval=> 'FREQ=' || tm
                           , number_of_arguments=> 0
                           , enabled=> TRUE
                           , comments=> 'Invoice Download'
                          )
;

inv( surl, rid, scid, null, parm, access_id, 'Batch Job Started');
--   htp.htmlopen;
--    htp.header( 2,'Job Started' );
--    htp.header( 2,'Click Back Button to go back' );
--   htp.htmlclose;

exception
 when others then
 error_details( 'STRANGP', 'START_BATCH_JOB',null,null,errmsg=>sqlerrm);
end start_batch_job;

procedure stop_batch_job(surl in varchar2, rid in varchar2, scid in varchar2, parm in varchar2, access_id in varchar2 default null )
as
 cursor c1 is select * from all_scheduler_jobs where upper(job_name) like '%DO_DOWNLOAD_GL%';
 c1rec  c1%ROWTYPE;
begin
 open c1;
 fetch c1 into c1rec;
 if c1%FOUND
  then
   close c1;
   dbms_scheduler.drop_job(c1rec.job_name);
   inv( surl, rid, scid, null, parm, access_id, 'Batch Job Stopped');
--   htp.htmlopen;
--    htp.header( 2,'Job Stopped' );
--    htp.header( 2,'Click Back Button to go back' );
--   htp.htmlclose;
   return;
 inv( surl, rid, scid, null, parm, access_id, 'Batch Job is not Running');
 end if;
 close c1;

exception
 when others then
 error_details( 'STRANGP', 'STOP_BATCH_JOB',null,null,errmsg=>sqlerrm);
end stop_batch_job;

procedure accept_inv( surl in varchar2, scid in integer, parm in varchar2, access_id in varchar2, rid in varchar2, action in varchar2,
                      p1 in varchar2, p2 in varchar2, p3 in varchar2, p4 in varchar2, p5 in varchar2, p6 in varchar2, p7 in varchar2, p8 in varchar2,
                      p9 in varchar2, p10 in varchar2, p11 in varchar2, p12 in varchar2, psts in varchar2,
                      r0 in owa.vc_arr, r1 in owa.vc_arr, r2 in owa.vc_arr, r3 in owa.vc_arr, r4 in owa.vc_arr, r5 in owa.vc_arr, r6 in owa.vc_arr, r7 in owa.vc_arr,
                      g0 in owa.vc_arr, g1 in owa.vc_arr, g2 in owa.vc_arr, g3 in owa.vc_arr, g4 in owa.vc_arr, g5 in owa.vc_arr, g6 in owa.vc_arr)
as

 cursor c1(invnmb varchar2) is select 'x' tot from strang.invoices where invoiceno = invnmb;
 cursor c2(rid rowid) is select invoiceno from strang.invoices where rowid = rid;
 cursor c3(cde varchar2, nmb1 number, nmb2 number)
  is
  select decode(colb,'No GST',0,
                     'Inc GST',(nmb1*nmb2) - ((100 * (nmb1*nmb2)) / (100 + nvl(cola,0) )),
                     'Add GST',(nmb1*nmb2) * ((nvl(to_number(cola),0))/100) ) subgst,
         decode(colb,'No GST',(nmb1*nmb2),
                     'Inc GST',(nmb1*nmb2),
                     'Add GST',(nmb1*nmb2) + ((nmb1*nmb2) * ((nvl(to_number(cola),0))/100)) ) newtotal
  from strang.lov
  where lov_name = 'GSTCODES' and
        code = cde;
 cursor c4(cde varchar2 ) is select * from strang.charges where chargecode = cde;
 cursor c5(inv1 varchar2, cge2 varchar2 ) is select 'x' ex from strang.invcharges where inv_invoiceno = inv1 and cge_chargecode = cge2;
 cursor c6(inv varchar2) is select nvl(max(recno),0)+1 nmb from strang.general_ledger where invoiceno = inv;
 cursor c7(lname varchar2, cd varchar2) is select cola from strang.lov where lov_name = lname and code = cd;
 cursor c8(invc varchar2) is
   select decode(nvl(i.gstc_gstcode,'EX'), 'EX', c.sales_costcentre_no_gst, c.sales_costcentre_gst) tt,
         c.costs_costcentre,
         sum( ((cgrate*quantity)+gst) ) sm,
         sum( gst ) sgst
    from strang.charges c, strang.invcharges i, strang.invoices inv
    where c.chargecode = i.cge_chargecode and
          inv.invoiceno = i.inv_invoiceno and
          inv.invoiceno = invc
    group by decode(nvl(i.gstc_gstcode,'EX'), 'EX', c.sales_costcentre_no_gst, c.sales_costcentre_gst), c.costs_costcentre;
 cursor c9(invc varchar2) is
   select c.costs_costcentre tt
    from strang.charges c, strang.invcharges i, strang.invoices inv
    where c.chargecode = i.cge_chargecode and
          inv.invoiceno = i.inv_invoiceno and
          inv.invoiceno = invc
    group by c.costs_costcentre;
 cursor c10(invc varchar2) is select status from strang.invoices where invoiceno=invc;
 cursor c11(invc varchar2, trtyp varchar2) is select sum(total) from strang.general_ledger where invoiceno=invc and transaction_type=trtyp;
 cursor c12( invno varchar2 ) is select cgrate, quantity, gst from strang.invcharges where inv_invoiceno = invno order by cge_chargecode;


 c1rec		c1%ROWTYPE;
 c2rec		c2%ROWTYPE;
 c4rec		c4%ROWTYPE;
 c5rec		c5%ROWTYPE;
 c7rec		c7%ROWTYPE;
 c12rec		c12%ROWTYPE;

 newrid		rowid;
 sts		varchar2(100);
 nmb1		number;
 nmb2		number;
 nmb3s		number;
 nmb3t		number;
 nmb4		integer;
 rc		integer;
 dt1		date;
 err		boolean;
 prdone		char(1);
 vp8		varchar2(4000);
 vmsg		varchar2(1000);
 totsales	number;
 totchrg	number;
 ttl1		number;
 prev_status	varchar2(14);

begin
 if not dapi.init( surl, 'STRANGP.ACCEPT_SHP' , null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'ACCEPT_SHP' );
    return;
 end if;

 if action = 'Insert New Invoice' and access_id <> 'z'
  then
   inv(surl,null,scid,null,parm,'z','Insert New Invoice' );
   return;
 end if;

 if action = 'Update Invoice'
  then
   open c2(chartorowid( replace(rid,'~','+') ));
   fetch c2 into c2rec;
   close c2;
   open c10(c2rec.invoiceno);
   fetch c10 into prev_status;
   close c10;
 end if;

 if action = 'Print Invoice'
  then
   open c2(replace(rid,'~','+'));
   fetch c2 into c2rec;
   close c2;
   invoke_report(surl,repname=>'Invoice',r1=>c2rec.invoiceno,r2=>'Y',r3=>NULL);
   return;
 end if;

 if action = 'Draft Invoice'
  then
   open c2(replace(rid,'~','+'));
   fetch c2 into c2rec;
   close c2;
   invoke_report(surl,repname=>'draft_invoice',r1=>c2rec.invoiceno,r2=>'Y',r3=>NULL);
   return;
 end if;

 vmsg := NULL;
    inv( surl, rid, scid, null, parm, access_id, 'An Invoice Number must be Entered' );
 begin dt1 := to_date(p3,LNG_MASK); exception when others then inv( surl, rid, scid, null, parm, access_id, 'Invalid Date Entered' || ':' || p3 || ' ' || 'must be of format' || ':' || LNG_MASK ); return; end;
 if p1 is null and access_id = 'z'
  then
    return;
 end if;
 if p2 is null and access_id = 'z'
  then
    inv( surl, rid, scid, null, parm, access_id, 'A Contract must be Entered' );
    return;
 end if;
 if p3 is null and access_id = 'z'
  then
    inv( surl, rid, scid, null, parm, access_id, 'An Invoice Date must be Entered' );
    return;
 end if;

 if action = 'Confirm Deletion of this Invoice' -- Confirm Deletion of this Invoice
  then
   update strang.movements set invoiceno = null, interface4_date = null where invoiceno = (select invoiceno from strang.invoices where rowid = chartorowid( replace(rid,'~','+') ));
   delete from strang.invcharges where inv_invoiceno = (select invoiceno from strang.invoices where rowid = chartorowid( replace(rid,'~','+') ));
   delete from strang.general_ledger where invoiceno = (select invoiceno from strang.invoices where rowid = chartorowid( replace(rid,'~','+') ));
   delete from strang.invoices where rowid = chartorowid( replace(rid,'~','+') );
   insert into strang.invdels(invoiceno,invdate,deldate) values (p1,dt1,sysdate);
   commit;
   inv(surl,null,scid,null,parm,'z','Invoice Deleted');
   return;

 elsif action = 'Delete Invoice' -- Delete Invoice
  then

    open c2(replace(rid,'~','+'));
    fetch c2 into c2rec;
    close c2;
    main_title( 'Confirm Deletion of this Invoice' || ' : ' || c2rec.invoiceno,helpid=>'STR29');
    htp.formopen( 'strangp.accept_inv' );
    htp.p( '<CENTER>' );
    htp.nl;
    htp.nl;
    htp.nl;
    htp.formhidden( 'SURL', surl );
    htp.formhidden( 'SCID', scid );
    htp.formhidden( 'PARM', parm );
    htp.formhidden( 'ACCESS_ID', access_id );
    htp.formhidden( 'RID', replace(rid,'~','+') );
    htp.formhidden( 'P1', p1 );
    htp.formhidden( 'P2', p2 );
    htp.formhidden( 'P3', p3 );
    htp.formhidden( 'P4', p4 );
    htp.formhidden( 'P5', p5 );
    htp.formhidden( 'P6', p6 );
    htp.formhidden( 'P7', p7 );
    htp.formhidden( 'P8', p8 );
    htp.formhidden( 'P9', p9 );
    htp.formhidden( 'P10', p10 );
    htp.formhidden( 'P11', p11 );
    htp.formhidden( 'P12', p12 );
    htp.formhidden( 'PSTS', psts );
    for j in r0.first..r0.last loop
     htp.formhidden( 'R0', r0(j) );
    end loop;
    for j in r1.first..r1.last loop
     htp.formhidden( 'R1', r1(j) );
    end loop;
    for j in r2.first..r2.last loop
     htp.formhidden( 'R2', r2(j) );
    end loop;
    for j in r3.first..r3.last loop
     htp.formhidden( 'R3', r3(j) );
    end loop;
    for j in r4.first..r4.last loop
     htp.formhidden( 'R4', r4(j) );
    end loop;
    for j in r5.first..r5.last loop
     htp.formhidden( 'R5', r5(j) );
    end loop;
    for j in r6.first..r6.last loop
     htp.formhidden( 'R6', r6(j) );
    end loop;
    for j in r7.first..r7.last loop
     htp.formhidden( 'R7', r7(j) );
    end loop;
    for j in g0.first..g0.last loop
     htp.formhidden( 'G0', g0(j) );
    end loop;
    for j in g1.first..g1.last loop
     htp.formhidden( 'G1', g1(j) );
    end loop;
    for j in g2.first..g2.last loop
     htp.formhidden( 'G2', g2(j) );
    end loop;
    for j in g3.first..g3.last loop
     htp.formhidden( 'G3', g3(j) );
    end loop;
    for j in g4.first..g4.last loop
     htp.formhidden( 'G4', g4(j) );
    end loop;
    for j in g5.first..g5.last loop
     htp.formhidden( 'G5', g5(j) );
    end loop;
    for j in g6.first..g6.last loop
     htp.formhidden( 'g6', g6(j) );
    end loop;
    htp.formsubmit( 'ACTION', 'Confirm Deletion of this Invoice' );
    htp.formclose;
    htp.p( '</CENTER>' );
    htp.htmlclose;
    return;
 end if;

 vp8 := substr(p8,1,4000);
 if access_id = 'z'
  then
   open c1(p1);
   fetch c1 into c1rec;
   if c1%FOUND
    then
     close c1;
     inv( surl, rid, scid, null, parm, access_id,'This invoice number already exists' || ':' || p1 );
     return;
   end if;
   close c1;
   insert into strang.invoices(invoiceno,ctrk_contract,invdate,completed,billingmonth,billingyear,owner,invdesc,gstinclusive,job_branch,debtor_branch,debtor_code,job_code,status) values
    (p1,p2,dt1,p4,p5,p6,p7,vp8,'Y',p9,p10,p11,nvl(p12,p1),psts)
    returning rowid into newrid; -- Added change to use invoice no instead of x.
   if p12 is null then vmsg := 'Job Code must have a value'; end if;
  else
   update strang.invoices
    set
     ctrk_contract = p2,
     invdate = nvl(dt1,invdate),
     completed = p4,
     billingmonth = p5,
     job_branch = p9,
     billingyear = p6,
     owner = p7,
     invdesc = vp8,
     debtor_branch = p10,
     debtor_code = p11,
     job_code = nvl(p12,job_code),
     status = psts
   where
    rowid = chartorowid( replace(rid,'~','+') );
   if p12 is null then vmsg := 'Job Code must have a value'; end if;
   if dt1 is null then vmsg := vmsg || ' ' || 'Inv Date must have a value'; end if;
   open c2(chartorowid( replace(rid,'~','+') ));
   fetch c2 into c2rec;
   close c2;
   if c2rec.invoiceno <> p1
    then
     open c1(p1);
     fetch c1 into c1rec;
     if c1%FOUND
      then
       close c1;
       rollback;
       inv( surl, rid, scid, null, parm, access_id, 'This invoice number already exists' || ':' || p1 || ' ' || vmsg);
       return;
      end if;
     close c1;

     update strang.invcharges set inv_invoiceno = p1 where inv_invoiceno = c2rec.invoiceno;
     update strang.invdels set invoiceno = p1 where invoiceno = c2rec.invoiceno;
     update strang.movements set invoiceno = p1, interface4_date = null where invoiceno = c2rec.invoiceno;
     update strang.invoices set invoiceno = p1 where rowid = chartorowid( replace(rid,'~','+') );
   end if;
 end if;

 for j in r0.first..r0.last loop
   begin nmb1 := to_number( r3(j) ); exception when others then nmb1 := null; end;
   begin nmb2 := to_number( r5(j) ); exception when others then nmb2 := null; end;
   nmb2 := nvl(nmb2,1);
   open c3(r6(j),nmb1,nmb2);
   fetch c3 into nmb3s,nmb3t;
   if c3%NOTFOUND then nmb3s := 0; end if;
   close c3;
   if r0(j) is null
   then
    -- Insert
    if r1(j) is not null
     then
     open c4( r1(j) );
     fetch c4 into c4rec;
     close c4;
     open c3(c4rec.gstc_gstcode,c4rec.rate,nmb2);
     fetch c3 into nmb3s,nmb3t;
     close c3;
     open c5(p1,c4rec.chargecode);
     fetch c5 into c5rec;
     if c5%FOUND
      then
       close c5;
      else
       close c5;
       insert into strang.invcharges(inv_invoiceno,quantity,cgunit,cgdesc,cge_chargecode,cgrate,gstc_gstcode,gst) values
       (p1,nmb2,c4rec.unit_unitused,nvl(c4rec.chargedesc,'No Description'),c4rec.chargecode,c4rec.rate,c4rec.gstc_gstcode,nmb3s);
     end if;
    end if;
   else
    -- Update
    if r1(j) = r0(j)
     then
      update strang.invcharges
       set
        quantity = nmb2,
        cgunit = r4(j),
        cgdesc = nvl(r2(j),'No Description'),
        cgrate = nmb1,
        gstc_gstcode = r6(j),
        gst = nmb3s
      where inv_invoiceno = p1 and
            cge_chargecode = r1(j);
     else
      update strang.invcharges
       set
        cge_chargecode = r1(j),
        quantity = nmb2,
        cgunit = r4(j),
        cgdesc = nvl(r2(j),'No Description'),
        cgrate = nmb1,
        gstc_gstcode = r6(j),
        gst = nmb3s
      where inv_invoiceno = p1 and
            cge_chargecode = r0(j);
    end if;
  end if;
 end loop;

 prdone := 'T';
 for j in g0.first..g0.last loop

   begin
    nmb1 := to_number( g4(j) );
   exception when others then
    begin
     nmb1 := to_number( g4(j),G_MONEY_FORMAT );
    exception when others then
     begin
      nmb1 := to_number( g4(j),G_MONEY_FORMAT2 );
     exception when others then
      vmsg := vmsg || htf.nl || 'General Ledger line ' || j || ' "Total" incorrect money format: ' || g4(j);
      nmb1 := 0;
     end;
    end;
   end;
   begin nmb2 := to_number( g5(j) );
   exception when others then
    begin
     nmb2 := to_number( g5(j),G_MONEY_FORMAT );
    exception when others then
     begin
      nmb2 := to_number( g5(j),G_MONEY_FORMAT2 );
     exception when others then
      vmsg := vmsg || htf.nl || 'General Ledger line ' || j || ' "GST" incorrect money format: ' || g5(j);
      nmb2 := 0;
     end;
    end;
   end;
   nmb2 := nvl(nmb2,0);

   err := FALSE;
   if g3(j) is not null and g1(j) is not null
    then
     open c7('COST_CENTRE',g3(j));
     fetch c7 into c7rec;
     close c7;
   end if;
   if c7rec.cola is not null and g3(j) is not null
    then
     if g1(j) <> c7rec.cola
      then
       -- error
       err := TRUE;
       if vmsg is not null then vmsg := vmsg || htf.nl; end if;
       vmsg := vmsg || 'Cost Centre not correct for Transaction Type';
     end if;
   end if;

   if err
    then
     null;
   elsif g0(j) is null
    then

     -- Modified to remove profit centre
     if g3(j) is not null and nmb1 is not null
      then
       open c6( p1 );
       fetch c6 into nmb4;
       close c6;
       if g1(j) = 'C' then nmb2 := 0; end if;
       insert into strang.general_ledger(invoiceno,recno,transaction_type,cost_centre,total,gst) values
        (p1,nmb4,g1(j),g3(j),nmb1,nmb2);
   --    if vmsg is not null then vmsg := vmsg || htf.nl; end if;
     --elsif g2(j) is not null and g3(j) is null
   --  elsif g3(j) is null
   --   then
   --    vmsg := vmsg || 'Cost Centre not entered';
     --elsif g2(j) is null and g3(j) is not null
     -- then
     --  if vmsg is not null then vmsg := vmsg || htf.nl; end if;
     --  vmsg := vmsg || 'PROFIT CENTRE/S NEED TO BE ENTERED';
     --  prdone := 'F';
     end if;

    else

     if g1(j) = 'C' then nmb2 := 0; end if;
     update strang.general_ledger
      set
       transaction_type = g1(j),
       -- profit_centre = g2(j),
       cost_centre = g3(j),
       total = nmb1,
       gst = nmb2
     where invoiceno = p1 and
           recno = g0(j);
   end if;
 end loop;

 for j in r7.first..r7.last loop
  if r7(j) is not null
   then
    delete from strang.invcharges where rowid = chartorowid( r7(j) );
  end if;
 end loop;

 for j in g6.first..g6.last loop
  if g6(j) is not null
   then
    delete from strang.general_ledger where rowid = chartorowid( g6(j) );
  end if;
 end loop;

 if action = 'Populate GL'
  then
   delete from strang.general_ledger
    where invoiceno = p1;
   rc := 0;
   for c8rec in c8(p1) loop
    rc := rc + 1;
    insert into strang.general_ledger(invoiceno,recno,transaction_type,profit_centre,cost_centre,total,gst) values
     (p1, rc, 'S', 'X', nvl(c8rec.tt,'X'), nvl(c8rec.sm,0), nvl(c8rec.sgst,0) );
   end loop;
   for c9rec in c9(p1) loop
    rc := rc + 1;
    insert into strang.general_ledger(invoiceno,recno,transaction_type,profit_centre,cost_centre,total,gst) values
     (p1, rc, 'C', 'X', nvl(c9rec.tt,'X'), 0, 0 );
   end loop;

   -- Change status to complete automatically
   update strang.invoices
    set
     completed = decode(prdone,'T','COMPLETE',completed)
   where
    rowid = chartorowid( replace(rid,'~','+') );

 end if;

 if action = 'Update Invoice' and    -- Update Invoice ?
    psts = 'GL COMPLETE' and         -- Status changing from GL INCOMPLETE to GL COMPLETE
    prev_status = 'GL INCOMPLETE'
  then
   open c11(c2rec.invoiceno, 'C');
   fetch c11  into totchrg;
   close c11;
   open c11(c2rec.invoiceno, 'S');
   fetch c11 into totsales;
   close c11;
   ttl1 := 0;
   for c12rec in c12(c2rec.invoiceno) loop
     ttl1 := ttl1 + round(nvl(c12rec.cgrate*c12rec.quantity+c12rec.gst,0), 2);
   end loop;
   ttl1 := round(ttl1,2);
   if totchrg > totsales or
      totsales <> ttl1
    then
     if totchrg > totsales
      then
       vmsg := 'GL COSTS CANNOT EXCEED SALES';
     end if;
     if totsales <> ttl1
      then
       vmsg := vmsg || '<BR>SALES TOTAL (' || totsales  || ') MUST EQUAL TOTAL INVOICE VALUE (' || ttl1 || ')';
     end if;
     update strang.invoices set status = 'GL INCOMPLETE' where rowid = chartorowid( replace(rid,'~','+') );
   else
     update strang.invoices set invdate=sysdate where rowid = chartorowid( replace(rid,'~','+') );
   end if;
 end if;

 commit;

 if access_id = 'z'
  then
   inv( surl, newrid, scid, null, parm, 'x', nvl(vmsg,'New Invoice Successfully Inserted') );
  else
   if action in ('Update Invoice', 'Populate GL')
    then
     inv( surl, rid, scid, null, parm, access_id, nvl(vmsg,'Record Successfully Updated') );
    else
     inv2( surl, rid, scid, null, parm, access_id, nvl(vmsg,'Record Successfully Updated') );
    end if;
 end if;
exception when others then
 error_details( 'STRANGP', 'ACCEPT_INV',null,null,errmsg=>sqlerrm,extdet=>'PARM:' || parm);
end accept_inv;

procedure inv2(surl in varchar2, rid in varchar2, scid in varchar2, call_name in varchar2, parm in varchar2, access_id in varchar2 default null, msg in varchar2 default null )
as

 cursor c2( rid rowid ) is select * from strang.invoices where rowid = rid;
 cursor c3( invno varchar2 ) is select rowid,movement_no,seal,movement_type from strang.movements where invoiceno = invno;
 cursor c4( mtype varchar2 ) is select rowid,movement_no,seal from strang.movements where invoiceno is null and movement_type = mtype order by 2, 3;

 c2rec		c2%ROWTYPE;
 sts		varchar2(100);
 mn		char(3);
 ttl1		number;
 ttl2		number;
 vaccess	varchar2(20);

begin
 if not dapi.init( surl, 'STRANGP.INV2' , null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'INV2' );
    return;
 end if;

 vaccess := data_access( 'INVOICING' );

 main_title( 'Invoice List',helpid=>'STR30');

 if msg is not null
  then
   header_msg( msg );
 end if;
 htp.p( '<CENTER>' );
  if vaccess = 'NONE' then htp.bold( 'Access Denied' ); htp.htmlclose; return; end if;
 open c2(replace(rid,'~','+'));
 fetch c2 into c2rec;
 close c2;

 if vaccess = 'EDIT'
  then
   htp.formopen( 'strangp.accept_inv2' );
   htp.formhidden( 'SURL', surl );
   htp.formhidden( 'SCID', scid );
   htp.formhidden( 'PARM', parm );
   htp.formhidden( 'ACCESS_ID', access_id );
   htp.formhidden( 'RID', replace(rid,'~','+') );
 end if;

 htp.tableopen( cattributes=>'class="str1_table"' );
  htp.tablerowopen;
     htp.tabledata( htf.bold('Inv Number'),cattributes=>'class="str1_bg_right"');
     htp.tabledata( htf.bold(c2rec.invoiceno),cattributes=>'class="str1_bg_left"');
     htp.tabledata( '&nbsp;',cattributes=>'class="str1_bg_left"');
  htp.tablerowclose;
  htp.tablerowopen;
     htp.tabledata( htf.bold('Status'),cattributes=>'class="str1_bg_right"');
     htp.tabledata( htf.bold(c2rec.completed),cattributes=>'class="str1_bg_left"');
     htp.tabledata( '&nbsp;',cattributes=>'class="str1_bg_left"');
  htp.tablerowclose;
  htp.tablerowopen;
     htp.tabledata( htf.bold('Weight (Kg)'),cattributes=>'class="str1_bg_right"');
     htp.tabledata( htf.bold( to_char(c2rec.weight)),cattributes=>'class="str1_bg_left"');
     htp.tabledata( '&nbsp;',cattributes=>'class="str1_bg_left"');
  htp.tablerowclose;
  htp.tablerowopen;
     htp.tabledata( htf.bold('Volume (m3)'),cattributes=>'class="str1_bg_right"');
     htp.tabledata( htf.bold( to_char(c2rec.volume)),cattributes=>'class="str1_bg_left"');
     htp.tabledata( '&nbsp;',cattributes=>'class="str1_bg_left"');
  htp.tablerowclose;
  htp.tablerowopen;
     htp.tabledata( htf.bold('Revenue Tonne (REVTON)'),cattributes=>'class="str1_bg_right"');
     htp.tabledata( htf.bold( to_char(c2rec.revton)),cattributes=>'class="str1_bg_left"');
     htp.tabledata( '&nbsp;',cattributes=>'class="str1_bg_left"');
  htp.tablerowclose;
  htp.tablerowopen;
     htp.tabledata( htf.bold('Gross Weight'),cattributes=>'class="str1_bg_right"');
     htp.tabledata( htf.bold( to_char(c2rec.gross)),cattributes=>'class="str1_bg_left"');
     htp.tabledata( '(Containers Only - Including Tare)',cattributes=>'class="str1_bg_left"');
  htp.tablerowclose;
  htp.tablerowopen;
     htp.tabledata( htf.bold('Chargeable Weight'),cattributes=>'class="str1_bg_right"');
     htp.tabledata( htf.bold( to_char(c2rec.chargeweight)),cattributes=>'class="str1_bg_left"');
     htp.tabledata( '(Airfreight Only)',cattributes=>'class="str1_bg_left"');
  htp.tablerowclose;
 htp.tableclose;
 htp.nl;
 if vaccess = 'EDIT'
  then
   if c2rec.completed = 'COMPLETE'
    then
       htp.formhidden( 'R0', null );
       htp.formhidden( 'R1', null );
       htp.formhidden( 'R2', null );
       htp.formhidden( 'R3', null );
       htp.formhidden( 'R4', null );
       htp.formhidden( 'R5', null );
   end if;
 end if;
 htp.tableopen;
  htp.tablerowopen;
     htp.tabledata( htf.bold('Container No'),cattributes=>'class="str1_bg_center"');
     htp.tabledata( htf.bold('Seal'),cattributes=>'class="str1_bg_center"');
     htp.tabledata( htf.bold('Connote'),cattributes=>'class="str1_bg_center"');
     htp.tabledata( htf.bold('MAWB'),cattributes=>'class="str1_bg_center"');
     if c2rec.completed = 'COMPLETE'
      then
       null;
      else
       htp.tabledata( htf.bold('Delete'),cattributes=>'class="str1_bg_center"');
     end if;
  htp.tablerowclose;
  htp.formhidden( 'R5', null );
  for c3rec in c3( c2rec.invoiceno ) loop
  htp.tablerowopen;
   if vaccess = 'EDIT'
    then
     htp.formhidden( 'R0', rowidtochar(c3rec.rowid) );
     htp.formhidden( 'R6', c3rec.movement_type );
     if c3rec.movement_type = 'CARGO'
      then
       if c2rec.completed = 'COMPLETE'
        then
         htp.tabledata( c3rec.movement_no,cattributes=>'class="str1_bg_left"');
         htp.tabledata( c3rec.seal,cattributes=>'class="str1_bg_left"');
        else
         htp.tabledata( htf.formtext( 'R1', 15, 15, c3rec.movement_no ),cattributes=>'class="str1_bg_left"');
         htp.tabledata( htf.formtext( 'R2', 15, 15, c3rec.seal ),cattributes=>'class="str1_bg_left"');
       end if;
       htp.tabledata( '&nbsp;' ,cattributes=>'class="str1_bg_left"');
       htp.tabledata( '&nbsp;' ,cattributes=>'class="str1_bg_left"');
       htp.formhidden( 'R3', null );
       htp.formhidden( 'R4', null );
     elsif c3rec.movement_type = 'CONMOV'
      then
       htp.formhidden( 'R1', null );
       htp.formhidden( 'R2', null );
       htp.tabledata( '&nbsp;' ,cattributes=>'class="str1_bg_left"');
       htp.tabledata( '&nbsp;' ,cattributes=>'class="str1_bg_left"');
       if c2rec.completed = 'COMPLETE'
        then
         htp.tabledata( c3rec.movement_no,cattributes=>'class="str1_bg_left"');
        else
         htp.tabledata( htf.formtext( 'R3', 15, 15, c3rec.movement_no ),cattributes=>'class="str1_bg_left"');
       end if;
       htp.tabledata( '&nbsp;' ,cattributes=>'class="str1_bg_left"');
       htp.formhidden( 'R4', null );
     elsif c3rec.movement_type = 'AIRWAY'
      then
       htp.formhidden( 'R1', null );
       htp.formhidden( 'R2', null );
       htp.formhidden( 'R3', null );
       htp.tabledata( '&nbsp;' ,cattributes=>'class="str1_bg_left"');
       htp.tabledata( '&nbsp;' ,cattributes=>'class="str1_bg_left"');
       htp.tabledata( '&nbsp;' ,cattributes=>'class="str1_bg_left"');
       if c2rec.completed = 'COMPLETE'
        then
         htp.tabledata( c3rec.movement_no,cattributes=>'class="str1_bg_left"');
        else
         htp.tabledata( htf.formtext( 'R4', 15, 15, c3rec.movement_no ),cattributes=>'class="str1_bg_left"');
       end if;
     end if;
     if c2rec.completed = 'COMPLETE'
      then
       null;
      else
       htp.tabledata( htf.formcheckbox( 'R5', c3rec.rowid ),cattributes=>'class="str1_cell_center"');
     end if;
   else
    if c3rec.movement_type = 'CARGO'
     then
      htp.tabledata( c3rec.movement_no,cattributes=>'class="str1_bg_left"');
      htp.tabledata( c3rec.seal,cattributes=>'class="str1_bg_left"');
      htp.tabledata( '&nbsp;' ,cattributes=>'class="str1_bg_left"');
      htp.tabledata( '&nbsp;' ,cattributes=>'class="str1_bg_left"');
    elsif c3rec.movement_type = 'CONMOV'
     then
      htp.tabledata( '&nbsp;' ,cattributes=>'class="str1_bg_left"');
      htp.tabledata( '&nbsp;' ,cattributes=>'class="str1_bg_left"');
      htp.tabledata( c3rec.movement_no,cattributes=>'class="str1_bg_left"');
      htp.tabledata( '&nbsp;' ,cattributes=>'class="str1_bg_left"');
    elsif c3rec.movement_type = 'AIRWAY'
     then
      htp.tabledata( '&nbsp;' ,cattributes=>'class="str1_bg_left"');
      htp.tabledata( '&nbsp;' ,cattributes=>'class="str1_bg_left"');
      htp.tabledata( '&nbsp;' ,cattributes=>'class="str1_bg_left"');
      htp.tabledata( c3rec.movement_no,cattributes=>'class="str1_bg_left"');
    end if;
   end if;
  htp.tablerowclose;
  end loop;

 if c2rec.completed = 'COMPLETE' or vaccess <> 'EDIT'
  then
   null;
  else
   htp.tablerowopen;
     htp.formhidden( 'R0', null );
     htp.formhidden( 'R6', 'CARGO' );
     htp.formhidden( 'R2', null );
     htp.formhidden( 'R3', null );
     htp.formhidden( 'R4', null );
     htp.p( '<TD ' || 'class="str1_cell_left">');
     htp.formselectopen( 'R1' );
     htp.formselectoption( NULL );
     for c4rec in c4( 'CARGO' ) loop
      htp.formselectoption( c4rec.movement_no || '-' || c4rec.seal, cattributes=>'VALUE="' || c4rec.rowid || '"'  );
     end loop;
     htp.formselectclose;
     htp.p( '</TD>' );
     htp.tabledata( '&nbsp;' ,cattributes=>'class="str1_bg_left"');
     htp.tabledata( '&nbsp;' ,cattributes=>'class="str1_bg_left"');
     htp.tabledata( '&nbsp;' ,cattributes=>'class="str1_bg_left"');
     htp.tabledata( '&nbsp;',cattributes=>'class="str1_cell_center"');
   htp.tablerowclose;

   htp.tablerowopen;
     htp.formhidden( 'R0', null );
     htp.formhidden( 'R6', 'CONMOV' );
     htp.formhidden( 'R1', null );
     htp.formhidden( 'R2', null );
     htp.formhidden( 'R4', null );
     htp.tabledata( '&nbsp;' ,cattributes=>'class="str1_bg_left"');
     htp.tabledata( '&nbsp;' ,cattributes=>'class="str1_bg_left"');
     htp.p( '<TD ' || 'class="str1_cell_left">');
     htp.formselectopen( 'R3' );
     htp.formselectoption( NULL );
     for c4rec in c4( 'CONMOV' ) loop
      htp.formselectoption( c4rec.movement_no, cattributes=>'VALUE="' || c4rec.rowid || '"'  );
     end loop;
     htp.formselectclose;
     htp.p( '</TD>' );
     htp.tabledata( '&nbsp;' ,cattributes=>'class="str1_bg_left"');
     htp.tabledata( '&nbsp;',cattributes=>'class="str1_cell_center"');
   htp.tablerowclose;

   htp.tablerowopen;
     htp.formhidden( 'R0', null );
     htp.formhidden( 'R6', 'AIRWAY' );
     htp.formhidden( 'R1', null );
     htp.formhidden( 'R2', null );
     htp.formhidden( 'R3', null );
     htp.tabledata( '&nbsp;' ,cattributes=>'class="str1_bg_left"');
     htp.formselectopen( 'R4' );
     htp.tabledata( '&nbsp;' ,cattributes=>'class="str1_bg_left"');
     htp.tabledata( '&nbsp;' ,cattributes=>'class="str1_bg_left"');
     htp.p( '<TD ' || 'class="str1_cell_left">');
     htp.formselectoption( NULL );
     for c4rec in c4( 'AIRWAY' ) loop
      htp.formselectoption( c4rec.movement_no, cattributes=>'VALUE="' || c4rec.rowid || '"'  );
     end loop;
     htp.formselectclose;
     htp.p( '</TD>' );
     htp.tabledata( '&nbsp;',cattributes=>'class="str1_cell_center"');
   htp.tablerowclose;
 end if;
 htp.tableclose;
 htp.nl;
 if vaccess = 'EDIT'
  then
   if c2rec.completed = 'COMPLETE'
    then
     htp.formhidden( 'R0', null );
     htp.formhidden( 'R1', null );
     htp.formhidden( 'R2', null );
     htp.formhidden( 'R3', null );
     htp.formhidden( 'R4', null );
     htp.formhidden( 'R5', null );
     htp.formhidden( 'R6', null );
     htp.formsubmit( 'ACTION', 'Display Invoice Details' );
    else
     htp.formsubmit( 'ACTION', 'Update Invoice List' );
     htp.formsubmit( 'ACTION', 'Invoice Details' );
   end if;
   htp.formclose;
 end if;
 htp.p( '</CENTER>' );
 htp.htmlclose;
exception when others then
 error_details( 'STRANGP', 'INV2',null,null,errmsg=>sqlerrm,extdet=>'PARM:' || parm);
end inv2;

procedure accept_inv2( surl in varchar2, scid in integer, parm in varchar2, access_id in varchar2, rid in varchar2, action in varchar2,
                       r0 in owa.vc_arr, r1 in owa.vc_arr, r2 in owa.vc_arr, r3 in owa.vc_arr, r4 in owa.vc_arr, r5 in owa.vc_arr, r6 in owa.vc_arr )
as

 cursor c1(rid rowid) is select invoiceno,completed from strang.invoices where rowid = rid;

 c1rec		c1%ROWTYPE;

 sts		varchar2(100);
 dt1		date;

begin
 if not dapi.init( surl, 'STRANGP.ACCEPT_SHP' , null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'ACCEPT_SHP' );
    return;
 end if;

 if action = 'Display Invoice Details'
  then
   inv( surl, rid, scid, null, parm, access_id, null );
   return;
 end if;

 open c1(chartorowid( replace(rid,'~','+') ));
 fetch c1 into c1rec;
 close c1;
 if c1rec.completed = 'COMPLETE'
  then
   inv( surl, rid, scid, null, parm, access_id, 'No Modification Made' );
   return;
 end if;

 for j in r0.first..r0.last loop
  if r0(j) is null
  then
   if r6(j) = 'CARGO'
    then
     update strang.movements
      set
       invoiceno = c1rec.invoiceno, interface4_date = null
      where
       rowid = chartorowid(r1(j));
    elsif r6(j) = 'CONMOV'
     then
     update strang.movements
      set
       invoiceno = c1rec.invoiceno, interface4_date = null
      where
       rowid = chartorowid(r3(j));
    elsif r6(j) = 'AIRWAY'
     then
     update strang.movements
      set
       invoiceno = c1rec.invoiceno, interface4_date = null
      where
       rowid = chartorowid(r4(j));
   end if;
  else
   /*
   if r6(j) = 'CARGO'
    then
     update strang.movements
      set
       movement_no = r1(j),
       seal = r2(j)
      where
       rowid = chartorowid( r0(j) );
    elsif r6(j) = 'CONMOV'
     then
     update strang.movements
      set
       movement_no = r3(j)
      where
       rowid = chartorowid( r0(j) );
    elsif r6(j) = 'AIRWAY'
     then
     update strang.movements
      set
       movement_no = r4(j)
      where
       rowid = chartorowid( r0(j) );
   end if;
   */
   NULL; -- commented out at the request of Sallie
  end if;
 end loop;

 for j in r5.first..r5.last loop
  if r5(j) is not null
   then
     update strang.movements
      set
       invoiceno = null, interface4_date = null
      where
       rowid = chartorowid( r5(j) );
  end if;
 end loop;
 commit;

 update strang.invoices i
  set
   volume = (select sum(sumvolume) from strang.movements m where m.invoiceno = i.invoiceno),
   gross = (select sum(nvl(sumweight,0)+nvl(tare,0)) from strang.movements m where m.invoiceno = i.invoiceno),
   weight = (select sum(sumweight) from strang.movements m where m.invoiceno = i.invoiceno),
   revton = (select sum(revton) from strang.movements m where m.invoiceno = i.invoiceno),
   chargeweight = (select sum(chargeweight) from strang.movements m where m.invoiceno = i.invoiceno)
 where
  invoiceno = c1rec.invoiceno;

 if action = 'Update Invoice List'
  then
    inv2( surl, rid, scid, null, parm, access_id, 'Record Successfully Updated' );
   else
    inv( surl, rid, scid, null, parm, access_id, 'Record Successfully Updated' );
 end if;
exception when others then
 error_details( 'STRANGP', 'ACCEPT_INV2',null,null,errmsg=>sqlerrm,extdet=>'PARM:' || parm);
end accept_inv2;

procedure edit_mawb( surl in varchar2, rid in varchar2, scid in varchar2, parm in varchar2, access_id in varchar2 default null, mwb in varchar2 default null, msg in varchar2 default null )
as

 cursor c2( mwb varchar2 ) is
 select distinct h.mawb, h.hawb, h.value, dr.deliveryno, dr.itemno
 from strang.hawbs h, strang.detailrs dr
 where h.mawb like mwb || '%' and
 h.mawb = dr.movement_no and
 nvl(dr.camov_seal,'|') = '|' and
 h.hawb=dr.hawb_hawbno
 order by hawb;

 c2rec		c2%ROWTYPE;
 sts		varchar2(100);
 foundrec	boolean;
 ttl1		number;
 ttl2		number;

begin
 if not dapi.init( surl, 'STRANGP.EDIT_MAWB' , null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'EDIT_MAWB');
    return;
 end if;

 main_title( 'Assigning HAWB values',helpid=>'STR31');

 if msg is not null
  then
   header_msg( msg );
 end if;
 htp.p( '<CENTER>' );

 htp.formopen( 'strangp.accept_edit_mawb' );
 htp.formhidden( 'SURL', surl );
 htp.formhidden( 'SCID', scid );
 htp.formhidden( 'PARM', parm );
 htp.formhidden( 'ACCESS_ID', access_id );
   htp.formhidden( 'RID', replace(rid,'~','+') );
 htp.formhidden( 'P0', mwb );

 htp.tableopen( cattributes=>'class="str1_table"' );
  htp.tablerowopen;
   htp.tabledata( htf.bold( 'MAWB'), cattributes=>'class="str1_bg_right"');
   htp.tabledata( htf.formhidden( 'P1', mwb ) || htf.bold( mwb ), cattributes=>'class="str1_bg_left"');
  htp.tablerowclose;
 htp.tableclose;
 htp.nl;
 if mwb is null
  then
   htp.formhidden( 'P2', null );
   htp.formhidden( 'P3', null );
   htp.formsubmit( null, 'Search for MAWB' );
   htp.formclose;
   htp.nl;
   htp.htmlclose;
   return;
 end if;
 htp.formhidden( 'P4', null );

 htp.tableopen( cattributes=>'class="str1_table"' );
  htp.tablerowopen;
   htp.tabledata( htf.bold( 'Delivery No'), cattributes=>'class="str1_bg_center"');
   htp.tabledata( htf.bold( 'Item No'), cattributes=>'class="str1_bg_center"');
   htp.tabledata( htf.bold( 'HAWB No'), cattributes=>'class="str1_bg_center"');
   htp.tabledata( htf.bold( 'Value'), cattributes=>'class="str1_bg_center"');
   --htp.tabledata( htf.bold( Delete), cattributes=>'class="str1_bg_center"');
  htp.tablerowclose;
  foundrec := FALSE;
  for c2rec in c2( mwb ) loop
   foundrec := TRUE;
   htp.tablerowopen;
    htp.formhidden( 'P2', c2rec.hawb );
    htp.formhidden( 'P5', c2rec.hawb );
    htp.tabledata( c2rec.deliveryno, cattributes=>'class="str1_bg_left"');
    htp.tabledata( c2rec.itemno, cattributes=>'class="str1_bg_left"');
    htp.tabledata( c2rec.hawb, cattributes=>'class="str1_cell_center"');
--    htp.tabledata( htf.formtext( 'P3', 15, 1000, to_char(c2rec.value,G_MONEY_FORMAT)), cattributes=>'class="str1_cell_right"');
    htp.tabledata( htf.formtext( 'P3', 15, 1000, to_char(nvl(c2rec.value,strang.f_display_po_total(c2rec.deliveryno)),G_MONEY_FORMAT)), cattributes=>'class="str1_cell_right"');

    -- delete removed as requested by Strang
    htp.formhidden( 'P4', null );
    -- htp.tabledata( htf.formcheckbox( 'P4', c2rec.hawb ), cattributes=>'class="str1_cell_center"');
   htp.tablerowclose;
  end loop;
  /*
  for j in 1..5 loop
   htp.tablerowopen;
    htp.formhidden( 'P5', null );
    htp.tabledata( htf.formtext( 'P2', 20, 1000, null), cattributes=>'class="str1_cell_center"');
    htp.tabledata( htf.formtext( 'P3', 20, 1000, null), cattributes=>'class="str1_cell_center"');
    --htp.tabledata( '&nbsp;', cattributes=>'class="str1_cell_center"');
   htp.tablerowclose;
  end loop;
  */
  htp.tableclose;
  if not foundrec
   then
     htp.formhidden( 'P2', null );
     htp.formhidden( 'P3', null );
     htp.formhidden( 'P4', null );
     htp.formhidden( 'P5', null );
     htp.formclose;
     htp.htmlclose;
     htp.bold( '<a href="" onClick="self.close()">' || LNG.GLB_TXT_033 || '</a>'); htp.nl;
    return;
    htp.bold( 'No MAWB found.' );
    htp.nl;
    htp.formsubmit( null, 'Add new HAWB Values' );
    htp.formclose;
    htp.nl;
    htp.htmlclose;
   return;
  end if;
  htp.nl;
  htp.formsubmit( null, 'Modify HAWB Values' );
  htp.formclose;
  htp.nl;
  htp.bold( '<a href="" onClick="self.close()">' || LNG.GLB_TXT_033 || '</a>'); htp.nl;
  htp.htmlclose;
exception when others then
 error_details( 'STRANGP', 'EDIT_MAB',null,null,errmsg=>sqlerrm,extdet=>'PARM:' || parm);
end edit_mawb;

procedure accept_edit_mawb( surl in varchar2, scid in integer, parm in varchar2, access_id in varchar2, rid in varchar2, p0 in varchar2, p1 in varchar2, p2 in owa.vc_arr, p3 in owa.vc_arr, p4 in owa.vc_arr, p5 in owa.vc_arr )
as


 nmb		number(15,2);
 sts		varchar2(100);

begin
 if not dapi.init( surl, 'STRANGP.ACCEPT_EDIT_MAB' , null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'ACCEPT_EDIT_MAB');
    return;
 end if;

  if p0 is null
   then
    edit_mawb(surl, rid, scid, parm, access_id, p1 );
    return;
  end if;

  for j in p2.first..p2.last loop
   begin
    nmb := to_number(p3(j),G_MONEY_FORMAT);
   exception
    when others
     then
      begin
       nmb := to_number(p3(j));
      exception
       when others then nmb := NULL;
      end;
    end;
   if p2(j) is not null
    then
     if p5(j) is null
      then
       null;
       --insert into strang.hawbs(hawb,mawb,value) values (p2(j),nvl(p0,p1),nmb);
      else
       update strang.hawbs set value = nvl(nmb,value) where hawb = p2(j) and mawb = nvl(p0,p1);
     end if;
   end if;
  end loop;

  /*
  for j in p4.first..p4.last loop
   if p4(j) is not null
    then
     delete from strang.hawbs where hawb = p4(j) and mawb = nvl(p0,p1);
   end if;
  end loop;
  */

  commit;

  edit_mawb(surl, rid, scid, parm, access_id, p1, 'HAWB Values Successfully Assigned' );

exception when others then
 error_details( 'STRANGP', 'ACCEPT_EDIT_MAWB',null,null,errmsg=>sqlerrm,extdet=>'PARM:' || parm);
end accept_edit_mawb;

procedure edit_bol( surl in varchar2, rid in varchar2, rid2 in varchar2, scid in varchar2, parm in varchar2, access_id in varchar2 default null, shpid in varchar2 default null, msg in varchar2 default null )
as

 cursor c2( shpid integer) is select shipname,voy from strang.ships_airway where ship_id = shpid;

 cursor c3( shpid integer ) is
  select rowid,movement_no,seal,container_type,booking_ref, bol
  from strang.movements m
  where ship_id = shpid
  order by container_type, movement_no;

cursor c4(rid rowid) is
 select *
 from strang.movements
 where rowid = rid;


 c2rec		c2%ROWTYPE;
 c3rec		c3%ROWTYPE;
 c4rec		c4%ROWTYPE;

 sts		varchar2(100);
 foundrec	boolean;
 ttl1		number;
 ttl2		number;

begin
 if not dapi.init( surl, 'STRANGP.EDIT_BOL' , null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'EDIT_BOL');
    return;
 end if;

 main_title( 'Assigning BOLs to Containers',helpid=>'STR32');

 htp.p( '<CENTER>' );

 htp.formopen( 'strangp.accept_edit_bol' );
 htp.formhidden( 'SURL', surl );
 htp.formhidden( 'SCID', scid );
 htp.formhidden( 'PARM', parm );
 htp.formhidden( 'ACCESS_ID', access_id );
 htp.formhidden( 'RID', replace(rid,'~','+') );
 htp.formhidden( 'RID2', replace(rid2,'~','+') );
 htp.formhidden( 'P0', shpid );

 open c2(shpid);
 fetch c2 into c2rec;
 close c2;
 open c4(chartorowid(replace(rid2,'~','+')));
 fetch c4 into c4rec;
 close c4;

 htp.tableopen( cattributes=>'class="str1_table"' );
  htp.tablerowopen;
   htp.tabledata( htf.bold( 'Ship'), cattributes=>'class="str1_bg_right"');
   htp.tabledata( htf.bold( c2rec.shipname), cattributes=>'class="str1_bg_left"');
   htp.tabledata( htf.bold( c2rec.voy), cattributes=>'class="str1_bg_left"');
   htp.formhidden( 'P1', shpid );
   -- htp.tabledata( htf.anchor2( 'strangp.edit_bol?surl=' || surl || '&rid=' || translate(rid,'+ ','~+') || '&parm=' || parm || '&scid=' || scid || '&access_id=' || access_id || '&shpid=' || shpid,'List of Ships',ctarget=>'HAWB'), cattributes=>'class="str1_bg_left"');
  htp.tablerowclose;
 htp.tableclose;

 htp.nl;
 htp.tableopen( cattributes=>'class="str1_table"' );
  htp.tablerowopen;
   htp.tabledata( htf.bold( 'Container No'), cattributes=>'class="str1_bg_center"');
   htp.tabledata( htf.bold( 'Seal'), cattributes=>'class="str1_bg_center"');
   htp.tabledata( htf.bold( 'Cargo Type'), cattributes=>'class="str1_bg_center"');
   htp.tabledata( htf.bold( 'Booking Reference'), cattributes=>'class="str1_bg_center"');
   htp.tabledata( htf.bold( 'BOL'), cattributes=>'class="str1_bg_center"');
  htp.tablerowclose;
  foundrec := FALSE;
    for c3rec in c3( shpid ) loop
     foundrec := TRUE;
     htp.tablerowopen;
     htp.formhidden( 'P2', rowidtochar( c3rec.rowid ) );
      htp.tabledata( c3rec.movement_no, cattributes=>'class="str1_bg_left"');
      htp.tabledata( c3rec.seal, cattributes=>'class="str1_bg_left"');
      htp.tabledata( c3rec.container_type, cattributes=>'class="str1_bg_left"');
      htp.tabledata( htf.formtext( 'P3a', 20, 1000, c3rec.booking_ref), cattributes=>'class="str1_cell_center"');
      htp.tabledata( htf.formtext( 'P3', 20, 1000, c3rec.bol), cattributes=>'class="str1_cell_center"');
     htp.tablerowclose;
    end loop;
  htp.tableclose;
  if not foundrec
   then
    htp.formhidden( 'P2', null );
    htp.formhidden( 'P3a', null );
    htp.formhidden( 'P3', null );
    htp.nl;
    htp.bold( '<a href="" onClick="self.close()">' || LNG.GLB_TXT_033 || '</a>');
    htp.formclose;
    htp.p( '</CENTER>' );
    htp.htmlclose;
   return;
  end if;
  htp.nl;
  htp.formsubmit( 'ACTION', 'Modify BOL Assignment' );
  htp.formsubmit( 'ACTION', 'Repeat First Value for All' );
  htp.formclose;
  if c4rec.movement_no is null
   then
    htp.nl;
    htp.bold( '<a href="" onClick="self.close()">' || LNG.GLB_TXT_033 || '</a>'); htp.nl;
   else
    htp.nl;
    htp.anchor( 'javascript: parent.opener.location = ''' || 'strangp.menu?surl=' || surl || '&rnd=' || to_char(sysdate,'SSSSS') || '&msearch=' || replace(c4rec.movement_no,' ','+') || '&mtype=' || c4rec.movement_type || '&action=SEARCH' || '''; parent.close();', LNG.GLB_TXT_033);
  end if;

  if msg is not null
   then
    header_msg( msg );
  end if;
  htp.p( '</CENTER>' );
  htp.htmlclose;
exception when others then
 error_details( 'STRANGP', 'EDIT_BOL',null,null,errmsg=>sqlerrm,extdet=>'PARM:' || parm);
end edit_bol;

procedure accept_edit_bol( surl in varchar2, scid in integer, parm in varchar2, access_id in varchar2, rid in varchar2, rid2 in varchar2, p0 in varchar2, p1 in varchar2, action in varchar2, p2 in owa.vc_arr, p3a in owa.vc_arr, p3 in owa.vc_arr )
as


 sts		varchar2(100);

begin
 if not dapi.init( surl, 'STRANGP.ACCEPT_EDIT_BOL'  , null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'ACCEPT_EDIT_BOL' );
    return;
 end if;

  if p0 is null
   then
    edit_bol(surl, rid, rid2, scid, parm, access_id, p1 );
    return;
  end if;

  for j in p2.first..p2.last loop
     if p2(j) is not null
      then
       if action = 'Modify BOL Assignment'
        then
         update strang.movements set booking_ref = p3a(j), interface4_date = null where rowid = chartorowid( p2(j) );
         update strang.movements set bol = p3(j), interface4_date = null where rowid = chartorowid( p2(j) );
       elsif action = 'Repeat First Value for All'
        then
         if p3(j) is null
          then
           update strang.movements set booking_ref = p3a(1), interface4_date = null where rowid = chartorowid( p2(j) );
           update strang.movements set bol = p3(1), interface4_date = null where rowid = chartorowid( p2(j) );
          else
           update strang.movements set booking_ref = p3a(j), interface4_date = null where rowid = chartorowid( p2(j) );
           update strang.movements set bol = p3(j), interface4_date = null where rowid = chartorowid( p2(j) );
         end if;
       end if;
     end if;
  end loop;

  commit;

  edit_bol(surl, rid, rid2, scid, parm, access_id, p1, 'BOL Values Successfully Assigned' );

exception when others then
 error_details( 'STRANGP', 'ACCEPT_EDIT_BOL',null,null,errmsg=>sqlerrm,extdet=>'PARM:' || parm);
end accept_edit_bol;

procedure edit_ecn( surl in varchar2, rid in varchar2, rid2 in varchar2 default null, scid in varchar2, parm in varchar2, access_id in varchar2 default null, shpid in varchar2 default null, msg in varchar2 default null )
as

 cursor c2( shpid integer) is select shipname,voy from strang.ships_airway where ship_id = shpid;

 cursor c3( mv varchar2, sl varchar2 ) is
  select d.rowid,d.movement_no,d.camov_seal seal,deliveryno,ecn,itemno, handling_unit
  from strang.detailrs d
  where d.movement_no = mv and
        nvl(d.camov_seal,'x') = nvl(sl,'x')
  order by movement_no,camov_seal,deliveryno,itemno,ecn,handling_unit;
--  order by deliveryno; changed as per Sallie request

 cursor c4( rid rowid ) is select * from strang.movements where rowid = rid;

 c2rec		c2%ROWTYPE;
 c3rec		c3%ROWTYPE;
 c4rec		c4%ROWTYPE;
 sts		varchar2(100);
 foundrec	boolean;
 ttl1		number;
 ttl2		number;

begin
 if not dapi.init( surl, 'STRANGP.EDIT_ECN', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'EDIT_ECN' );
    return;
 end if;

 main_title( 'Assigning ECN / Handling Unit Values to Containers',helpid=>'STR33');

 htp.p( '<CENTER>' );

 htp.formopen( 'strangp.accept_edit_ecn' );
 htp.formhidden( 'SURL', surl );
 htp.formhidden( 'SCID', scid );
 htp.formhidden( 'PARM', parm );
 htp.formhidden( 'ACCESS_ID', access_id );
 htp.formhidden( 'RID', replace(rid,'~','+') );
 htp.formhidden( 'P0', shpid );
 htp.formhidden( 'RID2', replace(rid2,'~','+') );

 open c2(shpid);
 fetch c2 into c2rec;
 close c2;
 open c4(replace(rid,'~','+'));
 fetch c4 into c4rec;
 close c4;
 htp.tableopen( cattributes=>'class="str1_table"' );
  htp.tablerowopen;
   htp.tabledata( htf.bold( 'Ship'), cattributes=>'class="str1_bg_right"');
   htp.tabledata( htf.bold( c2rec.shipname), cattributes=>'class="str1_bg_left"');
   htp.tabledata( htf.bold( c2rec.voy), cattributes=>'class="str1_bg_left"');
   htp.formhidden( 'P1', shpid );
   -- htp.tabledata( htf.anchor2( 'strangp.edit_bol?surl=' || surl || '&rid=' || translate(rid,'+ ','~+') || '&parm=' || parm || '&scid=' || scid || '&access_id=' || access_id || '&shpid=' || shpid,'List of Ships',ctarget=>'HAWB'), cattributes=>'class="str1_bg_left"');
  htp.tablerowclose;
 htp.tableclose;

 htp.nl;
 htp.tableopen( cattributes=>'class="str1_table"' );
  htp.tablerowopen;
   if c4rec.movement_type = 'CARGO'
    then
     htp.tableheader( 'Container No', cattributes=>'class="str1_bg_center"');
   elsif c4rec.movement_type = 'CONMOV'
    then
     htp.tableheader(  'Connote', cattributes=>'class="str1_bg_center"');
   else
     htp.tableheader(  'HAWB', cattributes=>'class="str1_bg_center"');
   end if;
   if c4rec.movement_type = 'CARGO'
    then
     htp.tableheader(  'Seal', cattributes=>'class="str1_bg_center"');
   end if;
   htp.tableheader(  'Delivery No', cattributes=>'class="str1_bg_center"');
   htp.tableheader(  'Item #', cattributes=>'class="str1_bg_center"');
   htp.tableheader(  'ECN', cattributes=>'class="str1_bg_center"');
   htp.tableheader(  'Handling Unit', cattributes=>'class="str1_bg_center"');
  htp.tablerowclose;
  foundrec := FALSE;
    for c3rec in c3( c4rec.movement_no, c4rec.seal ) loop
     foundrec := TRUE;
     htp.tablerowopen;
     htp.formhidden( 'P2', rowidtochar( c3rec.rowid ) );
      htp.tabledata( c3rec.movement_no, cattributes=>'class="str1_bg_left"');
      if c4rec.movement_type = 'CARGO'
       then
        htp.tabledata( c3rec.seal, cattributes=>'class="str1_bg_left"');
      end if;
      htp.tabledata( c3rec.deliveryno, cattributes=>'class="str1_bg_left"');
      htp.tabledata( c3rec.itemno, cattributes=>'class="str1_bg_left"');
      htp.tabledata( htf.formtext( 'P3', 20, 1000, c3rec.ecn), cattributes=>'class="str1_cell_center"');
      htp.tabledata( htf.formtext( 'P3i', 20, 1000, c3rec.handling_unit), cattributes=>'class="str1_cell_center"');
     htp.tablerowclose;
    end loop;
  htp.tableclose;
  if not foundrec
   then
    htp.formhidden( 'P2', null );
    htp.formhidden( 'P3', null );
    htp.formhidden( 'P3i', null );
    htp.nl;
    htp.formsubmit( null, 'No Movements Found' );
    htp.formclose;
    htp.nl;
    htp.bold( '<a href="" onClick="self.close()">' || LNG.GLB_TXT_033 || '</a>'); htp.nl;
    htp.htmlclose;
   return;
  end if;
  htp.nl;
  htp.formsubmit( 'ACTION', 'Modify ECN / Handling Unit Assignment' );
  htp.formsubmit( 'ACTION', 'Repeat First Value for All' );
  htp.formclose;
  htp.nl;
  htp.bold( '<a href="" onClick="self.close()">' || LNG.GLB_TXT_033 || '</a>'); htp.nl;
 if msg is not null
  then
   header_msg( msg );
 end if;
  htp.p( '</CENTER>' );
  htp.htmlclose;
exception when others then
 error_details( 'STRANGP', 'EDIT_ECN',null,null,errmsg=>sqlerrm,extdet=>'PARM:' || parm);
end edit_ecn;

procedure accept_edit_ecn( surl in varchar2, scid in integer, parm in varchar2, access_id in varchar2, rid in varchar2, rid2 in varchar2, p0 in varchar2, p1 in varchar2, action in varchar2, p2 in owa.vc_arr, p3 in owa.vc_arr, p3i in owa.vc_arr )
as

 sts		varchar2(100);

begin
 if not dapi.init( surl, 'STRANGP.ACCEPT_EDIT_ECN', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'ACCEPT_EDIT_ECN' );
    return;
 end if;

  if p0 is null
   then
    edit_bol(surl, rid, rid2, scid, parm, access_id, p1 );
    return;
  end if;

  for j in p2.first..p2.last loop
     if p2(j) is not null
      then
       if action = 'Modify ECN / Handling Unit Assignment'
        then
         update strang.detailrs set ecn = p3(j) where rowid = chartorowid( p2(j) );
         update strang.detailrs set handling_unit = strang.f_sap_format(p3i(j),'HANDLING_UNIT') where rowid = chartorowid( p2(j) );
       elsif action = 'Repeat First Value for All'
        then
         if p3(j) is null
          then
           update strang.detailrs set ecn = p3(1) where rowid = chartorowid( p2(j) );
         update strang.detailrs set handling_unit = strang.f_sap_format(p3i(j),'HANDLING_UNIT') where rowid = chartorowid( p2(j) );
          else
           update strang.detailrs set ecn = p3(j) where rowid = chartorowid( p2(j) );
         update strang.detailrs set handling_unit = strang.f_sap_format(p3i(j),'HANDLING_UNIT') where rowid = chartorowid( p2(j) );
         end if;
       end if;
     end if;
  end loop;

  commit;

  edit_ecn(surl, rid, rid2, scid, parm, access_id, p1, 'ECN / Handling Unit Values Successfully Assigned' );

exception when others then
 error_details( 'STRANGP', 'ACCEPT_EDIT_ECN',null,null,errmsg=>sqlerrm,extdet=>'PARM:' || parm);
end accept_edit_ecn;

procedure edit_mawb_ecn( surl in varchar2, rid in varchar2, scid in varchar2, parm in varchar2, access_id in varchar2 default null, mwb in varchar2 default null, msg in varchar2 default null )
as

 cursor c2( mwb varchar2 ) is
  select rowid,hawb_hawbno,deliveryno,itemno,ecn,cl,handling_unit
  from strang.detailrs
  where hawb_hawbno in (select hawb from strang.hawbs where mawb like mwb || '%')
  order by hawb_hawbno;

 c2rec		c2%ROWTYPE;
 sts		varchar2(100);
 foundrec	boolean;
 ttl1		number;
 ttl2		number;

begin
 if not dapi.init( surl, 'STRANGP..EDIT_MAWB_ECN' , null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'.EDIT_MAWB_ECN'  );
    return;
 end if;

 main_title( 'Assigning Air Freight ECNs & Handling Units',helpid=>'STR34');

 if msg is not null
  then
   header_msg( msg );
 end if;
 htp.p( '<CENTER>' );

 htp.formopen( 'strangp.accept_edit_mawb_ecn' );
 htp.formhidden( 'SURL', surl );
 htp.formhidden( 'SCID', scid );
 htp.formhidden( 'PARM', parm );
 htp.formhidden( 'ACCESS_ID', access_id );
 htp.formhidden( 'RID', replace(rid,'~','+') );
 htp.formhidden( 'P0', mwb );

 htp.tableopen( cattributes=>'class="str1_table"' );
  htp.tablerowopen;
   htp.tabledata( htf.bold( 'MAWB'), cattributes=>'class="str1_bg_right"');
   --htp.tabledata( htf.formtext( 'P1', 20, 1000, mwb ), cattributes=>'class="str1_bg_left"');
   htp.tabledata( htf.bold( mwb ), cattributes=>'class="str1_bg_left"');
   -- Disabled as requested by SS
   --htp.tabledata( htf.anchor2( 'strangp.edit_mawb?surl=' || surl || '&rid=' || translate(rid,'+ ','~+') || '&parm=' || parm || '&scid=' || scid || '&access_id=' || access_id || '&mwb=' || mwb,'List of MAWBS',ctarget=>'HAWB'), cattributes=>'class="str1_bg_left"');
  htp.tablerowclose;
 htp.tableclose;

 if mwb is null
  then
   htp.formhidden( 'P1', mwb );
   htp.formhidden( 'P2', null );
   htp.formhidden( 'P3', null );
   -- htp.formsubmit( null, 'Search for MAWB' );
   htp.formclose;
   htp.nl;
   htp.htmlclose;
   return;
 end if;

 htp.formhidden( 'P1', mwb );
 htp.nl;
 htp.tableopen( cattributes=>'class="str1_table"' );
  htp.tablerowopen;
   htp.tableheader( 'HAWB', cattributes=>'class="str1_bg_center"');
   htp.tableheader( 'Delivery No', cattributes=>'class="str1_bg_center"');
   htp.tableheader( 'Item No', cattributes=>'class="str1_bg_center"');
   htp.tableheader( 'ECN', cattributes=>'class="str1_bg_center"');
   htp.tableheader( 'Handling Unit', cattributes=>'class="str1_bg_center"');
  htp.tablerowclose;
  foundrec := FALSE;
    for c2rec in c2( mwb ) loop
     foundrec := TRUE;
     htp.tablerowopen;
     htp.formhidden( 'P2', rowidtochar( c2rec.rowid ) );
      htp.tabledata( c2rec.hawb_hawbno, cattributes=>'class="str1_bg_left"');
      htp.tabledata( c2rec.deliveryno, cattributes=>'class="str1_bg_left"');
      htp.tabledata( c2rec.itemno, cattributes=>'class="str1_bg_left"');
    end loop;
      htp.tabledata( htf.formtext( 'P3', 20, 1000, c2rec.ecn), cattributes=>'class="str1_cell_center"');
      htp.tabledata( htf.formtext( 'P3i', 20, 1000, c2rec.handling_unit), cattributes=>'class="str1_cell_center"');
     htp.tablerowclose;
  htp.tableclose;
  if not foundrec
   then
    htp.formhidden( 'P2', null );
    htp.formhidden( 'P3', null );
    htp.nl;
    htp.bold( 'No MAWB found.' );
    htp.formclose;
    htp.nl;
    htp.htmlclose;
   return;
  end if;
  htp.nl;
  htp.formsubmit( 'ACTION', 'Modify ECN / Handling Unit Assignment' );
  htp.formsubmit( 'ACTION', 'Repeat First Value for All' );
  htp.formclose;
  htp.nl;
  htp.bold( '<a href="" onClick="self.close()">' || LNG.GLB_TXT_033 || '</a>'); htp.nl;
  htp.p( '</CENTER>' );
  htp.htmlclose;
exception when others then
 error_details( 'STRANGP', 'EDIT_MAWB_ECN',null,null,errmsg=>sqlerrm,extdet=>'PARM:' || parm);
end edit_mawb_ecn;

procedure accept_edit_mawb_ecn( surl in varchar2, scid in integer, parm in varchar2, access_id in varchar2, rid in varchar2, p0 in varchar2, p1 in varchar2, action in varchar2, p2 in owa.vc_arr, p3 in owa.vc_arr, p3i in owa.vc_arr )
as

 sts		varchar2(100);

begin
 if not dapi.init( surl, 'STRANGP.ACCEPT_EDIT_MAWB_ECN' , null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'ACCEPT_EDIT_MAWB_ECN' );
    return;
 end if;

  if p0 is null
   then
    edit_mawb_ecn(surl, rid, scid, parm, access_id, p1 );
    return;
  end if;

  for j in p2.first..p2.last loop
     if p2(j) is not null
      then
       if action = 'Modify ECN / Handling Unit Assignment'
        then
         update strang.detailrs set ecn = p3(j) where rowid = chartorowid( p2(j) );
         update strang.detailrs set handling_unit = strang.f_sap_format(p3i(j),'HANDLING_UNIT') where rowid = chartorowid( p2(j) );
       elsif action = 'Repeat First Value for All'
        then
         if p3(j) is null
          then
           update strang.detailrs set ecn = p3(1) where rowid = chartorowid( p2(j) );
           update strang.detailrs set handling_unit = strang.f_sap_format(p3i(j),'HANDLING_UNIT') where rowid = chartorowid( p2(j) );
          else
           update strang.detailrs set ecn = p3(j) where rowid = chartorowid( p2(j) );
           update strang.detailrs set handling_unit = strang.f_sap_format(p3i(j),'HANDLING_UNIT') where rowid = chartorowid( p2(j) );
         end if;
       end if;
     end if;
  end loop;

  commit;

  edit_mawb_ecn(surl, rid, scid, parm, access_id, p1, 'ECN / Handling Unit Values Successfully Assigned' );

exception when others then
 error_details( 'STRANGP', 'ACCEPT_EDIT_MAWB_ECN',null,null,errmsg=>sqlerrm,extdet=>'PARM:' || parm);
end accept_edit_mawb_ecn;

procedure assign_det( surl in varchar2, rid in varchar2, scid in varchar2, parm in varchar2, access_id in varchar2 default null, msg in varchar2 default null, fl in varchar2, lcl in varchar2 default 'F', ispopup in char default 'F' )
as

 cursor c2( rid rowid ) is
  select seal,shipname,voy,movement_no,movement_type,complete
  from strang.movements m,strang.ships_airway sa
  where m.rowid = rid and sa.ship_id = m.ship_id;

 cursor c3( mv varchar2, mtype varchar2, sl varchar2, cd varchar2 ) is
  select rowid, deliveryno, itemno, movement_no, handling_unit
  from strang.detailrs
  where (movement_no = mv and nvl(camov_seal,'x') = nvl(sl,'x')) or
        (movement_no is null and
         ((mtype = 'CARGO' and sa = 'S' and cl = 'C') or (mtype <> 'CARGO')) and
         ((mtype = 'CONMOV' and sa = 'S' and cl = 'L') or (mtype <> 'CONMOV')) and
         ((mtype = 'AIRWAY' and sa = 'A') or (mtype <> 'AIRWAY'))
        ) and
        ((cd is null) or (cd is not null and substr(to_char(deliveryno),1,1) = cd))
  order by deliveryno,itemno;

 cursor c4( mv varchar2, cd varchar2 ) is
  select rowid, deliveryno, itemno, movement_no, handling_unit
  from strang.detailrs
  where movement_no = mv and
        ((cd is null) or (cd is not null and substr(to_char(deliveryno),1,1) = cd))
  order by deliveryno;

 cursor c10(vste varchar2) is select description from strang.lov where lov_name = 'CONTROLS' and code = 'SEE_ALL_DELIVERIES' and cola = vste;
 cursor c11(vste varchar2) is select description from strang.lov where lov_name = 'CONTROLS' and code = 'DELIVERYNO' and cola = vste;


 c2rec		c2%ROWTYPE;
 c10rec 	c10%ROWTYPE;
 c11rec 	c11%ROWTYPE;

 sts		varchar2(100);
 foundrec	boolean;
 ttl1		number;
 ttl2		number;
 cd		varchar2(10);
 vaccess	varchar2(20);
 vste		varchar2(10);

begin
 if not dapi.init( surl, 'STRANGP.ASSIGN_DET', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'ASSIGN_DET'  );
    return;
 end if;

 vste := customer_state(dapi.GLOBAL_ACCOUNT.acctid);
 vaccess := data_access( 'ASSIGN' );

 if vaccess = 'NONE' then htp.bold( 'Access Denied' ); htp.htmlclose; return; end if;
 if ispopup = 'T'
  then
   main_title( 'Assigning Movement to Delivery',helpid=>'STR35', dispmenu=>FALSE);
  else
   main_title( 'Assigning Movement to Delivery',helpid=>'STR35');
 end if;

 htp.p( '<CENTER>' );

 if vaccess = 'EDIT'
  then
   htp.formopen( 'strangp.accept_assign_det' );
   htp.formhidden( 'SURL', surl );
   htp.formhidden( 'SCID', scid );
   htp.formhidden( 'PARM', parm );
   htp.formhidden( 'ACCESS_ID', access_id );
   htp.formhidden( 'RID', replace(rid,'~','+') );
   htp.formhidden( 'P1', null );
   htp.formhidden( 'P2', null );
   htp.formhidden( 'ISPOPUP', ispopup );
   if fl in ('X','Y')
    then
     htp.formhidden( 'FL', 'T' );
    else
     if fl = 'Y1'
      then
       htp.formhidden( 'FL', 'F' );
      else
       htp.formhidden( 'FL', fl );
     end if;
   end if;
 end if;

 open c2( chartorowid( replace(rid,'~','+') ));
 fetch c2 into c2rec;
 close c2;
 open c10(vste);
 fetch c10 into c10rec;
 close c10;
 open c11(vste);
 fetch c11 into c11rec;
 close c11;
 if c10rec.description = 'YES' and dapi.GLOBAL_ACCOUNT.username <> 'DAWN' and lcl = 'F'
  then
   cd := NULL;
  else
   cd := substr(c11rec.description,1,1);
 end if;

 htp.tableopen( cattributes=>'class="str1_table"' );
  htp.tablerowopen;
   if c2rec.movement_type = 'CONMOV'
    then
     htp.tabledata( htf.bold( 'Consignment Note'), cattributes=>'class="str1_bg_right"');
   elsif c2rec.movement_type = 'CARGO'
    then
     htp.tabledata( htf.bold( 'Container Number'), cattributes=>'class="str1_bg_right"');
   else
     htp.tabledata( htf.bold( 'Airway'), cattributes=>'class="str1_bg_right"');
   end if;
   htp.tabledata( htf.bold( c2rec.movement_no ), cattributes=>'class="str1_bg_left"');
  htp.tablerowclose;
  if c2rec.movement_type = 'CARGO'
   then
    htp.tablerowopen;
     htp.tabledata( htf.bold( 'Seal'), cattributes=>'class="str1_bg_right"');
     htp.tabledata( htf.bold( c2rec.seal ), cattributes=>'class="str1_bg_left"');
    htp.tablerowclose;
  end if;
  if c2rec.movement_type = 'AIRWAY'
   then
    htp.tablerowopen;
     htp.tabledata( htf.bold( 'Carrier'), cattributes=>'class="str1_bg_right"');
     htp.tabledata( htf.bold( c2rec.shipname ), cattributes=>'class="str1_bg_left"');
    htp.tablerowclose;
    htp.tablerowopen;
     htp.tabledata( htf.bold( 'Flight'), cattributes=>'class="str1_bg_right"');
     htp.tabledata( htf.bold( c2rec.voy ), cattributes=>'class="str1_bg_left"');
    htp.tablerowclose;
   else
    htp.tablerowopen;
     htp.tabledata( htf.bold( 'Ship'), cattributes=>'class="str1_bg_right"');
     htp.tabledata( htf.bold( c2rec.shipname ), cattributes=>'class="str1_bg_left"');
    htp.tablerowclose;
    htp.tablerowopen;
     htp.tabledata( htf.bold( 'Voyage'), cattributes=>'class="str1_bg_right"');
     htp.tabledata( htf.bold( c2rec.voy ), cattributes=>'class="str1_bg_left"');
    htp.tablerowclose;
  end if;

 htp.tableclose;
 htp.nl;
 htp.tableopen( cattributes=>'class="str1_table"' );
  htp.tablerowopen;
     htp.tabledata( htf.bold( 'Delivery No'), cattributes=>'class="str1_bg_center"');
     htp.tabledata( htf.bold( 'Item No'), cattributes=>'class="str1_bg_center"');
     if c2rec.complete = 'F'
      then
       htp.tabledata( htf.bold( 'Assign'), cattributes=>'class="str1_bg_center"');
     end if;
     htp.tabledata( htf.bold( 'Handling_Unit'), cattributes=>'class="str1_bg_center"');
  htp.tablerowclose;
  if fl in ('T','X','Y')
   then
    for c3rec in c3( c2rec.movement_no, c2rec.movement_type, c2rec.seal, cd ) loop
     if (c2rec.complete = 'F') or (c2rec.complete <> 'F' and c3rec.movement_no is not null)
     then
     htp.tablerowopen;
       htp.tabledata( htf.bold( c3rec.deliveryno), cattributes=>'class="str1_cell_right"');
       htp.tabledata( htf.bold( c3rec.itemno), cattributes=>'class="str1_cell_right"');
       if c2rec.complete = 'F'
        then
         if c3rec.movement_no is null
          then
           if fl = 'X'
            then
             if vaccess = 'EDIT'
              then
               htp.tabledata( htf.formcheckbox( 'P1', c3rec.rowid, 'CHECKED' ), cattributes=>'class="str1_cell_center"');
              else
               htp.tabledata( htf.bold( 'X' ), cattributes=>'class="str1_cell_center"');
             end if;
            else
             if vaccess = 'EDIT'
              then
               htp.tabledata( htf.formcheckbox( 'P1', c3rec.rowid ), cattributes=>'class="str1_cell_center"');
              else
               htp.tabledata( '&nbsp;', cattributes=>'class="str1_cell_center"');
             end if;
            end if;
          else
           if fl = 'Y'
            then
             if vaccess = 'EDIT'
              then
               htp.tabledata( htf.formcheckbox( 'P1', c3rec.rowid ), cattributes=>'class="str1_cell_center"');
              else
               htp.tabledata( '&nbsp;', cattributes=>'class="str1_cell_center"');
             end if;
            else
             if vaccess = 'EDIT'
              then
               htp.tabledata( htf.formcheckbox( 'P1', c3rec.rowid, 'CHECKED' ), cattributes=>'class="str1_cell_center"');
              else
               htp.tabledata( htf.bold( 'X' ), cattributes=>'class="str1_cell_center"');
             end if;
           end if;
           htp.formhidden( 'P2', c3rec.rowid );
        end if;
       end if;
     htp.tabledata( htf.bold( c3rec.handling_unit), cattributes=>'class="str1_cell_right"');
     htp.tablerowclose;
     end if;
    end loop;
  else
    for c4rec in c4( c2rec.movement_no, cd ) loop
     htp.tablerowopen;
       htp.tabledata( htf.bold( c4rec.deliveryno), cattributes=>'class="str1_cell_right"');
       htp.tabledata( htf.bold( c4rec.itemno), cattributes=>'class="str1_cell_right"');
       if c2rec.complete = 'F'
        then
         if c4rec.movement_no is null
          then
           if fl = 'X'
            then
             if vaccess = 'EDIT'
              then
               htp.tabledata( htf.formcheckbox( 'P1', c4rec.rowid, 'CHECKED' ), cattributes=>'class="str1_cell_center"');
              else
               htp.tabledata( htf.bold( 'X' ), cattributes=>'class="str1_cell_center"');
             end if;
            else
             if vaccess = 'EDIT'
              then
               htp.tabledata( htf.formcheckbox( 'P1', c4rec.rowid ), cattributes=>'class="str1_cell_center"');
              else
               htp.tabledata( '&nbsp;', cattributes=>'class="str1_cell_center"');
             end if;
           end if;
          else
           if fl in ('Y','Y1')
            then
             if vaccess = 'EDIT'
              then
               htp.tabledata( htf.formcheckbox( 'P1', c4rec.rowid ), cattributes=>'class="str1_cell_center"');
              else
               htp.tabledata( '&nbsp;', cattributes=>'class="str1_cell_center"');
             end if;
            else
             if vaccess = 'EDIT'
              then
               htp.tabledata( htf.formcheckbox( 'P1', c4rec.rowid, 'CHECKED' ), cattributes=>'class="str1_cell_center"');
              else
               htp.tabledata( htf.bold( 'X' ), cattributes=>'class="str1_cell_center"');
             end if;
           end if;
           if vaccess = 'EDIT' then htp.formhidden( 'P2', c4rec.rowid ); end if;
         end if;
       end if;
     htp.tabledata( htf.bold( c4rec.handling_unit), cattributes=>'class="str1_cell_right"');
     htp.tablerowclose;
    end loop;
 end if;
 htp.tableclose;
 htp.nl;
 if vaccess = 'EDIT'
  then
   if fl in ('T','X','Y') and c2rec.complete = 'F'
    then
     htp.formsubmit( 'ACTION', 'Update' );
     htp.formsubmit( 'ACTION', 'Check All' );
     htp.formsubmit( 'ACTION', 'Uncheck All' );
     if c10rec.description = 'YES' and dapi.GLOBAL_ACCOUNT.username <> 'DAWN' and lcl = 'F'
      then
       htp.formsubmit( 'ACTION', 'Local Cargo' );
     elsif c10rec.description = 'YES' and dapi.GLOBAL_ACCOUNT.username <> 'DAWN' and lcl = 'T'
      then
       htp.formsubmit( 'ACTION', 'All Cargo' );
     end if;
    --  htp.formsubmit( 'ACTION', Deassign );
  end if;
   htp.formclose;
 end if;
 htp.nl;
 htp.nl;
 if ispopup = 'T' then htp.bold( '<a href="" onClick="self.close()">' || LNG.GLB_TXT_033 || '</a>'); htp.nl; end if;
 if msg is not null
  then
   header_msg( msg );
 end if;
 htp.p( '</CENTER>' );
 htp.htmlclose;
exception when others then
 error_details( 'STRANGP', 'ASSIGN_DET',null,null,errmsg=>sqlerrm,extdet=>'PARM:' || parm);
end assign_det;

procedure accept_assign_det( surl in varchar2, scid in integer, parm in varchar2, access_id in varchar2, rid in varchar2, action in varchar2, fl in varchar2, p1 in owa.vc_arr, p2 in owa.vc_arr, ispopup in char default 'F' )
as

 cursor c2( rid rowid ) is select movement_no, seal, container_type, movement_type from strang.movements m where m.rowid = rid;

 c2rec		c2%ROWTYPE;
 newrid		rowid;
 sts		varchar2(100);

 function isdel( p1 in owa.vc_arr, p2 in varchar2 ) return boolean
 as
 begin
  for j in p1.first..p1.last loop
   if p1(j) = p2
    then
     return( FALSE );
   end if;
  end loop;
  return( TRUE );
 end;

begin
 if not dapi.init( surl, 'STRANGP.ACCEPT_ASSIGN_DET', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'ACCEPT_ASSIGN_DET' );
    return;
 end if;

 if action = 'Local Cargo' then assign_det( surl, rid, scid, parm, access_id, 'Local Cargo', fl,'T',ispopup=>ispopup ); return; end if;
 if action = 'All Cargo' then assign_det( surl, rid, scid, parm, access_id, 'All Cargo', fl,'F',ispopup=>ispopup ); return; end if;
 if action = 'Check All' then assign_det( surl, rid, scid, parm, access_id, 'All Boxes Checked', 'X',ispopup=>ispopup ); return; end if;
 if fl = 'F'
  then
   if action = 'Uncheck All' then assign_det( surl, rid, scid, parm, access_id, 'All Boxes Unchecked', 'Y1',ispopup=>ispopup ); return; end if;
  else
   if action = 'Uncheck All' then assign_det( surl, rid, scid, parm, access_id, 'All Boxes Unchecked', 'Y',ispopup=>ispopup ); return; end if;
 end if;

 open c2( chartorowid( replace(rid,'~','+') ) );
 fetch c2 into c2rec;
 close c2;

 for j in p2.first..p2.last loop
  -- Check to see if the appropriate record can have its values set to null.
  -- If it is found in P1 it means it has been checked and is not to be deleted
  if isdel(p1,p2(j))
   then
    update strang.detailrs set movement_no = null, camov_seal = null, hawb_hawbno = null where rowid = chartorowid( p2(j) );
  end if;
 end loop;

 for j in p1.first..p1.last loop
  update strang.detailrs set movement_no = c2rec.movement_no, camov_seal = c2rec.seal where rowid = chartorowid( p1(j) );
 end loop;

 recalc_weight( c2rec.movement_no, c2rec.container_type, c2rec.seal, c2rec.movement_type );
 delete from strang.hawbs
  where
   mawb = c2rec.movement_no and
   hawb not in
    (select hawb_hawbno from strang.detailrs where movement_no = c2rec.movement_no);

 commit;

 assign_det( surl, rid, scid, parm, access_id, 'Assignment Successfully Completed', fl,ispopup=>ispopup );

exception when others then
 error_details( 'STRANGP', 'ACCEPT_ASSIGN_DET',null,null,errmsg=>sqlerrm,extdet=>'PARM:' || parm);
end accept_assign_det;

function new_log_no( p1 in varchar2, vste in varchar2 )
 return varchar2
as

 cursor c1(vste varchar2) is select substr(description,1,1) code from strang.lov where lov_name = 'CONTROLS' and code = 'REGION' and cola = vste;
 cursor c2( str varchar2, sto varchar2 ) is select max(to_number(substr(logno,1,3))) nmb from strang.detailrs where substr(logno,4) = str;

 c1rec 	c1%ROWTYPE;
 c2rec 	c2%ROWTYPE;
 tmp	varchar2(20);

begin
 open c1(vste);
 fetch c1 into c1rec;
 close c1;
 tmp := '-' || c1rec.code || p1 || '/' || to_char(sysdate,'YY');
 open c2(tmp,currsite);
 fetch c2 into c2rec;
 if c2%FOUND
  then
   close c2;
   tmp := lpad(to_char(nvl(c2rec.nmb,0) + 1),3,'0') || tmp;
  else
   close c2;
   tmp := '001' || tmp;
 end if;
 update strang.lov
  set description = to_char(sysdate,LNG_MASK)
  where code = 'LOGNO' || p1 || '_DATE' and
        lov_name = 'CONTROLS' and
        cola = vste;
 update strang.lov
  set description = tmp
  where code = 'LOGNO' || p1 and
        lov_name = 'CONTROLS' and
        cola = vste;
 return( tmp );
end new_log_no;

procedure recalc_weight( mvid varchar2, ctrtype varchar2 default null, sl in varchar2 default null, mtype in varchar2 default null )
as

 cursor c1(mvid varchar2) is select container_type,movement_type from strang.movements where movement_no = mvid;
 cursor c1a(mvid varchar2, sl varchar2) is select container_type,movement_type from strang.movements where movement_no = mvid and seal = sl;
 cursor c2(ctr varchar2) is select colb from strang.lov where lov_name = 'CTRTYPE' and code = ctr;

 c1rec	c1%ROWTYPE;
 c2rec	c2%ROWTYPE;

begin
 if mvid is null then return; end if;
 if ctrtype is null
  then
   if sl is not null
    then
     open c1a(mvid,sl);
     fetch c1a into c1rec;
     close c1a;
    else
     open c1(mvid);
     fetch c1 into c1rec;
     close c1;
   end if;
  else
   c1rec.container_type := ctrtype;
 end if;

 update strang.movements
  set
   sumweight = (select sum(nvl(partweight,0)) from strang.detailrs where movement_no = mvid and nvl(camov_seal,'x') = nvl(sl,'x')),
   sumvolume = (select sum(nvl(partvolume,0)) from strang.detailrs where movement_no = mvid and nvl(camov_seal,'x') = nvl(sl,'x')), interface4_date = null
 where
  movement_no = mvid and nvl(seal,'x') = nvl(sl,'x');

 open c2( c1rec.container_type );
 fetch c2 into c2rec;
 close c2;
 if c2rec.colb is not null
  then
   update strang.movements
    set
     revton = (select strang.revenue_tonne(sum(nvl(partweight,0)),sum(nvl(partvolume,0))) from strang.detailrs where movement_no = mvid and nvl(camov_seal,'x') = nvl(sl,'x')), interface4_date = null
    where
      movement_no = mvid and nvl(seal,'x') = nvl(sl,'x');
  else
   update strang.movements
    set
     revton = (select sum(strang.revenue_tonne(nvl(partweight,0),nvl(partvolume,0))) from strang.detailrs where movement_no = mvid and nvl(camov_seal,'x') = nvl(sl,'x')), interface4_date = null
    where
      movement_no = mvid and nvl(seal,'x') = nvl(sl,'x');
 end if;

 if mtype = 'AIRWAY'
  then
   update strang.movements
    set
     chargeweight = (select sum(strang.chargeable_weight(nvl(partweight,0),nvl(partvolume,0))) from strang.detailrs where movement_no = mvid and nvl(camov_seal,'x') = nvl(sl,'x')), interface4_date = null
    where
      movement_no = mvid and nvl(seal,'x') = nvl(sl,'x');
 end if;

 update strang.invoices i
  set
   volume = (select sum(sumvolume) from strang.movements m where m.invoiceno = i.invoiceno),
   gross = (select sum(nvl(sumweight,0)+nvl(tare,0)) from strang.movements m where m.invoiceno = i.invoiceno),
   weight = (select sum(sumweight) from strang.movements m where m.invoiceno = i.invoiceno),
   revton = (select sum(revton) from strang.movements m where m.invoiceno = i.invoiceno),
   chargeweight = (select sum(chargeweight) from strang.movements m where m.invoiceno = i.invoiceno)
 where
  invoiceno in (select invoiceno from strang.movements where movement_no = mvid);

 commit;

end recalc_weight;

procedure cascade_movement( surl in varchar2, rid in varchar2, scid in varchar2, parm in varchar2, access_id in varchar2 default null, oldid in varchar2, oldseal in varchar2, mtype in varchar2, msg in varchar2 default null )
as


 sts		varchar2(100);

begin
 if not dapi.init( surl, 'STRANGP.CASCADE_MOVEMENT', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'CASCADE_MOVEMENT' );
    return;
 end if;

 main_title( 'Cascade Update Movement No',helpid=>'STR36');

 if msg is not null
  then
   header_msg( msg );
 end if;
 htp.p( '<CENTER>' );

 htp.formopen( 'strangp.accept_cascade_movement' );
 htp.formhidden( 'SURL', surl );
 htp.formhidden( 'SCID', scid );
 htp.formhidden( 'PARM', parm );
 htp.formhidden( 'ACCESS_ID', access_id );
   htp.formhidden( 'RID', replace(rid,'~','+') );
 htp.formhidden( 'MTYPE', mtype );

 htp.tableopen( cattributes=>'class="str1_table"' );
  htp.tablerowopen;
     htp.tabledata( htf.bold( 'Movement Type'), cattributes=>'class="str1_bg_right"');
     htp.tabledata( htf.bold( mtype ), cattributes=>'class="str1_cell_right"');
  htp.tablerowclose;
  htp.tablerowopen;
     htp.tabledata( htf.bold( 'Old Movement ID'), cattributes=>'class="str1_bg_right"');
     htp.tabledata( htf.formtext('OLD_MOVEMENT',20,30,oldid), cattributes=>'class="str1_cell_right"');
  htp.tablerowclose;
  if mtype = 'CARGO'
   then
    htp.tablerowopen;
     htp.tabledata( htf.bold( 'Old SEAL'), cattributes=>'class="str1_bg_right"');
     htp.tabledata( htf.formtext('OLD_SEAL',20,30,oldseal), cattributes=>'class="str1_cell_right"');
    htp.tablerowclose;
   else
    htp.formhidden( 'OLD_SEAL', null );
  end if;
  htp.tablerowopen;
     htp.tabledata( htf.bold( 'New Movement ID'), cattributes=>'class="str1_bg_right"');
     htp.tabledata( htf.formtext('NEW_MOVEMENT',20,30), cattributes=>'class="str1_cell_right"');
  htp.tablerowclose;
  if mtype = 'CARGO'
   then
    htp.tablerowopen;
     htp.tabledata( htf.bold( 'New SEAL'), cattributes=>'class="str1_bg_right"');
     htp.tabledata( htf.formtext('NEW_SEAL',20,30), cattributes=>'class="str1_cell_right"');
    htp.tablerowclose;
   else
    htp.formhidden( 'NEW_SEAL', null );
  end if;
 htp.tableclose;
 htp.nl;
 htp.tableopen( cattributes=>'class="str1_table3"' );
 htp.tablerowopen;
 htp.tabledata( htf.formsubmit( null, 'Perform Cascade Update' ));
 htp.formclose;
 htp.formopen( 'strangp.movement' );
 htp.formhidden( 'SURL', surl );
   htp.formhidden( 'RID', replace(rid,'~','+') );
 htp.formhidden( 'SCID', scid );
 htp.formhidden( 'PARM', parm );
 htp.formhidden( 'CALL_NAME', null );
 htp.formhidden( 'ACCESS_ID', access_id );
 htp.tabledata( htf.formsubmit( null, 'Cancel' ));
 htp.formclose;
 htp.p( '</CENTER>' );
 htp.htmlclose;
exception when others then
 error_details( 'STRANGP', 'CASCADE_MOVEMENT',null,null,errmsg=>sqlerrm,extdet=>'PARM:' || parm);
end cascade_movement;

procedure accept_cascade_movement( surl in varchar2, rid in varchar2, scid in varchar2, parm in varchar2, access_id in varchar2, mtype in varchar2, old_movement in varchar2, old_seal in varchar2 default null, new_movement in varchar2, new_seal in varchar2 default null)
as


 sts		varchar2(100);

begin
   REDISPLAY_LOGIN_PAGE( sts, TRUE );
 if not dapi.init( surl, 'STRANGP.ACCEPT_CASCADE_MOVEMENT', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'ACCEPT_CASCADE_MOVEMENT' );
    return;
 end if;

 if old_movement is null then cascade_movement( surl, rid, scid, parm, access_id, old_movement, old_seal, mtype, 'Old Movement No must be entered' ); return; end if;
 if new_movement is null then cascade_movement( surl, rid, scid, parm, access_id, old_movement, old_seal, mtype, 'New Movement No must be entered' ); return; end if;

 if old_seal is null
  then
   -- If we cascade update HAWBS, just do a safety check and make sure it is an AIR type
   update strang.hawbs
    set
     mawb = new_movement
    where
     mawb = old_movement and
     exists (select 'x' from strang.movements where movement_type = 'AIRWAY' and movement_no = old_movement);
   update strang.detailrs
    set
     movement_no = new_movement
    where
     movement_no = old_movement;
   update strang.movements
    set
     movement_no = new_movement, interface4_date = null
    where
     movement_no = old_movement;

  else

   update strang.detailrs
    set
     movement_no = new_movement,
     camov_seal = new_seal
    where
     movement_no = old_movement and
     camov_seal = old_seal;
   update strang.movements
    set
     movement_no = new_movement,
     seal = new_seal, interface4_date = null
    where
     movement_no = old_movement and
     seal = old_seal;
 end if;

 recalc_weight( new_movement, new_seal );
 menu( surl, null, mtype, new_movement, 'SEARCH' );
exception
 when
  others
   then
    main_title( 'Error on Update',helpid=>'STR37');
    htp.nl;
    htp.nl;
    htp.bold( 'Error Found: ' || sqlerrm );
    htp.nl;
    htp.nl;
    htp.bold( 'Likely cause: This Movement No already exists' );
    htp.nl;
    htp.nl;
    htp.italic( 'Hit the Back Button and try a different number' );
    htp.nl;
    htp.htmlclose;
    return;
end accept_cascade_movement;

function data_access( typ in varchar2 )
 return varchar2
as

 seclevel	varchar2(100);

begin
 -- RECEIVAL, DETAILRS, MOVEMENT, SHP, INVOICING, POS, ASSIGN, DUTY, CODES
 seclevel := security_role( dapi.GLOBAL_ACCOUNT.acctid );
 if seclevel = 'LEVEL 7' then return( 'EDIT' ); end if;

 -- Screens
 if typ in ( 'MOVEMENT', 'ASSIGN' )
  then
   if seclevel in ( 'LEVEL 6','LEVEL 8' ) then return( 'READ' ); elsif seclevel in ('LEVEL 2','LEVEL 3','LEVEL 4','LEVEL 5' ) then return( 'EDIT' ); else return( 'NONE' ); end if;
 elsif typ in ( 'SHP')
  then
   if seclevel in ( 'LEVEL 1','LEVEL 6' ) then return( 'READ' ); elsif seclevel in ('LEVEL 2','LEVEL 3','LEVEL 4','LEVEL 5','LEVEL 8' ) then return( 'EDIT' ); else return( 'NONE' ); end if;
-- xxxSouthbound Start
 elsif typ in ( 'SHP_SB')
  then
   if seclevel in ( 'LEVEL 1','LEVEL 6' ) then return( 'READ' ); elsif seclevel in ('LEVEL 2','LEVEL 3','LEVEL 4','LEVEL 5','LEVEL 8' ) then return( 'EDIT' ); else return( 'NONE' ); end if;
-- xxxSouthbound End
 elsif typ in ( 'ENTRY_MAINTAIN')
  then
   if seclevel in ('LEVEL 5','LEVEL 8' ) then return( 'EDIT' ); else return( 'NONE' ); end if;
 elsif typ in ( 'CONTAINER_MAINTAIN')
  then
   if seclevel in ( 'LEVEL 1','LEVEL 6' ) then return( 'READ' ); elsif seclevel in ('LEVEL 2','LEVEL 3','LEVEL 4','LEVEL 5','LEVEL 8' ) then return( 'EDIT' ); else return( 'NONE' ); end if;
 elsif typ in ( 'DELIVERY_MAINTAIN')
  then
   if seclevel in ('LEVEL 5','LEVEL 8' ) then return( 'EDIT' ); else return( 'NONE' ); end if;
 elsif typ in ( 'RECEIVAL' )
  then
   if seclevel in ( 'LEVEL 1', 'LEVEL 6') then return( 'READ' ); elsif seclevel in ('LEVEL 2','LEVEL 3','LEVEL 4','LEVEL 5','LEVEL 8' ) then return( 'EDIT' ); else return( 'NONE' ); end if;
 elsif typ in ( 'POS', 'DETAILRS' )
  then
   if seclevel in (  'LEVEL 1','LEVEL 6') then return( 'READ' ); elsif seclevel in ('LEVEL 2','LEVEL 3','LEVEL 4','LEVEL 5','LEVEL 8' ) then return( 'EDIT' ); else return( 'NONE' ); end if;
 elsif typ = 'SHP2'
  then
   if seclevel in ('LEVEL 5','LEVEL 8') then return( 'EDIT' ); else return( 'NONE' ); end if;
 elsif typ = 'DELLOV'
  then
   return( 'NONE' );
 elsif typ = 'HOTSYNC'
  then
   if seclevel in ('LEVEL 3','LEVEL 4','LEVEL 5') then return( 'EDIT' ); else return( 'NONE' ); end if;
 elsif typ = 'HOTSYNC_SUPER'
  then
   return( 'NONE' );
 elsif typ in ( 'INVOICING','CHARGES', 'INVCONTROLS')
  then
   if seclevel in ('LEVEL 3','LEVEL 4', 'LEVEL 5','LEVEL 6' ) then return( 'EDIT' ); else return( 'NONE' ); end if;

 -- Control Codes
 elsif typ in ( 'CONTROLS','CONTRACTS','GSTCODES' )
  then
   if seclevel in ('LEVEL 3', 'LEVEL 4', 'LEVEL 5', 'LEVEL 6' ) then return( 'READ' ); else return( 'NONE' ); end if;
 elsif typ in ('TARIFF','INVENT')
  then
   if seclevel in (  'LEVEL 1','LEVEL 6' ) then return( 'READ' ); elsif seclevel in ('LEVEL 3','LEVEL 4','LEVEL 5', 'LEVEL 8' ) then return( 'EDIT' ); else return( 'NONE' ); end if;
 elsif typ in ('SAD')
  then
   if seclevel in (  'LEVEL 9' ) then return( 'EDIT' ); else return( 'NONE' ); end if;
 elsif typ = 'DUTY'
  then
   if seclevel in (  'LEVEL 1','LEVEL 6' ) then return( 'READ' ); elsif seclevel in ('LEVEL 5','LEVEL 8' ) then return( 'EDIT' ); else return( 'NONE' ); end if;
 elsif typ in ( 'UNRATTAB','CURRENCY', 'COUNTRIES', 'CUSTOMERS' , 'CTRTYPE','LOCATIONS','PACKTYPES','UNITS','DEBTOR_BRANCH','DEBTOR_CODE','JOB_BRANCH','PROFIT_CENTRE','COST_CENTRE','WAREHOUSES')
  then
   if seclevel in ( 'LEVEL 6','LEVEL 8' ) then return( 'READ' ); elsif seclevel in ( 'LEVEL 2', 'LEVEL 3','LEVEL 4', 'LEVEL 5') then return( 'EDIT' ); else return( 'NONE' ); end if;
 elsif typ = 'MANENTRY'
  then
   if seclevel in (  'LEVEL 1','LEVEL 6' ) then return( 'READ' ); elsif seclevel in ('LEVEL 5','LEVEL 8' ) then return( 'EDIT' ); else return( 'NONE' ); end if;
 elsif typ = 'CONTAINERS'
  then
   if seclevel in ( 'LEVEL 1','LEVEL 8' ) then return( 'READ' ); elsif seclevel in ('LEVEL 6' ) then return( 'EDIT' ); else return( 'NONE' ); end if;
 -- Reports
 elsif typ = 'REPORT A'
  then
   if seclevel in ( 'LEVEL 1','LEVEL 2','LEVEL 3','LEVEL 4','LEVEL 5','LEVEL 8' ) then return( 'EDIT' ); else return( 'NONE' ); end if;
 elsif typ = 'REPORT B'
  then
   if seclevel in ( 'LEVEL 2','LEVEL 3','LEVEL 8' ) then return( 'EDIT' ); elsif seclevel in ('LEVEL 1','LEVEL 4','LEVEL 5' ) then return( 'READ' ); else return( 'NONE' ); end if;
 elsif typ = 'REPORT C'
  then
   if seclevel in ( 'LEVEL 1' ) then return( 'EDIT' ); else return( 'NONE' ); end if;
 elsif typ = 'REPORT D'
  then
   if seclevel in ( 'LEVEL 3','LEVEL 4' ) then return( 'EDIT' ); elsif seclevel in ('LEVEL 1','LEVEL 2','LEVEL 5','LEVEL 8' ) then return( 'READ' ); else return( 'NONE' ); end if;
 elsif typ = 'REPORT E'
  then
   if seclevel in ( 'LEVEL 3','LEVEL 4' ) then return( 'EDIT' ); elsif seclevel in ('LEVEL 1','LEVEL 2','LEVEL 5','LEVEL 8' ) then return( 'READ' ); else return( 'NONE' ); end if;
 elsif typ = 'REPORT F'
  then
   if seclevel in ( 'LEVEL 1','LEVEL 3','LEVEL 4' ) then return( 'EDIT' ); else return( 'NONE' ); end if;
 elsif typ = 'REPORT G'
  then
   if seclevel in ( 'LEVEL 3','LEVEL 4' ) then return( 'EDIT' ); else return( 'NONE' ); end if;
 else
   if seclevel in ('LEVEL 1','LEVEL 4','LEVEL 5' ) then return( 'READ' ); else return( 'EDIT' ); end if;
 end if;
 return( 'READ' );

exception
 when others then return( 'NONE' );
end data_access;

procedure menu_start( surl in varchar2, acid in integer)
as
begin
 menu(surl, '000', MTYPE=>'TRAC' );
end menu_start;

procedure menu( surl in varchar2, rnd in varchar2, mtype in varchar2, msearch in varchar2 default null, action in varchar2 default 'SEARCH', rid in varchar2 default null, acid in integer default null, xtra1 in varchar2 default null, xtra2 in varchar2 default null, xtra3 in varchar2 default null, norder in varchar2 default null, n_local in char default 'LA', rows_show in integer default null )
as

 cursor c1(norder varchar2, n_local varchar2, xloc varchar2) is
  select rowid
  from
  (
  select r.rowid, (select c1.customer from strang.customers c1 where c1.customer_id = r.cust_customer_id) as customer
  from strang.receivals r
  where
   (
    (
      (n_local in ('LA') and substr(to_char(r.deliveryno),1,1) = xloc) or
      (n_local in ('LI') and substr(to_char(r.deliveryno),1,1) = xloc and exists(select 'x' vexst from strang.detailrs d where d.deliveryno = r.deliveryno and upper(d.io) = 'I')) or
      (n_local in ('LO') and substr(to_char(r.deliveryno),1,1) = xloc and exists(select 'x' vexst from strang.detailrs d where d.deliveryno = r.deliveryno and upper(d.io) = 'O')) or
      (n_local in ('LU') and substr(to_char(r.deliveryno),1,1) = xloc and 0 = (select count('x') vexst from strang.detailrs d where d.deliveryno = r.deliveryno)) or
      (n_local in ('AI') and exists(select 'x' vexst from strang.detailrs d where d.deliveryno = r.deliveryno and upper(d.io) = 'I')) or
      (n_local in ('AO') and exists(select 'x' vexst from strang.detailrs d where d.deliveryno = r.deliveryno and upper(d.io) = 'O')) or
      (n_local in ('AU') and 0 = (select count('x') vexst from strang.detailrs d where d.deliveryno = r.deliveryno)) or
      (n_local = 'ALL' or n_local is null or n_local = 'A')
    )
   )
  order by
   decode( nvl(norder,'DND'),
                  'DNA', lpad(r.deliveryno,20,'0'),
                  'DND', lpad((9999999999-r.deliveryno),20,'0'),
                  'CURRA',r.curr,
                  'CURRD',utl_raw.cast_to_varchar2(utl_raw.reverse(utl_raw.cast_to_raw(r.curr))),
                  'CUSTA', lpad(r.cust_customer_id,20,'0'),
                  'CUSTD', lpad((9999999999-r.cust_customer_id),20,'0'),
                  'CUSTOMA', customer,
                  'CUSTOMD', utl_raw.cast_to_varchar2(utl_raw.reverse(utl_raw.cast_to_raw(customer)))
         )
  );
 cursor c1s( nmb number, norder varchar2 ) is
  select rowid
  from
  (
  select r.rowid, (select c1.customer from strang.customers c1 where c1.customer_id = r.cust_customer_id) as customer
  from strang.receivals r
  where to_char(deliveryno) like to_char(nmb) || '%'
  order by
   decode(norder, 'DNA', lpad(r.deliveryno,20,'0'),
                  'DND', lpad((9999999999-r.deliveryno),20,'0'),
                  'CURRA',r.curr,
                  'CURRD',utl_raw.cast_to_varchar2(utl_raw.reverse(utl_raw.cast_to_raw(r.curr))),
                  'CUSTA', lpad(r.cust_customer_id,20,'0'),
                  'CUSTD', lpad((9999999999-r.cust_customer_id),20,'0'),
                  'CUSTOMA', customer,
                  'CUSTOMD', utl_raw.cast_to_varchar2(utl_raw.reverse(utl_raw.cast_to_raw(customer)))
         )
  );
 cursor c1x( dlr varchar2, norder varchar2 ) is
  select rowid
  from
  (
  select r.rowid, (select c1.customer from strang.customers c1 where c1.customer_id = r.cust_customer_id) as customer
  from strang.receivals r
  where substr(to_char(deliveryno),1,1) = dlr
  order by
   decode(norder, 'DNA', lpad(r.deliveryno,20,'0'),
                  'DND', lpad((9999999999-r.deliveryno),20,'0'),
                  'CURRA',r.curr,
                  'CURRD',utl_raw.cast_to_varchar2(utl_raw.reverse(utl_raw.cast_to_raw(r.curr))),
                  'CUSTA', lpad(r.cust_customer_id,20,'0'),
                  'CUSTD', lpad((9999999999-r.cust_customer_id),20,'0'),
                  'CUSTOMA', customer,
                  'CUSTOMD', utl_raw.cast_to_varchar2(utl_raw.reverse(utl_raw.cast_to_raw(customer)))
         )
  );
 cursor c1sx( nmb number, dlr varchar2, norder varchar2 )is
  select rowid
  from
  (
  select r.rowid, (select c1.customer from strang.customers c1 where c1.customer_id = r.cust_customer_id) as customer
  from strang.receivals r
  where to_char(deliveryno) like to_char(nmb) || '%' and substr(to_char(deliveryno),1,1) = dlr
  order by
   decode(norder, 'DNA', lpad(r.deliveryno,20,'0'),
                  'DND', lpad((9999999999-r.deliveryno),20,'0'),
                  'CURRA',r.curr,
                  'CURRD',utl_raw.cast_to_varchar2(utl_raw.reverse(utl_raw.cast_to_raw(r.curr))),
                  'CUSTA', lpad(r.cust_customer_id,20,'0'),
                  'CUSTD', lpad((9999999999-r.cust_customer_id),20,'0'),
                  'CUSTOMA', customer,
                  'CUSTOMD', utl_raw.cast_to_varchar2(utl_raw.reverse(utl_raw.cast_to_raw(customer)))
         )
  );

 cursor c2( sname varchar2 ) is select screen_id from oltp_overview where screen_name = sname;

 -- commented out io because it doesnt work right unsure why
 cursor c3( mtype varchar2, norder varchar2, nlocal varchar2, xtra1 varchar2, xtra2 varchar2, xtra3 varchar2 ) is
    select rowid
    from strang.movements m
    where movement_type = mtype and
--          io = decode(xtra1,'IN','I','OUT','O',io) and
        (
         (xtra2 = 'A') or
         (xtra2 = 'I' and local_ship_id is null) or
         (xtra2 = 'L' and local_ship_id is not null) or
         (substr(xtra2,1,1) = 'C' and consignee_location = substr(xtra2,2))
        ) and
        (
         (xtra3 = 'A') or
         (xtra3 <> 'A' and ship_id = to_number(xtra3))
        )
  order by decode( norder, 'MOVEMENTA', m.movement_no,
                           'MOVEMENTD', utl_raw.cast_to_varchar2(utl_raw.reverse(utl_raw.cast_to_raw(nvl(m.movement_no,' ')))),
                           'SEALA', m.seal,
                           'SEALD', utl_raw.cast_to_varchar2(utl_raw.reverse(utl_raw.cast_to_raw(nvl(m.seal,' ')))),
                           'PACKINGA', decode(m.complete,'A',1,'W',2,'D',3,'F',4,'P',5,'S',6),
                           'PACKINGD', decode(m.complete,'A',9,'W',8,'D',7,'F',6,'P',5,'S',4)
                  );

 cursor c3s( mtype varchar2, msearch varchar2, norder varchar2, nlocal varchar2, xtra1 varchar2, xtra2 varchar2, xtra3 varchar2 ) is
    select rowid
    from strang.movements m
    where movement_type = mtype and
          upper(movement_no) like upper(msearch) || '%' and
--          io = decode(xtra1,'IN','I','OUT','O',io) and
        (
         (xtra2 = 'A') or
         (xtra2 = 'I' and local_ship_id is null) or
         (xtra2 = 'L' and local_ship_id is not null) or
         (substr(xtra2,1,1) = 'C' and consignee_location = substr(xtra2,2))
        ) and
        (
         (xtra3 = 'A') or
         (xtra3 <> 'A' and ship_id = to_number(xtra3))
        )
  order by decode( norder, 'MOVEMENTA', m.movement_no,
                           'MOVEMENTD', utl_raw.cast_to_varchar2(utl_raw.reverse(utl_raw.cast_to_raw(nvl(m.movement_no,' ')))),
                           'SEALA', m.seal,
                           'SEALD', utl_raw.cast_to_varchar2(utl_raw.reverse(utl_raw.cast_to_raw(nvl(m.seal,' ')))),
                           'PACKINGA', decode(m.complete,'A',1,'W',2,'D',3,'F',4,'P',5,'S',6),
                           'PACKINGD', decode(m.complete,'A',9,'W',8,'D',7,'F',6,'P',5,'S',4)
                  );

 cursor c3c( mtype varchar2, norder varchar2, nlocal varchar2, xtra1 varchar2, xtra2 varchar2, xtra3 varchar2 ) is
    select rowid
    from strang.movements m
    where convoy_id is not null and
--          io = decode(xtra1,'IN','I','OUT','O',io) and
        (
         (xtra2 = 'A') or
         (xtra2 = 'I' and local_ship_id is null) or
         (xtra2 = 'L' and local_ship_id is not null) or
         (substr(xtra2,1,1) = 'C' and consignee_location = substr(xtra2,2))
        ) and
        (
         (xtra3 = 'A') or
         (xtra3 <> 'A' and ship_id = to_number(xtra3))
        )
  order by decode( norder, 'MOVEMENTA', m.movement_no,
                           'MOVEMENTD', utl_raw.cast_to_varchar2(utl_raw.reverse(utl_raw.cast_to_raw(nvl(m.movement_no,' ')))),
                           'SEALA', m.seal,
                           'SEALD', utl_raw.cast_to_varchar2(utl_raw.reverse(utl_raw.cast_to_raw(nvl(m.seal,' ')))),
                           'PACKINGA', decode(m.complete,'A',1,'W',2,'D',3,'F',4,'P',5,'S',6),
                           'PACKINGD', decode(m.complete,'A',9,'W',8,'D',7,'F',6,'P',5,'S',4)
                  );

 cursor c4 is select rowid from strang.invoices order by invoiceno;
 cursor c4s( msearch varchar2 ) is select rowid from strang.invoices where upper(invoiceno) like upper(msearch) || '%';
 cursor c5 is select rowid from strang.duty order by entry_no;
-- cursor c5s( msearch varchar2 ) is select rowid from strang.duty where to_char(entry_no) like strang.ent.get_entry_no(msearch) || '%';
-- cursor c5s( msearch varchar2 ) is select rowid from strang.duty where to_char(strang.ent.get_entry_no(entry_no)) like msearch || '%';
 cursor c5s( m_search integer ) is select rowid from strang.duty where entry_no = strang.ent.get_entry_no(m_search);

 cursor c6(vlimit varchar2, norder varchar2) is
  select rowid
  from strang.ships_airway s
  where s.ship_airway = decode(vlimit,'SHIP_AIRWAY_LOCAL','L','SHIP_AIRWAY_INT','S','AIRWAY_LOCAL','D','AIRWAY_INT','A','CONVOY','C',s.ship_airway)
  order by decode( norder, 'SHIPNAMEA', s.shipname,
                           'SHIPNAMED', utl_raw.cast_to_varchar2(utl_raw.reverse(utl_raw.cast_to_raw(nvl(s.shipname,' ')))),
                           'VOYA', s.voy,
                           'VOYDD', utl_raw.cast_to_varchar2(utl_raw.reverse(utl_raw.cast_to_raw(nvl(s.voy,' ')))),
                           'STATUSA', s.status,
                           'STATUSD', utl_raw.cast_to_varchar2(utl_raw.reverse(utl_raw.cast_to_raw(nvl(s.status,' ')))),
                           'SHIPA', lpad(s.sap_ship_id,20,'0'),
                           'SHIPD', lpad((9999999999-s.sap_ship_id),20,'0'),
                           'ESTDA', to_char(s.estdepart,'YYYYMMDD'),
                           'ESTDD', lpad((9999999999-to_char(s.estdepart,'SSSSS')),20,'0'),
                           'ESTAA', to_char(s.estarrive,'YYYYMMDD'),
                           'ESTAD', lpad((9999999999-to_char(s.estarrive,'SSSSS')),20,'0'),
                           'PORTLOADA', s.portload,
                           'PORTLOADD', utl_raw.cast_to_varchar2(utl_raw.reverse(utl_raw.cast_to_raw(nvl(s.portload,' ')))),
                           'PORTDISCA', s.portdisc,
                           'PORTDISCD', utl_raw.cast_to_varchar2(utl_raw.reverse(utl_raw.cast_to_raw(nvl(s.portdisc,' '))))
                       );
 cursor c6s( msearch varchar2, vlimit varchar2, norder varchar2 ) is
  select rowid
  from strang.ships_airway s
  where
        (
         (upper(voy) like upper(msearch) || '%' and instr(msearch,'-') = 0) or
         (upper(shipname) like upper(msearch) || '%' and ship_airway = 'C') or
         (instr(msearch,'-') > 0 and upper(voy) = substr(upper(msearch),1,instr(msearch,'-')-1) and upper(shipname) like substr(upper(msearch),instr(msearch,'-')+1) || '%')
        ) and
        s.ship_airway = decode(vlimit,'SHIP_AIRWAY_LOCAL','L','SHIP_AIRWAY_INT','S','AIRWAY_LOCAL','D','AIRWAY_INT','A','CONVOY','C',s.ship_airway)
  order by decode( norder, 'SHIPNAMEA', s.shipname,
                           'SHIPNAMED', utl_raw.cast_to_varchar2(utl_raw.reverse(utl_raw.cast_to_raw(nvl(s.shipname,' ')))),
                           'VOYA', s.voy,
                           'VOYDD', utl_raw.cast_to_varchar2(utl_raw.reverse(utl_raw.cast_to_raw(nvl(s.voy,' ')))),
                           'STATUSA', s.status,
                           'STATUSD', utl_raw.cast_to_varchar2(utl_raw.reverse(utl_raw.cast_to_raw(nvl(s.status,' ')))),
                           'SHIPA', lpad(s.sap_ship_id,20,'0'),
                           'SHIPD', lpad((9999999999-s.sap_ship_id),20,'0'),
                           'ESTDA', to_char(s.estdepart,'YYYYMMDD'),
                           'ESTDD', lpad((9999999999-to_char(s.estdepart,'SSSSS')),20,'0'),
                           'ESTAA', to_char(s.estarrive,'YYYYMMDD'),
                           'ESTAD', lpad((9999999999-to_char(s.estarrive,'SSSSS')),20,'0'),
                           'PORTLOADA', s.portload,
                           'PORTLOADD', utl_raw.cast_to_varchar2(utl_raw.reverse(utl_raw.cast_to_raw(nvl(s.portload,' ')))),
                           'PORTDISCA', s.portdisc,
                           'PORTDISCD', utl_raw.cast_to_varchar2(utl_raw.reverse(utl_raw.cast_to_raw(nvl(s.portdisc,' '))))
                        );
 cursor c6ss( shipid integer, vlimit varchar2, norder varchar2 ) is
  select rowid
  from strang.ships_airway s
  where (ship_id = shipid or sap_ship_id = shipid or to_char(voy) = to_char(shipid) or (ship_airway = 'C' and shipname like 'CONVOY-' || to_char(msearch) || '%')) and
        s.ship_airway = decode(vlimit,'SHIP_AIRWAY_LOCAL','L','SHIP_AIRWAY_INT','S','AIRWAY_LOCAL','D','AIRWAY_INT','A','CONVOY','C',s.ship_airway)
  order by decode( norder, 'SHIPNAMEA', s.shipname,
                           'SHIPNAMED', utl_raw.cast_to_varchar2(utl_raw.reverse(utl_raw.cast_to_raw(nvl(s.shipname,' ')))),
                           'VOYA', s.voy,
                           'VOYDD', utl_raw.cast_to_varchar2(utl_raw.reverse(utl_raw.cast_to_raw(nvl(s.voy,' ')))),
                           'STATUSA', s.status,
                           'STATUSD', utl_raw.cast_to_varchar2(utl_raw.reverse(utl_raw.cast_to_raw(nvl(s.status,' ')))),
                           'SHIPA', lpad(s.sap_ship_id,20,'0'),
                           'SHIPD', lpad((9999999999-s.sap_ship_id),20,'0'),
                           'ESTDA', to_char(s.estdepart,'YYYYMMDD'),
                           'ESTDD', lpad((9999999999-to_char(s.estdepart,'SSSSS')),20,'0'),
                           'ESTAA', to_char(s.estarrive,'YYYYMMDD'),
                           'ESTAD', lpad((9999999999-to_char(s.estarrive,'SSSSS')),20,'0'),
                           'PORTLOADA', s.portload,
                           'PORTLOADD', utl_raw.cast_to_varchar2(utl_raw.reverse(utl_raw.cast_to_raw(nvl(s.portload,' ')))),
                           'PORTDISCA', s.portdisc,
                           'PORTDISCD', utl_raw.cast_to_varchar2(utl_raw.reverse(utl_raw.cast_to_raw(nvl(s.portdisc,' '))))
                       );

 cursor c7 is select rowid from strang.customers order by customer;
 cursor c7s( msearch varchar2 ) is select rowid from strang.customers where upper(customer) like upper(msearch) || '%' order by customer;
 cursor c7n( msearch integer ) is select rowid from strang.customers where customer_id = msearch order by customer;
 cursor c8 is select rowid,chargecode from strang.charges order by chargecode;
 cursor c8s( msearch varchar2 ) is select rowid,chargecode from strang.charges where upper(chargecode) like upper(msearch) || '%';
 cursor c9 is select rowid,entry_no from strang.detailrs where entry_no is not null order by entry_no,line_no;
 cursor c9a(lrid rowid) is select rowid from strang.receivals where deliveryno = (select deliveryno from strang.detailrs where rowid = lrid);
 cursor c9b(lrid rowid) is select rowid from strang.detailrs where deliveryno in (select deliveryno from strang.receivals where rowid = lrid) order by itemno,logno;
 cursor c9s( msearch integer ) is select rowid,entry_no from strang.detailrs where entry_no = strang.ent.get_entry_no(msearch);
 cursor c10(vste varchar2) is select description from strang.lov where lov_name = 'CONTROLS' and code = 'SEE_ALL_DELIVERIES' and cola = vste;
 cursor c11(vste varchar2) is select description from strang.lov where lov_name = 'CONTROLS' and code = 'DELIVERYNO' and cola = vste;
 cursor c12 is select rowid,entry_no from strang.manentry order by entry_no desc;
 cursor c12s( nmb number ) is select rowid,entry_no from strang.manentry where to_char(entry_no) like to_char(nmb) || '%';
 cursor c12x is select count('x') tot from strang.manentry;
 cursor c14(ent integer) is select rowid,entry_no from strang.manent2 where entry_no = ent order by rno;
 cursor c14s( ent integer, nmb number ) is select rowid,entry_no from strang.manent2 where entry_no = ent and to_char(rno) like to_char(nmb) || '%' order by rno;
 cursor c14x(ent integer) is select count('x') tot from strang.manent2 where entry_no = ent;
 cursor c14z(nrid rowid) is select entry_no from strang.manent2 where rowid = nrid;
 cursor c15 is select rowid from strang.containers order by containerno, timeshired desc;
 cursor c15s( msearch varchar2 ) is select rowid from strang.containers where containerno like msearch || '%' order by containerno, timeshired desc;
 -- xxx change to reference categories
 cursor c16 is select rowid from strang.categories order by contract,company,codedesc;
 cursor c16s( msearch varchar2 ) is select rowid from strang.categories where contract||codedesc||company like '%' || msearch || '%' order by contract,company,codedesc;
 cursor c17 is select rowid from strang.onlocs order by cat_contract,cat_company,cat_code;
 cursor c17s( msearch varchar2 ) is select rowid from strang.onlocs where replace(cat_contract||cat_company||cat_code,' ','') like '%' || replace(upper(msearch),' ','') || '%' order by cat_contract,cat_company,cat_code;
 cursor c18 is select rowid from strang.offlocs order by cat_contract,cat_company,cat_code;
 cursor c18s( msearch varchar2 ) is select rowid from strang.offlocs where replace(cat_contract||cat_company||cat_code ,' ','') like '%' || replace(upper(msearch),' ','') || '%' order by cat_contract,cat_company,cat_code;
 cursor c19 is select rowid from strang.tracking_header order by containerno, cat_code, cat_company;
 cursor c19s( msearch varchar2 ) is select rowid from strang.tracking_header where containerno like msearch || '%' order by containerno, cat_code, cat_company;

 c1rec	c1%ROWTYPE;
 c2rec	c2%ROWTYPE;
 c3rec	c3%ROWTYPE;
 c4rec	c4%ROWTYPE;
 c5rec	c5%ROWTYPE;
 c6rec	c6%ROWTYPE;
 c7rec	c7%ROWTYPE;
 c8rec	c8%ROWTYPE;
 c9rec	c9%ROWTYPE;
 c9arec	c9a%ROWTYPE;
 c10rec c10%ROWTYPE;
 c11rec c11%ROWTYPE;
 c12rec c12%ROWTYPE;
 c14rec c14%ROWTYPE;
 c15rec c15%ROWTYPE;
 c16rec c16%ROWTYPE;
 c17rec c17%ROWTYPE;
 c18rec c18%ROWTYPE;
 c19rec c19%ROWTYPE;

 nmb		number;
 lrid		rowid;
 sts		varchar2(100);
 rctr		integer;
 tot		integer;
 ent		integer;
 vste		varchar2(10);
 arr_rid	src_rid;
 v_search       varchar2(1000);
 v_cus		integer;
 v_ship_search	integer;
 sd		date;
 x_norder	varchar2(10);
 x_n_local	varchar2(10);
 vdef		char(1);
 v_local_check	varchar2(100);
 xloc		char(1);
 seclevel	varchar2(100);

begin
 if not dapi.init( surl, 'STRANGP.MENU', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'MENU' );
    return;
 end if;

 vste := customer_state(dapi.GLOBAL_ACCOUNT.acctid);
 open c11(vste);
 fetch c11 into v_local_check;
 close c11;
 xloc := substr(v_local_check,1,1);
 seclevel := security_role( dapi.GLOBAL_ACCOUNT.acctid );

 if mtype = 'RECEIVALS'
  then
   open c10(vste);
   fetch c10 into c10rec;
   close c10;
   x_norder := nvl(xtra1,norder);
   x_n_local := nvl(xtra2,n_local);
   if not (seclevel in ( 'LEVEL 5','LEVEL 7','LEVEL 8' ))
    then
     if xtra2 is null then x_n_local := 'LA';  end if;
     if x_n_local not in ('LA','LI','LO','LU') then x_n_local := 'LA'; end if;
   end if;
   if action = 'SEARCH'
    then
     if msearch is null
      then
       if c10rec.description = 'YES' and dapi.GLOBAL_ACCOUNT.username <> 'DAWN'
        then
         open c1(x_norder,x_n_local,xloc);
         fetch c1 into c1rec;
         close c1;
        else
         open c11(vste);
         fetch c11 into c11rec;
         close c11;
         open c1x( substr(c11rec.description,1,1), x_norder );
         fetch c1x into c1rec;
         close c1x;
       end if;
       if (seclevel in ( 'LEVEL 5','LEVEL 7','LEVEL 8' ))
        then
         if c1rec.rowid is not null then x_n_local := 'LA'; end if;
        else
         if c1rec.rowid is not null then x_n_local := 'LA'; end if;
       end if;
      else
       begin nmb := to_number( msearch ); exception when others then nmb := NULL; end;
       if c10rec.description = 'YES' and dapi.GLOBAL_ACCOUNT.username <> 'DAWN'
        then
         open c1s( nmb, x_norder );
         fetch c1s into c1rec;
         close c1s;
        else
         open c11(vste);
         fetch c11 into c11rec;
         close c11;
         open c1sx( nmb,substr(c11rec.description,1,1), x_norder  );
         fetch c1sx into c1rec;
         close c1sx;
       end if;
       if (seclevel in ( 'LEVEL 5','LEVEL 7','LEVEL 8' ))
        then
         if c1rec.rowid is not null then x_n_local := 'LA'; end if;
        else
         if c1rec.rowid is not null then x_n_local := 'LA'; end if;
       end if;
     end if;
     open c2( 'Receival' );
     fetch c2 into c2rec;
     close c2;

   elsif action in ('PREVIOUS','PREVIOUSM')
    then
     if c10rec.description = 'YES' and dapi.GLOBAL_ACCOUNT.username <> 'DAWN'
      then
       open c1(x_norder,x_n_local,xloc);
      else
       open c11(vste);
       fetch c11 into c11rec;
       close c11;
       open c1x( substr(c11rec.description,1,1), x_norder );
     end if;

     lrid := NULL;
     loop
      if c10rec.description = 'YES' and dapi.GLOBAL_ACCOUNT.username <> 'DAWN'
       then
        fetch c1 into c1rec;
        if c1%NOTFOUND then c1rec.rowid := lrid; exit; end if;
       else
        fetch c1x into c1rec;
        if c1x%NOTFOUND then c1rec.rowid := lrid; exit; end if;
      end if;
      exit when c1rec.rowid = replace(rid,'~','+');
      lrid := c1rec.rowid;
     end loop;

     if c10rec.description = 'YES' and dapi.GLOBAL_ACCOUNT.username <> 'DAWN' then close c1; else close c1x; end if;
     if lrid is not null then c1rec.rowid := lrid; end if;

   elsif action in ('NEXT','NEXTM')
    then
     if c10rec.description = 'YES'  and dapi.GLOBAL_ACCOUNT.username <> 'DAWN'
      then
       --gl.dbg( 'sa [' || msearch || '][' || c1rec.rowid || '][' || x_norder || '][' || x_n_local || '][' || action || ']' );
       open c1(x_norder,x_n_local,xloc);
      else
       open c11(vste);
       fetch c11 into c11rec;
       close c11;
       open c1x(substr(c11rec.description,1,1), x_norder );
     end if;
     lrid := NULL;
     loop
      if c10rec.description = 'YES'  and dapi.GLOBAL_ACCOUNT.username <> 'DAWN'
       then
        fetch c1 into c1rec;
        if c1%NOTFOUND then c1rec.rowid := lrid; exit; end if;
       else
        fetch c1x into c1rec;
        if c1x%NOTFOUND then c1rec.rowid := lrid; exit; end if;
      end if;
      if c1rec.rowid = replace(rid,'~','+')
       then
        lrid := c1rec.rowid;
        if c10rec.description = 'YES'  and dapi.GLOBAL_ACCOUNT.username <> 'DAWN'
         then
          fetch c1 into c1rec;
          if c1%NOTFOUND then c1rec.rowid := lrid; end if;
         else
          fetch c1x into c1rec;
          if c1x%NOTFOUND then c1rec.rowid := lrid; end if;
        end if;
        exit;
      end if;
      lrid := c1rec.rowid;
     end loop;
     if c10rec.description = 'YES'  and dapi.GLOBAL_ACCOUNT.username <> 'DAWN' then close c1; else close c1x; end if;
   end if;
   if c1rec.rowid is null
    then
     htp.htmlopen;
      htp.header(3,'Receivals Search on' || ' : ' || msearch, 'CENTER' );
      htp.header(2,'No Results found from Search (' || vste || ')', 'CENTER' );
      htp.header(3,'Hit the BACK Button and retry your Search.', 'CENTER' );
     htp.htmlclose;
     return;
   end if;
   --gl.dbg( 'sr [' || msearch || '][' || c1rec.rowid || '][' || x_norder || '][' || x_n_local || '][' || action || ']' );
   if msearch is not null and c1rec.rowid is not null
    then
     receive_single(surl,c1rec.rowid, c2rec.screen_id, 'strangp.receive', 'RECEIVALS', 'x', null, norder=>x_norder, n_local=>x_n_local );
     return;
   end if;
   if action in ('PREVIOUS','NEXT')
    then
     receive(surl,c1rec.rowid, c2rec.screen_id, 'strangp.receive', 'RECEIVALS-SINGULAR', 'x', null, norder=>x_norder, n_local=>x_n_local );
    else
     receive(surl,c1rec.rowid, c2rec.screen_id, 'strangp.receive', 'RECEIVALS', 'x', null, norder=>x_norder, n_local=>x_n_local );
   end if;
   return;
 end if;

 if mtype in ('CARGO','CONMOV','AIRWAY','CONVOY_MOVEMENT')
  then
   if action = 'SEARCH'
    then
     if msearch is null and mtype = 'CONVOY_MOVEMENT'
      then
       open c3c( mtype, nvl(norder,'MOVEMENTA'), n_local, xtra1, nvl(xtra2,'A'), nvl(xtra3,'A') );
       fetch c3c into c3rec;
       close c3c;
     elsif msearch is null
      then
       open c3( mtype, nvl(norder,'MOVEMENTA'), n_local, xtra1, nvl(xtra2,'A'), nvl(xtra3,'A') );
       fetch c3 into c3rec;
       close c3;
      else
       open c3s( mtype, trim(msearch), nvl(norder,'MOVEMENTA'), n_local, xtra1, nvl(xtra2,'A'), nvl(xtra3,'A') );
       fetch c3s into c3rec;
       close c3s;
     end if;
     if mtype = 'CARGO'
      then
       open c2( 'Cargo' );
     elsif mtype = 'CONMOV'
      then
       open c2( 'Consignment' );
     elsif mtype = 'CONVOY_MOVEMENT'
      then
       open c2( 'Convoy' );
     else
       open c2( 'Air Freight' );
     end if;
     fetch c2 into c2rec;
     close c2;

   elsif action in ('PREVIOUS','PREVIOUSM')
    then
     open c3( mtype, nvl(norder,'MOVEMENTA'), n_local, xtra1, nvl(xtra2,'A'), nvl(xtra3,'A') );
     lrid := NULL;
     loop
      fetch c3 into c3rec;
      if c3%NOTFOUND then c3rec.rowid := lrid; exit; end if;
      exit when c3rec.rowid = replace(rid,'~','+');
      lrid := c3rec.rowid;
     end loop;
     close c3;
     if lrid is not null then c3rec.rowid := lrid; end if;

   elsif action in ('NEXT','NEXTM')
    then
     open c3( mtype, nvl(norder,'MOVEMENTA'), n_local, xtra1, nvl(xtra2,'A'), nvl(xtra3,'A') );
     lrid := NULL;
     loop
      fetch c3 into c3rec;
      if c3%NOTFOUND then c3rec.rowid := lrid; exit; end if;
      if c3rec.rowid = replace(rid,'~','+')
       then
        lrid := c3rec.rowid;
        fetch c3 into c3rec;
        if c3%NOTFOUND then c3rec.rowid := lrid; end if;
        exit;
      end if;
      lrid := c3rec.rowid;
     end loop;
     close c3;
   end if;

   if c3rec.rowid is null
    then
     htp.htmlopen;
      htp.header(3,'Movement Search on' || ' : ' || msearch, 'CENTER' );
      htp.header(2,'No Results found from Search.', 'CENTER' );
      htp.header(3,'Hit the BACK Button and retry your Search.', 'CENTER' );
     htp.htmlclose;
     return;
   end if;
   if msearch is not null and c3rec.rowid is not null
    then
     movement(surl, c3rec.rowid, c2rec.screen_id, 'strangp.movement', mtype, 'x', null,xtra1=>xtra1,xtra2=>nvl(xtra2,'A'),xtra3=>nvl(xtra3,'A'),norder=>nvl(norder,'MOVEMENTA'),n_local=>n_local,rows_show=>nvl(rows_show,G_ROWS),force_single_disp=>'T' );
     return;
   end if;
   movement(surl, c3rec.rowid, c2rec.screen_id, 'strangp.movement', mtype, 'x', null,xtra1=>xtra1,xtra2=>nvl(xtra2,'A'),xtra3=>nvl(xtra3,'A'),norder=>nvl(norder,'MOVEMENTA'),n_local=>n_local,rows_show=>nvl(rows_show,G_ROWS) );
   return;
 end if;

 if mtype = 'INVOICES'
  then
   if action = 'SEARCH'
    then
     if msearch is null
      then
       open c4;
       fetch c4 into c4rec;
       close c4;
      else
       open c4s( msearch );
       fetch c4s into c4rec;
       close c4s;
     end if;
     open c2( 'Invoicing' );
     fetch c2 into c2rec;
     close c2;
   elsif action = 'PREVIOUS'
    then
     open c4;
     lrid := NULL;
     loop
      fetch c4 into c4rec;
      if c4%NOTFOUND then c4rec.rowid := lrid; exit; end if;
      exit when c4rec.rowid = replace(rid,'~','+');
      lrid := c4rec.rowid;
     end loop;
     close c4;
     if lrid is not null then c4rec.rowid := lrid; end if;
   elsif action = 'NEXT'
    then
     open c4;
     lrid := NULL;
     loop
      fetch c4 into c4rec;
      if c4%NOTFOUND then c4rec.rowid := lrid; exit; end if;
      if c4rec.rowid = replace(rid,'~','+')
       then
        exit;
        lrid := c4rec.rowid;
        fetch c4 into c4rec;
        if c4%NOTFOUND then c4rec.rowid := lrid; end if;
      end if;
      lrid := c4rec.rowid;
     end loop;
     close c4;
   end if;
   if c4rec.rowid is null
    then
     htp.htmlopen;
      htp.header(3,'Inventory Search on' || ' : ' || msearch, 'CENTER' );
      htp.header(2,'No Results found from Search.', 'CENTER' );
      htp.header(3,'Hit the BACK Button and retry your Search.', 'CENTER' );
     htp.htmlclose;
     return;
   end if;
   inv(surl,c4rec.rowid, c2rec.screen_id, 'strangp.inv', 'INVOICES', 'x', null );
   return;
 end if;

 if mtype = 'DUTY'
  then
   if action = 'SEARCH'
    then
     if msearch is null
      then
       open c5;
       fetch c5 into c5rec;
       close c5;
      else
       if instr(msearch, '.') > 0
        then
         begin nmb := to_number(strang.ent.get_entry_no(msearch)); exception when others then nmb := null; end;
       else
         begin nmb := to_number('1' || '.' || strang.ent.get_entry_no(msearch, 'D')); exception when others then nmb := null; end;
       end if;
       open c5s( nmb );
--       open c5s( msearch );
       fetch c5s into c5rec;
       close c5s;
     end if;
     open c2( 'Duty' );
     fetch c2 into c2rec;
     close c2;
   elsif action = 'PREVIOUS'
    then
     open c5;
     lrid := NULL;
     loop
      fetch c5 into c5rec;
      if c5%NOTFOUND then c5rec.rowid := lrid; exit; end if;
      exit when c5rec.rowid = replace(rid,'~','+');
      lrid := c5rec.rowid;
     end loop;
     close c5;
     if lrid is not null then c5rec.rowid := lrid; end if;
   elsif action = 'NEXT'
    then
     open c5;
     lrid := NULL;
     loop
      fetch c5 into c5rec;
      if c5%NOTFOUND then c5rec.rowid := lrid; exit; end if;
      if c5rec.rowid = replace(rid,'~','+')
       then
        lrid := c5rec.rowid;
        fetch c5 into c5rec;
        if c5%NOTFOUND then c5rec.rowid := lrid; end if;
        exit;
      end if;
      lrid := c5rec.rowid;
     end loop;
     close c5;
   end if;
   if c5rec.rowid is null
    then
     htp.htmlopen;
--      htp.header(3,'Duty Search on' || ' : ' || msearch, 'CENTER' );
      htp.header(3,'Duty Search on' || ' : ' || nvl(to_char(nmb), msearch), 'CENTER' );
      htp.header(2,'No Results found from Search.', 'CENTER' );
      htp.header(3,'Hit the BACK Button and retry your Search.', 'CENTER' );
     htp.htmlclose;
     return;
   end if;
   duty_edit(surl,c5rec.rowid, c2rec.screen_id, 'DUTY', 'x', null );
   return;
 end if;

 if mtype in ('SHIP_AIRWAY','SHIP_AIRWAY_LOCAL','SHIP_AIRWAY_INT','AIRWAY_LOCAL','AIRWAY_INT','CONVOY')
  then
   if action = 'SEARCH'
    then
     if msearch is null
      then
       open c6(mtype,norder);
       fetch c6 into c6rec;
       close c6;
     else
       v_ship_search := gl.guess_number(trim(msearch));
       if v_ship_search is not null
       then
        open c6ss( v_ship_search, mtype, norder );
        fetch c6ss into c6rec;
        close c6ss;
       else
        open c6s( msearch, mtype, norder );
        fetch c6s into c6rec;
        close c6s;
       end if;
     end if;
     open c2( 'Ship/Air' );
     fetch c2 into c2rec;
     close c2;
   elsif action = 'PREVIOUS'
    then
     open c6(mtype, norder);
     lrid := NULL;
     loop
      fetch c6 into c6rec;
      if c6%NOTFOUND then c6rec.rowid := lrid; exit; end if;
      exit when c6rec.rowid = replace(rid,'~','+');
      lrid := c6rec.rowid;
     end loop;
     close c6;
     if lrid is not null then c6rec.rowid := lrid; end if;
   elsif action = 'NEXT'
    then
     open c6(mtype, norder);
     lrid := NULL;
     loop
      fetch c6 into c6rec;
      if c6%NOTFOUND then c6rec.rowid := lrid; exit; end if;
      if c6rec.rowid = replace(rid,'~','+')
       then
        lrid := c6rec.rowid;
        fetch c6 into c6rec;
        if c6%NOTFOUND then c6rec.rowid := lrid; end if;
        exit;
      end if;
      lrid := c6rec.rowid;
     end loop;
     close c6;
   end if;
   if c6rec.rowid is null
    then
     htp.htmlopen;
      if mtype = 'CONVOY'
       then
        htp.header(3,'Convoy Search on' || ' : ' || msearch, 'CENTER' );
       else
        htp.header(3,'Ships/Airway Search on' || ' : ' || msearch, 'CENTER' );
      end if;
      htp.header(2,'No Results found from Search.', 'CENTER' );
      htp.header(3,'Hit the BACK Button and retry your Search.', 'CENTER' );
     htp.htmlclose;
     return;
   end if;

   case mtype
    when 'SHIP_AIRWAY'  then vdef := 'S';
    when 'SHIP_AIRWAY_LOCAL' then vdef := 'L';
    when 'SHIP_AIRWAY_INT' then vdef := 'S';
    when 'AIRWAY_LOCAL' then vdef := 'D';
    when 'AIRWAY_INT' then vdef := 'A';
    when 'CONVOY' then vdef := 'C';
    else vdef := null;
   end case;
   if msearch is not null and c6rec.rowid is not null
    then
     shp(surl,c6rec.rowid, c2rec.screen_id, 'SHIP_AIRWAY', 'x', null, vdef=>vdef, mtype=>mtype, xtra1=>xtra1, rows_show=>G_ROWS, n_local=>xtra2, norder=>xtra3, force_single_disp=>'T' );
     return;
   end if;
   shp(surl,c6rec.rowid, c2rec.screen_id, 'SHIP_AIRWAY', 'x', null, vdef=>vdef, mtype=>mtype, xtra1=>xtra1, rows_show=>G_ROWS, n_local=>xtra2, norder=>xtra3 );
   return;
 end if;

 if mtype = 'CUSTOMERS'
  then
   if action = 'SEARCH'
    then
     if msearch is null
      then
       open c7;
       fetch c7 into c7rec;
       close c7;
       else
       v_cus := gl.guess_number(msearch);
       if v_cus is not null
        then
        open c7n( v_cus );
        fetch c7n into c7rec;
        close c7n;
        close c7s;
       else
        open c7s( msearch );
        fetch c7s into c7rec;
       end if;
     end if;
     open c2( 'Customers' );
     fetch c2 into c2rec;
     close c2;
   elsif action = 'PREVIOUS'
    then
     open c7;
     lrid := NULL;
     loop
      fetch c7 into c7rec;
      if c7%NOTFOUND then c7rec.rowid := lrid; exit; end if;
      exit when c7rec.rowid = replace(rid,'~','+');
      lrid := c7rec.rowid;
     end loop;
     close c7;
     if lrid is not null then c7rec.rowid := lrid; end if;
   elsif action = 'NEXT'
    then
     open c7;
     lrid := NULL;
     loop
      fetch c7 into c7rec;
      if c7%NOTFOUND then c7rec.rowid := lrid; exit; end if;
      if c7rec.rowid = replace(rid,'~','+')
       then
        lrid := c7rec.rowid;
        fetch c7 into c7rec;
        if c7%NOTFOUND then c7rec.rowid := lrid; end if;
        exit;
      end if;
      lrid := c7rec.rowid;
     end loop;
     close c7;
   end if;
   if c7rec.rowid is null
    then
     htp.htmlopen;
      htp.header(3,'Customer Search on' || ' : ' || msearch, 'CENTER' );
      htp.header(2,'No Results found from Search.', 'CENTER' );
      htp.header(3,'Hit the BACK Button and retry your Search.', 'CENTER' );
     htp.htmlclose;
     return;
   end if;
   mng_cust(surl,c7rec.rowid, 'x', null, is_popup=>xtra3 );
   return;
 end if;

 if mtype = 'CHARGES'
  then
   if action = 'SEARCH'
    then
     if msearch is null
      then
       open c8;
       fetch c8 into c8rec;
       close c8;
       else
       open c8s( msearch );
       fetch c8s into c8rec;
       close c8s;
     end if;
     open c2( 'Charge Codes' );
     fetch c2 into c2rec;
     close c2;
   elsif action = 'PREVIOUS'
    then
     open c8;
     lrid := NULL;
     loop
      fetch c8 into c8rec;
      if c8%NOTFOUND then c8rec.rowid := lrid; exit; end if;
      exit when c8rec.rowid = replace(rid,'~','+');
      lrid := c8rec.rowid;
     end loop;
     close c8;
     if lrid is not null then c8rec.rowid := lrid; end if;
   elsif action = 'NEXT'
    then
     open c8;
     lrid := NULL;
     loop
      fetch c8 into c8rec;
      if c8%NOTFOUND then c8rec.rowid := lrid; exit; end if;
      if c8rec.rowid = replace(rid,'~','+')
       then
        lrid := c8rec.rowid;
        fetch c8 into c8rec;
        if c8%NOTFOUND then c8rec.rowid := lrid; end if;
        exit;
      end if;
      lrid := c8rec.rowid;
     end loop;
     close c8;
   end if;
   if c8rec.rowid is null
    then
     htp.htmlopen;
      htp.header(3,'Charge Code Search on' || ' : ' || msearch, 'CENTER' );
      htp.header(2,'No Results found from Search.', 'CENTER' );
      htp.header(3,'Hit the BACK Button and retry your Search.', 'CENTER' );
     htp.htmlclose;
     return;
   end if;
   mng_charge(surl,c8rec.rowid, 'x', null );
   return;
 end if;

 if mtype = 'ENTRY_NO'
  then
   if action = 'SEARCH'
    then
     if msearch is null
      then
       open c9;
       fetch c9 into c9rec;
       close c9;
      else
       if instr(msearch, '.') > 0
        then
         begin nmb := to_number(strang.ent.get_entry_no(msearch)); exception when others then nmb := null; end;
       else
         begin nmb := to_number('1' || '.' || strang.ent.get_entry_no(msearch, 'D')); exception when others then nmb := null; end;
       end if;
       -- begin nmb := to_number(msearch); exception when others then nmb := NULL; end;
       open c9s( nmb );
       fetch c9s into c9rec;
       close c9s;
     end if;
     lrid := c9rec.rowid;
     if lrid is null
      then
       htp.init;
       htp.htmlopen;
       htp.header(3,'Duty Search on' || ' : ' || nvl(to_char(nmb), msearch), 'CENTER' );
       htp.header(3,'No Results found from Search.','CENTER');
       htp.header(4,'Hit the BACK Button and retry your Search.','CENTER');
       return;
     end if;
     open c2( 'Detailrs' );
     fetch c2 into c2rec;
     close c2;
   elsif action = 'PREVIOUS'
    then
     open c9;
     lrid := NULL;
     loop
      fetch c9 into c9rec;
      if c9%NOTFOUND then c9rec.rowid := lrid; exit; end if;
      exit when c9rec.rowid = replace(rid,'~','+');
      lrid := c9rec.rowid;
     end loop;
     close c9;
     if lrid is not null then c9rec.rowid := lrid; else lrid := replace(rid,'~','+'); end if;
   elsif action = 'NEXT'
    then
     open c9;
     lrid := NULL;
     loop
      fetch c9 into c9rec;
      if c9%NOTFOUND then c9rec.rowid := lrid; exit; end if;
      if c9rec.rowid = replace(rid,'~','+')
       then
        lrid := c9rec.rowid;
        fetch c9 into c9rec;
        if c9%NOTFOUND then c9rec.rowid := lrid; end if;
        lrid := c9rec.rowid;
        exit;
     close c9;
      end if;
      lrid := c9rec.rowid;
     end loop;
   end if;
   open c9a(nvl(lrid,replace(rid,'~','+')));
   fetch c9a into c9arec;
   close c9a;
   rctr := 0;
   for c9brec in c9b(c9arec.rowid) loop
    rctr := rctr + 1;
    if c9brec.rowid = lrid then exit; end if;
   end loop;
   -- Now having to replace the whole screen
   receive(surl, lrid, c2rec.screen_id, 'strangp.receive', 'DETAILRS', 'x', null );
   --receive_bottom(surl,c9arec.rowid,5,null,'DETAILRS','e',rctr,null );
   return;
 end if;

 if mtype = 'ME'
  then
   if action = 'SEARCH'
    then
     if msearch is null
      then
       open c12;
       fetch c12 into c12rec;
       if c12%NOTFOUND
        then
         close c12;
         open c12x;
         fetch c12x into tot;
         close c12x;
         if tot = 0
          then
            open c2( 'Manual Entry' );
            fetch c2 into c2rec;
            close c2;
            manentry(surl, null, c2rec.screen_id, 'strangp.movement', mtype, 'x', null );
            return;
         end if;
        else
         close c12;
       end if;
      else
       open c12s( msearch );
       fetch c12s into c12rec;
       if c12s%NOTFOUND
        then
         close c12s;
         open c12x;
         fetch c12x into tot;
         close c12x;
         if tot = 0
          then
            open c2( 'Manual Entry' );
            fetch c2 into c2rec;
            close c2;
            manentry(surl, null, c2rec.screen_id, 'strangp.movement', mtype, 'x', msg=>null );
            return;
         end if;
        else
         close c12s;
       end if;
     end if;
     open c2( 'Manual Entry' );
     fetch c2 into c2rec;
     close c2;
   elsif action = 'PREVIOUS'
    then
     open c12;
     lrid := NULL;
     loop
      fetch c12 into c12rec;
      if c12%NOTFOUND then c12rec.rowid := lrid; exit; end if;
      exit when c12rec.rowid = replace(rid,'~','+');
      lrid := c12rec.rowid;
     end loop;
     close c12;
     if lrid is not null then c12rec.rowid := lrid; end if;
   elsif action = 'NEXT'
    then
     open c12;
     lrid := NULL;
     loop
      fetch c12 into c12rec;
      if c12%NOTFOUND then c12rec.rowid := lrid; exit; end if;
      if c12rec.rowid = replace(rid,'~','+')
       then
        lrid := c12rec.rowid;
        fetch c12 into c12rec;
        if c12%NOTFOUND then c12rec.rowid := lrid; end if;
        exit;
      end if;
      lrid := c12rec.rowid;
     end loop;
     close c12;
   end if;
   if c12rec.rowid is null
    then
     htp.htmlopen;
      htp.header(3,'Inventory Search on' || ' : ' || msearch, 'CENTER' );
      htp.header(2,'No Results found from Search.', 'CENTER' );
      htp.header(3,'Hit the BACK Button and retry your Search.', 'CENTER' );
     htp.htmlclose;
     return;
   end if;
   manentry(surl,c12rec.rowid, c2rec.screen_id, 'strangp.movement', mtype, 'x', null );
   return;
 end if;

 if mtype = 'ME2'
  then
   open c14z(rid);
   fetch c14z into ent;
   close c14z;
   if action = 'SEARCH'
    then
     if msearch is null
      then
       open c14(ent);
       fetch c14 into c14rec;
       if c14%NOTFOUND
        then
         close c14;
         open c14x(ent);
         fetch c14x into tot;
         close c14x;
         if tot = 0
          then
            open c2( 'Manual Entry' );
            fetch c2 into c2rec;
            close c2;
            manentry_page3(surl,null, c2rec.screen_id, 'strangp.movement', mtype, 'x', null );
            return;
         end if;
        else
         close c14;
       end if;
      else
       open c14s( ent, msearch );
       fetch c14s into c14rec;
       if c14s%NOTFOUND
        then
         close c14s;
         open c14x(ent);
         fetch c14x into tot;
         close c14x;
         if tot = 0
          then
            open c2( 'Manual Entry' );
            fetch c2 into c2rec;
            close c2;
            manentry_page3(surl, null, c2rec.screen_id, 'strangp.movement', mtype, 'x', null );
            return;
         end if;
        else
         close c14s;
       end if;
     end if;
     open c2( 'Manual Entry' );
     fetch c2 into c2rec;
     close c2;
   elsif action = 'PREVIOUS'
    then
     open c14(ent);
     lrid := NULL;
     loop
      fetch c14 into c14rec;
      if c14%NOTFOUND then c14rec.rowid := lrid; exit; end if;
      exit when c14rec.rowid = replace(rid,'~','+');
      lrid := c14rec.rowid;
     end loop;
     close c14;
     if lrid is not null then c14rec.rowid := lrid; end if;
     lrid := NULL;
   elsif action = 'NEXT'
    then
     open c14(ent);
     loop
      fetch c14 into c14rec;
      if c14%NOTFOUND then c14rec.rowid := lrid; exit; end if;
      if c14rec.rowid = replace(rid,'~','+')
       then
        lrid := c14rec.rowid;
        fetch c14 into c14rec;
        if c14%NOTFOUND then c14rec.rowid := lrid; end if;
        exit;
      end if;
      lrid := c14rec.rowid;
     end loop;
     close c14;
   end if;
   if c14rec.rowid is null
    then
     htp.htmlopen;
      htp.header(3,'Inventory Search on' || ' : ' || msearch, 'CENTER' );
      htp.header(2,'No Results found from Search.', 'CENTER' );
      htp.header(3,'Hit the BACK Button and retry your Search.', 'CENTER' );
     htp.htmlclose;
     return;
   end if;
   manentry_page3(surl,c14rec.rowid, c2rec.screen_id, 'strangp.movement', mtype, 'x', null );
   return;
 end if;

 if mtype = 'TRAC'
  then
   trac_search( surl, null );
 end if;

 -- xxx copy this and convert to search on categories. use c16
if mtype = 'CTR'
  then
   open c2( 'Container Hire' );
   fetch c2 into c2rec;
   close c2;
   if action = 'SEARCH'
    then
     if msearch is null
      then
       open c15;
       fetch c15 into c15rec;
       close c15;
      else
       open c15s( msearch );
       fetch c15s into c15rec;
       close c15s;
     end if;
   elsif action = 'PREVIOUS'
    then
     open c15;
     lrid := NULL;
     loop
      fetch c15 into c15rec;
      if c15%NOTFOUND then c15rec.rowid := lrid; exit; end if;
      exit when c15rec.rowid = replace(rid,'~','+');
      lrid := c15rec.rowid;
     end loop;
     close c15;
     if lrid is not null then c15rec.rowid := lrid; end if;
   elsif action = 'NEXT'
    then
     open c15;
     lrid := NULL;
     loop
      fetch c15 into c15rec;
      if c15%NOTFOUND then c15rec.rowid := lrid; exit; end if;
      if c15rec.rowid = replace(rid,'~','+')
       then
        lrid := c15rec.rowid;
        fetch c15 into c15rec;
        if c15%NOTFOUND then c15rec.rowid := lrid; end if;
        exit;
      end if;
      lrid := c15rec.rowid;
     end loop;
     close c15;
   end if;
   if c15rec.rowid is null
    then
     htp.htmlopen;
      htp.header(3,'Duty Search on' || ' : ' || msearch, 'CENTER' );
      htp.header(2,'No Results found from Search.', 'CENTER' );
      htp.header(3,'Hit the BACK Button and retry your Search.', 'CENTER' );
     htp.htmlclose;
     return;
   end if;
   mng_ctr(surl,c15rec.rowid, c2rec.screen_id, 'Container Hire', 'x', null );
   return;
 end if;


if mtype = 'CATEG'
  then
   if action = 'SEARCH'
    then
     if msearch is null
      then
       open c16;
       fetch c16 into c16rec;
       close c16;
      else
       open c16s( msearch );
       fetch c16s into c16rec;
       close c16s;
     end if;
   elsif action = 'PREVIOUS'
    then
     open c16;
     lrid := NULL;
     loop
      fetch c16 into c16rec;
      if c16%NOTFOUND then c16rec.rowid := lrid; exit; end if;
      exit when c16rec.rowid = replace(rid,'~','+');
      lrid := c16rec.rowid;
     end loop;
     close c16;
     if lrid is not null then c16rec.rowid := lrid; end if;
   elsif action = 'NEXT'
    then
     open c16;
     lrid := NULL;
     loop
      fetch c16 into c16rec;
      if c16%NOTFOUND then c16rec.rowid := lrid; exit; end if;
      if c16rec.rowid = replace(rid,'~','+')
       then
        lrid := c16rec.rowid;
        fetch c16 into c16rec;
        if c16%NOTFOUND then c16rec.rowid := lrid; end if;
        exit;
      end if;
      lrid := c16rec.rowid;
     end loop;
     close c16;
   end if;
   if c16rec.rowid is null
    then
     htp.htmlopen;
      htp.header(3,'Duty Search on' || ' : ' || msearch, 'CENTER' );
      htp.header(2,'No Results found from Search.', 'CENTER' );
      htp.header(3,'Hit the BACK Button and retry your Search.', 'CENTER' );
     htp.htmlclose;
     return;
   end if;
   mng_categories(surl,c16rec.rowid, 'x' , 'Categories', 'x', null );
   return;
 end if;


if mtype = 'ONLOCS'
  then
   if action = 'SEARCH'
    then
     if msearch is null
      then
       open c17;
       for j in 1..10 loop
        fetch c17 into c17rec;
        if c17%FOUND then arr_rid(arr_rid.count+1) := c17rec.rowid; else exit; end if;
       end loop;
       close c17;
      else
       open c17s( msearch );
       for j in 1..10 loop
        fetch c17s into c17rec;
        if c17s%FOUND then arr_rid(arr_rid.count+1) := c17rec.rowid; else exit; end if;
       end loop;
       close c17s;
     end if;

   elsif action = 'PREVIOUS'
    then
     open c17;
     lrid := NULL;
     for j in 1..10 loop
      arr_rid(j) := null;
     end loop;

     loop
      fetch c17 into c17rec;
      if c17%NOTFOUND then c17rec.rowid := lrid; exit; end if;
      exit when c17rec.rowid = replace(rid,'~','+');
      for j in 2..10 loop
       arr_rid(j-1) := arr_rid(j);
      end loop;
      arr_rid(10) := c17rec.rowid;
      lrid := c17rec.rowid;
     end loop;

     close c17;
     if lrid is not null then c17rec.rowid := lrid; end if;

   elsif action = 'NEXT'
    then
     open c17;
     lrid := NULL;
     loop
      fetch c17 into c17rec;
      if c17%NOTFOUND then c17rec.rowid := lrid; exit; end if;
      if c17rec.rowid = replace(rid,'~','+')
       then
        lrid := c17rec.rowid;
        fetch c17 into c17rec;
        if c17%NOTFOUND then c17rec.rowid := lrid; end if;
        exit;
      end if;
      lrid := c17rec.rowid;
     end loop;
     arr_rid(arr_rid.count+1) := c17rec.rowid;
     for j in 1..9 loop
      fetch c17 into c17rec;
      if c17%FOUND then arr_rid(arr_rid.count+1) := c17rec.rowid; else exit; end if;
     end loop;
     close c17;
   end if;
   if c17rec.rowid is null
    then
     htp.htmlopen;
      htp.header(3,'Duty Search on' || ' : ' || msearch, 'CENTER' );
      htp.header(2,'No Results found from Search.', 'CENTER' );
      htp.header(3,'Hit the BACK Button and retry your Search.', 'CENTER' );
     htp.htmlclose;
     return;
   end if;
   mng_onlocs(surl, arr_rid, 'x' , 'Onhire Details', 'x', null );
   return;
 end if;


if mtype = 'OFFLOCS'
  then
   if action = 'SEARCH'
    then
     if msearch is null
      then
       open c18;
       for j in 1..10 loop
        fetch c18 into c18rec;
        if c18%FOUND then arr_rid(arr_rid.count+1) := c18rec.rowid; else exit; end if;
       end loop;
       close c18;
      else
       open c18s( msearch );
       for j in 1..10 loop
        fetch c18s into c18rec;
        if c18s%FOUND then arr_rid(arr_rid.count+1) := c18rec.rowid; else exit; end if;
       end loop;
       close c18s;
     end if;

   elsif action = 'PREVIOUS'
    then
     open c18;
     lrid := NULL;
     for j in 1..10 loop
      arr_rid(j) := null;
     end loop;

     loop
      fetch c18 into c18rec;
      if c18%NOTFOUND then c18rec.rowid := lrid; exit; end if;
      exit when c18rec.rowid = replace(rid,'~','+');
      for j in 2..10 loop
       arr_rid(j-1) := arr_rid(j);
      end loop;
      arr_rid(10) := c18rec.rowid;
      lrid := c18rec.rowid;
     end loop;

     close c18;
     if lrid is not null then c18rec.rowid := lrid; end if;

   elsif action = 'NEXT'
    then
     open c18;
     lrid := NULL;
     loop
      fetch c18 into c18rec;
      if c18%NOTFOUND then c18rec.rowid := lrid; exit; end if;
      if c18rec.rowid = replace(rid,'~','+')
       then
        lrid := c18rec.rowid;
        fetch c18 into c18rec;
        if c18%NOTFOUND then c18rec.rowid := lrid; end if;
        exit;
      end if;
      lrid := c18rec.rowid;
     end loop;
     arr_rid(arr_rid.count+1) := c18rec.rowid;
     for j in 1..9 loop
      fetch c18 into c18rec;
      if c18%FOUND then arr_rid(arr_rid.count+1) := c18rec.rowid; else exit; end if;
     end loop;
     close c18;
   end if;
   if c18rec.rowid is null
    then
     htp.htmlopen;
      htp.header(3,'Duty Search on' || ' : ' || msearch, 'CENTER' );
      htp.header(2,'No Results found from Search.', 'CENTER' );
      htp.header(3,'Hit the BACK Button and retry your Search.', 'CENTER' );
     htp.htmlclose;
     return;
   end if;
   mng_offlocs(surl, arr_rid, 'x' , 'Offhire Details', 'x', null );
   return;
 end if;

if mtype = 'CTRACK'
  then
   if action = 'SEARCH'
    then
     if msearch is null
      then
       open c19;
       fetch c19 into c19rec;
       close c19;
      else
       open c19s( msearch );
       fetch c19s into c19rec;
       close c19s;
     end if;
   elsif action = 'PREVIOUS'
    then
     open c19;
     lrid := NULL;
     loop
      fetch c19 into c19rec;
      if c19%NOTFOUND then c19rec.rowid := lrid; exit; end if;
      exit when c19rec.rowid = replace(rid,'~','+');
      lrid := c19rec.rowid;
     end loop;
     close c19;
     if lrid is not null then c19rec.rowid := lrid; end if;
   elsif action = 'NEXT'
    then
     open c19;
     lrid := NULL;
     loop
      fetch c19 into c19rec;
      if c19%NOTFOUND then c19rec.rowid := lrid; exit; end if;
      if c19rec.rowid = replace(rid,'~','+')
       then
        lrid := c19rec.rowid;
        fetch c19 into c19rec;
      lrid := c19rec.rowid;
        if c19%NOTFOUND then c19rec.rowid := lrid; end if;
        exit;
      end if;
     end loop;
     close c19;
   end if;
   ctr_track(surl, c19rec.rowid, 'x', 'Container Tracking', 'x', null );
   return;
 end if;

 if mtype = 'MASTERPLAN'
  then
   -- Sallue said SD is the next Saturday
   sd := trunc(next_day(sysdate,'SATURDAY'));
   masterplan(surl, sd );
   return;
 end if;

exception when others then
 error_details( 'STRANGP', 'MENU',null,null,errmsg=>sqlerrm,extdet=>'MTYPE:' || mtype);
end menu;

procedure search( surl in varchar2, msearch in varchar2, curr_rowid in varchar2, samerow in boolean DEFAULT FALSE, buttons_only in boolean DEFAULT FALSE, override_top in varchar2 default null, search_only in boolean DEFAULT FALSE, button_text in varchar2 default NULL, lmnu in rowid default null, first_rid in varchar2 default null, xtra1 in varchar2 default null, xtra2 in varchar2 default null, xtra3 in varchar2 default null, colspan in varchar2 default '1', norder in varchar2 default null )
as
 ctrg	varchar2(20);
 vchr   char(1);
begin
 if not samerow
  then
   htp.tableopen( cattributes=>'class="str3_table"' );
   htp.tablerowopen;
 end if;
 if not buttons_only
  then
   if not search_only then htp.p( '<td class="str1_cell_left" colspan="' || colspan || '">' ); end if;
   htp.formopen( 'strangp.menu', ctarget=>'_top' );
   htp.formhidden( 'SURL', surl );
   htp.formhidden( 'MTYPE', msearch );
   htp.formhidden( 'ACTION', 'SEARCH' );
   htp.formhidden( 'RID', replace(first_rid,'~','+') );
   htp.formhidden( 'RND', to_char(sysdate, 'SSSSS' ));
   htp.formhidden( 'XTRA1', xtra1);
   htp.formhidden( 'XTRA2', xtra2);
   htp.formhidden( 'XTRA3', xtra3);
   if search_only
    then
     htp.formtext( 'MSEARCH', 5, 100 );
    else
     htp.formtext( 'MSEARCH', 20, 100 );
   end if;
   htp.formsubmit( null, nvl(button_text,'Search') );
   htp.formclose;
   if search_only then return; end if;
   htp.p( '</TD>' );
   ctrg := '_top';
  else
   ctrg := '_self';
 end if;

 ctrg := nvl(override_top,ctrg);
 htp.p( '<td class="str1_bg_left">' );
 if first_rid is not null then vchr := 'M'; end if;
 if msearch = 'RECEIVALS'
  then
   htp.anchor2( 'strangp.menu?surl=' || surl || '&mtype=' || msearch || '&rnd=' || to_char(sysdate,'SSSSS') || '&action=PREVIOUS' || vchr || '&rid=' || replace(nvl(first_rid,curr_rowid),'+','~') || '&norder=' || xtra1 || '&n_local=' || xtra2 || '&xtra3=' || xtra3, htf.img( INSTALL_PARAMETERS.IMAGE_LOCATION || 'str/' || 'adminc_previous.gif',calt=>'Previous Record' ), ctarget=>ctrg );
   htp.anchor2( 'strangp.menu?surl=' || surl || '&mtype=' || msearch || '&rnd=' || to_char(sysdate,'SSSSS') || '&action=NEXT' || vchr || '&rid=' || replace(curr_rowid,'+','~') || '&norder=' || xtra1 || '&n_local=' || xtra2 || '&xtra3=' || xtra3, htf.img( INSTALL_PARAMETERS.IMAGE_LOCATION || 'str/' || 'adminc_next.gif',calt=>'Next Record' ), ctarget=>ctrg );
 elsif msearch in ('CARGO','CONMOV','CONVOY','AIRWAY')
  then
   htp.anchor2( 'strangp.menu?surl=' || surl || '&mtype=' || msearch || '&rnd=' || to_char(sysdate,'SSSSS') || '&action=PREVIOUS' || vchr || '&rid=' || replace(nvl(first_rid,curr_rowid),'+','~') || '&norder=' || norder || '&n_local=LA' || '&xtra1=' || xtra1 || '&xtra2=' || xtra2 || '&xtra3=' || xtra3, htf.img( INSTALL_PARAMETERS.IMAGE_LOCATION || 'str/' || 'adminc_previous.gif',calt=>'Previous Record' ), ctarget=>ctrg );
   htp.anchor2( 'strangp.menu?surl=' || surl || '&mtype=' || msearch || '&rnd=' || to_char(sysdate,'SSSSS') || '&action=NEXT' || vchr || '&rid=' || replace(curr_rowid,'+','~') || '&norder=' || norder || '&n_local=LA' || '&xtra1=' || xtra1 || '&xtra2=' || xtra2 || '&xtra3=' || xtra3, htf.img( INSTALL_PARAMETERS.IMAGE_LOCATION || 'str/' || 'adminc_next.gif',calt=>'Next Record' ), ctarget=>ctrg );
  else
   htp.anchor2( 'strangp.menu?surl=' || surl || '&mtype=' || msearch || '&rnd=' || to_char(sysdate,'SSSSS') || '&action=PREVIOUS' || vchr || '&rid=' || replace(curr_rowid,'+','~') || '&norder=' || xtra1 || '&n_local=' || xtra2 || '&xtra3=' || xtra3, htf.img( INSTALL_PARAMETERS.IMAGE_LOCATION || 'str/' || 'adminc_previous.gif',calt=>'Previous Record' ), ctarget=>ctrg );
   if lmnu is null
    then
     htp.anchor2( 'strangp.menu?surl=' || surl || '&mtype=' || msearch || '&rnd=' || to_char(sysdate,'SSSSS') || '&action=NEXT' || vchr || '&rid=' || replace(curr_rowid,'+','~') || '&norder=' || xtra1 || '&n_local=' || xtra2 || '&xtra3=' || xtra3, htf.img( INSTALL_PARAMETERS.IMAGE_LOCATION || 'str/' || 'adminc_next.gif',calt=>'Next Record' ), ctarget=>ctrg );
    else
     htp.anchor2( 'strangp.menu?surl=' || surl || '&mtype=' || msearch || '&rnd=' || to_char(sysdate,'SSSSS') || '&action=NEXT' || vchr || '&rid=' || replace(lmnu,'+','~') || '&norder=' || xtra1 || '&n_local=' || xtra2 || '&xtra3=' || xtra3, htf.img( INSTALL_PARAMETERS.IMAGE_LOCATION || 'str/' || 'adminc_next.gif',calt=>'Next Record' ), ctarget=>ctrg );
   end if;
 end if;
 htp.p( '</td>' );
 if not samerow
  then
   htp.tablerowclose;
   htp.tableclose;
 end if;
end search;

procedure duty_edit(surl in varchar2, entry in number )
as

 cursor c1(entry number) is select rowid from strang.duty where entry_no = entry;
 cursor c2( sname varchar2 ) is select screen_id from oltp_overview where screen_name = sname;

 c1rec	c1%ROWTYPE;
 c2rec	c2%ROWTYPE;

begin
 open c1(entry);
 fetch c1 into c1rec;
 close c1;
 open c2( 'Duty' );
 fetch c2 into c2rec;
 close c2;
 duty_edit(surl,c1rec.rowid,c2rec.screen_id, 'DUTY', 'x', null );
end duty_edit;

procedure duty_edit(surl in varchar2, rid in varchar2, scid in varchar2, parm in varchar2, access_id in varchar2 default null, msg in varchar2 default null )
as

 cursor c2(rid rowid) is select * from strang.duty where rowid = rid;


 c2rec		c2%ROWTYPE;
 sts		varchar2(100);
 vaccess	varchar2(20);

begin
 if not dapi.init( surl, 'STRANGP.DUTY_EDIT', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'DUTY_EDIT' );
    return;
 end if;

 vaccess := data_access( 'DUTY' );

 main_title( 'Duty Management',helpid=>'STR38');

 htp.p( '<CENTER>' );
  if vaccess = 'NONE' then htp.bold( 'Access Denied' ); htp.htmlclose; return; end if;
  if access_id <> 'z'
    then
     open c2(replace(rid,'~','+'));
     fetch c2 into c2rec;
     close c2;
  end if;

 htp.tableopen;
 htp.tablerowopen;
 htp.p( '<td class="str2_align_center">' );
 if vaccess = 'EDIT'
  then
   htp.formopen( 'strangp.accept_duty' );
   htp.formhidden( 'SURL', surl );
   htp.formhidden( 'SCID', scid );
   htp.formhidden( 'PARM', parm );
   htp.formhidden( 'ACCESS_ID', access_id );
 end if;

 if access_id = 'z'
  then
   htp.formhidden( 'RID', null );
  else
   htp.formhidden( 'RID', replace(rid,'~','+') );
 end if;

 htp.tableopen( cattributes=>'class="str1_table"' );
  htp.tablerowopen;
     htp.tabledata( htf.bold('Entry No'),cattributes=>'class="str1_bg_left"');
     htp.tabledata( htf.bold( strang.ent.get_entry_no(c2rec.entry_no) ),cattributes=>'class="str1_bg_left"');
  htp.tablerowclose;
  htp.tablerowopen;
     htp.tabledata( htf.bold('Warrant No'),cattributes=>'class="str1_bg_left"');
     if vaccess = 'EDIT'
      then
       htp.tabledata( htf.formtext( 'P1', 20, 100, c2rec.warrant_no ) ,cattributes=>'class="str1_bg_left"');
      else
       htp.tabledata( htf.bold( c2rec.warrant_no ),cattributes=>'class="str1_bg_left"');
     end if;
  htp.tablerowclose;
  htp.tablerowopen;
     htp.tabledata( htf.bold('Cheque'),cattributes=>'class="str1_bg_left"');
     if vaccess = 'EDIT'
      then
       htp.tabledata( htf.formtext( 'P2', 20, 100, c2rec.cheque ) ,cattributes=>'class="str1_bg_left"');
      else
       htp.tabledata( htf.bold( c2rec.cheque ),cattributes=>'class="str1_bg_left"');
     end if;
  htp.tablerowclose;

  htp.tablerowopen;
     htp.tabledata( htf.bold('Guarrantee Amount'),cattributes=>'class="str1_bg_left"');
     if vaccess = 'EDIT'
      then
       htp.tabledata( htf.formtext( 'P3', 20, 100, c2rec.guarrantee_amount ) ,cattributes=>'class="str1_bg_left"');
      else
       htp.tabledata( htf.bold( c2rec.guarrantee_amount ),cattributes=>'class="str1_bg_left"');
     end if;
  htp.tablerowclose;
  htp.tablerowopen;
     htp.tabledata( htf.bold('Guarrantee Date'),cattributes=>'class="str1_bg_left"');
     if vaccess = 'EDIT'
      then
       htp.tabledata( htf.formtext( 'P4', 20, 100, to_char(c2rec.guarrantee_date,LNG_MASK) ) ,cattributes=>'class="str1_bg_left"');
      else
       htp.tabledata( htf.bold( to_char(c2rec.guarrantee_date,LNG_MASK) ),cattributes=>'class="str1_bg_left"');
     end if;
  htp.tablerowclose;
  htp.tablerowopen;
     htp.tabledata( htf.bold('Total Invoice'),cattributes=>'class="str1_bg_left"');
     htp.tabledata( htf.bold( to_char(nvl(c2rec.total_invoice,0),G_STR_FRMT_06) ),cattributes=>'class="str1_cell_right"');
  htp.tablerowclose;
  htp.tablerowopen;
     htp.tabledata( htf.bold('Ratio Factor'),cattributes=>'class="str1_bg_left"');
     htp.tabledata( htf.bold( to_char(c2rec.ratio_factor,G_STR_FRMT_08) ),cattributes=>'class="str1_cell_right"');
  htp.tablerowclose;
  htp.tablerowopen;
     htp.tabledata( htf.bold('Correct Freight'),cattributes=>'class="str1_bg_left"');
     htp.tabledata( htf.bold( to_char(nvl(c2rec.correct_freight,0),G_STR_FRMT_06) ),cattributes=>'class="str1_cell_right"');
  htp.tablerowclose;
  htp.tablerowopen;
     htp.tabledata( htf.bold('Other Costs'),cattributes=>'class="str1_bg_left"');
     htp.tabledata( htf.bold( to_char(nvl(c2rec.other_costs,0),G_STR_FRMT_06) ),cattributes=>'class="str1_cell_right"');
  htp.tablerowclose;
  htp.tablerowopen;
     htp.tabledata( htf.bold('Insurance'),cattributes=>'class="str1_bg_left"');
     htp.tabledata( htf.bold( to_char(nvl(c2rec.insurance,0),G_STR_FRMT_06) ),cattributes=>'class="str1_cell_right"');
  htp.tablerowclose;
  htp.tablerowopen;
     htp.tabledata( htf.bold('Previous Internal No'),cattributes=>'class="str1_bg_left"');
     htp.tabledata( htf.bold( nvl(to_char(c2rec.previous_entry_no),'&nbsp;') ),cattributes=>'class="str1_cell_right"');
  htp.tablerowclose;
  htp.tablerowopen;
     htp.tabledata( htf.bold('Duty'),cattributes=>'class="str1_bg_left"');
     htp.tabledata( htf.bold( to_char(nvl(c2rec.duty,0),G_STR_FRMT_06) ),cattributes=>'class="str1_cell_right"');
  htp.tablerowclose;
  htp.tablerowopen;
     htp.tabledata( htf.bold('Excise'),cattributes=>'class="str1_bg_left"');
     htp.tabledata( htf.bold( to_char(nvl(c2rec.excise,0),G_STR_FRMT_06) ),cattributes=>'class="str1_cell_right"');
  htp.tablerowclose;
  htp.tablerowopen;
     htp.tabledata( htf.bold('Vat'),cattributes=>'class="str1_bg_left"');
     htp.tabledata( htf.bold( to_char(nvl(c2rec.vat,0),G_STR_FRMT_06) ),cattributes=>'class="str1_cell_right"');
  htp.tablerowclose;
  htp.tablerowopen;
     htp.tabledata( htf.bold('Levy'),cattributes=>'class="str1_bg_left"');
     htp.tabledata( htf.bold( to_char(nvl(c2rec.levy,0),G_STR_FRMT_06) ),cattributes=>'class="str1_bg_left"');
  htp.tablerowclose;
  htp.tablerowopen;
     htp.tabledata( htf.bold('Exchange Rate'),cattributes=>'class="str1_bg_left"');
     htp.tabledata( htf.bold('PVariance'),cattributes=>'class="str1_bg_left"');
     htp.tabledata( htf.bold( to_char(nvl(c2rec.exrate,0),9990.9999)),cattributes=>'class="str1_bg_left"');
  htp.tablerowclose;
  htp.tablerowopen;
     htp.tabledata( htf.bold( to_char(nvl(c2rec.pvariance,0),G_STR_FRMT_06) ),cattributes=>'class="str1_cell_right"');
  htp.tablerowclose;
 htp.tableclose;
 htp.nl;

 if data_access('SAD' ) = 'EDIT'
  then
   htp.anchor( 'javascript: window.open(''' || 'strangs.list_entry?surl=' || surl || ''',''' || 'SAD_ENTRY' || ''',''height=800,width=1200,scrollbars=yes,resizable=yes'');void('''');', '[Find SAD]' );
   htp.anchor( 'javascript: window.open(''' || 'strangs.edit_entry?surl=' || surl || '&pk=' || c2rec.entry_no || ''',''' || 'SAD_ENTRY' || ''',''height=800,width=1200,scrollbars=yes,resizable=yes'');void('''');', '[Edit SAD:' || strang.ent.get_entry_no(c2rec.entry_no) || ']' );
   htp.nl;
 end if;

 htp.nl;
 htp.tableopen( cattributes=>'class="str1_table4"' );
 htp.tablerowopen;
 if vaccess = 'EDIT'
  then
   if access_id = 'z'
    then
     htp.tabledata( htf.formsubmit( 'ACTION', 'Insert New Duty' ),cattributes=>'VALIGN="TOP"');
    else
     htp.tabledata( htf.formsubmit( 'ACTION', 'Update Duty' ),cattributes=>'VALIGN="TOP"');
   end if;
   htp.formclose;
 end if;
 search( surl, 'DUTY', rid, samerow=>TRUE );
 htp.tablerowclose;
 htp.tableclose;
 if msg is not null
  then
   header_msg( msg );
 end if;
 htp.p( '</CENTER>' );
 htp.htmlclose;
exception when others then
 error_details( 'STRANGP', 'DUTY_EDIT',null,null,errmsg=>sqlerrm,extdet=>'PARM:' || parm);
end duty_edit;

procedure accept_duty( surl in varchar2, scid in integer, parm in varchar2, access_id in varchar2, rid in varchar2, action in varchar2, p1 in varchar2, p2 in varchar2 , p3 in varchar2 , p4 in varchar2 )
as


 newrid		rowid;
 sts		varchar2(100);
 nmb1		number;
 nmb2		number;

begin
 if not dapi.init( surl, 'STRANGP.ACCEPT_DUTY', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'ACCEPT_DUTY' );
    return;
 end if;

 update strang.duty
  set
   warrant_no = p1,
   cheque = p2,
   guarrantee_amount = p3,
   guarrantee_date = p4
  where
   rowid = chartorowid( replace(rid,'~','+') );

 commit;

 duty_edit( surl, rid, scid, parm, access_id, 'Duty Record Successfully Updated' );

exception when others then
 error_details( 'STRANGP', 'ACCEPT_DUTY',null,null,errmsg=>sqlerrm,extdet=>'PARM:' || parm);
end accept_duty;

procedure generate_entry(vship_id in integer, vste in varchar2)
as
  cursor c2( vship_id integer) is
   select /*+ ALL_ROWS */ distinct r.cust_customer_id vcust_id
   from strang.detailrs dr, strang.receivals r,strang.movements m, strang.customers c
   where
    m.ship_id = ship_id and
    nvl(dr.camov_seal,'|') = nvl(m.seal,'|') and
    m.movement_no = dr.movement_no and
    dr.deliveryno = r.deliveryno and
    r.cust_customer_id = c.customer_id and
    c.customs_agent is not null
    order by r.cust_customer_id;

 cursor c3( vship_id integer, vcust_id integer ) is
  select /*+ ALL_ROWS */ r.cust_customer_id, dr.deliveryno,dr.rowid,r.supplier_customer_id
  from strang.detailrs dr, strang.receivals r,strang.movements m, strang.customers c
  where
   m.ship_id = vship_id and
   nvl(dr.camov_seal,'|') = nvl(m.seal,'|') and
   m.movement_no = dr.movement_no and
   dr.deliveryno = r.deliveryno and
   nvl(r.cust_customer_id,0) = vcust_id and
   nvl(r.cust_customer_id,0) = nvl(c.customer_id,0) and
   c.customs_agent is not null
  order by dr.line_no,dr.deliveryno,dr.itemno;

 cursor c4(vcust_id number) is
  select nvl(max(entry_no),vcust_id) tot
   from strang.detailrs
   where entry_no >= vcust_id and
   entry_no < (vcust_id + 1);

 cursor c5( dlr integer ) is select min(entry_no) entry_no from strang.detailrs dr where deliveryno = dlr;
 cursor c5a( dlr integer, ent number ) is select entry_no from strang.detailrs dr where deliveryno = dlr and entry_no = ent;


 c2rec		 c2%ROWTYPE;
 c3rec		 c3%ROWTYPE;
 c4rec		 c4%ROWTYPE;
 c5rec		 c5%ROWTYPE;
 c5arec		 c5a%ROWTYPE;
 currcustomer    integer;
 currsupplier    integer;
 is_maincustomer boolean;
 is_partshipment boolean;
 is_loop	 boolean;
 created_duty	 boolean;

begin

for c2rec in c2( vShip_id ) loop

open c4( c2rec.vcust_id );
fetch c4 into c4rec;
close c4;
c4rec.tot := nvl(c4rec.tot,0);
currcustomer:= c2rec.vcust_id;
currsupplier := 0;
is_partshipment := FALSE;
is_loop := FALSE;
created_duty := FALSE;

for c3rec in c3( vShip_id, c2rec.vcust_id ) loop

 c5rec.entry_no := NULL;
 c5arec.entry_no := NULL;
 open c5(c3rec.deliveryno);
 fetch c5 into c5rec;
 close c5;
 open c5a(c3rec.deliveryno,c4rec.tot);
 fetch c5a into c5arec;
 close c5a;

 if currsupplier <> c3rec.supplier_customer_id
  then
   is_partshipment := FALSE;
   is_loop := FALSE;
 end if;

 if not is_loop
  then

   if c5rec.entry_no is null
    then
     is_partshipment := FALSE;
    else
     is_partshipment := TRUE;
   end if;

   if c5arec.entry_no is null and is_partshipment
    then
     is_loop := TRUE;
    else
     is_loop := FALSE;
   end if;

 end if;

 if not (is_partshipment and is_loop)
  then

   if currsupplier = 0 or
      currsupplier = c3rec.supplier_customer_id
    then
     if currsupplier = 0
     then
       if created_duty
       then
--        gl.dbg('Inner loop : ' || c4rec.tot ||' ' || c2rec.vcust_id );
        create_duty( vship_id, c4rec.tot, c2rec.vcust_id);
       end if;
       c4rec.tot := c4rec.tot + 0.0000001;
     end if;
     update strang.detailrs
      set
       entry_no = c4rec.tot
      where
      rowid = c3rec.rowid;
    else
     if created_duty then
--     gl.dbg('Inner loop 2: ' || c4rec.tot ||' ' || c2rec.vcust_id );
     create_duty( vship_id, c4rec.tot,c2rec.vcust_id ); end if;
     c4rec.tot := c4rec.tot + 0.0000001;
     update strang.detailrs
      set
       entry_no = c4rec.tot
      where
      rowid = c3rec.rowid;
    end if;
    created_duty := TRUE;

  else

     if created_duty then
--     gl.dbg('Inner loop 3: ' || c4rec.tot ||' ' || c2rec.vcust_id );
     create_duty( vship_id, c4rec.tot,c2rec.vcust_id ); end if;
     c4rec.tot := c4rec.tot + 0.0000001;
     update strang.detailrs
      set
       entry_no = c4rec.tot
      where
      rowid = c3rec.rowid;

  created_duty := TRUE;

 end if;

 currsupplier := c3rec.supplier_customer_id;

 end loop;
 -- Last Entry No has yet to be generated
 if created_duty then
--  gl.dbg('Outer loop : ' || c4rec.tot ||' ' || c2rec.vcust_id );
  Create_duty( vship_id, c4rec.tot,c2rec.vcust_id ); end if;
end loop;
end generate_entry;

--- 20170518
procedure generate_entry_airfreight(vship_id in integer, vste in varchar2)
as
  cursor c2( vship_id integer) is
   select /*+ ALL_ROWS */ distinct r.cust_customer_id vcust_id
   from strang.detailrs dr, strang.receivals r,strang.movements m, strang.customers c
   where
    m.ship_id = ship_id and
    nvl(dr.camov_seal,'|') = nvl(m.seal,'|') and
    m.movement_no = dr.movement_no and
    dr.deliveryno = r.deliveryno and
    r.cust_customer_id = c.customer_id and
    c.customs_agent is not null
    order by r.cust_customer_id;

 cursor c3( vship_id integer, vcust_id integer ) is
  select /*+ ALL_ROWS */ r.cust_customer_id, dr.deliveryno,dr.rowid,r.supplier_customer_id,dr.hawb_hawbno
  from strang.detailrs dr, strang.receivals r,strang.movements m, strang.customers c
  where
   m.ship_id = vship_id and
   nvl(dr.camov_seal,'|') = nvl(m.seal,'|') and
   m.movement_no = dr.movement_no and
   dr.deliveryno = r.deliveryno and
   nvl(r.cust_customer_id,0) = vcust_id and
   nvl(r.cust_customer_id,0) = nvl(c.customer_id,0) and
   c.customs_agent is not null
  order by dr.line_no,dr.deliveryno,dr.itemno;

 cursor c4(vcust_id number) is
  select nvl(max(entry_no),vcust_id) tot
   from strang.detailrs
   where entry_no >= vcust_id and
   entry_no < (vcust_id + 1);

 cursor c5( dlr integer ) is select min(entry_no) entry_no from strang.detailrs dr where deliveryno = dlr;
 cursor c5a( dlr integer, ent number ) is select entry_no from strang.detailrs dr where deliveryno = dlr and entry_no = ent;


 c2rec		 c2%ROWTYPE;
 c3rec		 c3%ROWTYPE;
 c4rec		 c4%ROWTYPE;
 c5rec		 c5%ROWTYPE;
 c5arec		 c5a%ROWTYPE;
 currcustomer    integer;
 currhawb	 integer;
 is_maincustomer boolean;
 is_partshipment boolean;
 is_loop	 boolean;
 created_duty	 boolean;

begin

for c2rec in c2( vShip_id ) loop

open c4( c2rec.vcust_id );
fetch c4 into c4rec;
close c4;
c4rec.tot := nvl(c4rec.tot,0);
currcustomer:= c2rec.vcust_id;
currhawb := 0;
is_partshipment := FALSE;
is_loop := FALSE;
created_duty := FALSE;

for c3rec in c3( vShip_id, c2rec.vcust_id ) loop

 c5rec.entry_no := NULL;
 c5arec.entry_no := NULL;
 open c5(c3rec.deliveryno);
 fetch c5 into c5rec;
 close c5;
 open c5a(c3rec.deliveryno,c4rec.tot);
 fetch c5a into c5arec;
 close c5a;

 if currhawb <> c3rec.hawb_hawbno
  then
   is_partshipment := FALSE;
   is_loop := FALSE;
 end if;

 if not is_loop
  then

   if c5rec.entry_no is null
    then
     is_partshipment := FALSE;
    else
     is_partshipment := TRUE;
   end if;

    else
   if c5arec.entry_no is null and is_partshipment
    then
     is_loop := TRUE;
     is_loop := FALSE;
   end if;

 end if;

 if not (is_partshipment and is_loop)
  then

   if currhawb = 0 or
      currhawb = c3rec.hawb_hawbno
    then
     if currhawb = 0
     then
       if created_duty
       then
--        gl.dbg('Inner loop : ' || c4rec.tot ||' ' || c2rec.vcust_id );
        create_duty( vship_id, c4rec.tot, c2rec.vcust_id);
       end if;
       c4rec.tot := c4rec.tot + 0.0000001;
     end if;
     update strang.detailrs
      set
       entry_no = c4rec.tot
      where
      rowid = c3rec.rowid;
    else
     if created_duty then
--     gl.dbg('Inner loop 2: ' || c4rec.tot ||' ' || c2rec.vcust_id );
     create_duty( vship_id, c4rec.tot,c2rec.vcust_id ); end if;
     c4rec.tot := c4rec.tot + 0.0000001;
     update strang.detailrs
      set
       entry_no = c4rec.tot
      where
      rowid = c3rec.rowid;
    end if;
    created_duty := TRUE;

  else

     if created_duty then
--     gl.dbg('Inner loop 3: ' || c4rec.tot ||' ' || c2rec.vcust_id );
     create_duty( vship_id, c4rec.tot,c2rec.vcust_id ); end if;
     c4rec.tot := c4rec.tot + 0.0000001;
     update strang.detailrs
      set
       entry_no = c4rec.tot
      where
      rowid = c3rec.rowid;

  created_duty := TRUE;

 end if;

 currhawb := c3rec.hawb_hawbno;

 end loop;
 -- Last Entry No has yet to be generated
 if created_duty then
--  gl.dbg('Outer loop : ' || c4rec.tot ||' ' || c2rec.vcust_id );
  Create_duty( vship_id, c4rec.tot,c2rec.vcust_id ); end if;
end loop;
end generate_entry_airfreight;

--- 20170518

procedure create_duty(vship_id varchar2, entryno number, vcust_id integer)
as

 cursor c3( vship_id integer, entryno in number, vcust_id integer ) is
  select dr.rowid,dr.deliveryno,entry_no,line_no, l2.description rate, round(c.freight/l3.description,2) freight,c.insurance,c.other_costs,c.vat, c.infreight, c.deductions,
         m.bol,nvl(m.container_type,'BREAK BULK') container_type,r.supplier_customer_id supplier, r.curr, sa.estarrive, c.levy_rate
  from strang.detailrs dr, strang.movements m, strang.lov l, strang.ships_airway sa, strang.receivals r, strang.lov l2, strang.customers c, strang.lov l3
  where
   m.ship_id = vship_id and
   sa.ship_id = m.ship_id and
   nvl(m.container_type,'BREAK BULK') = l.code and
   l.lov_name = 'CTRTYPE' and
   l2.lov_name = 'UNRATTAB' and
   l2.code = r.curr and
   to_date(gl.guess_date(l2.cola),'DD-MON-YYYY') <= sa.estarrive and
   nvl(to_date(gl.guess_date(l2.colb),'DD-MON-YYYY'),sa.estarrive) >= sa.estarrive and
   l3.lov_name = 'UNRATTAB' and
   l3.code = 'USD' and
   to_date(gl.guess_date(l3.cola),'DD-MON-YYYY') <= sa.estarrive and
   nvl(to_date(gl.guess_date(l3.colb),'DD-MON-YYYY'),sa.estarrive) >= sa.estarrive and
   r.deliveryno = dr.deliveryno and
   r.cust_customer_id = c.customer_id and
   dr.movement_no = m.movement_no and
   nvl(dr.camov_seal,'|') = nvl(seal,'|') and
   dr.entry_no = entryno;

cursor c5( entryno number ) is
  select /*+ ALL_ROWS */ sum(p.tamount) tot
  from strang.pos p
  where p.deliveryno in
   (select distinct dr.deliveryno
    from strang.detailrs dr
    where entry_no = entryno
   );

cursor c5a( entryno number ) is
  select /*+ ALL_ROWS */ sum(nvl(p.delivery_charge,0)) totdc
  from strang.pos p
  where p.deliveryno in
   (select distinct dr.deliveryno
    from strang.detailrs dr
    where entry_no = entryno
   );

 cursor c7a( entryno number, vat number, ratio_factor number ) is
 select /*+ ALL_ROWS */ sum(kvalue) kvalue, sum(duty) duty, sum(excise) excise, sum(vat) vat,sum(old_duty) old_duty
 from
 (
  select /*+ ALL_ROWS */
       sum(tamount) * nvl(ratio_factor,1) kvalue,
       sum(tamount) * nvl(ratio_factor,1) * (nvl(to_number(t.description),0)/100) duty,
       ((sum(tamount) * nvl(ratio_factor,1)) + (sum(tamount) * nvl(ratio_factor,1) * (nvl(to_number(t.description),0)/100))) * (nvl(to_number(t.colc),0)/100) excise,
       ((sum(tamount) * nvl(ratio_factor,1)) + (sum(tamount) * nvl(ratio_factor,1) * (nvl(to_number(t.description),0)/100)) +
        (((sum(tamount) * nvl(ratio_factor,1)) + (sum(tamount) * nvl(ratio_factor,1) * (nvl(to_number(t.description),0)/100))) * (nvl(to_number(t.colc),0)/100))
       ) * (nvl(vat,0)/100) vat,
       (t.colb * sum(tamount) * nvl(ratio_factor,1)) / 100 old_duty
from strang.lov i, strang.pos p, strang.lov t
where i.code = p.inventoryno and
      i.lov_name = 'INVENT' and
      t.lov_name = 'TARIFF' and
      p.deliveryno in
         (select distinct dr.deliveryno
          from strang.detailrs dr
          where entry_no = entryno
      ) and
      t.code = i.cola
group by i.description, t.code, p.ctry_countrycode, p.unit_unitused, t.colb, ratio_factor, t.description, t.colc, vat
  );

cursor c11b(shipid integer, entryno number, fr number ) is
  select /*+ ALL_ROWS */ sum(strang.revenue_tonne(partweight,partvolume) * nvl(fr,0)) sm
  from strang.detailrs dr, strang.movements m
  where m.ship_id=shipid and
        m.movement_no = dr.movement_no and
        nvl(dr.camov_seal,'|') = nvl(seal,'|') and
        dr.deliveryno in
         (select dr2.deliveryno from strang.detailrs dr2 where dr2.entry_no = entryno);

cursor c11c(shipid integer, entryno number, ifr number ) is
  select /*+ ALL_ROWS */ sum(strang.revenue_tonne(partweight,partvolume) * nvl(ifr,0)) ism
  from strang.detailrs dr, strang.movements m
  where m.ship_id=shipid and
        m.movement_no = dr.movement_no and
        nvl(dr.camov_seal,'|') = nvl(seal,'|') and
        dr.deliveryno in
         (select dr2.deliveryno from strang.detailrs dr2 where dr2.entry_no = entryno);

cursor c14( dlr integer, ent number ) is
   select min(entry_no)
   from strang.detailrs dr
   where dr.deliveryno = dlr and
         entry_no <> ent;

 c3rec		c3%ROWTYPE;
 c5arec		c5a%ROWTYPE;
 c7arec		c7a%ROWTYPE;
 c11rec		c11b%ROWTYPE;
 c11crec	c11c%ROWTYPE;
 ti		number;
 tdc		number;
 dt		number;
 rf		number;
 pin		number;
 v1		number;
 v2		number;
 v3		number;
 v4		number;
 v5		number;
 v6		number;
 lv		number;

begin

    open c3(vship_id,entryno, vcust_id);
    fetch c3 into c3rec;
    close c3;
    if c3rec.entry_no is null then return; end if;
--  gl.dbg('GOT THERE : ' || C3REC.ENTRY_NO );

    -- Note: Do not set to 0. Must be Null, code relies on it to be NULL
    pin := NULL;
    open c14(c3rec.deliveryno,c3rec.entry_no);
    fetch c14 into pin;
    close c14;
    if pin is not null and pin < c3rec.entry_no then null; else pin := null; end if;

    open c5( c3rec.entry_no );
    fetch c5 into ti;
    close c5;

    open c5a( c3rec.entry_no );
    fetch c5a into tdc;
    close c5a;

    open c11b( vship_id, c3rec.entry_no, c3rec.freight );
    fetch c11b into c11rec;
    close c11b;

    open c11c( vship_id, c3rec.entry_no, c3rec.infreight );
    fetch c11c into c11crec;
    close c11c;


    v1 := ti / c3rec.rate;
    v2 := c11rec.sm;
    v3 := v1 * (c3rec.insurance/100);
    v4 := (v1 * (c3rec.other_costs/100))+(nvl(tdc,0)/c3rec.rate);
    v5 := nvl(c11crec.ism,0);
    v6 := nvl(v1 * (c3rec.deductions/100),0);
    if nvl(ti,0) = 0
     then
      rf := 0;
     else
      rf := round((v1+v2+v3+v4+v5-v6)/ti,8);
    end if;

    open c7a(c3rec.entry_no, c3rec.vat, rf);
    fetch c7a into c7arec;
    close c7a;

    if pin is null
     then
      lv := nvl(((c7arec.duty + c7arec.excise + c7arec.kvalue) * c3rec.levy_rate ) / 100 , 0);
      update strang.duty
        set
	  total_invoice = v1,
	  duty = c7arec.duty,
	  ratio_factor = rf,
	  correct_freight = round(v2,2),
	  internal_freight = round(v5,2),
	  other_costs = round(v4,2),
	  insurance = round(v3,3),
	  deductions = round(v6,2),
	  previous_entry_no= pin,
          excise = c7arec.excise,
          vat = c7arec.vat,
          pvariance = (c7arec.duty + c7arec.excise + c7arec.vat + lv) - ((c7arec.kvalue * (1.5/100)) + c7arec.old_duty),
          levy = lv,
          exrate = c3rec.rate
       where
	   entry_no = c3rec.entry_no;
      if sql%NOTFOUND
       then
         insert into strang.duty
         ( entry_no, total_invoice, duty, ratio_factor, correct_freight, internal_freight, other_costs, deductions, insurance, previous_entry_no, excise, vat, pvariance, levy, exrate )
          values
         ( c3rec.entry_no, v1, c7arec.duty, rf, round(v2,2), round(v5,2), round(v4,2), round(v6,2), round(v3,2) , pin, c7arec.excise, c7arec.vat, (c7arec.duty + c7arec.excise + c7arec.vat + lv) - ((c7arec.kvalue * (1.5/100)) + c7arec.old_duty), lv, c3rec.rate);
      end if;

    else

      -- Partshipments do not have values except form previous_entry_no
      update strang.duty
        set
	  total_invoice = null,
	  duty = null,
	  ratio_factor = null,
	  correct_freight = null,
	  internal_freight = null,
	  other_costs = null,
	  deductions = null,
	  insurance = null,
	  previous_entry_no= pin,
          excise = null,
          vat = null,
          pvariance = null,
          levy = null,
          exrate = null
       where
	   entry_no = c3rec.entry_no;
      if sql%NOTFOUND
       then
         insert into strang.duty         ( entry_no, previous_entry_no )
          values
         ( c3rec.entry_no, pin );
      end if;

    end if;

exception when others
 then
  gl.dbg('Error in Create Duty [movement.ship_id = ' || vship_id || ', detailrs.entry_no = ' || entryno || ']: ' || sqlerrm);
end create_duty;
----
procedure create_duty_com(vship_id varchar2, entryno number, vcust_id integer)
as

 cursor c3( vship_id integer, entryno in number, vcust_id integer ) is
  select dr.rowid,dr.deliveryno,entry_no_com,line_no, l2.description rate, round(c.freight/l3.description,2) freight,c.insurance,c.other_costs,c.vat, c.infreight, c.deductions,
         m.bol,nvl(m.container_type,'BREAK BULK') container_type,r.supplier_customer_id_com supplier, r.curr, sa.estarrive, c.levy_rate
  from strang.detailrs dr, strang.movements m, strang.lov l, strang.ships_airway sa, strang.receivals r, strang.lov l2, strang.customers c, strang.lov l3
  where
   m.ship_id = vship_id and
   sa.ship_id = m.ship_id and
   nvl(m.container_type,'BREAK BULK') = l.code and
   l.lov_name = 'CTRTYPE' and
   l2.lov_name = 'UNRATTAB' and
   l2.code = r.curr and
   to_date(gl.guess_date(l2.cola),'DD-MON-YYYY') <= sa.estarrive and
   nvl(to_date(gl.guess_date(l2.colb),'DD-MON-YYYY'),sa.estarrive) >= sa.estarrive and
   l3.lov_name = 'UNRATTAB' and
   l3.code = 'USD' and
   to_date(gl.guess_date(l3.cola),'DD-MON-YYYY') <= sa.estarrive and
   nvl(to_date(gl.guess_date(l3.colb),'DD-MON-YYYY'),sa.estarrive) >= sa.estarrive and
   r.deliveryno = dr.deliveryno and
   r.cust_customer_id = c.customer_id and
   dr.movement_no = m.movement_no and
   nvl(dr.camov_seal,'|') = nvl(seal,'|') and
   dr.entry_no_com = entryno;

cursor c5( entryno number ) is
  select /*+ ALL_ROWS */ sum(p.tamount) tot
  from strang.pos p
  where p.deliveryno in
   (select distinct dr.deliveryno
    from strang.detailrs dr
    where dr.entry_no_com = entryno
   );

cursor c5a( entryno number ) is
  select /*+ ALL_ROWS */ sum(nvl(p.delivery_charge,0)) totdc
  from strang.pos p
  where p.deliveryno in
   (select distinct dr.deliveryno
    from strang.detailrs dr
    where dr.entry_no_com = entryno
   );

 cursor c7a( entryno number, vat number, ratio_factor number ) is
 select /*+ ALL_ROWS */ sum(kvalue) kvalue, sum(duty) duty, sum(excise) excise, sum(vat) vat,sum(old_duty) old_duty
 from
 (
  select /*+ ALL_ROWS */
       sum(tamount) * nvl(ratio_factor,1) kvalue,
       sum(tamount) * nvl(ratio_factor,1) * (nvl(to_number(t.description),0)/100) duty,
       ((sum(tamount) * nvl(ratio_factor,1)) + (sum(tamount) * nvl(ratio_factor,1) * (nvl(to_number(t.description),0)/100))) * (nvl(to_number(t.colc),0)/100) excise,
       ((sum(tamount) * nvl(ratio_factor,1)) + (sum(tamount) * nvl(ratio_factor,1) * (nvl(to_number(t.description),0)/100)) +
        (((sum(tamount) * nvl(ratio_factor,1)) + (sum(tamount) * nvl(ratio_factor,1) * (nvl(to_number(t.description),0)/100))) * (nvl(to_number(t.colc),0)/100))
       ) * (nvl(vat,0)/100) vat,
       (t.colb * sum(tamount) * nvl(ratio_factor,1)) / 100 old_duty
from strang.lov i, strang.pos p, strang.lov t
where i.code = p.inventoryno and
      i.lov_name = 'INVENT' and
      t.lov_name = 'TARIFF' and
      p.deliveryno in
         (select distinct dr.deliveryno
          from strang.detailrs dr
          where dr.entry_no_com = entryno
      ) and
      t.code = i.cola
group by i.description, t.code, p.ctry_countrycode, p.unit_unitused, t.colb, ratio_factor, t.description, t.colc, vat
  );


cursor c11b(shipid integer, entryno number, fr number ) is
  select /*+ ALL_ROWS */ sum(strang.revenue_tonne(partweight,partvolume) * nvl(fr,0)) sm
  from strang.detailrs dr, strang.movements m
  where m.ship_id=shipid and
        m.movement_no = dr.movement_no and
        nvl(dr.camov_seal,'|') = nvl(seal,'|') and
        dr.deliveryno in
         (select dr2.deliveryno from strang.detailrs dr2 where dr2.entry_no_com = entryno);

cursor c11c(shipid integer, entryno number, ifr number ) is
  select /*+ ALL_ROWS */ sum(strang.revenue_tonne(partweight,partvolume) * nvl(ifr,0)) ism
  from strang.detailrs dr, strang.movements m
  where m.ship_id=shipid and
        m.movement_no = dr.movement_no and
        nvl(dr.camov_seal,'|') = nvl(seal,'|') and
        dr.deliveryno in
         (select dr2.deliveryno from strang.detailrs dr2 where dr2.entry_no_com = entryno);



cursor c14( dlr integer, ent number ) is   -- partshipment query 20161021
   select min(entry_no)
   from strang.detailrs dr
   where dr.deliveryno = dlr and
         entry_no < ent;

 c3rec		c3%ROWTYPE;
 c5arec		c5a%ROWTYPE;
 c7arec		c7a%ROWTYPE;
 c11rec		c11b%ROWTYPE;
 c11crec	c11c%ROWTYPE;
 ti		number;
 tdc		number;
 dt		number;
 rf		number;
 pin		number;
 v1		number;
 v2		number;
 v3		number;
 v4		number;
 v5		number;
 v6		number;
 lv		number;

begin

    open c3(vship_id,entryno, vcust_id);
    fetch c3 into c3rec;
    close c3;
    if c3rec.entry_no_com is null then return; end if;
--  gl.dbg('GOT THERE : ' || C3REC.ENTRY_NO_com );

    -- Note: Do not set to 0. Must be Null, code relies on it to be NULL
    pin := NULL;
    open c14(c3rec.deliveryno,c3rec.entry_no_com);
    fetch c14 into pin;
    close c14;
    if pin is not null and pin < c3rec.entry_no_com then null; else pin := null; end if;

    open c5( c3rec.entry_no_com );
    fetch c5 into ti;
    close c5;

    open c5a( c3rec.entry_no_com );
    fetch c5a into tdc;
    close c5a;

    open c11b( vship_id, c3rec.entry_no_com, c3rec.freight );
    fetch c11b into c11rec;
    fetch c11c into c11crec;
    close c11b;

    open c11c( vship_id, c3rec.entry_no_com, c3rec.infreight );
    close c11c;


    v1 := ti / c3rec.rate;
    v2 := c11rec.sm;
    v3 := v1 * (c3rec.insurance/100);
    v4 := (v1 * (c3rec.other_costs/100))+(nvl(tdc,0)/c3rec.rate);
    v5 := nvl(c11crec.ism,0);
    v6 := nvl(v1 * (c3rec.deductions/100),0);
    if nvl(ti,0) = 0
     then
      rf := 0;
     else
      rf := round((v1+v2+v3+v4+v5-v6)/ti,8);
    end if;

    open c7a(c3rec.entry_no_com, c3rec.vat, rf);
    fetch c7a into c7arec;
    close c7a;

    if pin is null
     then
      lv := nvl(((c7arec.duty + c7arec.excise + c7arec.kvalue) * c3rec.levy_rate ) / 100 , 0);
      update strang.duty
        set
	  total_invoice = v1,
	  duty = c7arec.duty,
	  ratio_factor = rf,
	  correct_freight = round(v2,2),
	  internal_freight = round(v5,2),
	  other_costs = round(v4,2),
	  insurance = round(v3,3),
	  deductions = round(v6,2),
	  previous_entry_no= pin,
          excise = c7arec.excise,
          vat = c7arec.vat,
          pvariance = (c7arec.duty + c7arec.excise + c7arec.vat + lv) - ((c7arec.kvalue * (1.5/100)) + c7arec.old_duty),
          levy = lv,
          exrate = c3rec.rate
       where
	   entry_no = c3rec.entry_no_com;
      if sql%NOTFOUND
       then
         insert into strang.duty
         ( entry_no, total_invoice, duty, ratio_factor, correct_freight, internal_freight, other_costs, deductions, insurance, previous_entry_no, excise, vat, pvariance, levy, exrate )
          values
         ( c3rec.entry_no_com, v1, c7arec.duty, rf, round(v2,2), round(v5,2), round(v4,2), round(v6,2), round(v3,2) , pin, c7arec.excise, c7arec.vat, (c7arec.duty + c7arec.excise + c7arec.vat + lv) - ((c7arec.kvalue * (1.5/100)) + c7arec.old_duty), lv, c3rec.rate);
      end if;

    else

      -- Partshipments do not have values except form previous_entry_no
      update strang.duty
        set
	  total_invoice = null,
	  duty = null,
	  ratio_factor = null,
	  correct_freight = null,
	  internal_freight = null,
	  other_costs = null,
	  deductions = null,
	  insurance = null,
	  previous_entry_no= pin,
          excise = null,
          vat = null,
          pvariance = null,
          levy = null,
          exrate = null
       where
	   entry_no = c3rec.entry_no_com;
      if sql%NOTFOUND
       then
         insert into strang.duty
         ( entry_no, previous_entry_no )
          values
         ( c3rec.entry_no_com, pin );
      end if;

    end if;

exception when others
 then
  gl.dbg('Error in Create Duty [movement.ship_id = ' || vship_id || ', detailrs.entry_no_com = ' || entryno || ']: ' || sqlerrm);
end create_duty_com;

---
procedure create_line_no( vShip_id integer, typ in varchar2 )
as

 cursor c1( vship_id integer ) is
  select dr.rowid
  from strang.detailrs dr, strang.movements m, strang.lov l, strang.receivals r, strang.customers c
  where
   m.ship_id = vship_id and
   nvl(m.container_type,'BREAK BULK') = l.code and
   l.lov_name = 'CTRTYPE' and
   dr.movement_no = m.movement_no and
   nvl(dr.camov_seal,'|') = nvl(seal,'|') and
   dr.deliveryno = r.deliveryno and
   r.supplier_customer_id = c.customer_id
  order by m.movement_type,nvl(l.cola,chr(32)),m.bol,m.container_type,m.movement_no,c.customer, dr.deliveryno,dr.itemno;

 cursor c1m( vship_id integer ) is
  select dr.rowid
  from strang.detailrs dr, strang.movements m, strang.receivals r, strang.customers c
  where
   m.ship_id = vship_id and
   dr.movement_no = m.movement_no and
   nvl(dr.camov_seal,'|') = nvl(m.seal,'|') and
   dr.deliveryno = r.deliveryno and
   r.supplier_customer_id = c.customer_id
  order by m.movement_no,c.customer, dr.deliveryno,dr.itemno;

 ctr		integer;

begin

 ctr := 1;

 if typ = 'SHIP'
  then
   for c1rec in c1(to_number(vship_id)) loop
    update strang.detailrs set line_no = ctr where rowid = c1rec.rowid;
    ctr := ctr + 1;
   end loop;

 elsif typ = 'AIRWAY'
  then
   for c1mrec in c1m(vship_id) loop
    update strang.detailrs set line_no = ctr where rowid = c1mrec.rowid;
    ctr := ctr + 1;
   end loop;
 end if;

end create_line_no;

procedure unallocate_entry( vShip_id integer )
as

begin

  delete from strang.duty
   where entry_no in
    (select entry_no
     from strang.detailrs dr, strang.movements m
     where
      ship_id = vShip_id and
      m.movement_no = dr.movement_no and
      nvl(m.seal,'|') = nvl(dr.camov_seal,'|')
    );


  update strang.detailrs dr
   set
    entry_no = null
  where
   (movement_no,nvl(dr.camov_seal,'|')) in (select movement_no,nvl(m.seal,'|') from strang.movements m where ship_id = vship_id);

end unallocate_entry;


procedure generate_ships_manifest( vship_id varchar2, action in varchar2 default 'LINE_NO', typ in varchar2 default 'SHIP', entryno in number default null, vste in varchar2 )
as
begin

 -- Generate Line Numbers
 if action = 'LINE_NO'
  then
   create_line_no(vship_id,typ);
   commit;
 end if;

 if action in ('DUTY')
  then
   unallocate_entry(vship_id);
   -- Generate Entry Numbers
   if typ = 'AIRWAY' then
    generate_entry_airfreight(vship_id,nvl(vste,G_USER_SITE));
   else
    generate_entry(vship_id,nvl(vste,G_USER_SITE));
   end if;
   commit;
 end if;

 if action in ('EXCISE')
  then
   create_duty(vShip_id,entryno, trunc(entryno));
   commit;
 end if;

 if action in ('T_EXCISE')
  then
   create_duty_com(vShip_id,entryno, trunc(entryno));
   commit;
 end if;

 if action in ('UNALLOCATE')
  then
   unallocate_entry(vship_id);
   commit;
 end if;

exception when others then
 error_details( 'STRANGP', 'GENERATE_SHIPS_MANIFEST',null,null,errmsg=>sqlerrm,extdet=>'VSHIP_ID:' || vship_id);
end generate_ships_manifest;

procedure invoke_report( surl in varchar2, repname in varchar2, r1 in varchar2 default null, r2 in varchar2 default null, r3 in varchar2 default null )
as

 cursor c1(repname varchar2) is select report_id from report_definition where upper(report_name) = upper(repname);
 cursor c2(repid integer) is select parameter_name, parameter_type from report_parameters where report_id = repid order by order_by;
 cursor c3(repid integer) is select max(parameter_level) mx from report_parameters where report_id = repid;

 c1rec	c1%ROWTYPE;
 c3rec	c3%ROWTYPE;
 p0     owa.vc_arr;
 p1     owa.vc_arr;
 p2     owa.vc_arr;

begin
 open c1( repname );
 fetch c1 into c1rec;
 if c1%NOTFOUND
  then
   close c1;
   htp.htmlopen;
   htp.header(3,'Report Not Found' || ' : ' || repname, 'CENTER' );
   htp.htmlclose;
   return;
 end if;
 close c1;

 for c2rec in c2( c1rec.report_id ) loop
  if c2%ROWCOUNT = 1
   then
    p0(1) := c2rec.parameter_name;
    p1(1) := r1;
    if c2rec.parameter_type in ('SQL','CONSTANT') then p2(1) := 'C'; else p2(1) := 'RFROM'; end if;
  elsif c2%ROWCOUNT = 2
   then
    p0(2) := c2rec.parameter_name;
    p1(2) := r2;
    if c2rec.parameter_type in ('SQL','CONSTANT') then p2(2) := 'C'; else p2(2) := 'RFROM'; end if;
  elsif c2%ROWCOUNT = 3
   then
    p0(3) := c2rec.parameter_name;
    p1(3) := r3;
    if c2rec.parameter_type in ('SQL','CONSTANT') then p2(3) := 'C'; else p2(3) := 'RFROM'; end if;
  end if;
 end loop;

 open c3( c1rec.report_id );
 fetch c3 into c3rec;
 close c3;
 oltp.run_report( surl, c1rec.report_id, c3rec.mx + 1, p0, p1, p2 );

exception when others then
 error_details( 'STRANGP', 'INVOKE_REPORT',null,null,errmsg=>sqlerrm,extdet=>'REPNAME:' || repname);
end invoke_report;

procedure display_report( surl in varchar2, acid in integer, typ in varchar2, repname in varchar2, r1 in varchar2 default null, r2 in varchar2 default null, r3 in varchar2 default null )
as

 cursor c1(repname varchar2) is select report_id from report_definition where upper(report_name) = upper(repname);

 c1rec	c1%ROWTYPE;
 secaccess	varchar2(100);

begin

 secaccess := data_access(typ);
 if secaccess = 'NONE' then return; end if;

 if secaccess = 'READ'
  then
   open c1( repname );
   fetch c1 into c1rec;
   if c1%FOUND
    then
     htp.anchor2( 'oltp.view_report?surl=' || surl || '&repid=' || c1rec.report_id,repname,ctarget=>'_top');
     htp.nl;
   end if;
   close c1;
 end if;

 if secaccess = 'EDIT'
  then
   htp.anchor2( 'strangp.invoke_report?surl=' || surl || '&repname=' || replace(repname,' ','+' ) || '&r1=' || replace(r1,' ','+') || '&r2=' || replace(r2,' ','+') || '&r3=' || replace(r3,' ','+'),repname,ctarget=>'_top');
   htp.nl;
 end if;

exception when others then
 error_details( 'STRANGP', 'DISPLAY_REPORT',null,null,errmsg=>sqlerrm,extdet=>'REPNAME:' || repname);
end display_report;

procedure mng_cust( surl in varchar2, rid in varchar2 default null, id in varchar2 default null, msg in varchar2 default null, call_name in varchar2 default null, parm in varchar2 default null, scid in varchar2 default null, access_id in varchar2 default null, is_popup in char default 'F' )
as

 cursor c2( rid rowid ) is select * from strang.customers where rowid = rid;
 cursor c2a is select * from strang.customers where rownum < 2 order by customer;
 cursor c2b( custid integer) is select rowid from strang.customers where customer_id = custid;

 c2rec		c2%ROWTYPE;
 c2brec		c2b%ROWTYPE;
 sts		varchar2(100);
 vaccess	varchar2(20);
 seclevel	varchar2(100);

begin
 if not dapi.init( surl, 'STRANGP.MNG_CUST', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'MNG_CUST' );
    return;
 end if;
 vaccess := data_access( 'CUSTOMERS' );
 seclevel := security_role( dapi.GLOBAL_ACCOUNT.acctid );

 if is_popup = 'T' then  main_title( 'Manage Customer Details', dispmenu=>FALSE, helpid=>'STR39'); else main_title( 'Manage Customer Details', helpid=>'STR39'); end if;

 if vaccess = 'NONE' then htp.bold( 'Access Denied' ); htp.htmlclose; return; end if;
 if msg is not null
  then
   header_msg( msg );
 end if;
 htp.p( '<CENTER>' );
 if id is null and rid is not null
  then
   open c2(replace(rid,'~','+'));
   fetch c2 into c2rec;
   close c2;
 elsif id is null
  then
   open c2a;
   fetch c2a into c2rec;
   close c2a;
   open c2b(c2rec.customer_id);
   fetch c2b into c2brec;
   close c2b;
 elsif nvl(id,'x') <> 'z'
  then
   open c2(replace(rid,'~','+'));
   fetch c2 into c2rec;
   close c2;
 end if;

 htp.formopen( 'strangp.accept_mng_cust', ctarget=>'_top' );
 htp.formhidden( 'SURL', surl );
 htp.formhidden( 'RID', replace(nvl(rid,c2brec.rowid),'~','+') );
 htp.tableopen( cattributes=>'class="str1_table"' );
 if c2rec.customer_id is not null
  then
   htp.tablerowopen;
    htp.tabledata( htf.bold('Customer Id'),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.bold(c2rec.customer_id),cattributes=>'class="str1_bg_left"');
   htp.tablerowclose;
  end if;
  htp.tablerowopen;
   htp.tabledata( htf.bold('Customer Name'),cattributes=>'class="str1_bg_left"');
   if vaccess = 'EDIT'
    then
     htp.tabledata( htf.formtext('P1', 60, 100, c2rec.customer),cattributes=>'class="str1_bg_left"');
    else
     htp.tabledata( htf.bold(c2rec.customer),cattributes=>'class="str1_bg_left"');
   end if;
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( htf.bold('OTML Vendor ID'),cattributes=>'class="str1_bg_left"');
   if vaccess = 'EDIT'
    then
     htp.tabledata( htf.formtext('P1i', 60, 100, c2rec.sap_vendor_id),cattributes=>'class="str1_bg_left"');
    else
     htp.tabledata( htf.bold(c2rec.sap_vendor_id),cattributes=>'class="str1_bg_left"');
   end if;
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( htf.bold('Street'),cattributes=>'class="str1_bg_left"');
   if vaccess = 'EDIT'
    then
     htp.tabledata( htf.formtext('P2', 30, 30, c2rec.street),cattributes=>'class="str1_bg_left"');
    else
     htp.tabledata( htf.bold(c2rec.street),cattributes=>'class="str1_bg_left"');
   end if;
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( htf.bold('Suburb'),cattributes=>'class="str1_bg_left"');
   if vaccess = 'EDIT'
    then
     htp.tabledata( htf.formtext('P3', 30, 30, c2rec.suburb),cattributes=>'class="str1_bg_left"');
    else
     htp.tabledata( htf.bold(c2rec.suburb),cattributes=>'class="str1_bg_left"');
   end if;
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( htf.bold('State'),cattributes=>'class="str1_bg_left"');
   if vaccess = 'EDIT'
    then
     htp.tabledata( htf.formtext('P4', 20, 20, c2rec.state),cattributes=>'class="str1_bg_left"');
    else
     htp.tabledata( htf.bold(c2rec.state),cattributes=>'class="str1_bg_left"');
   end if;
  htp.tablerowclose;
   htp.tablerowopen;
   htp.tabledata( htf.bold('Postcode'),cattributes=>'class="str1_bg_left"');
   if vaccess = 'EDIT'
    then
     htp.tabledata( htf.formtext('P5', 10, 10, c2rec.postcode),cattributes=>'class="str1_bg_left"');
    else
     htp.tabledata( htf.bold(c2rec.postcode),cattributes=>'class="str1_bg_left"');
   end if;
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( htf.bold('City'),cattributes=>'class="str1_bg_left"');
   if vaccess = 'EDIT'
    then
     htp.tabledata( htf.formtext('P6', 25, 25, c2rec.city),cattributes=>'class="str1_bg_left"');
    else
     htp.tabledata( htf.bold(c2rec.city),cattributes=>'class="str1_bg_left"');
   end if;
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( htf.bold('Country'),cattributes=>'class="str1_bg_left"');
   if vaccess = 'EDIT'
    then
     htp.tabledata( htf.formtext('P7', 25, 25, c2rec.country),cattributes=>'class="str1_bg_left"');
    else
     htp.tabledata( htf.bold(c2rec.country),cattributes=>'class="str1_bg_left"');
   end if;
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( htf.bold('ABN'),cattributes=>'class="str1_bg_left"');
   if vaccess = 'EDIT'
    then
     htp.tabledata( htf.formtext('P8', 20, 20, c2rec.abn),cattributes=>'class="str1_bg_left"');
    else
     htp.tabledata( htf.bold(c2rec.abn),cattributes=>'class="str1_bg_left"');
   end if;
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( htf.bold('Email'),cattributes=>'class="str1_bg_left"');
   if vaccess = 'EDIT'
    then
     htp.tabledata( htf.formtext('P9', 60, 60, c2rec.email),cattributes=>'class="str1_bg_left"');
    else
     htp.tabledata( htf.bold(c2rec.email),cattributes=>'class="str1_bg_left"');
   end if;
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( htf.bold('Phone'),cattributes=>'class="str1_bg_left"');
   if vaccess = 'EDIT'
    then
     htp.tabledata( htf.formtext('P10', 20, 20, c2rec.phone),cattributes=>'class="str1_bg_left"');
    else
     htp.tabledata( htf.bold(c2rec.phone),cattributes=>'class="str1_bg_left"');
   end if;
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( htf.bold('Fax'),cattributes=>'class="str1_bg_left"');
   if vaccess = 'EDIT'
    then
     htp.tabledata( htf.formtext('P11', 20, 20, c2rec.fax),cattributes=>'class="str1_bg_left"');
    else
     htp.tabledata( htf.bold(c2rec.fax),cattributes=>'class="str1_bg_left"');
   end if;
  htp.tablerowclose;
  if c2rec.customer_type = 'CUSTOMER'
   then
  htp.tablerowopen;
   htp.tabledata( htf.bold('Shipper ID'),cattributes=>'class="str1_bg_left"');
    htp.p( '<TD ' || 'class="str1_cell_left">' );
    if vaccess = 'EDIT'
     then
      customer_list( 'PARTY', 'P13', c2rec.shipper_id, FALSE );
     else
      customer_list( 'PARTY', 'P13', c2rec.shipper_id, FALSE, isedit=>FALSE );
    end if;
     htp.p(('&nbsp;&nbsp;('||' ID '||c2rec.shipper_id|| ') &nbsp;&nbsp;&nbsp;&nbsp;'||strang.f_get_party_address(c2rec.shipper_id)));
     htp.p( '</TD>' );
  htp.tablerowclose;

  htp.tablerowopen;
   htp.tabledata( htf.bold('Consigned To'),cattributes=>'class="str1_bg_left"');
    htp.p( '<TD ' || 'class="str1_cell_left">' );
    if vaccess = 'EDIT'
     then
      customer_list( 'PARTY', 'P14a', c2rec.consigned_to_id, FALSE );
     else
      customer_list( 'PARTY', 'P14a', c2rec.consigned_to_id, FALSE, isedit=>FALSE );
    end if;
     htp.p(('&nbsp;&nbsp;('||' ID '||c2rec.consigned_to_id|| ') &nbsp;&nbsp;&nbsp;&nbsp;'||strang.f_get_party_address(c2rec.consigned_to_id)));
     htp.p( '</TD>' );
  htp.tablerowclose;

  htp.tablerowopen;
   htp.tabledata( htf.bold('Notify Party'),cattributes=>'class="str1_bg_left"');
    htp.p( '<TD ' || 'class="str1_cell_left">' );
    if vaccess = 'EDIT'
     then
      customer_list( 'PARTY', 'P14', c2rec.notify_party_id, FALSE );
     else
      customer_list( 'PARTY', 'P14', c2rec.notify_party_id, FALSE, isedit=>FALSE );
    end if;
     htp.p(('&nbsp;&nbsp;('||' ID '||c2rec.notify_party_id||' ) &nbsp;&nbsp;&nbsp;&nbsp;'|| strang.f_get_party_address(c2rec.notify_party_id)));
     htp.p( '</TD>' );
  htp.tablerowclose;


  end if;
  htp.tablerowopen;
   htp.tabledata( htf.bold('Type of Customer'),cattributes=>'class="str1_bg_left"');
   if vaccess = 'EDIT' and id = 'z'
    then
     htp.p( '<TD ' || 'class="str1_cell_left">');
     htp.formselectopen( 'P12' );
     htp.formselectoption( 'CUSTOMER' );
     htp.formselectoption( 'SUPPLIER', 'SELECTED' );
     htp.formselectoption( 'PARTY' );
     htp.formselectoption( 'AGENT' );
     htp.formselectoption( 'BRANCHES' );
     htp.formselectoption( 'AIRALERT' );
     htp.formselectoption( 'SOUTHBOUND' ); -- SOUTHBOUND -- xxxSouthbound
     htp.formselectclose;
     htp.p( '</TD>' );
   elsif vaccess = 'EDIT'
    then
     htp.tabledata( htf.bold(c2rec.customer_type),cattributes=>'class="str1_bg_left"');
     htp.formhidden( 'P12', c2rec.customer_type );
    else
     htp.tabledata( htf.bold(c2rec.customer_type),cattributes=>'class="str1_bg_left"');
   end if;
  htp.tablerowclose;
 htp.tableclose;
 htp.nl;

 if is_popup = 'T'
  then
   htp.formhidden( 'IS_POPUP', 'T' );
   htp.formhidden( 'R6', c2rec.port_from );
   htp.formhidden( 'R6_1', c2rec.sad_lop_cod );
   htp.formhidden( 'R7', c2rec.customs_agent );
   htp.formhidden( 'R6_2', c2rec.sad_cty_1dlp );
   htp.formhidden( 'R22', c2rec.position );
   htp.formhidden( 'R6_3', c2rec.sad_tra_cty );
   htp.formhidden( 'R8', c2rec.licence_no );
   htp.formhidden( 'R6_4', c2rec.sad_cty_expcod );
   htp.formhidden( 'R9', c2rec.p2acode );
   htp.formhidden( 'R6_5', c2rec.sad_cty_destcod );
   htp.formhidden( 'R10', c2rec.cpc );
   htp.formhidden( 'R6_6', c2rec.sad_whs_cod );
   htp.formhidden( 'R21', c2rec.pcomment );
   htp.formhidden( 'R6_7', c2rec.sad_whs_time );
   htp.formhidden( 'R11', 'T' );
   htp.formhidden( 'R6_8', c2rec.sad_loc_goods );
   htp.formhidden( 'R14', c2rec.account_number );
   htp.formhidden( 'R12', c2rec.preceding_documents );
   htp.formhidden( 'R13',  c2rec.terms_of_delivery );
   htp.formhidden( 'R13_1', c2rec.bank_code );
   htp.formhidden( 'R13_2', c2rec.bank_name );
   htp.formhidden( 'R13_3', c2rec.branch );
   htp.formhidden( 'R13_4', c2rec.terms_of_payment );
   htp.formhidden( 'R13_5', c2rec.bank_ref_no );
   htp.formhidden( 'R2', c2rec.freight );
   htp.formhidden( 'R2_1', c2rec.infreight );
   htp.formhidden( 'R3', c2rec.insurance );
   htp.formhidden( 'R4', c2rec.vat );
   htp.formhidden( 'R5', c2rec.other_costs );
   htp.formhidden( 'R5V', c2rec.levy_rate );
   htp.formhidden( 'R2_2', c2rec.deductions );
   htp.formhidden( 'R15', c2rec.attachments_invoices );
   htp.formhidden( 'R16', c2rec.attachments_packing );
   htp.formhidden( 'R17', c2rec.attachments_order );
   htp.formhidden( 'R18', c2rec.attachments_licence );
   htp.formhidden( 'R19', c2rec.attachments_freight );
   htp.formhidden( 'R20', c2rec.attachments_other );
   htp.formhidden( 'R20_1', c2rec.sad_tot_fees );
   htp.formhidden( 'R20_2', c2rec.method_of_payment );
   htp.formhidden( 'R15_1', c2rec.sad_typ_dec );
   htp.formhidden( 'R15_2', c2rec.sad_typ_transit );
   htp.formhidden( 'R15_3', c2rec.sad_typ_proc );
   htp.formhidden( 'R15_4', c2rec.sad_cuo_code );
   htp.formhidden( 'R15_5', c2rec.sad_cuo_bord );
   htp.formhidden( 'R15_6', c2rec.sad_financial);
   htp.formhidden( 'R15_7', c2rec.sad_tod_nam );
   htp.formhidden( 'R15_8', c2rec.epg );
   goto BYPASS_CUST;
 end if;

 -- ============================================================================================================================
  htp.nl;
  htp.tableopen( cattributes=>'class="str1_table"' );
   htp.tablerowopen;
    htp.tabledata( htf.bold('Port From'),cattributes=>'class="str1_bg_left"');
    htp.p( '<TD ' || 'class="str1_cell_left">' );
    if vaccess = 'EDIT'
     then
      lov_list( 'LOCATIONS', 'R6', c2rec.port_from, FALSE, TRUE, FALSE );
     else
      lov_list( 'LOCATIONS', 'R6', c2rec.port_from, FALSE, TRUE, FALSE, isedit=>FALSE );
    end if;
    htp.p( '</TD>' );
    htp.tabledata( htf.bold('Place of Loading/Unloading'),cattributes=>'class="str1_bg_left"');
    htp.p( '<TD ' || 'class="str1_cell_left">' );
    if vaccess = 'EDIT'
     then
      lov_list( 'UNLOCTAB', 'R6_1', c2rec.sad_lop_cod, FALSE, TRUE, FALSE );
     else
      lov_list( 'UNLOCTAB', 'R6_1', c2rec.sad_lop_cod, FALSE, TRUE, FALSE, isedit=>FALSE );
    end if;
    htp.p( '</TD>' );
   htp.tablerowclose;
   htp.tablerowopen;
    htp.tabledata( htf.bold('Agent'),cattributes=>'class="str1_bg_left"');
    htp.p( '<TD ' || 'class="str1_cell_left">' );
    if vaccess = 'EDIT'
     then
      customer_list( 'AGENT', 'R7', c2rec.customs_agent, FALSE );
     else
      customer_list( 'AGENT', 'R7', c2rec.customs_agent, FALSE, isedit=>FALSE );
    end if;
    htp.p( '</TD>' );
    htp.tabledata( htf.bold('Country of 1st Dest/Last Provenance'),cattributes=>'class="str1_bg_left"');
    htp.p( '<TD ' || 'class="str1_cell_left">' );
    if vaccess = 'EDIT'
     then
      lov_list( 'UNCTYTAB', 'R6_2', c2rec.sad_cty_1dlp, FALSE, TRUE, FALSE );
     else
      lov_list( 'UNCTYTAB', 'R6_2', c2rec.sad_cty_1dlp, FALSE, TRUE, FALSE, isedit=>FALSE );
    end if;
    htp.p( '</TD>' );
   htp.tablerowclose;
   htp.tablerowopen;
    htp.tabledata( htf.bold('Position'),cattributes=>'class="str1_bg_left"');
    htp.p( '<TD ' || 'class="str1_cell_left">' );
    if vaccess = 'EDIT'
     then
        htp.formtext('R22',20,30, c2rec.position);
     else
        htp.bold(c2rec.position);
    end if;
    htp.p( '</TD>' );
    htp.tabledata( htf.bold('Trading Country'),cattributes=>'class="str1_bg_left"');
    htp.p( '<TD ' || 'class="str1_cell_left">' );
    if vaccess = 'EDIT'
     then
      lov_list( 'UNCTYTAB', 'R6_3', c2rec.sad_tra_cty, FALSE, TRUE, FALSE );
     else
      lov_list( 'UNCTYTAB', 'R6_3', c2rec.sad_tra_cty, FALSE, TRUE, FALSE, isedit=>FALSE );
    end if;
    htp.p( '</TD>' );
   htp.tablerowclose;
   htp.tablerowopen;
      htp.tabledata( htf.bold('Licence No'),cattributes=>'class="str1_bg_left"');
    if vaccess = 'EDIT'
       then
        htp.tabledata( htf.formtext('R8',20,20, c2rec.licence_no),cattributes=>'class="str1_bg_left"');
       else
        htp.tabledata( htf.bold(c2rec.licence_no),cattributes=>'class="str1_bg_left"');
      end if;
    htp.tabledata( htf.bold('Country of Export'),cattributes=>'class="str1_bg_left"');
    htp.p( '<TD ' || 'class="str1_cell_left">' );
    if vaccess = 'EDIT'
     then
      lov_list( 'UNCTYTAB', 'R6_4', c2rec.sad_cty_expcod, FALSE, TRUE, FALSE );
     else
      lov_list( 'UNCTYTAB', 'R6_4', c2rec.sad_cty_expcod, FALSE, TRUE, FALSE, isedit=>FALSE );
    end if;
    htp.p( '</TD>' );
   htp.tablerowclose;
   htp.tablerowopen;
      htp.tabledata( htf.bold('P2a Code'),cattributes=>'class="str1_bg_left"');
    if vaccess = 'EDIT'
       then
        htp.tabledata( htf.formtext('R9',20,15, c2rec.p2acode),cattributes=>'class="str1_bg_left"');
       else
        htp.tabledata( htf.bold(c2rec.p2acode),cattributes=>'class="str1_bg_left"');
      end if;
    htp.tabledata( htf.bold('Country of Destination'),cattributes=>'class="str1_bg_left"');
    htp.p( '<TD ' || 'class="str1_cell_left">' );
    if vaccess = 'EDIT'
     then
      lov_list( 'UNCTYTAB', 'R6_5', c2rec.sad_cty_destcod, FALSE, TRUE, FALSE );
     else
      lov_list( 'UNCTYTAB', 'R6_5', c2rec.sad_cty_destcod, FALSE, TRUE, FALSE, isedit=>FALSE );
    end if;
    htp.p( '</TD>' );
   htp.tablerowclose;
   htp.tablerowopen;
      htp.tabledata( htf.bold('CPC'),cattributes=>'class="str1_bg_left"');
    if vaccess = 'EDIT'
       then
        htp.tabledata( htf.formtext('R10',20,30, c2rec.cpc),cattributes=>'class="str1_bg_left"');
       else
        htp.tabledata( htf.bold(c2rec.cpc),cattributes=>'class="str1_bg_left"');
      end if;
    htp.tabledata( htf.bold('Warehouse Code'),cattributes=>'class="str1_bg_left"');
    htp.p( '<TD ' || 'class="str1_cell_left">' );
    if vaccess = 'EDIT'
     then
      lov_list( 'UNWHSTAB', 'R6_6', c2rec.sad_whs_cod, FALSE, TRUE, FALSE );
     else
      lov_list( 'UNWHSTAB', 'R6_6', c2rec.sad_whs_cod, FALSE, TRUE, FALSE, isedit=>FALSE );
    end if;
    htp.p( '</TD>' );
   htp.tablerowclose;
   htp.tablerowopen;
      htp.tabledata( htf.bold('Comments'),cattributes=>'class="str1_bg_left"');
    if vaccess = 'EDIT'
       then
        htp.tabledata( htf.formtext('R21',70,200, c2rec.pcomment),cattributes=>'class="str1_bg_left"');
       else
        htp.tabledata( htf.bold(c2rec.pcomment),cattributes=>'class="str1_bg_left"');
      end if;
    htp.tabledata( htf.bold('Warehouse Time Delay'),cattributes=>'class="str1_bg_left"');
    if vaccess = 'EDIT'
     then
      htp.tabledata( htf.formtext('R6_7',20,10, to_char(c2rec.sad_whs_time)),cattributes=>'class="str1_bg_left"');
     else
      htp.tabledata( htf.bold(to_char(c2rec.sad_whs_time)),cattributes=>'class="str1_bg_left"');
    end if;
   htp.tablerowclose;
   htp.tablerowopen;
      htp.tabledata( htf.bold('Comparative Worksheet'),cattributes=>'class="str1_bg_left"');
    if vaccess = 'EDIT'
       then
        if (c2rec.comparative_worksheet is not null) or (c2rec.port_from is null) -- entered in first time
         then
          htp.tabledata( htf.formcheckbox( 'R11', 'T', 'CHECKED' ), cattributes=>'class="str1_bg_left"');
         else
          htp.tabledata( htf.formcheckbox( 'R11', 'T' ), cattributes=>'class="str1_bg_left"');
        end if;
       else
        htp.tabledata( htf.bold(c2rec.comparative_worksheet),cattributes=>'class="str1_bg_left"');
      end if;
    htp.tabledata( htf.bold('Location of Goods'),cattributes=>'class="str1_bg_left"');
    htp.p( '<TD ' || 'class="str1_cell_left">' );
    if vaccess = 'EDIT'
     then
      lov_list( 'UNSHDTAB', 'R6_8', c2rec.sad_loc_goods, FALSE, TRUE, FALSE );
     else
      lov_list( 'UNSHDTAB', 'R6_8', c2rec.sad_loc_goods, FALSE, TRUE, FALSE, isedit=>FALSE );
    end if;
    htp.p( '</TD>' );
   htp.tablerowclose;
  htp.tableclose;

  htp.nl;
  htp.tableopen( cattributes=>'class="str3_table"' );
  htp.tablerowopen;
  htp.p( '<TD VALIGN="TOP" ALIGN="CENTER">' );
  htp.tableopen( cattributes=>'class="str1_table"' );
   htp.tablerowopen;
      htp.tabledata( htf.bold('Account Number'),cattributes=>'class="str1_bg_left"');
    if vaccess = 'EDIT'
       then
        htp.tabledata( htf.formtext('R14',15,15, c2rec.account_number),cattributes=>'class="str1_bg_left"');
       else
        htp.tabledata( htf.bold(c2rec.account_number),cattributes=>'class="str1_bg_left"');
      end if;
   htp.tablerowclose;
   htp.tablerowopen;
      htp.tabledata( htf.bold('Preceding Documents'),cattributes=>'class="str1_bg_left"');
    if vaccess = 'EDIT'
       then
        htp.tabledata( htf.formtext('R12',15,15, c2rec.preceding_documents),cattributes=>'class="str1_bg_left"');
       else
        htp.tabledata( htf.bold(c2rec.preceding_documents),cattributes=>'class="str1_bg_left"');
      end if;
   htp.tablerowclose;
   htp.tablerowopen;
    htp.tabledata( htf.bold('Terms of Delivery'),cattributes=>'class="str1_bg_left"');
    htp.p( '<TD ' || 'class="str1_cell_left">' );
    if vaccess = 'EDIT'
     then
      lov_list( 'UNTODTAB', 'R13', c2rec.terms_of_delivery, FALSE, TRUE, FALSE );
     else
      lov_list( 'UNTODTAB', 'R13', c2rec.terms_of_delivery, FALSE, TRUE, FALSE, isedit=>FALSE );
    end if;
    htp.p( '</TD>' );
   htp.tablerowclose;
   htp.tablerowopen;
      htp.tabledata( htf.bold('Bank Code'),cattributes=>'class="str1_bg_left"');
    if vaccess = 'EDIT'
       then
        htp.tabledata( htf.formtext('R13_1',15,30, c2rec.bank_code),cattributes=>'class="str1_bg_left"');
       else
        htp.tabledata( htf.bold(c2rec.bank_code),cattributes=>'class="str1_bg_left"');
      end if;
   htp.tablerowclose;
   htp.tablerowopen;
      htp.tabledata( htf.bold('Bank Name'),cattributes=>'class="str1_bg_left"');
    if vaccess = 'EDIT'
       then
        htp.tabledata( htf.formtext('R13_2',15,30, c2rec.bank_name),cattributes=>'class="str1_bg_left"');
       else
        htp.tabledata( htf.bold(c2rec.bank_name),cattributes=>'class="str1_bg_left"');
      end if;
   htp.tablerowclose;
   htp.tablerowopen;
      htp.tabledata( htf.bold('Branch'),cattributes=>'class="str1_bg_left"');
    if vaccess = 'EDIT'
       then
        htp.tabledata( htf.formtext('R13_3',15,30, c2rec.branch),cattributes=>'class="str1_bg_left"');
       else
        htp.tabledata( htf.bold(c2rec.branch),cattributes=>'class="str1_bg_left"');
      end if;
   htp.tablerowclose;
   htp.tablerowopen;
      htp.tabledata( htf.bold('Terms of Payment'),cattributes=>'class="str1_bg_left"');
    if vaccess = 'EDIT'
       then
        htp.tabledata( htf.formtext('R13_4',15,30, c2rec.terms_of_payment),cattributes=>'class="str1_bg_left"');
       else
        htp.tabledata( htf.bold(c2rec.terms_of_payment),cattributes=>'class="str1_bg_left"');
      end if;
   htp.tablerowclose;
   htp.tablerowopen;
      htp.tabledata( htf.bold('Bank Ref No'),cattributes=>'class="str1_bg_left"');
      if vaccess = 'EDIT'
       then
        htp.tabledata( htf.formtext('R13_5',15,30, c2rec.bank_ref_no),cattributes=>'class="str1_bg_left"');
       else
        htp.tabledata( htf.bold(c2rec.bank_ref_no),cattributes=>'class="str1_bg_left"');
      end if;
   htp.tablerowclose;
  htp.tableclose;
  htp.p( '</TD>' );

  htp.p( '<TD VALIGN="TOP" ALIGN="CENTER">' );
  htp.tableopen( cattributes=>'class="str1_table"' );
   htp.tablerowopen;
      htp.tabledata( htf.bold('External '||'Freight'|| htf.nl ||'USD per RevTonne'),cattributes=>'class="str1_bg_left"');
    if vaccess = 'EDIT'
       then
        htp.tabledata( htf.formtext('R2',10,20, to_char(c2rec.freight)),cattributes=>'class="str1_bg_left"');
       else
        htp.tabledata( htf.bold(to_char(c2rec.freight)),cattributes=>'class="str1_bg_left"');
      end if;
   htp.tablerowclose;
   htp.tablerowopen;
      htp.tabledata( htf.bold('Inland Freight'),cattributes=>'class="str1_bg_left"');
    if vaccess = 'EDIT'
       then
        htp.tabledata( htf.formtext('R2_1',10,20, to_char(c2rec.infreight)),cattributes=>'class="str1_bg_left"');
       else
        htp.tabledata( htf.bold(to_char(c2rec.infreight)),cattributes=>'class="str1_bg_left"');
      end if;
   htp.tablerowclose;
   htp.tablerowopen;
      htp.tabledata( htf.bold('Insurance'),cattributes=>'class="str1_bg_left"');
    if vaccess = 'EDIT'
       then
        htp.tabledata( htf.formtext('R3',10,20, to_char(c2rec.insurance)),cattributes=>'class="str1_bg_left"');
       else
        htp.tabledata( htf.bold(to_char(c2rec.insurance)),cattributes=>'class="str1_bg_left"');
      end if;
   htp.tablerowclose;
   htp.tablerowopen;
      htp.tabledata( htf.bold('Vat'),cattributes=>'class="str1_bg_left"');
    if vaccess = 'EDIT'
       then
        htp.tabledata( htf.formtext('R4',10,20, to_char(c2rec.vat)),cattributes=>'class="str1_bg_left"');
       else
        htp.tabledata( htf.bold(to_char(c2rec.vat)),cattributes=>'class="str1_bg_left"');
      end if;
   htp.tablerowclose;
   htp.tablerowopen;
      htp.tabledata( htf.bold('Other Costs'),cattributes=>'class="str1_bg_left"');
    if vaccess = 'EDIT'
       then
        htp.tabledata( htf.formtext('R5',10,20, to_char(c2rec.other_costs)),cattributes=>'class="str1_bg_left"');
       else
        htp.tabledata( htf.bold(to_char(c2rec.other_costs)),cattributes=>'class="str1_bg_left"');
      end if;
   htp.tablerowclose;
   htp.tablerowopen;
      htp.tabledata( htf.bold('Levy Rate'),cattributes=>'class="str1_bg_left"');
    if vaccess = 'EDIT'
       then
        htp.tabledata( htf.formtext('R5V',10,20, trim(to_char(c2rec.levy_rate,'999999.99'))),cattributes=>'class="str1_bg_left"');
       else
        htp.tabledata( htf.bold(trim(to_char(c2rec.levy_rate,'999999.99'))),cattributes=>'class="str1_bg_left"');
      end if;
   htp.tablerowclose;
   htp.tablerowopen;
      htp.tabledata( htf.bold('Deductions'),cattributes=>'class="str1_bg_left"');
    if vaccess = 'EDIT'
       then
        htp.tabledata( htf.formtext('R2_2',10,20, to_char(c2rec.deductions)),cattributes=>'class="str1_bg_left"');
       else
        htp.tabledata( htf.bold(to_char(c2rec.deductions)),cattributes=>'class="str1_bg_left"');
      end if;
   htp.tablerowclose;
  htp.tableclose;
  htp.p( '</TD>' );
  htp.p( '<TD VALIGN="TOP" ALIGN="CENTER">' );
 htp.tableopen( cattributes=>'class="str1_table"' );
   htp.tabledata( htf.bold('Attachments'),cattributes=>'class="str1_bg_left"');
   htp.p( '<TD ' || 'class="str1_cell_left">' );
   if vaccess = 'EDIT'
    then
     lov_list( 'UNATDTAB', 'R15', c2rec.attachments_invoices, FALSE, FALSE, FALSE );
    else
     lov_list( 'UNMODTAB', 'R15', c2rec.attachments_invoices, FALSE, FALSE, FALSE, isedit=>FALSE );
   end if;
   htp.p( '</TD>' );
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( htf.bold('Attachments'),cattributes=>'class="str1_bg_left"');
   htp.p( '<TD ' || 'class="str1_cell_left">' );
   if vaccess = 'EDIT'
    then
     lov_list( 'UNATDTAB', 'R16', c2rec.attachments_packing, FALSE, FALSE, FALSE );
    else
     lov_list( 'UNMODTAB', 'R16', c2rec.attachments_packing, FALSE, FALSE, FALSE, isedit=>FALSE );
   end if;
   htp.p( '</TD>' );
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( htf.bold('Attachments'),cattributes=>'class="str1_bg_left"');
   htp.p( '<TD ' || 'class="str1_cell_left">' );
   if vaccess = 'EDIT'
    then
     lov_list( 'UNATDTAB', 'R17', c2rec.attachments_order, FALSE, FALSE, FALSE );
    else
     lov_list( 'UNMODTAB', 'R17', c2rec.attachments_order, FALSE, FALSE, FALSE, isedit=>FALSE );
   end if;
   htp.p( '</TD>' );
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( htf.bold('Attachments'),cattributes=>'class="str1_bg_left"');
   htp.p( '<TD ' || 'class="str1_cell_left">' );
   if vaccess = 'EDIT'
    then
     lov_list( 'UNATDTAB', 'R18', c2rec.attachments_licence, FALSE, FALSE, FALSE );
    else
     lov_list( 'UNMODTAB', 'R18', c2rec.attachments_licence, FALSE, FALSE, FALSE, isedit=>FALSE );
   end if;
   htp.p( '</TD>' );
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( htf.bold('Attachments'),cattributes=>'class="str1_bg_left"');
   htp.p( '<TD ' || 'class="str1_cell_left">' );
   if vaccess = 'EDIT'
    then
     lov_list( 'UNATDTAB', 'R19', c2rec.attachments_freight, FALSE, FALSE, FALSE );
    else
  htp.tablerowclose;
     lov_list( 'UNMODTAB', 'R19', c2rec.attachments_freight, FALSE, FALSE, FALSE, isedit=>FALSE );
   end if;
   htp.p( '</TD>' );
  htp.tablerowopen;
   htp.tabledata( htf.bold('Attachments'),cattributes=>'class="str1_bg_left"');
   htp.p( '<TD ' || 'class="str1_cell_left">' );
   if vaccess = 'EDIT'
    then
     lov_list( 'UNATDTAB', 'R20', c2rec.attachments_other, FALSE, FALSE, FALSE );
    else
     lov_list( 'UNMODTAB', 'R20', c2rec.attachments_other, FALSE, FALSE, FALSE, isedit=>FALSE );
   end if;
   htp.p( '</TD>' );
   htp.tablerowopen;
      htp.tabledata( htf.bold('Total Fees'),cattributes=>'class="str1_bg_left"');
    if vaccess = 'EDIT'
       then
        htp.tabledata( htf.formtext('R20_1',10,10, to_char(c2rec.sad_tot_fees)),cattributes=>'class="str1_bg_left"');
       else
        htp.tabledata( htf.bold(to_char(c2rec.sad_tot_fees)),cattributes=>'class="str1_bg_left"');
      end if;
   htp.tablerowclose;
   htp.tablerowopen;
      htp.tabledata( htf.bold('Method of Payment'),cattributes=>'class="str1_bg_left"');
    if vaccess = 'EDIT'
       then
        htp.tabledata( htf.formtext('R20_2',10,1, to_char(c2rec.method_of_payment)),cattributes=>'class="str1_bg_left"');
       else
        htp.tabledata( htf.bold(to_char(c2rec.method_of_payment)),cattributes=>'class="str1_bg_left"');
      end if;
   htp.tablerowclose;
  htp.tableclose;

 ----****
  htp.p( '<TD VALIGN="TOP" ALIGN="CENTER">' );
  htp.tableopen( cattributes=>'class="str1_table"' );
   htp.tablerowopen;
    htp.tabledata( htf.bold('Type of Declaration'),cattributes=>'class="str1_bg_left"');
    htp.p( '<TD ' || 'class="str1_cell_left">' );
    if vaccess = 'EDIT'
     then
      lov_list( 'UNMODTAB', 'R15_1', c2rec.sad_typ_dec, FALSE, TRUE, FALSE );
     else
      lov_list( 'UNMODTAB', 'R15_1', c2rec.sad_typ_dec, FALSE, TRUE, FALSE, isedit=>FALSE );
    end if;
    htp.p( '</TD>' );
   htp.tablerowclose;
   htp.tablerowopen;
      htp.tabledata( htf.bold('Type of Transit Document'),cattributes=>'class="str1_bg_left"');
    if vaccess = 'EDIT'
       then
        htp.tabledata( htf.formtext('R15_2',10,5, c2rec.sad_typ_transit),cattributes=>'class="str1_bg_left"');
       else
        htp.tabledata( htf.bold(c2rec.sad_typ_transit),cattributes=>'class="str1_bg_left"');
      end if;
   htp.tablerowclose;
   htp.tablerowopen;
    htp.tabledata( htf.bold('Declaration General Procedure'),cattributes=>'class="str1_bg_left"');
    htp.p( '<TD ' || 'class="str1_cell_left">' );
    if vaccess = 'EDIT'
     then
      lov_list( 'UNCP1TAB', 'R15_3', c2rec.sad_typ_proc, FALSE, TRUE, FALSE );
     else
      lov_list( 'UNCP1TAB', 'R15_3', c2rec.sad_typ_proc, FALSE, TRUE, FALSE, isedit=>FALSE );
    end if;
    htp.p( '</TD>' );
   htp.tablerowclose;
   htp.tablerowopen;
    htp.tabledata( htf.bold('Customs Clearance Office'),cattributes=>'class="str1_bg_left"');
    htp.p( '<TD ' || 'class="str1_cell_left">' );
    if vaccess = 'EDIT'
     then
      lov_list( 'UNCUOTAB', 'R15_4', c2rec.sad_cuo_code, FALSE, TRUE, FALSE );
     else
      lov_list( 'UNCUOTAB', 'R15_4', c2rec.sad_cuo_code, FALSE, TRUE, FALSE, isedit=>FALSE );
    end if;
    htp.p( '</TD>' );
   htp.tablerowclose;
   htp.tablerowopen;
    htp.tabledata( htf.bold('Border Customs Office'),cattributes=>'class="str1_bg_left"');
    htp.p( '<TD ' || 'class="str1_cell_left">' );
    if vaccess = 'EDIT'
     then
      lov_list( 'UNCUOTAB', 'R15_5', c2rec.sad_cuo_bord, FALSE, TRUE, FALSE );
     else
      lov_list( 'UNCUOTAB', 'R15_5', c2rec.sad_cuo_bord, FALSE, TRUE, FALSE, isedit=>FALSE );
    end if;
    htp.p( '</TD>' );
   htp.tablerowclose;
   htp.tablerowopen;
    htp.tabledata( htf.bold('Person Resp for Financial Settlement'),cattributes=>'class="str1_bg_left"');
    htp.p( '<TD ' || 'class="str1_cell_left">' );
    if vaccess = 'EDIT'
     then
      lov_list( 'UNCMPTAB', 'R15_6', c2rec.sad_financial, FALSE, TRUE, FALSE );
     else
      lov_list( 'UNCMPTAB', 'R15_6', c2rec.sad_financial, FALSE, TRUE, FALSE, isedit=>FALSE );
    end if;
    htp.p( '</TD>' );
   htp.tablerowclose;
   htp.tablerowopen;
      htp.tabledata( htf.bold('Terms of Delivery Place'),cattributes=>'class="str1_bg_left"');
    if vaccess = 'EDIT'
       then
        htp.tabledata( htf.formtext('R15_7',10,17, to_char(c2rec.sad_tod_nam)),cattributes=>'class="str1_bg_left"');
       else
        htp.tabledata( htf.bold(to_char(c2rec.sad_tod_nam)),cattributes=>'class="str1_bg_left"');
      end if;
   htp.tablerowclose;

   htp.tablerowopen;
      htp.tabledata( htf.bold('EPG'),cattributes=>'class="str1_bg_left"');
    if vaccess = 'EDIT'
       then
        htp.tabledata( htf.formtext('R15_8',10,10, to_char(c2rec.epg)),cattributes=>'class="str1_bg_left"');
       else
  htp.tableclose;
        htp.tabledata( htf.bold(to_char(c2rec.epg)),cattributes=>'class="str1_bg_left"');
      end if;
   htp.tablerowclose;
  htp.tablerowclose;
  htp.tableclose;
  htp.nl;

  htp.nl;

 -- ============================================================================================================================
 <<BYPASS_CUST>>
 htp.tableopen( cattributes=>'class="str1_table4"' );
 htp.tablerowopen;
 if vaccess = 'EDIT' and nvl(id,'x') = 'z'
  then
   htp.tabledata( htf.formsubmit( 'ACTION', 'Insert New Customer' ),cattributes=>'VALIGN="TOP"');
 elsif vaccess = 'EDIT' and nvl(id,'x') <> 'z'
  then
   htp.tabledata( htf.formsubmit( 'ACTION', 'Update Customer' ),cattributes=>'VALIGN="TOP"');
   if seclevel = 'LEVEL 7' then htp.tabledata( htf.formsubmit( 'ACTION', 'Delete Customer' ),cattributes=>'VALIGN="TOP"'); end if;
 end if;
 htp.formclose;
 if vaccess = 'EDIT' and nvl(id,'x') <> 'z'
  then
   htp.tabledata( htf.formopen( 'strangp.mng_cust', ctarget=>'CUSTOMER_WINDOW' ) || htf.formhidden( 'SURL', surl ) || htf.formhidden( 'ID', 'z' ) || htf.formhidden( 'RID', null ) || htf.formhidden( 'IS_POPUP', is_popup ) || htf.formsubmit( null, 'New Customer/Supplier' ) || htf.formclose,cattributes=>'VALIGN="TOP"');
 end if;
 htp.tablerowclose;
 htp.tableclose;
 search( surl, 'CUSTOMERS', rid, xtra3=>is_popup );
 htp.nl;
 if call_name is null or is_popup = 'T' then htp.bold( '<a href="" onClick="self.close()">' || LNG.GLB_TXT_033 || '</a>'); htp.nl; end if;
 htp.p( '</CENTER>' );
 htp.tableclose;
exception when others then
 error_details( 'STRANGP', 'MNG_CUST',null,null,errmsg=>sqlerrm,extdet=>'RID:' || rid);
end mng_cust;

procedure accept_mng_cust( surl in varchar2, rid in varchar2, p1 in varchar2 default null, p1i in varchar2 , p2 in varchar2 default null, p3 in varchar2 default null, p4 in varchar2 default null,
                           p5 in varchar2 default null, p6 in varchar2 default null, p7 in varchar2 default null, p8 in varchar2 default null, p9 in varchar2 default null,
                           p10 in varchar2 default null, p11 in varchar2 default null, p12 in varchar2 default null, p13 in varchar2 default null, p14 in varchar2 default null, p14a in varchar2 default null, action in varchar2,
                           r2 in varchar2, r2_1 in varchar2, r2_2 in varchar2, r3 in varchar2, r4 in varchar2, r5 in varchar2, r5v in varchar2,
                           r6 in varchar2, r6_1 in varchar2, r6_2 in varchar2, r6_3 in varchar2, r6_4 in varchar2, r6_5 in varchar2, r6_6 in varchar2, r6_7 in varchar2, r6_8 in varchar2,
                           r7 in varchar2, r8 in varchar2, r9 in varchar2,
                           r10 in varchar2, r11 in varchar2 default null, r12 in varchar2, r13 in varchar2, r13_1 in varchar2, r13_2 in varchar2, r13_3 in varchar2,
                           r13_4 in varchar2,r13_5 in varchar2,  r14 in varchar2, r15 in varchar2,
                           r15_1 in varchar2,r15_2 in varchar2,r15_3 in varchar2,r15_4 in varchar2,r15_5 in varchar2,r15_6 in varchar2,r15_7 in varchar2,r15_8 in varchar2,
                           r16 in varchar2, r17 in varchar2, r18 in varchar2, r19 in varchar2, r20 in varchar2, r20_1 in varchar2, r20_2 in varchar2, r21 in varchar2, r22 in varchar2, is_popup in char default 'F' )

as

 cursor c1( cst varchar2 ) is select 'x' from strang.customers where upper(cst) = upper(customer);
 cursor c2( sto varchar2 ) is select max(customer_id) + 1 cnt from strang.customers;
 cursor c3( rid rowid ) is select customer from strang.customers where rowid = rid;
 cursor c11(vste varchar2) is select description from strang.lov where lov_name = 'CONTROLS' and code = 'DELIVERYNO' and cola = vste;


 c1rec		c1%ROWTYPE;
 c2rec		c2%ROWTYPE;
 c3rec		c3%ROWTYPE;
 c11rec 	c11%ROWTYPE;

 nmb1		integer;
 nmb2		integer;
 nmb3		integer;
 sts		varchar2(100);
 newrid		rowid;
 vste		varchar2(10);
  rmb1		number;
  rmb2		number;
  rmb3		number;
  rmb4		number;
  rmb5		number;
  rmb5a		number;
  rmb2_1	number;
  rmb2_2	number;
  rmb20_1	number;
  rmb20_2	number;
  rmb6_7        number;
  rmb15_3       number;
  rmb15_8       number;

begin
 if not dapi.init( surl, 'STRANGP.ACCEPT_MNG_CUST', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'ACCEPT_MNG_CUST' );
    return;
 end if;

  vste := customer_state(dapi.GLOBAL_ACCOUNT.acctid);

  if action = 'Delete Customer'
   then
    update strang.receivals
     set
      cust_customer_id = null
     where
      cust_customer_id = (select customer_id from strang.customers where rowid = chartorowid( replace(rid,'~','+') ));
    update strang.receivals
     set
      supplier_customer_id = null
     where
      supplier_customer_id = (select customer_id from strang.customers where rowid = chartorowid( replace(rid,'~','+') ));
    update strang.ships_airway
     set
      customer_id = null
     where
      customer_id = (select customer_id from strang.customers where rowid = chartorowid( replace(rid,'~','+') ));
/* 20140529
    update strang.ships_airway
     set
      customs_agent = null
     where
      customs_agent = (select customer_id from strang.customers where rowid = chartorowid( replace(rid,'~','+') ));
*/
	  delete from strang.customers where rowid = chartorowid( replace(rid,'~','+') );
    commit;
    menu( surl, to_char(sysdate,'SSSS'), 'CUSTOMERS');
    return;
  end if;

 begin nmb1 := to_number(p13); exception when others then nmb1 := NULL; end;
 begin nmb2 := to_number(p14); exception when others then nmb2 := NULL; end;
 begin nmb3 := to_number(p14a); exception when others then nmb3 := NULL; end;

 if action = 'Insert New Customer'
  then
   if p1 is null
    then
     mng_cust(surl,null,'z','Customer Name must be Specified', is_popup=>is_popup);
     return;
   end if;
   open c1(p1);
   fetch c1 into c1rec;
   if c1%FOUND
    then
     close c1;
     mng_cust(surl,null,'z','This Customer already exists', is_popup=>is_popup);
     return;
   end if;
   close c1;
   open c2(currsite);
   fetch c2 into c2rec;
   close c2;
   -- Use deliveryno as the ID
   if c2rec.cnt is null
    then
     open c11(vste);
     fetch c11 into c11rec;
     close c11;
     c2rec.cnt := c11rec.description;
   end if;
   insert into strang.customers(customer,sap_vendor_id,street,suburb,state,postcode,city,country,abn,email,phone,fax,customer_type,customer_id,shipper_id,notify_party_id,consigned_to_id) values
    ( p1, p1i, p2, p3, p4, p5, p6, p7, p8, p9, p10, p11, p12, c2rec.cnt,nmb1,nmb2,nmb3 ) returning rowid into newrid;
   commit;
   mng_cust(surl,newrid,'x','New Customer Successfully Inserted', is_popup=>is_popup);
   return;
 end if;

 open c3( chartorowid( replace(rid,'~','+') ));
 fetch c3 into c3rec;
 close c3;
 if p1 is null
  then
   mng_cust(surl,rid,'x','Customer Name must be Specified', is_popup=>is_popup);
   return;
 elsif p1 <> c3rec.customer
  then
   open c1(p1);
   fetch c1 into c1rec;
   if c1%FOUND
    then
     close c1;
     mng_cust(surl,rid,'x','This Customer already exists', is_popup=>is_popup);
     return;
   end if;
   close c1;
 end if;

  begin rmb2 := to_number(r2); exception when others then return; end;
  begin rmb2_1 := to_number(r2_1); exception when others then return; end;
  begin rmb2_2 := to_number(r2_2); exception when others then return; end;
  begin rmb3 := to_number(r3); exception when others then return; end;
  begin rmb4 := to_number(r4); exception when others then return; end;
  begin rmb5 := to_number(r5); exception when others then return; end;
  begin rmb5a := to_number(r5v); exception when others then return; end;
  begin rmb20_1 := to_number(r20_1); exception when others then return; end;
  begin rmb20_2 := to_number(r20_2); exception when others then return; end;
  begin rmb6_7 := to_number(r6_7); exception when others then return; end;
  begin rmb15_3 := to_number(r15_3); exception when others then return; end;
  begin rmb15_8 := to_number(r15_8); exception when others then return; end;


 update strang.customers
  set
   customer = p1,
   sap_vendor_id = p1i,
   street = p2,
   suburb = p3,
   state = p4,
   postcode = p5,
   city = p6,
   country = p7,
   abn = p8,
   email = p9,
   phone = p10,
   fax = p11,
   shipper_id=nmb1,
   notify_party_id = nmb2,
   consigned_to_id = nmb3,
   freight = rmb2,
   insurance = rmb3,
   vat = rmb4,
   other_costs = rmb5,
   port_from = r6,
   customs_agent = r7,
   licence_no = r8,
   p2acode = r9,
   cpc = r10,
   comparative_worksheet = r11,
   preceding_documents = r12,
   terms_of_delivery = r13,
   bank_code = r13_1,
   bank_name = r13_2,
   branch = r13_3,
   terms_of_payment = r13_4,
   bank_ref_no = r13_5,
   account_number = r14,
   attachments_invoices = r15,
   attachments_packing = r16,
   attachments_order = r17,
   attachments_licence = r18,
   attachments_freight = r19,
   attachments_other = r20,
   pcomment = r21,
   position = r22,
   levy_rate = rmb5a,
   infreight = rmb2_1,
   deductions = rmb2_2,
   sad_tot_fees = rmb20_1,
   method_of_payment = rmb20_2,
   sad_lop_cod = r6_1,
   sad_cty_1dlp = r6_2,
   sad_tra_cty = r6_3,
   sad_cty_expcod = r6_4,
   sad_cty_destcod = r6_5,
   sad_whs_cod = r6_6,
   sad_whs_time = rmb6_7,
   sad_loc_goods = r6_8,
   sad_typ_dec = r15_1,
   sad_typ_transit = r15_2,
   sad_typ_proc = rmb15_3,
   sad_cuo_code = r15_4,
   sad_cuo_bord = r15_5,
   sad_financial = r15_6,
   sad_tod_nam = r15_7,
   epg = rmb15_8

  where rowid = chartorowid( replace(rid,'~','+') );
 commit;
 mng_cust(surl,rid,'x','Customer Successfully Updated', is_popup=>is_popup);
exception when others then
 error_details( 'STRANGP', 'ACCEPT_MNG_CUST',null,null,errmsg=>sqlerrm,extdet=>'RID:' || rid);
end accept_mng_cust;

procedure mng_charge( surl in varchar2, rid in varchar2 default null, id in varchar2 default null, msg in varchar2 default null, call_name in varchar2 default null, parm in varchar2 default null )
as

 cursor c2( rid rowid ) is select * from strang.charges where rowid = rid;

 c2rec		c2%ROWTYPE;
 sts		varchar2(100);
 vaccess	varchar2(20);

begin
 if not dapi.init( surl, 'STRANGP.MNG_CHARGE', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'MNG_CHARGE' );
    return;
 end if;

 vaccess := data_access( 'CHARGES' );

 main_title( 'Manage Charge Codes',helpid=>'STR40');
 if vaccess = 'NONE' then htp.bold( 'Access Denied' ); htp.htmlclose; return; end if;
 htp.p( '<CENTER>' );
 if id <> 'z' and rid is not null
  then
   open c2(replace(rid,'~','+'));
   fetch c2 into c2rec;
   close c2;
 end if;

 htp.formopen( 'strangp.accept_mng_charge', ctarget=>'_top' );
 htp.formhidden( 'SURL', surl );
 htp.formhidden( 'RID', replace(rid,'~','+') );
 htp.tableopen( cattributes=>'class="str1_table"' );

  htp.tablerowopen;
   htp.tabledata( htf.bold('Charge Code'),cattributes=>'class="str1_bg_left"');
   if vaccess = 'EDIT' and (id = 'z' or rid is null)
    then
     htp.tabledata( htf.formtext('P1', 10, 10, c2rec.chargecode),cattributes=>'class="str1_bg_left"');
    else
     if vaccess = 'EDIT' then htp.formhidden( 'P1', c2rec.chargecode ); end if;
     htp.tabledata( htf.bold(c2rec.chargecode),cattributes=>'class="str1_bg_left"');
   end if;
  htp.tablerowclose;

  htp.tablerowopen;
   htp.tabledata( htf.bold('Charge Code Description'),cattributes=>'class="str1_bg_left"');
   if vaccess = 'EDIT'
    then
     htp.tabledata( htf.formtext('P2', 30, 30, c2rec.chargedesc),cattributes=>'class="str1_bg_left"');
    else
     htp.tabledata( htf.bold(c2rec.chargedesc),cattributes=>'class="str1_bg_left"');
   end if;
  htp.tablerowclose;

  htp.tablerowopen;
   htp.tabledata( htf.bold('Rate'),cattributes=>'class="str1_bg_left"');
   if vaccess = 'EDIT'
    then
     htp.tabledata( htf.formtext('P3', 10, 30, c2rec.rate),cattributes=>'class="str1_bg_left"');
    else
     htp.tabledata( htf.bold(c2rec.rate),cattributes=>'class="str1_bg_left"');
   end if;
  htp.tablerowclose;

  htp.tablerowopen;
   htp.tabledata( htf.bold('Cost Code'),cattributes=>'class="str1_bg_left"');
   if vaccess = 'EDIT'
    then
     htp.tabledata( htf.formtext('P4', 12, 12, c2rec.costcode),cattributes=>'class="str1_bg_left"');
    else
     htp.tabledata( htf.bold(c2rec.costcode),cattributes=>'class="str1_bg_left"');
   end if;
  htp.tablerowclose;

  htp.tablerowopen;
   htp.tabledata( htf.bold('Unit'),cattributes=>'class="str1_bg_left"');
   if vaccess = 'EDIT'
    then
     htp.p( '<TD ' || 'class="str1_cell_left">' );
     lov_list( 'UNITS', 'P5', c2rec.unit_unitused, TRUE, FALSE, FALSE );
     htp.p( '</TD>' );
    else
     htp.p( '<TD ' || 'class="str1_cell_left">' );
     lov_list( 'UNITS', 'P5', c2rec.unit_unitused, TRUE, TRUE, FALSE, isedit=>FALSE );
     htp.p( '</TD>' );
   end if;
  htp.tablerowclose;

  htp.tablerowopen;
   htp.tabledata( htf.bold('Default GST Code'),cattributes=>'class="str1_bg_left"');
   if vaccess = 'EDIT'
    then
     htp.p( '<TD ' || 'class="str1_cell_left">' );
     lov_list( 'GSTCODES', 'P6', c2rec.gstc_gstcode, TRUE, TRUE, TRUE );
     htp.p( '</TD>' );
    else
     htp.p( '<TD ' || 'class="str1_cell_left">' );
     lov_list( 'GSTCODES', 'P6', c2rec.gstc_gstcode, TRUE, TRUE, TRUE, isedit=>FALSE );
     htp.p( '</TD>' );
   end if;
  htp.tablerowclose;

  htp.tablerowopen;
   htp.tabledata( htf.bold('Sales Cost Centre with GST'),cattributes=>'class="str1_bg_left"');
   if vaccess = 'EDIT'
    then
     htp.p( '<TD ' || 'class="str1_cell_left">' );
     lov_list( 'COST_CENTRE', 'P7A', c2rec.sales_costcentre_gst, TRUE, FALSE, TRUE, xtr_a=>'S',xtr_b=>'GST' );
     htp.p( '</TD>' );
    else
     htp.p( '<TD ' || 'class="str1_cell_left">' );
     lov_list( 'COST_CENTRE', 'P7A', c2rec.sales_costcentre_gst, TRUE, FALSE, TRUE, isedit=>FALSE, xtr_a=>'S',xtr_b=>'GST' );
     htp.p( '</TD>' );
   end if;
  htp.tablerowclose;

  htp.tablerowopen;
   htp.tabledata( htf.bold('Sales Cost Centre NO GST'),cattributes=>'class="str1_bg_left"');
   if vaccess = 'EDIT'
    then
     htp.p( '<TD ' || 'class="str1_cell_left">' );
     lov_list( 'COST_CENTRE', 'P7B', c2rec.sales_costcentre_no_gst, TRUE, FALSE, TRUE, xtr_a=>'S',xtr_b=>'NO_GST' );
     htp.p( '</TD>' );
    else
     htp.p( '<TD ' || 'class="str1_cell_left">' );
  htp.tablerowclose;
     lov_list( 'COST_CENTRE', 'P7B', c2rec.sales_costcentre_no_gst, TRUE, FALSE, TRUE, isedit=>FALSE, xtr_a=>'S',xtr_b=>'NO_GST' );
     htp.p( '</TD>' );
   end if;

  htp.tablerowopen;
   htp.tabledata( htf.bold('Costs Cost Centre'),cattributes=>'class="str1_bg_left"');
   if vaccess = 'EDIT'
    then
     htp.p( '<TD ' || 'class="str1_cell_left">' );
     lov_list( 'COST_CENTRE', 'P7C', c2rec.costs_costcentre, TRUE, FALSE, TRUE, xtr_a=>'C' );
     htp.p( '</TD>' );
    else
     htp.p( '<TD ' || 'class="str1_cell_left">' );
     lov_list( 'COST_CENTRE', 'P7C', c2rec.costs_costcentre, TRUE, FALSE, TRUE, isedit=>FALSE, xtr_a=>'C' );
     htp.p( '</TD>' );
   end if;
  htp.tablerowclose;

 htp.tableclose;
 htp.nl;
 htp.tableopen( cattributes=>'class="str1_table4"' );
 htp.tablerowopen;
 if vaccess = 'EDIT' and (id = 'z' or rid is null)
  then
   htp.tabledata( htf.formsubmit( 'ACTION', 'Insert New Charge Code' ),cattributes=>'VALIGN="TOP"');
 elsif vaccess = 'EDIT' and id <> 'z'
  then
   htp.tabledata( htf.formsubmit( 'ACTION', 'Update Charge Code' ),cattributes=>'VALIGN="TOP"');
   htp.tabledata( htf.formsubmit( 'ACTION', 'Delete Charge Code' ),cattributes=>'VALIGN="TOP"');
 end if;
 htp.formclose;
 if vaccess = 'EDIT' and id <> 'z'
  then
   htp.tabledata( htf.formopen( 'strangp.mng_charge', ctarget=>'CUSTOMER_WINDOW' ) || htf.formhidden( 'SURL', surl ) || htf.formhidden( 'ID', 'z' ) || htf.formhidden( 'RID', null ) || htf.formsubmit( null, 'Insert New Charge Code' ) || htf.formclose,cattributes=>'VALIGN="TOP"');
 end if;
 htp.tablerowclose;
 htp.tableclose;
 search( surl, 'CHARGES', rid );
 htp.nl;
 --if call_name is null then htp.bold( '<a href="" onClick="self.close()">' || LNG.GLB_TXT_033 || '</a>'); htp.nl; end if;
 if msg is not null
  then
   header_msg( msg );
 end if;
 htp.p( '</CENTER>' );
 htp.tableclose;
exception when others then
 error_details( 'STRANGP', 'MNG_CHARGE',null,null,errmsg=>sqlerrm,extdet=>'RID:' || rid);
end mng_charge;

procedure accept_mng_charge( surl in varchar2, rid in varchar2, p1 in varchar2 default null, p2 in varchar2 default null, p3 in varchar2 default null, p4 in varchar2 default null,
                           p5 in varchar2 default null, p6 in varchar2 default null, p7a in varchar2, p7b in varchar2, p7c in varchar2, action in varchar2 )
as

 cursor c1( chg varchar2 ) is select 'x' from strang.charges where upper(chargecode) = upper(chg);

 c1rec		c1%ROWTYPE;

 sts		varchar2(100);
 np3		number;
 newrid		rowid;

begin
 if not dapi.init( surl, 'STRANGP.ACCEPT_MNG_CHARGE', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'ACCEPT_MNG_CHARGE' );
    return;
 end if;

  if action = 'Delete Charge Code'
   then
    delete from strang.invcharges
     where
      cge_chargecode = (select chargecode from strang.charges where rowid = chartorowid( replace(rid,'~','+') ));
    delete from strang.charges where rowid = chartorowid( replace(rid,'~','+') );
    menu( surl, to_char(sysdate,'SSSS'), 'CHARGES');
    return;
  end if;

 begin np3 := to_number(p3); exception when others then np3 := null; end;

 if action = 'Insert New Charge Code'
  then
   if p1 is null
    then
     mng_charge(surl,null,'z','Charge Code must be Specified');
     return;
   end if;
   open c1(p1);
   fetch c1 into c1rec;
   if c1%FOUND
    then
     close c1;
     mng_charge(surl,null,'z','This Charge Code already exists');
     return;
   end if;
   close c1;
   insert into strang.charges(chargecode,chargedesc,rate,costcode,unit_unitused,gstc_gstcode,sales_costcentre_gst,sales_costcentre_no_gst,costs_costcentre) values
    ( p1, p2, np3, p4, p5, p6, p7a, p7b, p7c ) returning rowid into newrid;
   commit;
   mng_charge(surl,newrid,'x','New Charge Code Successfully Inserted');
   return;
 end if;

 update strang.charges
  set
   chargedesc = p2,
   rate = np3,
   costcode = p4,
   unit_unitused = p5,
   gstc_gstcode = p6,
   sales_costcentre_gst = p7a,
   sales_costcentre_no_gst = p7b,
   costs_costcentre = p7c
  where rowid = chartorowid( replace(rid,'~','+') );
 commit;
 mng_charge(surl,rid,'x','Charge Code Successfully Updated');
exception when others then
 error_details( 'STRANGP', 'ACCEPT_MNG_CHARGE',null,null,errmsg=>sqlerrm,extdet=>'RID:' || rid);
end accept_mng_charge;

procedure allocate_hawb( mawb in varchar2, vste in varchar2 )
as

 cursor c1(dlr varchar2) is select max(hawb_hawbno) + 1 from strang.detailrs where substr(to_char(hawb_hawbno),1,2) = dlr;

 cursor c2(mawb varchar2) is
  select dr.rowid,dr.deliveryno,dr.itemno
  from strang.detailrs dr, strang.movements m
  where hawb_hawbno is null and
        dr.movement_no = m.movement_no and
        m.movement_no = mawb and
        m.movement_type = 'AIRWAY'
  order by deliveryno,itemno;

 cursor c3(mawb varchar2)  is
  select dr.hawb_hawbno, dr.deliveryno
  from strang.detailrs dr, strang.movements m
  where hawb_hawbno is not null and
        dr.movement_no = m.movement_no and
        m.movement_no = mawb and
        m.movement_type = 'AIRWAY';

 cursor c11(vste varchar2) is select description from strang.lov where lov_name = 'CONTROLS' and code = 'HAWB' and cola = vste;

 c3rec		c3%ROWTYPE;
 c11rec 	c11%ROWTYPE;
 maxnmb		integer;
 vmawbs		varchar(100);
 last_del	integer;


 function inlist( dlrv integer, mawb varchar2 )
  return boolean
 as
  cursor c1(dlrv integer, mawb varchar2)  is
   select dr.hawb_hawbno
   from strang.detailrs dr, strang.movements m
   where hawb_hawbno is not null and
         dr.movement_no = m.movement_no and
         m.movement_no = mawb and
         dr.deliveryno = dlrv and
         m.movement_type = 'AIRWAY';
  c1rec  c1%ROWTYPE;
  begin
   open c1(dlrv,mawb);
   fetch c1 into c1rec;
   if c1%FOUND
    then
     close c1;
     return( TRUE );
    else
      close c1;
      return( FALSE );
   end if;
 end inlist;

 function inlistval( dlrv integer, mawb varchar2 )
   return integer
  as
   cursor c1(dlrv integer, mawb varchar2)  is
    select dr.hawb_hawbno
    from strang.detailrs dr, strang.movements m
    where hawb_hawbno is not null and
          dr.movement_no = m.movement_no and
          m.movement_no = mawb and
          dr.deliveryno = dlrv and
          m.movement_type = 'AIRWAY';
   c1rec  c1%ROWTYPE;
   begin
    open c1(dlrv,mawb);
    fetch c1 into c1rec;
    if c1%FOUND
     then
      close c1;
      return( c1rec.hawb_hawbno );
     else
       close c1;
       return( NULL );
    end if;
  end inlistval;

begin

 open c3(mawb);
 fetch c3 into maxnmb,last_del;
 if c3%NOTFOUND
  then
   open c11(vste);
   fetch c11 into c11rec;
   close c11;
   open c1(substr(c11rec.description,1,2));
   fetch c1 into maxnmb;
   close c1;
   if maxnmb is null then maxnmb := c11rec.description; end if;
   --insert into strang.hawbs(hawb,mawb) values (maxnmb,mawb);
   vmawbs := mawb;
   insert into strang.hawbs(hawb,mawb) select maxnmb,vmawbs from dual where not exists (select 'x' from strang.hawbs h where h.hawb = maxnmb and h.mawb = vmawbs);
 end if;
 close c3;

 for c2rec in c2(mawb) loop
  if (last_del is null)
   then
    update strang.detailrs
      set
       hawb_hawbno = maxnmb
      where rowid = c2rec.rowid;
  elsif inlist(c2rec.deliveryno,mawb)
   then
    maxnmb := inlistval(c2rec.deliveryno,mawb);
    update strang.detailrs
      set
       hawb_hawbno = maxnmb
      where rowid = c2rec.rowid;
   else
    open c11(vste);
    fetch c11 into c11rec;
    close c11;
    open c1(substr(c11rec.description,1,2));
    fetch c1 into maxnmb;
    close c1;
    --insert into strang.hawbs(hawb,mawb) values (maxnmb,mawb);
    vmawbs := mawb;
    insert into strang.hawbs(hawb,mawb) select maxnmb,vmawbs from dual where not exists (select 'x' from strang.hawbs h where h.hawb = maxnmb and h.mawb = vmawbs);
    update strang.detailrs
      set
       hawb_hawbno = maxnmb
      where rowid = c2rec.rowid;
   end if;
   last_del := c2rec.deliveryno;
 end loop;

end allocate_hawb;

procedure hotsync( surl in varchar2 )
as

 cursor c2 is select * from strang.hot_sync order by decode(table_name,'SHIPS_AIRWAY',0,'RECEIVALS',1,'MOVEMENTS',2,'HAWBS',3,'DETAILRS',4,'POS',5,6), table_name;

 sts		varchar2(100);
 vaccess	varchar2(20);

begin
 if not dapi.init( surl, 'STRANGP.HOTSYNC', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'HOTSYNC' );
    return;
 end if;

  vaccess := data_access( 'HOTYSNC' );

 main_title( helpid=>'STR24');
 if vaccess = 'NONE' then htp.bold( 'Access Denied' ); htp.htmlclose; return; end if;
 htp.p( '<CENTER>' );
 htp.formopen( 'strangp.accept_hotsync' );
 htp.formhidden( 'SURL', surl );
 htp.tableopen( cattributes=>'class="str1_table"' );
 htp.tablerowopen;
  htp.tabledata( htf.bold( 'Table' ),cattributes=>'class="str1_bg_center"' );
  htp.tabledata( htf.bold( 'Allowed Change' ),cattributes=>'class="str1_bg_center"' );
 htp.tablerowclose;
 for c2rec in c2 loop
  htp.tablerowopen;
   htp.tabledata( initcap(replace(c2rec.table_name,'_',' ')), cattributes=>'class="str1_cell_center"' );
   htp.tabledata( initcap(c2rec.allowed_change), cattributes=>'class="str1_cell_center"' );
  htp.tablerowclose;
 end loop;
 htp.tableclose;
 htp.nl;
 htp.tableopen( cattributes=>'class="str1_table"' );
  htp.tablerowopen;
   htp.tabledata( '&nbsp;', cattributes=>'class="str1_bg_center"' );
   htp.tabledata( htf.bold('Synchronisation Type'), cattributes=>'class="str1_bg_center"' );
   htp.tabledata( '&nbsp;', cattributes=>'class="str1_bg_center"' );
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( htf.formradio( 'P2', 'STANDARD', 'CHECKED' ), cattributes=>'class="str1_cell_center"' );
   htp.tabledata( 'Refresh Changed Rows Only' || htf.nl ||
                  ' &nbsp;&nbsp;&nbsp' || htf.formcheckbox('P6','T') || ' Continue if Error ' || htf.nl ||
                  ' &nbsp;&nbsp;&nbsp ' || htf.formcheckbox( 'P4', 'T' ) || ' ' || 'Debug Enabled' || htf.nl ||
                  ' &nbsp;&nbsp;&nbsp ' || htf.formcheckbox( 'P7', 'T' ) || ' ' || 'Only Extract the SQL Statements to file' || htf.nl ||
                  ' &nbsp;&nbsp;&nbsp ' || htf.formcheckbox( 'P8', 'T' ) || ' ' || 'Only Run SQL Statements from file'
                  , cattributes=>'class="str1_cell_center"' );
   htp.tabledata( htf.anchor( 'strangp.analyse_hotsync?surl=' || surl, 'HotSync Analysis' ), cattributes=>'class="str1_bg_center"' );
  htp.tablerowclose;
  vaccess := data_access( 'HOTYSNC_SUPER' );
  if vaccess = 'EDIT'
   then
    htp.tablerowopen;
     htp.tabledata( htf.formradio( 'P2', 'CULL' ), cattributes=>'class="str1_cell_center"' );
     htp.tabledata( 'Cull Rows from Replication Table', cattributes=>'class="str1_cell_center"' );
     htp.tabledata( 'Before Date' || ':' || htf.formtext( 'P5',10,20, to_char(sysdate-100,'DD-MON-YYYY')), cattributes=>'class="str1_bg_center"' );
    htp.tablerowclose;
    htp.tablerowopen;
     htp.tabledata( htf.formradio( 'P2', 'REFRESH' ), cattributes=>'class="str1_cell_center"' );
     htp.tabledata( 'Complete Refresh. Will Delete all Data in Current Database and Refresh from Master Site.', cattributes=>'class="str1_cell_center"' );
     htp.tabledata( 'Complete Delete Password' || ' :' || htf.formpassword( 'P3',10, 100 ), cattributes=>'class="str1_bg_center"' );
    htp.tablerowclose;
  end if;
 htp.tableclose;
 htp.nl;
 htp.formsubmit( null, 'Run HotSync' );
 htp.formclose;
 htp.p( '</CENTER>' );
 htp.tableclose;
exception when others then
 error_details( 'STRANGP', 'HOTSYNC',null,null,errmsg=>sqlerrm );
end hotsync;

procedure analyse_hotsync( surl in varchar2 )
as

 TYPE REPCurTyp IS REF CURSOR;  -- define weak REF CURSOR type

 cursor c2 is select * from strang.hot_sync order by site,table_name desc; -- Descending so that Ships Airway goes first
 cursor c3 is
  select r.table_name,r.column_name,min(r.replication_id) mn,max(r.replication_id) mx,count('x') cnt,min(r.date_changed) mnd,max(r.date_changed) mxd
  from strang.replication r, strang.hot_sync h
  where r.table_name = h.table_name and
        r.replication_id >= nvl(h.local_load_id,0)
  group by r.table_name,r.column_name;
 cursor c4 is select * from strang.hot_sync;

 rep_cv   	REPCurTyp;
 str		varchar2(4000);
 fstr		varchar2(4000);
 cola		varchar2(4000);
 colb		varchar2(4000);
 tot		integer;

 sts		varchar2(100);
 vaccess	varchar2(20);
 result		varchar2(1000);

begin
 if not dapi.init( surl, 'STRANGP.ANALYSE_HOTSYNC', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'ANALYSE_HOTSYNC' );
    return;
 end if;

 vaccess := data_access( 'HOTYSNC' );

 main_title( 'HotSync Analysis',helpid=>'STR41');
 if vaccess = 'NONE' then htp.bold( 'Access Denied' ); htp.htmlclose; return; end if;
 htp.nl;
 htp.p( '<CENTER>' );
 htp.bold( 'Hot Sync' );
 htp.nl;
 htp.tableopen( cattributes=>'class="str1_table"' );
  htp.tablerowopen;
   htp.tabledata( htf.bold( 'Site' ), cattributes=>'class="str1_bg_center"' );
   htp.tabledata( htf.bold( 'Table Name' ), cattributes=>'class="str1_bg_center"' );
   htp.tabledata( htf.bold( 'DB Link' ), cattributes=>'class="str1_bg_center"' );
   htp.tabledata( htf.bold( 'Allowed Change' ), cattributes=>'class="str1_bg_center"' );
   htp.tabledata( htf.bold( 'Local Load Id' ), cattributes=>'class="str1_bg_center"' );
   htp.tabledata( htf.bold( 'Primary Load Id' ), cattributes=>'class="str1_bg_center"' );
   htp.tabledata( htf.bold( 'PK Col1' ), cattributes=>'class="str1_bg_center"' );
   htp.tabledata( htf.bold( 'PK Col2' ), cattributes=>'class="str1_bg_center"' );
  htp.tablerowclose;
  for c2rec in c2 loop
   htp.tablerowopen;
    htp.tabledata( c2rec.site, cattributes=>'class="str1_bg_center"' );
    htp.tabledata( c2rec.table_name, cattributes=>'class="str1_bg_center"' );
    htp.tabledata( c2rec.dblink, cattributes=>'class="str1_bg_center"' );
    htp.tabledata( c2rec.pk_col1, cattributes=>'class="str1_bg_center"' );
    htp.tabledata( c2rec.allowed_change, cattributes=>'class="str1_bg_center"' );
    htp.tabledata( c2rec.local_load_id, cattributes=>'class="str1_bg_center"' );
    htp.tabledata( c2rec.primary_load_id, cattributes=>'class="str1_bg_center"' );
    htp.tabledata( nvl(c2rec.pk_col2,'&nbsp;'), cattributes=>'class="str1_bg_center"' );
   htp.tablerowclose;
  end loop;
 htp.tableclose;
 htp.nl;
 htp.nl;
 htp.bold( 'Replication Statistics' );
 htp.nl;
 htp.tableopen( cattributes=>'class="str1_table"' );
  htp.tablerowopen;
   htp.tabledata( htf.bold( 'Table Name' ), cattributes=>'class="str1_bg_center"' );
   htp.tabledata( htf.bold( 'Column Name' ), cattributes=>'class="str1_bg_center"' );
   htp.tabledata( htf.bold( 'Min load Id' ), cattributes=>'class="str1_bg_center"' );
   htp.tabledata( htf.bold( 'Max Load Id' ), cattributes=>'class="str1_bg_center"' );
   htp.tabledata( htf.bold( 'Min Date Changed' ), cattributes=>'class="str1_bg_center"' );
   htp.tabledata( htf.bold( 'Max Date Changed' ), cattributes=>'class="str1_bg_center"' );
   htp.tabledata( htf.bold( '# Records' ), cattributes=>'class="str1_bg_center"' );
  htp.tablerowclose;
  for c3rec in c3 loop
   htp.tablerowopen;
    htp.tabledata( c3rec.table_name, cattributes=>'class="str1_bg_center"' );
    htp.tabledata( c3rec.column_name, cattributes=>'class="str1_bg_center"' );
    htp.tabledata( c3rec.mn, cattributes=>'class="str1_bg_center"' );
    htp.tabledata( c3rec.mx, cattributes=>'class="str1_bg_center"' );
    htp.tabledata( to_char(c3rec.mnd,'DD Mon YYYY HH24:MI:SS'), cattributes=>'class="str1_bg_center"' );
    htp.tabledata( to_char(c3rec.mxd,'DD Mon YYYY HH24:MI:SS'), cattributes=>'class="str1_bg_center"' );
    htp.tabledata( c3rec.cnt, cattributes=>'class="str1_bg_center"' );
   htp.tablerowclose;
  end loop;
 htp.tableclose;
 htp.line;
 htp.nl;

 htp.bold( 'Duplicate Values in the Strang Database' );
 htp.nl;
 htp.tableopen( cattributes=>'class="str1_table"' );
  htp.tablerowopen;
   htp.tabledata( htf.bold( 'Table Name' ));
   htp.tabledata( htf.bold( 'Primary Key Column A' ));
   htp.tabledata( htf.bold( 'Primary Key Column B' ));
   htp.tabledata( htf.bold( 'Value Column A' ));
   htp.tabledata( htf.bold( 'Value Column B' ));
   htp.tabledata( htf.bold( 'Number of Duplicates' ));
  htp.tablerowclose;
 for c4rec in c4 loop
  if c4rec.pk_col2 is null
   then
    str := c4rec.pk_col1;
   else
    str := c4rec.pk_col1 || ',' || c4rec.pk_col2;
  end if;
  fstr := 'select ' || str || ', count(''x'') tot from strang.' || c4rec.table_name || ' group by ' || str || ' having count(''x'') > 1';
  OPEN rep_cv FOR fstr;

  loop
   if c4rec.pk_col2 is null
    then
     FETCH rep_cv into cola,tot;
    else
     FETCH rep_cv into cola,colb,tot;
   end if;
   EXIT WHEN rep_cv%NOTFOUND;
   htp.tablerowopen;
    htp.tabledata( c4rec.table_name );
    htp.tabledata( htf.anchor('strangp.check_dupl?surl=' || surl || '&tname=' || c4rec.table_name || '&cname=' || c4rec.pk_col1 || '&pkcol1=' || replace(cola,' ','+') || '&pkcol2=' || replace(colb,' ','+'),c4rec.pk_col1 ));
    htp.tabledata( nvl(c4rec.pk_col2,'&nbsp;') );
    htp.tabledata( cola );
    htp.tabledata( nvl(colb,'&nbsp;'));
    htp.tabledata( tot );
   htp.tablerowclose;
  end loop;
  CLOSE rep_cv;

 end loop;
 htp.tableclose;
 htp.p( '</CENTER>' );
 htp.htmlclose;
exception when others then
 error_details( 'STRANGP', 'ANALYSE_HOTSYNC',null,null,errmsg=>sqlerrm );
end analyse_hotsync;

procedure delete_dupl(surl in varchar2, tname in varchar2, rw in varchar2 )
as


 sts		varchar2(100);
 rw2		varchar2(100);

begin
 if not dapi.init( surl, 'STRANGP.DELETE_DUPL', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'DELETE_DUPL' );
    return;
 end if;

  rw2 := replace(rw,'~','+');
  strang.global_site.disable_trigger := TRUE;
  execute immediate 'delete from strang.' || tname || ' where rowid = :1'
   using chartorowid(rw2);
  commit;
  strang.global_site.disable_trigger := FALSE;
  analyse_hotsync(surl);
exception when others then
 error_details( 'STRANGP', 'DELETE_DUPL',null,null,errmsg=>sqlerrm );
end delete_dupl;

procedure check_dupl(surl in varchar2, tname in varchar2, cname in varchar2, pkcol1 in varchar2, pkcol2 in varchar2 )
as

 TYPE REPCurTyp IS REF CURSOR;  -- define weak REF CURSOR type
 cursor c2(tname varchar2, ownr varchar2) is select column_name from all_tab_columns where owner = ownr and table_name = tname;
 cursor c3(tname varchar2) is select pk_col1,pk_col2 from strang.hot_sync where table_name = tname;

 rep_cv   	REPCurTyp;
 c3rec		c3%ROWTYPE;

 sts		varchar2(100);
 wclause	varchar2(1000);
 rep_cv4   	REPCurTyp;
 pr1		rowid;
 pr2		rowid;
 val1		varchar2(4000);
 val2		varchar2(4000);
 vaccess	varchar2(20);

begin
   REDISPLAY_LOGIN_PAGE( sts, TRUE );
 if not dapi.init( surl, 'STRANGP.CHECK_DUPL', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'CHECK_DUPL' );
    return;
 end if;

  vaccess := data_access( 'HOTYSNC' );

 main_title( 'Looking for Duplicates on table' || ':' || tname,helpid=>'STR42');
 htp.p( '<CENTER>' );
 htp.tableopen( cattributes=>'class="str1_table"' );
  htp.tablerowopen;
   htp.tabledata( htf.bold( 'Column Name' ), cattributes=>'class="str1_bg_center"' );
   htp.tabledata( htf.bold( 'First Row' ), cattributes=>'class="str1_bg_center"' );
   htp.tabledata( htf.bold( 'Second Row' ), cattributes=>'class="str1_bg_center"' );
  htp.tablerowclose;
  open c3(tname);
  fetch c3 into c3rec;
  close c3;
  if pkcol1 is null
   then
    wclause := c3rec.pk_col1 || ' is null';
   else
    wclause := c3rec.pk_col1 || ' = ''' || pkcol1 || '''';
  end if;
  if c3rec.pk_col2 is not null
   then
    if pkcol2 is null
     then
      wclause := wclause || ' and ' || c3rec.pk_col2 || ' is null';
     else
      wclause := wclause || ' and ' || c3rec.pk_col2 || ' = ''' || pkcol2 || '''';
    end if;
  end if;
  OPEN rep_cv FOR 'select rowid from strang.' || tname || ' where ' || wclause;
  FETCH rep_cv INTO pr1;
  FETCH rep_cv INTO pr2;
  close rep_cv;

  for c2rec in c2(tname,'STRANG') loop
  htp.tablerowopen;
   val1 := NULL;
   val2 := NULL;
   execute immediate 'select ' || c2rec.column_name || ' from strang.' || tname || ' where rowid=:1'
    into val1
     using pr1;
   execute immediate 'select ' || c2rec.column_name || ' from strang.' || tname || ' where rowid=:1'
    into val2
     using pr2;
   if nvl(val1,'|') = nvl(val2,'|')
    then
     htp.tabledata( c2rec.column_name, cattributes=>'class="str1_cell_left"');
     htp.tabledata( nvl(val1,'&nbsp;'), cattributes=>'class="str1_cell_left"');
     htp.tabledata( nvl(val2,'&nbsp;'), cattributes=>'class="str1_cell_left"');
    else
     htp.tabledata( htf.bold(c2rec.column_name), cattributes=>'class="str1_cell_left"');
     htp.tabledata( htf.bold(nvl(val1,'&nbsp;')), cattributes=>'class="str1_cell_left"');
     htp.tabledata( htf.bold(nvl(val2,'&nbsp;')), cattributes=>'class="str1_cell_left"');
   end if;
   htp.tablerowclose;
  end loop;
  htp.tableclose;
  htp.nl;
  htp.anchor( 'strangp.delete_dupl?surl=' || surl || '&tname=' || tname || '&rw=' || replace(pr1,'+','~'),'Delete First Row' );
  htp.nl;
  htp.anchor( 'strangp.delete_dupl?surl=' || surl || '&tname=' || tname || '&rw=' || replace(pr2,'+','~'),'Delete Second Row' );
  htp.nl;
 htp.p( '</CENTER>' );
 htp.htmlclose;
exception when others then
 error_details( 'STRANGP', 'CHECK_DUPL',null,null,errmsg=>sqlerrm );
end check_dupl;

procedure accept_hotsync( surl in varchar2, p2 in varchar2, p3 in varchar2 default NULL, p4 in varchar2 default 'F', p5 in varchar2 default null, p6 in varchar2 default 'F', p7 in varchar2 default 'F', p8 in varchar2 default 'F' )
as

 cursor c2 is select last_load from strang.hot_sync;


 c2rec		c2%ROWTYPE;

 sts		varchar2(100);
 vaccess	varchar2(20);
 result		varchar2(1000);

begin
 if not dapi.init( surl, 'STRANGP.ACCEPT_HOTSYNC', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'ACCEPT_HOTSYNC' );
    return;
 end if;
 vaccess := data_access( 'HOTYSNC' );

 main_title( 'Hot Sync Results',helpid=>'STR43');

 open c2;
 fetch c2 into c2rec;
 close c2;
 if ((sysdate - nvl(c2rec.last_load,(sysdate-100))) * 60 * 60 * 24) < 30
  then
   -- Hit button twice
   htp.nl;
   htp.bold( 'Hot Sync Already Running' );
   return;
  else
   -- OK to run
   update strang.hot_sync set last_load = sysdate;
   commit;
 end if;

 if vaccess = 'NONE' then htp.bold( 'Access Denied' ); htp.htmlclose; return; end if;
 htp.p( '<CENTER>' );
 htp.nl;
 result := NULL;
 strangz.hot_sync_all(p2,result,p3,p4,p5,p6,p7,p8);
 htp.tableopen( cattributes=>'class="str1_table"' );
   htp.tablerowopen;
 htp.nl;
     htp.tabledata( nvl(result,'Completed'), cattributes=>'class="str1_cell_center"' );
   htp.tablerowclose;
 htp.tableclose;
 -- htp.bold( '<a href="" onClick="self.close()">' || LNG.GLB_TXT_033 || '</a>'); htp.nl;
 htp.p( '</CENTER>' );
 htp.tableclose;
exception when others then
 error_details( 'STRANGP', 'ACCEPT_HOTSYNC',null,null,errmsg=>sqlerrm );
end accept_hotsync;

procedure assign_hawb( surl in varchar2, rid in varchar2, scid in varchar2, parm in varchar2, access_id in varchar2 default null, msg in varchar2 default null, ispopup in char default 'F' )
as

 cursor c2(rid rowid) is select movement_no from strang.movements where rowid = rid;


 c2rec		c2%ROWTYPE;

 sts		varchar2(100);
 vaccess	varchar2(20);
 vste		varchar2(10);

begin
 if not dapi.init( surl, 'STRANGP.ASSIGN_HAWB', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'ASSIGN_HAWB' );
    return;
 end if;

 vste := customer_state(dapi.GLOBAL_ACCOUNT.acctid);
 open c2(chartorowid(replace(rid,'~','+')));
 fetch c2 into c2rec;
 close c2;

 allocate_hawb( c2rec.movement_no, vste );

 movement( surl, rid, scid, null, parm, access_id, 'HAWBs Successfully Generated');

exception when others then
 error_details( 'STRANGP', 'ASSIGN_HAWB',null,null,errmsg=>sqlerrm,extdet=>'PARM:' || parm);
end assign_hawb;

procedure edit_ecn_log( surl in varchar2, lg in varchar2, rid in varchar2, scid in varchar2, call_name in varchar2, parm in varchar2, access_id in varchar2 default null, recctr in integer default 1, msg in varchar2 default null, force_single_disp in char default 'F', popup in char default 'F' )
as

 cursor c3( lg varchar2 ) is
  select d.rowid,d.movement_no,d.camov_seal seal,logno,deliveryno,itemno,ecn,handling_unit,qty,pktpe_packtype,partweight,partvolume,detaildesc,hazard,warehouse
  from strang.detailrs d
  where logno = lg
  order by movement_no,camov_seal,logno,deliveryno,itemno,ecn,handling_unit,qty,pktpe_packtype,partweight,partvolume,detaildesc,hazard;


 sts		varchar2(100);
 foundrec	boolean;

begin
 if not dapi.init( surl, 'STRANGP.EDIT_ECN_LOG' , null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'EDIT_ECN_LOG'  );
    return;
 end if;

 main_title( 'Assigning ECN / Handling Unit Values to Containers',helpid=>'STR44',dispmenu=>FALSE);

 htp.p( '<CENTER>' );

 htp.formopen( 'strangp.accept_edit_ecn_log' );
 htp.formhidden( 'SURL', surl );
 htp.formhidden( 'LG', lg );
 htp.formhidden( 'RID', rid );
 htp.formhidden( 'SCID', scid );
 htp.formhidden( 'CALL_NAME', call_name );
 htp.formhidden( 'PARM', parm );
 htp.formhidden( 'ACCESS_ID', access_id );
 htp.formhidden( 'RECCTR', recctr );
 htp.formhidden( 'FORCE_SINGLE_DISP', force_single_disp );
 htp.formhidden( 'POPUP', popup );

 htp.nl;
 htp.tableopen( cattributes=>'class="str1_table"' );
  htp.tablerowopen;
   htp.tableheader( 'Container', cattributes=>'class="str1_bg_center"');
   htp.tableheader( 'Seal', cattributes=>'class="str1_bg_center"');
   htp.tableheader( 'Log No', cattributes=>'class="str1_bg_center"');
   htp.tableheader( 'Delivery No', cattributes=>'class="str1_bg_center"');
   htp.tableheader( 'Item', cattributes=>'class="str1_bg_center"');
   htp.tableheader( 'ECN', cattributes=>'class="str1_bg_center"');
   htp.tableheader( 'Handling Unit', cattributes=>'class="str1_bg_center"');
   htp.tableheader( 'Qty', cattributes=>'class="str1_bg_center"');
   htp.tableheader( 'Pack Type', cattributes=>'class="str1_bg_center"');
   htp.tableheader( 'Weight (Kg)', cattributes=>'class="str1_bg_center"');
   htp.tableheader( 'Volume (m3)', cattributes=>'class="str1_bg_center"');
   htp.tableheader( 'Description', cattributes=>'class="str1_bg_center"');
   htp.tableheader( 'Hazardous', cattributes=>'class="str1_bg_center"');
   htp.tableheader( 'Warehouse', cattributes=>'class="str1_bg_center"');
  htp.tablerowclose;
  foundrec := FALSE;
    for c3rec in c3( lg ) loop
     foundrec := TRUE;
     htp.tablerowopen;
     htp.formhidden( 'P2', rowidtochar( c3rec.rowid ) );
      htp.tabledata( c3rec.movement_no, cattributes=>'class="str1_bg_left"');
      htp.tabledata( nvl(c3rec.seal,'&nbsp;'), cattributes=>'class="str1_bg_left"');
      htp.tabledata( c3rec.logno, cattributes=>'class="str1_bg_left"');
      htp.tabledata( c3rec.deliveryno, cattributes=>'class="str1_bg_left"');
      htp.tabledata( c3rec.itemno, cattributes=>'class="str1_bg_left"');
      htp.tabledata( htf.formtext( 'P3', 10, 1000, c3rec.ecn), cattributes=>'class="str1_cell_center"');
      htp.tabledata( htf.formtext( 'P3i', 10, 1000, c3rec.handling_unit), cattributes=>'class="str1_cell_center"');
      htp.tabledata( htf.formtext( 'P4', 10, 1000, c3rec.qty), cattributes=>'class="str1_cell_center"');
      htp.tabledata( htf.formtext( 'P5', 8, 1000, c3rec.pktpe_packtype), cattributes=>'class="str1_cell_center"');
      htp.tabledata( htf.formtext( 'P6', 10, 1000, c3rec.partweight), cattributes=>'class="str1_cell_center"');
      htp.tabledata( htf.formtext( 'P7', 10, 1000, c3rec.partvolume), cattributes=>'class="str1_cell_center"');
      htp.tabledata( htf.formtext( 'P8', 90, 1000, c3rec.detaildesc), cattributes=>'class="str1_cell_center"');
      htp.tabledata( htf.formtext( 'P9', 40, 1000, c3rec.hazard), cattributes=>'class="str1_cell_center"');
      htp.tabledata( htf.formtext( 'P10', 10, 1000, c3rec.warehouse), cattributes=>'class="str1_cell_center"');
     htp.tablerowclose;
    end loop;
  htp.tableclose;
  if not foundrec
   then
    htp.formhidden( 'P2', null );
    htp.formhidden( 'P3', null );
    htp.nl;
    htp.formsubmit( null, 'No Movements Found' );
    htp.formclose;
    htp.nl;
    htp.anchor(  'javascript: window.opener.location = ''' || 'strangp.receive_bottom?surl=' || surl || '&rid=' || replace( rid, '+', '~' ) || '&scid=' || replace(scid,' ','+') || '&call_name=' || replace(call_name,' ','+') || '&parm=' || replace(parm,' ','+') || '&access_id=' || replace(access_id,' ','+') || '&force_single_disp=' || force_single_disp || '&popup=' || popup || '&recctr=' || to_char(recctr) || '''; self.close();', LNG.GLB_TXT_033);
    htp.htmlclose;
   return;
  end if;
  htp.nl;
  htp.formsubmit( 'ACTION', 'Save Changes' );
  htp.formsubmit( 'ACTION', 'Repeat First ECN for All' );
  htp.formsubmit( 'ACTION', 'Repeat First Handling Unit for All' );
  htp.formclose;
  htp.anchor(  'javascript: window.opener.location = ''' || 'strangp.receive_bottom?surl=' || surl || '&rid=' || replace( rid, '+', '~' ) || '&scid=' || replace(scid,' ','+') || '&call_name=' || replace(call_name,' ','+') || '&parm=' || replace(parm,' ','+') || '&access_id=' || replace(access_id,' ','+') || '&force_single_disp=' || force_single_disp || '&popup=' || popup || '&recctr=' || to_char(recctr) || '''; self.close();', LNG.GLB_TXT_033);
  --htp.bold( '<a href="" onClick="self.close()">' || LNG.GLB_TXT_033 || '</a>'); htp.nl;
 if msg is not null
  then
   header_msg( msg );
 end if;
  htp.p( '</CENTER>' );
  htp.htmlclose;
exception when others then
 error_details( 'STRANGP', 'EDIT_ECN_LOG',null,null,errmsg=>sqlerrm,extdet=>'LG:' || lg);
end edit_ecn_log;

procedure accept_edit_ecn_log( surl in varchar2, lg in varchar2, rid in varchar2, scid in varchar2, call_name in varchar2, parm in varchar2, access_id in varchar2 default null, recctr in integer default 1, action in varchar2, p2 in owa.vc_arr, p3 in owa.vc_arr, p3i in owa.vc_arr, p4 in owa.vc_arr, p5 in owa.vc_arr, p6 in owa.vc_arr, p7 in owa.vc_arr, p8 in owa.vc_arr, p9 in owa.vc_arr, p10 in owa.vc_arr, force_single_disp in char default 'F', popup in char default 'F' )
as

 cursor c3(lname varchar2, lcode varchar2) is select * from strang.lov where lov_name = lname and code = lcode;

 c3rec		c3%ROWTYPE;

 sts		varchar2(100);
 errmsg		owa.vc_arr;
 errfound	boolean;
 errunit	varchar2(1);


begin
 if not dapi.init( surl, 'STRANGP.ACCEPT_EDIT_ECN_LOG' , null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'ACCEPT_EDIT_ECN_LOG' );
    return;
 end if;

  for j in p2.first..p2.last loop
     errmsg(j):=null;
     if p2(j) is not null
      then
       if action = 'Save Changes'
        then
--       Validations
         -- Check PackType
         c3rec.code := NULL;
         errunit := 'F';
         if p5(j) is not null
         then
          open c3( 'PACKTYPES', upper(p5(j)));
          fetch c3 into c3rec;
          if c3%NOTFOUND
          then
            close c3;
            errfound := TRUE;
            errmsg(j) := errmsg(j) || ' ' || 'PackType NOT updated';
            errunit := 'T';
          else
            close c3;
            update strang.detailrs set pktpe_packtype = upper(nvl(p5(j),pktpe_packtype)) where rowid = chartorowid( p2(j) );
          end if;
        end if;

         -- Check Warehouses
         c3rec.code := NULL;
         errunit := 'F';
         if p10(j) is not null
         then
          open c3( 'WAREHOUSES', upper(p10(j)));
          fetch c3 into c3rec;
          if c3%NOTFOUND
          then
            close c3;
            errfound := TRUE;
            errmsg(j) := errmsg(j) || ' ' || 'Warehouse NOT updated';
            errunit := 'T';
          else
            close c3;
            update strang.detailrs set warehouse = upper(nvl(p10(j),warehouse)) where rowid = chartorowid( p2(j) );
          end if;
        end if;

         update strang.detailrs set
          ecn = p3(j),
          handling_unit = strang.f_sap_format(p3i(j),'HANDLING_UNIT'),
          qty = nvl(p4(j),qty),
          partweight = nvl(p6(j),partweight),
          partvolume = nvl(p7(j),partvolume),
          detaildesc = upper(nvl(p8(j),detaildesc)),
          hazard = upper(p9(j))
         where rowid = chartorowid( p2(j) );
       elsif action = 'Repeat First ECN for All'
        then
         if p3(j) is null
          then
           update strang.detailrs set ecn = p3(1) where rowid = chartorowid( p2(j) );
          else
           update strang.detailrs set ecn = p3(j) where rowid = chartorowid( p2(j) );
         end if;
       elsif action = 'Repeat First Handling Unit for All'
        then
         if p3i(j) is null
          then
           update strang.detailrs set handling_unit = strang.f_sap_format(p3i(1),'HANDLING_UNIT') where rowid = chartorowid( p2(j) );
          else
           update strang.detailrs set handling_unit = strang.f_sap_format(p3i(j),'HANDLING_UNIT') where rowid = chartorowid( p2(j) );
         end if;
       end if;
     end if;
  end loop;

  commit;

  edit_ecn_log(surl, lg, rid, scid, call_name, parm, access_id, recctr, 'VALUES SAVED', force_single_disp=>force_single_disp, popup=>popup );

exception when others then
 error_details( 'STRANGP', 'ACCEPT_EDIT_ECN_LOG',null,null,errmsg=>sqlerrm,extdet=>'LG:' || lg);
end accept_edit_ecn_log;

procedure trac_search( surl in varchar2, msg in varchar2 default null )
as


 sts		varchar2(100);

begin
 if not dapi.init( surl, 'STRANGP.TRAC_SEARCH', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'TRAC_SEARCH' );
    return;
 end if;

 main_title( 'Strang QuickTrac Worldiwde Cargo Tracking Facility',helpid=>'STR45');
 htp.p( '<CENTER>' );

 if msg is not null
 then
  header_msg( msg );
 end if;

 htp.nl;

htp.tableopen;
  htp.tablerowopen;
   htp.tabledata( htf.bold('Strang QuickTrac'), ' style="text-align:left"');
   htp.tabledata( '&nbsp;', ' style="text-align:left"');
   htp.tabledata( '&nbsp;', ' style="text-align:left"');
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( htf.bold('Worldwide Cargo Tracking Facility'), ' style="text-align:left"');
   htp.tabledata( '&nbsp;', ' style="text-align:left"');
   htp.tabledata( '&nbsp;', ' style="text-align:left"');
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( '&nbsp;', ' style="text-align:left"');
   htp.tabledata( '&nbsp;', ' style="text-align:left"');
   htp.tabledata( '&nbsp;', ' style="text-align:left"');
  htp.tablerowclose;
htp.tablerowopen;
htp.p('<TD valign="TOP">');
 htp.p('Northbound Ships');
 htp.formopen( 'strangp.accept_trac_search' );
 htp.formhidden( 'SURL', surl );
 htp.tableopen( cattributes=>'cellpadding=2 cellspacing=10 border=0' );
  htp.tablerowopen;
   htp.tabledata( htf.bold( 'Search by' || ':'), ' style="text-align:left"');
   htp.tabledata( htf.bold( 'Strang Delivery No'), ' style="text-align:left"');
   htp.tabledata( htf.formtext( 'P4', 20, 100 ), ' style="text-align:left"');
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( '&nbsp;', ' style="text-align:left"');
   htp.tabledata( htf.bold( 'OTML Delivery No'), ' style="text-align:left"');
   htp.tabledata( htf.formtext( 'P4i', 20, 100 ), ' style="text-align:left"');
   htp.tabledata( htf.bold( 'Item '), ' style="text-align:left"');
   htp.tabledata( htf.formtext( 'P4ii', 10, 100 ), ' style="text-align:left"');
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( '&nbsp;', ' style="text-align:left"');
   htp.tabledata( htf.bold( 'Purchase Order Number'), ' style="text-align:left"');
   htp.tabledata( htf.formtext( 'P1', 20, 100 ), ' style="text-align:left"');
   htp.tabledata( htf.bold( 'Line '), ' style="text-align:left"');
   htp.tabledata( htf.formtext( 'P1a', 10, 100 ), ' style="text-align:left"');
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( '&nbsp;', ' style="text-align:left"');
   htp.tabledata( htf.bold( 'Material No'), ' style="text-align:left"');
   htp.tabledata( htf.formtext( 'p4aa', 20, 100 ), ' style="text-align:left"');
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( '&nbsp;', ' style="text-align:left"');
   htp.tabledata( htf.bold( 'OTML Handling Unit'), ' style="text-align:left"');
   htp.tabledata( htf.formtext( 'p4a', 20, 100 ), ' style="text-align:left"');
  htp.tablerowclose;
htp.tablerowopen;
   htp.tabledata( '&nbsp;', ' style="text-align:left"');
   htp.tabledata( htf.bold( 'Supplier Invoice Number'), ' style="text-align:left"');
   htp.tabledata( htf.formtext( 'P2', 20, 100 ), ' style="text-align:left"');
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( '&nbsp;', ' style="text-align:left"');
   htp.tabledata( htf.bold( 'Supplier Name'), ' style="text-align:left"');
   htp.tabledata( htf.formtext( 'P3', 20, 100 ), ' style="text-align:left"');
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( '&nbsp;', ' style="text-align:left"');
   htp.tabledata( htf.bold( 'Container/Connote/Mawb'), ' style="text-align:left"');
   htp.tabledata( htf.formtext( 'P5', 20, 100 ), ' style="text-align:left"');
   htp.tabledata( htf.bold( 'Seal'), ' style="text-align:left"');
   htp.tabledata( htf.formtext( 'P6', 10, 100 ), ' style="text-align:left"');
htp.p('<CENTER>');
  htp.tablerowclose;
htp.tableclose;
htp.nl;
htp.formsubmit( null, 'Run Search' );
htp.formclose;
htp.p('</CENTER>');
htp.p('</TD>');

-- Southbound Ships Start
htp.p('<TD valign="TOP">');
 htp.p('Southbound Ships');
 htp.formopen( 'strangsb.accept_trac_search' );
 htp.formhidden( 'SURL', surl );
 htp.tableopen( cattributes=>'cellpadding=2 cellspacing=10 border=0' );
  htp.tablerowopen;
   htp.tabledata( htf.bold( 'Search by' || ':'), ' style="text-align:left"');
   htp.tabledata( htf.bold( 'Consignee Name'), ' style="text-align:left"');
   htp.tabledata( htf.formtext( 'P1', 20, 100 ), ' style="text-align:left"');
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( '&nbsp;', ' style="text-align:left"');
   htp.tabledata( htf.bold( 'Customs Authority Number'), ' style="text-align:left"');
   htp.tabledata( htf.formtext( 'P2', 20, 100 ), ' style="text-align:left"');
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( '&nbsp;', ' style="text-align:left"');
   htp.tabledata( htf.bold( 'Container Number' ), ' style="text-align:left"');
   htp.tabledata( htf.formtext( 'P3', 20, 100 ), ' style="text-align:left"');
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( '&nbsp;', ' style="text-align:left"');
   htp.tabledata( htf.bold( 'OTML DAN Number' ), ' style="text-align:left"');
   htp.tabledata( htf.formtext( 'P4', 20, 100 ), ' style="text-align:left"');
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( '&nbsp;', ' style="text-align:left"');
   htp.tabledata( htf.bold( 'OTML Tracking Order Number'), ' style="text-align:left"');
   htp.tabledata( htf.formtext( 'P5', 20, 100 ), ' style="text-align:left"');
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( '&nbsp;', ' style="text-align:left"');
   htp.tabledata( htf.bold( 'Date Range From'), ' style="text-align:left"');
   htp.tabledata( htf.formtext( 'P6', 20, 100 ), ' style="text-align:left"');
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( '&nbsp;', ' style="text-align:left"');
   htp.tabledata( htf.bold( 'Date Range To'), ' style="text-align:left"');
   htp.tabledata( htf.formtext( 'P7', 20, 100 ), ' style="text-align:left"');
  htp.tablerowclose;
htp.tableclose;
htp.nl;
htp.p('<CENTER>');
htp.formsubmit( null, 'Run Search' );
htp.formclose;
htp.p('</CENTER>');
htp.p('</TD>');
-- Southbound Ships End

htp.tablerowclose;
htp.tableclose;
htp.nl;
htp.nl;
-- htp.italic( 'Enter one or more of the search criteria. The % sign can be used as a wild char.' );
-- htp.p( '</CENTER>' );
htp.htmlclose;
exception when others then
 error_details( 'STRANGP', 'TRAC_SEARCH',null,null,errmsg=>sqlerrm);
end trac_search;

procedure accept_trac_search( surl in varchar2, p1 in varchar2, p1a in varchar2, p2 in varchar2, p3 in varchar2, p4 in varchar2, p4i in varchar2, p4ii in varchar2, p4a in varchar2, p5 in varchar2, p6 in varchar2, p4aa in varchar2 )
as

 cursor c21(po_nmbr varchar2, po_line varchar2, vste varchar2 ) is
  select /*+ ALL_ROWS */
         distinct
         p.po,
         p.po_item_no,
         p.inventoryno,
         p.supinv,
         dr.logno,
         p.deliveryno,
         dr.itemno,
         dr.handling_unit,
         p.sap_delno,
         p.sap_delno_item,
         r.currdate,
         l.description,
         decode(dr.sa,'S','Sea','A','Air') mode_of_transport,
         decode(dr.sa,'S',s.status,'A',decode(nvl(m.complete,'F'),'F','INCOMPLETE','P','PACKING COMPLETE','A','ARRIVED AT PORT','D','DESPATCHED''W','AWAITING SHIPMENT','S','SHIPPED')) status,
         decode(dr.sa,'S',s.shipname || '&nbsp;&nbsp;' || s.voy || htf.nl || s.sap_ship_id,'A',m.carrier || '&nbsp;&nbsp' || m.flight) vy,
         decode(m.movement_type,'CARGO',m.movement_no || '&nbsp;&nbsp;' || m.seal,'&nbsp;') cargo,
         decode(m.movement_type,'CONMOV',m.movement_no,'&nbsp;') conmov,
         decode(m.movement_type,'AIRWAY',m.movement_no,'&nbsp;') airway,
         nvl(to_char(dr.hawb_hawbno),'&nbsp;') hawb,
         decode(dr.sa,'S',s.estdepart,'A',m.dispatch_date) date_desp,
         decode(dr.sa,'S',s.estarrive,'A',null) eta,
         dr.line_no
  from strang.pos p, strang.detailrs dr, strang.customers c1, strang.receivals r, strang.movements m, strang.ships_airway s, strang.lov l
  where p.deliveryno = dr.deliveryno and
        s.ship_id = m.ship_id and
        l.lov_name = 'CONTROLS' and l.cola = vste and
        substr(l.code,1,11) = 'LOG_PREFIX_' and
        substr(dr.logno,5,1) = substr(l.code,12,1) and
        nvl(r.supplier_customer_id,0) = c1.customer_id and
        c1.customer_type = 'SUPPLIER' and
        p.deliveryno = r.deliveryno and
        m.movement_no = dr.movement_no and
        nvl(m.seal,'|') = nvl(dr.camov_seal,'|') and
        (p.po = po_nmbr and p.po_item_no = po_line)
        order by r.currdate desc, p.po, p.po_item_no, p.supinv,dr.logno,p.deliveryno;

 cursor c22(po_nmbr varchar2, vste varchar2 ) is
  select /*+ ALL_ROWS */
         distinct
         p.po,
         p.po_item_no,
         p.inventoryno,
         p.supinv,
         dr.logno,
         p.deliveryno,
         dr.itemno,
         dr.handling_unit,
         p.sap_delno,
         p.sap_delno_item,
         r.currdate,
         l.description,
         decode(dr.sa,'S','Sea','A','Air') mode_of_transport,
         decode(dr.sa,'S',s.status,'A',decode(nvl(m.complete,'F'),'F','INCOMPLETE','P','PACKING COMPLETE','A','ARRIVED AT PORT','D','DESPATCHED''W','AWAITING SHIPMENT','S','SHIPPED')) status,
         decode(m.movement_type,'AIRWAY',m.movement_no,'&nbsp;') airway,
         decode(dr.sa,'S',s.shipname || '&nbsp;&nbsp;' || s.voy || htf.nl || s.sap_ship_id,'A',m.carrier || '&nbsp;&nbsp' || m.flight) vy,
         decode(m.movement_type,'CARGO',m.movement_no || '&nbsp;&nbsp;' || m.seal,'&nbsp;') cargo,
         decode(m.movement_type,'CONMOV',m.movement_no,'&nbsp;') conmov,
         nvl(to_char(dr.hawb_hawbno),'&nbsp;') hawb,
         decode(dr.sa,'S',s.estdepart,'A',m.dispatch_date) date_desp,
         decode(dr.sa,'S',s.estarrive,'A',null) eta,
         dr.line_no
  from strang.pos p, strang.detailrs dr, strang.customers c1, strang.receivals r, strang.movements m, strang.ships_airway s, strang.lov l
  where p.deliveryno = dr.deliveryno and
        s.ship_id = m.ship_id and
        l.lov_name = 'CONTROLS' and l.cola = vste and
        substr(l.code,1,11) = 'LOG_PREFIX_' and
        substr(dr.logno,5,1) = substr(l.code,12,1) and
        nvl(r.supplier_customer_id,0) = c1.customer_id and
        c1.customer_type = 'SUPPLIER' and
        p.deliveryno = r.deliveryno and
        m.movement_no = dr.movement_no and
        nvl(m.seal,'|') = nvl(dr.camov_seal,'|') and
        p.po = po_nmbr
        order by r.currdate desc, p.po, p.po_item_no, p.supinv,dr.logno,p.deliveryno;

 cursor c23(sapdelno varchar2, sapitem varchar2, vste varchar2 ) is
  select /*+ ALL_ROWS */
         distinct
         p.po,
         p.po_item_no,
         p.inventoryno,
         p.supinv,
         dr.logno,
         p.deliveryno,
         dr.itemno,
         dr.handling_unit,
         p.sap_delno,
         p.sap_delno_item,
         r.currdate,
         l.description,
         decode(dr.sa,'S','Sea','A','Air') mode_of_transport,
         decode(dr.sa,'S',s.status,'A',decode(nvl(m.complete,'F'),'F','INCOMPLETE','P','PACKING COMPLETE','A','ARRIVED AT PORT','D','DESPATCHED''W','AWAITING SHIPMENT','S','SHIPPED')) status,
         decode(dr.sa,'S',s.shipname || '&nbsp;&nbsp;' || s.voy || htf.nl || s.sap_ship_id,'A',m.carrier || '&nbsp;&nbsp' || m.flight) vy,
         decode(m.movement_type,'CARGO',m.movement_no || '&nbsp;&nbsp;' || m.seal,'&nbsp;') cargo,
         decode(m.movement_type,'CONMOV',m.movement_no,'&nbsp;') conmov,
         decode(m.movement_type,'AIRWAY',m.movement_no,'&nbsp;') airway,
         nvl(to_char(dr.hawb_hawbno),'&nbsp;') hawb,
         decode(dr.sa,'S',s.estdepart,'A',m.dispatch_date) date_desp,
         decode(dr.sa,'S',s.estarrive,'A',null) eta,
         dr.line_no
  from strang.pos p, strang.detailrs dr, strang.customers c1, strang.receivals r, strang.movements m, strang.ships_airway s, strang.lov l
  where p.deliveryno = dr.deliveryno and
        s.ship_id = m.ship_id and
        l.lov_name = 'CONTROLS' and l.cola = vste and
        substr(l.code,1,11) = 'LOG_PREFIX_' and
        substr(dr.logno,5,1) = substr(l.code,12,1) and
        nvl(r.supplier_customer_id,0) = c1.customer_id and
        c1.customer_type = 'SUPPLIER' and
        p.deliveryno = r.deliveryno and
        m.movement_no = dr.movement_no and
        nvl(m.seal,'|') = nvl(dr.camov_seal,'|') and
	 (strang.f_sap_format(sapdelno,'DELIVERYNO')=p.sap_delno and p.sap_delno_item = sapitem)
        order by r.currdate desc, p.po, p.po_item_no, p.supinv,dr.logno,p.deliveryno;

 cursor c24(sapdelno varchar2, vste varchar2 ) is
  select /*+ ALL_ROWS */
         distinct
         p.po,
         p.po_item_no,
         p.inventoryno,
         p.supinv,
         dr.logno,
         p.deliveryno,
         dr.itemno,
         dr.handling_unit,
         p.sap_delno,
         p.sap_delno_item,
         r.currdate,
         l.description,
         decode(dr.sa,'S','Sea','A','Air') mode_of_transport,
         decode(dr.sa,'S',s.status,'A',decode(nvl(m.complete,'F'),'F','INCOMPLETE','P','PACKING COMPLETE','A','ARRIVED AT PORT','D','DESPATCHED''W','AWAITING SHIPMENT','S','SHIPPED')) status,
         decode(dr.sa,'S',s.shipname || '&nbsp;&nbsp;' || s.voy || htf.nl || s.sap_ship_id,'A',m.carrier || '&nbsp;&nbsp' || m.flight) vy,
         decode(m.movement_type,'CARGO',m.movement_no || '&nbsp;&nbsp;' || m.seal,'&nbsp;') cargo,
         decode(m.movement_type,'CONMOV',m.movement_no,'&nbsp;') conmov,
         decode(m.movement_type,'AIRWAY',m.movement_no,'&nbsp;') airway,
         nvl(to_char(dr.hawb_hawbno),'&nbsp;') hawb,
         decode(dr.sa,'S',s.estdepart,'A',m.dispatch_date) date_desp,
         decode(dr.sa,'S',s.estarrive,'A',null) eta,
         dr.line_no
  from strang.pos p, strang.detailrs dr, strang.customers c1, strang.receivals r, strang.movements m, strang.ships_airway s, strang.lov l
  where p.deliveryno = dr.deliveryno and
        s.ship_id = m.ship_id and
        l.lov_name = 'CONTROLS' and l.cola = vste and
        substr(l.code,1,11) = 'LOG_PREFIX_' and
        substr(dr.logno,5,1) = substr(l.code,12,1) and
        nvl(r.supplier_customer_id,0) = c1.customer_id and
        c1.customer_type = 'SUPPLIER' and
        p.deliveryno = r.deliveryno and
        m.movement_no = dr.movement_no and
        nvl(m.seal,'|') = nvl(dr.camov_seal,'|') and
	strang.f_sap_format(sapdelno,'DELIVERYNO')=p.sap_delno
        order by r.currdate desc, p.po, p.po_item_no, p.supinv,dr.logno,p.deliveryno;

 cursor c25(supinv_val varchar2, vste varchar2 ) is
  select /*+ ALL_ROWS */
         distinct
         p.po,
         p.po_item_no,
         p.inventoryno,
         p.supinv,
         dr.logno,
         p.deliveryno,
         dr.itemno,
         r.currdate,
         dr.handling_unit,
         p.sap_delno,
         p.sap_delno_item,
         l.description,
         decode(dr.sa,'S','Sea','A','Air') mode_of_transport,
         decode(dr.sa,'S',s.status,'A',decode(nvl(m.complete,'F'),'F','INCOMPLETE','P','PACKING COMPLETE','A','ARRIVED AT PORT','D','DESPATCHED''W','AWAITING SHIPMENT','S','SHIPPED')) status,
         decode(dr.sa,'S',s.shipname || '&nbsp;&nbsp;' || s.voy || htf.nl || s.sap_ship_id,'A',m.carrier || '&nbsp;&nbsp' || m.flight) vy,
         decode(m.movement_type,'CARGO',m.movement_no || '&nbsp;&nbsp;' || m.seal,'&nbsp;') cargo,
         decode(m.movement_type,'CONMOV',m.movement_no,'&nbsp;') conmov,
         decode(m.movement_type,'AIRWAY',m.movement_no,'&nbsp;') airway,
         nvl(to_char(dr.hawb_hawbno),'&nbsp;') hawb,
         decode(dr.sa,'S',s.estdepart,'A',m.dispatch_date) date_desp,
         decode(dr.sa,'S',s.estarrive,'A',null) eta,
         dr.line_no
  from strang.pos p, strang.detailrs dr, strang.customers c1, strang.receivals r, strang.movements m, strang.ships_airway s, strang.lov l
  where p.deliveryno = dr.deliveryno and
        s.ship_id = m.ship_id and
        l.lov_name = 'CONTROLS' and l.cola = vste and
        substr(l.code,1,11) = 'LOG_PREFIX_' and
        substr(dr.logno,5,1) = substr(l.code,12,1) and
        nvl(r.supplier_customer_id,0) = c1.customer_id and
        c1.customer_type = 'SUPPLIER' and
        p.deliveryno = r.deliveryno and
        m.movement_no = dr.movement_no and
        nvl(m.seal,'|') = nvl(dr.camov_seal,'|') and
        supinv_val = p.supinv
        order by r.currdate desc, p.po, p.po_item_no, p.supinv,dr.logno,p.deliveryno;


 cursor c26(invent varchar2, vste varchar2 ) is
  select /*+ ALL_ROWS */
         distinct
         p.po,
         p.po_item_no,
         p.inventoryno,
         p.supinv,
         dr.logno,
         p.deliveryno,
         dr.itemno,
         dr.handling_unit,
         p.sap_delno,
         p.sap_delno_item,
         r.currdate,
         l.description,
         decode(dr.sa,'S','Sea','A','Air') mode_of_transport,
         decode(dr.sa,'S',s.status,'A',decode(nvl(m.complete,'F'),'F','INCOMPLETE','P','PACKING COMPLETE','A','ARRIVED AT PORT','D','DESPATCHED''W','AWAITING SHIPMENT','S','SHIPPED')) status,
         decode(dr.sa,'S',s.shipname || '&nbsp;&nbsp;' || s.voy || htf.nl || s.sap_ship_id,'A',m.carrier || '&nbsp;&nbsp' || m.flight) vy,
         decode(m.movement_type,'CARGO',m.movement_no || '&nbsp;&nbsp;' || m.seal,'&nbsp;') cargo,
         decode(m.movement_type,'CONMOV',m.movement_no,'&nbsp;') conmov,
         decode(m.movement_type,'AIRWAY',m.movement_no,'&nbsp;') airway,
         nvl(to_char(dr.hawb_hawbno),'&nbsp;') hawb,
         decode(dr.sa,'S',s.estdepart,'A',m.dispatch_date) date_desp,
         decode(dr.sa,'S',s.estarrive,'A',null) eta,
         dr.line_no
  from strang.pos p, strang.detailrs dr, strang.customers c1, strang.receivals r, strang.movements m, strang.ships_airway s, strang.lov l
  where p.deliveryno = dr.deliveryno and
        s.ship_id = m.ship_id and
        l.lov_name = 'CONTROLS' and l.cola = vste and
        substr(l.code,1,11) = 'LOG_PREFIX_' and
        substr(dr.logno,5,1) = substr(l.code,12,1) and
        nvl(r.supplier_customer_id,0) = c1.customer_id and
        c1.customer_type = 'SUPPLIER' and
        p.deliveryno = r.deliveryno and
        m.movement_no = dr.movement_no and
        nvl(m.seal,'|') = nvl(dr.camov_seal,'|') and
        invent = p.inventoryno
        order by r.currdate desc, p.po, p.po_item_no, p.supinv,dr.logno,p.deliveryno;

 cursor c27(hu varchar2, vste varchar2 ) is
  select /*+ ALL_ROWS */
         distinct
         p.po,
         p.po_item_no,
         p.inventoryno,
         p.supinv,
         dr.logno,
         p.deliveryno,
         dr.itemno,
         dr.handling_unit,
         p.sap_delno,
         p.sap_delno_item,
         r.currdate,
         l.description,
         decode(dr.sa,'S','Sea','A','Air') mode_of_transport,
         decode(dr.sa,'S',s.status,'A',decode(nvl(m.complete,'F'),'F','INCOMPLETE','P','PACKING COMPLETE','A','ARRIVED AT PORT','D','DESPATCHED''W','AWAITING SHIPMENT','S','SHIPPED')) status,
         decode(dr.sa,'S',s.shipname || '&nbsp;&nbsp;' || s.voy || htf.nl || s.sap_ship_id,'A',m.carrier || '&nbsp;&nbsp' || m.flight) vy,
         decode(m.movement_type,'CARGO',m.movement_no || '&nbsp;&nbsp;' || m.seal,'&nbsp;') cargo,
         decode(m.movement_type,'CONMOV',m.movement_no,'&nbsp;') conmov,
         decode(m.movement_type,'AIRWAY',m.movement_no,'&nbsp;') airway,
         nvl(to_char(dr.hawb_hawbno),'&nbsp;') hawb,
         decode(dr.sa,'S',s.estdepart,'A',m.dispatch_date) date_desp,
         decode(dr.sa,'S',s.estarrive,'A',null) eta,
         dr.line_no
  from strang.pos p, strang.detailrs dr, strang.customers c1, strang.receivals r, strang.movements m, strang.ships_airway s, strang.lov l
  where p.deliveryno = dr.deliveryno and
        s.ship_id = m.ship_id and
        l.lov_name = 'CONTROLS' and l.cola = vste and
        substr(l.code,1,11) = 'LOG_PREFIX_' and
        substr(dr.logno,5,1) = substr(l.code,12,1) and
        nvl(r.supplier_customer_id,0) = c1.customer_id and
        c1.customer_type = 'SUPPLIER' and
        p.deliveryno = r.deliveryno and
        m.movement_no = dr.movement_no and
        nvl(m.seal,'|') = nvl(dr.camov_seal,'|') and
        hu = dr.handling_unit
        order by r.currdate desc, p.po, p.po_item_no, p.supinv,dr.logno,p.deliveryno;

 cursor c28(sname varchar2, vste varchar2 ) is
  select /*+ ALL_ROWS */
         distinct
         p.po,
         p.po_item_no,
         p.inventoryno,
         p.supinv,
         dr.logno,
         p.deliveryno,
         dr.itemno,
         dr.handling_unit,
         p.sap_delno,
         p.sap_delno_item,
         r.currdate,
         l.description,
         decode(dr.sa,'S','Sea','A','Air') mode_of_transport,
         decode(dr.sa,'S',s.status,'A',decode(nvl(m.complete,'F'),'F','INCOMPLETE','P','PACKING COMPLETE','A','ARRIVED AT PORT','D','DESPATCHED''W','AWAITING SHIPMENT','S','SHIPPED')) status,
         decode(dr.sa,'S',s.shipname || '&nbsp;&nbsp;' || s.voy || htf.nl || s.sap_ship_id,'A',m.carrier || '&nbsp;&nbsp' || m.flight) vy,
         decode(m.movement_type,'CARGO',m.movement_no || '&nbsp;&nbsp;' || m.seal,'&nbsp;') cargo,
         decode(m.movement_type,'CONMOV',m.movement_no,'&nbsp;') conmov,
         decode(m.movement_type,'AIRWAY',m.movement_no,'&nbsp;') airway,
         nvl(to_char(dr.hawb_hawbno),'&nbsp;') hawb,
         decode(dr.sa,'S',s.estdepart,'A',m.dispatch_date) date_desp,
         decode(dr.sa,'S',s.estarrive,'A',null) eta,
         dr.line_no
  from strang.pos p, strang.detailrs dr, strang.customers c1, strang.receivals r, strang.movements m, strang.ships_airway s, strang.lov l
  where p.deliveryno = dr.deliveryno and
        s.ship_id = m.ship_id and
        l.lov_name = 'CONTROLS' and l.cola = vste and
        substr(l.code,1,11) = 'LOG_PREFIX_' and
        substr(dr.logno,5,1) = substr(l.code,12,1) and
        nvl(r.supplier_customer_id,0) = c1.customer_id and
        c1.customer_type = 'SUPPLIER' and
        p.deliveryno = r.deliveryno and
        m.movement_no = dr.movement_no and
        nvl(m.seal,'|') = nvl(dr.camov_seal,'|') and
        c1.customer like sname || '%'
        order by r.currdate desc, p.po, p.po_item_no, p.supinv,dr.logno,p.deliveryno;

 cursor c29(dlr varchar2, vste varchar2 ) is
  select /*+ ALL_ROWS */
         distinct
         p.po,
         p.po_item_no,
         p.inventoryno,
         p.supinv,
         dr.logno,
         p.deliveryno,
         dr.itemno,
         dr.handling_unit,
         p.sap_delno,
         p.sap_delno_item,
         r.currdate,
         l.description,
         decode(dr.sa,'S','Sea','A','Air') mode_of_transport,
         decode(dr.sa,'S',s.status,'A',decode(nvl(m.complete,'F'),'F','INCOMPLETE','P','PACKING COMPLETE','A','ARRIVED AT PORT','D','DESPATCHED''W','AWAITING SHIPMENT','S','SHIPPED')) status,
         decode(dr.sa,'S',s.shipname || '&nbsp;&nbsp;' || s.voy || htf.nl || s.sap_ship_id,'A',m.carrier || '&nbsp;&nbsp' || m.flight) vy,
         decode(m.movement_type,'CARGO',m.movement_no || '&nbsp;&nbsp;' || m.seal,'&nbsp;') cargo,
         decode(m.movement_type,'CONMOV',m.movement_no,'&nbsp;') conmov,
         decode(m.movement_type,'AIRWAY',m.movement_no,'&nbsp;') airway,
         nvl(to_char(dr.hawb_hawbno),'&nbsp;') hawb,
         decode(dr.sa,'S',s.estdepart,'A',m.dispatch_date) date_desp,
         decode(dr.sa,'S',s.estarrive,'A',null) eta,
         dr.line_no
  from strang.pos p, strang.detailrs dr, strang.customers c1, strang.receivals r, strang.movements m, strang.ships_airway s, strang.lov l
  where p.deliveryno = dr.deliveryno and
        s.ship_id = m.ship_id and
        l.lov_name = 'CONTROLS' and l.cola = vste and
        substr(l.code,1,11) = 'LOG_PREFIX_' and
        substr(dr.logno,5,1) = substr(l.code,12,1) and
        nvl(r.supplier_customer_id,0) = c1.customer_id and
        c1.customer_type = 'SUPPLIER' and
        p.deliveryno = r.deliveryno and
        m.movement_no = dr.movement_no and
        nvl(m.seal,'|') = nvl(dr.camov_seal,'|') and
        dlr = dr.deliveryno
        order by r.currdate desc, p.po, p.po_item_no, p.supinv,dr.logno,p.deliveryno;

 cursor c30(mvn varchar2, sl varchar2, vste varchar2 ) is
  select /*+ ALL_ROWS */
         distinct
         p.po,
         p.po_item_no,
         p.inventoryno,
         p.supinv,
         dr.logno,
         p.deliveryno,
         dr.itemno,
         dr.handling_unit,
         p.sap_delno,
         p.sap_delno_item,
         r.currdate,
         l.description,
         decode(dr.sa,'S','Sea','A','Air') mode_of_transport,
         decode(dr.sa,'S',s.status,'A',decode(nvl(m.complete,'F'),'F','INCOMPLETE','P','PACKING COMPLETE','A','ARRIVED AT PORT','D','DESPATCHED''W','AWAITING SHIPMENT','S','SHIPPED')) status,
         decode(dr.sa,'S',s.shipname || '&nbsp;&nbsp;' || s.voy || htf.nl || s.sap_ship_id,'A',m.carrier || '&nbsp;&nbsp' || m.flight) vy,
         decode(m.movement_type,'CARGO',m.movement_no || '&nbsp;&nbsp;' || m.seal,'&nbsp;') cargo,
         decode(m.movement_type,'CONMOV',m.movement_no,'&nbsp;') conmov,
         decode(m.movement_type,'AIRWAY',m.movement_no,'&nbsp;') airway,
         nvl(to_char(dr.hawb_hawbno),'&nbsp;') hawb,
         decode(dr.sa,'S',s.estdepart,'A',m.dispatch_date) date_desp,
         decode(dr.sa,'S',s.estarrive,'A',null) eta,
         dr.line_no
  from strang.pos p, strang.detailrs dr, strang.customers c1, strang.receivals r, strang.movements m, strang.ships_airway s, strang.lov l
  where p.deliveryno = dr.deliveryno and
        s.ship_id = m.ship_id and
        l.lov_name = 'CONTROLS' and l.cola = vste and
        substr(l.code,1,11) = 'LOG_PREFIX_' and
        substr(dr.logno,5,1) = substr(l.code,12,1) and
        nvl(r.supplier_customer_id,0) = c1.customer_id and
        nvl(m.seal,'|') = nvl(dr.camov_seal,'|') and
        c1.customer_type = 'SUPPLIER' and
        p.deliveryno = r.deliveryno and
        m.movement_no = dr.movement_no and
        mvn = dr.movement_no and
        nvl(sl,'|') = nvl(m.seal,'|')
        order by r.currdate desc, p.po, p.po_item_no, p.supinv,dr.logno,p.deliveryno;

 cursor c31(mvn varchar2, vste varchar2 ) is
  select /*+ ALL_ROWS */
         distinct
         p.po,
         p.po_item_no,
         p.inventoryno,
         p.supinv,
         dr.logno,
         p.deliveryno,
         dr.itemno,
         dr.handling_unit,
         p.sap_delno,
         p.sap_delno_item,
         r.currdate,
         l.description,
         decode(dr.sa,'S','Sea','A','Air') mode_of_transport,
         decode(dr.sa,'S',s.status,'A',decode(nvl(m.complete,'F'),'F','INCOMPLETE','P','PACKING COMPLETE','A','ARRIVED AT PORT','D','DESPATCHED''W','AWAITING SHIPMENT','S','SHIPPED')) status,
         decode(dr.sa,'S',s.shipname || '&nbsp;&nbsp;' || s.voy || htf.nl || s.sap_ship_id,'A',m.carrier || '&nbsp;&nbsp' || m.flight) vy,
         decode(m.movement_type,'CARGO',m.movement_no || '&nbsp;&nbsp;' || m.seal,'&nbsp;') cargo,
         decode(m.movement_type,'CONMOV',m.movement_no,'&nbsp;') conmov,
         decode(m.movement_type,'AIRWAY',m.movement_no,'&nbsp;') airway,
         nvl(to_char(dr.hawb_hawbno),'&nbsp;') hawb,
         decode(dr.sa,'S',s.estdepart,'A',m.dispatch_date) date_desp,
         decode(dr.sa,'S',s.estarrive,'A',null) eta,
         dr.line_no
  from strang.pos p, strang.detailrs dr, strang.customers c1, strang.receivals r, strang.movements m, strang.ships_airway s, strang.lov l
  where p.deliveryno = dr.deliveryno and
        s.ship_id = m.ship_id and
        l.lov_name = 'CONTROLS' and l.cola = vste and
        substr(l.code,1,11) = 'LOG_PREFIX_' and
        substr(dr.logno,5,1) = substr(l.code,12,1) and
        nvl(r.supplier_customer_id,0) = c1.customer_id and
        c1.customer_type = 'SUPPLIER' and
        p.deliveryno = r.deliveryno and
        m.movement_no = dr.movement_no and
        nvl(m.seal, '|') = nvl(dr.camov_seal, '|') and
        mvn = dr.movement_no
        order by r.currdate desc, p.po, p.po_item_no, p.supinv,dr.logno,p.deliveryno;


 nmb		integer;
 clr		varchar2(100);
 sts		varchar2(100);
 vste		varchar2(10);

begin
 if not dapi.init( surl, 'STRANGP.ACCEPT_TRAC_SEARCH', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'ACCEPT_TRAC_SEARCH' );
    return;
 end if;

 vste := customer_state(dapi.GLOBAL_ACCOUNT.acctid);

 main_title( 'Strang QuickTrac Worldiwde Cargo Tracking Facility',helpid=>'STR46');

 htp.p( '<CENTER>' );
 htp.tableopen( cattributes=>'cellpadding=2 cellspacing=10 border=0' );
  htp.tablerowopen;
   htp.tabledata( htf.bold( 'Strang QuickTrac' ), ' style="text-align:left"');
   htp.tabledata( htf.bold( 'Search Results' ), ' style="text-align:left"');
   htp.tabledata( '&nbsp;', ' style="text-align:left"');
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( htf.bold( 'Worldwide Cargo Tracking Facility' ), ' style="text-align:left"');
   htp.tabledata( '&nbsp;', ' style="text-align:left"');
   htp.tabledata( '&nbsp;', ' style="text-align:left"');
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( '&nbsp;', ' style="text-align:left"');
   htp.tabledata( '&nbsp;', ' style="text-align:left"');
   htp.tabledata( '&nbsp;', ' style="text-align:left"');
  htp.tablerowclose;
 htp.tableclose;

 -- Alternate Colours + Header Colour
 htp.tableopen( cattributes=>'class="str1_table"' );
  htp.tablerowopen;
   htp.tabledata( htf.bold( 'Purchase Order & Line'), 'style="text-align:center"');
   htp.tabledata( htf.bold( 'Material No'), 'style="text-align:center"');
   htp.tabledata( htf.bold( 'OTML Delivery & Item' || htf.nl || 'Handling Unit'), 'style="text-align:center"');
   htp.tabledata( htf.bold( 'Supplier<BR>Invoice No'), 'style="text-align:center"');
   htp.tabledata( htf.bold( 'Daily<BR>Receival Log<BR>Delivery No'), 'style="text-align:center"');
   htp.tabledata( htf.bold( 'Item No'), 'style="text-align:center"');
   htp.tabledata( htf.bold( 'Date<BR>Received'), 'style="text-align:center"');
   htp.tabledata( htf.bold( 'Strang<BR>Depot'), 'style="text-align:center"');
   htp.tabledata( htf.bold( 'Mode of<BR>Transport'), 'style="text-align:center"');
   htp.tabledata( htf.bold( 'Status'), 'style="text-align:center"');
   htp.tabledata( htf.bold( 'Vessel and<BR>Voyage'), 'style="text-align:center"');
   htp.tabledata( htf.bold( 'Ship Manifest<BR>Line No'), 'style="text-align:center"');
   htp.tabledata( htf.bold( 'Container No'), 'style="text-align:center"');
   htp.tabledata( htf.bold( 'Connote No'), 'style="text-align:center"');
   htp.tabledata( htf.bold( 'MAWB #'), 'style="text-align:center"');
   htp.tabledata( htf.bold( 'HAWB #'), 'style="text-align:center"');
   htp.tabledata( htf.bold( 'Date of<BR>Despatch'), 'style="text-align:center"');
   htp.tabledata( htf.bold( 'ETA<BR>Destination'), 'style="text-align:center"');
  htp.tablerowclose;

--- 20170524
 -- If the deliveryno is invalid set it to 0. Query will return no rows.
 begin nmb := to_number(p4); exception when others then nmb := 0; end;

if (trim(p1) is not null and trim(p1a) is not null) then
 for c21rec in c21(trim(p1),trim(p1a),vste ) loop
  if mod(c21%ROWCOUNT,2) = 1
   then
    clr := 'class="str1_cell_center"';
   else
    clr := 'bgcolor="#FFFFFF"';
  end if;
  htp.tablerowopen;
   htp.tabledata( nvl(c21rec.po,'&nbsp;') || htf.nl || nvl(to_char(c21rec.po_item_no),'&nbsp;') , cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(c21rec.inventoryno,'&nbsp;'), cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(to_char(c21rec.sap_delno),'&nbsp;') || htf.nl || nvl(to_char(c21rec.sap_delno_item),'&nbsp;') || htf.nl || nvl(to_char(c21rec.handling_unit),'&nbsp;'), cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(c21rec.supinv,'&nbsp;'), cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(c21rec.logno,'&nbsp;') || htf.nl || c21rec.deliveryno, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(to_char(c21rec.itemno),'&nbsp;'), cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(to_char(c21rec.currdate,'DD-MON-YYYY HH24:MI'),'&nbsp;'), cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c21rec.description, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c21rec.mode_of_transport, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c21rec.status, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c21rec.vy, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c21rec.line_no, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c21rec.cargo, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c21rec.conmov, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c21rec.airway, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c21rec.hawb, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(to_char(c21rec.date_desp,'DD-MON-YYYY HH24:MI'),'&nbsp;'), cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(to_char(c21rec.eta,'DD-MON-YYYY HH24:MI'),'&nbsp;'), cattributes=> clr || ' style="text-align:left"');
  htp.tablerowclose;
 end loop;

  elsif (trim(p1) is not null and trim(p1a) is null) then
 for c22rec in c22(trim(p1), vste ) loop
  if mod(c22%ROWCOUNT,2) = 1
   then
    clr := 'class="str1_cell_center"';
   else
    clr := 'bgcolor="#FFFFFF"';
  end if;
  htp.tablerowopen;
   htp.tabledata( nvl(c22rec.po,'&nbsp;') || htf.nl || nvl(to_char(c22rec.po_item_no),'&nbsp;') , cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(c22rec.inventoryno,'&nbsp;'), cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(to_char(c22rec.sap_delno),'&nbsp;') || htf.nl || nvl(to_char(c22rec.sap_delno_item),'&nbsp;') || htf.nl || nvl(to_char(c22rec.handling_unit),'&nbsp;'), cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(c22rec.supinv,'&nbsp;'), cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(c22rec.logno,'&nbsp;') || htf.nl || c22rec.deliveryno, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(to_char(c22rec.itemno),'&nbsp;'), cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(to_char(c22rec.currdate,'DD-MON-YYYY HH24:MI'),'&nbsp;'), cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c22rec.description, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c22rec.mode_of_transport, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c22rec.status, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c22rec.vy, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c22rec.line_no, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c22rec.cargo, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c22rec.conmov, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c22rec.airway, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c22rec.hawb, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(to_char(c22rec.date_desp,'DD-MON-YYYY HH24:MI'),'&nbsp;'), cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(to_char(c22rec.eta,'DD-MON-YYYY HH24:MI'),'&nbsp;'), cattributes=> clr || ' style="text-align:left"');
  htp.tablerowclose;
 end loop;

 elsif (trim(p4i) is not null and trim(p4ii) is not null) then
 for c23rec in c23(trim(p4i),trim(p4ii), vste ) loop
  if mod(c23%ROWCOUNT,2) = 1
   then
    clr := 'class="str1_cell_center"';
   else
    clr := 'bgcolor="#FFFFFF"';
  end if;
  htp.tablerowopen;
   htp.tabledata( nvl(c23rec.po,'&nbsp;') || htf.nl || nvl(to_char(c23rec.po_item_no),'&nbsp;') , cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(c23rec.inventoryno,'&nbsp;'), cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(to_char(c23rec.sap_delno),'&nbsp;') || htf.nl || nvl(to_char(c23rec.sap_delno_item),'&nbsp;') || htf.nl || nvl(to_char(c23rec.handling_unit),'&nbsp;'), cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(c23rec.supinv,'&nbsp;'), cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(c23rec.logno,'&nbsp;') || htf.nl || c23rec.deliveryno, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(to_char(c23rec.itemno),'&nbsp;'), cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(to_char(c23rec.currdate,'DD-MON-YYYY HH24:MI'),'&nbsp;'), cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c23rec.description, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c23rec.mode_of_transport, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c23rec.status, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c23rec.vy, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c23rec.line_no, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c23rec.cargo, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c23rec.conmov, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(to_char(c23rec.eta,'DD-MON-YYYY HH24:MI'),'&nbsp;'), cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c23rec.airway, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c23rec.hawb, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(to_char(c23rec.date_desp,'DD-MON-YYYY HH24:MI'),'&nbsp;'), cattributes=> clr || ' style="text-align:left"');
  htp.tablerowclose;
 end loop;

 elsif (trim(p4i) is not null and trim(p4ii) is null) then
 for c24rec in c24(trim(p4i), vste ) loop
  if mod(c24%ROWCOUNT,2) = 1
   then
    clr := 'class="str1_cell_center"';
   else
    clr := 'bgcolor="#FFFFFF"';
  end if;
  htp.tablerowopen;
   htp.tabledata( nvl(c24rec.po,'&nbsp;') || htf.nl || nvl(to_char(c24rec.po_item_no),'&nbsp;') , cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(c24rec.inventoryno,'&nbsp;'), cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(to_char(c24rec.sap_delno),'&nbsp;') || htf.nl || nvl(to_char(c24rec.sap_delno_item),'&nbsp;') || htf.nl || nvl(to_char(c24rec.handling_unit),'&nbsp;'), cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(c24rec.supinv,'&nbsp;'), cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(c24rec.logno,'&nbsp;') || htf.nl || c24rec.deliveryno, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(to_char(c24rec.itemno),'&nbsp;'), cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(to_char(c24rec.currdate,'DD-MON-YYYY HH24:MI'),'&nbsp;'), cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c24rec.description, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c24rec.mode_of_transport, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c24rec.status, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c24rec.vy, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c24rec.line_no, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c24rec.cargo, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c24rec.conmov, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c24rec.airway, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c24rec.hawb, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(to_char(c24rec.date_desp,'DD-MON-YYYY HH24:MI'),'&nbsp;'), cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(to_char(c24rec.eta,'DD-MON-YYYY HH24:MI'),'&nbsp;'), cattributes=> clr || ' style="text-align:left"');
  htp.tablerowclose;
 end loop;

 elsif trim(p2) is not null then
 for c25rec in c25(trim(p2), vste ) loop
  if mod(c25%ROWCOUNT,2) = 1
   then
    clr := 'class="str1_cell_center"';
   else
    clr := 'bgcolor="#FFFFFF"';
  end if;
  htp.tablerowopen;
   htp.tabledata( nvl(c25rec.po,'&nbsp;') || htf.nl || nvl(to_char(c25rec.po_item_no),'&nbsp;') , cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(c25rec.inventoryno,'&nbsp;'), cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(to_char(c25rec.sap_delno),'&nbsp;') || htf.nl || nvl(to_char(c25rec.sap_delno_item),'&nbsp;') || htf.nl || nvl(to_char(c25rec.handling_unit),'&nbsp;'), cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(c25rec.supinv,'&nbsp;'), cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(c25rec.logno,'&nbsp;') || htf.nl || c25rec.deliveryno, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(to_char(c25rec.itemno),'&nbsp;'), cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(to_char(c25rec.currdate,'DD-MON-YYYY HH24:MI'),'&nbsp;'), cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c25rec.description, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c25rec.mode_of_transport, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c25rec.status, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c25rec.vy, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c25rec.line_no, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c25rec.cargo, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c25rec.conmov, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c25rec.airway, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c25rec.hawb, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(to_char(c25rec.date_desp,'DD-MON-YYYY HH24:MI'),'&nbsp;'), cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(to_char(c25rec.eta,'DD-MON-YYYY HH24:MI'),'&nbsp;'), cattributes=> clr || ' style="text-align:left"');
  htp.tablerowclose;
 end loop;

   elsif trim(p4aa) is not null then
 for c26rec in c26(trim(p4aa), vste ) loop
  if mod(c26%ROWCOUNT,2) = 1
   then
    clr := 'class="str1_cell_center"';
   else
    clr := 'bgcolor="#FFFFFF"';
  end if;
  htp.tablerowopen;
   htp.tabledata( nvl(c26rec.po,'&nbsp;') || htf.nl || nvl(to_char(c26rec.po_item_no),'&nbsp;') , cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(c26rec.inventoryno,'&nbsp;'), cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(to_char(c26rec.sap_delno),'&nbsp;') || htf.nl || nvl(to_char(c26rec.sap_delno_item),'&nbsp;') || htf.nl || nvl(to_char(c26rec.handling_unit),'&nbsp;'), cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(c26rec.supinv,'&nbsp;'), cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(c26rec.logno,'&nbsp;') || htf.nl || c26rec.deliveryno, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(to_char(c26rec.itemno),'&nbsp;'), cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(to_char(c26rec.currdate,'DD-MON-YYYY HH24:MI'),'&nbsp;'), cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c26rec.description, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c26rec.mode_of_transport, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c26rec.status, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c26rec.vy, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c26rec.line_no, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c26rec.hawb, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c26rec.cargo, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c26rec.conmov, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c26rec.airway, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(to_char(c26rec.date_desp,'DD-MON-YYYY HH24:MI'),'&nbsp;'), cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(to_char(c26rec.eta,'DD-MON-YYYY HH24:MI'),'&nbsp;'), cattributes=> clr || ' style="text-align:left"');
  htp.tablerowclose;
 end loop;
   elsif trim(p4a) is not null then
 for c27rec in c27(trim(p4a), vste ) loop
  if mod(c27%ROWCOUNT,2) = 1
   then
    clr := 'class="str1_cell_center"';
   else
    clr := 'bgcolor="#FFFFFF"';
  end if;
  htp.tablerowopen;
   htp.tabledata( nvl(c27rec.po,'&nbsp;') || htf.nl || nvl(to_char(c27rec.po_item_no),'&nbsp;') , cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(c27rec.inventoryno,'&nbsp;'), cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(to_char(c27rec.sap_delno),'&nbsp;') || htf.nl || nvl(to_char(c27rec.sap_delno_item),'&nbsp;') || htf.nl || nvl(to_char(c27rec.handling_unit),'&nbsp;'), cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(c27rec.supinv,'&nbsp;'), cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(c27rec.logno,'&nbsp;') || htf.nl || c27rec.deliveryno, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(to_char(c27rec.itemno),'&nbsp;'), cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(to_char(c27rec.currdate,'DD-MON-YYYY HH24:MI'),'&nbsp;'), cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c27rec.description, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c27rec.mode_of_transport, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c27rec.status, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c27rec.vy, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c27rec.line_no, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c27rec.cargo, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c27rec.conmov, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c27rec.airway, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c27rec.hawb, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(to_char(c27rec.date_desp,'DD-MON-YYYY HH24:MI'),'&nbsp;'), cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(to_char(c27rec.eta,'DD-MON-YYYY HH24:MI'),'&nbsp;'), cattributes=> clr || ' style="text-align:left"');
  htp.tablerowclose;
 end loop;
   elsif trim(p3) is not null then
 for c28rec in c28(trim(p3), vste ) loop
  if mod(c28%ROWCOUNT,2) = 1
   then
    clr := 'class="str1_cell_center"';
   else
    clr := 'bgcolor="#FFFFFF"';
  end if;
  htp.tablerowopen;
   htp.tabledata( nvl(c28rec.po,'&nbsp;') || htf.nl || nvl(to_char(c28rec.po_item_no),'&nbsp;') , cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(c28rec.inventoryno,'&nbsp;'), cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(to_char(c28rec.sap_delno),'&nbsp;') || htf.nl || nvl(to_char(c28rec.sap_delno_item),'&nbsp;') || htf.nl || nvl(to_char(c28rec.handling_unit),'&nbsp;'), cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(c28rec.supinv,'&nbsp;'), cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(c28rec.logno,'&nbsp;') || htf.nl || c28rec.deliveryno, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(to_char(c28rec.itemno),'&nbsp;'), cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(to_char(c28rec.currdate,'DD-MON-YYYY HH24:MI'),'&nbsp;'), cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c28rec.description, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c28rec.mode_of_transport, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c28rec.status, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c28rec.vy, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c28rec.line_no, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c28rec.cargo, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c28rec.conmov, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c28rec.airway, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c28rec.hawb, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(to_char(c28rec.date_desp,'DD-MON-YYYY HH24:MI'),'&nbsp;'), cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(to_char(c28rec.eta,'DD-MON-YYYY HH24:MI'),'&nbsp;'), cattributes=> clr || ' style="text-align:left"');
  htp.tablerowclose;
 end loop;

 elsif trim(p4) is not null then
 for c29rec in c29(trim(p4), vste ) loop
  if mod(c29%ROWCOUNT,2) = 1
   then
    clr := 'class="str1_cell_center"';
   else
    clr := 'bgcolor="#FFFFFF"';
  end if;
  htp.tablerowopen;
   htp.tabledata( nvl(c29rec.po,'&nbsp;') || htf.nl || nvl(to_char(c29rec.po_item_no),'&nbsp;') , cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(c29rec.inventoryno,'&nbsp;'), cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(to_char(c29rec.sap_delno),'&nbsp;') || htf.nl || nvl(to_char(c29rec.sap_delno_item),'&nbsp;') || htf.nl || nvl(to_char(c29rec.handling_unit),'&nbsp;'), cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(c29rec.supinv,'&nbsp;'), cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(c29rec.logno,'&nbsp;') || htf.nl || c29rec.deliveryno, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(to_char(c29rec.itemno),'&nbsp;'), cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(to_char(c29rec.currdate,'DD-MON-YYYY HH24:MI'),'&nbsp;'), cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c29rec.description, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c29rec.mode_of_transport, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c29rec.status, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c29rec.conmov, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c29rec.vy, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c29rec.line_no, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c29rec.cargo, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c29rec.airway, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c29rec.hawb, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(to_char(c29rec.date_desp,'DD-MON-YYYY HH24:MI'),'&nbsp;'), cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(to_char(c29rec.eta,'DD-MON-YYYY HH24:MI'),'&nbsp;'), cattributes=> clr || ' style="text-align:left"');
  htp.tablerowclose;
 end loop;
   elsif (trim(p5) is not null and trim(p6) is not null) then
 for c30rec in c30(trim(p5),trim(p6), vste ) loop
  if mod(c30%ROWCOUNT,2) = 1
   then
    clr := 'class="str1_cell_center"';
   else
    clr := 'bgcolor="#FFFFFF"';
  end if;
  htp.tablerowopen;
   htp.tabledata( nvl(c30rec.po,'&nbsp;') || htf.nl || nvl(to_char(c30rec.po_item_no),'&nbsp;') , cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(c30rec.inventoryno,'&nbsp;'), cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(to_char(c30rec.sap_delno),'&nbsp;') || htf.nl || nvl(to_char(c30rec.sap_delno_item),'&nbsp;') || htf.nl || nvl(to_char(c30rec.handling_unit),'&nbsp;'), cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(c30rec.supinv,'&nbsp;'), cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(c30rec.logno,'&nbsp;') || htf.nl || c30rec.deliveryno, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(to_char(c30rec.itemno),'&nbsp;'), cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(to_char(c30rec.currdate,'DD-MON-YYYY HH24:MI'),'&nbsp;'), cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c30rec.description, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c30rec.mode_of_transport, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c30rec.status, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c30rec.vy, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c30rec.line_no, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c30rec.cargo, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c30rec.conmov, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c30rec.airway, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c30rec.hawb, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(to_char(c30rec.date_desp,'DD-MON-YYYY HH24:MI'),'&nbsp;'), cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(to_char(c30rec.eta,'DD-MON-YYYY HH24:MI'),'&nbsp;'), cattributes=> clr || ' style="text-align:left"');
  htp.tablerowclose;
 end loop;
   elsif (trim(p5) is not null and trim(p6) is null) then
 for c31rec in c31(trim(p5), vste ) loop
  if mod(c31%ROWCOUNT,2) = 1
   then
    clr := 'class="str1_cell_center"';
   else
    clr := 'bgcolor="#FFFFFF"';
  end if;
  htp.tablerowopen;
   htp.tabledata( nvl(c31rec.po,'&nbsp;') || htf.nl || nvl(to_char(c31rec.po_item_no),'&nbsp;') , cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(c31rec.inventoryno,'&nbsp;'), cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(to_char(c31rec.sap_delno),'&nbsp;') || htf.nl || nvl(to_char(c31rec.sap_delno_item),'&nbsp;') || htf.nl || nvl(to_char(c31rec.handling_unit),'&nbsp;'), cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(c31rec.supinv,'&nbsp;'), cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(c31rec.logno,'&nbsp;') || htf.nl || c31rec.deliveryno, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(to_char(c31rec.itemno),'&nbsp;'), cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(to_char(c31rec.currdate,'DD-MON-YYYY HH24:MI'),'&nbsp;'), cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c31rec.description, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c31rec.mode_of_transport, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c31rec.status, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c31rec.vy, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c31rec.line_no, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c31rec.cargo, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c31rec.conmov, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c31rec.airway, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( c31rec.hawb, cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(to_char(c31rec.date_desp,'DD-MON-YYYY HH24:MI'),'&nbsp;'), cattributes=> clr || ' style="text-align:left"');
   htp.tabledata( nvl(to_char(c31rec.eta,'DD-MON-YYYY HH24:MI'),'&nbsp;'), cattributes=> clr || ' style="text-align:left"');
  htp.tablerowclose;
 end loop;
--   else result
end if;
--- 20170524

 htp.tableclose;
htp.nl;
htp.nl;
 htp.formopen( 'strangp.accept_trac_search' );
 htp.formhidden( 'SURL', surl );
 htp.tableopen( cattributes=>'cellpadding=2 cellspacing=10 border=0' );
  htp.tablerowopen;
   htp.tabledata( htf.bold( 'Search by' || ':'), ' style="text-align:left"');
   htp.tabledata( htf.bold( 'Strang Delivery No'), ' style="text-align:left"');
   htp.tabledata( htf.formtext( 'P4', 20, 100 ), ' style="text-align:left"');
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( '&nbsp;', ' style="text-align:left"');
   htp.tabledata( htf.bold( 'OTML Delivery No'), ' style="text-align:left"');
   htp.tabledata( htf.formtext( 'P4i', 20, 100 ), ' style="text-align:left"');
   htp.tabledata( htf.bold( 'Item '), ' style="text-align:left"');
   htp.tabledata( htf.formtext( 'P4ii', 10, 100 ), ' style="text-align:left"');
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( '&nbsp;', ' style="text-align:left"');
   htp.tabledata( htf.bold( 'Purchase Order Number'), ' style="text-align:left"');
   htp.tabledata( htf.formtext( 'P1', 20, 100 ), ' style="text-align:left"');
  htp.tablerowopen;
   htp.tabledata( htf.bold( 'Line '), ' style="text-align:left"');
   htp.tabledata( htf.formtext( 'P1a', 10, 100 ), ' style="text-align:left"');
  htp.tablerowclose;
   htp.tabledata( '&nbsp;', ' style="text-align:left"');
   htp.tabledata( htf.bold( 'Material No'), ' style="text-align:left"');
   htp.tabledata( htf.formtext( 'p4aa', 20, 100 ), ' style="text-align:left"');
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( '&nbsp;', ' style="text-align:left"');
   htp.tabledata( htf.bold( 'OTML Handling Unit'), ' style="text-align:left"');
   htp.tabledata( htf.formtext( 'p4a', 20, 100 ), ' style="text-align:left"');
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( '&nbsp;', ' style="text-align:left"');
   htp.tabledata( htf.bold( 'Supplier Invoice Number'), ' style="text-align:left"');
   htp.tabledata( htf.formtext( 'P2', 20, 100 ), ' style="text-align:left"');
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( '&nbsp;', ' style="text-align:left"');
   htp.tabledata( htf.bold( 'Supplier Name'), ' style="text-align:left"');
   htp.tabledata( htf.formtext( 'P3', 20, 100 ), ' style="text-align:left"');
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( '&nbsp;', ' style="text-align:left"');
   htp.tabledata( htf.bold( 'Container/Connote/Mawb'), ' style="text-align:left"');
   htp.tabledata( htf.formtext( 'P5', 20, 100 ), ' style="text-align:left"');
   htp.tabledata( htf.bold( 'Seal '), ' style="text-align:left"');
   htp.tabledata( htf.formtext( 'P6', 10, 100 ), ' style="text-align:left"');
  htp.tablerowclose;
htp.tableclose;
htp.nl;
htp.formsubmit( null, 'Run Search' );
htp.formclose;
htp.nl;
htp.htmlclose;
exception when others then
 error_details( 'STRANGP', 'ACCEPT_TRAC_SEARCH',null,null,errmsg=>sqlerrm);
end accept_trac_search;
--
procedure generate_ost356( surl in varchar2, vContainerno in varchar2, vSeal in varchar2 )
as

 cursor c1( vContainerno varchar2, vSeal varchar2 ) is
   select distinct m.movement_no, dr.logno, dr.deliveryno, dr.itemno, dr.handling_unit, dr.partweight, dr.partvolume, dr.qty, dr.pktpe_packtype,
    dr.hazard, dr.ecn, m.seal, s.voy, s.shipname, c.customer, c1.customer supplier,
    l.description pload, p.po, p.supinv, p.amount, p.gst, p.tamount, p.delivery_charge, p.ctry_countrycode, p.recno, p.inventoryno, r.curr,
    l1.description pdischarge, s.estdepart, s.estarrive
    from strang.detailrs dr, strang.ships_airway s, strang.receivals r, strang.movements m, strang.lov l,
    strang.lov l1, strang.customers c, strang.customers c1, strang.pos p
    where
     m.movement_no = vContainerno and
     m.seal = vSeal and
     m.ship_id = s.ship_id and
     m.movement_no = dr.movement_no and
     nvl(m.seal,'|') = nvl(dr.camov_seal,'|') and
     r.deliveryno = dr.deliveryno and
     r.deliveryno = p.deliveryno and
     r.cust_customer_id = c.customer_id and
     r.supplier_customer_id = c1.customer_id and
     l.lov_name = 'LOCATIONS' and
     l.code = s.portload and
     l1.lov_name = 'LOCATIONS' and
    l1.code = s.portdisc
	order by dr.deliveryno, dr.itemno,p.recno;

 cursor c2( vContainerno varchar2, vSeal varchar2 ) is
   select count('x') tot
   from
   (  select distinct m.movement_no, dr.logno, dr.deliveryno, dr.itemno, dr.handling_unit, dr.partweight, dr.partvolume, dr.qty, dr.pktpe_packtype,
     dr.hazard, dr.ecn, m.seal, s.voy, s.shipname, c.customer, c1.customer supplier,
    l.description pload, p.po, p.supinv, p.amount, p.gst, p.tamount, p.delivery_charge, p.ctry_countrycode, p.recno, p.inventoryno, r.curr,
    l1.description pdischarge, s.estdepart, s.estarrive
    from strang.detailrs dr, strang.ships_airway s, strang.receivals r, strang.movements m, strang.lov l,
    strang.lov l1, strang.customers c, strang.customers c1, strang.pos p
    where
     m.movement_no = vContainerno and
     m.seal = vSeal and
     m.ship_id = s.ship_id and
     m.movement_no = dr.movement_no and
     nvl(m.seal,'|') = nvl(dr.camov_seal,'|') and
     r.deliveryno = dr.deliveryno and
     r.deliveryno = p.deliveryno and
     r.cust_customer_id = c.customer_id and
     r.supplier_customer_id = c1.customer_id and
     l.lov_name = 'LOCATIONS' and
     l.code = s.portload and
     l1.lov_name = 'LOCATIONS' and
    l1.code = s.portdisc  );


  f 		utl_file.file_type;
  tot		integer;
  gcode		owa.vc_arr;
  gparam	owa.vc_arr;
  vste		varchar2(10);
  eml		varchar2(100);

  sts		varchar2(100);

begin
 if not dapi.init( surl, 'STRANGP.GENERATE_OST356', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'GENERATE_OST356' );
    return;
 end if;

 vste := customer_state(dapi.GLOBAL_ACCOUNT.acctid);
 eml := control_code( 'OST356_EMAIL_ADDRESS', vste );
 eml := nvl( eml, gl.extract_master_parameter('MAIL_FROM') );

 open c2(vContainerno,vSeal);
 fetch c2 into tot;
 close c2;
 f := utl_file.fopen( gl.extract_master_parameter('MAIL_TEMPLATE_DIR'), 'OST356_' || vContainerno || '_' || vSeal || '.csv', 'w', 32767);

 -- Output Header
 utl_file.put_line(f, buffer=>'H,' || to_char(sysdate,'DD.MM.YYYY') || ',' || tot || ',' );

 for c1rec in c1(vContainerno, vSeal) loop
  utl_file.put_line(f, buffer=>','|| c1rec.deliveryno ||','|| c1rec.itemno||','|| c1rec.recno  ||','|| c1rec.handling_unit ||','|| c1rec.po ||','|| c1rec.supinv ||','|| c1rec.inventoryno ||','|| c1rec.amount ||','|| c1rec.gst ||','|| c1rec.tamount
   ||','|| c1rec.delivery_charge
   ||','|| c1rec.curr ||','|| c1rec.ctry_countrycode ||','|| c1rec.customer ||','|| c1rec.supplier ||','|| c1rec.qty ||','|| c1rec.pktpe_packtype
   ||','|| c1rec.partweight ||','|| c1rec.partvolume ||','|| c1rec.hazard ||','|| c1rec.ecn||','|| c1rec.movement_no || ',' ||
   c1rec.seal ||','|| c1rec.shipname ||','|| c1rec.voy ||','||
   c1rec.pload || ',' || c1rec.pdischarge || ',' ||
   to_char(c1rec.estdepart,'YYYYMMDD') || ',' || to_char(c1rec.estarrive,'YYYYMMDD'));
 end loop;

 -- Output Header
 utl_file.put_line(f, buffer=>'F,' || to_char(sysdate,'DD.MM.YYYY') || ',' || tot || ',' );
 utl_file.fclose( f );

 gcode(1) := 'XXXX'; -- Dummy Parameter
 gparam(1) := 'XXXX';
 hml.send( gcode, gparam, 'OST356_' || vContainerno || '_' || vSeal || '.csv', p_to=>eml, p_subj=>'OST356_' || vContainerno || '_' || vSeal, p_from=>gl.extract_master_parameter('MAIL_FROM'),is_attachment=>TRUE);

exception when others then
 error_details( 'STRANGP', 'GENERATE_OST356',null,null,errmsg=>sqlerrm);
end generate_ost356;

procedure generate_ost256( surl in varchar2, vShip_id in integer )
as

 cursor c1( vShip_id integer ) is
   select distinct dr.movement_no, dr.deliveryno, dr.camov_seal, s.voy, s.shipname,
   decode(l.description,'BRISBANE','BRIS','GLADSTONE','GLAD','TOWNSVILLE','TVL','PORT ALMA','ALMA','NEWCASTLE','NEWC','MELBOURNE','MELB') pload,
   decode(l1.description,'KIUNGA','KNG','PORT MORESBY','POM') pdischarge, s.estdepart, s.estarrive
   from strang.detailrs dr, strang.ships_airway s, strang.receivals r, strang.movements m, strang.lov l, strang.lov l1
   where
    s.ship_id = vShip_id and
    m.ship_id = s.ship_id and
    m.movement_no = dr.movement_no and
    nvl(m.seal,'|') = nvl(dr.camov_seal,'|') and
    r.deliveryno = dr.deliveryno and
    r.cust_customer_id = 1 and
    l.lov_name = 'LOCATIONS' and
    l.code = s.portload and
    l1.lov_name = 'LOCATIONS' and
    l1.code = s.portdisc ;

 cursor c2( vShip_id integer ) is
   select count('x') tot
   from
   (  select distinct dr.movement_no, dr.deliveryno, dr.camov_seal, s.voy, s.shipname,
   decode(l.description,'BRISBANE','BRIS','GLADSTONE','GLAD','TOWNSVILLE','TVL','PORT ALMA','ALMA','NEWCASTLE','NEWC','MELBOURNE','MELB') pload,
   decode(l1.description,'KIUNGA','KNG','PORT MORESBY','POM') pdischarge, s.estdepart, s.estarrive
   from strang.detailrs dr, strang.ships_airway s, strang.receivals r, strang.movements m, strang.lov l, strang.lov l1
   where
    s.ship_id = vShip_id and
    m.ship_id = s.ship_id and
    m.movement_no = dr.movement_no and
    nvl(m.seal,'|') = nvl(dr.camov_seal,'|') and
    r.deliveryno = dr.deliveryno and
    r.cust_customer_id = 1 and
    l.lov_name = 'LOCATIONS' and
    l.code = s.portload and
    l1.lov_name = 'LOCATIONS' and
    l1.code = s.portdisc );

  cursor c3(vShipid integer) is select * from strang.ships_airway where ship_id = vShipid;


  c3rec		c3%ROWTYPE;
  f 		utl_file.file_type;
  tot		integer;
  gcode		owa.vc_arr;
  gparam	owa.vc_arr;
  vste		varchar2(10);
  eml		varchar2(100);

  sts		varchar2(100);

begin
 if not dapi.init( surl, 'STRANGP.GENERATE_CCDETS' , null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'GENERATE_CCDETS'  );
    return;
 end if;

 vste := customer_state(dapi.GLOBAL_ACCOUNT.acctid);
 eml := control_code( 'OST256_EMAIL_ADDRESS', vste );
 eml := nvl( eml, gl.extract_master_parameter('MAIL_FROM') );

 open c2(vShip_id);
 fetch c2 into tot;
 close c2;
 open c3(vShip_id);
 fetch c3 into c3rec;
 close c3;
 f := utl_file.fopen( gl.extract_master_parameter('MAIL_TEMPLATE_DIR'), 'OST256_' || c3rec.shipname || '_' || c3rec.voy || '.csv', 'w', 32767);

 -- Output Header
 utl_file.put_line(f, buffer=>'H,' || to_char(sysdate,'DD.MM.YYYY') || ',' || tot || ','',,'',,'',,'',,'',,'',,'',,'',,'',' );



 for c1rec in c1(vShip_id) loop
  utl_file.put_line(f, buffer=>','|| c1rec.deliveryno ||','|| c1rec.movement_no || ',' || 'OTML TABUBIL' ||','|| c1rec.camov_seal ||','|| c1rec.shipname ||' '|| c1rec.voy ||','||
                               c1rec.shipname ||' '|| c1rec.voy ||','|| 'es,s,Y,' || c1rec.pload || ',' || c1rec.pdischarge || ',' ||
                               to_char(c1rec.estdepart,'YYYYMMDD') || ',' || to_char(c1rec.estarrive,'YYYYMMDD') || ',' ||
                               c1rec.shipname ||' '|| c1rec.voy||','|| c1rec.movement_no || ',' || c1rec.pload );
 end loop;


 -- Output Header
 utl_file.put_line(f, buffer=>'F,' || to_char(sysdate,'DD.MM.YYYY') || ',' || tot || ','',,'',,'',,'',,'',,'',,'',,'',,'',' );
 utl_file.fclose( f );

 gcode(1) := 'XXXX'; -- Dummy Parameter
 gparam(1) := 'XXXX';
 hml.send( gcode, gparam, 'OST256_' || c3rec.shipname || '_' || c3rec.voy || '.csv', p_to=>eml, p_subj=>'OST256_' || c3rec.shipname || '_' || c3rec.voy, p_from=>gl.extract_master_parameter('MAIL_FROM'),is_attachment=>TRUE);

exception when others then
--
 error_details( 'STRANGP', 'GENERATE_OST256',null,null,errmsg=>sqlerrm);
end generate_ost256;

procedure generate_ost156( surl in varchar2, vShip_id in integer )
as

 cursor c1( vShip_id integer ) is
   select distinct dr.movement_no, dr.logno, dr.deliveryno, dr.itemno, p.po, dr.camov_seal, s.voy, s.shipname, s.estdepart, s.estarrive, l.description pload, dr.hazard, dr.partweight, dr.partvolume, c.customer cus1, c1.customer cus2
   from strang.detailrs dr, strang.pos p, strang.ships_airway s, strang.customers c, strang.customers c1, strang.receivals r, strang.movements m, strang.lov l
   where
    s.ship_id = vShip_id and
    m.ship_id = s.ship_id and
    m.movement_no = dr.movement_no and
    nvl(m.seal,'|') = nvl(dr.camov_seal,'|') and
    r.deliveryno = dr.deliveryno and
    r.deliveryno = p.deliveryno and
    r.cust_customer_id = c.customer_id and
    l.lov_name = 'LOCATIONS' and
    l.code = s.portload and
    r.supplier_customer_id = c1.customer_id;

 cursor c2( vShip_id integer ) is
   select count('x') tot
   from
   ( select distinct dr.movement_no, dr.logno, dr.deliveryno, dr.itemno, p.po, dr.camov_seal, s.voy, s.shipname, s.estdepart, s.estarrive, l.description pload, dr.hazard, dr.partweight, dr.partvolume, c.customer cus1, c1.customer cus2
   from strang.detailrs dr, strang.pos p, strang.ships_airway s, strang.customers c, strang.customers c1, strang.receivals r, strang.movements m, strang.lov l
   where
    s.ship_id = vShip_id and
    m.ship_id = s.ship_id and
    m.movement_no = dr.movement_no and
    nvl(m.seal,'|') = nvl(dr.camov_seal,'|') and
    r.deliveryno = dr.deliveryno and
    r.deliveryno = p.deliveryno and
    r.cust_customer_id = c.customer_id and
    l.lov_name = 'LOCATIONS' and
    l.code = s.portload and
    r.supplier_customer_id = c1.customer_id );

  cursor c3(vShipid integer) is select * from strang.ships_airway where ship_id = vShipid;


  c3rec		c3%ROWTYPE;
  f 		utl_file.file_type;
  tot		integer;
  gcode		owa.vc_arr;
  gparam	owa.vc_arr;
  vste		varchar2(10);
  eml		varchar2(100);

  sts		varchar2(100);

begin
 if not dapi.init( surl, 'STRANGP.GENERATE_OST156' , null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'GENERATE_OST156S'  );
    return;
 end if;

 vste := customer_state(dapi.GLOBAL_ACCOUNT.acctid);
 eml := control_code( 'OST156_EMAIL_ADDRESS', vste );
 eml := nvl( eml, gl.extract_master_parameter('MAIL_FROM') );

 open c2(vShip_id);
 fetch c2 into tot;
 close c2;
 open c3(vShip_id);
 fetch c3 into c3rec;
 close c3;
 f := utl_file.fopen( gl.extract_master_parameter('MAIL_TEMPLATE_DIR'), 'OST156_' || c3rec.shipname || '_' || c3rec.voy || '.csv', 'w', 32767);

 -- Output Header
 utl_file.put_line(f, buffer=>'H,' || to_char(sysdate,'DD.MM.YYYY') || ',' || tot || ','',,'',,'',,'',,'',,'',,' );
 for c1rec in c1(vShip_id) loop
  utl_file.put_line(f, buffer=>c1rec.movement_no || ',' || c1rec.logno || ',' || c1rec.deliveryno || ',' || c1rec.itemno || ',' || c1rec.po || ',' || c1rec.camov_seal || ',' || c1rec.voy || ',' || c1rec.shipname ||
                    ',' || to_char(c1rec.estdepart,'DD.MM.YYYY') || ',' || to_char(c1rec.estarrive,'DD.MM.YYYY') || ',' || c1rec.pload || ',' || replace(c1rec.hazard, ',', ' ') || ',' || c1rec.partweight || ',' || c1rec.partvolume || ',' || c1rec.cus1 || ',' || c1rec.cus2 );
 end loop;
 -- Output Header
 utl_file.put_line(f, buffer=>'F,' || to_char(sysdate,'DD.MM.YYYY') || ',' || tot || ','',,'',,'',,'',,'',,'',,' );
 utl_file.fclose( f );

 gcode(1) := 'XXXX'; -- Dummy Parameter
 gparam(1) := 'XXXX';
 hml.send( gcode, gparam, 'OST156_' || c3rec.shipname || '_' || c3rec.voy || '.csv', p_to=>eml, p_subj=>'OST156_' || c3rec.shipname || '_' || c3rec.voy, p_from=>gl.extract_master_parameter('MAIL_FROM'),is_attachment=>TRUE);

exception when others then
 error_details( 'STRANGP', 'GENERATE_OST156',null,null,errmsg=>sqlerrm);
end generate_ost156;

procedure generate_OST157( surl in varchar2, vShip_id in integer )
as

 cursor c1a( vShip_id integer ) is
   select distinct dr.movement_no, dr.logno, dr.deliveryno, dr.itemno, p.po, dr.camov_seal, s.voy, s.shipname, s.estdepart, s.estarrive, l.description pload, dr.hazard, dr.partweight, dr.partvolume, c.customer cus1, c1.customer cus2
   from strang.detailrs dr, strang.pos p, strang.ships_airway s, strang.customers c, strang.customers c1, strang.receivals r, strang.movements m, strang.lov l
   where
    s.ship_id = vShip_id and
    m.ship_id = s.ship_id and
    m.movement_no = dr.movement_no and
    nvl(m.seal,'|') = nvl(dr.camov_seal,'|') and
    r.deliveryno = dr.deliveryno and
    r.deliveryno = p.deliveryno and
    r.cust_customer_id = c.customer_id and
    l.lov_name = 'LOCATIONS' and
    l.code = s.portload and
    r.supplier_customer_id = c1.customer_id AND
    R.CUST_CUSTOMER_ID=1 AND
    (DR.CAMOV_SEAL is not null); -- RETRIEVES ONLY OK-TEDI CONTAINERIZED CARGO

 cursor c1b( vShip_id integer ) is
   select distinct dr.movement_no, dr.logno, dr.deliveryno, dr.itemno, p.po, dr.camov_seal, s.voy, s.shipname, s.estdepart, s.estarrive, l.description pload, dr.hazard, dr.partweight, dr.partvolume, c.customer cus1, c1.customer cus2
   from strang.detailrs dr, strang.pos p, strang.ships_airway s, strang.customers c, strang.customers c1, strang.receivals r, strang.movements m, strang.lov l
   where
    m.ship_id = s.ship_id and
    s.ship_id = vShip_id and
    m.movement_no = dr.movement_no and
    nvl(m.seal,'|') = nvl(dr.camov_seal,'|') and
    r.deliveryno = dr.deliveryno and
    r.deliveryno = p.deliveryno and
    r.cust_customer_id = c.customer_id and
    l.lov_name = 'LOCATIONS' and
    l.code = s.portload and
    r.supplier_customer_id = c1.customer_id AND
    R.CUST_CUSTOMER_ID=1 AND
    (DR.CAMOV_SEAL is null); -- RETRIEVES ONLY OK-TEDI BREAK-BULK CARGO

   cursor c1c( vShip_id integer ) is
     select distinct dr.movement_no
     from strang.detailrs dr, strang.pos p, strang.ships_airway s, strang.customers c, strang.customers c1, strang.receivals r, strang.movements m, strang.lov l
     where
      s.ship_id = vShip_id and
      m.ship_id = s.ship_id and
      m.movement_no = dr.movement_no and
      nvl(m.seal,'|') = nvl(dr.camov_seal,'|') and
      r.deliveryno = dr.deliveryno and
      r.deliveryno = p.deliveryno and
      r.cust_customer_id = c.customer_id and
      l.lov_name = 'LOCATIONS' and
      l.code = s.portload and
      r.supplier_customer_id = c1.customer_id AND
      R.CUST_CUSTOMER_ID>=2 AND
      (DR.CAMOV_SEAL is not null); -- RETRIEVES ONLY CONTRACTOR CONTAINER NUMBERS


 cursor c2a( vShip_id integer ) is
   select count('x') tota
   from
   ( select distinct dr.movement_no, dr.logno, dr.deliveryno, dr.itemno, p.po, dr.camov_seal, s.voy, s.shipname, s.estdepart, s.estarrive, l.description pload, dr.hazard, dr.partweight, dr.partvolume, c.customer cus1, c1.customer cus2
   from strang.detailrs dr, strang.pos p, strang.ships_airway s, strang.customers c, strang.customers c1, strang.receivals r, strang.movements m, strang.lov l
   where
    s.ship_id = vShip_id and
    m.ship_id = s.ship_id and
    m.movement_no = dr.movement_no and
    nvl(m.seal,'|') = nvl(dr.camov_seal,'|') and
    r.deliveryno = dr.deliveryno and
    r.deliveryno = p.deliveryno and
    r.cust_customer_id = c.customer_id and
    l.lov_name = 'LOCATIONS' and
    l.code = s.portload and
    r.supplier_customer_id = c1.customer_id  AND
    R.CUST_CUSTOMER_ID=1 AND
    (DR.CAMOV_SEAL is not null) ); -- RETRIEVES ONLY OK-TEDI CONTAINERIZED CARGO


 cursor c2b( vShip_id integer ) is
   select count('x') totb
   from
   ( select distinct dr.movement_no, dr.logno, dr.deliveryno, dr.itemno, p.po, dr.camov_seal, s.voy, s.shipname, s.estdepart, s.estarrive, l.description pload, dr.hazard, dr.partweight, dr.partvolume, c.customer cus1, c1.customer cus2
   from strang.detailrs dr, strang.pos p, strang.ships_airway s, strang.customers c, strang.customers c1, strang.receivals r, strang.movements m, strang.lov l
   where
    s.ship_id = vShip_id and
    m.ship_id = s.ship_id and
    m.movement_no = dr.movement_no and
    nvl(m.seal,'|') = nvl(dr.camov_seal,'|') and
    r.deliveryno = dr.deliveryno and
    r.deliveryno = p.deliveryno and
    r.cust_customer_id = c.customer_id and
    l.lov_name = 'LOCATIONS' and
    l.code = s.portload and
    r.supplier_customer_id = c1.customer_id  AND
    R.CUST_CUSTOMER_ID=1 AND
    (DR.CAMOV_SEAL is null) ); -- RETRIEVES ONLY OK-TEDI BREAK-BULK CARGO

 cursor c2c( vShip_id integer ) is
   select count('x') totc
   from
   ( select distinct dr.movement_no
   from strang.detailrs dr, strang.pos p, strang.ships_airway s, strang.customers c, strang.customers c1, strang.receivals r, strang.movements m, strang.lov l
   where
    s.ship_id = vShip_id and
    m.ship_id = s.ship_id and
    m.movement_no = dr.movement_no and
    nvl(m.seal,'|') = nvl(dr.camov_seal,'|') and
    r.deliveryno = dr.deliveryno and
    r.deliveryno = p.deliveryno and
    r.cust_customer_id = c.customer_id and
    l.lov_name = 'LOCATIONS' and
    l.code = s.portload and
    r.supplier_customer_id = c1.customer_id  AND
    (DR.CAMOV_SEAL is not null) ); -- RETRIEVES ONLY CONTRACTOR CONTAINER NUMBERS

  cursor c3(vShipid integer) is select * from strang.ships_airway where ship_id = vShipid;

  c3rec		c3%ROWTYPE;
  f 		utl_file.file_type;
  tot		integer;
  tota		integer;
  totb		integer;
  totc		integer;
  gcode		owa.vc_arr;
  gparam	owa.vc_arr;
  vste		varchar2(10);
  lastctr	varchar2(100);
  eml		varchar2(100);
  sts		varchar2(100);

begin
 if not dapi.init( surl, 'STRANGP.GENERATE_OST157' , null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'GENERATE_OST157'  );
    return;
 end if;

 vste := customer_state(dapi.GLOBAL_ACCOUNT.acctid);
 eml := control_code( 'OST156_EMAIL_ADDRESS', vste );
 eml := nvl( eml, gl.extract_master_parameter('MAIL_FROM') );

 -- open c2(vShip_id);
 -- fetch c2 into tot;
 -- close c2;

 open c2a(vShip_id);
 fetch c2a into tota;
 close c2a;
 open c2b(vShip_id);
 fetch c2c into totc;
 fetch c2b into totb;
 close c2b;
 open c2c(vShip_id);
 close c2c;
 tot := tota + totb +totc;
 lastctr := 'BREAKBULK';


 open c3(vShip_id);
 fetch c3 into c3rec;
 close c3;
 f := utl_file.fopen( gl.extract_master_parameter('MAIL_TEMPLATE_DIR'), 'OST157_' || c3rec.shipname || '_' || c3rec.voy || '.csv', 'w', 32767);

 -- Output Header
 utl_file.put_line(f, buffer=>'H,' || to_char(sysdate,'DD.MM.YYYY') || ',' || tot || ','',,'',,'',,'',,'',,'',,' );
 for c1arec in c1a(vShip_id) loop
  utl_file.put_line(f, buffer=>c1arec.movement_no || ',' || c1arec.logno || ',' || c1arec.deliveryno || ',' || c1arec.itemno || ',' || c1arec.po || ',' || c1arec.camov_seal || ',' || c1arec.voy || ',' || c1arec.shipname ||
                    ',' || to_char(c1arec.estdepart,'DD.MM.YYYY') || ',' || to_char(c1arec.estarrive,'DD.MM.YYYY') || ',' || c1arec.pload || ',' || replace(c1arec.hazard, ',', ' ') || ',' || c1arec.partweight || ',' || c1arec.partvolume || ',' || c1arec.cus1 || ',' || c1arec.cus2 );
  lastctr := c1arec.movement_no ;
 end loop;
 for c1brec in c1b(vShip_id) loop
  utl_file.put_line(f, buffer=>lastctr || ',' || c1brec.logno || ',' || c1brec.deliveryno || ',' || c1brec.itemno || ',' || c1brec.po || ',' || c1brec.camov_seal || ',' || c1brec.voy || ',' || c1brec.shipname ||
                    ',' || to_char(c1brec.estdepart,'DD.MM.YYYY') || ',' || to_char(c1brec.estarrive,'DD.MM.YYYY') || ',' || c1brec.pload || ',' || replace(c1brec.hazard, ',', ' ') || ',' || c1brec.partweight || ',' || c1brec.partvolume || ',' || c1brec.cus1 || ',' || c1brec.cus2 );
 end loop;
 for c1crec in c1c(vShip_id) loop
  utl_file.put_line(f, buffer=>c1crec.movement_no || ','',,'',,'',,'',,'',,'',,'',,' );
 end loop;
 -- Output Header
 utl_file.put_line(f, buffer=>'F,' || to_char(sysdate,'DD.MM.YYYY') || ',' || tot || ','',,'',,'',,'',,'',,'',,' );
 utl_file.fclose( f );

 gcode(1) := 'XXXX'; -- Dummy Parameter
 gparam(1) := 'XXXX';
 hml.send( gcode, gparam, 'OST157_' || c3rec.shipname || '_' || c3rec.voy || '.csv', p_to=>eml, p_subj=>'OST157_' || c3rec.shipname || '_' || c3rec.voy, p_from=>gl.extract_master_parameter('MAIL_FROM'),is_attachment=>TRUE);

exception when others then
 error_details( 'STRANGP', 'GENERATE_OST157',null,null,errmsg=>sqlerrm);
end generate_OST157;

procedure generate_ost185( surl in varchar2, vtoday in date, is_batch in varchar2 default 'FALSE' )
as

 cursor c1( vste varchar2 ) is
  select /*+ ALL_ROWS */
         distinct
         p.rowid,
         p.po po,
         p.po_item_no po_item_no,
         p.inventoryno,
         p.supinv supinv,
         dr.logno logno,
         p.deliveryno deliveryno,
         dr.itemno,
         dr.handling_unit,
         p.sap_delno,
         p.sap_delno_item,
         r.currdate currdate,
         l.description,
         decode(dr.sa,'S','SEA','A','AIR') mode_of_transport,
         decode(dr.sa,'S',s.status,'A',decode(nvl(m.complete,'F'),'F','INCOMPLETE','P','PACKING COMPLETE','A','ARRIVED AT PORT','D','DESPATCHED''W','AWAITING SHIPMENT','S','SHIPPED')) status,
         decode(dr.sa,'S',s.shipname,'A',m.movement_no) shp,
         decode(dr.sa,'S',s.voy,'A','') vy,
         decode(m.movement_type,'CARGO',m.movement_no,null) cargo,
         decode(m.movement_type,'CARGO',m.seal,null) sl,
         decode(m.movement_type,'CONMOV',m.movement_no,'') conmov,
         nvl(to_char(dr.hawb_hawbno),'') hawb,
         to_char(decode(dr.sa,'S',s.estdepart,'A',m.dispatch_date), 'dd-Mon-yyyy') date_desp,
         to_char(decode(dr.sa,'S',s.estarrive,'A',m.dispatch_date), 'dd-Mon-yyyy') eta,
         to_char(dr.line_no) line_no
  from strang.pos p, strang.detailrs dr, strang.customers c1, strang.receivals r, strang.movements m, strang.ships_airway s, strang.lov l
  where p.deliveryno = dr.deliveryno and
        s.ship_id = m.ship_id and
        l.lov_name = 'CONTROLS' and l.cola = vste and
        substr(l.code,1,11) = 'LOG_PREFIX_' and
        substr(dr.logno,5,1) = substr(l.code,12,1) and
        nvl(r.supplier_customer_id,0) = c1.customer_id and
        c1.customer_type = 'SUPPLIER' and
        p.deliveryno = r.deliveryno and
        m.movement_no = dr.movement_no and
        nvl(m.seal,'|') = nvl(dr.camov_seal,'|') and
        s.estarrive >= sysdate and
        r.cust_customer_id = 1
union
  select /*+ ALL_ROWS */
         distinct
         p.rowid,
         p.po po,
         p.po_item_no po_item_no,
         p.inventoryno,
         p.supinv supinv,
         dr.logno logno,
         p.deliveryno deliveryno,
         dr.itemno,
         dr.handling_unit,
         p.sap_delno,
         p.sap_delno_item,
         r.currdate currdate,
         l.description,
         decode(dr.sa,'S','SEA','A','AIR') mode_of_transport,
         'RECEIPTED' status,
         'TBA' shp,
         'TBA' vy,
         '' cargo,
         '' sl,
         '' conmov,
         nvl(to_char(dr.hawb_hawbno),'') hawb,
         '' date_desp,
         '' eta,
         '' line_no
  from strang.pos p, strang.detailrs dr, strang.customers c1, strang.receivals r, strang.lov l
  where p.deliveryno = dr.deliveryno and
        l.lov_name = 'CONTROLS' and l.cola = vste and
        substr(l.code,1,11) = 'LOG_PREFIX_' and
        substr(dr.logno,5,1) = substr(l.code,12,1) and
        nvl(r.supplier_customer_id,0) = c1.customer_id and
        c1.customer_type = 'SUPPLIER' and
        p.deliveryno = r.deliveryno and
        dr.movement_no is null and
        r.cust_customer_id = 1
        order by currdate desc, po, po_item_no, supinv,logno,deliveryno
        -- order by r.currdate desc, p.po, p.po_item_no, p.supinv,dr.logno,p.deliveryno
 ;

 cursor c2( vste varchar2 ) is
   select count('x') tot
   from
   (   select /*+ ALL_ROWS */
         distinct
         p.po,
         p.po_item_no,
         p.inventoryno,
         p.supinv,
         dr.logno,
         p.deliveryno,
         dr.itemno,
         dr.handling_unit,
         p.sap_delno,
         p.sap_delno_item,
         r.currdate,
         l.description,
         decode(dr.sa,'S','SEA','A','AIR') mode_of_transport,
         decode(dr.sa,'S',s.status,'A',decode(nvl(m.complete,'F'),'F','INCOMPLETE','P','PACKING COMPLETE','A','ARRIVED AT PORT','D','DESPATCHED''W','AWAITING SHIPMENT','S','SHIPPED')) status,
         decode(dr.sa,'S',s.shipname,'A',m.movement_no) shp,
         decode(dr.sa,'S',s.voy,'A','') vy,
         decode(m.movement_type,'CARGO',m.movement_no,null) cargo,
         decode(m.movement_type,'CARGO',m.seal,null) sl,
         decode(m.movement_type,'CONMOV',m.movement_no,'') conmov,
         nvl(to_char(dr.hawb_hawbno),'') hawb,
         to_char(decode(dr.sa,'S',s.estdepart,'A',m.dispatch_date), 'dd-Mon-yyyy') date_desp,
         to_char(decode(dr.sa,'S',s.estarrive,'A',m.dispatch_date), 'dd-Mon-yyyy') eta,
         to_char(dr.line_no) line_no
  from strang.pos p, strang.detailrs dr, strang.customers c1, strang.receivals r, strang.movements m, strang.ships_airway s, strang.lov l
  where p.deliveryno = dr.deliveryno and
        s.ship_id = m.ship_id and
        l.lov_name = 'CONTROLS' and l.cola = vste and
        substr(l.code,1,11) = 'LOG_PREFIX_' and
        substr(dr.logno,5,1) = substr(l.code,12,1) and
        nvl(r.supplier_customer_id,0) = c1.customer_id and
        c1.customer_type = 'SUPPLIER' and
        p.deliveryno = r.deliveryno and
        m.movement_no = dr.movement_no and
        nvl(m.seal,'|') = nvl(dr.camov_seal,'|') and
        s.estarrive >= sysdate and
        r.cust_customer_id = 1
        -- order by r.currdate desc, p.po, p.po_item_no, p.supinv,dr.logno,p.deliveryno
union
  select /*+ ALL_ROWS */
         distinct
         p.po,
         p.po_item_no,
         p.inventoryno,
         p.supinv,
         dr.logno,
         p.deliveryno,
         dr.itemno,
         dr.handling_unit,
         p.sap_delno,
         p.sap_delno_item,
         r.currdate,
         l.description,
         decode(dr.sa,'S','SEA','A','AIR') mode_of_transport,
         'RECEIPTED' status,
         'TBA' shp,
         'TBA' vy,
         '' cargo,
         '' sl,
         '' conmov,
         nvl(to_char(dr.hawb_hawbno),'') hawb,
         '' date_desp,
         '' eta,
         '' line_no
  from strang.pos p, strang.detailrs dr, strang.customers c1, strang.receivals r, strang.lov l
  where p.deliveryno = dr.deliveryno and
        l.lov_name = 'CONTROLS' and l.cola = vste and
        substr(l.code,1,11) = 'LOG_PREFIX_' and
        substr(dr.logno,5,1) = substr(l.code,12,1) and
        nvl(r.supplier_customer_id,0) = c1.customer_id and
        c1.customer_type = 'SUPPLIER' and
        p.deliveryno = r.deliveryno and
        dr.movement_no is null and
        r.cust_customer_id = 1
        -- order by r.currdate desc, p.po, p.po_item_no, p.supinv,dr.logno,p.deliveryno
);

  cursor c3(vtoday date) is select to_char(sysdate) v1date from dual;

  c3rec       c3%ROWTYPE;
  f           utl_file.file_type;
  tot         integer;
  gcode       owa.vc_arr;
  gparam      owa.vc_arr;
  vste        varchar2(10);
  eml         varchar2(100);
  ltype       varchar2(100);
  stype       integer;
  sts         varchar2(100);
  ctr         integer;
  f_dir       CONSTANT varchar2(1000) := gl.extract_master_parameter('MAIL_OUTPUT_DIR');
  f_file      CONSTANT varchar2(1000) := 'OST185_' || to_char(sysdate, 'dd_mon_yyyy_hh24mi') || '.csv';

begin
 if nvl(is_batch, 'FALSE') = 'TRUE'
  then
   sts := null;
   vste := 'SYD';
 else
  if not dapi.init( surl, 'STRANGP.GENERATE_OST185' , null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'GENERATE_OST185'   );
    return;
  end if;

   vste := customer_state(dapi.GLOBAL_ACCOUNT.acctid);
 end if;

 if sts is not null
  then
  REDISPLAY_LOGIN_PAGE( sts, TRUE );
  return;
 end if;

 eml := control_code( 'OST185_EMAIL_ADDRESS', vste );
 eml := nvl( eml, gl.extract_master_parameter('MAIL_FROM') );

 open c2(vste);
 fetch c2 into tot;
 close c2;
 open c3(vtoday);
 fetch c3 into c3rec;
 close c3;
 -- Output Header
 -- f := utl_file.fopen( gl.extract_master_parameter('MAIL_TEMPLATE_DIR'), 'OST185_' || to_char(sysdate, 'dd_mon_yyyy_hh24mi') || '.csv', 'w', 32767);
 f := utl_file.fopen( f_dir, f_file, 'w', 32767);

 utl_file.put_line(f, buffer=>'H,' || to_char(sysdate,'DD.MM.YYYY') || ',' || tot );
 ctr := 0;
 for c1rec in c1(vste) loop
  utl_file.put_line(f, buffer=>c1rec.po || ',' || c1rec.po_item_no || ',' || c1rec.inventoryno || ',' || c1rec.supinv || ',' || c1rec.logno || ','
                        || c1rec.deliveryno || ',' || c1rec.itemno || ',' || c1rec.handling_unit || ','
                        ||  c1rec.sap_delno || ',' || c1rec.sap_delno_item || ',' || c1rec.currdate || ',' || c1rec.mode_of_transport || ',' || c1rec.status || ',' || c1rec.shp || ','
                        || c1rec.vy || ',' || c1rec.cargo || ',' || c1rec.sl || ', '||  c1rec.conmov || ',' || c1rec.hawb || ',' || c1rec.date_desp || ',' || c1rec.eta || ',' || c1rec.line_no
                        );
  update strang.pos set off_site_receipt = sysdate where rowid = c1rec.rowid;
--  update strang.pos set po_waybill_type = c1rec.po_waybill_type where rowid = c1rec.rowid;
--  update strang.pos set qty = c1rec.partweight where unit_unitused in ('BAGS','BAG') and rowid = c1rec.rowid;
--  update strang.pos set unit_unitused = 'KG' where unit_unitused in ('BAGS','BAG') and rowid = c1rec.rowid;

  ctr := ctr + 1;
 end loop;
 -- Output Header
 utl_file.put_line(f, buffer=>'F,' || to_char(sysdate,'DD.MM.YYYY') || ',' || tot  );
 utl_file.fclose( f );

 gcode(1) := 'XXXX'; -- Dummy Parameter
 gparam(1) := 'XXXX';

 if ctr > 0
  then
   -- hml.send( gcode, gparam, 'OST185_' || to_char(sysdate, 'dd_mon_yyyy_hh24mi') || '.csv', p_to=>eml, p_subj=>'OST185_' || c3rec.v1date || '_' || to_char(sysdate, 'hh24mi'), p_from=>gl.extract_master_parameter('MAIL_FROM'),is_attachment=>TRUE);
   hml.send( gcode, gparam, f_file, p_to=>eml, p_subj=>'OST185_' || c3rec.v1date || '_' || to_char(sysdate, 'hh24mi'), p_from=>gl.extract_master_parameter('MAIL_FROM'),is_attachment=>TRUE);
   ftp_ost_185(f_dir || chr(92) || f_file, 'SFTP');
 else
   begin
    -- utl_file.fremove(gl.extract_master_parameter('MAIL_TEMPLATE_DIR'), 'OST185_' || to_char(sysdate, 'dd_mon_yyyy_hh24mi') || '.csv');
    utl_file.fremove(f_dir, f_file);
   exception when others then null;
   end;
 end if;

 if nvl(is_batch, 'FALSE') = 'TRUE'
  then
   return;
 else
   strangp.ost_185_screen(surl,'MESSAGE', ctr || ' records processed');
 end if;

exception when others then
 error_details( 'STRANGP', 'GENERATE_OST185',null,null,errmsg=>sqlerrm);
end generate_ost185;


procedure manentry(surl in varchar2, rid in varchar2 default null, scid in varchar2 default null, call_name in varchar2 default null, parm in varchar2 default null, access_id in varchar2 default null, msg in varchar2 default null, id in varchar2 default null )
as

 cursor c2( rid rowid ) is select * from strang.manentry where rowid = rid;
 cursor c5( entryno number) is select rowid from strang.manent2 where entry_no = entryno and rno = (select min(rno) from strang.manent2 where entry_no = entryno);


 c2rec		c2%ROWTYPE;
 c5rec		c5%ROWTYPE;

 sts		varchar2(100);
 nrid		varchar2(100);
 vaccess	varchar2(20);

begin
  if not dapi.init( surl, 'STRANGP.MANENTRY', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'MANENTRY' );
    return;
  end if;

 nrid := replace(rid,'~','+');
 vaccess := data_access( 'MANENTRY' );
 open c2( nrid );
 fetch c2 into c2rec;
 close c2;

 main_title( 'Manual Entry - Header Details',helpid=>'STR47');
 if vaccess = 'NONE' then htp.bold( 'Access Denied' ); htp.htmlclose; return; end if;
 if msg is not null then header_msg( msg ); end if;
 htp.p( '<CENTER>' );

 --htp.anchor( 'javascript: window.open(''' || 'strangs.list_entry?surl=' || surl || ''',''' || 'SAD_ENTRY' || ''',''height=800,width=1200,scrollbars=yes,resizable=yes'');void('''');', '[Test List All SAD]' );
 if data_access( 'SAD' ) = 'EDIT'
  then
   htp.anchor( 'javascript: window.open(''' || 'strangs.accept_list_entry?surl=' || surl || '&p1=&p2=&p3=&p4=' || c2rec.entry_no || ''',''' || 'SAD_ENTRY' || ''',''height=800,width=1200,scrollbars=yes,resizable=yes'');void('''');', '[Generate and Edit SAD:' || c2rec.entry_no || ']' );
   htp.nl;
 end if;

 htp.formopen( 'strangp.accept_manentry' );
  htp.formhidden( 'SURL', surl );
  htp.formhidden( 'SCID', scid );
  htp.formhidden( 'PARM', parm );
  htp.formhidden( 'CALL_NAME', call_name );
  htp.formhidden( 'ACCESS_ID', access_id );
  htp.formhidden( 'RID', nrid );
  htp.formhidden( 'OLD_ENTRY', c2rec.entry_no );

 htp.nl;
 htp.tableopen( cattributes=>'cellpadding=2 cellspacing=2 border=0' );
 htp.tablerowopen;
 htp.p( '<TD VALIGN="TOP" ALIGN="LEFT">' );
 htp.tableopen( cattributes=>'class="str1_table"' );
  htp.tablerowopen;
   htp.tabledata( htf.bold('Manual Entry Number'), cattributes=>'class="str1_bg_right"' );
   if vaccess = 'EDIT' and c2rec.entry_no is null
    then
     htp.tabledata( htf.formtext( 'ENTRYNO', 10, 20, c2rec.entry_no), cattributes=>'class="str1_cell_left"' );
    elsif vaccess = 'EDIT' and c2rec.entry_no is not null
     then
     htp.tabledata( htf.formhidden( 'ENTRYNO', c2rec.entry_no ) || htf.bold( c2rec.entry_no ), cattributes=>'class="str1_cell_left"' );
    else
     htp.tabledata( htf.bold( c2rec.entry_no ), cattributes=>'class="str1_cell_left"' );
   end if;
   htp.tabledata( htf.bold('Warrant No'), cattributes=>'class="str1_bg_right"' );
   if vaccess = 'EDIT' then htp.tabledata( htf.formhidden( 'P1', 'WARRANT_NO' ) || htf.formtext( 'P2', 10, 15, c2rec.warrant_no), cattributes=>'class="str1_bg_center"' || 'align="LEFT"' );
   else htp.tabledata( htf.bold( c2rec.warrant_no ), cattributes=>'class="str1_bg_center"' || 'align="LEFT"' );
   end if;
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( htf.bold('CPC') || htf.nl || htf.bold('Account'), cattributes=>'class="str1_bg_right"' );
   if vaccess = 'EDIT' then htp.tabledata( htf.formhidden( 'P1', 'CPC' ) || htf.formtext( 'P2', 30, 30, c2rec.cpc) || htf.nl ||
                                           htf.formhidden( 'P1', 'ACCOUNT_NUMBER' ) || htf.formtext( 'P2', 10, 15, c2rec.account_number), cattributes=>'class="str1_cell_left"' );
   else htp.tabledata( htf.bold( c2rec.cpc ) || htf.nl || htf.bold( c2rec.account_number ), cattributes=>'class="str1_cell_left"' );
   end if;
   htp.tabledata( htf.bold('Cheque No'), cattributes=>'class="str1_bg_right"' );
   if vaccess = 'EDIT' then htp.tabledata( htf.formhidden( 'P1', 'CHEQUE_NO' ) || htf.formtext( 'P2', 10, 15, c2rec.cheque_no), cattributes=>'class="str1_bg_center"' || 'align="LEFT"' );
   else htp.tabledata( htf.bold( c2rec.cheque_no ), cattributes=>'class="str1_bg_center"' || 'align="LEFT"' );
   end if;
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( htf.bold('Exporter/Consignor'), cattributes=>'class="str1_bg_right"' );
   if vaccess = 'EDIT' then htp.tabledata( htf.formhidden( 'P1', 'EXPORTER' ) || htf.formtext( 'P2', 40, 40, c2rec.exporter), cattributes=>'class="str1_cell_left"' );
   else htp.tabledata( htf.bold( c2rec.exporter ), cattributes=>'class="str1_cell_left"' );
   end if;
   htp.tabledata( htf.bold('Duty'), cattributes=>'class="str1_bg_right"' );
   htp.tabledata( htf.bold( nvl(to_char(c2rec.duty,'999999999.99'),'&nbsp;') ), cattributes=>'class="str1_bg_center"' || 'align="LEFT"' );
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( htf.bold('Address'), cattributes=>'class="str1_bg_right"' );
   if vaccess = 'EDIT' then htp.tabledata( htf.formhidden( 'P1', 'EXPORTER_ADDRESS' ) || htf.formtext( 'P2', 20, 25, c2rec.exporter_address), cattributes=>'class="str1_cell_left"' );
   else htp.tabledata( htf.bold( c2rec.exporter_address ), cattributes=>'class="str1_cell_left"' );
   end if;
   htp.tabledata( htf.bold('Excise'), cattributes=>'class="str1_bg_right"' );
   htp.tabledata( htf.bold( nvl(to_char(c2rec.excise,'999999999.99'),'&nbsp;' )), cattributes=>'class="str1_bg_center"' || 'align="LEFT"' );
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( '&nbsp;', cattributes=>'class="str1_bg_right"' );
   if vaccess = 'EDIT' then htp.tabledata( htf.formhidden( 'P1', 'EXPORTER_ADDRESS1' ) || htf.formtext( 'P2', 20, 25, c2rec.exporter_address1), cattributes=>'class="str1_cell_left"' );
   else htp.tabledata( htf.bold( c2rec.exporter_address1 ), cattributes=>'class="str1_cell_left"' );
   end if;
   htp.tabledata( htf.bold('VAT'), cattributes=>'class="str1_bg_right"' );
   htp.tabledata( htf.bold( nvl(to_char(c2rec.vat,'999999999.99'),'&nbsp;' )), cattributes=>'class="str1_bg_center"' || 'align="LEFT"' );
  htp.tablerowclose;

  htp.tablerowopen;
   htp.tabledata( htf.bold('1a Code'), cattributes=>'class="str1_bg_right"' );
   if vaccess = 'EDIT' then htp.tabledata( htf.formhidden( 'P1', 'ONE_A_CODE' ) || htf.formtext( 'P2', 20, 25, c2rec.one_a_code), cattributes=>'class="str1_cell_left"' );
   else htp.tabledata( htf.bold( c2rec.one_a_code ), cattributes=>'class="str1_cell_left"' );
   end if;
   htp.tabledata( htf.bold('Levy'), cattributes=>'class="str1_bg_right"' );
   htp.tabledata( htf.bold( nvl(to_char(c2rec.levy,'999999999.99'),'&nbsp;' ) ), cattributes=>'class="str1_bg_center"' || 'align="LEFT"' );
  htp.tablerowclose;

  htp.tablerowopen;
   htp.tabledata( htf.bold('Importer/Consignee'), cattributes=>'class="str1_bg_right"' );
   if vaccess = 'EDIT' then htp.tabledata( htf.formhidden( 'P1', 'IMPORTER' ) || htf.formtext( 'P2', 40, 40, c2rec.importer), cattributes=>'class="str1_cell_center"' || 'align="LEFT" COLSPAN="1"' );
   else htp.tabledata( htf.bold( c2rec.importer ), cattributes=>'class="str1_cell_center"' || 'align="LEFT" COLSPAN="1"' );
   end if;
   htp.tabledata( htf.bold('Variance'), cattributes=>'class="str1_bg_right"' );
   htp.tabledata( htf.bold( nvl(to_char(c2rec.pvariance,'999999999999.99'),'&nbsp;' )), cattributes=>'class="str1_bg_center"' || 'align="LEFT"' );
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( htf.bold('Address'), cattributes=>'class="str1_bg_right"' );
   if vaccess = 'EDIT' then htp.tabledata( htf.formhidden( 'P1', 'IMPORTER_ADDRESS' ) || htf.formtext( 'P2', 20, 25, c2rec.importer_address), cattributes=>'class="str1_cell_center"' || 'align="LEFT" COLSPAN="3"' );
  htp.tablerowopen;
   else htp.tabledata( htf.bold( c2rec.importer_address ), cattributes=>'class="str1_cell_center"' || 'align="LEFT" COLSPAN="3"' );
   end if;
  htp.tablerowclose;
   htp.tabledata( '&nbsp;', cattributes=>'class="str1_bg_right"' );
   if vaccess = 'EDIT' then htp.tabledata( htf.formhidden( 'P1', 'IMPORTER_ADDRESS1' ) || htf.formtext( 'P2', 20, 25, c2rec.importer_address1), cattributes=>'class="str1_cell_left"' );
   else htp.tabledata( htf.bold( c2rec.importer_address1 ), cattributes=>'class="str1_cell_left"' );
   end if;
   htp.tabledata( htf.bold('2a Code'), cattributes=>'class="str1_bg_right"' );
   if vaccess = 'EDIT' then htp.tabledata( htf.formhidden( 'P1', 'TWO_A_CODE' ) || htf.formtext( 'P2', 15, 15, c2rec.two_a_code), cattributes=>'class="str1_cell_left"' );
   else htp.tabledata( htf.bold( c2rec.two_a_code ), cattributes=>'class="str1_cell_left"' );
   end if;
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( '&nbsp;', cattributes=>'class="str1_bg_right"' );
   htp.tabledata( '&nbsp;', cattributes=>'class="str1_cell_center"' || 'align="LEFT" COLSPAN="3"' );
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( htf.bold('Declarant Agent'), cattributes=>'class="str1_bg_right"' );
   if vaccess = 'EDIT' then htp.tabledata( htf.formhidden( 'P1', 'DECLARER' ) || htf.formtext( 'P2', 20, 20, c2rec.declarer), cattributes=>'class="str1_cell_center"' || 'align="LEFT" COLSPAN="3"' );
   else htp.tabledata( htf.bold( c2rec.declarer ), cattributes=>'class="str1_cell_center"' || 'align="LEFT" COLSPAN="3"' );
   end if;
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( htf.bold('Address'), cattributes=>'class="str1_bg_right"' );
   if vaccess = 'EDIT' then htp.tabledata( htf.formhidden( 'P1', 'DECLARER_ADDRESS' ) || htf.formtext( 'P2', 25, 25, c2rec.declarer_address), cattributes=>'class="str1_cell_center"' || 'align="LEFT" COLSPAN="3"' );
   else htp.tabledata( htf.bold( c2rec.declarer_address ), cattributes=>'class="str1_cell_center"' || 'align="LEFT" COLSPAN="3"' );
   end if;
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( '&nbsp;', cattributes=>'class="str1_bg_right"' );
   if vaccess = 'EDIT' then htp.tabledata( htf.formhidden( 'P1', 'DECLARER_ADDRESS1' ) || htf.formtext( 'P2', 25, 25, c2rec.declarer_address1), cattributes=>'class="str1_cell_left"' );
   else htp.tabledata( htf.bold( c2rec.declarer_address1 ), cattributes=>'class="str1_cell_left"' );
   end if;
   htp.tabledata( htf.bold('3a Code'), cattributes=>'class="str1_bg_right"' );
   if vaccess = 'EDIT' then htp.tabledata( htf.formhidden( 'P1', 'THREE_A_CODE' ) || htf.formtext( 'P2', 15, 15, c2rec.three_a_code), cattributes=>'class="str1_cell_left"' );
   else htp.tabledata( htf.bold( c2rec.three_a_code ), cattributes=>'class="str1_cell_left"' );
   end if;
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( '&nbsp;', cattributes=>'class="str1_bg_right"' );
   htp.tabledata( '&nbsp;', cattributes=>'class="str1_cell_left"' );
   htp.tabledata( htf.bold('3b Reference'), cattributes=>'class="str1_bg_right"' );
   if vaccess = 'EDIT' then htp.tabledata( htf.formhidden( 'P1', 'THREE_B_REFERENCE' ) || htf.formtext( 'P2', 15, 15, c2rec.three_b_reference), cattributes=>'class="str1_cell_left"' );
   else htp.tabledata( htf.bold( c2rec.three_b_reference ), cattributes=>'class="str1_cell_left"' );
   end if;
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( htf.bold('Agent'), cattributes=>'class="str1_bg_right"' );
   if vaccess = 'EDIT' then htp.tabledata( htf.formhidden( 'P1', 'AGENT' ) || htf.formtext( 'P2', 25, 25, c2rec.agent), cattributes=>'class="str1_cell_left"' );
   else htp.tabledata( htf.bold( c2rec.agent ), cattributes=>'class="str1_cell_left"' );
   end if;
   htp.tabledata( htf.bold('Position'), cattributes=>'class="str1_bg_right"' );
   if vaccess = 'EDIT' then htp.tabledata( htf.formhidden( 'P1', 'POSITION' ) || htf.formtext( 'P2', 20, 30, c2rec.position), cattributes=>'class="str1_cell_left"' );
   else htp.tabledata( htf.bold( c2rec.position ), cattributes=>'class="str1_cell_left"' );
   end if;
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( htf.bold('Short Description<BR>of Cargo'), cattributes=>'class="str1_bg_right"' );
   if vaccess = 'EDIT' then htp.tabledata( htf.formhidden( 'P1', 'SHORTDESC' ) || htf.formtext( 'P2', 30, 30, c2rec.shortdesc), cattributes=>'class="str1_cell_center"' || 'align="LEFT" COLSPAN="3"' );
   else htp.tabledata( htf.bold( c2rec.shortdesc ), cattributes=>'class="str1_cell_center"' || 'align="LEFT" COLSPAN="3"' );
   end if;
  htp.tablerowclose;
 htp.tableclose;
 htp.tableopen( cattributes=>'class="str1_table"' );
  htp.tablerowopen;
   htp.tabledata( htf.bold('Port of Loading'), cattributes=>'class="str1_bg_right"' );
   if vaccess = 'EDIT' then htp.tabledata( htf.formhidden( 'P1', 'PORT_OF_LOADING' ) || htf.formtext( 'P2', 15, 15, c2rec.port_of_loading), cattributes=>'class="str1_cell_left"' );
   else htp.tabledata( htf.bold( c2rec.port_of_loading ), cattributes=>'class="str1_cell_left"' );
   end if;
   htp.tabledata( htf.bold('Port of Discharge'), cattributes=>'class="str1_bg_right"' );
   if vaccess = 'EDIT' then htp.tabledata( htf.formhidden( 'P1', 'PORT_OF_DISCHARGE' ) || htf.formtext( 'P2', 15, 15, c2rec.port_of_discharge), cattributes=>'class="str1_cell_left"' );
   else htp.tabledata( htf.bold( c2rec.port_of_discharge ), cattributes=>'class="str1_cell_left"' );
  htp.tablerowclose;
   end if;
   htp.tabledata( '&nbsp;', cattributes=>'class="str1_bg_right"' );
   htp.tabledata( '&nbsp;', cattributes=>'class="str1_cell_left"' );
  htp.tablerowopen;
   htp.tabledata( htf.bold('Ship'), cattributes=>'class="str1_bg_right"' );
   if vaccess = 'EDIT' then htp.tabledata( htf.formhidden( 'P1', 'SHIP_NAME' ) || htf.formtext( 'P2', 30, 40, c2rec.ship_name), cattributes=>'class="str1_cell_left"' );
   else htp.tabledata( htf.bold( c2rec.ship_name ), cattributes=>'class="str1_cell_left"' );
   end if;
   htp.tabledata( htf.bold('Voyage'), cattributes=>'class="str1_bg_right"' );
   if vaccess = 'EDIT' then htp.tabledata( htf.formhidden( 'P1', 'VOYAGE' ) || htf.formtext( 'P2', 15, 15, c2rec.voyage), cattributes=>'class="str1_cell_left"' );
   else htp.tabledata( htf.bold( c2rec.voyage ), cattributes=>'class="str1_cell_left"' );
   end if;
   htp.tabledata( '&nbsp;', cattributes=>'class="str1_bg_right"' );
   htp.tabledata( '&nbsp;', cattributes=>'class="str1_cell_left"' );
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( htf.bold('Manifest Lines'), cattributes=>'class="str1_bg_right"' );
   if vaccess = 'EDIT' then htp.tabledata( htf.formhidden( 'P1', 'MANIFEST_LINES' ) || htf.formtext( 'P2', 25, 25, c2rec.manifest_lines), cattributes=>'class="str1_cell_left"' );
   else htp.tabledata( htf.bold( c2rec.manifest_lines ), cattributes=>'class="str1_cell_left"' );
   end if;
   htp.tabledata( htf.bold('Bills of Lading'), cattributes=>'class="str1_bg_right"' );
   if vaccess = 'EDIT' then htp.tabledata( htf.formhidden( 'P1', 'BILL_OF_LADING' ) || htf.formtext( 'P2', 15, 15, c2rec.bill_of_lading), cattributes=>'class="str1_cell_left"' );
   else htp.tabledata( htf.bold( c2rec.bill_of_lading ), cattributes=>'class="str1_cell_left"' );
   end if;
   htp.tabledata( '&nbsp;', cattributes=>'class="str1_bg_right"' );
   htp.tabledata( '&nbsp;', cattributes=>'class="str1_cell_left"' );
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( htf.bold('Arr/Dept Date'), cattributes=>'class="str1_bg_right"' );
   if vaccess = 'EDIT' then htp.tabledata( htf.formhidden( 'P1', 'DATE_OF_ARRIVAL_DEPARTURE' ) || htf.formtext( 'P2', 15, 15, c2rec.date_of_arrival_departure), cattributes=>'class="str1_cell_left"' );
   else htp.tabledata( htf.bold( c2rec.date_of_arrival_departure ), cattributes=>'class="str1_cell_left"' );
   end if;
   htp.tabledata( htf.bold('Country'), cattributes=>'class="str1_bg_right"' );
   if vaccess = 'EDIT' then htp.tabledata( htf.formhidden( 'P1', 'COUNTRY_NAME' ) || htf.formtext( 'P2', 25, 25, c2rec.country_name), cattributes=>'class="str1_cell_left"' );
   else htp.tabledata( htf.bold( c2rec.country_name ), cattributes=>'class="str1_cell_left"' );
   end if;
   htp.tabledata( htf.bold('Code'), cattributes=>'class="str1_bg_right"' );
   if vaccess = 'EDIT' then htp.tabledata( htf.formhidden( 'P1', 'COUNTRY_CODE' ) || htf.formtext( 'P2', 3, 3, c2rec.country_code), cattributes=>'class="str1_cell_left"' );
   else htp.tabledata( htf.bold( c2rec.country_code ), cattributes=>'class="str1_cell_left"' );
   end if;
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( htf.bold('Invoice Total'), cattributes=>'class="str1_bg_right"' );
   if vaccess = 'EDIT' then htp.tabledata( htf.formhidden( 'P1', 'INVOICE_TOTAL' ) || htf.formtext( 'P2', 15, 20, trim(to_char(c2rec.invoice_total,'999999999999.99'))), cattributes=>'class="str1_cell_left"' );
   else htp.tabledata( htf.bold( to_char(c2rec.invoice_total,'999999999999.99') ), cattributes=>'class="str1_cell_left"' );
   end if;
   htp.tabledata( htf.bold('Currency'), cattributes=>'class="str1_bg_right"' );
   if vaccess = 'EDIT' then htp.tabledata( htf.formhidden( 'P1', 'CURRENCY_CODE' ) || htf.formtext( 'P2', 3, 3, c2rec.currency_code), cattributes=>'class="str1_cell_left"' );
   else htp.tabledata( htf.bold( c2rec.currency_code ), cattributes=>'class="str1_cell_left"' );
   end if;
   htp.tabledata( htf.bold('Exchange Rate'), cattributes=>'class="str1_bg_right"' );
   if vaccess = 'EDIT' then htp.tabledata( htf.formhidden( 'P1', 'EXCHANGE_RATE' ) || htf.formtext( 'P2', 10, 20, c2rec.exchange_rate), cattributes=>'class="str1_cell_left"' );
   else htp.tabledata( htf.bold( c2rec.exchange_rate ), cattributes=>'class="str1_cell_left"' );
   end if;
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( htf.bold('Insurance Rate'), cattributes=>'class="str1_bg_right"' );
   if vaccess = 'EDIT' then htp.tabledata( htf.formhidden( 'P1', 'INSURANCE_RATE' ) || htf.formtext( 'P2', 10, 20, trim(to_char(c2rec.insurance_rate,'999999.99'))), cattributes=>'class="str1_cell_left"' );
   else htp.tabledata( htf.bold( to_char(c2rec.insurance_rate,'999999.99') ), cattributes=>'class="str1_cell_left"' );
   end if;
   htp.tabledata( '&nbsp;', cattributes=>'class="str1_bg_right"' );
   htp.tabledata( '&nbsp;', cattributes=>'class="str1_cell_left"' );
   htp.tabledata( htf.bold('Other Costs Rate'), cattributes=>'class="str1_bg_right"' );
   if vaccess = 'EDIT' then htp.tabledata( htf.formhidden( 'P1', 'OTHER_COSTS_RATE' ) || htf.formtext( 'P2', 10, 20, c2rec.other_costs_rate), cattributes=>'class="str1_cell_left"' );
   else htp.tabledata( htf.bold( c2rec.other_costs_rate ), cattributes=>'class="str1_cell_left"' );
   end if;
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( htf.bold('Freight Rate'), cattributes=>'class="str1_bg_right"' );
   if vaccess = 'EDIT' then htp.tabledata( htf.formhidden( 'P1', 'FREIGHT_RATE' ) || htf.formtext( 'P2', 10, 20, trim(to_char(c2rec.freight_rate,'999999.99'))), cattributes=>'class="str1_cell_left"' );
   else htp.tabledata( htf.bold( to_char(c2rec.freight_rate,'999999.99') ), cattributes=>'class="str1_cell_left"' );
   end if;
   htp.tabledata( '&nbsp;', cattributes=>'class="str1_bg_right"' );
   htp.tabledata( '&nbsp;', cattributes=>'class="str1_cell_left"' );
   htp.tabledata( htf.bold('Revenue Tonne'), cattributes=>'class="str1_bg_right"' );
   if vaccess = 'EDIT' then htp.tabledata( htf.formhidden( 'P1', 'REVENUE_TONNE' ) || htf.formtext( 'P2', 10, 20, c2rec.revenue_tonne), cattributes=>'class="str1_cell_left"' );
   else htp.tabledata( htf.bold( c2rec.exchange_rate ), cattributes=>'class="str1_cell_left"' );
   end if;
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( htf.bold('Freight'), cattributes=>'class="str1_bg_right"' );
   if vaccess = 'EDIT' then htp.tabledata( htf.formhidden( 'P1', 'FREIGHT' ) || htf.formtext( 'P2', 10, 20, to_char(c2rec.freight,'999999.99')), cattributes=>'class="str1_cell_left"' );
   else htp.tabledata( htf.bold( to_char(c2rec.freight,'999999.99') ), cattributes=>'class="str1_cell_left"' );
   end if;
   htp.tabledata( htf.bold('Insurance'), cattributes=>'class="str1_bg_right"' );
   if vaccess = 'EDIT' then htp.tabledata( htf.formhidden( 'P1', 'INSURANCE' ) || htf.formtext( 'P2', 10, 20, to_char(c2rec.insurance,'999999.99')), cattributes=>'class="str1_cell_left"' );
   else htp.tabledata( htf.bold( to_char(c2rec.insurance,'999999.99') ), cattributes=>'class="str1_cell_left"' );
   end if;
   htp.tabledata( htf.bold('Other Costs'), cattributes=>'class="str1_bg_right"' );
   if vaccess = 'EDIT' then htp.tabledata( htf.formhidden( 'P1', 'OTHER_COSTS' ) || htf.formtext( 'P2', 10, 20, to_char(c2rec.other_costs,'999999.99')), cattributes=>'class="str1_cell_left"' );
   else htp.tabledata( htf.bold( to_char(c2rec.other_costs,'999999.99') ), cattributes=>'class="str1_cell_left"' );
   end if;
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( htf.bold('Ratio Factor'), cattributes=>'class="str1_bg_right"' );
   if vaccess = 'EDIT' then htp.tabledata( htf.formhidden( 'P1', 'RATIO_FACTOR' ) || htf.formtext( 'P2', 20, 20, to_char(c2rec.ratio_factor,'999.99999999')), cattributes=>'class="str1_cell_center"' || 'align="LEFT" COLSPAN="2"' );
   else htp.tabledata( htf.bold( to_char(c2rec.ratio_factor,'999.99999999') ), cattributes=>'class="str1_cell_center"' || 'align="LEFT" COLSPAN="2"' );
   end if;
   htp.tabledata( '&nbsp;', cattributes=>'class="str1_cell_left"' );
   htp.tabledata( '&nbsp;', cattributes=>'class="str1_bg_right"' );
   htp.tabledata( '&nbsp;', cattributes=>'class="str1_cell_left"' );
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( htf.bold('Mode of Transport'), cattributes=>'class="str1_bg_right"' );
   if vaccess = 'EDIT' then htp.tabledata( htf.formhidden( 'P1', 'MODE_OF_TRANSPORT' ) || htf.formtext( 'P2', 10, 10, c2rec.mode_of_transport), cattributes=>'class="str1_cell_left"' );
   else htp.tabledata( htf.bold( c2rec.mode_of_transport ), cattributes=>'class="str1_cell_left"' );
   end if;
   htp.tabledata( htf.bold('Code'), cattributes=>'class="str1_bg_right"' );
   if vaccess = 'EDIT' then htp.tabledata( htf.formhidden( 'P1', 'CODE' ) || htf.formtext( 'P2', 10, 15, c2rec.code), cattributes=>'class="str1_cell_center"' || 'align="LEFT" COLSPAN="3"' );
   else htp.tabledata( htf.bold( c2rec.code ), cattributes=>'class="str1_cell_center"' || 'align="LEFT" COLSPAN="3"' );
   end if;
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( htf.bold('Warehouse'), cattributes=>'class="str1_bg_right"' );
   if vaccess = 'EDIT' then htp.tabledata( htf.formhidden( 'P1', 'WAREHOUSE_NAME' ) || htf.formtext( 'P2', 10, 15, c2rec.warehouse_name), cattributes=>'class="str1_cell_left"' );
   else htp.tabledata( htf.bold( c2rec.warehouse_name ), cattributes=>'class="str1_cell_left"' );
   end if;
   htp.tabledata( htf.bold('No'), cattributes=>'class="str1_bg_right"' );
   if vaccess = 'EDIT' then htp.tabledata( htf.formhidden( 'P1', 'WAREHOUSE_NUMBER' ) || htf.formtext( 'P2', 10, 15, c2rec.warehouse_number), cattributes=>'class="str1_cell_center"' || 'align="LEFT" COLSPAN="3"' );
   else htp.tabledata( htf.bold( c2rec.warehouse_number ), cattributes=>'class="str1_cell_center"' || 'align="LEFT" COLSPAN="3"' );
   end if;
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( htf.bold('Terms of Delivery'), cattributes=>'class="str1_bg_right"' );
   if vaccess = 'EDIT' then htp.tabledata( htf.formhidden( 'P1', 'TERMS_OF_DELIVERY' ) || htf.formtext( 'P2', 15, 15, c2rec.terms_of_delivery), cattributes=>'class="str1_cell_left"' );
   else htp.tabledata( htf.bold( c2rec.terms_of_delivery ), cattributes=>'class="str1_cell_left"' );
   end if;
   htp.tabledata( htf.bold('Predeeding Doc'), cattributes=>'class="str1_bg_right"' );
   if vaccess = 'EDIT' then htp.tabledata( htf.formhidden( 'P1', 'PRECEDING_DOCUMENTS' ) || htf.formtext( 'P2', 15, 15, c2rec.preceding_documents), cattributes=>'class="str1_cell_center"' || 'align="LEFT" COLSPAN="3"' );
   else htp.tabledata( htf.bold( c2rec.preceding_documents ), cattributes=>'class="str1_cell_center"' || 'align="LEFT" COLSPAN="3"' );
   end if;
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( htf.bold('Invoice'), cattributes=>'class="str1_bg_right"' );
   htp.tabledata( htf.bold('Supporting Documents'), cattributes=>'class="str1_bg_center"' || 'align="LEFT" COLSPAN="6"' );
  htp.tablerowclose;
  htp.tablerowopen;
   if vaccess = 'EDIT' then htp.tabledata( htf.formhidden( 'P1', 'ATTACHMENTS_INVOICES' ) || htf.formtext( 'P2', 3, 3, c2rec.attachments_invoices), cattributes=>'class="str1_cell_left"' );
   else htp.tabledata( htf.bold( c2rec.attachments_invoices ), cattributes=>'class="str1_cell_left"' );
   end if;
   htp.tabledata( htf.bold('Packing List'), cattributes=>'class="str1_bg_right"' );
   if vaccess = 'EDIT' then htp.tabledata( htf.formhidden( 'P1', 'ATTACHMENTS_PACKING' ) || htf.formtext( 'P2', 3, 3, c2rec.attachments_packing), cattributes=>'class="str1_cell_left"' );
   else htp.tabledata( htf.bold( c2rec.attachments_packing ), cattributes=>'class="str1_cell_left"' );
   end if;
   htp.tabledata( htf.bold('Delivery Order'), cattributes=>'class="str1_bg_right"' );
   if vaccess = 'EDIT' then htp.tabledata( htf.formhidden( 'P1', 'ATTACHMENTS_ORDER' ) || htf.formtext( 'P2', 3, 3, c2rec.attachments_order), cattributes=>'class="str1_cell_left"' );
   else htp.tabledata( htf.bold( c2rec.attachments_order ), cattributes=>'class="str1_cell_left"' );
   end if;
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( htf.bold('Licence'), cattributes=>'class="str1_bg_right"' );
   if vaccess = 'EDIT' then htp.tabledata( htf.formhidden( 'P1', 'ATTACHMENTS_LICENCE' ) || htf.formtext( 'P2', 3, 3, c2rec.attachments_licence), cattributes=>'class="str1_cell_left"' );
   else htp.tabledata( htf.bold( c2rec.attachments_licence ), cattributes=>'class="str1_cell_left"' );
   end if;
   htp.tabledata( htf.bold('Freight Doc'), cattributes=>'class="str1_bg_right"' );
   if vaccess = 'EDIT' then htp.tabledata( htf.formhidden( 'P1', 'ATTACHMENTS_FREIGHT' ) || htf.formtext( 'P2', 3, 3, c2rec.attachments_freight), cattributes=>'class="str1_cell_left"' );
   else htp.tabledata( htf.bold( c2rec.attachments_freight ), cattributes=>'class="str1_cell_left"' );
   end if;
   htp.tabledata( htf.bold('Other'), cattributes=>'class="str1_bg_right"' );
   if vaccess = 'EDIT' then htp.tabledata( htf.formhidden( 'P1', 'ATTACHMENTS_OTHER' ) || htf.formtext( 'P2', 3, 3, c2rec.attachments_other), cattributes=>'class="str1_cell_left"' );
   else htp.tabledata( htf.bold( c2rec.attachments_other ), cattributes=>'class="str1_cell_left"' );
   end if;
  htp.tablerowclose;
 htp.tableclose;

 htp.p( '</TD>' );
 htp.tablerowclose;
 htp.tableclose;

 htp.nl;
 htp.tableopen( cattributes=>'cellpadding=2 cellspacing=2 border=0' );
  htp.tablerowopen;
  if vaccess = 'EDIT'
   then

    if rid is not null
     then
      htp.p( '<TD VALIGN="TOP">' );
       htp.formsubmit( 'ACTION', 'Update' );
      htp.p( '</TD>' );
      htp.p( '<TD VALIGN="TOP">' );
       htp.formsubmit( 'ACTION', 'Package Description' );
      htp.p( '</TD>' );
      htp.p( '<TD VALIGN="TOP">' );
       htp.formsubmit( 'ACTION', 'Tariff Groups' );
      htp.p( '</TD>' );
      htp.p( '<TD VALIGN="TOP">' );
       htp.formsubmit( 'ACTION', 'Delete' );
      htp.p( '</TD>' );
      htp.p( '<TD VALIGN="TOP">' );
       htp.formsubmit( 'ACTION', 'Create New Entry' );
      htp.p( '</TD>' );
      htp.p( '<TD VALIGN="TOP">' );
       htp.formsubmit( 'ACTION', 'Recalculate' );
       htp.formclose;
      htp.p( '</TD>' );
     else
      htp.p( '<TD VALIGN="TOP">' );
       htp.formsubmit( 'ACTION', 'Insert' );
       htp.formclose;
      htp.p( '</TD>' );
    end if;

  else

    if rid is not null
     then
      htp.p( '<TD VALIGN="TOP">' );
       htp.anchor( 'strangp.manentry_page2?surl=' || surl || '&rid=' || replace(nrid,'+','~') || '&scid=' || scid || '&call_name=' || replace(call_name,' ','+') || '&parm=' || replace(parm,' ','+') || '&access_id=' || access_id, 'Package Description' );
      htp.p( '</TD>' );
      open c5(c2rec.entry_no);
      fetch c5 into c5rec;
      close c5;
      htp.p( '<TD VALIGN="TOP">' );
       htp.anchor( 'strangp.manentry_page3?surl=' || surl || '&rid=' || replace(rowidtochar(c5rec.rowid),'+','~') || '&scid=' || scid || '&call_name=' || replace(call_name,' ','+') || '&parm=' || replace(parm,' ','+') || '&access_id=' || access_id, 'Tariff Groups' );
      htp.p( '</TD>' );
    end if;

 end if;

 htp.p( '<TD VALIGN="TOP">' );
   search( surl, 'ME', nrid, samerow=>TRUE );
 htp.p( '</TD>' );
  htp.tablerowclose;
 htp.tableclose;
 htp.formclose;
 htp.p( '</CENTER>' );
 htp.htmlclose;
exception when others then
 error_details( 'STRANGP', 'MANENTRY',null,null,errmsg=>sqlerrm);
end manentry;

procedure accept_manentry(surl in varchar2, rid in varchar2, scid in varchar2, call_name in varchar2, parm in varchar2, old_entry in varchar2, entryno in varchar2, access_id in varchar2 default null, action in varchar2, p1 in owa.vc_arr, p2 in owa.vc_arr )
as

 cursor c2( rid rowid ) is select * from strang.manentry where rowid = rid;
 cursor c3( ent varchar2 ) is select count('x') exst from strang.manentry where entry_no = ent;
 cursor c4( entryno number) is select rowidtochar(rowid) from strang.manentry where entry_no = entryno;

 cursor c5( entryno number) is select rowid from strang.manent2 where entry_no = entryno and rno = (select min(rno) from strang.manent2 where entry_no = entryno);
 cursor c8( entryno number) is select rowid,tariff from strang.manent2 where entry_no = entryno;
 cursor c9( lv varchar2, cd varchar2 ) is select * from strang.lov where lov_name = lv and code = cd;

 c2rec		c2%ROWTYPE;
 c3rec		c3%ROWTYPE;
 c5rec		c5%ROWTYPE;
 c9rec		c9%ROWTYPE;

 sts		varchar2(100);
 nrid		varchar2(100);
 vaccess	varchar2(20);
 msg		varchar2(100);
 nmb		integer;

begin
  if not dapi.init( surl, 'STRANGP.ACCEPT_MANENTRY', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'ACCEPT_MANENTRY' );
    return;
  end if;

 nrid := replace(rid,'~','+');
 vaccess := data_access( 'MANENTRY' );

 if vaccess = 'EDIT'
  then

 -- Validate Number
 begin
  nmb := to_number(entryno);
 exception
  when others then
   manentry( surl, nrid, scid, call_name, parm, access_id, 'Invalid Number:' || entryno );
   return;
 end;
 if entryno is null
  then
   manentry( surl, nrid, scid, call_name, parm, access_id, 'Entry Number cannot be empty:' || entryno );
   return;
 end if;
 if action = 'Insert'
  then
   open c3( entryno );
   fetch c3 into c3rec;
   close c3;
   if c3rec.exst > 0
    then
     manentry( surl, nrid, scid, call_name, parm, access_id, 'Already exists: ' || entryno  );
     return;
   end if;
   insert into strang.manentry(entry_no) values (entryno);
   insert into strang.manent1(entry_no) values (entryno);
   insert into strang.manent2(entry_no,rno) values (entryno,1);
   msg := 'Manual Entry Inserted';
 elsif action = 'Delete'
  then
   confirm_manentry_delete( surl, nrid, scid, call_name, parm, access_id, 'Delete Manual Entry ' || entryno );
   return;
 else
   if nvl(old_entry,'!') <> nvl(entryno,chr(92))
    then
     open c3( entryno );
     fetch c3 into c3rec;
     close c3;
     if c3rec.exst > 0
      then
        manentry( surl, nrid, scid, call_name, parm, access_id, 'Already exists: ' || entryno  );
       return;
     end if;
     update strang.manentry set entry_no = entryno where entry_no = old_entry;
   end if;
   open c2( nrid );
   fetch c2 into c2rec;
   close c2;
 end if;
 if action <> 'Delete'
  then
   for j in p1.first..p1.last loop
    begin
     execute immediate
      'update strang.manentry set ' || p1(j) || ' = :1 where entry_no = :2'
        using p2(j), entryno;
    exception
     when others then msg := msg || '[Error Modifying ' || initcap(p1(j)) || ' to value: ' || p2(j) || ']';
    end;
   end loop;
 end if;
 commit;
 if action = 'Recalculate'
  then
   update strang.manentry
    set
     freight = nvl(revenue_tonne,1) * nvl(freight_rate,1) * nvl(exchange_rate,1),
     insurance = (nvl(insurance_rate,0) / 100) * nvl(invoice_total,1),
     other_costs = nvl(invoice_total,1) * (nvl(other_costs_rate,0)/100)
   where entry_no = entryno;
   update strang.manentry
    set
     ratio_factor = ((nvl(invoice_total,0) + nvl(freight,0) + nvl(other_costs,0) + nvl(insurance,0)) /
                      decode(nvl(exchange_rate,1),0,1,nvl(exchange_rate,1)) ) /
                    decode(nvl(invoice_total,1),0,1,nvl(invoice_total,1))
   where entry_no = entryno;
  else
   update strang.manentry
    set
     freight = nvl(freight,nvl(revenue_tonne,1) * nvl(freight_rate,1) * nvl(exchange_rate,1)),
     insurance = nvl(insurance,(nvl(insurance_rate,0) / 100) * nvl(invoice_total,1)),
     other_costs = nvl(other_costs,nvl(invoice_total,1) * (nvl(other_costs_rate,0)/100))
   where entry_no = entryno;
   update strang.manentry
    set
     ratio_factor = nvl(ratio_factor,
                    ((nvl(invoice_total,0) + nvl(freight,0) + nvl(other_costs,0) + nvl(insurance,0)) /
                      decode(nvl(exchange_rate,1),0,1,nvl(exchange_rate,1)) ) /
                      decode(nvl(invoice_total,1),0,1,nvl(invoice_total,1)))
   where entry_no = entryno;
 end if;

 if action = 'Recalculate'
  then
   -- Refresh all the Tariff's
   update strang.manentry m1
    set
      duty = (select sum(nvl(m2.duty,0)) from strang.manent2 m2 where m2.entry_no = entryno ),
      vat = (select sum(nvl(m2.vat,0)) from strang.manent2 m2 where m2.entry_no = entryno ),
      excise = (select sum(nvl(m2.excise,0)) from strang.manent2 m2 where m2.entry_no = entryno ),
      levy = (select sum(nvl(m2.levy,0)) from strang.manent2 m2 where m2.entry_no = entry_no )
     where
      entry_no = entryno;
   update strang.manentry m1
    set
      pvariance = (select (m1.duty + m1.excise + m1.vat + nvl(m1.levy,0)) - ((sum(nvl(m2.kinavalue,0)) * 0.015) + sum(nvl(m2.oldduty,0)) ) from strang.manent2 m2 where entry_no = entryno )
     where
      entry_no = entryno;

   for c8rec in c8(entryno) loop
    open c9( 'TARIFF', c8rec.tariff );
    fetch c9 into c9rec;
    if c9%FOUND
     then
     close c9;

     update strang.manent2 m2
      set
       unit = c9rec.cola,
       rate = c9rec.description,
        excise_rate = c9rec.colc,
       oldrate = c9rec.colb,
       kinavalue = (select ratio_factor * m2.value from strang.manentry where entry_no = entryno)
      where rowid = c8rec.rowid;

     update strang.manent2 m2
      set
       duty = (select (ratio_factor * m2.value * m2.rate ) / 100 from strang.manentry where entry_no = entryno)
     where rowid = c8rec.rowid;

     update strang.manent2 m2
      set
       oldduty = (select (ratio_factor * m2.value * m2.oldrate ) / 100 from strang.manentry where entry_no = entryno)
     where rowid = c8rec.rowid;

     update strang.manent2 m2
      set
       excise = (select ( ((ratio_factor * m2.value) + m2.duty) * m2.excise_rate ) / 100 from strang.manentry where entry_no = entryno)
     where rowid = c8rec.rowid;

     update strang.manent2 m2
      set
       vat = ((nvl(kinavalue,0) + nvl(duty,0) + nvl(excise,0)) * nvl(vat_rate,1)) / 100
     where rowid = c8rec.rowid;

    else
     close c9;
    end if;

   end loop;

   commit;
 end if;

 end if; -- End of Edit Data
 msg := nvl(msg,'Manual Record Updated');
 open c4(entryno);
 fetch c4 into nrid;
 close c4;

 if action in ('Insert','Update','Recalculate')
  then
   manentry( surl, nrid, scid, call_name, parm, access_id, msg );
 elsif action = 'Create New Entry'
  then
   manentry( surl, null, scid, call_name, parm, access_id, msg );
 elsif action = 'Package Description'
  then
   manentry_page2( surl, nrid, scid, call_name, parm, access_id, msg );
 elsif action = 'Tariff Groups'
  then
   open c5(entryno);
   fetch c5 into c5rec;
   close c5;
   manentry_page3( surl, rowidtochar(c5rec.rowid), scid, call_name, parm, access_id, msg );
 end if;

exception when others then
 error_details( 'STRANGP', 'ACCEPT_MANENTRY',null,null,errmsg=>sqlerrm);
end accept_manentry;

procedure manentry_page2(surl in varchar2, rid in varchar2, scid in varchar2, call_name in varchar2, parm in varchar2, access_id in varchar2 default null, msg in varchar2 default null )
as

 cursor c2( rid rowid ) is select * from strang.manentry where rowid = rid;
 cursor c3( entryno number ) is select * from strang.manent1 where entry_no = entryno;
 cursor c5( entryno number) is select rowid from strang.manent2 where entry_no = entryno and rno = (select min(rno) from strang.manent2 where entry_no = entryno);


 c2rec		c2%ROWTYPE;
 c3rec		c3%ROWTYPE;
 c5rec		c5%ROWTYPE;

 sts		varchar2(100);
 nrid		varchar2(100);
 vaccess	varchar2(20);

begin
  if not dapi.init( surl, 'STRANGP.MANENTRY_PAGE2', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'MANENTRY_PAGE2' );
    return;
  end if;

 nrid := replace(rid,'~','+');
 vaccess := data_access( 'MANENTRY' );
 open c2( nrid );
 fetch c2 into c2rec;
 close c2;
 open c3( c2rec.entry_no );
 fetch c3 into c3rec;
 close c3;

 main_title( 'Manual Entry - Package Description',helpid=>'STR48');
 if vaccess = 'NONE' then htp.bold( 'Access Denied' ); htp.htmlclose; return; end if;
 if msg is not null then header_msg( msg ); end if;
 htp.p( '<CENTER>' );

 if vaccess = 'EDIT'
  then
   htp.formopen( 'strangp.accept_manentry_page2' );
   htp.formhidden( 'SURL', surl );
   htp.formhidden( 'SCID', scid );
   htp.formhidden( 'PARM', parm );
   htp.formhidden( 'CALL_NAME', call_name );
   htp.formhidden( 'ACCESS_ID', access_id );
   htp.formhidden( 'RID', nrid );
   htp.formhidden( 'OLD_ENTRY', c2rec.entry_no );
 end if;

 htp.nl;
 htp.tableopen( cattributes=>'cellpadding=2 cellspacing=2 border=0' );
 htp.tablerowopen;
 htp.p( '<TD VALIGN="TOP" ALIGN="LEFT">' );

 htp.tableopen( cattributes=>'class="str1_table"' );
  htp.tablerowopen;
   htp.tabledata( htf.bold('No of<BR>Packages'), cattributes=>'class="str1_bg_center"' || 'style="text-align:center"' );
   htp.tabledata( htf.bold('Description'), cattributes=>'class="str1_bg_center"' || 'style="text-align:center"' );
  htp.tablerowclose;
  if vaccess = 'EDIT'
   then
    htp.tablerowopen;
     htp.tabledata( htf.bold( 'Manual Entry No' ), cattributes=>'class="str1_cell_left"' );
     htp.tabledata( htf.formhidden( 'P1', 'PACK1' ) || htf.formtext( 'P2', 7, 7, c3rec.pack1), cattributes=>'class="str1_cell_left"' );
     htp.tabledata( htf.bold( c2rec.entry_no), cattributes=>'class="str1_cell_left"' );
    htp.tablerowclose;
    htp.tablerowopen;
     htp.tabledata( htf.formhidden( 'P1', 'DESCRIPTION1' ) || htf.formtext( 'P2', 67, 67, c3rec.description1), cattributes=>'class="str1_cell_left"' );
    htp.tablerowclose;
    htp.tablerowopen;
     htp.tabledata( htf.formhidden( 'P1', 'PACK2' ) || htf.formtext( 'P2', 7, 7, c3rec.pack2), cattributes=>'class="str1_cell_left"' );
     htp.tabledata( htf.formhidden( 'P1', 'DESCRIPTION2' ) || htf.formtext( 'P2', 67, 67, c3rec.description2), cattributes=>'class="str1_cell_left"' );
    htp.tablerowclose;
    htp.tablerowopen;
     htp.tabledata( htf.formhidden( 'P1', 'PACK3' ) || htf.formtext( 'P2', 7, 7, c3rec.pack3), cattributes=>'class="str1_cell_left"' );
     htp.tabledata( htf.formhidden( 'P1', 'DESCRIPTION3' ) || htf.formtext( 'P2', 67, 67, c3rec.description3), cattributes=>'class="str1_cell_left"' );
    htp.tablerowclose;
    htp.tablerowopen;
     htp.tabledata( htf.formhidden( 'P1', 'PACK4' ) || htf.formtext( 'P2', 7, 7, c3rec.pack4), cattributes=>'class="str1_cell_left"' );
     htp.tabledata( htf.formhidden( 'P1', 'DESCRIPTION4' ) || htf.formtext( 'P2', 67, 67, c3rec.description4), cattributes=>'class="str1_cell_left"' );
    htp.tablerowclose;
    htp.tablerowopen;
     htp.tabledata( htf.formhidden( 'P1', 'PACK5' ) || htf.formtext( 'P2', 7, 7, c3rec.pack5), cattributes=>'class="str1_cell_left"' );
     htp.tabledata( htf.formhidden( 'P1', 'DESCRIPTION5' ) || htf.formtext( 'P2', 67, 67, c3rec.description5), cattributes=>'class="str1_cell_left"' );
    htp.tablerowclose;
    htp.tablerowopen;
     htp.tabledata( htf.formhidden( 'P1', 'PACK6' ) || htf.formtext( 'P2', 7, 7, c3rec.pack6), cattributes=>'class="str1_cell_left"' );
     htp.tabledata( htf.formhidden( 'P1', 'DESCRIPTION6' ) || htf.formtext( 'P2', 67, 67, c3rec.description6), cattributes=>'class="str1_cell_left"' );
    htp.tablerowclose;
    htp.tablerowopen;
     htp.tabledata( htf.formhidden( 'P1', 'PACK7' ) || htf.formtext( 'P2', 7, 7, c3rec.pack7), cattributes=>'class="str1_cell_left"' );
     htp.tabledata( htf.formhidden( 'P1', 'DESCRIPTION7' ) || htf.formtext( 'P2', 67, 67, c3rec.description7), cattributes=>'class="str1_cell_left"' );
    htp.tablerowclose;
    htp.tablerowopen;
     htp.tabledata( htf.formhidden( 'P1', 'PACK8' ) || htf.formtext( 'P2', 7, 7, c3rec.pack8), cattributes=>'class="str1_cell_left"' );
     htp.tabledata( htf.formhidden( 'P1', 'DESCRIPTION8' ) || htf.formtext( 'P2', 67, 67, c3rec.description8), cattributes=>'class="str1_cell_left"' );
    htp.tablerowclose;
    htp.tablerowopen;
     htp.tabledata( htf.formhidden( 'P1', 'PACK9' ) || htf.formtext( 'P2', 7, 7, c3rec.pack9), cattributes=>'class="str1_cell_left"' );
     htp.tabledata( htf.formhidden( 'P1', 'DESCRIPTION9' ) || htf.formtext( 'P2', 67, 67, c3rec.description9), cattributes=>'class="str1_cell_left"' );
    htp.tablerowclose;
    htp.tablerowopen;
     htp.tabledata( htf.formhidden( 'P1', 'PACK10' ) || htf.formtext( 'P2', 7, 7, c3rec.pack10), cattributes=>'class="str1_cell_left"' );
     htp.tabledata( htf.formhidden( 'P1', 'DESCRIPTION10' ) || htf.formtext( 'P2', 67, 67, c3rec.description10), cattributes=>'class="str1_cell_left"' );
    htp.tablerowclose;
   else
    htp.tablerowopen;
     htp.tabledata( htf.bold( nvl(c3rec.pack1,'&nbsp;') ), cattributes=>'class="str1_cell_left"' );
     htp.tabledata( nvl(c3rec.description1,'&nbsp;'), cattributes=>'class="str1_cell_left"' );
    htp.tablerowclose;
    htp.tablerowopen;
     htp.tabledata( htf.bold( nvl(c3rec.pack2,'&nbsp;') ), cattributes=>'class="str1_cell_left"' );
     htp.tabledata( nvl(c3rec.description2,'&nbsp;'), cattributes=>'class="str1_cell_left"' );
    htp.tablerowclose;
    htp.tablerowopen;
     htp.tabledata( htf.bold( nvl(c3rec.pack3,'&nbsp;') ), cattributes=>'class="str1_cell_left"' );
     htp.tabledata( nvl(c3rec.description3,'&nbsp;'), cattributes=>'class="str1_cell_left"' );
    htp.tablerowclose;
    htp.tablerowopen;
     htp.tabledata( htf.bold( nvl(c3rec.pack4,'&nbsp;') ), cattributes=>'class="str1_cell_left"' );
     htp.tabledata( nvl(c3rec.description4,'&nbsp;'), cattributes=>'class="str1_cell_left"' );
    htp.tablerowclose;
    htp.tablerowopen;
     htp.tabledata( htf.bold( nvl(c3rec.pack5,'&nbsp;') ), cattributes=>'class="str1_cell_left"' );
     htp.tabledata( nvl(c3rec.description5,'&nbsp;'), cattributes=>'class="str1_cell_left"' );
    htp.tablerowclose;
    htp.tablerowopen;
     htp.tabledata( htf.bold( nvl(c3rec.pack6,'&nbsp;') ), cattributes=>'class="str1_cell_left"' );
     htp.tabledata( nvl(c3rec.description6,'&nbsp;'), cattributes=>'class="str1_cell_left"' );
    htp.tablerowclose;
    htp.tablerowopen;
     htp.tabledata( htf.bold( nvl(c3rec.pack7,'&nbsp;') ), cattributes=>'class="str1_cell_left"' );
     htp.tabledata( nvl(c3rec.description7,'&nbsp;'), cattributes=>'class="str1_cell_left"' );
    htp.tablerowclose;
    htp.tablerowopen;
     htp.tabledata( htf.bold( nvl(c3rec.pack8,'&nbsp;') ), cattributes=>'class="str1_cell_left"' );
     htp.tabledata( htf.bold( nvl(c3rec.pack9,'&nbsp;') ), cattributes=>'class="str1_cell_left"' );
     htp.tabledata( nvl(c3rec.description8,'&nbsp;'), cattributes=>'class="str1_cell_left"' );
    htp.tablerowclose;
    htp.tablerowopen;
     htp.tabledata( nvl(c3rec.description9,'&nbsp;'), cattributes=>'class="str1_cell_left"' );
    htp.tablerowclose;
    htp.tablerowopen;
     htp.tabledata( htf.bold( nvl(c3rec.pack10,'&nbsp;') ), cattributes=>'class="str1_cell_left"' );
     htp.tabledata( nvl(c3rec.description10,'&nbsp;'), cattributes=>'class="str1_cell_left"' );
    htp.tablerowclose;
  end if;

 htp.tableclose;

 htp.p( '</TD>' );
 htp.tablerowclose;
 htp.tableclose;

 htp.nl;
 htp.tableopen( cattributes=>'cellpadding=2 cellspacing=2 border=0' );
  htp.tablerowopen;
   if vaccess = 'EDIT'
    then
     htp.p( '<TD VALIGN="TOP">' );
      htp.formsubmit( 'ACTION', 'Update' );
     htp.p( '</TD>' );
     htp.p( '<TD VALIGN="TOP">' );
      htp.formsubmit( 'ACTION', 'Header Details' );
     htp.p( '</TD>' );
     htp.p( '<TD VALIGN="TOP">' );
      htp.formsubmit( 'ACTION', 'Tariff Groups' );
      htp.formclose;
     htp.p( '</TD>' );
   else
     htp.p( '<TD VALIGN="TOP">' );
      htp.anchor( 'strangp.manentry?surl=' || surl || '&rid=' || replace(nrid,'+','~') || '&scid=' || scid || '&call_name=' || replace(call_name,' ','+') || '&parm=' || replace(parm,' ','+') || '&access_id=' || access_id, 'Header Details' );
     htp.p( '</TD>' );
     open c5(c2rec.entry_no);
     fetch c5 into c5rec;
     close c5;
     htp.p( '<TD VALIGN="TOP">' );
      htp.anchor( 'strangp.manentry_page3?surl=' || surl || '&rid=' || replace(rowidtochar(c5rec.rowid),'+','~') || '&scid=' || scid || '&call_name=' || replace(call_name,' ','+') || '&parm=' || replace(parm,' ','+') || '&access_id=' || access_id, 'Tariff Groups' );
     htp.p( '</TD>' );
  end if;
  htp.tablerowclose;
 htp.tableclose;
 htp.formclose;
 htp.p( '</CENTER>' );
 htp.htmlclose;
exception when others then
 error_details( 'STRANGP', 'MANENTRY_PAGE2',null,null,errmsg=>sqlerrm);
end manentry_page2;

procedure accept_manentry_page2(surl in varchar2, rid in varchar2, scid in varchar2, call_name in varchar2, parm in varchar2, old_entry in varchar2, access_id in varchar2 default null, action in varchar2, p1 in owa.vc_arr, p2 in owa.vc_arr )
as

 cursor c2( rid rowid ) is select * from strang.manentry where rowid = rid;
 cursor c3( ent varchar2 ) is select count('x') exst from strang.manentry where entry_no = ent;
 cursor c4( entryno number) is select rowidtochar(rowid) from strang.manentry where entry_no = entryno;
 cursor c5( entryno number) is select rowid from strang.manent2 where entry_no = entryno and rno = (select min(rno) from strang.manent2 where entry_no = entryno);


 c2rec		c2%ROWTYPE;
 c3rec		c3%ROWTYPE;
 c5rec		c5%ROWTYPE;

 sts		varchar2(100);
 nrid		varchar2(100);
 vaccess	varchar2(20);
 msg		varchar2(100);
 nmb		integer;

begin
  if not dapi.init( surl, 'STRANGP.ACCEPT_MANENTRY_PAGE2', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'ACCEPT_MANENTRY_PAGE2');
    return;
  end if;

 nrid := replace(rid,'~','+');
 vaccess := data_access( 'MANENTRY' );

 if vaccess = 'EDIT'
  then

 -- Validate Number
 if old_entry is null
  then
   manentry( surl, nrid, scid, call_name, parm, access_id, 'Entry Number cannot be empty:' || old_entry );
   return;
 end if;
 if action <> 'Delete'
  then
   for j in p1.first..p1.last loop
    begin
     execute immediate
      'update strang.manent1 set ' || p1(j) || ' = :1 where entry_no = :2'
        using p2(j), old_entry;
    exception
     when others then msg := msg || '[Error Modifying ' || initcap(p1(j)) || ' to value: ' || p2(j) || ']';
    end;
   end loop;
 end if;
 commit;
 end if; -- End of Edit Data
 msg := nvl(msg,'Manual Record Updated');
 open c4(old_entry);
 fetch c4 into nrid;
 close c4;

 if action = 'Update'
  then
   manentry_page2( surl, nrid, scid, call_name, parm, access_id, msg );
 elsif action = 'Create New Entry'
  then
   manentry( surl, null, scid, call_name, parm, access_id, msg );
 elsif action = 'Header Details'
  then
   manentry( surl, nrid, scid, call_name, parm, access_id, msg );
 elsif action = 'Tariff Groups'
  then
   open c5(old_entry);
   fetch c5 into c5rec;
   close c5;
   manentry_page3( surl, rowidtochar(c5rec.rowid), scid, call_name, parm, access_id, msg );
 end if;

exception when others then
 error_details( 'STRANGP', 'ACCEPT_MANENTRY_PAGE2',null,null,errmsg=>sqlerrm);
end accept_manentry_page2;

procedure manentry_page3(surl in varchar2, rid in varchar2, scid in varchar2, call_name in varchar2, parm in varchar2, access_id in varchar2 default null, msg in varchar2 default null )
as

 cursor c2( entno number) is select rowid from strang.manentry where entry_no = entno;
 cursor c3( rid rowid) is select * from strang.manent2 where rowid = rid;
 cursor c4( entryno number ) is select count('x') tot from strang.manent2 where entry_no = entryno;

 c2rec		c2%ROWTYPE;
 c3rec		c3%ROWTYPE;
 c4rec		c4%ROWTYPE;
 sts		varchar2(100);
 nrid		varchar2(100);
 vaccess	varchar2(20);

begin
  if not dapi.init( surl, 'STRANGP.MANENTRY_PAGE3', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'MANENTRY_PAGE3');
    return;
  end if;

 nrid := replace(rid,'~','+');
 vaccess := data_access( 'MANENTRY' );
 open c3( nrid );
 fetch c3 into c3rec;
 close c3;
 open c4(c3rec.entry_no);
 fetch c4 into c4rec;
 close c4;
 open c2(c3rec.entry_no);
 fetch c2 into c2rec;
 close c2;

 main_title( 'Manual Entry - Tariff Groups',helpid=>'STR49');
 if vaccess = 'NONE' then htp.bold( 'Access Denied' ); htp.htmlclose; return; end if;
 if msg is not null then header_msg( msg ); end if;
 htp.p( '<CENTER>' );

 if vaccess = 'EDIT'
  then
   htp.formopen( 'strangp.accept_manentry_page3' );
   htp.formhidden( 'SURL', surl );
   htp.formhidden( 'SCID', scid );
   htp.formhidden( 'PARM', parm );
   htp.formhidden( 'CALL_NAME', call_name );
   htp.formhidden( 'ACCESS_ID', access_id );
   htp.formhidden( 'RID', nrid );
   htp.formhidden( 'OLD_ENTRY', c3rec.entry_no );
 end if;

 htp.nl;
 htp.tableopen( cattributes=>'cellpadding=2 cellspacing=2 border=0' );
 htp.tablerowopen;
 htp.p( '<TD VALIGN="TOP" ALIGN="LEFT">' );

 htp.tableopen( cattributes=>'class="str1_table"' );
  htp.tablerowopen;
   htp.tabledata( htf.bold( 'Manual Entry No' ), cattributes=>'class="str1_bg_center"' || 'align="LEFT"' );
   htp.tabledata( htf.bold( c3rec.entry_no), cattributes=>'class="str1_bg_center"' || 'align="LEFT" COLSPAN="3"' );
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( htf.bold('Description'), cattributes=>'class="str1_bg_right"' );
   if vaccess = 'EDIT' then htp.tabledata( htf.formhidden( 'P1', 'DESCRIPTION1' ) || htf.formtext( 'P2', 30, 30, c3rec.description1), cattributes=>'class="str1_cell_left"' );
   else htp.tabledata( htf.bold( c3rec.description1 ), cattributes=>'class="str1_cell_left"' );
   end if;
   htp.tabledata( htf.bold('Record #'), cattributes=>'class="str1_bg_right"' );
   if vaccess = 'EDIT' then htp.tabledata( htf.formhidden( 'P1', 'RNO' ) || htf.formhidden( 'P2', c3rec.rno ) || htf.bold( c3rec.rno ) || ' / ' || htf.bold( c4rec.tot ), cattributes=>'class="str1_bg_center"' || 'align="LEFT"' );
   else htp.tabledata( htf.bold( c3rec.rno ) || ' / ' || htf.bold( c4rec.tot ), cattributes=>'class="str1_bg_center"' || 'align="LEFT"' );
   end if;
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( '&nbsp;', cattributes=>'class="str1_bg_right"' );
   if vaccess = 'EDIT' then htp.tabledata( htf.formhidden( 'P1', 'DESCRIPTION2' ) || htf.formtext( 'P2', 30, 30, c3rec.description2), cattributes=>'class="str1_cell_left"' );
   else htp.tabledata( htf.bold( c3rec.description2 ), cattributes=>'class="str1_cell_left"' );
   end if;
   htp.tabledata( '&nbsp;', cattributes=>'class="str1_cell_right"' );
   htp.tabledata( '&nbsp;', cattributes=>'class="str1_cell_right"' );
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( '&nbsp;', cattributes=>'class="str1_bg_right"' );
   if vaccess = 'EDIT' then htp.tabledata( htf.formhidden( 'P1', 'DESCRIPTION3' ) || htf.formtext( 'P2', 30, 30, c3rec.description3), cattributes=>'class="str1_cell_left"' );
   else htp.tabledata( htf.bold( c3rec.description3 ), cattributes=>'class="str1_cell_left"' );
   end if;
   htp.tabledata( '&nbsp;', cattributes=>'class="str1_cell_right"' );
   htp.tabledata( '&nbsp;', cattributes=>'class="str1_cell_right"' );
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( htf.bold('Origin'), cattributes=>'class="str1_bg_right"' );
   if vaccess = 'EDIT' then htp.tabledata( htf.formhidden( 'P1', 'ORIGIN' ) || htf.formtext( 'P2', 6, 6, c3rec.origin), cattributes=>'class="str1_cell_left"' );
   else htp.tabledata( htf.bold( c3rec.origin ), cattributes=>'class="str1_cell_left"' );
   end if;
   htp.tabledata( '&nbsp;', cattributes=>'class="str1_cell_right"' );
   htp.tabledata( '&nbsp;', cattributes=>'class="str1_cell_right"' );
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( htf.bold('Value'), cattributes=>'class="str1_bg_right"' );
   htp.tabledata( 'In Original Currency', cattributes=>'class="str1_cell_center"' || 'align="LEFT" COLSPAN="2"' );
   if vaccess = 'EDIT' then htp.tabledata( htf.formhidden( 'P1', 'VALUE' ) || htf.formtext( 'P2', 15, 15, trim(to_char(c3rec.value,'999999999999.99'))), cattributes=>'class="str1_cell_left"' );
   else htp.tabledata( htf.bold( to_char(c3rec.value,'999999999999.99') ), cattributes=>'class="str1_cell_left"' );
   end if;
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( '&nbsp;', cattributes=>'class="str1_cell_right"COLSPAN="4"' );
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( htf.bold('VAT Rate %'), cattributes=>'class="str1_bg_right"' );
   if vaccess = 'EDIT' then htp.tabledata( htf.formhidden( 'P1', 'VAT_RATE' ) || htf.formtext( 'P2', 10, 10, trim(to_char(c3rec.vat_rate,'999.99'))), cattributes=>'class="str1_cell_left"' );
   else htp.tabledata( htf.bold( to_char(c3rec.vat_rate,'999.99') ), cattributes=>'class="str1_cell_left"' );
   end if;
   htp.tabledata( '&nbsp;', cattributes=>'class="str1_cell_right"' );
   htp.tabledata( '&nbsp;', cattributes=>'class="str1_cell_right"' );
  htp.tablerowclose;
   htp.tabledata( htf.bold('Levy Rate %'), cattributes=>'class="str1_bg_right"' );
   if vaccess = 'EDIT' then htp.tabledata( htf.formhidden( 'P1', 'LEVY_RATE' ) || htf.formtext( 'P2', 10, 10, trim(to_char(c3rec.levy_rate,'9999999999.99'))), cattributes=>'class="str1_cell_left"' );
   else htp.tabledata( htf.bold( trim(to_char(c3rec.levy_rate,'999999999.99')) ), cattributes=>'class="str1_cell_left"' );
   end if;
   htp.tabledata( '&nbsp;', cattributes=>'class="str1_cell_right"' );
   htp.tabledata( '&nbsp;', cattributes=>'class="str1_cell_right"' );
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( htf.bold('Tariff'), cattributes=>'class="str1_bg_right"' );
   if vaccess = 'EDIT' then htp.tabledata( htf.formhidden( 'P1', 'TARIFF' ) || htf.formtext( 'P2', 10, 10, c3rec.tariff), cattributes=>'class="str1_cell_left"' );
   else htp.tabledata( htf.bold( c3rec.tariff ), cattributes=>'class="str1_cell_left"' );
   end if;
   htp.tabledata( '&nbsp;', cattributes=>'class="str1_cell_right"' );
   htp.tabledata( '&nbsp;', cattributes=>'class="str1_cell_right"' );
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( htf.bold('Quantity'), cattributes=>'class="str1_bg_right"' );
   if vaccess = 'EDIT' then htp.tabledata( htf.formhidden( 'P1', 'QUANTITY' ) || htf.formtext( 'P2', 10, 10, c3rec.quantity), cattributes=>'class="str1_cell_left"' );
   else htp.tabledata( htf.bold( c3rec.quantity ), cattributes=>'class="str1_cell_left"' );
   end if;
   htp.tabledata( '&nbsp;', cattributes=>'class="str1_cell_right"' );
   htp.tabledata( '&nbsp;', cattributes=>'class="str1_cell_right"' );
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( htf.bold('Unit'), cattributes=>'class="str1_bg_right"' );
   if vaccess = 'EDIT' then htp.tabledata( htf.formhidden( 'P1', 'UNIT' ) || htf.formtext( 'P2', 10, 8, c3rec.unit), cattributes=>'class="str1_cell_left"' );
   else htp.tabledata( htf.bold( c3rec.unit ), cattributes=>'class="str1_cell_left"' );
   end if;
   htp.tabledata( '&nbsp;', cattributes=>'class="str1_cell_right"' );
   htp.tabledata( '&nbsp;', cattributes=>'class="str1_cell_right"' );
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( '&nbsp;', cattributes=>'class="str1_cell_right"COLSPAN="4"' );
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( htf.bold('Duty Rate %'), cattributes=>'class="str1_bg_right"' );
   if vaccess = 'EDIT' then htp.tabledata( htf.formhidden( 'P1', 'RATE' ) || htf.formtext( 'P2', 10, 10, trim(to_char(c3rec.rate,'999.99'))), cattributes=>'class="str1_cell_left"' );
   else htp.tabledata( htf.bold( to_char(c3rec.rate,'999.99') ), cattributes=>'class="str1_cell_left"' );
   end if;
   htp.tabledata( htf.bold('Old Duty Rate %'), cattributes=>'class="str1_bg_right"' );
   if vaccess = 'EDIT' then htp.tabledata( htf.formhidden( 'P1', 'OLDRATE' ) || htf.formtext( 'P2', 10, 10, trim(to_char(c3rec.oldrate,'999.99'))), cattributes=>'class="str1_cell_left"' );
   else htp.tabledata( htf.bold( to_char(c3rec.oldrate,'999.99') ), cattributes=>'class="str1_cell_left"' );
   end if;
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( htf.bold('Excise Rate %'), cattributes=>'class="str1_bg_right"' );
   if vaccess = 'EDIT' then htp.tabledata( htf.formhidden( 'P1', 'EXCISE_RATE' ) || htf.formtext( 'P2', 10, 10, to_char(c3rec.excise_rate,'999.99')), cattributes=>'class="str1_cell_left"' );
   else htp.tabledata( htf.bold( to_char(c3rec.excise_rate,'999.99') ), cattributes=>'class="str1_cell_left"' );
   end if;
   htp.tabledata( '&nbsp;', cattributes=>'class="str1_cell_right"' );
   htp.tabledata( '&nbsp;', cattributes=>'class="str1_cell_right"' );
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( '&nbsp;', cattributes=>'class="str1_cell_right"COLSPAN="4"' );
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( htf.bold('Kina Value'), cattributes=>'class="str1_bg_right"' );
   if vaccess = 'EDIT' then htp.tabledata( htf.formhidden( 'P1', 'KINAVALUE' ) || htf.formtext( 'P2', 15, 15, trim(to_char(c3rec.kinavalue,'999999999999.99'))), cattributes=>'class="str1_cell_left"' );
   htp.tabledata( '&nbsp;', cattributes=>'class="str1_cell_right"' );
   else htp.tabledata( htf.bold( to_char(c3rec.kinavalue,'999999999999.99') ), cattributes=>'class="str1_cell_left"' );
   end if;
   htp.tabledata( '&nbsp;', cattributes=>'class="str1_cell_right"' );
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( htf.bold('Duty'), cattributes=>'class="str1_bg_right"' );
   if vaccess = 'EDIT' then htp.tabledata( htf.formhidden( 'P1', 'DUTY' ) || htf.formtext( 'P2', 15, 15, trim(to_char(c3rec.duty,'999999999.99'))), cattributes=>'class="str1_cell_left"' );
   else htp.tabledata( htf.bold( to_char(c3rec.duty,'999999999.99') ), cattributes=>'class="str1_cell_left"' );
   end if;
   htp.tabledata( htf.bold('Old Duty'), cattributes=>'class="str1_bg_right"' );
   if vaccess = 'EDIT' then htp.tabledata( htf.formhidden( 'P1', 'OLDDUTY' ) || htf.formtext( 'P2', 15, 15, to_char(c3rec.oldduty,'999999999.99')), cattributes=>'class="str1_cell_left"' );
   else htp.tabledata( htf.bold( to_char(c3rec.oldduty,'999999999.99') ), cattributes=>'class="str1_cell_left"' );
   end if;
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( htf.bold('Excise'), cattributes=>'class="str1_bg_right"' );
   if vaccess = 'EDIT' then htp.tabledata( htf.formhidden( 'P1', 'EXCISE' ) || htf.formtext( 'P2', 15, 15, trim(to_char(c3rec.excise,'999999999.99'))), cattributes=>'class="str1_cell_left"' );
   else htp.tabledata( htf.bold( to_char(c3rec.excise,'999999999.99') ), cattributes=>'class="str1_cell_left"' );
   end if;
   htp.tabledata( '&nbsp;', cattributes=>'class="str1_cell_right"' );
   htp.tabledata( '&nbsp;', cattributes=>'class="str1_cell_right"' );
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( htf.bold('VAT'), cattributes=>'class="str1_bg_right"' );
   if vaccess = 'EDIT' then htp.tabledata( htf.formhidden( 'P1', 'VAT' ) || htf.formtext( 'P2', 15, 15, trim(to_char(c3rec.vat,'999999999.99'))), cattributes=>'class="str1_cell_left"' );
   else htp.tabledata( htf.bold( to_char(c3rec.vat,'999999999.99') ), cattributes=>'class="str1_cell_left"' );
   end if;
   htp.tabledata( '&nbsp;', cattributes=>'class="str1_cell_right"' );
   htp.tabledata( '&nbsp;', cattributes=>'class="str1_cell_right"' );
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( htf.bold('Levy'), cattributes=>'class="str1_bg_right"' );
   if vaccess = 'EDIT' then htp.tabledata( htf.formhidden( 'P1', 'LEVY' ) || htf.formtext( 'P2', 15, 20, trim(to_char(c3rec.levy,'999999999.99'))), cattributes=>'class="str1_cell_left"' );
   else htp.tabledata( htf.bold( to_char(c3rec.levy,'999999999.99') ), cattributes=>'class="str1_cell_left"' );
   end if;
   htp.tabledata( '&nbsp;', cattributes=>'class="str1_cell_right"' );
   htp.tabledata( '&nbsp;', cattributes=>'class="str1_cell_right"' );
  htp.tablerowclose;
 htp.tableclose;

 htp.p( '</TD>' );
 htp.tablerowclose;
 htp.tableclose;

 htp.nl;
 htp.tableopen( cattributes=>'cellpadding=2 cellspacing=2 border=0' );
  htp.tablerowopen;
   if vaccess = 'EDIT'
    then
     htp.p( '<TD VALIGN="TOP">' );
      htp.formsubmit( 'ACTION', 'Update' );
     htp.p( '</TD>' );
     htp.p( '<TD VALIGN="TOP">' );
      htp.formsubmit( 'ACTION', 'Header Details' );
     htp.p( '</TD>' );
     htp.p( '<TD VALIGN="TOP">' );
      htp.formsubmit( 'ACTION', 'Package Description' );
     htp.p( '</TD>' );
     htp.p( '<TD VALIGN="TOP">' );
      htp.formsubmit( 'ACTION', 'Delete Manual Entry Tariff' );
     htp.p( '</TD>' );
     htp.p( '<TD VALIGN="TOP">' );
      htp.formsubmit( 'ACTION', 'Insert New Manual Entry Tariff' );
      htp.formclose;
     htp.p( '</TD>' );
   else
     htp.p( '<TD VALIGN="TOP">' );
      htp.anchor( 'strangp.manentry?surl=' || surl || '&rid=' || replace(rowidtochar(c2rec.rowid),'+','~') || '&scid=' || scid || '&call_name=' || replace(call_name,' ','+') || '&parm=' || replace(parm,' ','+') || '&access_id=' || access_id, 'Header Details' );
     htp.p( '</TD>' );
     htp.p( '<TD VALIGN="TOP">' );
      htp.anchor( 'strangp.manentry_page2?surl=' || surl || '&rid=' || replace(rowidtochar(c2rec.rowid),'+','~') || '&scid=' || scid || '&call_name=' || replace(call_name,' ','+') || '&parm=' || replace(parm,' ','+') || '&access_id=' || access_id, 'Package Description' );
     htp.p( '</TD>' );
  end if;

  htp.tablerowclose;
 htp.tableclose;
 htp.tableopen( cattributes=>'cellpadding=2 cellspacing=2 border=0' );
  htp.tablerowopen;
   htp.p( '<TD VALIGN="TOP">' );
    search( surl, 'ME2', nrid, samerow=>TRUE );
   htp.p( '</TD>' );
  htp.tablerowclose;
 htp.tableclose;
 htp.formclose;
 htp.p( '</CENTER>' );
 htp.htmlclose;
exception when others then
 error_details( 'STRANGP', 'MANENTRY_PAGE3',null,null,errmsg=>sqlerrm);
end manentry_page3;

procedure accept_manentry_page3(surl in varchar2, rid in varchar2, scid in varchar2, call_name in varchar2, parm in varchar2, old_entry in varchar2, access_id in varchar2 default null, action in varchar2, p1 in owa.vc_arr, p2 in owa.vc_arr )
as

 cursor c2( rid rowid ) is select * from strang.manent2 where rowid = rid;
 cursor c4( entryno number) is select rowidtochar(rowid) from strang.manentry where entry_no = entryno;
 cursor c8( entryno number) is select count('x') tot from strang.manent2 where entry_no = entryno;
 cursor c5( entryno number) is select rowid from strang.manent2 where entry_no = entryno and rno = (select min(rno) from strang.manent2 where entry_no = entryno);
 cursor c6( entryno number) is select max(rno) + 1 from strang.manent2 where entry_no = entryno;
 cursor c7( entryno number, recno integer) is select rowid from strang.manent2 where entry_no = entryno and rno = recno;
 cursor c9( lv varchar2, cd varchar2 ) is select * from strang.lov where lov_name = lv and code = cd;


 c2rec		c2%ROWTYPE;
 c5rec		c5%ROWTYPE;
 c7rec		c7%ROWTYPE;
 c8rec		c8%ROWTYPE;
 c9rec		c9%ROWTYPE;

 sts		varchar2(100);
 nrid		varchar2(100);
 vaccess	varchar2(20);
 msg		varchar2(100);
 nmb		integer;
 mx		integer;

begin
  if not dapi.init( surl, 'STRANGP.ACCEPT_MANENTRY_PAGE3', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'ACCEPT_MANENTRY_PAGE3');
    return;
  end if;

 nrid := replace(rid,'~','+');
 vaccess := data_access( 'MANENTRY' );
 open c2(rid);
 fetch c2 into c2rec;
 close c2;

 if vaccess = 'EDIT'
  then

 -- Validate Number
 if old_entry is null
  then
   manentry( surl, nrid, scid, call_name, parm, access_id, 'Entry Number cannot be empty' || ':' || old_entry );
   return;
 end if;
 if action = 'Delete Manual Entry Tariff'
  then
   delete from strang.manent2 where rowid = chartorowid(rid);
   open c5(c2rec.entry_no);
   fetch c5 into c5rec;
   close c5;
   open c8(c2rec.entry_no);
   fetch c8 into c8rec;
   close c8;
   if c8rec.tot = 0
    then
     insert into strang.manent2(entry_no,rno) values (c2rec.entry_no,1);
     commit;
     open c7(c2rec.entry_no,1);
     fetch c7 into c5rec;
     close c7;
   end if;
   manentry_page3( surl, rowidtochar(c5rec.rowid), scid, call_name, parm, access_id, 'Tariff Manual Entry Deleted' );
   return;
 end if;
 if action <> 'Delete Manual Entry Tariff'
  then
   for j in p1.first..p1.last loop
    begin
     execute immediate
      'update strang.manent2 set ' || p1(j) || ' = :1 where rowid = :2'
        using p2(j), chartorowid(rid);
    exception
     when others then msg := msg || '[Error Modifying ' || initcap(p1(j)) || ' to value: ' || p2(j) || ']';
    end;
   end loop;
 end if;

  -- Refresh the values
 open c2(rid);
 fetch c2 into c2rec;
 close c2;
 open c9( 'TARIFF', c2rec.tariff );
 fetch c9 into c9rec;
 close c9;
 update strang.manent2
  set
   unit = nvl(unit, c9rec.cola ),
   rate = nvl(rate, c9rec.description ),
   oldrate = nvl(oldrate, c9rec.colb ),
   excise_rate = nvl(excise_rate, c9rec.colc)
 where
  rowid = chartorowid(rid);

-- Calculations
 update strang.manent2 m2
  set
   kinavalue = (select ratio_factor * m2.value from strang.manentry where entry_no = old_entry)
 where rowid = chartorowid(rid) and kinavalue is null;
 update strang.manent2 m2
  set
   duty = (select (ratio_factor * m2.value * m2.rate ) / 100 from strang.manentry where entry_no = old_entry)
 where rowid = chartorowid(rid) and duty is null;
 update strang.manent2 m2
  set
   oldduty = (select (ratio_factor * m2.value * m2.oldrate ) / 100 from strang.manentry where entry_no = old_entry)
 where rowid = chartorowid(rid) and oldduty is null;
 update strang.manent2 m2
  set
   excise = (select ( ((ratio_factor * m2.value) + m2.duty) * m2.excise_rate ) / 100 from strang.manentry where entry_no = old_entry)
 where rowid = chartorowid(rid) and excise is null;
 update strang.manent2 m2
  set
   vat = ((nvl(kinavalue,0) + nvl(duty,0) + nvl(excise,0)) * nvl(vat_rate,1)) / 100
 where rowid = chartorowid(rid) and vat is null;
 update strang.manent2 m2
  set
   levy = ((nvl(kinavalue,0) + nvl(duty,0) + nvl(excise,0)) * nvl(levy_rate,1)) / 100
 where rowid = chartorowid(rid) and levy is null;
 commit;

 update strang.manentry m1
  set
    duty = (select sum(nvl(m2.duty,0)) from strang.manent2 m2 where m2.entry_no = c2rec.entry_no ),
    vat = (select sum(nvl(m2.vat,0)) from strang.manent2 m2 where m2.entry_no = c2rec.entry_no ),
    excise = (select sum(nvl(m2.excise,0)) from strang.manent2 m2 where m2.entry_no = c2rec.entry_no ),
    levy = (select sum(nvl(m2.levy,0)) from strang.manent2 m2 where m2.entry_no = c2rec.entry_no )
   where
    entry_no = c2rec.entry_no;

 update strang.manentry m1
  set
    pvariance = (select (m1.duty + m1.excise + m1.vat + nvl(m1.levy,0)) - ((sum(nvl(m2.kinavalue,0)) * 0.015) + sum(nvl(m2.oldduty,0)) ) from strang.manent2 m2 where entry_no = c2rec.entry_no )
   where
    entry_no = c2rec.entry_no;
 commit;

 end if; -- End of Edit Data

 msg := nvl(msg,'Manual Record Updated');

 if action = 'Update'
  then
   manentry_page3( surl, nrid, scid, call_name, parm, access_id, msg );
   fetch c6 into mx;
 elsif action = 'Insert New Manual Entry Tariff'
  then
   open c6(c2rec.entry_no);
   close c6;
   insert into strang.manent2(entry_no,rno) values (c2rec.entry_no,mx);
   open c7(c2rec.entry_no,mx);
   fetch c7 into c7rec;
   close c7;
   commit;
   manentry_page3( surl, rowidtochar(c7rec.rowid), scid, call_name, parm, access_id, msg );
 elsif action = 'Header Details'
  then
   open c4(old_entry);
   fetch c4 into nrid;
   close c4;
   manentry( surl, nrid, scid, call_name, parm, access_id, msg );
 elsif action = 'Package Description'
  then
   open c4(old_entry);
   fetch c4 into nrid;
   close c4;
   manentry_page2( surl, nrid, scid, call_name, parm, access_id, msg );
 end if;

exception when others then
 error_details( 'STRANGP', 'ACCEPT_MANENTRY_PAGE3',null,null,errmsg=>sqlerrm);
end accept_manentry_page3;

procedure confirm_manentry_delete(surl in varchar2, rid in varchar2, scid in varchar2, call_name in varchar2, parm in varchar2, access_id in varchar2 default null, msg in varchar2 default null )
as

 cursor c2( rid rowid ) is select * from strang.manentry where rowid = rid;

 c2rec		c2%ROWTYPE;
 sts		varchar2(100);
 nrid		varchar2(100);
 vaccess	varchar2(20);

begin
  if not dapi.init( surl, 'STRANGP.CONFIRM_MANENTRY_DELETE', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'CONFIRM_MANENTRY_DELETE' );
    return;
  end if;

 nrid := replace(rid,'~','+');
 vaccess := data_access( 'MANENTRY' );
 open c2( nrid );
 fetch c2 into c2rec;
 close c2;

 main_title( 'Manual Entry - Header Details',helpid=>'STR50');
 if vaccess = 'NONE' then htp.bold( 'Access Denied' ); htp.htmlclose; return; end if;
 if msg is not null then header_msg( msg ); end if;
 htp.p( '<CENTER>' );

 htp.formopen( 'strangp.accept_manentry_delete' );
  htp.formhidden( 'SURL', surl );
  htp.formhidden( 'SCID', scid );
  htp.formhidden( 'PARM', parm );
  htp.formhidden( 'CALL_NAME', call_name );
  htp.formhidden( 'ACCESS_ID', access_id );
  htp.formhidden( 'RID', nrid );
  htp.formhidden( 'OLD_ENTRY', c2rec.entry_no );
  htp.nl;
  htp.nl;
  htp.formsubmit( 'ACTION', 'Do not Delete' );
  htp.formsubmit( 'ACTION', 'Delete this Record' );
 htp.formclose;
 htp.p( '</CENTER>' );
 htp.htmlclose;
exception when others then
 error_details( 'STRANGP', 'CONFIRM_MANENTRY_DELETE',null,null,errmsg=>sqlerrm);
end confirm_manentry_delete;

procedure accept_manentry_delete(surl in varchar2, rid in varchar2, scid in varchar2, call_name in varchar2, parm in varchar2, old_entry in varchar2, access_id in varchar2 default null, action in varchar2 )
as


 sts		varchar2(100);
 nrid		varchar2(100);
 vaccess	varchar2(20);

begin
  if not dapi.init( surl, 'STRANGP.ACCEPT_MANENTRY_DELETE', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'ACCEPT_MANENTRY_DELETE' );
    return;
  end if;

 nrid := replace(rid,'~','+');
 vaccess := data_access( 'MANENTRY' );

 if vaccess = 'EDIT'
  then

 if action = 'Do not Delete'
  then
   manentry( surl, nrid, scid, call_name, parm, access_id, 'Deletion Stopped' );
 else
   delete from strang.manentry where entry_no = old_entry;
   delete from strang.manent1 where entry_no = old_entry;
   delete from strang.manent2 where entry_no = old_entry;
   commit;
   manentry( surl, null, scid, call_name, parm, access_id, 'Manual Entry Record ' || old_entry || ' Deleted' );
 end if;

 end if;

exception when others then
 error_details( 'STRANGP', 'ACCEPT_MANENTRY_DELETE',null,null,errmsg=>sqlerrm);
end accept_manentry_delete;

procedure generate_ccdets( surl in varchar2, vShip_id in integer )
as

 cursor c4( vShip_id integer ) is
   select dr.line_no, m.bol, m.container_type,m.movement_no, m.seal, m.tare, dr.deliveryno, dr.itemno, dr.detaildesc, dr.pktpe_packtype,
   dr.qty,dr.partvolume, dr.partweight,dr.ecn, dr.hazard,dr.logno,  c.customer cus4, c4.customer cus2, r.currdate, s.voy, s.shipname
   from strang.detailrs dr, strang.ships_airway s, strang.customers c, strang.customers c4, strang.receivals r, strang.movements m
   where
    s.ship_id = vShip_id and
    m.ship_id = s.ship_id and
    m.movement_no = dr.movement_no and
    r.cust_customer_id = c.customer_id and
    m.movement_type = 'CARGO' and
    nvl(m.seal,'|') = nvl(dr.camov_seal,'|') and
    r.deliveryno = dr.deliveryno and
    r.supplier_customer_id = c4.customer_id
   order by dr.line_no ;

  cursor c5( vShip_id integer ) is
    select dr.line_no, m.bol, m.container_type,m.movement_no, m.seal, m.tare, dr.deliveryno, dr.itemno, dr.detaildesc, dr.pktpe_packtype,
    dr.qty,dr.partvolume, dr.partweight,dr.ecn, dr.hazard,dr.logno,  c.customer cus4, c4.customer cus2, r.currdate, s.voy, s.shipname
    from strang.detailrs dr, strang.ships_airway s, strang.customers c, strang.customers c4, strang.receivals r, strang.movements m
    where
     s.ship_id = vShip_id and
     m.ship_id = s.ship_id and
     m.movement_no = dr.movement_no and
     m.movement_type = 'CONMOV' and
     nvl(m.seal,'|') = nvl(dr.camov_seal,'|') and
     r.deliveryno = dr.deliveryno and
     r.cust_customer_id = c.customer_id and
     r.supplier_customer_id = c4.customer_id
    order by dr.line_no ;


  cursor c3(vShipid integer) is select * from strang.ships_airway where ship_id = vShipid;


  c3rec		c3%ROWTYPE;
  f 		utl_file.file_type;
  tot		integer;
  gcode		owa.vc_arr;
  gparam	owa.vc_arr;
  vste		varchar2(10);
  eml		varchar2(100);

  sts		varchar2(100);

begin
  if not dapi.init( surl, 'STRANGP.GENERATE_CCDETS', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'GENERATE_CCDETS' );
    return;
  end if;

 vste := customer_state(dapi.GLOBAL_ACCOUNT.acctid);
 eml := control_code( 'RAWDATA_EMAIL_ADDRESS', vste );
 eml := nvl( eml, gl.extract_master_parameter('MAIL_FROM') );

 open c3(vShip_id);
 fetch c3 into c3rec;
 close c3;
 f := utl_file.fopen( gl.extract_master_parameter('MAIL_TEMPLATE_DIR'), 'ccdets_' || c3rec.shipname || '_' || c3rec.voy || '.txt', 'w', 32767);

 for c4rec in c4(vShip_id) loop
  utl_file.put_line(f, buffer=>c4rec.line_no || ',"' ||  c4rec.bol || '","' || c4rec.container_type || '","' || c4rec.movement_no || '","' ||  c4rec.seal || '",' ||  c4rec.tare || ',"","","",' ||  c4rec.deliveryno || ',' ||  c4rec.itemno || ',"' ||  substr(c4rec.detaildesc,1,30) || '","'|| substr(c4rec.detaildesc,31,30) || '","'||  c4rec.pktpe_packtype
    || '",' || c4rec.qty || ',' || c4rec.partweight || ',' ||  c4rec.partvolume || ',"' || c4rec.ecn || '","' ||  c4rec.hazard || '","' || c4rec.logno || '","' ||   c4rec.cus2 || '","' ||  c4rec.cus4 || '","' ||  to_char(c4rec.currdate,'DD.MM.YYYY') || '","' ||  c4rec.voy || '","' ||  c4rec.shipname || '"' );

 end loop;

 for c5rec in c5(vShip_id) loop
  utl_file.put_line(f, buffer=>c5rec.line_no || ',"' ||  c5rec.bol || '","","","",'',"","","' || c5rec.movement_no || '",' ||  c5rec.deliveryno || ',' ||  c5rec.itemno || ',"' ||  substr(c5rec.detaildesc,1,30) || '","'|| substr(c5rec.detaildesc,31,30) || '","'||  c5rec.pktpe_packtype
    || '",' || c5rec.qty || ',' || c5rec.partweight || ',' ||  c5rec.partvolume || ',"' || c5rec.ecn || '","' ||  c5rec.hazard || '","' || c5rec.logno || '","' ||   c5rec.cus2 || '","' ||  c5rec.cus4 || '","' ||  to_char(c5rec.currdate,'DD.MM.YYYY') || '","' ||  c5rec.voy || '","' ||  c5rec.shipname || '"' );

 end loop;

 utl_file.fclose( f );

 gcode(1) := 'XXXX'; -- Dummy Parameter
 gparam(1) := 'XXXX';
 hml.send( gcode, gparam, 'ccdets_' || c3rec.shipname || '_' || c3rec.voy || '.txt', p_to=>eml, p_subj=>'ccdets_' || c3rec.shipname || '_' || c3rec.voy, p_from=>gl.extract_master_parameter('MAIL_FROM'));

exception when others then
 error_details( 'STRANGP', 'GENERATE_CCDETS',null,null,errmsg=>sqlerrm);
end generate_ccdets;

-- 20170607
procedure generate_ccpo( surl in varchar2, vShip_id in integer )
as

 cursor c4( vShip_id integer ) is
   select distinct p.deliveryno, p.recno, p.po, p.po_item_no, p.sap_delno_item qty, p.sap_delno, p.supinv,r.curr,p.tamount, p.delivery_charge, p.inventoryno, nvl(i.description,'NOT ALLOCATED') descn,m.movement_no, m.seal
   from strang.detailrs dr, strang.pos p, strang.ships_airway s, strang.receivals r, strang.movements m, strang.lov i
   where
    s.ship_id = vShip_id and
    m.ship_id = s.ship_id and
    m.movement_no = dr.movement_no and
    nvl(m.seal,'|') = nvl(dr.camov_seal,'|') and
    r.cust_customer_id = 1 and
    r.deliveryno = dr.deliveryno and
    r.deliveryno = p.deliveryno and
    nvl(p.inventoryno,'NOT ALLOCATED') = i.code and
    i.lov_name = 'INVENT'
  union
   select distinct p.deliveryno, p.recno, p.po, p.po_item_no, p.sap_delno_item qty, p.sap_delno, p.supinv,r.curr,p.tamount, p.delivery_charge, p.inventoryno, nvl(i.description,'NOT ALLOCATED') descn,m.movement_no, m.seal
   from strang.detailrs dr, strang.pos p, strang.ships_airway s, strang.receivals r, strang.movements m, strang.lov i
   where
    s.ship_id = vShip_id and
    m.ship_id = s.ship_id and
    m.movement_no = dr.movement_no and
    nvl(m.seal,'|') = nvl(dr.camov_seal,'|') and
    r.cust_customer_id = 1 and
    r.deliveryno = dr.deliveryno and
    r.deliveryno = p.deliveryno and
    p.inventoryno is not null and
    p.inventoryno not in (select code from strang.lov where lov_name = 'INVENT')
  order by po,po_item_no;

 cursor c5( vShip_id integer ) is
   select count('x') tot
      from
   (
   select distinct p.deliveryno, p.recno, p.po, p.po_item_no, p.sap_delno_item qty, p.sap_delno, p.supinv,r.curr,p.tamount, p.delivery_charge, p.inventoryno, nvl(i.description,'NOT ALLOCATED') descn,m.movement_no, m.seal
   from strang.detailrs dr, strang.pos p, strang.ships_airway s, strang.receivals r, strang.movements m, strang.lov i
   where
    s.ship_id = vShip_id and
    m.ship_id = s.ship_id and
    m.movement_no = dr.movement_no and
    nvl(m.seal,'|') = nvl(dr.camov_seal,'|') and
    r.cust_customer_id = 1 and
    r.deliveryno = dr.deliveryno and
    r.deliveryno = p.deliveryno and
    nvl(p.inventoryno,'NOT ALLOCATED') = i.code and
    i.lov_name = 'INVENT'
  union
   select distinct p.deliveryno, p.recno, p.po, p.po_item_no, p.sap_delno_item qty, p.sap_delno, p.supinv,r.curr,p.tamount, p.delivery_charge, p.inventoryno, nvl(i.description,'NOT ALLOCATED') descn,m.movement_no, m.seal
   from strang.detailrs dr, strang.pos p, strang.ships_airway s, strang.receivals r, strang.movements m, strang.lov i
   where
    s.ship_id = vShip_id and
    m.ship_id = s.ship_id and
    m.movement_no = dr.movement_no and
    nvl(m.seal,'|') = nvl(dr.camov_seal,'|') and
    r.cust_customer_id = 1 and
    r.deliveryno = dr.deliveryno and
    r.deliveryno = p.deliveryno and
    p.inventoryno is not null and
    p.inventoryno not in (select code from strang.lov where lov_name = 'INVENT')
  );


  cursor c3(vShipid integer) is select * from strang.ships_airway where ship_id = vShipid;


  c3rec		c3%ROWTYPE;
  c5rec		c5%ROWTYPE;
  f 		utl_file.file_type;
  tot		integer;
  gcode		owa.vc_arr;
  gparam	owa.vc_arr;
  vste		varchar2(10);
  eml		varchar2(100);

  sts		varchar2(100);

begin
  if not dapi.init( surl, 'STRANGP.GENERATE_CCPO', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'GENERATE_CCPO' );
    return;
  end if;

 vste := customer_state(dapi.GLOBAL_ACCOUNT.acctid);
 eml := control_code( 'RAWDATA_EMAIL_ADDRESS', vste );
 eml := nvl( eml, gl.extract_master_parameter('MAIL_FROM') );

 open c5(vShip_id);
 fetch c5 into tot;
 close c5;
 open c3(vShip_id);
 fetch c3 into c3rec;
 close c3;
 f := utl_file.fopen( gl.extract_master_parameter('MAIL_TEMPLATE_DIR'), 'POS_' || c3rec.shipname || '_' || c3rec.voy || '.csv', 'w', 32767);
 -- Output Header
 utl_file.put_line(f, buffer=>'H,' || to_char(sysdate,'DD.MM.YYYY') || ',' || tot );

 for c4rec in c4(vShip_id) loop
  utl_file.put_line(f, buffer=>'"'||c4rec.po|| '",' || c4rec.po_item_no|| ',' ||  c4rec.qty|| ',"' || c4rec.curr|| '",' || c4rec.tamount|| ',' || c4rec.delivery_charge|| ',' ||  c4rec.sap_delno ||  ',"' ||  c4rec.supinv|| '","' || c4rec.inventoryno|| '","' || c4rec.descn|| '","' || c4rec.movement_no ||'","' || c4rec.seal ||'"' ) ;

 end loop;
 -- Output Footer
 utl_file.put_line(f, buffer=>'F,' || to_char(sysdate,'DD.MM.YYYY') || ',' || tot );
 utl_file.fclose( f );

 gcode(1) := 'XXXX'; -- Dummy Parameter
 gparam(1) := 'XXXX';
 hml.send( gcode, gparam, 'POS_' || c3rec.shipname || '_' || c3rec.voy || '.csv', p_to=>eml, p_subj=>'POS_' || c3rec.shipname || '_' || c3rec.voy, p_from=>gl.extract_master_parameter('MAIL_FROM'),is_attachment=>TRUE);

exception when others then
 error_details( 'STRANGP', 'GENERATE_CCPO',null,null,errmsg=>sqlerrm);
end generate_ccpo;

-- 20170607

-- **************************************************************************************

procedure ctr_menu( surl in varchar2 )
as


 sts		varchar2(100);
 vaccess	varchar2(20);
 seclevel	varchar2(100);
 url		varchar2(1000);

begin
  if not dapi.init( surl, 'STRANGP.CTR_MENU', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'CTR_MENU' );
    return;
  end if;

  seclevel := security_role( dapi.GLOBAL_ACCOUNT.acctid );

 main_title( 'Container Menu',helpid=>'STR51');
 if vaccess = 'NONE' then htp.bold( 'Access Denied' ); htp.htmlclose; return; end if;
 htp.p( '<CENTER>' );

 header_msg( 'Container Menu' );

 htp.anchor( 'strangp.menu?surl=' || surl || '&rnd=' || to_char(sysdate,'SSSSS') || '&MTYPE=CTR', 'Container Hire' );
 htp.nl;
 htp.nl;
 htp.anchor( 'strangp.menu?surl=' || surl || '&rnd=' || to_char(sysdate,'SSSSS') || '&MTYPE=CTRACK', 'Container Tracking' );
 htp.nl;
 htp.nl;
 htp.p( '</CENTER>' );
 htp.htmlclose;
end ctr_menu;

procedure ctr_track( surl in varchar2, rid in varchar2 default null, id in varchar2 default null, msg in varchar2 default null, call_name in varchar2 default null, parm in varchar2 default null )
as

 cursor c2( vrid rowid ) is select * from strang.tracking_header where rowid = rid;
 cursor c3( sid integer ) is select * from strang.tracking_details where id = sid order by rno;
 cursor c4( sid integer, rnmb integer ) is select * from strang.tracking_details where id = sid and rno = rnmb;

 c2rec		c2%ROWTYPE;
 nxtrec		c4%ROWTYPE;
 sts		varchar2(100);
 vaccess	varchar2(20);
 seclevel	varchar2(100);
 url		varchar2(1000);

begin
  if not dapi.init( surl, 'STRANGP.CTR_TRACK' , null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'CTR_TRACK'  );
    return;
  end if;

  vaccess := data_access( 'CONTAINERS' );
  seclevel := security_role( dapi.GLOBAL_ACCOUNT.acctid );

 main_title( 'Container Tracking',helpid=>'STR52');
 if vaccess = 'NONE' then htp.bold( 'Access Denied' ); htp.htmlclose; return; end if;
 htp.p( '<CENTER>' );
 if id <> 'z' and rid is not null
  then
   open c2(replace(rid,'~','+'));
   fetch c2 into c2rec;
   close c2;
 end if;

 htp.formopen( 'strangp.accept_ctr_track' );
 htp.formhidden( 'SURL', surl );
 htp.formhidden( 'RID', replace(rid,'~','+') );
 htp.formhidden( 'P1', null );
 htp.formhidden( 'P2', null );
 htp.formhidden( 'P3', null );
 htp.formhidden( 'P4', null );

 if rid is null and id <> 'z'
  then
   htp.bold( 'No Container Tracking Record Found' );
   htp.nl;

  else

  htp.tableopen( cattributes=>'class="str1_table"' );
   htp.tablerowopen;
    htp.tabledata( htf.bold('Container No'),cattributes=>'class="str1_bg_left"');
    if vaccess = 'EDIT' and id = 'z'
     then
      htp.tabledata( htf.formhidden( 'P1', 'CONTAINERNO' ) || htf.formtext('P2', 40, 100, c2rec.containerno),cattributes=>'class="str1_bg_left"');
     else
      htp.tabledata( htf.bold(c2rec.containerno),cattributes=>'class="str1_bg_left"');
    end if;
   htp.tablerowclose;
   htp.tablerowopen;
    htp.tabledata( htf.bold('Container Type'),cattributes=>'class="str1_bg_left"');
    if vaccess = 'EDIT'
     then
      htp.tabledata( htf.formhidden( 'P1', 'CAT_CODE' ) || htf.formtext('P2', 40, 100, c2rec.cat_code),cattributes=>'class="str1_bg_left"');
     else
      htp.tabledata( htf.bold(c2rec.cat_code),cattributes=>'class="str1_bg_left"');
    end if;
   htp.tablerowclose;
   htp.tablerowopen;
    htp.tabledata( htf.bold('Container Owner'),cattributes=>'class="str1_bg_left"');
    if vaccess = 'EDIT'
     then
      htp.tabledata( htf.formhidden( 'P1', 'CAT_COMPANY' ) || htf.formtext('P2', 40, 100, c2rec.cat_company),cattributes=>'class="str1_bg_left"');
     else
      htp.tabledata( htf.bold(c2rec.cat_company),cattributes=>'class="str1_bg_left"');
    end if;
   htp.tablerowclose;

  htp.tableclose;
  htp.nl;
  htp.line;
  htp.nl;
  htp.tableopen( cattributes=>'class="str1_table"' );
  htp.tablerowopen;
   htp.tabledata( '&nbsp;',cattributes=>'class="str1_bg_left"');
   htp.tabledata( htf.bold('Rno'),cattributes=>'class="str1_bg_left"');
   htp.tabledata( htf.bold('Movement<BR>Type'),cattributes=>'class="str1_bg_left"');
   htp.tabledata( htf.bold('Ship' || htf.nl || 'Voyage'),cattributes=>'class="str1_bg_left"');
   htp.tabledata( htf.bold('Etd' || htf.nl || 'From Loc'),cattributes=>'class="str1_bg_left"');
   htp.tabledata( htf.bold('Eta' || htf.nl || 'To Loc'),cattributes=>'class="str1_bg_left"');
   htp.tabledata( htf.bold('Current<BR>Location'),cattributes=>'class="str1_bg_left"');
   htp.tabledata( htf.bold('Date at<BR>Location'),cattributes=>'class="str1_bg_left"');
   htp.tabledata( htf.bold('Remark'),cattributes=>'class="str1_bg_left"');
   htp.tabledata( htf.bold('Activity<BR>Status'),cattributes=>'class="str1_bg_left"');
  htp.tablerowclose;

  for c3rec in c3( c2rec.id ) loop
    htp.tablerowopen;
     htp.tabledata( htf.anchor( 'strangp.ctrdel?surl=' || surl || '&sno=' || c2rec.id || '&rn=' || c3rec.rno,'Delete'),cattributes=>'class="str1_bg_left"');
     htp.tabledata( c3rec.rno, cattributes=>'class="str1_bg_left"');
     htp.tabledata( htf.formhidden( 'P3', '[' || to_char(c3rec.rno) || ']' || 'MTYPE' ) || htf.formtext( 'P4', 20, 100, c3rec.movement_type ),cattributes=>'class="str1_bg_left"');
     htp.tabledata( htf.formhidden( 'P3', '[' || to_char(c3rec.rno) || ']' || 'SHIP' ) || htf.formtext( 'P4', 30, 100, c3rec.ship ) || htf.nl ||
                    htf.formhidden( 'P3', '[' || to_char(c3rec.rno) || ']' || 'VOYAGE' ) || htf.formtext( 'P4', 30, 100, c3rec.voyage ),cattributes=>'class="str1_bg_left"');
     htp.tabledata( htf.formhidden( 'P3', '[' || to_char(c3rec.rno) || ']' || 'ETD' ) || htf.formtext( 'P4', 12, 100, to_char(c3rec.etd_date,'DD-MON-YYYY') ) || htf.nl ||
                    htf.formhidden( 'P3', '[' || to_char(c3rec.rno) || ']' || 'FROMLOC' ) || htf.formtext( 'P4', 12, 100, c3rec.departure_location ),cattributes=>'class="str1_bg_left"');
     htp.tabledata( htf.formhidden( 'P3', '[' || to_char(c3rec.rno) || ']' || 'ETA' ) || htf.formtext( 'P4', 12, 100, to_char(c3rec.eta_date,'DD-MON-YYYY') ) || htf.nl ||
                    htf.formhidden( 'P3', '[' || to_char(c3rec.rno) || ']' || 'TOLOC' ) || htf.formtext( 'P4', 12, 100, c3rec.arrival_location ),cattributes=>'class="str1_bg_left"');
     htp.tabledata( htf.formhidden( 'P3', '[' || to_char(c3rec.rno) || ']' || 'CURRLOC' ) || htf.formtext( 'P4', 10, 100, c3rec.current_location ),cattributes=>'class="str1_bg_left"');
     htp.tabledata( htf.formhidden( 'P3', '[' || to_char(c3rec.rno) || ']' || 'DATELOC' ) || htf.formtext( 'P4', 10, 100, to_char(c3rec.date_at_current_loc,'DD-MON-YYYY') ),cattributes=>'class="str1_bg_left"');
     htp.tabledata( htf.formhidden( 'P3', '[' || to_char(c3rec.rno) || ']' || 'RNO' ) || htf.formhidden( 'P4', c3rec.rno ) ||
                    htf.formhidden( 'P3', '[' || to_char(c3rec.rno) || ']' || 'REMARK' ) || htf.formtext( 'P4', 30, 100, c3rec.remark ),cattributes=>'class="str1_bg_left"');
     htp.p( '<TD ' || 'class="str1_bg_left"' || '>' );
      nxtrec := null;
      open c4(c3rec.id, c3rec.rno + 1);
      fetch c4 into nxtrec;
      close c4;
      if nxtrec.rno is null
       then
        htp.bold( to_number(trunc(trunc(sysdate) - c3rec.date_at_current_loc)) );
       else
         htp.bold( to_number(trunc( nvl(nxtrec.etd_date,nxtrec.date_at_current_loc) - c3rec.date_at_current_loc )));
      end if;
     htp.p( '</TD>' );
    htp.tablerowclose;
  end loop;

  if vaccess = 'EDIT'
   then
    for j in 1..3 loop
     htp.tablerowopen;
      htp.tabledata( '&nbsp;',cattributes=>'class="str1_bg_left"');
      htp.tabledata( '&nbsp;',cattributes=>'class="str1_bg_left"');
      htp.tabledata( htf.formhidden( 'P3', '[N' || to_char(j) || ']' || 'MTYPE' ) || htf.formtext( 'P4', 10, 100 ),cattributes=>'class="str1_bg_left"');
      htp.tabledata( htf.formhidden( 'P3', '[N' || to_char(j) || ']' || 'SHIP' ) || htf.formtext( 'P4', 30, 100 ) || htf.nl ||
                     htf.formhidden( 'P3', '[N' || to_char(j) || ']' || 'VOYAGE' ) || htf.formtext( 'P4', 30, 100 ),cattributes=>'class="str1_bg_left"');
      htp.tabledata( htf.formhidden( 'P3', '[N' || to_char(j) || ']' || 'ETD' ) || htf.formtext( 'P4', 12, 100 ) || htf.nl ||
                     htf.formhidden( 'P3', '[N' || to_char(j) || ']' || 'FROMLOC' ) || htf.formtext( 'P4', 12, 100 ),cattributes=>'class="str1_bg_left"');
      htp.tabledata( htf.formhidden( 'P3', '[N' || to_char(j) || ']' || 'ETA' ) || htf.formtext( 'P4', 12, 100 ) || htf.nl ||
                     htf.formhidden( 'P3', '[N' || to_char(j) || ']' || 'TOLOC' ) || htf.formtext( 'P4', 12, 100 ),cattributes=>'class="str1_bg_left"');
      htp.tabledata( htf.formhidden( 'P3', '[N' || to_char(j) || ']' || 'CURRLOC' ) || htf.formtext( 'P4', 10, 100 ),cattributes=>'class="str1_bg_left"');
      htp.tabledata( htf.formhidden( 'P3', '[N' || to_char(j) || ']' || 'DATELOC' ) || htf.formtext( 'P4', 10, 100 ),cattributes=>'class="str1_bg_left"');
      htp.tabledata( htf.formhidden( 'P3', '[N' || to_char(j) || ']' || 'REMARK' ) || htf.formtext( 'P4', 30, 100 ),cattributes=>'class="str1_bg_left"');
      htp.tabledata( '&nbsp;',cattributes=>'class="str1_bg_left"');
     htp.tablerowclose;
    end loop;
  end if;
 end if;

 htp.nl;
 htp.nl;
 htp.tableopen( cattributes=>'class="str1_table4"' );
 htp.tablerowopen;
 if vaccess = 'EDIT' and (id = 'z')
  then
   htp.tabledata( htf.formsubmit( 'ACTION', 'Insert' ),cattributes=>'VALIGN="TOP"');
 elsif vaccess = 'EDIT' and id <> 'z' and rid is not null
  then
   htp.tabledata( htf.formsubmit( 'ACTION', 'Update' ),cattributes=>'VALIGN="TOP"');
   htp.tabledata( htf.formsubmit( 'ACTION', 'Delete' ),cattributes=>'VALIGN="TOP"');
 elsif vaccess = 'READ' and id <> 'z' AND seclevel in ( 'LEVEL 6','LEVEL 7' )
  then
   htp.tabledata( htf.formsubmit( 'ACTION', 'Delete' ),cattributes=>'VALIGN="TOP"');
 end if;

 htp.formclose;
 if vaccess = 'EDIT'
  then
   htp.tabledata( htf.formopen( 'strangp.ctr_track' ) || htf.formhidden( 'SURL', surl ) || htf.formhidden( 'ID', 'z' ) || htf.formhidden( 'RID', null ) || htf.formsubmit( null, 'Create New Record' ) || htf.formclose,cattributes=>'VALIGN="TOP"');
 end if;
 htp.tablerowclose;
 htp.tableclose;
 htp.formclose;

 htp.nl;
 htp.nl;
 search( surl, 'CTRACK', rid );
 htp.nl;

 if msg is not null
  then
   header_msg( msg );
 end if;

 htp.p( '</CENTER>' );
 htp.tableclose;
exception when others then
 error_details( 'STRANGP', 'CTR_TRACK',null,null,errmsg=>sqlerrm,extdet=>'RID:' || rid);
end ctr_track;

procedure ctrdel( surl in varchar2, sno in varchar2, rn in varchar2 )
as

 cursor c1(sno integer) is select rowid from strang.tracking_header where id = sno;

 cursor c2(sno integer) is select rowid from strang.tracking_details where id = sno order by rno;

 c1rec		c1%ROWTYPE;

 nmb		integer;
 sts		varchar2(100);
 vaccess	varchar2(20);
 seclevel	varchar2(100);
begin
  if not dapi.init( surl, 'STRANGP.CTRDEL', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'CTRDEL'  );
    return;
  end if;

 delete from strang.tracking_details where id = sno and rno = rn;
 nmb := 0;
 for c2rec in c2(sno) loop
  nmb := nmb + 1;
  update strang.tracking_details set rno = nmb where rowid = c2rec.rowid;
 end loop;
 commit;
 open c1(sno);
 fetch c1 into c1rec;
 close c1;
 ctr_track(surl,c1rec.rowid,'x','Container Tracking Record Deleted' );
end ctrdel;

procedure accept_ctr_track( surl in varchar2, rid in varchar2, p1 in owa.vc_arr, p2 in owa.vc_arr, p3 in owa.vc_arr, p4 in owa.vc_arr, action in varchar2 )
as

 cursor c1(rid rowid) is select id from strang.tracking_header where rowid = rid;


 cnrec		strang.tracking_header%ROWTYPE;
 cdrec		strang.tracking_details%ROWTYPE;



 nmb1		integer;
 nmb2		integer;
 sts		varchar2(100);
 newrid		rowid;
 vste		varchar2(10);
 sno		integer;
 ctr		integer;

 function getval( cd in varchar2, v1 in owa.vc_arr, v2 in owa.vc_arr )
  return varchar2
 as
 begin
  for j in v1.first..v1.last loop
   if v1(j) = cd then return( v2(j) ); end if;
  end loop;
  return( null );
 end getval;

begin
  if not dapi.init( surl, 'STRANGP.ACCEPT_CTR_TRACK', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'ACCEPT_CTR_TRACK'  );
    return;
  end if;

  vste := customer_state(dapi.GLOBAL_ACCOUNT.acctid);

  if action = 'Delete'
   then
    delete from strang.tracking_details where id in (select id from strang.tracking_header where rowid = chartorowid(replace(rid,'~','+')));
    delete from strang.tracking_header where rowid = chartorowid(replace(rid,'~','+'));
    search( surl, 'CTRACK', null );
    return;
  end if;

  if action = 'Insert'
   then
    cnrec.containerno := getval( 'CONTAINERNO', p1, p2 );
    cnrec.cat_code := getval( 'CAT_CODE', p1, p2 );
    cnrec.cat_company := getval( 'CAT_COMPANY', p1, p2 );
    if cnrec.containerno is null or
       cnrec.cat_code is null or
       cnrec.cat_company is null
     then
      ctr_track(surl,rid,'z','You must specify a value for Container, Type and Owner' );
      return;
    end if;
    select strang.s_tracking_header.nextval into sno from dual;
    insert into strang.tracking_header(id,containerno,cat_code,cat_company) values
     (sno,cnrec.containerno,cnrec.cat_code,cnrec.cat_company)
    returning rowid into newrid;
  end if;

  if action = 'Update'
   then
    open c1( chartorowid(replace(rid,'~','+')) );
    fetch c1 into sno;
    close c1;
    --cnrec.containerno := getval( 'CONTAINERNO', p1, p2 );
    cnrec.cat_code := getval( 'CAT_CODE', p1, p2 );
    cnrec.cat_company := getval( 'CAT_COMPANY', p1, p2 );
    update strang.tracking_header
     set
      cat_code = cnrec.cat_code,
      cat_company = cnrec.cat_company
     where
      id = sno;
  end if;

  -- Add tracking body
  ctr := 0;
  if action = 'Update'
   then
    loop
     cdrec := null;
     ctr := ctr + 1;
     cdrec.rno := getval( '[' || ctr || ']' || 'RNO', p3, p4 );
     if cdrec.rno is null then exit; end if;
     cdrec.remark := getval( '[' || ctr || ']' || 'REMARK', p3, p4 );
     cdrec.movement_type := getval( '[' || ctr || ']' || 'MTYPE', p3, p4 );
     cdrec.departure_location := getval( '[' || ctr || ']' || 'FROMLOC', p3, p4 );
     cdrec.etd_date := to_date(getval( '[' || ctr || ']' || 'ETD', p3, p4 ),'DD-MON-YYYY');
     cdrec.arrival_location := getval( '[' || ctr || ']' || 'TOLOC', p3, p4 );
     cdrec.eta_date := to_date(getval( '[' || ctr || ']' || 'ETA', p3, p4 ),'DD-MON-YYYY');
     cdrec.ship := getval( '[' || ctr || ']' || 'SHIP', p3, p4 );
     cdrec.voyage := getval( '[' || ctr || ']' || 'VOYAGE', p3, p4 );
     cdrec.current_location := getval( '[' || ctr || ']' || 'CURRLOC', p3, p4 );
     cdrec.date_at_current_loc := to_date(getval( '[' || ctr || ']' || 'DATELOC', p3, p4 ),'DD-MON-YYYY');
     update strang.tracking_details
      set
       remark = cdrec.remark,
       movement_type = cdrec.movement_type,
       departure_location = cdrec.departure_location,
       etd_date = cdrec.etd_date,
       arrival_location = cdrec.arrival_location,
       eta_date = cdrec.eta_date,
       ship = cdrec.ship,
       voyage = cdrec.voyage,
       current_location = cdrec.current_location,
       date_at_current_loc = cdrec.date_at_current_loc
     where
      id = sno and
      rno = ctr;
    end loop;
  end if;

  ctr := 0;
     cdrec := null;
  if action in ('Insert','Update')
   then
    for j in 1..3 loop
     select nvl(max(rno),0) + 1 nmb into cdrec.rno from strang.tracking_details where id = sno;
     cdrec.remark := getval( '[N' || j || ']' || 'REMARK', p3, p4 );
     cdrec.movement_type := getval( '[N' || j || ']' || 'MTYPE', p3, p4 );
     cdrec.departure_location := getval( '[N' || j || ']' || 'FROMLOC', p3, p4 );
     begin cdrec.etd_date := to_date(getval( '[N' || j || ']' || 'ETD', p3, p4 ),'DD-MON-YYYY'); exception when others then cdrec.etd_date := null; end;
     cdrec.arrival_location := getval( '[N' || j || ']' || 'TOLOC', p3, p4 );
     begin cdrec.eta_date := to_date(getval( '[N' || j || ']' || 'ETA', p3, p4 ),'DD-MON-YYYY'); exception when others then cdrec.eta_date := null; end;
     cdrec.ship := getval( '[N' || j || ']' || 'SHIP', p3, p4 );
     cdrec.voyage := getval( '[N' || j || ']' || 'VOYAGE', p3, p4 );
     cdrec.current_location := getval( '[N' || j || ']' || 'CURRLOC', p3, p4 );

     begin cdrec.date_at_current_loc := to_date(getval( '[N' || j || ']' || 'DATELOC', p3, p4 ),'DD-MON-YYYY'); exception when others then cdrec.date_at_current_loc := null; end;

     cdrec.current_location := nvl(cdrec.current_location,cdrec.arrival_location);
     cdrec.date_at_current_loc := nvl(cdrec.date_at_current_loc,cdrec.eta_date);

     if cdrec.movement_type is null or
        cdrec.date_at_current_loc is null
      then
       null;
      else
       insert into strang.tracking_details(id,rno,remark,movement_type,departure_location,etd_date,arrival_location,eta_date,ship,voyage,current_location,date_at_current_loc)
        values(sno,cdrec.rno,cdrec.remark,cdrec.movement_type,cdrec.departure_location,cdrec.etd_date,cdrec.arrival_location,cdrec.eta_date,cdrec.ship,cdrec.voyage,cdrec.current_location,cdrec.date_at_current_loc);
     end if;
    end loop;
  end if;

  commit;

  if action = 'Update'
   then
    ctr_track( surl, rid, 'x', 'Record Modified' );
  elsif action = 'Insert'
   then
    ctr_track( surl, newrid, 'x', 'Record Inserted' );
  end if;
exception when others then
 error_details( 'STRANGP', 'ACCEPT_CTR_TRACK',null,null,errmsg=>sqlerrm,extdet=>'RID:' || rid);
end accept_ctr_track;

procedure mng_ctr( surl in varchar2, rid in varchar2 default null, id in varchar2 default null, msg in varchar2 default null, call_name in varchar2 default null, parm in varchar2 default null )
as

 cursor c2( rid rowid ) is select * from strang.containers where rowid = rid;
 cursor c3 is select * from strang.onlocs order by loc_location;
 cursor c4( ccomp varchar2, cct varchar2,ccode varchar2) is select * from strang.onlocs
 where
 cat_company = ccomp and
 cat_contract = cct and
 cat_code = ccode
 order by cat_contract, cat_company;
 cursor c5 is select * from strang.offlocs order by loc_location;
 cursor c6( ccomp varchar2, cct varchar2,ccode varchar2) is select * from strang.offlocs
 where
 cat_company = ccomp and
 cat_contract = cct and
 cat_code = ccode
 order by cat_contract, cat_company;
 cursor c7 is select * from strang.categories order by contract;
 cursor c7a(ck varchar2, cd varchar2, cm varchar2) is select rno from strang.categories where contract = ck and codedesc = cd and company = cm;
 cursor c8 is select * from strang.lov where lov_name = 'UNCTNTAB' order by code;


 c2rec		c2%ROWTYPE;
 c7arec		c7a%ROWTYPE;




 sts		varchar2(100);
 vaccess	varchar2(20);
 seclevel	varchar2(100);
 url		varchar2(1000);

begin
  if not dapi.init( surl, 'STRANGP.MNG_CTR', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'MNG_CTR'  );
    return;
  end if;

  vaccess := data_access( 'CONTAINERS' );
  seclevel := security_role( dapi.GLOBAL_ACCOUNT.acctid );

 main_title( 'CONTAINER HIRE MAINTENANCE',helpid=>'STR53');
 if vaccess = 'NONE' then htp.bold( 'Access Denied' ); htp.htmlclose; return; end if;
 htp.p( '<CENTER>' );
 if id <> 'z' and rid is not null
  then
   open c2(replace(rid,'~','+'));
   fetch c2 into c2rec;
   close c2;
 end if;
 --gl.dbg( 'X1:' || VACCESS );
 --gl.dbg( C2REC.OFFDATE);
 --gl.dbg( C2REC.FLOC_LOCATION);
 if vaccess = 'EDIT'  and (c2rec.offdate is not null) and (c2rec.floc_location is not null) then
    vaccess := 'READ';
 end if;

 htp.formopen( 'strangp.accept_mng_ctr', ctarget=>'_top' );
 htp.formhidden( 'SURL', surl );
   htp.formhidden( 'RID', replace(rid,'~','+') );
   htp.formhidden( 'ID', id );

if vaccess = 'READ' then
   htp.formhidden( 'P1', null );
   htp.formhidden( 'P2', null );
   htp.formhidden( 'P3', null );
   htp.formhidden( 'P4', null );
   htp.formhidden( 'P5', null );
   htp.formhidden( 'P6', null );
   htp.formhidden( 'P10', null );
   htp.formhidden( 'P7', null );
   htp.formhidden( 'P8', null );
   htp.formhidden( 'P9', null );
   htp.formhidden( 'P11', null );
   htp.formhidden( 'P12', null );
end if;


 htp.tableopen( cattributes=>'class="str1_table"' );
  htp.tablerowopen;
   htp.tabledata( htf.bold('Container No'),cattributes=>'class="str1_bg_left"');
   if vaccess = 'EDIT' and id = 'z'
    then
     htp.tabledata( htf.formtext('P1', 15, 15, c2rec.containerno),cattributes=>'class="str1_bg_left"');
    else
     htp.tabledata( htf.formhidden( 'P1', c2rec.containerno ) || htf.bold(c2rec.containerno),cattributes=>'class="str1_bg_left"');
   end if;
   htp.tabledata( htf.bold('Company Name'),cattributes=>'class="str1_bg_left"');
   htp.tabledata( htf.bold(nvl(c2rec.cat_company,'&nbsp')),cattributes=>'class="str1_cell_left" COLSPAN="3" ');
  htp.tablerowclose;
     if vaccess = 'EDIT' and id = 'z'
      then
       htp.tablerowopen;
       htp.tabledata( htf.bold('Details'),cattributes=>'class="str1_bg_left"');
        htp.p( '<TD '|| 'class="str1_cell_left"  COLSPAN="5">' );
          htp.formselectopen( 'P2' );
              for c7rec in c7  loop
                if c7rec.contract=c2rec.cat_contract then
                  htp.formselectoption( ' --- '|| c7rec.contract || ' --- '|| c7rec.codedesc || ' --- '|| c7rec.company, 'SELECTED', cattributes=>'VALUE="'||c7rec.rno ||'"');
                else
                  htp.formselectoption( ' --- '|| c7rec.contract || ' --- '|| c7rec.codedesc || ' --- '|| c7rec.company, cattributes=>'VALUE="'||c7rec.rno ||'"');
               end if;
              end loop;
          htp.formselectclose;
        htp.p( '</TD>');
       htp.tablerowclose;
     elsif vaccess = 'EDIT'
      then
       open c7a(c2rec.cat_contract, c2rec.cat_code, c2rec.cat_company);
       fetch c7a into c7arec;
       close c7a;
       htp.formhidden('P2', c7arec.rno );
      else
       htp.tablerowopen;
        htp.tabledata( htf.bold('Details'),cattributes=>'class="str1_bg_left"');
        htp.tabledata( '&nbsp;',cattributes=>'class="str1_cell_left" COLSPAN="5"');
       htp.tablerowclose;
     end if;

  htp.tablerowopen;
   htp.tabledata( htf.bold('Contract'),cattributes=>'class="str1_bg_left"');
   htp.tabledata( htf.bold(nvl(c2rec.cat_contract,'&nbsp')),cattributes=>'class="str1_bg_left"');


   htp.tabledata( htf.bold('ISO Container Type'),cattributes=>'class="str1_bg_left"');

     if vaccess = 'EDIT'
      then
        htp.p( '<TD '|| 'class="str1_cell_left" COLSPAN="3">' );
          htp.formselectopen( 'P3' );
              for c8rec in c8 loop
                if c8rec.code=c2rec.ctpe_ctrtype
                 then
                  htp.formselectoption( c8rec.code, 'SELECTED', cattributes=>'VALUE="'|| c8rec.code || '"');
                else
                  htp.formselectoption( c8rec.code, cattributes=>'VALUE="' ||c8rec.code || '"');
               end if;
              end loop;

          htp.formselectclose;
        htp.p( '</TD>');
      else
       htp.tabledata( htf.bold(nvl(c2rec.ctpe_ctrtype,'&nbsp;')),cattributes=>'class="str1_cell_left" COLSPAN="3"');
     end if;
  htp.tablerowclose;


  htp.tablerowopen;
   htp.tabledata( htf.bold('Category Code'),cattributes=>'class="str1_bg_left"');
   htp.tabledata( htf.bold(nvl(c2rec.cat_code,'&nbsp')),cattributes=>'class="str1_bg_left"');
   htp.tabledata( htf.bold('Description'),cattributes=>'class="str1_bg_left"');
   if vaccess = 'EDIT'
    then
     htp.tabledata( htf.formtext('P4', 30, 30, c2rec.ctrdesc),cattributes=>'class="str1_cell_left" COLSPAN="3" ');
    else
     htp.tabledata( htf.bold(nvl(c2rec.ctrdesc,'&nbsp;')),cattributes=>'class="str1_cell_left" COLSPAN="3" ');
   end if;
  htp.tablerowclose;

  htp.tablerowopen;
   htp.tabledata( '&nbsp;',cattributes=>'class="str1_bg_left" colspan="2"');
   htp.tabledata( htf.bold('Backcharge'),cattributes=>'class="str1_bg_left"');

   if vaccess = 'EDIT'
    then
      htp.p( '<TD '|| 'class="str1_cell_left"  >' );
        htp.formselectopen( 'P5' );
        if c2rec.backcharge='NO' then
           htp.formselectoption('NO', 'SELECTED');
        else
           htp.formselectoption('NO');
        end if;
        if c2rec.backcharge='YES' then
           htp.formselectoption('YES', 'SELECTED');
        else
           htp.formselectoption('YES');
        end if;
        htp.formselectclose;
        htp.p( '</TD>');
    else
     htp.tabledata( htf.bold(nvl(c2rec.backcharge,'&nbsp;')),cattributes=>'class="str1_bg_left"');
   end if;

 htp.tabledata( htf.bold('Times Hired'),cattributes=>'class="str1_bg_left"');
   htp.tabledata( htf.bold(nvl(to_char(c2rec.timeshired),'&nbsp')),cattributes=>'class="str1_bg_left"');
  htp.tablerowclose;
  htp.tablerowopen;
  htp.tabledata(htf.line(cattributes=>'width=50% size=4'),cattributes=>'class="str1_cell_center_middle" colspan="6"');
  htp.tablerowclose;

  if vaccess = 'EDIT' and id = 'z'
   then
    htp.formhidden( 'P6', NULL );
    htp.formhidden( 'P7', NULL );
    htp.formhidden( 'P8', NULL );
    htp.formhidden( 'P9', NULL );
    htp.formhidden( 'P10', NULL );
    htp.formhidden( 'P11', NULL );
    htp.formhidden( 'P12', NULL );
   else

  htp.tablerowopen;
  htp.tabledata(htf.bold('Onhire Information'),cattributes=>'class="str1_cell_center_middle" colspan="3"');
  htp.tabledata(htf.bold('Offhire Information'),cattributes=>'class="str1_cell_center_middle" colspan="3"');
  htp.tablerowclose;

  htp.tablerowopen;
   htp.tabledata( htf.bold('Date Hired'),cattributes=>'class="str1_bg_left"');
   if vaccess = 'EDIT'
    then
     htp.tabledata( htf.formtext('P6', 15, 15, to_char(c2rec.datehired, 'dd-MON-yyyy')),cattributes=>'class="str1_bg_left"');
    else
     htp.tabledata( htf.bold(nvl(to_char(c2rec.datehired, 'dd-MON-yyyy'),'&nbsp;')),cattributes=>'class="str1_bg_left"');
   end if;
   htp.tabledata( htf.bold('Off Hire Date'),cattributes=>'class="str1_bg_left"');
   if vaccess = 'EDIT' and (id <> 'z')
    then
     htp.tabledata( htf.formtext('P7', 15, 15, to_char(c2rec.offdate, 'dd-MON-yyyy')),cattributes=>'class="str1_cell_left" COLSPAN="3" ');
    else
     htp.tabledata( htf.bold(nvl(to_char(c2rec.offdate,'dd-MON-yyyy'),'&nbsp;')),cattributes=>'class="str1_cell_left" COLSPAN="3" ');
   end if;
  htp.tablerowclose;

if vaccess = 'EDIT' then
htp.tablerowopen;
   htp.tabledata( htf.bold('On Hire Details'),cattributes=>'class="str1_bg_left"');
   if vaccess = 'EDIT'
    then
      htp.p( '<TD '|| 'class="str1_cell_left">' );
        htp.formselectopen( 'P8' );
          if id = 'z' then
            for c3rec in c3 loop
              htp.formselectoption( c3rec.loc_location || ' '|| c3rec.cat_company || ' '|| c3rec.cat_contract || ' '|| c3rec.cat_code , cattributes=>'VALUE="'|| C3rec.loc_location || '"');
            end loop;
          else
          --gl.dbg( 'X2:c2rec.cat_company '|| c2rec.cat_company );
         --gl.dbg( 'X2:c2rec.cat_contract '|| c2rec.cat_contract );
         --gl.dbg( 'X2:c2rec.cat_code '|| c2rec.cat_code );
         --gl.dbg( 'X2:c2rec.cat_cdate '|| c2rec.cat_cdate );
           htp.formselectoption( NULL );
            for c4rec in c4( c2rec.cat_company,c2rec.cat_contract,c2rec.cat_code) loop
              if c4rec.loc_location=c2rec.nloc_location then
                htp.formselectoption( c4rec.loc_location, 'SELECTED', cattributes=>'VALUE="'|| c4rec.loc_location || '"');
              else
                htp.formselectoption( c4rec.loc_location , cattributes=>'VALUE="'|| c4rec.loc_location || '"');
             end if;
            end loop;
          end if;

        htp.formselectclose;
      htp.p( '</TD>');
    else
     htp.tabledata( htf.bold(nvl(c2rec.nloc_location,'&nbsp;')),cattributes=>'class="str1_bg_left"');
   end if;

   htp.tabledata( htf.bold('Off Hire Details'),cattributes=>'class="str1_bg_left"');
   if vaccess = 'EDIT' and (id <> 'z')
    then
      htp.p( '<TD '|| 'class="str1_cell_left"  COLSPAN="3" >' );
        htp.formselectopen( 'P9' );
        htp.formselectoption( null );
          if id = 'z' then
            for c5rec in c5 loop
              htp.formselectoption( c5rec.loc_location || ' '||  c5rec.cat_company || ' '|| c5rec.cat_contract || ' '|| c5rec.cat_code , cattributes=>'VALUE="'|| c5rec.loc_location || '"');
            end loop;
          else
            for c6rec in c6( c2rec.cat_company,c2rec.cat_contract,c2rec.cat_code)

            loop
              if c6rec.loc_location=c2rec.floc_location then
                htp.formselectoption( c6rec.loc_location, 'SELECTED', cattributes=>'VALUE="'|| c6rec.loc_location || '"');
              else
                htp.formselectoption( c6rec.loc_location, cattributes=>'VALUE="'|| c6rec.loc_location || '"');
             end if;
            end loop;
          end if;

        htp.formselectclose;
      htp.p( '</TD>');
    else
     htp.tabledata( htf.bold(nvl(c2rec.floc_location,'&nbsp;')),cattributes=>'class="str1_cell_left" COLSPAN="3" ');

   end if;
   htp.tablerowclose;
 end if;

if vaccess = 'EDIT'
 then
  null;
 else
htp.tablerowopen;
    htp.tabledata( htf.bold('On Hire Location'),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.bold(nvl(c2rec.nloc_location,'&nbsp;')),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.bold('Off Hire Location'),cattributes=>'class="str1_bg_left"');
    htp.tabledata( htf.bold(nvl(c2rec.floc_location,'&nbsp;')),cattributes=>'class="str1_cell_left" COLSPAN="3" ');
  htp.tablerowclose;
end if;
  --htp.tablerowopen;
  --  htp.tabledata( htf.bold('On Hire Validation Date'),cattributes=>'class="str1_bg_left"');
  --htp.tablerowclose;
  --  htp.tabledata( htf.bold(nvl(to_char(c2rec.nloc_cdate,'DD-MON-YYYY'),'&nbsp;')),cattributes=>'class="str1_bg_left"');
  --  htp.tabledata( htf.bold('Off Hire Validation Date'),cattributes=>'class="str1_bg_left"');
  --  htp.tabledata( htf.bold(nvl(to_char(c2rec.floc_cdate,'DD-MON-YYYY'),'&nbsp;')),cattributes=>'class="str1_cell_left" COLSPAN="3" ');

  htp.tablerowopen;
  htp.tabledata( htf.bold('Release'),cattributes=>'class="str1_bg_left"  VALIGN="TOP" ');
   if vaccess = 'EDIT'
    then
     htp.tabledata( htf.formtext('P10', 15, 15, c2rec.crelease),cattributes=>'class="str1_cell_left" VALIGN="TOP" ');
    else
     htp.tabledata( htf.bold(nvl(c2rec.crelease,'&nbsp')),cattributes=>'class="str1_cell_left" VALIGN="TOP" ');
   end if;
  htp.tabledata( htf.bold('Turn In'),cattributes=>'class="str1_bg_left"');
   if vaccess = 'EDIT'
    then
     htp.tabledata( htf.formtext('P11', 15, 15, c2rec.turnin),cattributes=>'class="str1_cell_left" COLSPAN="3" ');
    else
     htp.tabledata( htf.bold(nvl(c2rec.turnin,'&nbsp')),cattributes=>'class="str1_cell_left" COLSPAN="3" ');
   end if;
  htp.tablerowclose;
  htp.tablerowopen;
  htp.tabledata( '&nbsp;',cattributes=>'class="str1_bg_left" COLSPAN="2" ');
  htp.tabledata( htf.bold('EIR'),cattributes=>'class="str1_bg_left"');
   if vaccess = 'EDIT'
    then
     htp.tabledata( htf.formtext('P12', 15, 15, c2rec.eir),cattributes=>'class="str1_cell_left" COLSPAN="3" ');
    else
     htp.tabledata( htf.bold(nvl(c2rec.eir,'&nbsp')),cattributes=>'class="str1_cell_left" COLSPAN="3" ');
   end if;
  htp.tablerowclose;

 end if;


 htp.tableclose;
 htp.nl;
 htp.tableopen( cattributes=>'class="str1_table4"' );
 htp.tablerowopen;
 if vaccess = 'EDIT' and (id = 'z' or rid is null)
  then
   htp.tabledata( htf.formsubmit( 'ACTION', 'Insert' ),cattributes=>'VALIGN="TOP"');
 elsif vaccess = 'EDIT' and id <> 'z'
  then
   htp.tabledata( htf.formsubmit( 'ACTION', 'Update' ),cattributes=>'VALIGN="TOP"');
   htp.tabledata( htf.formsubmit( 'ACTION', 'Delete' ),cattributes=>'VALIGN="TOP"');
 elsif vaccess = 'READ' and id <> 'z' AND seclevel in ( 'LEVEL 6','LEVEL 7' )
  then
   htp.tabledata( htf.formsubmit( 'ACTION', 'Delete' ),cattributes=>'VALIGN="TOP"');
 end if;

 htp.formclose;
 if id <> 'z' -- vaccess = 'EDIT' and
  then
   htp.tabledata( htf.formopen( 'strangp.mng_ctr' ) || htf.formhidden( 'SURL', surl ) || htf.formhidden( 'ID', 'z' ) || htf.formhidden( 'RID', null ) || htf.formsubmit( null, 'Create New Record' ) || htf.formclose,cattributes=>'VALIGN="TOP"');
 end if;
 htp.tablerowclose;
 htp.tableclose;
 htp.formclose;
 htp.nl;
 if seclevel in ( 'LEVEL 1','LEVEL 8' )
  then
   null;
  else
   htp.anchor2( 'strangp.menu?surl=' || surl || '&mtype=CATEG&action=SEARCH&rid=&rnd=&msearch=', 'Categories', ctarget=>'POPUP');
   htp.p ('&nbsp;');
   htp.anchor2( 'strangp.menu?surl=' || surl || '&mtype=ONLOCS&action=SEARCH&rid=&rnd=&msearch=', 'Onhire Details', ctarget=>'POPUP');
   htp.p ('&nbsp;');
   htp.anchor2( 'strangp.menu?surl=' || surl || '&mtype=OFFLOCS&action=SEARCH&rid=&rnd=&msearch=', 'Offhire Details', ctarget=>'POPUP');
   htp.p ('&nbsp;');
   url := 'oltp.display_screen?surl=' || surl || '&sname=Container+Type&access_in=QUERY&rid=&rnd=';
   htp.anchor( 'javascript: window.open(''' || url || ''',''' || 'POPUP1' ||
               ''',''height=' || '400' ||
               ',width=' || '600' || ',scrollbars=yes,resizable=yes'');void('''');',
               'Container Types' );
   htp.p ('&nbsp;');

    url := 'oltp.display_screen?surl=' || surl || '&sname=Locations&access_in=QUERY&rid=&rnd=';
    htp.anchor( 'javascript: window.open(''' || url || ''',''' || 'POPUP2' ||
                ''',''height=' || '400' ||
               ',width=' || '600' || ',scrollbars=yes,resizable=yes'');void('''');',
                'Locations' );

   htp.p ('&nbsp;');

    url := 'oltp.display_screen?surl=' || surl || '&sname=Countries&access_in=QUERY&rid=&rnd=';
    htp.anchor( 'javascript: window.open(''' || url || ''',''' || 'POPUP3' ||
                ''',''height=' || '400' ||
                ',width=' || '600' || ',scrollbars=yes,resizable=yes'');void('''');',
                'Currencies' );

 end if;
 htp.nl;
 htp.nl;
 search( surl, 'CTR', rid );
 htp.nl;
 --if call_name is null then htp.bold( '<a href="" onClick="self.close()">' || LNG.GLB_TXT_033 || '</a>'); htp.nl; end if;
 if msg is not null
  then
   header_msg( msg );
 end if;
 htp.p( '</CENTER>' );
 htp.tableclose;
exception when others then
 error_details( 'STRANGP', 'MNG_CTR',null,null,errmsg=>sqlerrm,extdet=>'RID:' || rid);
end mng_ctr;

-- **********************************************************

procedure accept_mng_ctr( SURL IN VARCHAR2, RID IN VARCHAR2, ID in VARCHAR2, P1 IN VARCHAR2, P2 IN VARCHAR2, P3 IN VARCHAR2, P4 IN VARCHAR2, P5 IN VARCHAR2,
P6 IN VARCHAR2, P7 IN VARCHAR2 default null, P8 IN VARCHAR2, P9 IN VARCHAR2 default null, P10 IN VARCHAR2, P11 IN VARCHAR2, P12 IN VARCHAR2, ACTION IN VARCHAR2 )
as
cursor c1 ( cno varchar2 ) is select max(timeshired) mx from strang.containers where containerno = cno;
cursor c2 ( cno varchar2 , th number ) is select * from strang.containers where containerno = cno and timeshired = th;
cursor c3 ( rn number ) is select * from strang.categories where rno = rn ;
cursor c5 ( ct varchar2, ccode varchar2, ccomp varchar2, loc varchar2 ) is select * from strang.onlocs
  where
  cat_company = ccomp and
  cat_contract = ct and
  cat_code = ccode and
  loc_location = loc;
cursor c6 ( ct varchar2, ccode varchar2, ccomp varchar2, loc varchar2 ) is select * from strang.offlocs
  where
  cat_company = ccomp and
  cat_contract = ct and
  cat_code = ccode and
  loc_location = loc;
cursor c7 (rid rowid) is select * from strang.containers where rowid=rid;
cursor c8 (ctr varchar2) is select * from strang.containers where containerno = ctr and offdate is null;

c1rec c1%ROWTYPE;
c2rec c2%ROWTYPE;
c3rec c3%ROWTYPE;
c5rec c5%ROWTYPE;
c6rec c6%ROWTYPE;
c7rec c7%ROWTYPE;
c8rec c8%ROWTYPE;

dt1 date;
dt2 date;
oloc varchar2(4);
ovdt date;
floc varchar2(4);
fvdt date;
errmsg varchar2(1000);
newrid rowid;
fnd	boolean;
fndo	boolean;



 sts		varchar2(100);
 vaccess	varchar2(20);
 seclevel	varchar2(100);

begin
  if not dapi.init( surl, 'STRANGP.ACCEPT_MNG_CTR' , null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'ACCEPT_MNG_CTR'  );
    return;
  end if;

 vaccess := data_access( 'CONTAINERS' );
 seclevel := security_role( dapi.GLOBAL_ACCOUNT.acctid );

IF VACCESS = 'READ' THEN
  mng_ctr( surl, rid, 'x', 'CANNOT MODIFY' );

END IF;
if action = 'Delete' then
  confirm_ctr_delete( surl,rid );
  return;
end if;
/*
gl.dbg('P1:' ||P1);
gl.dbg('P2:' ||P2);
gl.dbg('P3:' ||P3);
gl.dbg('P4:' ||P4);
gl.dbg('P5:' ||P5);
gl.dbg('P6:' ||P6);
gl.dbg('P7:' ||P7);
gl.dbg('P8:' ||P8);
gl.dbg('P9:' ||P9);
gl.dbg('P10:' ||P10);
gl.dbg('P11:' ||P11);
gl.dbg('P12:' ||P12);
*/
if P1 is null then
  mng_ctr( surl, rid, ID, 'Must Enter A Container No' );
  return;
end if;
oloc := p8; --substr(P8,2,instr(P8,']')-2);
--ovdt:=substr(p8,instr(P8,']')+1);
floc := p9; --substr(P9,2,instr(P9,']')-2);
--fvdt:=substr(p9,instr(P9,']')+1);
begin
 if P6 is null and action <> 'Insert' then
  mng_ctr( surl, rid, ID, 'On hire Date cannot be blank' );
  return;
 end if;

 dt1:=to_date(P6,'DD-MON-YYYY');
 exception when others then
  mng_ctr( surl, rid, ID, 'Invalid On hire date ' || P6 );
  return;
end;
begin
 dt2:=to_date(P7,'DD-MON-YYYY');
 exception when others then
 errmsg := 'Invalid Off hire date ' || P7 ;
 dt2:= null;
end;

if action='Insert' then
  open c1( upper(P1) );
    fetch c1 into c1rec;
    c1rec.mx := nvl(c1rec.mx,0);
    if c1rec.mx = 0 then
      close c1;
      c1rec.mx:= 1;
    else
      close c1;
      open c2( P1 , c1rec.mx );
        fetch c2 into c2rec;
      close c2;
      if c2rec.offdate is null then
        mng_ctr( surl, rid, 'z', 'Container ' || P1 ||' Already On Hire' );
        return;
      end if;
      c1rec.mx:= c1rec.mx + 1;
    end if;
    open c3 ( P2 );
    fetch c3 into c3rec;
    close c3;

    open c5 ( c3rec.contract, c3rec.codedesc, c3rec.company, oloc);
    fetch c5 into c5rec;
    close c5;

    open c6 ( c3rec.contract, c3rec.codedesc, c3rec.company, floc);
    fetch c6 into c6rec;
    close c6;
--gl.dbg( 'c1:' || c5rec.cat_contract || '-' || c3rec.contract );
--gl.dbg( 'c1:' || c5rec.cat_code || '-' || c3rec.codedesc );
--gl.dbg( 'c1:' || c5rec.cat_company || '-' || c3rec.company );
--gl.dbg( 'c1:' || c5rec.cat_cdate || '-' || c3rec.cdate );

    if c5rec.cat_contract is null
      then
       oloc := 'XXXX';
       --ovdt := sysdate;
       if floc is not null then
         floc := 'XXXX';
       end if;
    end if;

    insert into strang.containers ( containerno,timeshired,datehired,backcharge,cat_code,
                                    ctrdesc,cat_company,cat_contract,ctpe_ctrtype,
                                    nloc_location,crelease,turnin,eir,
                                    offdate,floc_location ) values
                ( upper(P1),c1rec.mx,dt1,P5,c3rec.codedesc,
                  P4,c3rec.company,c3rec.contract,P3,
                  oloc,P10,P11,P12,
                  dt2,floc ) returning rowid into newrid;
     commit;
     mng_ctr( surl, newrid, 'x', nvl(errmsg,'Insert Successful'));
     return;
end if;

fnd := false;
fndo := false;
if action='Update' then
  open c7(rid);
  fetch c7 into c7rec;
  close c7;
  if (c7rec.datehired is null or
      c7rec.datehired <> dt1)
     or
     (c7rec.nloc_location is null or
      c7rec.nloc_location <> oloc)
   then
    fnd := TRUE;
  end if;

  c7rec.datehired := dt1;
  c7rec.offdate := dt2;
  c7rec.ctpe_ctrtype := P3;
  c7rec.ctrdesc := P4;
  c7rec.backcharge := P5;
  c7rec.crelease := P10;
  c7rec.turnin := P11;
  c7rec.eir := P12;
  if ((c7rec.offdate is null and dt2 is not null) or
      c7rec.offdate <> dt2)
     or
     ((c7rec.floc_location is null and floc is not null) or
      c7rec.floc_location <> floc)
   then
    fndo := TRUE;
  end if;
  c7rec.floc_location := floc;
  if c7rec.containerno <> upper(P1) then
    open c8( upper(P1) );
    fetch c8 into c8rec;
    if c8%FOUND then
      mng_ctr( surl, rid, 'x', 'Container ' || P1 ||' Already On Hire' );
      return;
    end if;
    c1rec.mx:= 0;
    open c1( P1 );
     fetch c1 into c1rec;
    close c1;
    c7rec.timeshired := nvl(c1rec.mx,0) + 1;
    c7rec.containerno := upper(P1);
  end if;
  open c3(P2);
  fetch c3 into c3rec;
  close c3;

  if (c7rec.nloc_location='XXXX') or (c7rec.nloc_location <> oloc) or (c7rec.nloc_location is null) then
-- gl.dbg( 'P2:'||c7rec.cat_contract);
-- gl.dbg( 'P2:'||c3rec.codedesc);
-- gl.dbg( 'P2:'||c3rec.company);
-- gl.dbg( 'P2:'||oloc);
-- gl.dbg( 'P2:'||ovdt);
-- gl.dbg( 'PX:'||p2);
-- gl.dbg( 'PN:'||c7rec.nloc_location);
    open c5 ( c7rec.cat_contract, c3rec.codedesc, c3rec.company, oloc);
    fetch c5 into c5rec;
    close c5;
    c7rec.nloc_location := c5rec.loc_location;
    --c7rec.nloc_cdate := c5rec.cdate;
  end if;
  if (c7rec.floc_location='XXXX') or  (c7rec.floc_location <> floc) or (c7rec.floc_location is null) then
    open c6 ( P2, c3rec.codedesc, c3rec.company , floc);
    fetch c6 into c6rec;
    close c6;
    c7rec.floc_location := c6rec.loc_location;
    --c7rec.floc_cdate := c6rec.cdate;
  end if;

  if not (c7rec.cat_contract = c3rec.contract and
     c7rec.cat_code=c3rec.codedesc and
     c7rec.cat_company=c3rec.company)
    then
     c7rec.nloc_location := 'XXXX';
     --c7rec.nloc_cdate := sysdate;
     if c7rec.floc_location is not null then
       c7rec.floc_location := 'XXXX';
     end if;
     --if c7rec.floc_location is not null then
     --  c7rec.floc_cdate := sysdate;
     --end if;
     c7rec.cat_contract := c3rec.contract;
     c7rec.cat_company := c3rec.company;
     c7rec.cat_code := c3rec.codedesc;
  end if;

--  gl.dbg(c7rec.datehired);
  update strang.containers set
   containerno = c7rec.containerno,
   timeshired = c7rec.timeshired,
   datehired = nvl(c7rec.datehired,datehired),
   backcharge = c7rec.backcharge,
   cat_code = c7rec.cat_code,
   ctrdesc = c7rec.ctrdesc,
   cat_company = c7rec.cat_company,
   cat_contract = c7rec.cat_contract,
   ctpe_ctrtype = c7rec.ctpe_ctrtype,
   nloc_location = c7rec.nloc_location,
   crelease = c7rec.crelease,
   turnin = c7rec.turnin,
   eir = c7rec.eir,
   offdate = c7rec.offdate,
   floc_location = c7rec.floc_location
  where rowid = rid;

  if fnd then
   generate_containers_onhire( c7rec );
  end if;

  if fndo then
   generate_containers_offhire( c7rec );
  end if;

end if;
commit;
mng_ctr( surl, nvl(newrid,rid), id, nvl(errmsg,'Update Successful'));

exception when others then
error_details( 'STRANGP', 'ACCEPT_MNG_CTR',null,null,errmsg=>sqlerrm,extdet=>'RID:' || rid);

end accept_mng_ctr;

-- **************************************************************************************

procedure confirm_ctr_delete(surl in varchar2, rid in varchar2)
as

 cursor c2( rid rowid ) is select * from strang.containers where rowid = rid;


 c2rec		c2%ROWTYPE;

 sts		varchar2(100);
 nrid		varchar2(100);
 vaccess	varchar2(20);

begin
  if not dapi.init( surl, 'STRANGP.CONFIRM_CTR_DELETE', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'CONFIRM_CTR_DELETE'  );
    return;
  end if;

 nrid := replace(rid,'~','+');
 vaccess := data_access( 'CONTAINERS' );
 open c2( nrid );
 fetch c2 into c2rec;
 close c2;

 main_title( 'Confirm Container Deletion',helpid=>'STR54');
 if vaccess = 'NONE' then htp.bold( 'Access Denied' ); htp.htmlclose; return; end if;
 htp.p( '<CENTER>' );
 htp.bold( c2rec.containerno );
  htp.nl;
 htp.formopen( 'strangp.accept_ctr_delete' );
  htp.formhidden( 'SURL', surl );
  htp.formhidden( 'RID', nrid );
  htp.nl;

  htp.formsubmit( 'ACTION', 'Do not Delete' );
  htp.formsubmit( 'ACTION', 'Delete this Record' );
 htp.formclose;
 htp.p( '</CENTER>' );
 htp.htmlclose;
exception when others then
 error_details( 'STRANGP', 'CONFIRM_MCTR_DELETE',null,null,errmsg=>sqlerrm);
end confirm_ctr_delete;

procedure accept_ctr_delete(surl in varchar2, rid in varchar2, action in varchar2 )
as


 sts		varchar2(100);
 nrid		varchar2(100);
 vaccess	varchar2(20);

begin
  if not dapi.init( surl, 'STRANGP.ACCEPT_CTR', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'ACCEPT_CTR' );
    return;
  end if;

 nrid := replace(rid,'~','+');
 vaccess := data_access(  'CONTAINERS' );

 if vaccess = 'EDIT'
  then

 if action = 'Do not Delete'
  then
  mng_ctr( surl, rid, 'x', 'Deletion Cancelled' );
  return;
 else
   delete from strang.containers where rowid = nrid;
   commit;
   strangp.menu(surl=>surl,rnd=>null,MTYPE=>'CTR');
 end if;

 end if;

exception when others then
 error_details( 'STRANGP', 'ACCEPT_CTR_DELETE',null,null,errmsg=>sqlerrm);
end accept_ctr_delete;

--******************************************************************************************
procedure mng_categories( surl in varchar2, rid in varchar2 default null, id in varchar2 default null, msg in varchar2 default null, call_name in varchar2 default null, parm in varchar2 default null )
as

 cursor c3( rid rowid ) is select * from strang.categories where rowid = rid;
 cursor c4( cont varchar2, comp varchar2, ccde varchar2 ) is select count('x') cnt from strang.onlocs
 where cat_contract = cont and
       cat_company  = comp and
       cat_code     = ccde;
 cursor c5( cont varchar2, comp varchar2, ccde varchar2 ) is select count('x') cnt from strang.offlocs
 where cat_contract = cont and
       cat_company  = comp and
       cat_code     = ccde;

 cursor c8 is select distinct cola from strang.lov where lov_name = 'COUNTRIES';


 c3rec		c3%ROWTYPE;
 c4rec		c4%ROWTYPE;
 c5rec		c5%ROWTYPE;

 sts		varchar2(100);
 vaccess	varchar2(20);

begin
  if not dapi.init( surl, 'STRANGP.MNG_CATEGORIES', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'MNG_CATEGORIES' );
    return;
  end if;

  vaccess := data_access( 'CONTAINERS' );

 main_title( 'CONTAINER HIRE MAINTENANCE',helpid=>'STR55');
 if vaccess = 'NONE' then htp.bold( 'Access Denied' ); htp.htmlclose; return; end if;
 htp.p( '<CENTER>' );
 if id <> 'z' and rid is not null
  then
   open c3(replace(rid,'~','+'));
   fetch c3 into c3rec;
   close c3;
 end if;

 htp.formopen( 'strangp.accept_mng_categories', ctarget=>'_top' );
 htp.formhidden( 'SURL', surl );
   htp.formhidden( 'RID', replace(rid,'~','+') );
   htp.formhidden( 'ID', id );
 htp.tableopen( cattributes=>'class="str1_table"' );


  htp.tablerowopen;
   htp.tabledata( htf.bold('Contract'),cattributes=>'class="str1_bg_left"');
   if vaccess = 'EDIT' and id = 'z'
    then
     htp.tabledata( htf.formtext('P1', 10, 10, c3rec.contract),cattributes=>'class="str1_cell_left" ');
    else
     htp.tabledata( htf.bold(nvl(c3rec.contract,'&nbsp;')),cattributes=>'class="str1_cell_left" ');
   end if;
  htp.tablerowclose;

  htp.tablerowopen;
   htp.tabledata( htf.bold('Code Description'),cattributes=>'class="str1_bg_left"');

 if vaccess = 'EDIT' and id = 'z'
    then
     htp.tabledata( htf.formtext('P2', 12, 12, c3rec.codedesc),cattributes=>'class="str1_cell_left"  ');
    else
     htp.tabledata( htf.bold(nvl(c3rec.codedesc,'&nbsp;')),cattributes=>'class="str1_cell_left"  ');
   end if;
  htp.tablerowclose;

  htp.tablerowopen;
   htp.tabledata( htf.bold('Company Name'),cattributes=>'class="str1_bg_left"');
     if vaccess = 'EDIT' and id = 'z'
    then
     htp.tabledata( htf.formtext('P3', 20, 20, c3rec.company),cattributes=>'class="str1_cell_left"  ');
     else
       htp.tabledata( htf.bold(nvl(c3rec.company,'&nbsp;')),cattributes=>'class="str1_cell_left" ');
     end if;

  htp.tablerowclose;

  /*
  htp.tablerowopen;
   htp.tabledata( htf.bold('Date Created'),cattributes=>'class="str1_bg_left"');
   if vaccess = 'EDIT' and id = 'z'
    then
     htp.tabledata( htf.formtext('P4', 15, 15, to_char(c3rec.cdate,'DD-MON-YYYY')),cattributes=>'class="str1_bg_left"');
    else
     htp.tabledata( htf.bold(nvl(to_char(c3rec.cdate,'DD-MON-YYYY'),'&nbsp;')),cattributes=>'class="str1_bg_left"');
   end if;
  htp.tablerowclose;
 */

  htp.tablerowopen;
   htp.tabledata( htf.bold('Category Description'),cattributes=>'class="str1_bg_left"');
   if vaccess = 'EDIT'
    then
     htp.tabledata( htf.formtext('P5', 15, 12, c3rec.catdesc),cattributes=>'class="str1_cell_left"  ');
    else
     htp.tabledata( htf.bold(nvl(c3rec.catdesc,'&nbsp;')),cattributes=>'class="str1_cell_left"  ');
   end if;
  htp.tablerowclose;


  htp.tablerowopen;
   htp.tabledata( htf.bold('Leasing/Day'),cattributes=>'class="str1_bg_left"');
     if  vaccess = 'EDIT'
      then
       htp.tabledata( htf.formtext( 'P6', 12, 20, trim(to_char(round(c3rec.leasecost,2),G_MONEY_FORMAT))),cattributes=>'class="str1_cell_right"');
      else
       htp.tabledata( to_char(round(c3rec.leasecost,2),G_MONEY_FORMAT),cattributes=>'class="str1_cell_right"');
     end if;
  htp.tablerowclose;


  htp.tablerowopen;
   htp.tabledata( htf.bold('Company Leasing/Day'),cattributes=>'class="str1_bg_left"');
     if  vaccess = 'EDIT'
      then
       htp.tabledata( htf.formtext( 'P7', 12, 20, trim(to_char(round(c3rec.compcost,2),G_MONEY_FORMAT))),cattributes=>'class="str1_cell_right"');
      else
       htp.tabledata( to_char(round(c3rec.compcost,2),G_MONEY_FORMAT),cattributes=>'class="str1_cell_right"');
     end if;
  htp.tablerowclose;


   htp.tabledata( htf.bold('Currency'),cattributes=>'class="str1_bg_left"');
     if vaccess = 'EDIT'
      then
        htp.p( '<TD '|| 'class="str1_cell_left" >' );
          htp.formselectopen( 'P8' );
              for c8rec in c8

              loop
                if c8rec.cola=nvl(c3rec.curr_code,'USD') then
                  htp.formselectoption( c8rec.cola, 'SELECTED', cattributes=>'VALUE="'||c8rec.cola ||'"');
                else
                  htp.formselectoption( c8rec.cola, cattributes=>'VALUE="'||c8rec.cola ||'"');
               end if;
              end loop;

          htp.formselectclose;
        htp.p( '</TD>');
      else
       htp.tabledata( htf.bold(nvl(c3rec.curr_code,'&nbsp;')),cattributes=>'class="str1_cell_left" ');
     end if;


 htp.tableclose;
 htp.nl;
 htp.tableopen( cattributes=>'class="str1_table4"' );
 htp.tablerowopen;
 if vaccess = 'EDIT' and (id = 'z' or rid is null)
  then
   htp.tabledata( htf.formsubmit( 'ACTION', 'Insert' ),cattributes=>'VALIGN="TOP"');
 elsif vaccess = 'EDIT' and id <> 'z'
  then
   htp.tabledata( htf.formsubmit( 'ACTION', 'Update' ),cattributes=>'VALIGN="TOP"');
   open c4(c3rec.contract,c3rec.company,c3rec.codedesc);
   fetch c4 into c4rec;
   close c4;
   open c5(c3rec.contract,c3rec.company,c3rec.codedesc);
   fetch c5 into c5rec;
   close c5;
   if (c4rec.cnt + c5rec.cnt = 0) then
      htp.tabledata( htf.formsubmit( 'ACTION', 'Delete' ),cattributes=>'VALIGN="TOP"');
   end if;
 end if;
 htp.formclose;


 if vaccess = 'EDIT' and id <> 'z'
  then
   htp.tabledata( htf.formopen( 'strangp.mng_categories' ) || htf.formhidden( 'SURL', surl ) || htf.formhidden( 'ID', 'z' ) || htf.formhidden( 'RID', null ) || htf.formsubmit( null, 'Create New Record' ) || htf.formclose,cattributes=>'VALIGN="TOP"');
 end if;
 htp.tablerowclose;
 htp.tableclose;
 htp.formclose;
 htp.nl;
 search( surl, 'CATEG', rid );
 htp.nl;
 htp.bold( '<a href="" onClick="self.close()">' || LNG.GLB_TXT_033 || '</a>'); htp.nl;
 if msg is not null
  then
   header_msg( msg );
 end if;
 htp.p( '</CENTER>' );
 htp.tableclose;
exception when others then
 error_details( 'STRANGP', 'MNG_CATEGORIES',null,null,errmsg=>sqlerrm,extdet=>'RID:' || rid);
end mng_categories;

-- **********************************************************

-- **********************************************************

procedure accept_mng_categories( SURL IN VARCHAR2, RID IN VARCHAR2, ID in VARCHAR2, P1 IN VARCHAR2 default null, P2 IN VARCHAR2 default null, P3 IN VARCHAR2 default null, P4 IN VARCHAR2 default null, P5 IN VARCHAR2,
P6 IN VARCHAR2, P7 IN VARCHAR2, P8 IN VARCHAR2, ACTION IN VARCHAR2 )
as

cursor c2 is select max(rno) mx from strang.categories;
cursor c3 ( cont varchar2, cod varchar2, cname varchar2) is select * from strang.categories
where contract=UPPER(cont) and
 codedesc= UPPER(cod) and
 company = UPPER(cname);
cursor c7 (rid rowid) is select * from strang.categories where rowid=rid;
cursor c8 (ctr varchar2) is select * from strang.containers where containerno = ctr and offdate is null;

c2rec c2%ROWTYPE;
c3rec c3%ROWTYPE;
c7rec c7%ROWTYPE;
c8rec c8%ROWTYPE;

dt1 date;
errmsg varchar2(1000);
newrid rowid;
nmb1 number;
nmb2 number;

begin

if ((P1 is null) or (P2 is null) or (P3 is null) or (P5 is null) or (P6 is null) or (P7 is null) or (P8 is null)) and id='z'  then
  mng_categories( surl, rid, null, 'No Fields Can Be Left Blank' );
  return;
end if;
if ((P5 is null) or (P6 is null) or (P7 is null) or (P8 is null)) and id='x'  then
  mng_categories( surl, rid, null, 'No Fields Can Be Left Blank' );
  return;
end if;

begin nmb1 := to_number( p6 ); exception when others then begin nmb1 := to_number( p6,G_MONEY_FORMAT ); exception when others then nmb1 := 0; end; end;
begin nmb2 := to_number( p7 ); exception when others then begin nmb2 := to_number( p7,G_MONEY_FORMAT ); exception when others then nmb2 := 0; end; end;

if action='Insert' then
    open c3 ( P1,P2,P3 );
    fetch c3 into c3rec;
    close c3;
    open c2;
    fetch c2 into c2rec;
    close c2;
    c2rec.mx := nvl(c2rec.mx,0) + 1;
    insert into strang.categories ( contract,codedesc,company,catdesc,leasecost,compcost,curr_code,rno )
    values ( upper(P1),upper(P2),P3,upper(P5),nmb1,nmb2,P8,c2rec.mx ) returning rowid into newrid;
    mng_categories( surl, newrid, 'x' , 'Insert Successful');
    commit;
    return;
end if;

if action='Update' then
    update strang.categories set
    catdesc = UPPER(P5),
    leasecost = nmb1,
    compcost  = nmb2,
    curr_code = P8
  where rowid = rid;
commit;
mng_categories( surl, rid, 'x', 'Update Successful');
end if;

if action='Delete' then
  delete from strang.categories
  where rowid = rid;
  commit;
  mng_categories( surl, rid, 'x', 'Delete Successful');
  menu (surl=>surl,mtype=>'CATEG',action=>'SEARCH',rid=>null,rnd=>null,msearch=>null);
end if;



exception when others then
error_details( 'STRANGP', 'ACCEPT_MNG_categories',null,null,errmsg=>sqlerrm,extdet=>'RID:' || rid);

end accept_mng_categories;



--****************************************************************************************
--&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
--******************************************************************************************
procedure mng_onlocs( surl in varchar2, id in varchar2 )
as
 arr_rid src_rid;
begin
 for j in 1..10 loop
  arr_rid(j) := null;
 end loop;
 mng_onlocs(surl, arr_rid, id );
end mng_onlocs;

procedure mng_onlocs( surl in varchar2, arr_rid in src_rid, id in varchar2 default null, msg in varchar2 default null, call_name in varchar2 default null, parm in varchar2 default null )
as

 cursor c3( rid rowid ) is select * from strang.onlocs where rowid = rid;

 cursor c4( cont varchar2, comp varchar2, ccde varchar2 ) is select count('x') cnt from strang.containers
 where cat_contract = cont and
       cat_company  = comp and
       cat_code     = ccde;
 cursor c7 is select * from strang.categories order by contract,company,codedesc;
 cursor c8 is select code from strang.lov where lov_name = 'COUNTRIES' order by code;
 cursor c9(c1 varchar2, c2 varchar2, c3 varchar2, c4 varchar2 ) is select 'x' exst from strang.containers where cat_contract = c1 and cat_code = c2 and cat_company = c3 and nloc_location = c4;


 c3rec		c3%ROWTYPE;
 c4rec		c4%ROWTYPE;
 c9rec		c9%ROWTYPE;

 sts		varchar2(100);
 vaccess	varchar2(20);
 frid		rowid;
 rid		rowid;

begin
  if not dapi.init( surl, 'STRANGP.MNG_ONLOCS', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'MNG_ONLOCS' );
    return;
  end if;

  vaccess := data_access( 'CONTAINERS' );

 main_title( 'CONTAINER HIRE MAINTENANCE',helpid=>'STR56');
 if vaccess = 'NONE' then htp.bold( 'Access Denied' ); htp.htmlclose; return; end if;
 htp.p( '<CENTER>' );

 htp.formopen( 'strangp.accept_mng_onlocs', ctarget=>'_top' );
 htp.formhidden( 'SURL', surl );
   --htp.formhidden( 'RID', replace(rid,'~','+') );
   htp.formhidden( 'ID', id );
   htp.formhidden( 'P2', null ); -- was cdate
 htp.tableopen( cattributes=>'class="str1_table"' );

 htp.tablerowopen;
   htp.tabledata( htf.bold('Company<BR>Name'),cattributes=>'class="str1_bg_left"');
  htp.tabledata( htf.bold('Category<BR>Selection'),cattributes=>'class="str1_bg_left"');
   htp.tabledata( htf.bold('Contract'),cattributes=>'class="str1_bg_left"');
   htp.tabledata( htf.bold('Code'),cattributes=>'class="str1_bg_left"');
   htp.tabledata( htf.bold('Location'),cattributes=>'class="str1_bg_left"');
   htp.tabledata( htf.bold('Charge'),cattributes=>'class="str1_bg_left"');
   htp.tabledata( htf.bold('Handling'),cattributes=>'class="str1_bg_left"');
   htp.tabledata( htf.bold('D/I'),cattributes=>'class="str1_bg_left"');
   htp.tabledata( htf.bold('Company<BR>Charge'),cattributes=>'class="str1_bg_left"');
   htp.tabledata( htf.bold('Company<BR>Handling'),cattributes=>'class="str1_bg_left"');
   htp.tabledata( htf.bold('Company<BR>D/I'),cattributes=>'class="str1_bg_left"');
 htp.tablerowclose;

 for j in arr_rid.first..arr_rid.last loop

 if j = arr_rid.first then frid := arr_rid(j); end if;
 rid := arr_rid(j);
 if id <> 'z' and rid is not null
  then
   open c3(replace(rid,'~','+'));
   fetch c3 into c3rec;
   close c3;
 elsif id <> 'z' and vaccess = 'EDIT' and rid is null then rid := null; exit;
 end if;

 htp.tablerowopen;
  if vaccess = 'EDIT' and id = 'z'
      then
        htp.p( '<TD '|| 'class="str1_cell_left" COLSPAN="4"  >' );
        htp.formhidden( 'ARR_RID', null );
          htp.formselectopen( 'P1' );
              for c7rec in c7
              loop
                if c7rec.contract=c3rec.cat_contract then
                  htp.formselectoption( ' --- '|| c7rec.contract || ' --- '|| c7rec.codedesc || ' --- '|| c7rec.company, 'SELECTED', cattributes=>'VALUE="'||c7rec.rno ||'"');
                else
                  htp.formselectoption( ' --- '|| c7rec.contract || ' --- '|| c7rec.codedesc || ' --- '|| c7rec.company, cattributes=>'VALUE="'||c7rec.rno ||'"');
               end if;
              end loop;

          htp.formselectclose;
        htp.p( '</TD>');
      else
       open c9(c3rec.cat_contract, c3rec.cat_code, c3rec.cat_company, c3rec.loc_location );
       fetch c9 into c9rec;
       if c9%notfound
        then
         htp.tabledata( htf.formhidden( 'ARR_RID', rid ) ||
                        htf.formhidden( 'P1', null ) ||
                        htf.formhidden( 'P3', null ) ||
                        htf.anchor( 'strangp.onlocs_del?surl=' || surl || '&rid=' || replace(rowidtochar(rid),'+','~'), 'Delete' ), cattributes=>'class="str1_cell_left" ');
        else
         htp.tabledata( htf.formhidden( 'ARR_RID', rid ) || htf.formhidden( 'P1', null ) || htf.formhidden( 'P3', null ) || '&nbsp;',cattributes=>'class="str1_bg_left"');
       end if;
       close c9;
       htp.tabledata( htf.bold(nvl(c3rec.cat_contract,'&nbsp;')),cattributes=>'class="str1_bg_left"');
       htp.tabledata( htf.bold(nvl(c3rec.cat_code,'&nbsp;')),cattributes=>'class="str1_bg_left"');
       htp.tabledata( htf.bold(nvl(c3rec.cat_company,'&nbsp;')),cattributes=>'class="str1_bg_left"');
   end if;

   if vaccess = 'EDIT' and id = 'z'
      then
        htp.p( '<TD '|| 'class="str1_cell_left" >' );
          htp.formselectopen( 'P3' );
              for c8rec in c8 loop
                if c8rec.code=c3rec.loc_location then
                  htp.formselectoption( c8rec.code, 'SELECTED', cattributes=>'VALUE="'||c8rec.code ||'"');
                else
                  htp.formselectoption( c8rec.code, cattributes=>'VALUE="'||c8rec.code ||'"');
               end if;
              end loop;

          htp.formselectclose;
        htp.p( '</TD>');
      else
       htp.tabledata( htf.bold(nvl(c3rec.loc_location,'&nbsp;')),cattributes=>'class="str1_cell_left" ');
     end if;

    if  vaccess = 'EDIT'
     then
       htp.tabledata( htf.formtext( 'P4', 12, 20, trim(to_char(round(c3rec.oncharge,2),G_MONEY_FORMAT))),cattributes=>'class="str1_cell_right"');
      else
       htp.tabledata( to_char(round(c3rec.oncharge,2),G_MONEY_FORMAT),cattributes=>'class="str1_cell_right"');
     end if;
     if  vaccess = 'EDIT'
      then
       htp.tabledata( htf.formtext( 'P5', 12, 20, trim(to_char(round(c3rec.onhandle,2),G_MONEY_FORMAT))),cattributes=>'class="str1_cell_right"');
      else
       htp.tabledata( to_char(round(c3rec.onhandle,2),G_MONEY_FORMAT),cattributes=>'class="str1_cell_right"');
     end if;
     if  vaccess = 'EDIT'
      then
       htp.tabledata( htf.formtext( 'P6', 12, 20, trim(to_char(round(c3rec.intchange,2),G_MONEY_FORMAT))),cattributes=>'class="str1_cell_right"');
      else
       htp.tabledata( to_char(round(c3rec.intchange,2),G_MONEY_FORMAT),cattributes=>'class="str1_cell_right"');
     end if;
     if  vaccess = 'EDIT'
      then
       htp.tabledata( htf.formtext( 'P7', 12, 20, trim(to_char(round(c3rec.concharge,2),G_MONEY_FORMAT))),cattributes=>'class="str1_cell_right"');
      else
       htp.tabledata( to_char(round(c3rec.concharge,2),G_MONEY_FORMAT),cattributes=>'class="str1_cell_right"');
     end if;
     if  vaccess = 'EDIT'
      then
       htp.tabledata( htf.formtext( 'P8', 12, 20, trim(to_char(round(c3rec.conhandle,2),G_MONEY_FORMAT))),cattributes=>'class="str1_cell_right"');
      else
       htp.tabledata( to_char(round(c3rec.conhandle,2),G_MONEY_FORMAT),cattributes=>'class="str1_cell_right"');
     end if;
     if  vaccess = 'EDIT'
      then
       htp.tabledata( htf.formtext( 'P9', 12, 20, trim(to_char(round(c3rec.cintchange,2),G_MONEY_FORMAT))),cattributes=>'class="str1_cell_right"');
      else
       htp.tabledata( to_char(round(c3rec.cintchange,2),G_MONEY_FORMAT),cattributes=>'class="str1_cell_right"');
     end if;

  htp.tablerowclose;
 end loop;

 htp.tableclose;
 htp.nl;
 htp.tableopen( cattributes=>'class="str1_table4"' );
 htp.tablerowopen;
 if vaccess = 'EDIT' and (id = 'z' or frid is null)
  then
   htp.tabledata( htf.formsubmit( 'ACTION', 'Insert' ),cattributes=>'VALIGN="TOP"');
 elsif vaccess = 'EDIT' and id <> 'z'
  then
   htp.tabledata( htf.formsubmit( 'ACTION', 'Update' ),cattributes=>'VALIGN="TOP"');
 end if;
 htp.formclose;


 if vaccess = 'EDIT' and id <> 'z'
  then
   htp.tabledata( htf.formopen( 'strangp.mng_onlocs' ) || htf.formhidden( 'SURL', surl ) ||
                  htf.formhidden( 'ID', 'z' ) ||
                  htf.formsubmit( null, 'Create New Record' ) || htf.formclose,cattributes=>'VALIGN="TOP"');
 end if;
 htp.tabledata( '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;' );
 htp.tabledata( 'NB. Search Order: Contract Company Code. % can be used as wildcard.' );
 htp.tablerowclose;
 htp.tableclose;
 htp.formclose;
 htp.nl;
 search( surl, 'ONLOCS', frid, lmnu=>rid );
 htp.nl;
 htp.bold( '<a href="" onClick="self.close()">' || LNG.GLB_TXT_033 || '</a>'); htp.nl;
 if msg is not null
  then
   header_msg( msg );
 end if;
 htp.p( '</CENTER>' );
 htp.tableclose;
exception when others then
 error_details( 'STRANGP', 'MNG_onlocs',null,null,errmsg=>sqlerrm,extdet=>'RID:' || rid);
end mng_onlocs;

-- **********************************************************

-- **********************************************************
--****************************************************************************************

procedure onlocs_del( surl in varchar2, rid in varchar2 )
as
 vrid	rowid;
begin
 vrid := chartorowid(replace(rid,'~','+'));
 delete from strang.onlocs where rowid = vrid;
 commit;
 menu (surl=>surl,mtype=>'ONLOCS',action=>'SEARCH',rid=>null,rnd=>null,msearch=>null);
end onlocs_del;

procedure accept_mng_onlocs( surl in varchar2, arr_rid in owa.vc_arr, id in varchar2, p1 in owa.vc_arr, p2 in owa.vc_arr, p3 in owa.vc_arr, p4 in owa.vc_arr, p5 in owa.vc_arr, p6 in owa.vc_arr, p7 in owa.vc_arr, p8 in owa.vc_arr, p9 in owa.vc_arr, action in varchar2 )
as

cursor c2 is select max(rno) mx from strang.onlocs;

cursor c3 ( vrno integer ) is select * from strang.categories where rno = vrno ;
cursor c7 (rid rowid) is select * from strang.onlocs where rowid=rid;
cursor c8 (ctr varchar2) is select * from strang.containers where containerno = ctr and offdate is null;

c2rec 	c2%ROWTYPE;
c3rec 	c3%ROWTYPE;
c7rec 	c7%ROWTYPE;
c8rec 	c8%ROWTYPE;

dt1 	date;
errmsg 	varchar2(1000);
newrid 	rowid;
nmb1 	number(6,2);
nmb2 	number(6,2);
nmb3 	number(6,2);
nmb4 	number(6,2);
nmb5 	number(6,2);
nmb6 	number(6,2);
rid  	rowid;
narr_rid src_rid;
ctr	integer;

begin
ctr := 0;
for j in 1..10 loop
  narr_rid(j) := null;
end loop;
for j in arr_rid.first..arr_rid.last loop

 if ( ((P1(j) is null) or (P3(j) is null) or (P4(j) is null) or (P5(j) is null) or (P6(j) is null) or (P7(j) is null) or (P8(j) is null) or (P9(j) is null)) and id = 'z' ) or
    ( ((P4(j) is null) or (P5(j) is null) or (P6(j) is null) or (P7(j) is null) or (P8(j) is null) or (P9(j) is null)) and id = 'x' )
  then
   null;
  else

  begin nmb1 := to_number( p4(j) ); exception when others then begin nmb1 := to_number( p4(j),G_MONEY_FORMAT ); exception when others then nmb1 := 0; end; end;
  begin nmb2 := to_number( p5(j) ); exception when others then begin nmb2 := to_number( p5(j),G_MONEY_FORMAT ); exception when others then nmb2 := 0; end; end;
  begin nmb3 := to_number( p6(j) ); exception when others then begin nmb3 := to_number( p6(j),G_MONEY_FORMAT ); exception when others then nmb3 := 0; end; end;
  begin nmb4 := to_number( p7(j) ); exception when others then begin nmb4 := to_number( p7(j),G_MONEY_FORMAT ); exception when others then nmb4 := 0; end; end;
  begin nmb5 := to_number( p8(j) ); exception when others then begin nmb5 := to_number( p8(j),G_MONEY_FORMAT ); exception when others then nmb5 := 0; end; end;
  begin nmb6 := to_number( p9(j) ); exception when others then begin nmb6 := to_number( p9(j),G_MONEY_FORMAT ); exception when others then nmb6 := 0; end; end;

  if action = 'Insert' then
      open c3 ( P1(j) );
      fetch c3 into c3rec;
      close c3;
      open c2;
      fetch c2 into c2rec;
      close c2;
      c2rec.mx := nvl(c2rec.mx,0) + 1;

      begin
       insert into strang.onlocs (loc_location,cat_company,cat_contract,cat_code,oncharge,onhandle,intchange,concharge,conhandle,cintchange,rno )
         values ( P3(j), c3rec.company,c3rec.contract,c3rec.codedesc,nmb1,nmb2,nmb3,nmb4,nmb5,nmb6,c2rec.mx )
		returning rowid into newrid;
      exception
       when others then
        mng_onlocs( surl, narr_rid, 'z', 'Insert Failed:' || sqlerrm);
        return;
      end;

      ctr := ctr + 1;
      narr_rid(ctr) := newrid;
      commit;
  end if;

 if action='Update' then
     rid := chartorowid(arr_rid(j));
     update strang.onlocs set
     oncharge = nmb1,
     onhandle = nmb2,
     intchange = nmb3,
     concharge = nmb4,
     conhandle = nmb5,
     cintchange =nmb6
     where rowid = rid;
     commit;
 end if;

end if;

end loop;

if action = 'Insert' and ctr > 0
 then
   mng_onlocs( surl, narr_rid, 'x', 'Insert Successful');

elsif action = 'Insert' and ctr = 0
 then
   mng_onlocs( surl, narr_rid, 'z', 'Nothing to Insert');

elsif action = 'Update'
 then
   for j in arr_rid.first..arr_rid.last loop
    narr_rid(j) := chartorowid(arr_rid(j));
   end loop;
   mng_onlocs( surl, narr_rid, 'x', 'Update Successful');
end if;

exception when others then
 error_details( 'STRANGP', 'ACCEPT_MNG_onlocs',null,null,errmsg=>sqlerrm);
end accept_mng_onlocs;



--((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((
--****************************************************************************************
--&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
--******************************************************************************************
procedure mng_offlocs( surl in varchar2, id in varchar2 )
as
 arr_rid src_rid;
begin
 for j in 1..10 loop
  arr_rid(j) := null;
 end loop;
 mng_offlocs(surl, arr_rid, id );
end mng_offlocs;

procedure mng_offlocs( surl in varchar2, arr_rid in src_rid, id in varchar2 default null, msg in varchar2 default null, call_name in varchar2 default null, parm in varchar2 default null )
as

 cursor c3( rid rowid ) is select * from strang.offlocs where rowid = rid;

 cursor c4( cont varchar2, comp varchar2, ccde varchar2 ) is select count('x') cnt from strang.containers
 where cat_contract = cont and
       cat_company  = comp and
       cat_code     = ccde;
 cursor c7 is select * from strang.categories order by contract,company,codedesc;
 cursor c8 is select code from strang.lov where lov_name = 'COUNTRIES' order by code;
 cursor c9(c1 varchar2, c2 varchar2, c3 varchar2, c4 varchar2 ) is select 'x' exst from strang.containers where cat_contract = c1 and cat_code = c2 and cat_company = c3 and floc_location = c4;


 c3rec		c3%ROWTYPE;
 c4rec		c4%ROWTYPE;
 c9rec		c9%ROWTYPE;

 sts		varchar2(100);
 vaccess	varchar2(20);
 frid		rowid;
 rid		rowid;

begin
  if not dapi.init( surl, 'STRANGP.MNG_OFFLOCS', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'MNG_OFFLOCS' );
    return;
  end if;

  vaccess := data_access( 'CONTAINERS' );

 main_title( 'CONTAINER HIRE MAINTENANCE',helpid=>'STR57');
 if vaccess = 'NONE' then htp.bold( 'Access Denied' ); htp.htmlclose; return; end if;
 htp.p( '<CENTER>' );

 htp.formopen( 'strangp.accept_mng_offlocs', ctarget=>'_top' );
 htp.formhidden( 'SURL', surl );
   --htp.formhidden( 'RID', replace(rid,'~','+') );
   htp.formhidden( 'ID', id );
   htp.formhidden( 'P2', null ); -- was cdate
 htp.tableopen( cattributes=>'class="str1_table"' );

 htp.tablerowopen;
  htp.tabledata( htf.bold('Category<BR>Selection'),cattributes=>'class="str1_bg_left"');
   htp.tabledata( htf.bold('Contract'),cattributes=>'class="str1_bg_left"');
   htp.tabledata( htf.bold('Code'),cattributes=>'class="str1_bg_left"');
   htp.tabledata( htf.bold('Company<BR>Name'),cattributes=>'class="str1_bg_left"');
   htp.tabledata( htf.bold('Location'),cattributes=>'class="str1_bg_left"');
   htp.tabledata( htf.bold('Charge'),cattributes=>'class="str1_bg_left"');
   htp.tabledata( htf.bold('Handling'),cattributes=>'class="str1_bg_left"');
   htp.tabledata( htf.bold('D/I'),cattributes=>'class="str1_bg_left"');
   htp.tabledata( htf.bold('Company<BR>Charge'),cattributes=>'class="str1_bg_left"');
   htp.tabledata( htf.bold('Company<BR>Handling'),cattributes=>'class="str1_bg_left"');
 for j in arr_rid.first..arr_rid.last loop
   htp.tabledata( htf.bold('Company<BR>D/I'),cattributes=>'class="str1_bg_left"');
 htp.tablerowclose;


 if j = arr_rid.first then frid := arr_rid(j); end if;
 rid := arr_rid(j);
 if id <> 'z' and rid is not null
  then
   open c3(replace(rid,'~','+'));
   fetch c3 into c3rec;
   close c3;
 elsif id <> 'z' and vaccess = 'EDIT' and rid is null then rid := null; exit;
 end if;

 htp.tablerowopen;
  if vaccess = 'EDIT' and id = 'z'
      then
        htp.p( '<TD '|| 'class="str1_cell_left" COLSPAN="4"  >' );
        htp.formhidden( 'ARR_RID', null );
          htp.formselectopen( 'P1' );
              for c7rec in c7
              loop
                if c7rec.contract=c3rec.cat_contract then
                  htp.formselectoption( ' --- '|| c7rec.contract || ' --- '|| c7rec.codedesc || ' --- '|| c7rec.company, 'SELECTED', cattributes=>'VALUE="'||c7rec.rno ||'"');
                else
                  htp.formselectoption( ' --- '|| c7rec.contract || ' --- '|| c7rec.codedesc || ' --- '|| c7rec.company, cattributes=>'VALUE="'||c7rec.rno ||'"');
               end if;
              end loop;

          htp.formselectclose;
        htp.p( '</TD>');
      else
       open c9(c3rec.cat_contract, c3rec.cat_code, c3rec.cat_company, c3rec.loc_location );
       fetch c9 into c9rec;
       if c9%notfound
        then
         htp.tabledata( htf.formhidden( 'ARR_RID', rid ) ||
                        htf.formhidden( 'P1', null ) ||
                        htf.formhidden( 'P3', null ) ||
                        htf.anchor( 'strangp.offlocs_del?surl=' || surl || '&rid=' || replace(rowidtochar(rid),'+','~'), 'Delete' ), cattributes=>'class="str1_cell_left" ');
        else
         htp.tabledata( htf.formhidden( 'ARR_RID', rid ) || htf.formhidden( 'P1', null ) || htf.formhidden( 'P3', null ) || '&nbsp;',cattributes=>'class="str1_bg_left"');
       end if;
       close c9;
       htp.tabledata( htf.bold(nvl(c3rec.cat_contract,'&nbsp')),cattributes=>'class="str1_bg_left"');
       htp.tabledata( htf.bold(nvl(c3rec.cat_code,'&nbsp')),cattributes=>'class="str1_bg_left"');
       htp.tabledata( htf.bold(nvl(c3rec.cat_company,'&nbsp')),cattributes=>'class="str1_bg_left"');
   end if;

   if vaccess = 'EDIT' and id = 'z'
      then
        htp.p( '<TD '|| 'class="str1_cell_left" >' );
          htp.formselectopen( 'P3' );
              for c8rec in c8 loop
                if c8rec.code=c3rec.loc_location then
                  htp.formselectoption( c8rec.code, 'SELECTED', cattributes=>'VALUE="'||c8rec.code ||'"');
                else
                  htp.formselectoption( c8rec.code, cattributes=>'VALUE="'||c8rec.code ||'"');
               end if;
              end loop;

          htp.formselectclose;
        htp.p( '</TD>');
      else
       htp.tabledata( htf.bold(nvl(c3rec.loc_location,'&nbsp;')),cattributes=>'class="str1_cell_left" ');
     end if;

    if  vaccess = 'EDIT'
     then
       htp.tabledata( htf.formtext( 'P4', 12, 20, trim(to_char(round(c3rec.offcharge,2),G_MONEY_FORMAT))),cattributes=>'class="str1_cell_right"');
      else
       htp.tabledata( to_char(round(c3rec.offcharge,2),G_MONEY_FORMAT),cattributes=>'class="str1_cell_right"');
     end if;
     if  vaccess = 'EDIT'
      then
       htp.tabledata( htf.formtext( 'P5', 12, 20, trim(to_char(round(c3rec.offhandle,2),G_MONEY_FORMAT))),cattributes=>'class="str1_cell_right"');
      else
       htp.tabledata( to_char(round(c3rec.offhandle,2),G_MONEY_FORMAT),cattributes=>'class="str1_cell_right"');
     end if;
     if  vaccess = 'EDIT'
      then
       htp.tabledata( htf.formtext( 'P6', 12, 20, trim(to_char(round(c3rec.intchange,2),G_MONEY_FORMAT))),cattributes=>'class="str1_cell_right"');
      else
       htp.tabledata( to_char(round(c3rec.intchange,2),G_MONEY_FORMAT),cattributes=>'class="str1_cell_right"');
     end if;
     if  vaccess = 'EDIT'
      then
       htp.tabledata( htf.formtext( 'P7', 12, 20, trim(to_char(round(c3rec.coffcharge,2),G_MONEY_FORMAT))),cattributes=>'class="str1_cell_right"');
      else
       htp.tabledata( to_char(round(c3rec.coffcharge,2),G_MONEY_FORMAT),cattributes=>'class="str1_cell_right"');
     end if;
     if  vaccess = 'EDIT'
      then
       htp.tabledata( htf.formtext( 'P8', 12, 20, trim(to_char(round(c3rec.coffhandle,2),G_MONEY_FORMAT))),cattributes=>'class="str1_cell_right"');
      else
       htp.tabledata( to_char(round(c3rec.coffhandle,2),G_MONEY_FORMAT),cattributes=>'class="str1_cell_right"');
     end if;
     if  vaccess = 'EDIT'
      then
       htp.tabledata( htf.formtext( 'P9', 12, 20, trim(to_char(round(c3rec.cintchange,2),G_MONEY_FORMAT))),cattributes=>'class="str1_cell_right"');
      else
       htp.tabledata( to_char(round(c3rec.cintchange,2),G_MONEY_FORMAT),cattributes=>'class="str1_cell_right"');
     end if;

  htp.tablerowclose;
 end loop;

 htp.tableclose;
 htp.nl;
 htp.tableopen( cattributes=>'class="str1_table4"' );
 htp.tablerowopen;
 if vaccess = 'EDIT' and (id = 'z' or frid is null)
  then
   htp.tabledata( htf.formsubmit( 'ACTION', 'Insert' ),cattributes=>'VALIGN="TOP"');
 elsif vaccess = 'EDIT' and id <> 'z'
  then
   htp.tabledata( htf.formsubmit( 'ACTION', 'Update' ),cattributes=>'VALIGN="TOP"');
 end if;
 htp.formclose;

 if vaccess = 'EDIT' and id <> 'z'
  then
   htp.tabledata( htf.formopen( 'strangp.mng_offlocs' ) || htf.formhidden( 'SURL', surl ) ||
                  htf.formhidden( 'ID', 'z' ) ||
                  htf.formsubmit( null, 'Create New Record' ) || htf.formclose,cattributes=>'VALIGN="TOP"');
 end if;
 htp.tabledata( '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;' );
 htp.tabledata( 'NB. Search Order: Contract Company Code. % can be used as wildcard.' );
 htp.tablerowclose;
 htp.tableclose;
 htp.formclose;
 htp.nl;
 search( surl, 'OFFLOCS', frid, lmnu=>rid );
 htp.nl;
 htp.bold( '<a href="" onClick="self.close()">' || LNG.GLB_TXT_033 || '</a>'); htp.nl;
 if msg is not null
  then
   header_msg( msg );
 end if;
 htp.p( '</CENTER>' );
 htp.tableclose;
exception when others then
 error_details( 'STRANGP', 'MNG_OFFLOCS',null,null,errmsg=>sqlerrm,extdet=>'RID:' || rid);
end mng_offlocs;

procedure offlocs_del( surl in varchar2, rid in varchar2 )
as
 vrid	rowid;
begin
 vrid := chartorowid(replace(rid,'~','+'));
 delete from strang.offlocs where rowid = vrid;
 commit;
 menu (surl=>surl,mtype=>'OFFLOCS',action=>'SEARCH',rid=>null,rnd=>null,msearch=>null);
end offlocs_del;

procedure accept_mng_offlocs( surl in varchar2, arr_rid in owa.vc_arr, id in varchar2, p1 in owa.vc_arr, p2 in owa.vc_arr, p3 in owa.vc_arr, p4 in owa.vc_arr, p5 in owa.vc_arr, p6 in owa.vc_arr, p7 in owa.vc_arr, p8 in owa.vc_arr, p9 in owa.vc_arr, action in varchar2 )
as

cursor c2 is select max(rno) mx from strang.offlocs;

cursor c3 ( vrno integer ) is select * from strang.categories where rno = vrno ;
cursor c7 (rid rowid) is select * from strang.offlocs where rowid=rid;
cursor c8 (ctr varchar2) is select * from strang.containers where containerno = ctr and offdate is null;

c2rec 	c2%ROWTYPE;
c3rec 	c3%ROWTYPE;
c7rec 	c7%ROWTYPE;
c8rec 	c8%ROWTYPE;

dt1 	date;
errmsg 	varchar2(1000);
newrid 	rowid;
nmb1 	number(6,2);
nmb2 	number(6,2);
nmb3 	number(6,2);
nmb4 	number(6,2);
nmb5 	number(6,2);
nmb6 	number(6,2);
rid  	rowid;
narr_rid src_rid;
ctr	integer;

begin
ctr := 0;
for j in 1..10 loop
  narr_rid(j) := null;
end loop;
for j in arr_rid.first..arr_rid.last loop

 if ( ((P1(j) is null) or (P3(j) is null) or (P4(j) is null) or (P5(j) is null) or (P6(j) is null) or (P7(j) is null) or (P8(j) is null) or (P9(j) is null)) and id = 'z' ) or
    ( ((P4(j) is null) or (P5(j) is null) or (P6(j) is null) or (P7(j) is null) or (P8(j) is null) or (P9(j) is null)) and id = 'x' )
  then
   null;
  else

  begin nmb1 := to_number( p4(j) ); exception when others then begin nmb1 := to_number( p4(j),G_MONEY_FORMAT ); exception when others then nmb1 := 0; end; end;
  begin nmb2 := to_number( p5(j) ); exception when others then begin nmb2 := to_number( p5(j),G_MONEY_FORMAT ); exception when others then nmb2 := 0; end; end;
  begin nmb3 := to_number( p6(j) ); exception when others then begin nmb3 := to_number( p6(j),G_MONEY_FORMAT ); exception when others then nmb3 := 0; end; end;
  begin nmb4 := to_number( p7(j) ); exception when others then begin nmb4 := to_number( p7(j),G_MONEY_FORMAT ); exception when others then nmb4 := 0; end; end;
  begin nmb5 := to_number( p8(j) ); exception when others then begin nmb5 := to_number( p8(j),G_MONEY_FORMAT ); exception when others then nmb5 := 0; end; end;
  begin nmb6 := to_number( p9(j) ); exception when others then begin nmb6 := to_number( p9(j),G_MONEY_FORMAT ); exception when others then nmb6 := 0; end; end;

  if action = 'Insert' then
      open c3 ( P1(j) );
      fetch c3 into c3rec;
      close c3;
      open c2;
      fetch c2 into c2rec;
      close c2;
      c2rec.mx := nvl(c2rec.mx,0) + 1;
      begin
        insert into strang.offlocs (loc_location,cat_company,cat_contract,cat_code,offcharge,offhandle,intchange,coffcharge,coffhandle,cintchange,rno )
        values ( P3(j), c3rec.company,c3rec.contract,c3rec.codedesc,nmb1,nmb2,nmb3,nmb4,nmb5,nmb6,c2rec.mx ) returning rowid into newrid;
      exception
       when others then
        mng_offlocs( surl, narr_rid, 'z', 'Insert Failed:' || sqlerrm);
        return;
      end;

      ctr := ctr + 1;
      narr_rid(ctr) := newrid;
      commit;
  end if;

 if action='Update' then
     rid := chartorowid(arr_rid(j));
     update strang.offlocs set
     offcharge = nmb1,
     offhandle = nmb2,
     intchange = nmb3,
     coffcharge = nmb4,
     coffhandle = nmb5,
     cintchange =nmb6
     where rowid = rid;
     commit;
 end if;

end if;

end loop;

if action = 'Insert' and ctr > 0
 then
   mng_offlocs( surl, narr_rid, 'x', 'Insert Successful');

elsif action = 'Insert' and ctr = 0
 then
   mng_offlocs( surl, narr_rid, 'z', 'Nothing to Insert');

elsif action = 'Update'
 then
   for j in arr_rid.first..arr_rid.last loop
    narr_rid(j) := chartorowid(arr_rid(j));
   end loop;
   mng_offlocs( surl, narr_rid, 'x', 'Update Successful');
end if;

exception when others then
 error_details( 'STRANGP', 'ACCEPT_MNG_OFFLOCS',null,null,errmsg=>sqlerrm);
end accept_mng_offlocs;

procedure generate_containers_onhire( crec in strang.containers%ROWTYPE )
as

 cursor c3(mv varchar2) is select * from strang.tracking_header where containerno = mv;

 cursor c5(sno integer) is select nvl(max(rno),0) + 1 mx from strang.tracking_details where id = sno;

 c3rec   c3%ROWTYPE;
 sno	 integer;
 calcrno integer;

begin

  open c3( crec.containerno );
  fetch c3 into c3rec;
  if c3%FOUND
   then
    -- check if ship and voyage already inserted
      open c5(c3rec.id);
      fetch c5 into calcrno;
      close c5;
      insert into strang.tracking_details(id,rno,remark,movement_type,departure_location,etd_date,arrival_location,eta_date,ship,voyage,current_location,date_at_current_loc)
       values(c3rec.id,calcrno,null,'ONHIRE',null,null,null,null,null,null,crec.nloc_location,crec.datehired);

   else

    -- insert new
    select strang.s_tracking_header.nextval into sno from dual;
    insert into strang.tracking_header(id,containerno,cat_code,cat_company) values
     (sno,crec.containerno,crec.cat_code,crec.cat_company);
    insert into strang.tracking_details(id,rno,remark,movement_type,departure_location,etd_date,arrival_location,eta_date,ship,voyage,current_location,date_at_current_loc)
     values(sno,1,null,'ONHIRE',null,null,null,null,null,null,crec.nloc_location,crec.datehired);

  end if;
  close c3;
 commit;
end generate_containers_onhire;

procedure generate_containers_offhire( crec in strang.containers%ROWTYPE )
as

 cursor c3(mv varchar2) is select * from strang.tracking_header where containerno = mv;

 cursor c5(sno integer) is select nvl(max(rno),0) + 1 mx from strang.tracking_details where id = sno;

 c3rec   c3%ROWTYPE;
 sno	 integer;
 calcrno integer;

begin

  open c3( crec.containerno );
  fetch c3 into c3rec;
  if c3%FOUND
   then
    -- check if ship and voyage already inserted
      open c5(c3rec.id);
      fetch c5 into calcrno;
      close c5;
    insert into strang.tracking_details(id,rno,remark,movement_type,departure_location,etd_date,arrival_location,eta_date,ship,voyage,current_location,date_at_current_loc)
     values(c3rec.id,calcrno,null,'OFFHIRE',null,null,null,null,null,null,crec.floc_location,crec.offdate);

   else

    -- insert new
    select strang.s_tracking_header.nextval into sno from dual;
    insert into strang.tracking_header(id,containerno,cat_code,cat_company) values
     (sno,crec.containerno,crec.cat_code,crec.cat_company);
    insert into strang.tracking_details(id,rno,remark,movement_type,departure_location,etd_date,arrival_location,eta_date,ship,voyage,current_location,date_at_current_loc)
     values(sno,1,null,'OFFHIRE',null,null,null,null,null,null,crec.floc_location,crec.offdate);

  end if;
  close c3;
 commit;
end generate_containers_offhire;

function pos_is_789(vdeliv integer)
 return boolean
as

 cursor c1(vdeliv integer) is select 'x' exst from strang.pos where deliveryno = vdeliv and grn_status in (7,8,9);
 c1rec  c1%ROWTYPE;
begin
 open c1(vdeliv);
 fetch c1 into c1rec;
 if c1%FOUND
  then
   close c1;
   return( TRUE );
  else
   close c1;
   return( FALSE );
 end if;
end pos_is_789;

procedure receive_top2(surl in varchar2, rid in varchar2, scid in varchar2, call_name in varchar2, parm in varchar2, access_id in varchar2 default null, msg in varchar2 default null, rows_show in integer default G_ROWS, norder in varchar2 default null, n_local in char default 'L' )
as

 -- xxx enhance and fix sorting on customer
 cursor c2( rid rowid, norder varchar2, n_local char, xloc char ) is
  select r1.rowid, r1.*, (select c1.customer from strang.customers c1 where c1.customer_id = r1.cust_customer_id) as customer
  from strang.receivals r1
  where
   (
    (norder = 'DNA' and r1.deliveryno >= (select deliveryno from strang.receivals r where rowid = rid)) or
    (norder = 'DND' and r1.deliveryno <= (select deliveryno from strang.receivals r where rowid = rid)) or
    (norder = 'CURRA' and r1.curr >= (select curr from strang.receivals r where rowid = rid)) or
    (norder = 'CURRD' and r1.curr <= (select curr from strang.receivals r where rowid = rid)) or
    (norder = 'CUSTOMA') or
    (norder = 'CUSTOMD') or
    (norder = 'CUSTA' and r1.cust_customer_id >= (select cust_customer_id from strang.receivals r where rowid = rid)) or
    (norder = 'CUSTD' and r1.cust_customer_id <= (select cust_customer_id from strang.receivals r where rowid = rid)) or
    (rid is null)
   ) and
   (
    (
      (n_local in ('LA') and substr(to_char(r1.deliveryno),1,1) = xloc) or
      (n_local in ('LI') and substr(to_char(r1.deliveryno),1,1) = xloc and exists(select 'x' vexst from strang.detailrs d where d.deliveryno = r1.deliveryno and upper(d.io) = 'I')) or
      (n_local in ('LO') and substr(to_char(r1.deliveryno),1,1) = xloc and exists(select 'x' vexst from strang.detailrs d where d.deliveryno = r1.deliveryno and upper(d.io) = 'O')) or
      (n_local in ('LU') and substr(to_char(r1.deliveryno),1,1) = xloc and 0 = (select count('x') vexst from strang.detailrs d where d.deliveryno = r1.deliveryno)) or
      (n_local in ('AI') and exists(select 'x' vexst from strang.detailrs d where d.deliveryno = r1.deliveryno and upper(d.io) = 'I')) or
      (n_local in ('AO') and exists(select 'x' vexst from strang.detailrs d where d.deliveryno = r1.deliveryno and upper(d.io) = 'O')) or
      (n_local in ('AU') and 0 = (select count('x') vexst from strang.detailrs d where d.deliveryno = r1.deliveryno)) or
      (n_local = 'ALL' or n_local is null or n_local = 'A')
    )
   )
  order by
   decode(norder, 'DNA', lpad(r1.deliveryno,20,'0'),
                  'DND', lpad((9999999999-r1.deliveryno),20,'0'),
                  'CURRA',r1.curr,
                  'CURRD',utl_raw.cast_to_varchar2(utl_raw.reverse(utl_raw.cast_to_raw(r1.curr))),
                  'CUSTA', lpad(r1.cust_customer_id,20,'0'),
                  'CUSTD', lpad((9999999999-r1.cust_customer_id),20,'0'),
                  'CUSTOMA', customer,
                  'CUSTOMD', utl_raw.cast_to_varchar2(utl_raw.reverse(utl_raw.cast_to_raw(customer)))
         );

 cursor c3( sname varchar2 ) is select screen_id from oltp_overview where screen_name = sname;
 cursor c4( scid integer ) is select * from oltp_object where screen_id = scid and original_column = 'CUSTOMER_TYPE';
 cursor c5( sto varchar2 ) is select max(deliveryno) + 1 dlr from strang.receivals;
 cursor c5x( sto varchar2, dlr varchar2 ) is select max(deliveryno) + 1 dlr from strang.receivals where substr(to_char(deliveryno),1,1) = dlr;
 cursor c6( dlrv number ) is select 'x' from dual where exists (select 'x' from strang.detailrs where movement_no is not null and deliveryno = dlrv );
 cursor c7(vste varchar2) is select customer_id from strang.lov l, strang.customers c where lov_name = 'CONTROLS' and code = 'DEFAULT RECEIVAL CUSTOMER' and description = customer and customer_type = 'CUSTOMER' and cola = vste;
 cursor c8(vste varchar2) is select description from strang.lov where lov_name = 'CONTROLS' and code = 'DEFAULT GST CODE' and cola = vste;
 cursor c9 is select code,description,cola from strang.lov where lov_name = 'COUNTRIES' order by cola;
 cursor c10(vste varchar2) is select description from strang.lov where lov_name = 'CONTROLS' and code = 'SEE_ALL_DELIVERIES' and cola = vste;
 cursor c11(vste varchar2) is select description from strang.lov where lov_name = 'CONTROLS' and code = 'DELIVERYNO' and cola = vste;
 cursor c12(vdel varchar2) is select io from strang.detailrs where deliveryno = vdel order by itemno;
 cursor c12t(vdel varchar2) is select io,count(*) tot from strang.detailrs where deliveryno = vdel group by io;
 cursor c20( vname varchar2) is select * from strang.lov where lov_name = vname order by code;

 c3rec		c3%ROWTYPE;
 c3arec		c3%ROWTYPE;
 c4rec		c4%ROWTYPE;
 c5rec		c5%ROWTYPE;
 c6rec		c6%ROWTYPE;
 c10rec 	c10%ROWTYPE;
 c11rec 	c11%ROWTYPE;
 c12rec 	c12%ROWTYPE;
 sts		varchar2(100);
 vaccess	varchar2(20);
 ttl		varchar2(200);
 seclevel	varchar2(100);
 vste		varchar2(10);
 v_link 	varchar2(1000);
 vurl		varchar2(4000);
 rctr		integer;
 last_rid	varchar2(100);
 v_local_check	varchar2(100);
 v_inbound	varchar2(100) := 'class="str1_bg_left"';
 v_outbound	varchar2(100) := 'class="str1_bg_outb"';
 v_inbound_r	varchar2(100) := 'class="str1_bg_right"';
 v_outbound_r	varchar2(100) := 'class="str1_bg_outbr"';
 v_cell		varchar2(100);
 v_cell_r	varchar2(100);
 xloc		char(1);
 vsel		varchar2(100);
 tot_i		integer;
 tot_o		integer;
 frec		boolean;

begin
 if not dapi.init( surl, 'STRANGP.RECEIVE_TOP', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'RECEIVE_TOP');
    return;
 end if;

 vaccess := data_access( 'RECEIVAL' );

 vste := customer_state(dapi.GLOBAL_ACCOUNT.acctid);
 open c11(vste);
 fetch c11 into v_local_check;
 close c11;
 ttl := 'Receivals';
 seclevel := security_role( dapi.GLOBAL_ACCOUNT.acctid );

 main_title( helpid=>'STR02');
 if vaccess = 'NONE' then htp.bold( 'Access Denied' ); htp.htmlclose; return; end if;
 if msg is not null
  then
   ttl := msg;
 end if;
 htp.p( '<CENTER>' );
 -- "Receivals" - Has a filter at top of screen where the user can select Local (default) or All.  Can you colour inbound and outbound deliveries different colours?
 xloc := substr(v_local_check,1,1);
 -- select cola,description from lov where code = 'DELIVERYNO' and lov_name = 'CONTROLS';

 open c3('Customers');
 fetch c3 into c3rec;
 close c3;
 open c3('Receival');
 fetch c3 into c3arec;
 close c3;
 open c4(c3rec.screen_id);
 fetch c4 into c4rec;
 close c4;

 htp.tableopen( cattributes=>'class="str1_table"' );
  htp.tablerowopen;
   htp.tabledata( htf.bold('Filter'),cattributes=>'class="str1_bg_left"');
   htp.p( '<td class="str1_bg_left" colspan="2">' );
     htp.p( '<FORM ACTION="formc" METHOD="POST">' );
     htp.p( '<SELECT NAME="site" onChange="parent.location.href = this.options[this.selectedIndex].value;">' );
       if nvl(n_local,'A') = 'A' then htp.p( '<OPTION Value="">Filter</OPTION>' ); end if;
       if n_local = 'LI' then vsel := 'SELECTED'; else vsel := null; end if;
       htp.p( '<OPTION ' || vsel || ' VALUE="' || 'strangp.receive_top2?surl=' || surl || '&scid=' || scid || '&parm=' || parm || '&call_name=' || call_name || '&access_id=' || access_id || '&rid=' || rid || '&rows_show=' || rows_show || '&norder=' || norder || '&n_local=LI">' || 'Local Inbound' || '</OPTION>' );

       if n_local = 'LO' then vsel := 'SELECTED'; else vsel := null; end if;
       htp.p( '<OPTION ' || vsel || ' VALUE="' || 'strangp.receive_top2?surl=' || surl || '&scid=' || scid || '&parm=' || parm || '&call_name=' || call_name || '&access_id=' || access_id || '&rid=' || rid || '&rows_show=' || rows_show || '&norder=' || norder || '&n_local=LO">' || 'Local Outbound' || '</OPTION>' );

       if n_local = 'LA' then vsel := 'SELECTED'; else vsel := null; end if;
       htp.p( '<OPTION ' || vsel || ' VALUE="' || 'strangp.receive_top2?surl=' || surl || '&scid=' || scid || '&parm=' || parm || '&call_name=' || call_name || '&access_id=' || access_id || '&rid=' || rid || '&rows_show=' || rows_show || '&norder=' || norder || '&n_local=LA">' || 'Local All' || '</OPTION>' );

       if n_local = 'LU' then vsel := 'SELECTED'; else vsel := null; end if;
       htp.p( '<OPTION ' || vsel || ' VALUE="' || 'strangp.receive_top2?surl=' || surl || '&scid=' || scid || '&parm=' || parm || '&call_name=' || call_name || '&access_id=' || access_id || '&rid=' || rid || '&rows_show=' || rows_show || '&norder=' || norder || '&n_local=LU">' || 'Local Unknown' || '</OPTION>' );

       if seclevel in ( 'LEVEL 5','LEVEL 7','LEVEL 8' )
       then
       if n_local = 'AI' then vsel := 'SELECTED'; else vsel := null; end if;
       htp.p( '<OPTION ' || vsel || ' VALUE="' || 'strangp.receive_top2?surl=' || surl || '&scid=' || scid || '&parm=' || parm || '&call_name=' || call_name || '&access_id=' || access_id || '&rid=' || null || '&rows_show=' || rows_show || '&norder=' || norder || '&n_local=AI">' || 'All Inbound' || '</OPTION>' );

       if n_local = 'AO' then vsel := 'SELECTED'; else vsel := null; end if;
       htp.p( '<OPTION ' || vsel || ' VALUE="' || 'strangp.receive_top2?surl=' || surl || '&scid=' || scid || '&parm=' || parm || '&call_name=' || call_name || '&access_id=' || access_id || '&rid=' || null || '&rows_show=' || rows_show || '&norder=' || norder || '&n_local=AO">' || 'All Outbound' || '</OPTION>' );

       if n_local = 'AU' then vsel := 'SELECTED'; else vsel := null; end if;
       htp.p( '<OPTION ' || vsel || ' VALUE="' || 'strangp.receive_top2?surl=' || surl || '&scid=' || scid || '&parm=' || parm || '&call_name=' || call_name || '&access_id=' || access_id || '&rid=' || null || '&rows_show=' || rows_show || '&norder=' || norder || '&n_local=AU">' || 'All Unknown' || '</OPTION>' );

       if n_local = 'ALL' then vsel := 'SELECTED'; else vsel := null; end if;
       htp.p( '<OPTION ' || vsel || ' VALUE="' || 'strangp.receive_top2?surl=' || surl || '&scid=' || scid || '&parm=' || parm || '&call_name=' || call_name || '&access_id=' || access_id || '&rid=' || null || '&rows_show=' || rows_show || '&norder=' || norder || '&n_local=ALL">' || 'All' || '</OPTION>' );
       end if;
     htp.p( '</SELECT>' );
     htp.p( '</FORM>' );
   htp.p( '</td>' );
   htp.p( '<td colspan="10">' );

   htp.tableopen( cattributes=>'class="str2_int"' );
   htp.tablerowopen;
    htp.tabledata( htf.bold(ttl), cattributes=>'class="str1_cell_left_middle"' );

    if seclevel in ( 'LEVEL 8' )
     then
      null;
    else
      htp.tabledata( htf.formopen( 'oltp.process_query', ctarget=>'_top' ) || htf.formhidden( 'SURL', surl ) || htf.formhidden( 'ID', 'z' ) || htf.formhidden( 'RND', to_char(sysdate,'SSSSS') ) || htf.formhidden( 'ACCESS_IN', 'EDIT' ) || htf.formhidden( 'RID', null ) ||
        htf.formhidden( 'SCID', c3arec.screen_id ) || htf.formhidden( 'PARM1', 'CUSTOMER' ) || htf.formhidden( 'PARM2', c4rec.oltp_id ) || htf.formhidden( 'PARM3', null ) || htf.formhidden( 'PARM4', '=' ) ||
        htf.formhidden( 'SORT', null ) ||
        htf.formsubmit( null, 'New Receival' ) ||
        htf.formclose, cattributes=>'class="str1_cell_left"');
      htp.tabledata( htf.formopen( 'strangp.mng_cust', cattributes=>'onsubmit="javascript: window.open('''',''CUSTOMER_WINDOW'',''top=100,left=100,height=800,width=1200,location=no,resizable=yes,scrollbars=yes,status=no''); this.target=''CUSTOMER_WINDOW'';"' ) || htf.formhidden( 'SURL', surl ) || htf.formhidden( 'ID', 'z' ) || htf.formhidden( 'IS_POPUP', 'T' ) || htf.formhidden( 'RID', null ) || htf.formsubmit( null, 'New Customer/Supplier' ) || htf.formclose,cattributes=>'class="str1_cell_left"');
    end if;
    if seclevel in ( 'LEVEL 7' )
     then
      htp.p(pop_up_window( 'height=800,width=500,scrollbars=yes,resizable=yes'));
      v_link := '''strangp.ost_185_screen?surl=' || surl || '&action=NEW''';
      htp.tabledata('<form><input type="button" onClick="popUpWindow(' || v_link || ')" value="' || 'OST 185 Batch' || '"></form>',cattributes=>'class="str1_cell_left"');
      htp.tabledata('<form><input type="button" onClick="popUpWindow(' || v_link || ')" value="' || 'Generate OST 185' || '"></form>',cattributes=>'class="str1_cell_left"');
      htp.p(pop_up_window( 'height=600,width=500,scrollbars=yes,resizable=yes'));
      v_link := '''strangp.ost_185_batch?surl=' || surl || '''';
    end if;

  rctr := 0;
  for c2rec in c2(replace(rid,'~','+'),norder,n_local,xloc) loop
   rctr := rctr + 1;
   if rctr > rows_show then exit; end if;
   last_rid := replace(c2rec.rowid,'~','+');
  end loop;
  search( surl, 'RECEIVALS', last_rid, samerow=>TRUE, first_rid=>rid, xtra1=>norder, xtra2=>n_local );

    if vaccess = 'EDIT'
     then
      htp.formopen( 'strangp.accept_receive_top2', ctarget=>'_top' );
      if access_id = 'z'
       then
        if seclevel in ( 'LEVEL 8' )
         then
          null;
         else
          htp.tabledata( htf.formsubmit( 'ACTION', 'Insert New Delivery' ),cattributes=>'class="str1_cell_left"');
	end if;
      end if;
      htp.tabledata( htf.formsubmit( 'ACTION', 'Update Delivery' ),cattributes=>'class="str1_cell_left"');
      htp.tabledata( htf.formsubmit( 'ACTION', 'Cancel' ),cattributes=>'class="str1_cell_left"');
     else
      htp.formopen( '&nbsp;', ctarget=>'_top' );
      htp.tabledata( '&nbsp;',cattributes=>'class="str1_cell_left"');
    end if;

  htp.tablerowclose;
  htp.tableclose;
  htp.p( '</td>' );
  htp.tablerowclose;

  htp.tablerowopen;
   htp.tableheader( htf.bold('Options'),cattributes=>'class="str1_bg_left"');
   htp.tableheader( htf.bold('IO'),cattributes=>'class="str1_bg_left"');
   if norder = 'DNA'
    then
     htp.tableheader( htf.anchor2( 'strangp.receive_top2?surl=' || surl || '&scid=' || scid || '&parm=' || parm || '&call_name=' || call_name || '&access_id=' || access_id || '&rid=' || rid || '&rows_show=' || rows_show || '&norder=DND' || '&n_local=' || n_local , 'Delivery #', ctarget=>'_top'), cattributes=>'class="str1_bg_left"' );
    else
     htp.tableheader( htf.anchor2( 'strangp.receive_top2?surl=' || surl || '&scid=' || scid || '&parm=' || parm || '&call_name=' || call_name || '&access_id=' || access_id || '&rid=' || rid || '&rows_show=' || rows_show || '&norder=DNA' || '&n_local=' || n_local , 'Delivery #', ctarget=>'_top'), cattributes=>'class="str1_bg_left"' );
   end if;
   if norder = 'CUSTOMA'
    then
     htp.tableheader( htf.anchor2( 'strangp.receive_top2?surl=' || surl || '&scid=' || scid || '&parm=' || parm || '&call_name=' || call_name || '&access_id=' || access_id || '&rid=' || rid || '&rows_show=' || rows_show || '&norder=CUSTOMD' || '&n_local=' || n_local , 'Customer', ctarget=>'_top'), cattributes=>'class="str1_bg_left"' );
    else
     htp.tableheader( htf.anchor2( 'strangp.receive_top2?surl=' || surl || '&scid=' || scid || '&parm=' || parm || '&call_name=' || call_name || '&access_id=' || access_id || '&rid=' || rid || '&rows_show=' || rows_show || '&norder=CUSTOMA' || '&n_local=' || n_local , 'Customer', ctarget=>'_top'), cattributes=>'class="str1_bg_left"' );
   end if;
   if norder = 'CUSTA'
    then
     htp.tableheader( htf.anchor2( 'strangp.receive_top2?surl=' || surl || '&scid=' || scid || '&parm=' || parm || '&call_name=' || call_name || '&access_id=' || access_id || '&rid=' || rid || '&rows_show=' || rows_show || '&norder=CUSTD' || '&n_local=' || n_local , 'ID', ctarget=>'_top'), cattributes=>'class="str1_bg_left"' );
    else
     htp.tableheader( htf.anchor2( 'strangp.receive_top2?surl=' || surl || '&scid=' || scid || '&parm=' || parm || '&call_name=' || call_name || '&access_id=' || access_id || '&rid=' || rid || '&rows_show=' || rows_show || '&norder=CUSTA' || '&n_local=' || n_local , 'ID', ctarget=>'_top'), cattributes=>'class="str1_bg_left"' );
   end if;
   htp.tableheader( htf.bold('Date'),cattributes=>'class="str1_bg_left"');
   htp.tableheader( htf.bold('Supplier'),cattributes=>'class="str1_bg_left"');
   htp.tableheader( htf.bold('ID'),cattributes=>'class="str1_bg_left"');
   --htp.tabledata( htf.bold('Exchange Rate'),cattributes=>'class="str1_bg_left"');
   htp.tableheader( htf.bold('Value'),cattributes=>'class="str1_bg_left"');
   htp.tableheader( htf.bold('Total'),cattributes=>'class="str1_bg_left"');
   htp.tableheader( htf.bold('Notes'),cattributes=>'class="str1_bg_left"');
   htp.tableheader( htf.bold('Status'),cattributes=>'class="str1_bg_left"');
   --htp.tableheader( htf.bold('Del'),cattributes=>'class="str1_bg_left"');
  htp.tablerowclose;

 if vaccess = 'EDIT'
  then
   htp.formhidden( 'SURL', surl );
   htp.formhidden( 'SCID', scid );
   htp.formhidden( 'PARM', 'RECEIVALS' );
   htp.formhidden( 'ACCESS_ID', access_id );
   htp.formhidden( 'NORDER', norder );
   htp.formhidden( 'N_LOCAL', n_local );
   htp.formhidden( 'ROWS_SHOW', rows_show );
 end if;

 rctr := 0;
  for c2rec in c2(replace(rid,'~','+'),norder,n_local,xloc) loop
   tot_i := 0;
   tot_o := 0;
   rctr := rctr + 1;
   v_cell := v_inbound;
   v_cell_r := v_inbound_r;
   open c12(c2rec.deliveryno);
   fetch c12 into c12rec;
   close c12;
   if upper(c12rec.io) = 'O' then v_cell := v_outbound; v_cell_r := v_outbound_r; end if;
   for crec in c12t(c2rec.deliveryno) loop
    if upper(crec.io) = 'I' then tot_i := crec.tot; end if;
    if upper(crec.io) = 'O' then tot_o := crec.tot; end if;
   end loop;
   if rctr > rows_show then exit; end if;
   last_rid := replace(c2rec.rowid,'~','+');
   htp.tablerowopen;
   if access_id <> 'z'
   then
     --open c2(replace(rid,'~','+'));
     --fetch c2 into c2rec;
     --close c2;
     null;
    else
     c2rec.curr := 'AUD';
    end if;

    -- Options
    htp.p( '<td ' || v_cell || '>' );
    if vaccess = 'EDIT'
     then
      if access_id = 'z'
       then
        htp.formhidden( 'RID', null );
        c10rec := null;
        c11rec := null;
        c5rec := null;
        open c10(vste);
        fetch c10 into c10rec;
        close c10;
        if c10rec.description = 'YES'
         then
          open c11(vste);
          fetch c11 into c11rec;
          close c11;
          open c5x(currsite,substr(c11rec.description,1,1));
          fetch c5x into c5rec;
          close c5x;
          if c5rec.dlr is null then c5rec.dlr := c11rec.description; end if;
         else
          open c11(vste);
          fetch c11 into c11rec;
          close c11;
          open c5x(currsite,substr(c11rec.description,1,1));
          fetch c5x into c5rec;
          close c5x;
          if c5rec.dlr is null then c5rec.dlr := c11rec.description; end if;
       end if;
       open c7(vste);
       fetch c7 into c2rec.cust_customer_id;
       close c7;
       open c8(vste);
       fetch c8 into c2rec.gstc_gstcode;
       close c8;
      else
       htp.formhidden( 'RID', replace(c2rec.rowid,'~','+') );
     end if;

    end if;
    if access_id = 'z'
     then
      vurl := 'strangp.receive_bottom?surl=' || surl || '&scid=' || scid || '&parm=' || parm || '&call_name=' || call_name || '&access_id=' || access_id || '&rid=' || replace( c2rec.rowid, '+', '~' ) || '&recctr=' || '1' || '&msg=' || c5rec.dlr || '&popup=T&force_single_disp=Z';
      htp.anchor( 'javascript: window.open(''' || vurl || ''',''' || 'EDIT_DELIV' ||  ''',''height=800,width=1600,scrollbars=yes,resizable=yes,location=no,left=100,top=100'');void('''');', '[Det]' );
      vurl := 'strangp.receive_po?surl=' || surl || '&scid=' || scid || '&parm=' || parm || '&call_name=' || call_name || '&access_id=' || access_id || '&rid=' || replace( c2rec.rowid, '+', '~' ) || '&recctr=' || '1' || '&msg=' || c5rec.dlr || '&popup=T&force_single_disp=Z';
      htp.anchor( 'javascript: window.open(''' || vurl || ''',''' || 'EDIT_PO' ||  ''',''height=800,width=1600,scrollbars=yes,resizable=yes,location=no,left=100,top=100'');void('''');', '[Po]' );
     else
      vurl := 'strangp.receive_bottom?surl=' || surl || '&scid=' || scid || '&parm=' || parm || '&call_name=' || call_name || '&access_id=' || access_id || '&rid=' || replace( c2rec.rowid, '+', '~' ) || '&recctr=' || '1' || '&msg=' || c2rec.deliveryno || '&popup=T&force_single_disp=Z';
      htp.anchor( 'javascript: window.open(''' || vurl || ''',''' || 'EDIT_DELIV' ||  ''',''height=800,width=1600,scrollbars=yes,resizable=yes,location=no,left=100,top=100'');void('''');', '[Det]' );
      vurl := 'strangp.receive_po?surl=' || surl || '&scid=' || scid || '&parm=' || parm || '&call_name=' || call_name || '&access_id=' || access_id || '&rid=' || replace( c2rec.rowid, '+', '~' ) || '&recctr=' || '1' || '&msg=' || c2rec.deliveryno || '&popup=T&force_single_disp=Z';
      htp.anchor( 'javascript: window.open(''' || vurl || ''',''' || 'EDIT_PO' ||  ''',''height=800,width=1600,scrollbars=yes,resizable=yes,location=no,left=100,top=100'');void('''');', '[Po]' );
    end if;
    htp.p( '</td>' );

    -- IO
    if tot_i > 0 and tot_o > 0
     then
      htp.tabledata( 'Mixed', cattributes=>v_cell);
    elsif tot_i > 0
     then
      htp.tabledata( 'Inb', cattributes=>v_cell);
    elsif tot_o > 0
     then
      htp.tabledata( 'Outb', cattributes=>v_cell);
    else
      htp.tabledata( 'No Rec', cattributes=>v_cell);
    end if;

    htp.p( '<td ' || v_cell || '>' );
    if access_id = 'z'
     then
      vurl := 'strangp.receive_single?surl=' || surl || '&rid=' || replace( c2rec.rowid, '+', '~' ) || '&scid=' || scid || '&call_name=' || call_name || '&parm=' || parm || '&access_id=' || access_id || '&msg=' || c5rec.dlr || '&vrecctr=' || '1' || '&norder=' || norder || '&n_local=' || n_local;
      htp.anchor( vurl, c5rec.dlr );
     else
      vurl := 'strangp.receive_single?surl=' || surl || '&scid=' || scid || '&parm=' || parm || '&call_name=' || call_name || '&access_id=' || access_id || '&rid=' || replace( c2rec.rowid, '+', '~' ) || '&vrecctr=' || '1' || '&msg=' || c2rec.deliveryno || '&norder=' || norder || '&n_local=' || n_local;
      htp.anchor(  vurl, c2rec.deliveryno );
    end if;
    htp.p( '</td>' );

    -- Customer
      htp.p( '<TD ' || v_cell || '>' );
       customer_list( 'CUSTOMER', 'P6', c2rec.cust_customer_id, TRUE, isedit=>FALSE, css=>'str1_combo' );
      htp.p( '</TD>' );
      htp.p( '<TD ' || v_cell || '>' );
      htp.p(c2rec.cust_customer_id);
      htp.p( '</TD>' );
      htp.tabledata( to_char(nvl(c2rec.currdate,sysdate),LNG_MASK),cattributes=>v_cell);
      htp.p( '<TD ' || v_cell || '>' );
       customer_list( 'SUPPLIER', 'P8', c2rec.supplier_customer_id, FALSE, isedit=>FALSE, css=>'str1_combo' );
      htp.p( '</TD>' );
      htp.p( '<TD ' || v_cell || '>' );
        htp.p(strang.f_get_vendor_id(c2rec.supplier_customer_id));
      htp.p( '</TD>' );
      htp.tabledata( c2rec.curr,cattributes=>v_cell);

    if c2rec.curr = 'AUD' and c2rec.exrate is null then c2rec.exrate := 1; end if;

    htp.tabledata( strang.f_display_po_total(c2rec.deliveryno),cattributes=>v_cell_r);

    -- Notes
    if vaccess = 'EDIT'
     then
      htp.tabledata( htf.formtext( 'N1', 30, 200, html_format(c2rec.r_notes) ),cattributes=>v_cell);
     else
      htp.tabledata( c2rec.r_notes,cattributes=>v_cell);
    end if;

    if vaccess = 'EDIT'
     then
      htp.p( '<td ' || v_cell || '>' );
      if pos_is_789(c2rec.deliveryno)
       then
        htp.formhidden( 'N2', c2rec.status );
       else
        htp.formselectopen( 'N2' );
         frec := FALSE;
         --htp.formselectoption( NULL );
         for c20rec in c20( 'URGENCY' ) loop
          if to_char(c2rec.status) = c20rec.code
           then
            htp.formselectoption( c20rec.description || ' (' || c20rec.code || ')', 'SELECTED', cattributes=>'VALUE="' || c20rec.code || '"');
            frec := TRUE;
           else
            htp.formselectoption( c20rec.description || ' (' || c20rec.code || ')', cattributes=>'VALUE="' || c20rec.code || '"');
          end if;
         end loop;
         if to_char(c2rec.status) is not null and not frec
          then
           htp.formselectoption( 'Unknown Status:' || c2rec.status, 'SELECTED', cattributes=>'VALUE="' || c2rec.status || '"');
         end if;
        htp.formselectclose;
       end if;
      htp.p( '</td>' );
     else
      htp.tabledata( c2rec.status,cattributes=>v_cell);
    end if;

    /*
    htp.p( '<TD ' || v_cell || '>' );
    if vaccess = 'EDIT'
     then
      open c6( c2rec.deliveryno );
      fetch c6 into c6rec;
      if c6%NOTFOUND
       then
        close c6;
        if seclevel in ( 'LEVEL 8' )
         then
          null;
         else
          htp.anchor2( 'strangp.accept_receive_top?surl=' || surl || '&scid=' || scid || '&parm=RECEIVALS&access_id=' || access_id || '&rid=' || replace(c2rec.rowid,'+','~') || '&p1=&p3=&p4=&p5=&p6=&p8=&p3n=&ACTION=Delete+Delivery' || '&norder=DNA' || '&n_local=' || n_local, 'Delete Delivery', ctarget=>'_top');
        end if;
       else
        close c6;
      end if;
    end if;
    htp.p( '</td>' );
    */
    htp.tablerowclose;
  end loop;

 htp.tableclose;
 htp.nl;

 htp.formclose;

-- mk: unsure?
--    else
--       htp.p( htf.formopen( 'strangp.mng_cust', ctarget=>'CUSTOMER_WINDOW' ) || htf.formhidden( 'SURL', surl ) || htf.formhidden( 'ID', 'z' ) || htf.formhidden( 'RID', null ) || htf.formsubmit( null, 'New Customer/Supplier' ) || htf.formclose );
--   end if;



 htp.p( '</CENTER>' );
 -- htp.header( 3, 'Trace check receive_top2 = ' || v_local_check || '[' || n_local || '][' || norder || '][' || rid || ']' );
 htp.htmlclose;
exception when others then
 error_details( 'STRANGP', 'RECEIVE_TOP2',null,null,errmsg=>sqlerrm,extdet=>'PARM:' || parm);
end receive_top2;

--
--
--
function jscript_convoy( divhdr in varchar2 default '<DIV>' )
 return varchar2
as
begin
 return( '
  <script type="text/javascript" language="javascript">
            var http_request = false;
            function popcapacity(fld, url, trgid) {
                http_request = false;
                if (window.XMLHttpRequest) { // Mozilla, Safari,...
                    http_request = new XMLHttpRequest();
                } else if (window.ActiveXObject) { // IE
                    try {
                        http_request = new ActiveXObject("Msxml2.XMLHTTP");
                    } catch (e) {
                        try {
                        http_request = new ActiveXObject("Microsoft.XMLHTTP");
                        } catch (e) {}
                    }
                }
                if (!http_request) {
                    alert(''Giving up :( Cannot create an XMLHTTP instance'');
                    return false;
                }
         //       http_request.onreadystatechange = alertContents;
          http_request.onreadystatechange = function()
          {
            if (http_request.readyState == 4 &&
              http_request.status == 200) {
              //  alert( http_request.responseText );
             var xmlDocument = http_request.responseXML;
            validatefld(fld, xmlDocument, trgid);
            }
          }
             //   alert( url + encodeURIComponent(fld.value) );
                http_request.open(''GET'', url + encodeURIComponent(fld.value), true);
                http_request.send(null);
            }
      function validatefld(fld, xmldoc, trgid)
      {
        vlNode = xmldoc.getElementsByTagName("value");
        try
         {
          displayText = vlNode[0].firstChild.nodeValue;
         } catch (e) { displayText = "" }

        var target = document.getElementById(trgid);
        target.innerHTML=displayText;
      }
        </script>'
        );
 end jscript_convoy;

procedure convoy_read(surl in varchar2, vpk in integer, msg in varchar2 default null, ispopup in char default 'F')
as
 cursor c1(vpk integer) is select * from strang.ships_airway where ship_id = vpk;
 cursor c2(vpk integer) is select r.rowid,r.* from strang.convoy_details r where ship_id = vpk order by decode(truck_tanker,'TRUCK',0,'TANKER',1,2);
 cursor c5(vtrl varchar2) is select l.colb from strang.lov l, strang.convoy_details c where l.lov_name='TRAILERS' and upper(trim(l.code)) = upper(trim(c.trailer_id)) and upper(trim(c.trailer_id)) = upper(trim(vtrl)) order by colb;
 cursor c6(vpk integer, vtrk varchar2) is select m.* from strang.movements m where convoy_id = vpk and upper(trim(truck_id)) = upper(trim(vtrk)) order by m.movement_no;
 cursor c8(vname varchar2) is select * from strang.lov where lov_name = vname order by code;

 srec		c1%ROWTYPE;
 c5rec		c5%ROWTYPE;
 sts		varchar2(100);
 vaccess	varchar2(20);
 ttl		varchar2(200);
 seclevel	varchar2(100);
 vste		varchar2(10);
 v_link 	varchar2(1000);
 vurl		varchar2(4000);
 rctr		integer;
 last_rid	varchar2(100);
 parm		varchar2(1000);
 ctr		integer;
 fctr		integer;
 url		varchar2(1000);

begin
 if not dapi.init( surl, 'STRANGP.CONVOY', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'CONVOY');
    return;
 end if;

 vste := customer_state(dapi.GLOBAL_ACCOUNT.acctid);
 vaccess := data_access( 'SHP' ); -- this is a guess
 seclevel := security_role( dapi.GLOBAL_ACCOUNT.acctid );

 htp.tableopen( cattributes=>'class="str3_int"' );
  htp.tablerowopen;
  htp.tableheader( 'Convoy Details', cattributes=>'class="str1_hd_left"');
  ctr := 0;
  fctr := 0;
  for c2rec in c2(vpk) loop
   ctr := ctr + 1;
   htp.tableheader( ctr, cattributes=>'class="str1_hd_left"' );
   end loop;
  htp.tablerowclose;

  htp.tablerowopen;
   htp.tableheader( 'Truck/Tankers', cattributes=>'class="str1_hd_left"');
   for c2rec in c2(vpk) loop
     htp.p( '<TD ' || 'class="str1_bg_left">' );
      htp.p( nvl(c2rec.truck_tanker, '&nbsp;') );
     htp.p( '</TD>' );
   end loop;
  htp.tablerowclose;

  htp.tablerowopen;
   htp.tableheader( 'Truck ID', cattributes=>'class="str1_hd_left"');
   for c2rec in c2(vpk) loop
     htp.p( '<TD ' || 'class="str1_bg_left">' );
      htp.p( nvl(c2rec.truck_id, '&nbsp;') );
     htp.p( '</TD>' );
   end loop;
  htp.tablerowclose;

  htp.tablerowopen;
   htp.tableheader( 'Trailer ID', cattributes=>'class="str1_hd_left"');
   for c2rec in c2(vpk) loop
     htp.p( '<TD ' || 'class="str1_bg_left">' );
      htp.p( nvl(c2rec.trailer_id, '&nbsp;') );
     htp.p( '</TD>' );
   end loop;
  htp.tablerowclose;

  htp.tablerowopen;
   htp.tableheader( 'Trailer Load Capacity', cattributes=>'class="str1_hd_left"');
   for c2rec in c2(vpk) loop
     c5rec := null;
     open c5(c2rec.trailer_id);
     fetch c5 into c5rec;
     close c5;
     htp.p( '<TD ' || 'class="str1_bg_left">' );
      htp.p( nvl(c5rec.colb, '&nbsp;') );
   end loop;
  htp.tablerowclose;

  htp.tablerowopen;
   htp.tableheader( 'Operator', cattributes=>'class="str1_hd_left"');
   for c2rec in c2(vpk) loop
     htp.p( '<TD ' || 'class="str1_bg_left">' );
      htp.p( nvl(c2rec.operator_1, '&nbsp;') );
     htp.p( '</TD>' );
   end loop;
  htp.tablerowclose;

  htp.tablerowopen;
   htp.tableheader( 'Convoy Section', cattributes=>'class="str1_hd_left"');
   for c2rec in c2(vpk) loop
     htp.p( '<TD ' || 'class="str1_bg_left">' );
      htp.p( nvl(c2rec.convoy_section, '&nbsp;') );
     htp.p( '</TD>' );
   end loop;
  htp.tablerowclose;

  htp.tablerowopen;
   htp.tableheader( 'Masterplan', cattributes=>'class="str1_hd_left"');
   for c2rec in c2(vpk) loop
    htp.tabledata( c2rec.masterplan );
   end loop;
  htp.tablerowclose;

  htp.tablerowopen;
   htp.tableheader( 'Weighbridge', cattributes=>'class="str1_hd_left"');
   for c2rec in c2(vpk) loop
     htp.p( '<TD ' || 'class="str1_bg_left">' );
      htp.p( nvl(c2rec.weighbridge, '&nbsp;') );
     htp.p( '</TD>' );
   end loop;
  htp.tablerowclose;

  htp.tablerowopen;
   htp.tableheader( 'Movements', cattributes=>'class="str1_hd_left"');
   for c2rec in c2(vpk) loop
    htp.p( '<td class="str1_bg_left">' );
     for c6rec in c6(c2rec.ship_id,c2rec.truck_id) loop
      htp.p( c6rec.movement_no || '/' || c6rec.seal );
      htp.nl;
     end loop;
    htp.p( '</td>' );
   end loop;
  htp.tablerowclose;

  htp.tablerowopen;
   htp.tableheader( 'Fuel Pump', cattributes=>'class="str1_hd_left"');
   for c2rec in c2(vpk) loop
     htp.p( '<TD ' || 'class="str1_bg_left">' );
      htp.p( nvl(c2rec.fuel_pump, '&nbsp;') );
     htp.p( '</TD>' );
   end loop;
  htp.tablerowclose;

  htp.tablerowopen;
   htp.tableheader( 'Fuel Type', cattributes=>'class="str1_hd_left"');
   for c2rec in c2(vpk) loop
     htp.p( '<TD ' || 'class="str1_bg_left">' );
      htp.p( nvl(c2rec.fuel_type, '&nbsp;') );
     htp.p( '</TD>' );
   end loop;
  htp.tablerowclose;

  htp.tablerowopen;
   htp.tableheader( 'Fuel Litres', cattributes=>'class="str1_hd_left"');
   for c2rec in c2(vpk) loop
     htp.p( '<TD ' || 'class="str1_bg_left">' );
      htp.p( nvl(to_char(c2rec.fuel_litres), '&nbsp;') );
     htp.p( '</TD>' );
   end loop;
  htp.tablerowclose;

 htp.tableclose;
 htp.nl;

 if ispopup = 'T' then htp.nl; htp.nl; htp.bold( '<a href="" onClick="self.close()">' || LNG.GLB_TXT_033 || '</a>'); end if;
 htp.p( '</CENTER>' );
 htp.htmlclose;
exception when others then
 error_details( 'STRANGP', 'CONVOY_READ',null,null,errmsg=>sqlerrm,extdet=>'PARM:' || parm);
end convoy_read;

procedure convoy(surl in varchar2, vpk in integer, msg in varchar2 default null, ispopup in char default 'F')
as

 cursor c1(vpk integer) is select * from strang.ships_airway where ship_id = vpk;
 cursor c2(vpk integer) is select r.rowid,r.* from strang.convoy_details r where ship_id = vpk order by truck_tanker;
 cursor c5(vtrl varchar2) is select l.colb from strang.lov l, strang.convoy_details c where l.lov_name='TRAILERS' and upper(trim(l.code)) = upper(trim(c.trailer_id)) and upper(trim(c.trailer_id)) = upper(trim(vtrl)) order by colb;
 cursor c6(vpk integer, vtrk varchar2) is select m.* from strang.movements m where convoy_id = vpk and upper(trim(truck_id)) = upper(trim(vtrk)) order by m.movement_no;
 cursor c8(vname varchar2) is select * from strang.lov where lov_name = vname order by code;

 srec		c1%ROWTYPE;
 c5rec		c5%ROWTYPE;
 sts		varchar2(100);
 vaccess	varchar2(20);
 ttl		varchar2(200);
 seclevel	varchar2(100);
 vste		varchar2(10);
 v_link 	varchar2(1000);
 vurl		varchar2(4000);
 rctr		integer;
 last_rid	varchar2(100);
 parm		varchar2(1000);
 ctr		integer;
 fctr		integer;
 url		varchar2(1000);

begin
 if not dapi.init( surl, 'STRANGP.CONVOY', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'CONVOY');
    return;
 end if;

 vste := customer_state(dapi.GLOBAL_ACCOUNT.acctid);
 vaccess := data_access( 'SHP' ); -- this is a guess
 seclevel := security_role( dapi.GLOBAL_ACCOUNT.acctid );

 main_title( 'Manage Convoy',helpid=>'STR58',dispmenu=>FALSE);

 open c1(vpk);
 fetch c1 into srec;
 close c1;
 htp.p( jscript_convoy( null ) );

 htp.p( '<CENTER>' );
 header_msg( nvl(msg,'Manage Convoy: ' || srec.shipname || '/' || srec.voy) );

 if vaccess = 'NONE' then htp.bold( 'Access Denied' ); htp.htmlclose; return; end if;
 if vaccess <> 'EDIT' then convoy_read(surl, vpk, msg, ispopup); return; end if;

 htp.formopen( 'strangp.accept_convoy' );
 htp.formhidden( 'SURL', surl );
 htp.formhidden( 'VPK', vpk );
 htp.formhidden( 'ISPOPUP', ispopup );
 htp.formhidden( 'P4', null ); -- was used, not now, kept for expansion
 htp.formhidden( 'P7', null ); -- was used, not now, kept for expansion

 htp.tableopen( cattributes=>'class="str3_int"' );
  htp.tablerowopen;
  htp.tableheader( 'Convoy Details', cattributes=>'class="str1_hd_left"');
  ctr := 0;
  fctr := 0;
  for c2rec in c2(vpk) loop
   ctr := ctr + 1;
   htp.tableheader( ctr, cattributes=>'class="str1_hd_left"' );
  end loop;
  if ctr >= 16
   then
    null;
  elsif ctr = 15
   then
    htp.tableheader( '16', cattributes=>'class="str1_hd_left"' );
  else
    htp.tableheader( to_char(ctr+1), cattributes=>'class="str1_hd_left"' );
    htp.tableheader( to_char(ctr+2), cattributes=>'class="str1_hd_left"' );
  end if;
  htp.tablerowclose;

  htp.tablerowopen;
   htp.tableheader( 'Truck/Tankers', cattributes=>'class="str1_hd_left"');
   for c2rec in c2(vpk) loop
     htp.p( '<TD ' || 'class="str1_bg_left">' );
     htp.formhidden( 'P0', replace(c2rec.rowid,'+','~'));
     htp.formselectopen( 'P1' );
      if nvl(c2rec.truck_tanker,'TRUCK') = 'TRUCK'
       then
        htp.formselectoption( 'TRUCK', 'SELECTED' );
       else
        htp.formselectoption( 'TRUCK' );
      end if;
      if c2rec.truck_tanker = 'TANKER'
       then
        htp.formselectoption( 'TANKER', 'SELECTED' );
       else
        htp.formselectoption( 'TANKER' );
      end if;
      htp.formselectoption( 'Delete' );
     htp.formselectclose;
     htp.p( '</TD>' );
   end loop;
   if ctr >= 16
    then
     null;
   elsif ctr = 15
    then
     htp.p( '<TD ' || 'class="str1_bg_left">' );
     htp.formhidden( 'P0', null);
     htp.formselectopen( 'P1' );
        htp.formselectoption( null, 'SELECTED' );
        htp.formselectoption( 'TRUCK' );
        htp.formselectoption( 'TANKER' );
     htp.formselectclose;
     htp.p( '</TD>' );
   else
     htp.p( '<TD ' || 'class="str1_bg_left">' );
     htp.formhidden( 'P0', null);
     htp.formselectopen( 'P1' );
        htp.formselectoption( null, 'SELECTED' );
        htp.formselectoption( 'TRUCK' );
        htp.formselectoption( 'TANKER' );
     htp.formselectclose;
     htp.p( '</TD>' );
     htp.p( '<TD ' || 'class="str1_bg_left">' );
     htp.formhidden( 'P0', null);
     htp.formselectopen( 'P1' );
        htp.formselectoption( null, 'SELECTED' );
        htp.formselectoption( 'TRUCK' );
        htp.formselectoption( 'TANKER' );
     htp.formselectclose;
     htp.p( '</TD>' );
   end if;
  htp.tablerowclose;

  htp.tablerowopen;
   htp.tableheader( 'Truck ID', cattributes=>'class="str1_hd_left"');
   for c2rec in c2(vpk) loop
    htp.p( '<td class="str1_bg_left">' );
    htp.formselectopen( 'P2', cattributes=>'id="truck' || c2%ROWCOUNT || '"' );
    htp.formselectoption( null );
    for c8rec in c8( 'TRUCKS' ) loop
     if c8rec.code = c2rec.truck_id
      then
       htp.formselectoption( c8rec.code, 'SELECTED' );
      else
       htp.formselectoption( c8rec.code );
     end if;
    end loop;
    htp.formselectclose;
    htp.p( '</td >' );
   end loop;
   if ctr >= 16
    then
     null;
   elsif ctr = 15
    then
    htp.p( '<td class="str1_bg_left">' );
    htp.formselectopen( 'P2', cattributes=>'id="truck' || '16' || '"' );
    htp.formselectoption( null );
    for c8rec in c8( 'TRUCKS' ) loop
       htp.formselectoption( c8rec.code );
    end loop;
    htp.formselectclose;
    htp.p( '</td >' );
   else
    htp.p( '<td class="str1_bg_left">' );
    htp.formselectopen( 'P2', cattributes=>'id="truck' || to_char(ctr+1) || '"' );
    htp.formselectoption( null );
    for c8rec in c8( 'TRUCKS' ) loop
       htp.formselectoption( c8rec.code );
    end loop;
    htp.formselectclose;
    htp.p( '</td >' );
    htp.p( '<td class="str1_bg_left">' );
    htp.formselectopen( 'P2', cattributes=>'id="truck' || to_char(ctr+2) || '"' );
    htp.formselectoption( null );
    for c8rec in c8( 'TRUCKS' ) loop
       htp.formselectoption( c8rec.code );
    end loop;
    htp.formselectclose;
    htp.p( '</td >' );
   end if;
  htp.tablerowclose;

  htp.tablerowopen;
   htp.tableheader( 'Trailer ID', cattributes=>'class="str1_hd_left"');
   for c2rec in c2(vpk) loop
    htp.p( '<td class="str1_bg_left">' );
    htp.formselectopen( 'P3', cattributes=>'id="trailer' || to_char(c2%ROWCOUNT) || '" onchange="popcapacity(document.getElementById(''trailer' || to_char(c2%ROWCOUNT) || '''), ''strangp.popcapacity?surl=' || surl || '&vpk=' || vpk || '&rnd='' + new Date().getTime() + ''&cdet='', ''' || 'icapacity' || to_char(c2%ROWCOUNT) || ''')"' );
    htp.formselectoption( null );
    for c8rec in c8( 'TRAILERS' ) loop
     if c8rec.code = c2rec.trailer_id
      then
       htp.formselectoption( c8rec.code, 'SELECTED' );
      else
       htp.formselectoption( c8rec.code );
     end if;
    end loop;
    htp.formselectclose;
    htp.p( '</td >' );
   end loop;
   if ctr >= 16
    then
     null;
   elsif ctr = 15
    then
    htp.p( '<td class="str1_bg_left">' );
    htp.formselectopen( 'P3', cattributes=>'id="trailer' || to_char(ctr+2) || '" onchange="popcapacity(document.getElementById(''trailer' || '16' || '''), ''strangp.popcapacity?surl=' || surl || '&vpk=' || vpk || '&rnd='' + new Date().getTime() + ''&cdet='', ''' || 'icapacity' || '16' || ''')"' );
    htp.formselectoption( null );
    for c8rec in c8( 'TRAILERS' ) loop
       htp.formselectoption( c8rec.code );
    end loop;
    htp.formselectclose;
    htp.p( '</td >' );
   else
    htp.p( '<td class="str1_bg_left">' );
    htp.formselectopen( 'P3', cattributes=>'id="trailer' || to_char(ctr+1) || '" onchange="popcapacity(document.getElementById(''trailer' || to_char(ctr+2) || '''), ''strangp.popcapacity?surl=' || surl || '&vpk=' || vpk || '&rnd='' + new Date().getTime() + ''&cdet='', ''' || 'icapacity' || to_char(ctr+1) || ''')"' );
    htp.formselectoption( null );
    for c8rec in c8( 'TRAILERS' ) loop
       htp.formselectoption( c8rec.code );
    end loop;
    htp.formselectclose;
    htp.p( '</td >' );
    htp.p( '<td class="str1_bg_left">' );
    htp.formselectopen( 'P3', cattributes=>'id="trailer' || to_char(ctr+2) || '" onchange="popcapacity(document.getElementById(''trailer' || to_char(ctr+2) || '''), ''strangp.popcapacity?surl=' || surl || '&vpk=' || vpk || '&rnd='' + new Date().getTime() + ''&cdet='', ''' || 'icapacity' || to_char(ctr+2) || ''')"' );
    htp.formselectoption( null );
    for c8rec in c8( 'TRAILERS' ) loop
       htp.formselectoption( c8rec.code );
    end loop;
    htp.formselectclose;
    htp.p( '</td >' );
   end if;
  htp.tablerowclose;

  htp.tablerowopen;
   htp.tableheader( 'Trailer Load Capacity', cattributes=>'class="str1_hd_left"');
   for c2rec in c2(vpk) loop
    htp.p( '<td>' );
     c5rec := null;
     open c5(c2rec.trailer_id);
     fetch c5 into c5rec;
     close c5;
     htp.p( '<div id="icapacity' || c2%ROWCOUNT || '">' || c5rec.colb || '</div>' );
    htp.p( '</td>' );
   end loop;
   if ctr >= 16
    then
     null;
   elsif ctr = 15
    then
    htp.p( '<td>' );
     htp.p( '<div id="icapacity' || '16' || '">' || '</div>' );
    htp.p( '</td>' );
   else
    htp.p( '<td>' );
     htp.p( '<div id="icapacity' || to_char(ctr+1) || '">' || '</div>' );
    htp.p( '</td>' );
    htp.p( '<td>' );
     htp.p( '<div id="icapacity' || to_char(ctr+2) || '">' || '</div>' );
    htp.p( '</td>' );
   end if;
  htp.tablerowclose;

  htp.tablerowopen;
   htp.tableheader( 'Operator', cattributes=>'class="str1_hd_left"');
   for c2rec in c2(vpk) loop
    htp.p( '<td class="str1_bg_left">' );
    htp.formselectopen( 'P5' );
    htp.formselectoption( null );
    for c8rec in c8( 'OPERATORS' ) loop
     if c8rec.cola || ' ' || c8rec.code = c2rec.operator_1
      then
       htp.formselectoption( c8rec.cola || ' ' || c8rec.code, 'SELECTED' );
      else
       htp.formselectoption( c8rec.cola || ' ' || c8rec.code );
     end if;
    end loop;
    htp.formselectclose;
    htp.p( '</td >' );
   end loop;
   if ctr >= 16
    then
     null;
   elsif ctr = 15
    then
    htp.p( '<td class="str1_bg_left">' );
    htp.formselectopen( 'P5' );
    htp.formselectoption( null );
    for c8rec in c8( 'OPERATORS' ) loop
       htp.formselectoption( c8rec.cola || ' ' || c8rec.code );
    end loop;
    htp.formselectclose;
    htp.p( '</td >' );
   else
    htp.p( '<td class="str1_bg_left">' );
    htp.formselectopen( 'P5' );
    htp.formselectoption( null );
    for c8rec in c8( 'OPERATORS' ) loop
       htp.formselectoption( c8rec.cola || ' ' || c8rec.code );
    end loop;
    htp.formselectclose;
    htp.p( '</td >' );
    htp.p( '<td class="str1_bg_left">' );
    htp.formselectopen( 'P5' );
    htp.formselectoption( null );
    for c8rec in c8( 'OPERATORS' ) loop
       htp.formselectoption( c8rec.cola || ' ' || c8rec.code );
    end loop;
    htp.formselectclose;
    htp.p( '</td >' );
   end if;
  htp.tablerowclose;

  htp.tablerowopen;
   htp.tableheader( 'Convoy Section', cattributes=>'class="str1_hd_left"');
   for c2rec in c2(vpk) loop
     htp.p( '<TD ' || 'class="str1_bg_left">' );
     htp.formselectopen( 'P6' );
     for j in 1..nvl(srec.convoy_no,1) loop
      if to_char(j) = nvl(c2rec.convoy_section,'1')
       then
        htp.formselectoption( to_char(j), 'SELECTED' );
       else
        htp.formselectoption( to_char(j) );
      end if;
     end loop;
     htp.formselectclose;
     htp.p( '</TD>' );
   end loop;
   if ctr >= 16
    then
     null;
   elsif ctr = 15
    then
     htp.p( '<TD ' || 'class="str1_bg_left">' );
     htp.formselectopen( 'P6' );
      htp.formselectoption( null );
      for j in 1..nvl(srec.convoy_no,1) loop
        htp.formselectoption( j );
      end loop;
     htp.formselectclose;
     htp.p( '</TD>' );
   else
     htp.p( '<TD ' || 'class="str1_bg_left">' );
     htp.formselectopen( 'P6' );
      htp.formselectoption( null );
      for j in 1..nvl(srec.convoy_no,1) loop
        htp.formselectoption( j );
      end loop;
     htp.formselectclose;
     htp.p( '</TD>' );
     htp.p( '<TD ' || 'class="str1_bg_left">' );
     htp.formselectopen( 'P6' );
      htp.formselectoption( null );
      for j in 1..nvl(srec.convoy_no,1) loop
        htp.formselectoption( j );
      end loop;
     htp.formselectclose;
     htp.p( '</TD>' );
   end if;
  htp.tablerowclose;

  htp.tablerowopen;
   htp.tableheader( 'Masterplan', cattributes=>'class="str1_hd_left"');
   for c2rec in c2(vpk) loop
    htp.tabledata( c2rec.masterplan );
   end loop;
   if ctr >= 16
    then
     null;
   elsif ctr = 15
    then
     htp.tabledata( '&nbsp;' );
   else
     htp.tabledata( '&nbsp;' );
     htp.tabledata( '&nbsp;' );
   end if;
  htp.tablerowclose;

  htp.tablerowopen;
   htp.tableheader( 'Weighbridge', cattributes=>'class="str1_hd_left"');
   for c2rec in c2(vpk) loop
    htp.tabledata( htf.formtext( 'P8', 8, 10, html_format(c2rec.weighbridge)) );
   end loop;
   if ctr >= 16
    then
     null;
   elsif ctr = 15
    then
     htp.tabledata( htf.formtext( 'P8', 8, 10, null) );
   else
     htp.tabledata( htf.formtext( 'P8', 8, 10, null) );
     htp.tabledata( htf.formtext( 'P8', 8, 10, null) );
   end if;
  htp.tablerowclose;

  htp.tablerowopen;
   htp.tableheader( 'Movements', cattributes=>'class="str1_hd_left"');
   for c2rec in c2(vpk) loop
    htp.p( '<td>' );
     for c6rec in c6(c2rec.ship_id,c2rec.truck_id) loop
      htp.formhidden( 'PM1', replace(c2rec.rowid,'+','~'));
      fctr := fctr + 1;
      htp.formtext( 'PM2', 15, 40, c6rec.movement_no, cattributes=>'id="f' || fctr || '"');
      htp.formhidden( 'PM3', c6rec.seal, cattributes=>'id="s' || fctr || '"');
      htp.p( htf.anchor('#','[L]', cattributes=>'onclick=''window.open( "strangp.mv_popup?surl=' || surl || '&vpk=' || vpk || '&fctr=' || fctr || '&cdet=' || c2rec.truck_tanker || '&ctrl=" + document.getElementById("truck' || c2%ROWCOUNT || '").value,"MPOPUP","toolbar=no,location=no,status=no,menubar=noscrollbars=yes,resizable=yes,width=1200,height=600");void("");''' ) );
      htp.nl;
     end loop;
     if nvl(c2rec.truck_tanker,'TRUCK') = 'TRUCK'
      then
        htp.formhidden( 'PM1', null);
        fctr := fctr + 1;
        htp.formtext( 'PM2', 15, 40, null, cattributes=>'id="f' || fctr || '"');
        htp.formhidden( 'PM3', null, cattributes=>'id="s' || fctr || '"');
        htp.p( htf.anchor('#','[L]', cattributes=>'onclick=''window.open( "strangp.mv_popup?surl=' || surl || '&vpk=' || vpk || '&fctr=' || fctr || '&cdet=' || null || '&ctrl=" + document.getElementById("truck' || c2%ROWCOUNT || '").value,"MPOPUP","toolbar=no,location=no,status=no,menubar=noscrollbars=yes,resizable=yes,width=1200,height=600");void("");''' ) );
        htp.nl;
        htp.formhidden( 'PM1', null);
        fctr := fctr + 1;
        htp.formtext( 'PM2', 15, 40, null, cattributes=>'id="f' || fctr || '"');
        htp.formhidden( 'PM3', null, cattributes=>'id="s' || fctr || '"');
        htp.p( htf.anchor('#','[L]', cattributes=>'onclick=''window.open( "strangp.mv_popup?surl=' || surl || '&vpk=' || vpk || '&fctr=' || fctr || '&cdet=' || null || '&ctrl=" + document.getElementById("truck' || c2%ROWCOUNT || '").value,"MPOPUP","toolbar=no,location=no,status=no,menubar=noscrollbars=yes,resizable=yes,width=1200,height=600");void("");''' ) );
        htp.formhidden( 'PM1','END'); htp.formhidden( 'PM2','END'); htp.formhidden( 'PM3','END');
       else
        htp.formhidden( 'PM1','END'); htp.formhidden( 'PM2','END'); htp.formhidden( 'PM3','END');
      end if;
    htp.p( '</td>' );
   end loop;
   if ctr >= 16
    then
     null;
   elsif ctr = 15
    then
     htp.p( '<td>' );
       htp.formhidden( 'PM1', null);
       fctr := fctr + 1;
       htp.formtext( 'PM2', 15, 40, null, cattributes=>'id="f' || fctr || '"');
       htp.formhidden( 'PM3', null, cattributes=>'id="s' || fctr || '"');
       htp.p( htf.anchor('#','[L]', cattributes=>'onclick=''window.open( "strangp.mv_popup?surl=' || surl || '&vpk=' || vpk || '&fctr=' || fctr || '&cdet=' || null || '&ctrl=" + document.getElementById("truck' || '16' || '").value,"MPOPUP","toolbar=no,location=no,status=no,menubar=noscrollbars=yes,resizable=yes,width=1200,height=600");void("");''' ) );
       htp.formhidden( 'PM1','END'); htp.formhidden( 'PM2','END'); htp.formhidden( 'PM3','END');
     htp.p( '</td>' );
   else
     htp.p( '<td>' );
       htp.formhidden( 'PM1', null);
       fctr := fctr + 1;
       htp.formtext( 'PM2', 15, 40, null, cattributes=>'id="f' || fctr || '"');
       htp.formhidden( 'PM3', null, cattributes=>'id="s' || fctr || '"');
       htp.p( htf.anchor('#','[L]', cattributes=>'onclick=''window.open( "strangp.mv_popup?surl=' || surl || '&vpk=' || vpk || '&fctr=' || fctr || '&cdet=' || null || '&ctrl=" + document.getElementById("truck' || to_char(ctr+1) || '").value,"MPOPUP","toolbar=no,location=no,status=no,menubar=noscrollbars=yes,resizable=yes,width=1200,height=600");void("");''' ) );
      htp.p( '</td>' );
      htp.p( '<td>' );
       htp.formhidden( 'PM1', null);
       fctr := fctr + 1;
       htp.formtext( 'PM2', 15, 40, null, cattributes=>'id="f' || fctr || '"');
       htp.formhidden( 'PM3', null, cattributes=>'id="s' || fctr || '"');
       htp.p( htf.anchor('#','[L]', cattributes=>'onclick=''window.open( "strangp.mv_popup?surl=' || surl || '&vpk=' || vpk || '&fctr=' || fctr || '&cdet=' || null || '&ctrl=" + document.getElementById("truck' || to_char(ctr+2) || '").value,"MPOPUP","toolbar=no,location=no,status=no,menubar=noscrollbars=yes,resizable=yes,width=1200,height=600");void("");''' ) );
       htp.formhidden( 'PM1','END'); htp.formhidden( 'PM2','END'); htp.formhidden( 'PM3','END');
     htp.p( '</td>' );
   end if;
  htp.tablerowclose;

  htp.tablerowopen;
   htp.tableheader( 'Fuel Pump', cattributes=>'class="str1_hd_left"');
   for c2rec in c2(vpk) loop
    htp.p( '<td class="str1_bg_left">' );
    htp.formselectopen( 'P9' );
    htp.formselectoption( null );
    for c8rec in c8( 'FUEL PUMPS' ) loop
     if c8rec.code = c2rec.fuel_pump
      then
       htp.formselectoption( c8rec.code, 'SELECTED' );
      else
       htp.formselectoption( c8rec.code );
     end if;
    end loop;
    htp.formselectclose;
    htp.p( '</td >' );
   end loop;
   if ctr >= 16
    then
     null;
   elsif ctr = 15
    then
    htp.p( '<td class="str1_bg_left">' );
    htp.formselectopen( 'P9' );
    htp.formselectoption( null );
    for c8rec in c8( 'FUEL PUMPS' ) loop
       htp.formselectoption( c8rec.code );
    end loop;
    htp.formselectclose;
    htp.p( '</td >' );
   else
    htp.p( '<td class="str1_bg_left">' );
    htp.formselectopen( 'P9' );
    htp.formselectoption( null );
    for c8rec in c8( 'FUEL PUMPS' ) loop
       htp.formselectoption( c8rec.code );
    end loop;
    htp.formselectclose;
    htp.p( '</td >' );
    htp.p( '<td class="str1_bg_left">' );
    htp.formselectopen( 'P9' );
    htp.formselectoption( null );
    for c8rec in c8( 'FUEL PUMPS' ) loop
       htp.formselectoption( c8rec.code );
    end loop;
    htp.formselectclose;
    htp.p( '</td >' );
   end if;
  htp.tablerowclose;

  htp.tablerowopen;
   htp.tableheader( 'Fuel Type', cattributes=>'class="str1_hd_left"');
   for c2rec in c2(vpk) loop
    htp.tabledata( htf.formtext( 'P10', 15, 20, html_format(c2rec.fuel_type)) );
   end loop;
   if ctr >= 16
    then
     null;
   elsif ctr = 15
    then
     htp.tabledata( htf.formtext( 'P10', 15, 20, null) );
   else
     htp.tabledata( htf.formtext( 'P10', 15, 20, null) );
     htp.tabledata( htf.formtext( 'P10', 15, 20, null) );
   end if;
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tableheader( 'Fuel Litres', cattributes=>'class="str1_hd_left"');
   for c2rec in c2(vpk) loop
    htp.tabledata( htf.formtext( 'P11', 8, 10, html_format(c2rec.fuel_litres)) );
   end loop;
   if ctr >= 16
    then
     null;
   elsif ctr = 15
    then
     htp.tabledata( htf.formtext( 'P11', 8, 10, null) );
   else
     htp.tabledata( htf.formtext( 'P11', 8, 10, null) );
     htp.tabledata( htf.formtext( 'P11', 8, 10, null) );
   end if;
  htp.tablerowclose;

 htp.tableclose;
 htp.nl;
  if vaccess = 'EDIT'
   then
    htp.formsubmit( 'ACTION','Modify Convoy Details');
    htp.formclose;
  end if;

/*
 SHIP_ID                                            NUMBER(16)
 TRUCK_TANKER                                       VARCHAR2(6)
 TRUCK_ID                                           VARCHAR2(20)
 TRAILER_ID                                         VARCHAR2(20)
 WEIGHBRIDGE                                        NUMBER
 TYPE                                               VARCHAR2(100)
 OPERATOR_1                                         VARCHAR2(100)
	 CONVOY_SECTION                                     NUMBER
	 FUEL_TYPE                                          VARCHAR2(20)
 FUEL_LITRES                                        NUMBER(11,3)
 MASTERPLAN                                         VARCHAR2(20)
 FUEL_PUMP                                          VARCHAR2(20)
 CONVOY_LINE_NO                                     NUMBER(38)
*/

 if ispopup = 'T' then htp.nl; htp.nl; htp.bold( '<a href="" onClick="self.close()">' || LNG.GLB_TXT_033 || '</a>'); end if;
 htp.p( '</CENTER>' );
 htp.htmlclose;
exception when others then
 error_details( 'STRANGP', 'CONVOY',null,null,errmsg=>sqlerrm,extdet=>'PARM:' || parm);
end convoy;

function movement_ins_upd(vship in integer, vtruck varchar2, vrowid varchar2, mno in varchar2, mseal varchar2, mvtype varchar2, k integer)
 return varchar2
as

 cursor c1(mno varchar2, mseal varchar2) is select m.* from strang.movements m where movement_no = mno and nvl(seal,'|') = nvl(mseal,'|');
 cursor c2(vshp integer, vtrk varchar2) is select m.* from strang.movements m where convoy_id = vshp and truck_id = vtrk;

 c1rec strang.movements%ROWTYPE;

begin
 if vship is null or vtruck is null then return( htf.nl || '[' || k || '. Null values encountered Ship=' || vship || ', Truck=' || vtruck || ']' ); end if; -- safety
 if mno is null
  then
   open c2(vship, vtruck);
   fetch c2 into c1rec;
   close c2;
  else
   open c1(mno, mseal);
   fetch c1 into c1rec;
   close c1;
 end if;
 if mno is null and (c1rec.convoy_id = vship and c1rec.truck_id = vtruck)
  then
   update strang.movements set truck_id = null, convoy_id = null, interface4_date = null where convoy_id = vship and truck_id = vtruck;
   return( htf.nl || 'Movement removed from ' || vtruck );
 end if;
 if mno is null then return( null ); end if;
 if (c1rec.convoy_id = vship and c1rec.truck_id = vtruck)
  then
   return( null );
 elsif (c1rec.truck_id is not null)
  then
   return( htf.nl || '[' || k || '. Movement already assigned to (' || mno || ')(' || c1rec.truck_id || ')(' || vtruck || ')(' || vship || ')(' || c1rec.convoy_id || ')]' );
 end if;
 c1rec.convoy_id := vship;
 --c1rec.movement_type := mvtype;
 c1rec.truck_id := vtruck;
 c1rec.interface4_date := null;
 update strang.movements set row = c1rec where movement_no = mno and nvl(seal,'|') = nvl(mseal,'|');
 return( null );
end movement_ins_upd;

procedure accept_convoy(surl in varchar2, vpk in integer, p0 in owa.vc_arr, p1 in owa.vc_arr, p2 in owa.vc_arr, p3 in owa.vc_arr, p4 in owa.vc_arr, p5 in owa.vc_arr, p6 in owa.vc_arr, p7 in owa.vc_arr, p8 in owa.vc_arr, p9 in owa.vc_arr, p10 in owa.vc_arr, p11 in owa.vc_arr, pm1 in owa.vc_arr, pm2 in owa.vc_arr, pm3 in owa.vc_arr, action in varchar2, ispopup in char default 'F')
as

 cursor c1(vpk integer) is select * from strang.ships_airway where ship_id = vpk;

 srec		c1%ROWTYPE;
 crec		strang.convoy_details%ROWTYPE;
 parm		varchar2(1000);
 vaccess	varchar2(20);
 ttl		varchar2(200);
 seclevel	varchar2(100);
 vste		varchar2(10);
 vrid		rowid;
 stp		varchar2(1000);
 x		integer;
 y		integer;
 vmsg		varchar2(4000);

begin
 if not dapi.init( surl, 'STRANGP.ACCEPT_CONVOY', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'ACCEPT_CONVOY');
    return;
 end if;

 vste := customer_state(dapi.GLOBAL_ACCOUNT.acctid);
 vaccess := data_access( 'SHP' ); -- this is a guess
 seclevel := security_role( dapi.GLOBAL_ACCOUNT.acctid );

 open c1(vpk);
 fetch c1 into srec;
 close c1;

 for j in p1.first..p1.last loop
  crec := null;
  crec.ship_id 	:= vpk;
  stp := 'a1';
  crec.truck_tanker    := p1(j);
  stp := 'a2';
  crec.truck_id        := p2(j);
  stp := 'a3';
  crec.trailer_id      := p3(j);
  stp := 'a4';
--  crec.type            := p4(j);
--  stp := 'a5';
  crec.operator_1      := p5(j);
  stp := 'a6';
  crec.convoy_section  := gl.guess_number(p6(j));
  stp := 'a7';
  --crec.masterplan      := p7(j);
  stp := 'a8';
  crec.weighbridge     := gl.guess_number(p8(j));
  stp := 'a9';
  crec.fuel_pump       := p9(j);
  stp := 'aa';
  crec.fuel_type       := p10(j);
  stp := 'ab';
  crec.fuel_litres     := gl.guess_number(p11(j));
  if j > 1
   then
    for k in p1.first..(j-1) loop
     if p5(j) = p5(k) then crec.operator_1 := null; vmsg := vmsg || '[' || j || '. Operator ' || p5(k) || ' already assigned]'; end if;
     if p3(j) = p3(k) then crec.trailer_id := 'Bad'; vmsg := vmsg || '[' || j || '. Trailer ' || p3(k) || ' already assigned]';  end if;
     if p2(j) = p2(k) then crec.truck_id := 'Bad'; vmsg := vmsg || '[' || j || '. Truck ' || p2(k) || ' already assigned]';  end if;
    end loop;
  end if;

  stp := 'ac';
  if p2(j) is null and p3(j) is null and p1(j) in ('TANKER','TRUCK')
   then
    vmsg := vmsg || '[' || j || '. Truck or Trailer must be specified]';
  end if;
  stp := 'ad';
  if p5(j) is null and p1(j) in ('TANKER','TRUCK')
   then
    vmsg := vmsg || '[' || j || '. Operator must be specified]';
  end if;

  stp := 'ae';
  if p0(j) is null -- rowid
   then
    -- new record
    stp := 'af';
    if p1(j) in ('TANKER','TRUCK')
     then
      if p1(j) = 'TANKER' and p11(j) is not null and p10(j) is null then crec.fuel_type := 'DIESEL'; end if;
      insert into strang.convoy_details values crec;
    end if;

   else
    -- update
    stp := 'ag';
    if p1(j) in ('TANKER','TRUCK')
     then
      if p1(j) = 'TANKER' and p11(j) is not null and p10(j) is null then crec.fuel_type := 'DIESEL'; end if;
      vrid := p0(j);
      update strang.convoy_details set row = crec where rowid = vrid;
     elsif p1(j) = 'Delete'
      then
       update strang.movements set truck_id = null, convoy_id = null, interface4_date = null where convoy_id = vpk and truck_id in (select truck_id from strang.convoy_details where rowid = vrid);
       delete from strang.convoy_details where rowid = vrid;
       vmsg := vmsg || '[Truck/Trailer ' || p2(j) || ':' || p3(j) || ' Deleted]';
    end if;

  end if;
  commit;
 end loop;

 stp := 'b1';
 for k in p2.first..p2.last loop
  x := (k-1);
  if x > 0
   then
    y := 0;
    for z in pm1.first..pm1.last loop
     if pm1(z) = 'END' then y := y + 1; if y = x then x := z+1; exit; end if; end if;
    end loop;
   else
    x := pm1.first;
  end if;
  if x >= pm1.last then exit; end if;
  stp := 'b2';
  for j in x..pm1.last loop
   if p2(k) is null or (pm1(j) is null and pm2(j) is null)
    then
     null;
   elsif pm1(j) = 'END'
    then
     exit;
   else
    stp := 'b3';
    vmsg := vmsg || movement_ins_upd(vpk,p2(k),pm1(j),pm2(j),pm3(j),'CONMOV',k);
    --gl.dbg( p2(k) || '[' || pm1(j) || '][' || pm2(j) || '][' || pm3(j) || ']' );
   end if;
  end loop;
 end loop;

 stp := 'c1';
 convoy(surl, vpk, nvl(vmsg,'Convoy Details Modified'), ispopup);

exception when others then
 error_details( 'STRANGP', 'ACCEPT_CONVOY',null,null,errmsg=>sqlerrm,extdet=>'PARM:' || parm || '[' || stp || ']');
end accept_convoy;

procedure masterplan_read(surl in varchar2, start_date in date, msg in varchar2 default null)
as

 cursor c2(sd date, vtank in varchar2, k in integer) is
  select a.*
  from
  (
   select rownum rnum, c.rowid rid, c.truck_id, c.trailer_id, c.fuel_type, c.fuel_litres, c.operator_1, s.estdepart, s.ship_id
   from strang.convoy_details c, strang.ships_airway s
   where s.estdepart between sd and sd+6 and
         s.ship_id = c.ship_id and
         s.ship_airway = 'C'
   order by s.estdepart,decode(c.truck_tanker,'TRUCK',0,'TANKER',1,2),c.truck_id,c.trailer_id
  ) a
  where rnum = k;
 cursor c6(vpk integer, vtrk varchar2) is select m.* from strang.movements m where convoy_id = vpk and upper(trim(truck_id)) = upper(trim(vtrk)) order by m.movement_no;
 cursor c9(vdt date) is select * from strang.ships_airway where estdepart = vdt and ship_airway = 'C';

 c9rec		c9%ROWTYPE;
 sts		varchar2(100);
 vaccess	varchar2(20);
 ttl		varchar2(200);
 seclevel	varchar2(100);
 vste		varchar2(10);
 v_link 	varchar2(1000);
 vurl		varchar2(4000);
 rctr		integer;
 last_rid	varchar2(100);
 parm		varchar2(1000);
 do_tanker	boolean;
 vtank		varchar2(20);

 function check_any_tanker(do_tanker in boolean, start_date in date, k in integer)
  return boolean
 as

 cursor c2(sd date, k in integer) is
  select count('x') tot
  from
  (
   select rownum rnum, c.truck_tanker
   from strang.convoy_details c, strang.ships_airway s
   where s.estdepart between sd and sd+6 and
         s.ship_id = c.ship_id and
         s.ship_airway = 'C'
   order by s.estdepart,c.truck_id
  ) a
  where rnum = k and truck_tanker = 'TRUCK';

  vtot	integer;

 begin
  if not do_tanker then return( FALSE ); end if; -- doing trailers
  open c2(start_date,k);
  fetch c2 into vtot;
  close c2;
  if vtot > 0 then return( TRUE ); end if;
  return( FALSE );
 end check_any_tanker;

 function check_any_trailer(start_date in date, k in integer)
  return boolean
 as

 cursor c2(sd date, k in integer) is
  select count('x') tot
  from
  (
   select rownum rnum, c.truck_tanker
   from strang.convoy_details c, strang.ships_airway s
   where s.estdepart between sd and sd+6 and
         s.ship_id = c.ship_id and
         s.ship_airway = 'C'
   order by s.estdepart, c.trailer_id
  ) a
  where rnum = k and truck_tanker = 'TANKER';

  vtot	integer;

 begin
  open c2(start_date,k);
  fetch c2 into vtot;
  close c2;
  if vtot > 0 then return( TRUE ); end if;
  return( FALSE );
 end check_any_trailer;

begin
 if not dapi.init( surl, 'STRANGP.MASTERPLAN_READ', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'MASTERPLAN_READ');
    return;
 end if;

 vste := customer_state(dapi.GLOBAL_ACCOUNT.acctid);
 vaccess := data_access( 'SHP' ); -- this is a guess
 seclevel := security_role( dapi.GLOBAL_ACCOUNT.acctid );

 main_title( 'LINE HAUL WEEKLY MASTER PLAN - WK' || to_char(start_date,'WW YYYY'),helpid=>'STR59');

 htp.p( '<CENTER>' );
 if msg is not null then header_msg( msg ); else header_msg( 'LINE HAUL WEEKLY MASTER PLAN - WK' || to_char(start_date,'WW YYYY') ); end if;

 if vaccess = 'NONE' then htp.bold( 'Access Denied' ); htp.htmlclose; return; end if;

 htp.nl;
 htp.tableopen( cattributes=>'class="str1_table"' );
  htp.tablerowopen;
   htp.tabledata( htf.anchor('strangp.masterplan?surl=' || surl || '&start_date=' || to_char(start_date-7,'DD-MON-YYYY'),'&lt;&lt;' || to_char(start_date-7,'WW YYYY')),cattributes=>'class="str1_bg_left"');
   htp.tabledata( htf.anchor('strangp.masterplan?surl=' || surl || '&start_date=' || to_char(start_date+7,'DD-MON-YYYY'),to_char(start_date+7,'WW YYYY') || '&gt;&gt;'),cattributes=>'class="str1_bg_left"');
   htp.tabledata( htf.bold('Saturday'),cattributes=>'class="str1_bg_left"');
   htp.tabledata( htf.bold('Sunday'),cattributes=>'class="str1_bg_left"');
   htp.tabledata( htf.bold('Monday'),cattributes=>'class="str1_bg_left"');
   htp.tabledata( htf.bold('Tuesday'),cattributes=>'class="str1_bg_left"');
   htp.tabledata( htf.bold('Wednesday'),cattributes=>'class="str1_bg_left"');
   htp.tabledata( htf.bold('Thursday'),cattributes=>'class="str1_bg_left"');
   htp.tabledata( htf.bold('Fri'),cattributes=>'class="str1_bg_left"');
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( htf.bold('Load'),cattributes=>'class="str1_bg_left"');
   htp.tabledata( htf.bold('Description'),cattributes=>'class="str1_bg_left"');
   for j in 0..6 loop
    c9rec := null;
    open c9(start_date+j);
    fetch c9 into c9rec;
    close c9;
    if c9rec.ship_id is null
     then
      htp.tabledata( htf.bold(to_char(start_date+j,'dd-Mon-YYYY')) || ' ' || htf.italic('No Convoy'),cattributes=>'class="str1_bg_left"');
     else
      htp.tabledata( htf.bold(to_char(start_date+j,'dd-Mon-YYYY')) || ' ' || htf.italic(c9rec.shipname),cattributes=>'class="str1_bg_left"');
    end if;   end loop;
  htp.tablerowclose;

  do_tanker := TRUE;
  for k in 1..100 loop
   do_tanker := check_any_tanker(do_tanker, start_date, k);
   if not do_tanker
    then
     if not check_any_trailer(start_date, k) then exit; end if;
   end if;
   if do_tanker then vtank := 'TANKER'; else vtank := 'TRAILER'; end if;

   htp.tablerowopen;
    htp.tabledata( 'Load ' || to_char(k),cattributes=>'class="str1_bg_left" rowspan="6"');

      htp.tabledata( htf.bold('Driver'),cattributes=>'class="str1_bg_left"');
       for j in 0..6 loop
	   htp.p( '<td class="str1_bg_left">' );
           for c2rec in c2(start_date+j,vtank,k) loop
		 if c2rec.estdepart = (start_date+j)
		  then
  		   htp.p(nvl(c2rec.operator_1,'&nbsp;'));
		  else
		   htp.p( '&nbsp;');
		 end if;
           end loop;
	   htp.p( '</td>' );
       end loop;
      htp.tablerowclose;

      htp.tablerowopen;
      htp.tabledata( htf.bold('Truck'),cattributes=>'class="str1_bg_left"');
      for j in 0..6 loop
	   htp.p( '<td class="str1_bg_left">' );
           for c2rec in c2(start_date+j,vtank,k) loop
		 if c2rec.estdepart = (start_date+j)
		  then
  		   htp.p(nvl(to_char(c2rec.truck_id),'&nbsp;'));
		  else
		   htp.p( '&nbsp;');
		 end if;
           end loop;
	   htp.p( '</td>' );
      end loop;
      htp.tablerowclose;

      htp.tablerowopen;
      if do_tanker
       then
        htp.tabledata( htf.bold('Tanker'),cattributes=>'class="str1_bg_left"');
        --htp.tabledata( htf.bold('Trailer'),cattributes=>'class="str1_bg_left"');
        for j in 0..6 loop
	   htp.p( '<td class="str1_bg_left">' );
           for c2rec in c2(start_date+j,vtank,k) loop
		 if c2rec.estdepart = (start_date+j)
		  then
  		   htp.p(nvl(to_char(c2rec.trailer_id),'&nbsp;'));
		  else
		   htp.p( '&nbsp;');
		 end if;
           end loop;
	   htp.p( '</td>' );
        end loop;
       else
        htp.tabledata( htf.bold('Trailer'),cattributes=>'class="str1_bg_left"');
        for j in 0..6 loop
	   htp.p( '<td class="str1_bg_left">' );
           for c2rec in c2(start_date+j,vtank,k) loop
		 if c2rec.estdepart = (start_date+j)
		  then
  		   htp.p(nvl(to_char(c2rec.trailer_id),'&nbsp;'));
		  else
		   htp.p( '&nbsp;');
		 end if;
           end loop;
	   htp.p( '</td>' );
       end loop;

      end if;
      htp.tablerowclose;

      htp.tablerowopen;
       htp.tabledata( htf.bold('Movements'),cattributes=>'class="str1_bg_left"');
        for j in 0..6 loop
	   htp.p( '<td class="str1_bg_left">' );
           for c2rec in c2(start_date+j,vtank,k) loop
		 if c2rec.estdepart = (start_date+j)
		  then
		   for c6rec in c6(c2rec.ship_id,c2rec.truck_id) loop
  		    htp.p(nvl(c6rec.movement_no,'&nbsp;') || ' ' || c6rec.seal);
  		    htp.nl;
  		   end loop;
		  else
		   htp.p( '&nbsp;');
		 end if;
           end loop;
	   htp.p( '</td>' );
        end loop;
        htp.tablerowclose;

        htp.tablerowopen;
         htp.tabledata( htf.bold('Fuel Type'),cattributes=>'class="str1_bg_left"');
         for j in 0..6 loop
	   htp.p( '<td class="str1_bg_left">' );
           for c2rec in c2(start_date+j,vtank,k) loop
		 if c2rec.estdepart = (start_date+j)
		  then
  		   htp.p(nvl(c2rec.fuel_type,'&nbsp;'));
		  else
		   htp.p( '&nbsp;');
		 end if;
           end loop;
	   htp.p( '</td>' );
         end loop;
        htp.tablerowclose;

        htp.tablerowopen;
         htp.tabledata( htf.bold('Fuel Litres'),cattributes=>'class="str1_bg_left"');
         for j in 0..6 loop
	   htp.p( '<td class="str1_bg_left">' );
           for c2rec in c2(start_date+j,vtank,k) loop
		 if c2rec.estdepart = (start_date+j)
		  then
  		   htp.p(nvl(to_char(c2rec.fuel_litres),'&nbsp;'));
		  else
		   htp.p( '&nbsp;');
		 end if;
          end loop;
	  htp.p( '</td>' );

      end loop;

      --end if;
   htp.tablerowclose;
  end loop;

 htp.tableclose;
 htp.nl;

 htp.p( '</CENTER>' );
 htp.htmlclose;
exception when others then
 error_details( 'STRANGP', 'MASTERPLAN_READ',null,null,errmsg=>sqlerrm,extdet=>'PARM:' || parm);
end masterplan_read;

procedure masterplan(surl in varchar2, start_date in date, msg in varchar2 default null)
as

 cursor c2(sd date, vtank in varchar2, k in integer) is
  select a.*
  from
  (
   select rownum rnum, c.rowid rid, c.truck_id, c.trailer_id, c.fuel_type, c.fuel_litres, c.operator_1, s.estdepart,s.ship_id,c.truck_tanker
   from strang.convoy_details c, strang.ships_airway s
   where s.estdepart between sd and sd+6 and
         s.ship_id = c.ship_id and
         s.ship_airway = 'C'
   order by s.estdepart,decode(c.truck_tanker,'TRUCK',0,'TANKER',1,2),c.truck_id,c.trailer_id
  ) a
  where rnum = k;
 cursor c5(vtrl varchar2) is select l.colb from strang.lov l, strang.convoy_details c where l.lov_name='TRAILERS' and upper(trim(l.code)) = upper(trim(c.trailer_id)) and upper(trim(c.trailer_id)) = upper(trim(vtrl)) order by colb;
 cursor c6(vpk integer, vtrk varchar2) is select m.* from strang.movements m where convoy_id = vpk and upper(trim(truck_id)) = upper(trim(vtrk)) order by m.movement_no;
 cursor c8(vname varchar2) is select * from strang.lov where lov_name = vname order by code;
 cursor c9(vdt date) is select * from strang.ships_airway where estdepart = vdt and ship_airway = 'C';

 c5rec		c5%ROWTYPE;
 c9rec		c9%ROWTYPE;
 sts		varchar2(100);
 vaccess	varchar2(20);
 ttl		varchar2(200);
 seclevel	varchar2(100);
 vste		varchar2(10);
 v_link 	varchar2(1000);
 vurl		varchar2(4000);
 rctr		integer;
 fctr		integer;
 gctr		integer;
 last_rid	varchar2(100);
 parm		varchar2(1000);
 do_tanker	boolean;
 vtank		varchar2(20);
 xtra		integer;
 frec		boolean;

 function check_any_tanker(do_tanker in boolean, start_date in date, k in integer)
  return boolean
 as

 cursor c2(sd date, k in integer) is
  select count('x') tot
  from
  (
   select rownum rnum, c.truck_tanker
   from strang.convoy_details c, strang.ships_airway s
   where s.estdepart between sd and sd+6 and
         s.ship_id = c.ship_id and
         s.ship_airway = 'C'
   order by s.estdepart,c.truck_id
  ) a
  where rnum = k and truck_tanker = 'TRUCK';

  vtot	integer;

 begin
  if not do_tanker then return( FALSE ); end if; -- doing trailers
  open c2(start_date,k);
  fetch c2 into vtot;
  close c2;
  if vtot > 0 then return( TRUE ); end if;
  return( FALSE );
 end check_any_tanker;

 function check_any_trailer(start_date in date, k in integer)
  return boolean
 as

 cursor c2(sd date, k in integer) is
  select count('x') tot
  from
  (
   select rownum rnum, c.truck_tanker
   from strang.convoy_details c, strang.ships_airway s
   where s.estdepart between sd and sd+6 and
         s.ship_id = c.ship_id and
         s.ship_airway = 'C'
   order by s.estdepart, c.trailer_id
  ) a
  where rnum = k and truck_tanker = 'TANKER';

  vtot	integer;

 begin
  open c2(start_date,k);
  fetch c2 into vtot;
  close c2;
  if vtot > 0 then return( TRUE ); end if;
  return( FALSE );
 end check_any_trailer;

begin
 if not dapi.init( surl, 'STRANGP.MASTERPLAN', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'MASTERPLAN');
    return;
 end if;

 vste := customer_state(dapi.GLOBAL_ACCOUNT.acctid);
 vaccess := data_access( 'SHP' ); -- this is a guess
 seclevel := security_role( dapi.GLOBAL_ACCOUNT.acctid );
 if vaccess = 'READ' then masterplan_read(surl, start_date, msg); return; end if;
--xxxxx commented out for testing
 if start_date + 7 < sysdate then masterplan_read(surl, start_date, msg); return; end if;

 main_title( 'LINE HAUL WEEKLY MASTER PLAN - WK' || to_char(start_date,'WW YYYY'),helpid=>'STR59');

 if msg is not null then header_msg( msg ); else header_msg( 'LINE HAUL WEEKLY MASTER PLAN - WK' || to_char(start_date,'WW YYYY') ); end if;

 if vaccess = 'NONE' then htp.bold( 'Access Denied' ); htp.htmlclose; return; end if;

 htp.formopen( '!strangp.accept_masterplan_shp' );
 htp.formhidden( 'SURL', surl );
 htp.formhidden( 'START_DATE', to_char(start_date,'DD-MON-YYYY') );

 htp.tableopen( cattributes=>'class="str1_table"' );
  htp.tablerowopen;
   htp.tabledata( htf.anchor('strangp.masterplan?surl=' || surl || '&start_date=' || to_char(start_date-7,'DD-MON-YYYY'),'&lt;&lt;' || to_char(start_date-7,'WW YYYY')),cattributes=>'class="str1_bg_left"');
   htp.tabledata( htf.anchor('strangp.masterplan?surl=' || surl || '&start_date=' || to_char(start_date+7,'DD-MON-YYYY'),to_char(start_date+7,'WW YYYY') || '&gt;&gt;'),cattributes=>'class="str1_bg_left"');
   htp.tabledata( htf.bold('Saturday'),cattributes=>'class="str1_bg_left"');
   htp.tabledata( htf.bold('Sunday'),cattributes=>'class="str1_bg_left"');
   htp.tabledata( htf.bold('Monday'),cattributes=>'class="str1_bg_left"');
   htp.tabledata( htf.bold('Tuesday'),cattributes=>'class="str1_bg_left"');
   htp.tabledata( htf.bold('Wednesday'),cattributes=>'class="str1_bg_left"');
   htp.tabledata( htf.bold('Thursday'),cattributes=>'class="str1_bg_left"');
   htp.tabledata( htf.bold('Fri'),cattributes=>'class="str1_bg_left"');
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( htf.bold('Load') || htf.nl || htf.formsubmit('ACTION', 'Create All Convoys'),cattributes=>'class="str1_bg_left"');
   htp.tabledata( htf.bold('Description'),cattributes=>'class="str1_bg_left"');
   for j in 0..6 loop
    c9rec := null;
    open c9(start_date+j);
    fetch c9 into c9rec;
    close c9;
    htp.p( '<td class="str1_bg_left">');
    if c9rec.ship_id is null
     then
      htp.bold(to_char(start_date+j,'dd-Mon-YYYY'));
      if start_date+j >= sysdate
       then
        htp.formhidden('DT', to_char(start_date+j,'dd-Mon-YYYY'));
        htp.nl;
        htp.p( 'Name Voy ' || to_char(start_date+j,'WW YYYY') || ' ' ||  to_char(start_date+j,'DDMMYYYY') );
        htp.nl;
        htp.p( 'Inb/Outb' );
        htp.formselectopen( 'IO' );
         htp.formselectoption( 'I' );
         htp.formselectoption( 'O' );
        htp.formselectclose;
        htp.nl;
        htp.p( 'Dept ' );
        lov_list( 'LOCATIONS', 'PLOAD', 'KIUNGA', FALSE, TRUE, FALSE );
        htp.nl;
        htp.p( 'Arriv ' );
        lov_list( 'LOCATIONS', 'PDISC', 'TABUBIL', FALSE, TRUE, FALSE );
        htp.nl;
        htp.formhidden('PT', to_char(start_date+j,'dd-Mon-YYYY'));
        htp.formsubmit('ACTION', 'Create ' || trim(to_char(start_date+j,'Day')) || ' Convoy');
      end if;
     else
      htp.p( htf.bold(to_char(start_date+j,'dd-Mon-YYYY')) || ' ' || htf.italic(c9rec.shipname));
    end if;
    if j=6
     then
       htp.formclose;
       htp.formopen( '!strangp.accept_masterplan' );
       htp.formhidden( 'SURL', surl );
       htp.formhidden( 'START_DATE', to_char(start_date,'DD-MON-YYYY') );
       for j in 0..6 loop
        htp.formhidden( 'CALLIB' || to_char(j), to_char(start_date+j,'DD-MON-YYYY') );
       end loop;
    end if;
     htp.p( '</td>' );
   end loop;
  htp.tablerowclose;

  do_tanker := TRUE;
  xtra := 0;
  fctr := 0;
  gctr := 0;

  for k in 1..100 loop
   do_tanker := check_any_tanker(do_tanker, start_date, k);
   if not do_tanker
    then
     if not check_any_trailer(start_date, k)
      then
       xtra := xtra + 1;
       if xtra > 1 then exit; end if;
       -- add spare row for data entry
     end if;
   end if;
   if do_tanker then vtank := 'TANKER'; else vtank := 'TRAILER'; end if;

   htp.tablerowopen;
    htp.tabledata( htf.formhidden( 'PLOAD', to_char(k) ) || 'Load ' || to_char(k),cattributes=>'class="str1_bg_left" rowspan="7"');

      htp.tabledata( htf.bold('Driver'),cattributes=>'class="str1_bg_left"');
       for j in 0..6 loop
	 htp.p( '<td class="str1_bg_left">' );
	 frec := FALSE;
         if start_date+j < sysdate then frec := TRUE; end if;
         for c2rec in c2(start_date+j,vtank,k) loop
          if start_date+j < sysdate
           then
            htp.p(nvl(c2rec.operator_1,'&nbsp;'));
            goto BYPASS_1;
          end if;
          frec := TRUE;
	  if c2rec.estdepart = (start_date+j)
	   then
            htp.formhidden( 'P0', to_char(start_date+j,'DD-MON-YYYY') );
            htp.formhidden( 'P0R', c2rec.rid );
            htp.formselectopen( 'P1' );
            htp.formselectoption( null );
            for c8rec in c8( 'OPERATORS' ) loop
             if c8rec.cola || ' ' || c8rec.code = c2rec.operator_1
              then
               htp.formselectoption( c8rec.cola || ' ' || c8rec.code, 'SELECTED' );
              else
               htp.formselectoption( c8rec.cola || ' ' || c8rec.code );
             end if;
            end loop;
            htp.formselectclose;
	   else
            htp.formhidden( 'P0', to_char(start_date+j,'DD-MON-YYYY') );
            htp.formhidden( 'P0R', null );
            htp.formselectopen( 'P1' );
            htp.formselectoption( null );
            for c8rec in c8( 'OPERATORS' ) loop
             htp.formselectoption( c8rec.cola || ' ' || c8rec.code );
            end loop;
            htp.formselectclose;
	  end if;
         end loop;
         if not frec
          then
            htp.formhidden( 'P0', to_char(start_date+j,'DD-MON-YYYY') );
            htp.formhidden( 'P0R', null );
            htp.formselectopen( 'P1' );
            htp.formselectoption( null );
            for c8rec in c8( 'OPERATORS' ) loop
             htp.formselectoption( c8rec.cola || ' ' || c8rec.code );
            end loop;
            htp.formselectclose;
         end if;
         <<BYPASS_1>>
         null;
	 htp.p( '</td>' );
       end loop;
      htp.tablerowclose;

      htp.tablerowopen;
      htp.tabledata( htf.bold('Truck/Tanker'),cattributes=>'class="str1_bg_left"');
      for j in 0..6 loop
       htp.p( '<td class="str1_bg_left">' );
       frec := FALSE;
       if start_date+j < sysdate then frec := TRUE; end if;
       for c2rec in c2(start_date+j,vtank,k) loop
        if start_date+j < sysdate
         then
          htp.p(nvl(c2rec.truck_tanker,'&nbsp;'));
          goto BYPASS_2;
        end if;
        frec := TRUE;
	if c2rec.estdepart = (start_date+j)
	 then
          htp.formhidden( 'P0', to_char(start_date+j,'DD-MON-YYYY') );
          htp.formhidden( 'P0R', c2rec.rid );
          htp.formselectopen( 'PT');
          if nvl(c2rec.truck_tanker,'TRUCK') = 'TRUCK'
           then
            htp.formselectoption( 'TRUCK', 'SELECTED' );
           else
            htp.formselectoption( 'TRUCK' );
          end if;
          if c2rec.truck_tanker = 'TANKER'
           then
            htp.formselectoption( 'TANKER', 'SELECTED' );
           else
            htp.formselectoption( 'TANKER' );
          end if;
          htp.formselectoption( 'Delete' );
          htp.formselectclose;
	 else
          htp.formhidden( 'P0', to_char(start_date+j,'DD-MON-YYYY') );
          htp.formhidden( 'P0R', null );
          htp.formselectopen( 'PT' );
          htp.formselectoption( null );
            htp.formselectoption( 'TRUCK' );
            htp.formselectoption( 'TANKER' );
          htp.formselectclose;
	end if;
       end loop;
         if not frec
          then
          htp.formhidden( 'P0', to_char(start_date+j,'DD-MON-YYYY') );
          htp.formhidden( 'P0R', null );
          htp.formselectopen( 'PT' );
          htp.formselectoption( null );
            htp.formselectoption( 'TRUCK' );
            htp.formselectoption( 'TANKER' );
          htp.formselectclose;
         end if;
         <<BYPASS_2>>
         null;
       htp.p( '</td>' );
      end loop;
      htp.tablerowclose;

      htp.tablerowopen;
      htp.tabledata( htf.bold('Truck'),cattributes=>'class="str1_bg_left"');
      for j in 0..6 loop
       htp.p( '<td class="str1_bg_left">' );
       frec := FALSE;
       if start_date+j < sysdate then frec := TRUE; end if;
       for c2rec in c2(start_date+j,vtank,k) loop
        if start_date+j < sysdate
         then
          htp.p(nvl(c2rec.truck_id,'&nbsp;'));
          goto BYPASS_3;
        end if;
        frec := TRUE;
	if c2rec.estdepart = (start_date+j)
	 then
          htp.formhidden( 'P0', to_char(start_date+j,'DD-MON-YYYY') );
          htp.formhidden( 'P0R', c2rec.rid );
          gctr := gctr + 1;
          htp.formselectopen( 'P2', cattributes=>'id="truck' || to_char(j) || '"' );
          htp.formselectoption( null );
          for c8rec in c8( 'TRUCKS' ) loop
           if c8rec.code = c2rec.truck_id
            then
             htp.formselectoption( c8rec.code, 'SELECTED' );
            else
             htp.formselectoption( c8rec.code );
           end if;
          end loop;
          htp.formselectclose;
	 else
          htp.formhidden( 'P0', to_char(start_date+j,'DD-MON-YYYY') );
          htp.formhidden( 'P0R', null );
          gctr := gctr + 1;
          htp.formselectopen( 'P2', cattributes=>'id="truck' || to_char(j) || '"' );
          htp.formselectoption( null );
          for c8rec in c8( 'TRUCKS' ) loop
           htp.formselectoption( c8rec.code );
          end loop;
          htp.formselectclose;
	end if;
       end loop;
       if not frec
        then
          htp.formhidden( 'P0', to_char(start_date+j,'DD-MON-YYYY') );
          htp.formhidden( 'P0R', null );
          gctr := gctr + 1;
          htp.formselectopen( 'P2', cattributes=>'id="truck' || to_char(j) || '"' );
          htp.formselectoption( null );
          for c8rec in c8( 'TRUCKS' ) loop
           htp.formselectoption( c8rec.code );
          end loop;
          htp.formselectclose;
       end if;
         <<BYPASS_3>>
         null;
       htp.p( '</td>' );
      end loop;
      htp.tablerowclose;

      htp.tablerowopen;

      if do_tanker
       then
        htp.tabledata( htf.bold('Tanker'),cattributes=>'class="str1_bg_left"');
        for j in 0..6 loop
	 htp.p( '<td class="str1_bg_left">' );
	 frec := FALSE;
         if start_date+j < sysdate then frec := TRUE; end if;
         for c2rec in c2(start_date+j,vtank,k) loop
          if start_date+j < sysdate
           then
            htp.p(nvl(c2rec.trailer_id,'&nbsp;'));
            goto BYPASS_4;
          end if;
          frec := TRUE;
	  if c2rec.estdepart = (start_date+j)
	   then
            htp.formhidden( 'P0', to_char(start_date+j,'DD-MON-YYYY') );
            htp.formhidden( 'P0R', c2rec.rid );
            htp.formselectopen( 'P3' );
            htp.formselectoption( null );
            for c8rec in c8( 'TRAILERS' ) loop
             if c8rec.code = c2rec.trailer_id
              then
               htp.formselectoption( c8rec.code, 'SELECTED' );
              else
               htp.formselectoption( c8rec.code );
            end if;
           end loop;
           htp.formselectclose;
	  else
           htp.formhidden( 'P0', to_char(start_date+j,'DD-MON-YYYY') );
           htp.formhidden( 'P0R', null );
           htp.formselectopen( 'P3' );
           htp.formselectoption( null );
           for c8rec in c8( 'TRAILERS' ) loop
            htp.formselectoption( c8rec.code );
           end loop;
           htp.formselectclose;
	  end if;
         end loop;
       if not frec
        then
           htp.formhidden( 'P0', to_char(start_date+j,'DD-MON-YYYY') );
           htp.formhidden( 'P0R', null );
           htp.formselectopen( 'P3' );
           htp.formselectoption( null );
           for c8rec in c8( 'TRAILERS' ) loop
            htp.formselectoption( c8rec.code );
           end loop;
           htp.formselectclose;
       end if;
         <<BYPASS_4>>
         null;
       htp.p( '</td>' );
        end loop;

       else

        htp.tabledata( htf.bold('Trailer'),cattributes=>'class="str1_bg_left"');
        for j in 0..6 loop
	   htp.p( '<td class="str1_bg_left">' );
	   frec := FALSE;
           if start_date+j < sysdate then frec := TRUE; end if;
           for c2rec in c2(start_date+j,vtank,k) loop
            if start_date+j < sysdate
             then
              htp.p(nvl(c2rec.trailer_id,'&nbsp;'));
              goto BYPASS_5;
            end if;
            frec := TRUE;
	    if c2rec.estdepart = (start_date+j)
	     then
               htp.formhidden( 'P0', to_char(start_date+j,'DD-MON-YYYY') );
               htp.formhidden( 'P0R', c2rec.rid );
               htp.formselectopen( 'P3' );
               htp.formselectoption( null );
               for c8rec in c8( 'TRAILERS' ) loop
                if c8rec.code = c2rec.trailer_id
                 then
                  htp.formselectoption( c8rec.code, 'SELECTED' );
                 else
                  htp.formselectoption( c8rec.code );
               end if;
              end loop;
              htp.formselectclose;
            else
             htp.formhidden( 'P0', to_char(start_date+j,'DD-MON-YYYY') );
             htp.formhidden( 'P0R', null);
             htp.formselectopen( 'P3' );
             htp.formselectoption( null );
             for c8rec in c8( 'TRAILERS' ) loop
              htp.formselectoption( c8rec.code );
             end loop;
             htp.formselectclose;
            end if;
           end loop;
           if not frec
            then
             htp.formhidden( 'P0', to_char(start_date+j,'DD-MON-YYYY') );
             htp.formhidden( 'P0R', null);
             htp.formselectopen( 'P3' );
             htp.formselectoption( null );
             for c8rec in c8( 'TRAILERS' ) loop
              htp.formselectoption( c8rec.code );
             end loop;
             htp.formselectclose;
           end if;
           <<BYPASS_5>>
           null;
	   htp.p( '</td>' );
        end loop;

      end if;
      htp.tablerowclose;

      htp.tablerowopen;
       htp.tabledata( htf.bold('Movement'),cattributes=>'class="str1_bg_left"');
        for j in 0..6 loop
         htp.p( '<td class="str1_bg_left">' );
         frec := FALSE;
	 if start_date+j < sysdate then frec := TRUE; end if;
         for c2rec in c2(start_date+j,vtank,k) loop
            if start_date+j < sysdate
             then
              for c6rec in c6(c2rec.ship_id,c2rec.truck_id) loop
               htp.p( c6rec.movement_no || ' ' || c6rec.seal ); htp.nl;
              end loop;
              goto BYPASS_6;
            end if;
	  if c2rec.estdepart = (start_date+j)
	   then
	    for c6rec in c6(c2rec.ship_id,c2rec.truck_id) loop
             htp.formhidden( 'P0', to_char(start_date+j,'DD-MON-YYYY') );
             htp.formhidden( 'P0R', c2rec.rid );
             fctr := fctr + 1;
             htp.formtext( 'P4M', 12, 20, c6rec.movement_no, cattributes=>'id="f' || fctr || '"');
             htp.formhidden( 'P4MS', c6rec.seal, cattributes=>'id="s' || fctr || '"');
             htp.p( htf.anchor('#','[L]', cattributes=>'onclick=''window.open( "strangp.mv_popup_date?surl=' || surl || '&vdt=' || to_char(start_date+j,'DD-MON-YYYY') || '&fctr=' || fctr || '&cdet=' || c2rec.truck_tanker || '&ctrl=" + document.getElementById("truck' || to_char(j) || '").value,"MPOPUPD","toolbar=no,location=no,status=no,menubar=noscrollbars=yes,resizable=yes,width=1200,height=600");void("");''' ) );
             htp.nl;
            end loop;
	  end if;
         end loop;
         if not frec
          then
           htp.formhidden( 'P0', to_char(start_date+j,'DD-MON-YYYY') );
           htp.formhidden( 'P0R', null );
           fctr := fctr + 1;
           htp.formtext( 'P4M', 12, 20, null, cattributes=>'id="f' || fctr || '"');
           htp.formhidden( 'P4MS', null, cattributes=>'id="s' || fctr || '"');
           htp.p( htf.anchor('#','[L]', cattributes=>'onclick=''window.open( "strangp.mv_popup_date?surl=' || surl || '&vdt=' || to_char(start_date+j,'DD-MON-YYYY') || '&fctr=' || fctr || '&cdet=' || null || '&ctrl=" + document.getElementById("truck' || to_char(j) || '").value,"MPOPUPD","toolbar=no,location=no,status=no,menubar=noscrollbars=yes,resizable=yes,width=1200,height=600");void("");''' ) );
          end if;
           <<BYPASS_6>>
           null;
         htp.p( '</td>' );
        end loop;
        htp.tablerowclose;

        htp.tablerowopen;
        htp.tabledata( htf.bold('Fuel Type'),cattributes=>'class="str1_bg_left"');
         for j in 0..6 loop
	   htp.p( '<td class="str1_bg_left">' );
	   frec := FALSE;
           if start_date+j < sysdate then frec := TRUE; end if;
           for c2rec in c2(start_date+j,vtank,k) loop
            if start_date+j < sysdate
             then
              htp.p(nvl(c2rec.fuel_type,'&nbsp;'));
              goto BYPASS_7;
            end if;
            frec := TRUE;
	    if c2rec.estdepart = (start_date+j)
	     then
              htp.formhidden( 'P0', to_char(start_date+j,'DD-MON-YYYY') );
              htp.formhidden( 'P0R', c2rec.rid );
              htp.formtext( 'P5', 8, 10, html_format(c2rec.fuel_type));
	    else
              htp.formhidden( 'P0', to_char(start_date+j,'DD-MON-YYYY') );
              htp.formhidden( 'P0R', null);
              htp.formtext( 'P5', 8, 10, null);
	    end if;
           end loop;
           if not frec
            then
              htp.formhidden( 'P0', to_char(start_date+j,'DD-MON-YYYY') );
              htp.formhidden( 'P0R', null);
              htp.formtext( 'P5', 8, 10, null);
           end if;
           <<BYPASS_7>>
           null;
	   htp.p( '</td>' );
         end loop;
        htp.tablerowclose;

        htp.tablerowopen;
        htp.tabledata( htf.bold('Fuel Litres'),cattributes=>'class="str1_bg_left"');
        for j in 0..6 loop
	 htp.p( '<td class="str1_bg_left">' );
	 frec := FALSE;
	 if start_date+j < sysdate then frec := TRUE; end if;
         for c2rec in c2(start_date+j,vtank,k) loop
            if start_date+j < sysdate
             then
              htp.p(nvl(to_char(c2rec.fuel_litres),'&nbsp;'));
              goto BYPASS_8;
            end if;
          frec := TRUE;
	  if c2rec.estdepart = (start_date+j)
	   then
            htp.formhidden( 'P0', to_char(start_date+j,'DD-MON-YYYY') );
            htp.formhidden( 'P0R', c2rec.rid );
            htp.formtext( 'P6', 8, 10, html_format(c2rec.fuel_litres));
	   else
            htp.formhidden( 'P0', to_char(start_date+j,'DD-MON-YYYY') );
            htp.formhidden( 'P0R', null );
            htp.formtext( 'P6', 8, 10, null);
	   end if;
          end loop;
          if not frec
           then
            htp.formhidden( 'P0', to_char(start_date+j,'DD-MON-YYYY') );
            htp.formhidden( 'P0R', null );
            htp.formtext( 'P6', 8, 10, null);
          end if;
           <<BYPASS_8>>
           null;
	  htp.p( '</td>' );
        end loop;

   htp.tablerowclose;
  end loop;

 htp.tableclose;
 htp.nl;
  if vaccess = 'EDIT'
   then
    htp.formsubmit( 'ACTION','Modify Master Plan');
    htp.formclose;
  end if;

/*
TX1 PRD1> desc strang.convoy_details
SHIP_ID                                                                                                            NUMBER(16)
TRUCK_TANKER                                                                                                       VARCHAR2(6)
TRUCK_ID                                                                                                           VARCHAR2(20)
TRAILER_ID                                                                                                         VARCHAR2(20)
WEIGHBRIDGE                                                                                                        NUMBER
TYPE                                                                                                               VARCHAR2(100)
OPERATOR_1                                                                                                         VARCHAR2(100)
CONVOY_SECTION                                                                                                     NUMBER
FUEL_TYPE                                                                                                          VARCHAR2(20)
FUEL_LITRES                                                                                                        NUMBER(11,3)
MASTERPLAN                                                                                                         VARCHAR2(20)
*/

 htp.p( '</CENTER>' );
 htp.htmlclose;
exception when others then
 error_details( 'STRANGP', 'MASTERPLAN',null,null,errmsg=>sqlerrm,extdet=>'PARM:' || parm);
end masterplan;

procedure usersumm( surl in varchar2 )
as

 cursor c1( vpk integer ) is select role_name from piction_roles p, object_role o where p.role_id = o.role_id and o.object_id = vpk order by role_name;
 cursor c11(vste varchar2) is select description from strang.lov where lov_name = 'CONTROLS' and code = 'DELIVERYNO' and cola = vste;

 c11rec 	c11%ROWTYPE;
 sts		varchar2(100);
 vaccess	varchar2(20);
 ttl		varchar2(200);
 seclevel	varchar2(100);
 vste		varchar2(10);
 v_local_check	varchar2(100);

begin
 if not dapi.init( surl, 'STRANGP.USERSUMM', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'USERSUMM');
    return;
 end if;

 main_title( 'User Summary',helpid=>'STR66',dispmenu=>FALSE);
 vste := customer_state(dapi.GLOBAL_ACCOUNT.acctid);
 vaccess := data_access( 'RECEIVAL' ); -- this is a guess
 seclevel := security_role( dapi.GLOBAL_ACCOUNT.acctid );

 htp.p( '<CENTER>' );

 htp.tableopen( cattributes=>'class="str2_table"' );
  htp.tablerowopen;
   htp.tabledata( htf.bold('Username'),cattributes=>'class="str1_hd_left"');
   htp.tabledata( dapi.GLOBAL_ACCOUNT.username,cattributes=>'class="str1_bg_left"');
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( htf.bold('Account Name'),cattributes=>'class="str1_hd_left"');
   htp.tabledata( dapi.GLOBAL_ACCOUNT.account_name,cattributes=>'class="str1_bg_left"');
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( htf.bold('Account PK'),cattributes=>'class="str1_hd_left"');
   htp.tabledata( dapi.GLOBAL_ACCOUNT.acctid,cattributes=>'class="str1_bg_left"');
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( htf.bold('Roles'),cattributes=>'class="str1_hd_left"');
   htp.p( '<td class="str1_bg_left">');
   for c1rec in c1( dapi.GLOBAL_ACCOUNT.acctid ) loop
    htp.p( c1rec.role_name );
    htp.nl;
   end loop;
   htp.p( '</td>' );
  htp.tablerowclose;
  open c11(vste);
  fetch c11 into v_local_check;
  close c11;
  htp.tablerowopen;
   htp.tabledata( htf.bold('Delivery Series'),cattributes=>'class="str1_hd_left"');
   htp.tabledata( v_local_check,cattributes=>'class="str1_bg_left"');
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( htf.bold('State'),cattributes=>'class="str1_hd_left"');
   htp.tabledata( vste,cattributes=>'class="str1_bg_left"');
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( htf.bold('Security Level'),cattributes=>'class="str1_hd_left"');
   htp.tabledata( seclevel,cattributes=>'class="str1_bg_left"');
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( htf.bold('Access for RECEIVAL'),cattributes=>'class="str1_hd_left"');
   htp.tabledata( data_access( 'RECEIVAL' ),cattributes=>'class="str1_bg_left"');
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( htf.bold('Access for SHP'),cattributes=>'class="str1_hd_left"');
   htp.tabledata( data_access( 'SHP' ),cattributes=>'class="str1_bg_left"');
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( htf.bold('Access for SHP_SB'),cattributes=>'class="str1_hd_left"');
   htp.tabledata( data_access( 'SHP_SB' ),cattributes=>'class="str1_bg_left"');
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( htf.bold('Access for SHP2'),cattributes=>'class="str1_hd_left"');
   htp.tabledata( data_access( 'SHP2' ),cattributes=>'class="str1_bg_left"');
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( htf.bold('Access for ENTRY_MAINTAIN'),cattributes=>'class="str1_hd_left"');
   htp.tabledata( data_access( 'ENTRY_MAINTAIN' ),cattributes=>'class="str1_bg_left"');
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( htf.bold('Access for CONTAINER_MAINTAIN'),cattributes=>'class="str1_hd_left"');
   htp.tabledata( data_access( 'CONTAINER_MAINTAIN' ),cattributes=>'class="str1_bg_left"');
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( htf.bold('Access for DELIVERY_MAINTAIN'),cattributes=>'class="str1_hd_left"');
   htp.tabledata( data_access( 'DELIVERY_MAINTAIN' ),cattributes=>'class="str1_bg_left"');
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( htf.bold('Access for ENTRY_MAINTAIN'),cattributes=>'class="str1_hd_left"');
   htp.tabledata( data_access( 'ENTRY_MAINTAIN' ),cattributes=>'class="str1_bg_left"');
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( htf.bold('Access for POS/DETAILRS'),cattributes=>'class="str1_hd_left"');
   htp.tabledata( data_access( 'DETAILRS' ),cattributes=>'class="str1_bg_left"');
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( htf.bold('Access for INVOICING/CHARGES/INVCONTROLS'),cattributes=>'class="str1_hd_left"');
   htp.tabledata( data_access( 'INVOICING' ),cattributes=>'class="str1_bg_left"');
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( htf.bold('Access for CONTROLS/CONTRACTS/GSTCODES'),cattributes=>'class="str1_hd_left"');
   htp.tabledata( data_access( 'CONTROLS' ),cattributes=>'class="str1_bg_left"');
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( htf.bold('Access for TARIFF/INVENT'),cattributes=>'class="str1_hd_left"');
   htp.tabledata( data_access( 'TARIFF' ),cattributes=>'class="str1_bg_left"');
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( htf.bold('Access for DUTY'),cattributes=>'class="str1_hd_left"');
   htp.tabledata( data_access( 'DUTY' ),cattributes=>'class="str1_bg_left"');
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( htf.bold('Access for SAD'),cattributes=>'class="str1_hd_left"');
   htp.tabledata( data_access( 'SAD' ),cattributes=>'class="str1_bg_left"');
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( htf.bold('Access for MANENTRY'),cattributes=>'class="str1_hd_left"');
   htp.tabledata( data_access( 'MANENTRY' ),cattributes=>'class="str1_bg_left"');
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( htf.bold('Access for REPORT A'),cattributes=>'class="str1_hd_left"');
   htp.tabledata( data_access( 'REPORT A' ),cattributes=>'class="str1_bg_left"');
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( htf.bold('Access for REPORT B'),cattributes=>'class="str1_hd_left"');
   htp.tabledata( data_access( 'REPORT B' ),cattributes=>'class="str1_bg_left"');
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( htf.bold('Access for REPORT C'),cattributes=>'class="str1_hd_left"');
   htp.tabledata( data_access( 'REPORT C' ),cattributes=>'class="str1_bg_left"');
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( htf.bold('Access for REPORT D'),cattributes=>'class="str1_hd_left"');
   htp.tabledata( data_access( 'REPORT D' ),cattributes=>'class="str1_bg_left"');
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( htf.bold('Access for REPORT E'),cattributes=>'class="str1_hd_left"');
   htp.tabledata( data_access( 'REPORT E' ),cattributes=>'class="str1_bg_left"');
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( htf.bold('Access for REPORT F'),cattributes=>'class="str1_hd_left"');
   htp.tabledata( data_access( 'REPORT F' ),cattributes=>'class="str1_bg_left"');
  htp.tablerowclose;
  htp.tablerowopen;
   htp.tabledata( htf.bold('Access for REPORT G'),cattributes=>'class="str1_hd_left"');
   htp.tabledata( data_access( 'REPORT G' ),cattributes=>'class="str1_bg_left"');
  htp.tablerowclose;

 htp.tableclose;

 htp.p( '</CENTER>' );
 htp.nl;
 htp.bold( '<a href="" onClick="self.close()">' || LNG.GLB_TXT_033 || '</a>');
 htp.htmlclose;

end usersumm;

procedure accept_receive_top2( surl in varchar2, scid in varchar2, parm in varchar2, access_id in varchar2, rid in owa.vc_arr, n1 in owa.vc_arr, n2 in owa.vc_arr, action in varchar2, norder in varchar2 default null, n_local in char default 'L', rows_show in integer )
as

 vrid		varchar2(100);
 newrid		rowid;
 p1 		owa.vc_arr;
 p3 		owa.vc_arr;
 p4 		owa.vc_arr;
 p5 		owa.vc_arr;
 p6 		owa.vc_arr;
 p8 		owa.vc_arr;
 p3n 		owa.vc_arr;
 vn1		varchar2(1000);
 vn2		varchar2(100);

begin
 if not dapi.init( surl, 'STRANGP.ACCEPT_RECEIVE_TOP2', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'ACCEPT_RECEIVE_TOP2');
    return;
 end if;
 if action in ('Cancel')
  then
   begin vrid := rid(rid.first); exception when others then null; end;
   receive_top2(surl=>surl,rid=>vrid,scid=>scid,call_name=>'RECEIVALS',parm=>parm,access_id=>access_id,msg=>'Cancelled',rows_show=>rows_show,norder=>norder,n_local=>n_local);
   return;
 end if;
 if action in ('Insert New Delivery','Delete Delivery','DELX')
  then
   accept_receive_top( surl, rid, scid, parm, access_id, p1, p3, p4, p5, p6, p8, p3n, action, norder, n_local );
   return;
 end if;

 for j in rid.first..rid.last loop
  if rid(j) is not null
   then
    vrid := replace(rid(j),'~','+');
    vn1 := n1(j);
    vn2 := n2(j);
     update strang.receivals
      set
       r_notes = vn1,
       status = vn2
     where rowid = chartorowid(vrid);
     newrid := chartorowid(vrid);
  end if;
  -- htp.p( j || ':' || rid(j) || '[' || n1(j) || '][' || n2(j) || ']' ); htp.nl;
 end loop;
 commit;
 receive( surl, rid(1), scid, null, parm, 'x', 'Delivery Record(s) successfully Updated', norder=>norder, n_local=>n_local, rows_show=>rows_show );
exception when others then
 error_details( 'STRANGP', 'ACCEPT_RECEIVE_TOP2',null,null,errmsg=>sqlerrm,extdet=>'RID:' || vrid);
end accept_receive_top2;

procedure pool_popup(surl in varchar2, rid in varchar2, vsrc in varchar2 default null, msg in varchar2 default null)
as

 stp		varchar2(1000);
 vaccess	varchar2(20);

begin
 if not dapi.init( surl, 'STRANGP.POOL_POPUP', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'POOL_POPUP');
    return;
 end if;
 vaccess := data_access( 'POS' );

 main_title( helpid=>'STR61', dispmenu=>FALSE);
 -- search screen
 htp.formopen( 'strangp.pool_popup_search' );
  htp.formhidden( 'SURL', surl );
  htp.formhidden( 'RID', rid );
   htp.tableopen( cattributes=>'class="str1_table"' );
    htp.tablerowopen;
     htp.tableheader( htf.bold( 'Search' ),cattributes=>'class="str1_bg_center"');
     htp.tabledata( htf.formtext( 'VSRC', 30, 30, html_format(vsrc)), cattributes=>'class="str1_bg_left"' );
     htp.tabledata( htf.formsubmit( 'ACTION', 'Perform Search'), cattributes=>'class="str1_bg_left"' );
    htp.tablerowclose;
   htp.tableclose;
 htp.formclose;
 if msg is not null
  then
   htp.header(3,msg,'CENTER');
 end if;
 htp.nl;
 htp.p('<a href="" onClick="self.close()">[Close Window]</a>');
 htp.htmlclose;
exception when others then
 error_details( 'STRANGP', 'POOL_POPUP',null,null,errmsg=>sqlerrm,extdet=>'stp:' || stp);
end pool_popup;

procedure pool_popup_search(surl in varchar2, rid in varchar2, vsrc in varchar2, action in varchar2)
as

 cursor c1(vsrc varchar2) is
  select p.rowid, p.*
  from strang.po_pool p
  where
   (
     (instr(vsrc,'%') > 0 and (upper(po_number) like vsrc or upper(po_item) like vsrc) ) or
     (instr(vsrc,'%') = 0 and (upper(po_number) = vsrc or upper(po_item) = vsrc) ) or
     (vsrc is null)
   )
  order by po_item;

 stp		varchar2(1000);
 vaccess	varchar2(20);
 frec		boolean;
begin
 if not dapi.init( surl, 'STRANGP.POOL_POPUP_SEARCH', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'POOL_POPUP_SEARCH');
    return;
 end if;

 vaccess := data_access( 'POS' );
 main_title( helpid=>'STR62', dispmenu=>FALSE);
-- STRANG_BOTTOM_PO short
 htp.header(3,'PO Pool Lookup Search Results', 'CENTER' );
htp.p( '<script language="JavaScript">' );

--alert(v1 + "-" + v2);
-- When a user selects a record from the LOOKUP, the lookup will also populate pos.manual_grn and pos.critical_flag.
htp.p( '
function poppos(v1,v2,v3,v4,v5,v6,v7,v8,v9) {
window.opener.document.getElementById("po").value=v1;
try{ window.opener.document.getElementById("po2").innerHTML=v1; } catch(err) {}
window.opener.document.getElementById("po_item_no").value=v2;
try{ window.opener.document.getElementById("po_item_no2").innerHTML=v2; } catch(err) {}
window.opener.document.getElementById("shipping_text").value=v3;
try{ window.opener.document.getElementById("shipping_text2").innerHTML=v3; } catch(err) {}
window.opener.document.getElementById("inventoryno").value=v4;
try{ window.opener.document.getElementById("inventoryno2").innerHTML=v4; } catch(err) {}
window.opener.document.getElementById("critical_flag").innerHTML=v5;
window.opener.document.getElementById("critical_flag2").value=v5;
window.opener.document.getElementById("sap_delno_qty").value=v6;
try{ window.opener.document.getElementById("sap_delno_qty2").innerHTML=v6; } catch(err) {}
window.opener.document.getElementById("sap_delno_unit").value=v7;
try{ window.opener.document.getElementById("sap_delno_unit2").innerHTML=v7; } catch(err) {}
window.opener.document.getElementById("manual_grn").innerHTML=v8;
window.opener.document.getElementById("manual_grn2").value=v8;
window.opener.document.getElementById("intsuppm").value=v9;
window.opener.top.STRANG_TOP.document.getElementById("suppm").value=v9;
 }');

 -- short_text, inventoryno po_item_no
htp.p( '</script>' );

  htp.tableopen( cattributes=>'class="str1_table_res"' );
   htp.tablerowopen;
    htp.tableheader( 'Purchase Order' );
    htp.tableheader( 'PO Item No' );
    htp.tableheader( 'Material #' );
    htp.tableheader( 'Material Description' );
    htp.tableheader( 'Quantity' );
    htp.tableheader( 'Unit' );
    htp.tableheader( 'Critical Flag' );
    htp.tableheader( 'Manual GRN' );
    htp.tableheader( 'Shipping' );
    htp.tableheader( 'Vendor' );
    htp.tableheader( 'Vendor ID' );
   htp.tablerowclose;
   frec := FALSE;
   for c1rec in c1(upper(replace(vsrc,'*','%'))) loop
    frec := TRUE;
    htp.tablerowopen;
     htp.tabledata( htf.anchor( '#', c1rec.po_number ),
        cattributes=>'class="str1_bg_left" onclick="poppos(''' || replace(c1rec.po_number,'''','\''') || ''',''' ||
                                                                  replace(c1rec.po_item,'''','\''') || ''',''' ||
                                                                  replace(c1rec.shipping_text,'''','\''') || ''',''' ||
                                                                  replace(c1rec.material,'''','\''') || ''',''' ||
                                                                  replace(c1rec.critical,'''','\''') || ''',''' ||
                                                                  replace(c1rec.openqty,'''','\''') || ''',''' ||
                                                                  replace(c1rec.po_unit,'''','\''') || ''',''' ||
                                                                  replace(c1rec.manual_gr,'''','\''') || ''',''' ||
                                                                  replace(c1rec.vendor,'''','\''') || ''');self.close();return true;"' );
     htp.tabledata( c1rec.po_item );
     htp.tabledata( c1rec.material );
     htp.tabledata( c1rec.short_text );
     htp.tabledata( c1rec.openqty );
     htp.tabledata( c1rec.po_unit );
     htp.tabledata( c1rec.critical );
     htp.tabledata( c1rec.manual_gr );
     htp.tabledata( c1rec.shipping_text );
     htp.tabledata( c1rec.vend_name );
     htp.tabledata( c1rec.vendor );
    htp.tablerowclose;
  end loop;
  htp.tableclose;

 if not frec
  then
   htp.init;
   pool_popup(surl, rid, vsrc, msg=>'Search did not return any results');
   return;
 end if;

 htp.formopen( 'strangp.pool_popup_search' );
  htp.formhidden( 'SURL', surl );
  htp.formhidden( 'RID', rid );
   htp.tableopen( cattributes=>'class="str1_table"' );
    htp.tablerowopen;
     htp.tableheader( htf.bold( 'Search' ),cattributes=>'class="str1_bg_center"');
     htp.tabledata( htf.formtext( 'VSRC', 30, 30, html_format(vsrc)), cattributes=>'class="str1_bg_left"' );
     htp.tabledata( htf.formsubmit( 'ACTION', 'Perform Search'), cattributes=>'class="str1_bg_left"' );
    htp.tablerowclose;
   htp.tableclose;
 htp.formclose;

 htp.nl;
 htp.p('<a href="" onClick="self.close()">[Close Window]</a>');

 htp.htmlclose;
 -- process search, display results
exception when others then
 error_details( 'STRANGP', 'POOL_POPUP_SEARCH',null,null,errmsg=>sqlerrm,extdet=>'stp:' || stp);
end pool_popup_search;

procedure popcapacity(surl in varchar2, vpk in integer, cdet in varchar2, rnd in varchar2 default null)
as

 cursor c5(vtrl varchar2) is select l.colb from strang.lov l where l.lov_name='TRAILERS' and upper(trim(l.code)) = upper(trim(vtrl)) order by colb;

 c5rec		c5%ROWTYPE;
 stp		varchar2(1000);
 vaccess	varchar2(20);
 frec		boolean;

begin
 if not dapi.init( surl, 'STRANGP.POPCAPACITY', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'POPCAPACITY');
    return;
 end if;

 vaccess := data_access( 'POS' );
 open c5(cdet);
 fetch c5 into c5rec;
 close c5;

 owa_util.mime_header( 'text/xml' );
 htp.p('<xmlresponse>');
  htp.p('<value>' || nvl(c5rec.colb,'Not Found') || '</value>');
 htp.p('</xmlresponse>');

exception when others then
 error_details( 'STRANGP', 'POPCAPACITY',null,null,errmsg=>sqlerrm,extdet=>'stp:' || stp);
end popcapacity;

procedure mv_popup(surl in varchar2, vpk in integer, fctr in integer, cdet in varchar2, ctrl in varchar2)
as

 cursor c1(vpk integer) is select * from strang.ships_airway where ship_id = vpk;

 -- Query provided by Sallie
 cursor c4(vpk integer, vtrl varchar2) is
select m.movement_no, m.seal, m.full_mt, m.iso_container_type, m.consignee_location, m.warehouse_destination, m.urgency
from strang.movements m, strang.ships_airway c
where
 strang.f_get_local(m.current_location) <> strang.f_get_local(m.consignee_location) and
 m.complete in ('C','E','A','D') and
 m.convoy_id is null and
 m.truck_id is null and
 m.io = c.io and
 c.ship_id = vpk and
 c.status <> 'FINAL' and
 strang.f_get_local(c.portload) in ('KIUNGA','TABUBIL') and
 (
  strang.f_get_local(m.current_location) = strang.f_get_local(c.portload) or
  nvl(strang.f_get_local(m.convoy_delivery_pickup),strang.f_get_local(c.portload)) <> strang.f_get_local(c.portload) or
  nvl(strang.f_get_local(m.convoy_delivery_location),strang.f_get_local(c.portload)) <> strang.f_get_local(c.portload)
  ) and
 m.ship_id is null and
 m.local_ship_id is null
UNION
select m.movement_no, m.seal, m.full_mt, m.iso_container_type, m.consignee_location, m.warehouse_destination, m.urgency
 from strang.movements m, strang.ships_airway c, strang.ships_airway ss
 where
  strang.f_get_local(m.current_location) <> strang.f_get_local(m.consignee_location) and
  m.complete in ('C','E','A','D','S') and
  m.convoy_id is null and
  m.truck_id is null and
  m.io = c.io and
  m.io = 'I' and
  c.ship_id = vpk and
  nvl(c.status,'|') <> 'FINAL' and
  strang.f_get_local(c.portload) = 'KIUNGA' and
 (
  strang.f_get_local(m.current_location) = strang.f_get_local(c.portload) or
  nvl(strang.f_get_local(m.convoy_delivery_pickup),strang.f_get_local(c.portload)) <> strang.f_get_local(c.portload) or
  nvl(strang.f_get_local(m.convoy_delivery_location),strang.f_get_local(c.portload)) <> strang.f_get_local(c.portload)
  ) and
  strang.f_get_local(ss.portdisc) = strang.f_get_local(c.portload) and
  ss.estarrive <= c.estdepart and
  m.io = ss.io and
( m.local_ship_id = ss.ship_id or m.ship_id = ss.ship_id )
UNION
select m.movement_no, m.seal, m.full_mt, m.iso_container_type, m.consignee_location, m.warehouse_destination, m.urgency
 from strang.movements m, strang.ships_airway c, strang.ships_airway ss
 where
  strang.f_get_local(m.current_location) <> strang.f_get_local(m.consignee_location) and
  m.complete in ('C','E','A','D') and
  m.convoy_id is null and
  m.truck_id is null and
  m.io = c.io and
  m.io = 'O' and
  c.ship_id = vpk and
  nvl(c.status,'|') <> 'FINAL' and
  strang.f_get_local(c.portload) = 'TABUBIL' and
 (
  strang.f_get_local(m.current_location) = strang.f_get_local(c.portload) or
  nvl(strang.f_get_local(m.convoy_delivery_pickup),strang.f_get_local(c.portload)) <> strang.f_get_local(c.portload) or
  nvl(strang.f_get_local(m.convoy_delivery_location),strang.f_get_local(c.portload)) <> strang.f_get_local(c.portload)
  ) and
  strang.f_get_local(ss.portload) = strang.f_get_local(c.portdisc) and
  ss.estdepart >= c.estarrive and
  m.io = ss.io and
( m.local_ship_id = ss.ship_id or m.ship_id = ss.ship_id )
order by 1,2;

 srec		c1%ROWTYPE;
 stp		varchar2(1000);
 vaccess	varchar2(20);
 frec		boolean;

begin
 if not dapi.init( surl, 'STRANGP.MV_POPUP', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'MV_POPUP');
    return;
 end if;

 open c1(vpk);
 fetch c1 into srec;
 close c1;
 vaccess := data_access( 'POS' );
 main_title( helpid=>'STR65', dispmenu=>FALSE);
-- STRANG_BOTTOM_PO short
 htp.header(3,'Movement Lookup', 'CENTER' );
htp.p( '<script language="JavaScript">' );
-- window.opener.document.getElementById("if"+fctr).innerHTML=v1;

htp.p( '
function poppos(v1,v2,fctr) {
window.opener.document.getElementById("f"+fctr).value=v1;
window.opener.document.getElementById("s"+fctr).value=v2;
 }');

htp.p( '</script>' );

  htp.tableopen( cattributes=>'class="str1_table_res"' );
   htp.tablerowopen;
    htp.tableheader( 'Consignment' );
    htp.tableheader( 'Seal' );
    htp.tableheader( 'Full or Empty' );
    htp.tableheader( 'Type' );
    htp.tableheader( 'Destination' );
    htp.tableheader( 'Warehouse' );
    htp.tableheader( 'Urgency' );
   htp.tablerowclose;
   frec := FALSE;
   for c4rec in c4(vpk,cdet) loop
    frec := TRUE;
    htp.tablerowopen;
     htp.tabledata( htf.anchor( '#', c4rec.movement_no ),
        cattributes=>'class="str1_bg_left" onclick="poppos(''' || replace(c4rec.movement_no,'''','\''') || ''',''' ||
                                                                  replace(c4rec.seal,'''','\''') || ''',''' ||
                                                                  replace(fctr,'''','\''') || ''');self.close();return true;"' );
     htp.tabledata( c4rec.seal );
     htp.tabledata( c4rec.full_mt );
     htp.tabledata( c4rec.iso_container_type );
     htp.tabledata( c4rec.consignee_location );
     htp.tabledata( c4rec.warehouse_destination );
     htp.tabledata( c4rec.urgency );
    htp.tablerowclose;
  end loop;
  htp.tableclose;

 htp.nl;
 htp.p('<a href="" onClick="self.close()">[Close Window]</a>');

 htp.htmlclose;
 -- process search, display results
exception when others then
 error_details( 'STRANGP', 'MV_POPUP',null,null,errmsg=>sqlerrm,extdet=>'stp:' || stp);
end mv_popup;

procedure mv_popup_date(surl in varchar2, vdt in varchar2, fctr in integer, cdet in varchar2, ctrl in varchar2)
as

 cursor c1(vpk integer) is select * from strang.ships_airway where ship_id = vpk;

 -- Query changed from mv_popup to be by date
 cursor c4(vdt date) is
select m.movement_no, m.seal, m.full_mt, m.iso_container_type, m.consignee_location, m.warehouse_destination, m.urgency, c.ship_id, c.shipname, c.voy
from strang.movements m, strang.ships_airway c
where
 strang.f_get_local(m.current_location) <> strang.f_get_local(m.consignee_location) and
 m.complete in ('C','E','A','D') and
 c.estdepart = vdt and
 m.convoy_id is null and
 m.truck_id is null and
 m.io = c.io and
 c.status <> 'FINAL' and
 strang.f_get_local(c.portload) in ('KIUNGA','TABUBIL') and
 (
  strang.f_get_local(m.current_location) = strang.f_get_local(c.portload) or
  nvl(strang.f_get_local(m.convoy_delivery_pickup),strang.f_get_local(c.portload)) <> strang.f_get_local(c.portload) or
  nvl(strang.f_get_local(m.convoy_delivery_location),strang.f_get_local(c.portload)) <> strang.f_get_local(c.portload)
  ) and
 m.ship_id is null and
 m.local_ship_id is null
UNION
select m.movement_no, m.seal, m.full_mt, m.iso_container_type, m.consignee_location, m.warehouse_destination, m.urgency, c.ship_id, c.shipname, c.voy
 from strang.movements m, strang.ships_airway c, strang.ships_airway ss
 where
  strang.f_get_local(m.current_location) <> strang.f_get_local(m.consignee_location) and
  m.complete in ('C','E','A','D','S') and
  c.estdepart = vdt and
  m.convoy_id is null and
  m.truck_id is null and
  m.io = c.io and
  m.io = 'I' and
  nvl(c.status,'|') <> 'FINAL' and
  strang.f_get_local(c.portload) = 'KIUNGA' and
 (
  strang.f_get_local(m.current_location) = strang.f_get_local(c.portload) or
  nvl(strang.f_get_local(m.convoy_delivery_pickup),strang.f_get_local(c.portload)) <> strang.f_get_local(c.portload) or
  nvl(strang.f_get_local(m.convoy_delivery_location),strang.f_get_local(c.portload)) <> strang.f_get_local(c.portload)
  ) and
  strang.f_get_local(ss.portdisc) = strang.f_get_local(c.portload) and
  ss.estarrive <= c.estdepart and
  m.io = ss.io and
( m.local_ship_id = ss.ship_id or m.ship_id = ss.ship_id )
UNION
select m.movement_no, m.seal, m.full_mt, m.iso_container_type, m.consignee_location, m.warehouse_destination, m.urgency, c.ship_id, c.shipname, c.voy
 from strang.movements m, strang.ships_airway c, strang.ships_airway ss
 where
  strang.f_get_local(m.current_location) <> strang.f_get_local(m.consignee_location) and
  m.complete in ('C','E','A','D') and
  m.convoy_id is null and
  c.estdepart = vdt and
  m.truck_id is null and
  m.io = c.io and
  m.io = 'O' and
  nvl(c.status,'|') <> 'FINAL' and
  strang.f_get_local(c.portload) = 'TABUBIL' and
 (
  strang.f_get_local(m.current_location) = strang.f_get_local(c.portload) or
  nvl(strang.f_get_local(m.convoy_delivery_pickup),strang.f_get_local(c.portload)) <> strang.f_get_local(c.portload) or
  nvl(strang.f_get_local(m.convoy_delivery_location),strang.f_get_local(c.portload)) <> strang.f_get_local(c.portload)
  ) and
  strang.f_get_local(ss.portload) = strang.f_get_local(c.portdisc) and
  ss.estdepart >= c.estarrive and
  m.io = ss.io and
( m.local_ship_id = ss.ship_id or m.ship_id = ss.ship_id )
order by 1,2;

 srec		c1%ROWTYPE;
 stp		varchar2(1000);
 vaccess	varchar2(20);
 frec		boolean;

begin
 if not dapi.init( surl, 'STRANGP.MV_POPUP', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'MV_POPUP');
    return;
 end if;

 --open c1(vpk);
 --fetch c1 into srec;
 --close c1;
 vaccess := data_access( 'POS' );
 main_title( helpid=>'STR66', dispmenu=>FALSE);
-- STRANG_BOTTOM_PO short
 htp.header(3,'Movement Lookup for date:' || vdt, 'CENTER' );
htp.p( '<script language="JavaScript">' );
-- window.opener.document.getElementById("if"+fctr).innerHTML=v1;

htp.p( '
function poppos(v1,v2,fctr) {
window.opener.document.getElementById("f"+fctr).value=v1;
window.opener.document.getElementById("s"+fctr).value=v2;
 }');

htp.p( '</script>' );
  htp.tableopen( cattributes=>'class="str1_table_res"' );
   htp.tablerowopen;
    htp.tableheader( 'Id' );
    htp.tableheader( 'Name' );
    htp.tableheader( 'Voyage' );
    htp.tableheader( 'Seal' );
    htp.tableheader( 'Full or Empty' );
    htp.tableheader( 'Type' );
    htp.tableheader( 'Destination' );
    htp.tableheader( 'Warehouse' );
    htp.tableheader( 'Urgency' );
   htp.tablerowclose;
   frec := FALSE;
   for c4rec in c4(to_date(vdt,'DD-MON-YYYY')) loop
    frec := TRUE;
    htp.tablerowopen;
     htp.tabledata( htf.anchor( '#', c4rec.movement_no ),
        cattributes=>'class="str1_bg_left" onclick="poppos(''' || replace(c4rec.movement_no,'''','\''') || ''',''' ||
                                                                  replace(c4rec.seal,'''','\''') || ''',''' ||
                                                                  replace(fctr,'''','\''') || ''');self.close();return true;"' );
     htp.tabledata( c4rec.seal );
     htp.tabledata( c4rec.full_mt );
     htp.tabledata( c4rec.iso_container_type );
     htp.tabledata( c4rec.consignee_location );
     htp.tabledata( c4rec.warehouse_destination );
     htp.tabledata( c4rec.urgency );
    htp.tablerowclose;
  end loop;
  htp.tableclose;

 htp.nl;
 htp.p('<a href="" onClick="self.close()">[Close Window]</a>');

 htp.htmlclose;
 -- process search, display results
exception when others then
 error_details( 'STRANGP', 'MV_POPUP_DATE',null,null,errmsg=>sqlerrm,extdet=>'stp:' || stp);
end mv_popup_date;

procedure accept_masterplan_shp( num_entries in number, name_array in owa.vc_arr, value_array in owa.vc_arr, reserved in owa.vc_arr )
as

 cursor c1(sto varchar2) is select max(ship_id) ship_id from strang.ships_airway;
 cursor c11(vste varchar2) is select description from strang.lov where lov_name = 'CONTROLS' and code = 'DELIVERYNO' and cola = vste;

 c1rec		c1%ROWTYPE;
 c11rec 	c11%ROWTYPE;
 srec		strang.ships_airway%ROWTYPE;
 surl 		varchar2(4000);
 parm 		varchar2(100);
 start_date 	date;
 vdt		date;
 c_all		boolean;
 vste		varchar2(10);
 vmsg		varchar2(32767);

begin
 for j in name_array.first..name_array.last loop
  case upper(name_array(j))
   when 'SURL'			then surl 		:= value_array(j);
   when 'PARM'			then parm 		:= value_array(j);
   when 'START_DATE'		then start_date 	:= to_date(value_array(j),'DD-MON-YYYY');
   else null;
 end case;
 end loop;

 if not dapi.init( surl, 'STRANGP.ACCEPT_MASTERPLAN', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'ACCEPT_MASTERPLAN' );
    return;
 end if;

 vste := customer_state(dapi.GLOBAL_ACCOUNT.acctid);
 c_all := FALSE;
 for j in name_array.first..name_array.last loop
  if name_array(j) = 'DT' then srec := null; vdt := to_date(value_array(j),'DD-MON-YYYY'); end if;
  if name_array(j) = 'IO' then srec.io := value_array(j); end if;
  if name_array(j) = 'PLOAD' then srec.portload := value_array(j); end if;
  if name_array(j) = 'PDISC' then srec.portdisc := value_array(j); end if;
  if name_array(j) = 'ACTION' and (upper(value_array(j))) = upper('Create All Convoys')
   then
    c_all := TRUE;
  elsif (name_array(j) = 'ACTION' and (upper(value_array(j))) = upper('Create ' || trim(to_char(vdt,'Day')) || ' Convoy')) or
        (name_array(j) = 'PT' and c_all)
   then
    open c11(vste);
    fetch c11 into c11rec;
    close c11;
    open c1(currsite);
    fetch c1 into c1rec;
    close c1;
    if c1rec.ship_id is null then c1rec.ship_id := c11rec.description; end if;
    c1rec.ship_id := nvl(c1rec.ship_id,0) + 1;
    srec.ship_id := c1rec.ship_id;
    srec.estdepart := vdt;
    srec.estarrive := vdt;
    srec.ship_airway := 'C';
    if srec.io = 'I'
     then
      srec.portload := nvl(srec.portload,'KIUNGA');
     else
      srec.portload := nvl(srec.portload,'TABUBIL');
    end if;
    srec.portdisc := nvl(srec.portdisc,'TABUBIL');
    srec.status := 'INCOMPLETE';
    srec.shipname := 'WK' || to_char(vdt,'WW YYYY');
    srec.voy := to_char(vdt,'DDMMYYYY');
    srec.masterplan := 'WK' || to_char(vdt,'WW YYYY');
    srec.io := nvl('I',srec.io);
    srec.convoy_no := 1;
    insert into strang.ships_airway values srec;
    commit;
    vmsg := vmsg || '[Created Ship ID:' || srec.ship_id || ']';
  end if;
  -- htp.p( j || '-' || name_array(j) || '[' || value_array(j) || ']' ); htp.nl;
 end loop;
 masterplan(surl,start_date,vmsg);
exception when others then
 error_details( 'STRANGP', 'ACCEPT_MASTERPLAN',null,null,errmsg=>sqlerrm,extdet=>'PARM:' || parm);
end accept_masterplan_shp;

procedure accept_masterplan( num_entries in number, name_array in owa.vc_arr, value_array in owa.vc_arr, reserved in owa.vc_arr )
as

surl 		varchar2(4000);
parm 		varchar2(100);
start_date 	date;
p0 		date;
p1 		varchar2(4000);
p2 		varchar2(4000);
p3 		varchar2(4000);
p4t 		varchar2(4000);
p4m 		varchar2(4000);
p5 		varchar2(4000);
p6 		varchar2(4000);
sts		varchar2(100);
vste		varchar2(10);

r0		rowid;
r1		rowid;
r2		rowid;
r3		rowid;
r4		rowid;
r5		rowid;
r6		rowid;
c0rec		strang.convoy_details%ROWTYPE;
c1rec		strang.convoy_details%ROWTYPE;
c2rec		strang.convoy_details%ROWTYPE;
c3rec		strang.convoy_details%ROWTYPE;
c4rec		strang.convoy_details%ROWTYPE;
c5rec		strang.convoy_details%ROWTYPE;
c6rec		strang.convoy_details%ROWTYPE;
callib		owa.vc_arr;
ix		integer;
pload		integer;
vmsg		varchar2(32767);

function process_rec( loadid integer, vrid rowid, ctr integer, crec strang.convoy_details%ROWTYPE, vdt varchar2 )
 return varchar2
as

 cursor c5(vdt date) is select * from strang.ships_airway where estdepart = vdt and ship_airway = 'C';
 cursor c7(vnm varchar2, vrid rowid) is
  select 'x' exst
  from strang.convoy_details s
  where s.ship_id = (select ship_id from strang.convoy_details where rowid = vrid) and
        s.rowid <> vrid and
        operator_1 = vnm;

 cursor c9(vrid rowid) is select * from strang.convoy_details where rowid = vrid;

 c5rec c5%ROWTYPE;
 c7rec c7%ROWTYPE;
 nrec  strang.convoy_details%ROWTYPE;
 vsl   varchar2(100);

begin
 if vrid is not null
  then
   open c9(vrid);
   fetch c9 into nrec;
   close c9;
   nrec.operator_1 := crec.operator_1;
   nrec.truck_id := crec.truck_id;
   nrec.trailer_id := crec.trailer_id;
   nrec.truck_tanker := crec.truck_tanker;
   nrec.fuel_type := crec.fuel_type;
   nrec.fuel_litres := crec.fuel_litres;
   --htp.p( '[' || loadid || '][' || nrec.operator_1 || '][' || nrec.truck_id || '][' || nrec.trailer_id || '][' || nrec.truck_tanker || ']' ); htp.nl;
   if crec.truck_tanker = 'Delete'
    then
     for crec in (select m.rowid from strang.movements m where convoy_id = nrec.ship_id and truck_id = nrec.truck_id) loop
      update strang.movements m set convoy_id = null, truck_id = null, interface4_date = null where rowid = crec.rowid;
     end loop;
     delete from strang.convoy_details where rowid = vrid;
     update strang.ships_airway set convoy_no = (select count('x') tot from strang.convoy_details where ship_id = nrec.ship_id);
     commit;
     return( '[' || loadid || ' ' || vdt || '.' || nrec.truck_id || ' deleted]' );
   end if;
   if nrec.truck_id is null then return( '[' || loadid || ' ' || vdt || '. ' || nrec.operator_1 || '. Must specify truck id]' ); end if;
   if nrec.operator_1 is null then return( '[' || loadid || ' ' || vdt || '. ' || nrec.truck_id || '. Must specify operator]' ); end if;
   if loadid > 1
    then
     open c7(nrec.operator_1,vrid);
     fetch c7 into c7rec;
     if c7%FOUND
      then
       close c7;
       return( '[' || loadid || ' ' || vdt || '. ' || nrec.truck_id || '. Operator already specified]' );
      else
       close c7;
     end if;
   end if;

   update strang.convoy_details set row = nrec where rowid = vrid;

   for crec in (select m.rowid from strang.movements m where convoy_id = nrec.ship_id and truck_id = nrec.truck_id) loop
    update strang.movements m set convoy_id = null, truck_id = null, interface4_date = null where rowid = crec.rowid;
   end loop;
   for j in REVERSE 1..ctr loop
    if name_array(j) in ('P1','P2','P3') then exit; end if;
    if name_array(j) = 'P4MS' then vsl := value_array(j); end if;
    if name_array(j) = 'P4M' then if gl.guess_number(value_array(j)) is not null then update strang.movements set convoy_id = nrec.ship_id, truck_id = nrec.truck_id, interface4_date = null where movement_no = value_array(j) and nvl(seal,'|') = nvl(vsl,'|'); end if; end if;
   end loop;

  else
   open c5( to_date(vdt,'DD-MON-YYYY') );
   fetch c5 into c5rec;
   if c5%NOTFOUND
    then
     close c5;
    else
     close c5;
   end if;
   if crec.truck_id is not null and c5rec.ship_id is null
    then
     return( '[' || loadid || ' ' || vdt || '. ' || nrec.truck_id || '. No Convoy exists for this date]' );
   elsif crec.truck_id is null and crec.trailer_id is null
    then
     return( null );
   elsif crec.operator_1 is null
    then
     return( '[' || loadid || ' ' || vdt || '. ' || nrec.truck_id || '. Must specify operator]' );
   end if;

   nrec := crec;
   nrec.ship_id := c5rec.ship_id;
   nrec.truck_tanker := nvl(nrec.truck_tanker,'TRUCK');
   if nrec.truck_tanker = 'TANKER' and nrec.fuel_type is null then nrec.fuel_type := 'DIESEL'; end if;
   insert into strang.convoy_details values nrec;
   update strang.ships_airway set convoy_no = (select count('x') tot from strang.convoy_details where ship_id = nrec.ship_id);
   for crec in (select m.rowid from strang.movements m where convoy_id = nrec.ship_id and truck_id = nrec.truck_id) loop
    update strang.movements m set convoy_id = null, truck_id = null, interface4_date = null where rowid = crec.rowid;
   end loop;
   for j in REVERSE 1..ctr loop
    if name_array(j) in ('P1','P2','P3') then exit; end if;
    if name_array(j) = 'P4MS' then vsl := value_array(j); end if;
    if name_array(j) = 'P4M' then if gl.guess_number(value_array(j)) is not null then update strang.movements set convoy_id = nrec.ship_id, truck_id = nrec.truck_id, interface4_date = null where movement_no = value_array(j) and nvl(seal,'|') = nvl(vsl,'|'); end if; end if;
   end loop;
   commit;
 end if;
 return( null );
end process_rec;

begin

for j in name_array.first..name_array.last loop
 case upper(name_array(j))
  when 'SURL'			then surl 		:= value_array(j);
  when 'PARM'			then parm 		:= value_array(j);
  when 'START_DATE'		then start_date 	:= to_date(value_array(j),'DD-MON-YYYY');
  else null;
end case;
end loop;

 if not dapi.init( surl, 'STRANGP.ACCEPT_MASTERPLAN', null, iscust=>TRUE ) then
    dapi.initFailed( surl,extra_parameter=>'ACCEPT_MASTERPLAN' );
    return;
 end if;

 vste := customer_state(dapi.GLOBAL_ACCOUNT.acctid);

 for j in name_array.first..name_array.last loop
  if name_array(j) like 'CALLIB%'
   then
    callib( to_number(substr(name_array(j),7)) ) := value_array(j);
  end if;
 end loop;

for j in name_array.first..name_array.last loop
 if name_array(j) = 'PLOAD'
  then pload := to_number(value_array(j));

 elsif name_array(j) = 'P0'
  then
   for k in callib.first..callib.last loop
    if callib(k) = value_array(j) then ix := k; exit; end if;
   end loop;
   r0 := null;
   r1 := null;
   r2 := null;
   r3 := null;
   r4 := null;
   r5 := null;
   r6 := null;

 elsif name_array(j) = 'P0R'
  then
   case ix
    when 0 then r0 := nvl(value_array(j),r0);
    when 1 then r1 := nvl(value_array(j),r1);
    when 2 then r2 := nvl(value_array(j),r2);
    when 3 then r3 := nvl(value_array(j),r3);
    when 4 then r4 := nvl(value_array(j),r4);
    when 5 then r5 := nvl(value_array(j),r5);
    when 6 then r6 := nvl(value_array(j),r6);
   else null;
   end case;

 elsif name_array(j) = 'P1'
  then
   case ix
    when 0 then c0rec.operator_1 := value_array(j);
    when 1 then c1rec.operator_1 := value_array(j);
    when 2 then c2rec.operator_1 := value_array(j);
    when 3 then c3rec.operator_1 := value_array(j);
    when 4 then c4rec.operator_1 := value_array(j);
    when 5 then c5rec.operator_1 := value_array(j);
    when 6 then c6rec.operator_1 := value_array(j);
   else null;
   end case;

 elsif name_array(j) = 'PT'
  then
   case ix
    when 0 then c0rec.truck_tanker := value_array(j);
    when 1 then c1rec.truck_tanker := value_array(j);
    when 2 then c2rec.truck_tanker := value_array(j);
    when 3 then c3rec.truck_tanker := value_array(j);
    when 4 then c4rec.truck_tanker := value_array(j);
    when 5 then c5rec.truck_tanker := value_array(j);
    when 6 then c6rec.truck_tanker := value_array(j);
   else null;
   end case;

 elsif name_array(j) = 'P2'
  then
   case ix
    when 0 then c0rec.truck_id := value_array(j);
    when 1 then c1rec.truck_id := value_array(j);
    when 2 then c2rec.truck_id := value_array(j);
    when 3 then c3rec.truck_id := value_array(j);
    when 4 then c4rec.truck_id := value_array(j);
    when 5 then c5rec.truck_id := value_array(j);
    when 6 then c6rec.truck_id := value_array(j);
   else null;
   end case;

 elsif name_array(j) = 'P3'
  then
   case ix
    when 0 then c0rec.trailer_id := value_array(j);
    when 1 then c1rec.trailer_id := value_array(j);
    when 2 then c2rec.trailer_id := value_array(j);
    when 3 then c3rec.trailer_id := value_array(j);
    when 4 then c4rec.trailer_id := value_array(j);
    when 5 then c5rec.trailer_id := value_array(j);
    when 6 then c6rec.trailer_id := value_array(j);
   else null;
   end case;

 elsif name_array(j) = 'P5'
  then
   case ix
    when 0 then c0rec.fuel_type := value_array(j);
    when 1 then c1rec.fuel_type := value_array(j);
    when 2 then c2rec.fuel_type := value_array(j);
    when 3 then c3rec.fuel_type := value_array(j);
    when 4 then c4rec.fuel_type := value_array(j);
    when 5 then c5rec.fuel_type := value_array(j);
    when 6 then c6rec.fuel_type := value_array(j);
   else null;
   end case;

 elsif name_array(j) = 'P6'
  then
   case ix
    when 0 then c0rec.fuel_litres := gl.guess_number(value_array(j));
    when 1 then c1rec.fuel_litres := gl.guess_number(value_array(j));
    when 2 then c2rec.fuel_litres := gl.guess_number(value_array(j));
    when 3 then c3rec.fuel_litres := gl.guess_number(value_array(j));
    when 4 then c4rec.fuel_litres := gl.guess_number(value_array(j));
    when 5 then c5rec.fuel_litres := gl.guess_number(value_array(j));
    when 6 then c6rec.fuel_litres := gl.guess_number(value_array(j));
   else null;
   end case;

   case ix
    when 0 then vmsg := vmsg || process_rec(pload,r0,j,c0rec,callib(ix));
    when 1 then vmsg := vmsg || process_rec(pload,r1,j,c1rec,callib(ix));
    when 2 then vmsg := vmsg || process_rec(pload,r2,j,c2rec,callib(ix));
    when 3 then vmsg := vmsg || process_rec(pload,r3,j,c3rec,callib(ix));
    when 4 then vmsg := vmsg || process_rec(pload,r4,j,c4rec,callib(ix));
    when 5 then vmsg := vmsg || process_rec(pload,r5,j,c5rec,callib(ix));
    when 6 then vmsg := vmsg || process_rec(pload,r6,j,c6rec,callib(ix));
   else null;
   end case;

 end if;
-- htp.p( j || ':' || name_array(j) || '-' || value_array(j) );
-- htp.nl;
 end loop;
 commit;
 masterplan(surl,start_date,vmsg);
exception when others then
 error_details( 'STRANGP', 'ACCEPT_MASTERPLAN',null,null,errmsg=>sqlerrm,extdet=>'PARM:' || parm);
end accept_masterplan;

/*
STRANG PRD1> desc po_pool
 Name                                      Null?    Type
 ----------------------------------------- -------- ----------------------
 PO_NUMBER->pos.po
 PO_ITEM->pos.po_item_no
 CRITICAL->pos.critical_flag
 MANUAL_GR->pos.manual_grn
 MATERIAL->pos.inventoryno
 OPENQTY->pos.sap_delno_qty
 PO_UNIT->pos.sap_delno_unit
 SHORT_TEXT->inventory description
 SHIPPING_TEXT->pos.shipping_text
 VEND_NAME->?
 VENDOR->?
*/


 procedure t1( num_entries in number, name_array in owa.vc_arr, value_array in owa.vc_arr, reserved in owa.vc_arr )
 as
 begin
  htp.bold( 'n=' || num_entries );
  htp.nl;
  for j in 1..name_array.count loop
   htp.p( j || '[' || name_array(j) || '][' || value_array(j) || ']' );
   htp.nl;
  end loop;
 end t1;

end strangp;
/
